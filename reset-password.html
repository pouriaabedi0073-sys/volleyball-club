<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>بازیابی رمز عبور</title>
    <style>
      body{font-family:Tahoma, Arial, sans-serif;background:#f7f7f9;color:#111;padding:24px}
      .card{max-width:640px;margin:36px auto;background:#fff;border-radius:10px;padding:22px;box-shadow:0 8px 24px rgba(12,14,20,0.06)}
      h1{margin:0 0 12px;font-size:20px}
      label{display:block;margin:10px 0 6px;font-weight:600}
      input,textarea{width:100%;padding:10px;border:1px solid #e0e6ea;border-radius:8px;box-sizing:border-box}
      .muted{color:#666;font-size:13px}
      .row{display:flex;gap:8px;align-items:center}
      button{background:#0ea5e9;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
      button.secondary{background:#6b7280}
      .hidden{display:none}
      .ok{color:green}
      .err{color:#b91c1c}
      pre{background:#f3f4f6;padding:10px;border-radius:6px;overflow:auto}
    </style>
  </head>
  <body>
    <div class="card">
      <h1>بازیابی رمز عبور</h1>

      <div style="display:flex;justify-content:space-between;align-items:center">
        <div id="status" class="muted">در حال بررسی لینک بازیابی...</div>
        <div><button id="showSessionBtn" type="button" style="background:transparent;border:1px solid #e6eef2;padding:6px 8px;border-radius:8px">نمایش نشست</button></div>
      </div>

      <!-- Single reset form (shown only after session is set) -->
      <form id="resetForm" class="hidden" style="margin-top:14px">
        <label for="newPassword">رمز جدید</label>
        <div style="display:flex;align-items:center;gap:8px">
          <input id="newPassword" name="newPassword" type="password" minlength="6" autocomplete="new-password" placeholder="رمز جدید (حداقل 6 کاراکتر)" style="flex:1" />
          <button id="togglePw" type="button" aria-label="نمایش یا مخفی کردن رمز" title="نمایش یا مخفی کردن رمز" style="border:none;background:transparent;cursor:pointer;font-size:18px;line-height:1;padding:6px">👁️</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="doReset">تغییر رمز</button>
          <button id="doSignOut" class="secondary hidden" type="button">خروج از حساب</button>
        </div>
      </form>

      <!-- Manual token fallback: shown when fragment tokens are not present -->
      <div id="tokenFallback" class="hidden" style="margin-top:14px">
        <p class="muted">اگر لینک ایمیل توکن را نداشت، توکن‌ها را اینجا بچسبانید:</p>
        <label for="accessToken">access_token</label>
        <textarea id="accessToken" rows="2" placeholder="access_token"></textarea>
        <label for="refreshToken">refresh_token (اختیاری)</label>
        <textarea id="refreshToken" rows="2" placeholder="refresh_token (اگر وجود دارد)"></textarea>
        <div style="margin-top:10px"><button id="useToken">استفاده از توکن</button></div>
      </div>

      <div id="done" class="hidden" style="margin-top:12px">
        <p id="doneMsg" class="ok">رمز با موفقیت تغییر یافت.</p>
        <p class="muted">قریباً هدایت می‌شوید...</p>
      </div>

      <hr style="margin:16px 0;border:none;border-top:1px solid #eef2f5" />
      <p class="muted">راهنما: لینک بازیابی معمولاً توکن‌ها را در fragment (بعد از #) قرار می‌دهد. اگر توکن نبود، از بخش بالا به‌صورت دستی اضافه کنید.</p>
    </div>

    <!-- UMD Supabase (works on GitHub Pages) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
      // Put config on window to avoid accidental redeclare
      if (typeof window.SUPABASE_URL === 'undefined') window.SUPABASE_URL = 'https://wtycgduarwpgnxxvwtgz.supabase.co';
      if (typeof window.SUPABASE_ANON_KEY === 'undefined') window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0eWNnZHVhcndwZ254eHZ3dGd6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDMyNzUsImV4cCI6MjA3Mzg3OTI3NX0.uqjl1qWII_Yzw86uOHlesjH0YP4AL4QMhjFItPb2DjU';

      // Wait for the UMD lib to load and create a client
      function createClientWhenReady(){
        let attempts = 0; const max = 40; const delay = 100;
        return new Promise((resolve,reject)=>{
          (function waitLib(){
            try{
              const lib = (window.supabase && typeof window.supabase.createClient === 'function') ? window.supabase : (typeof supabase !== 'undefined' ? supabase : null);
              if (lib && typeof lib.createClient === 'function') return resolve(lib.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY));
            }catch(e){}
            attempts++; if (attempts>=max) return reject(new Error('Supabase library not available'));
            setTimeout(waitLib, delay);
          })();
        });
      }

      // parse tokens from fragment or search
      function parseTokens(){
        const out = {};
        const hash = (location.hash && location.hash.startsWith('#')) ? location.hash.slice(1) : '';
        const params = new URLSearchParams(hash || location.search);
        if (params.get('access_token')) out.access_token = params.get('access_token');
        if (params.get('refresh_token')) out.refresh_token = params.get('refresh_token');
        if (!out.access_token) out.access_token = params.get('token') || params.get('accessToken') || params.get('access-token');
        out.type = params.get('type') || null;
        return out;
      }

      function clearFragment(){ try{ history.replaceState(null,'', location.pathname + location.search); }catch(e){} }

      (async function init(){
        const status = document.getElementById('status');
        const resetForm = document.getElementById('resetForm');
        const tokenFallback = document.getElementById('tokenFallback');
        const doneEl = document.getElementById('done');
        const newPw = document.getElementById('newPassword');
        const useTokenBtn = document.getElementById('useToken');
        const showSessionBtn = document.getElementById('showSessionBtn');
        const signOutBtn = document.getElementById('doSignOut');
        const togglePwBtn = document.getElementById('togglePw');

        let client;
        try{ client = await createClientWhenReady(); } catch(e){ console.error(e); status.innerHTML = '<span class="err">خطا: کتابخانه Supabase در دسترس نیست.</span>'; tokenFallback.classList.remove('hidden'); return; }

        const t = parseTokens();
        if ((t.type === 'recovery' && t.access_token) || t.access_token) {
          status.textContent = 'در حال تنظیم نشست از لینک...';
          try{
            const { data, error } = await client.auth.setSession({ access_token: t.access_token, refresh_token: t.refresh_token || null });
            if (error) throw error;
            try{ const s = await client.auth.getSession(); const user = s?.data?.session?.user || null; if (user && user.email) status.textContent = `نشست تنظیم شد برای ${user.email}؛ اکنون رمز جدید را وارد کنید.`; else status.textContent = 'نشست تنظیم شد؛ اکنون رمز جدید را وارد کنید.'; }catch(_){ status.textContent = 'نشست تنظیم شد؛ اکنون رمز جدید را وارد کنید.'; }
            clearFragment(); resetForm.classList.remove('hidden'); tokenFallback.classList.add('hidden'); signOutBtn.classList.remove('hidden'); try{ newPw.focus(); }catch(e){}
          }catch(err){ console.error('setSession failed', err); status.innerHTML = '<span class="err">خطا در تنظیم نشست: ' + (err.message || err) + '</span>'; tokenFallback.classList.remove('hidden'); }
        } else {
          status.textContent = 'لینک بازیابی توکن ندارد.'; tokenFallback.classList.remove('hidden');
        }

        useTokenBtn.addEventListener('click', async function(){
          const at = document.getElementById('accessToken').value.trim();
          const rt = document.getElementById('refreshToken').value.trim();
          if (!at){ alert('لطفاً access_token را وارد کنید.'); return; }
          status.textContent = 'در حال تنظیم نشست از توکن وارد شده...';
          try{ const { data, error } = await client.auth.setSession({ access_token: at, refresh_token: rt || null }); if (error) throw error; status.textContent = 'نشست تنظیم شد؛ فرم تغییر رمز آماده است.'; clearFragment(); resetForm.classList.remove('hidden'); tokenFallback.classList.add('hidden'); signOutBtn.classList.remove('hidden'); try{ newPw.focus(); }catch(e){} }catch(err){ console.error(err); status.innerHTML = '<span class="err">خطا: ' + (err.message || err) + '</span>'; }
        });

        if (showSessionBtn) showSessionBtn.addEventListener('click', async function(){ try{ const sess = await client.auth.getSession(); console.log('session', sess); const u = await client.auth.getUser(); console.log('user', u); alert('اطلاعات نشست در کنسول چاپ شد.'); }catch(e){ console.warn(e); alert('خطا در خواندن نشست (کنسول را ببینید)'); } });

        resetForm.addEventListener('submit', async function(e){
          e.preventDefault();
          const pw = newPw.value.trim();
          if (!pw || pw.length < 6){ alert('لطفاً رمز حداقل 6 کاراکتر وارد کنید.'); return; }
          status.textContent = 'در حال تغییر رمز...';
          try{ const { data, error } = await client.auth.updateUser({ password: pw }); if (error) throw error; document.getElementById('doneMsg').textContent = 'رمز با موفقیت تغییر یافت.'; resetForm.classList.add('hidden'); doneEl.classList.remove('hidden'); setTimeout(()=>{ location.href = 'https://pouriaabedi0073-sys.github.io/volleyball-club/reset-success.html'; }, 1500); }catch(err){ console.error('updateUser failed', err); status.innerHTML = '<span class="err">خطا در تغییر رمز: ' + (err.message || err) + '</span>'; }
        });

        signOutBtn.addEventListener('click', async function(){ try{ await client.auth.signOut(); status.textContent = 'از حساب خارج شدید.'; signOutBtn.classList.add('hidden'); resetForm.classList.add('hidden'); tokenFallback.classList.remove('hidden'); }catch(e){ console.error(e); } });

        // wire up the show/hide password button
        if (togglePwBtn && newPw) {
          togglePwBtn.addEventListener('click', function(){
            try{
              if (newPw.type === 'password'){
                newPw.type = 'text';
                togglePwBtn.textContent = '🙈';
                togglePwBtn.title = 'مخفی کردن رمز';
              } else {
                newPw.type = 'password';
                togglePwBtn.textContent = '👁️';
                togglePwBtn.title = 'نمایش رمز';
              }
              // keep focus on the input after toggle
              try{ newPw.focus(); }catch(e){}
            }catch(e){ console.warn('toggle password failed', e); }
          });
        }

      })();
    </script>
  </body>
</html>