<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>بازیابی رمز عبور..</title>
  <style>
    body{font-family:Tahoma,Arial,sans-serif;background:#f7f9fc;padding:20px}
    .card{max-width:500px;margin:40px auto;background:#fff;padding:30px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.1);text-align:center}
    h1{font-size:22px;color:#1e40af;margin-bottom:20px}
    input,button{width:100%;padding:12px;margin:10px 0;border-radius:8px;border:1px solid #ddd;font-size:16px}
    button{background:#0ea5e9;color:white;border:none;cursor:pointer}
    .hidden{display:none}
    .err{color:#d00;font-weight:bold}
    .ok{color:#0a0;font-weight:bold}
  </style>
</head>
<body>
  <div class="card">
    <h1>بازیابی رمز عبورررر</h1>
    <div id="status">در حال بررسی لینک...</div>

    <form id="resetForm" class="hidden">
      <input type="password" id="newPassword" placeholder="رمز جدید (حداقل ۶ کاراکتر)" minlength="6" required>
      <button type="submit">تغییر رمز عبور</button>
    </form>

    <div id="fallback" class="hidden">
      <p>لینک کار نکرد؟ توکن را دستی وارد کنید:</p>
      <textarea id="manualToken" rows="3" placeholder="access_token را اینجا بچسبانید"></textarea>
      <button onclick="useManualToken()">استفاده از توکن</button>
    </div>

    <div id="success" class="hidden ok">رمز با موفقیت تغییر کرد! در حال هدایت...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Load config with Supabase credentials -->
  <script src="./config.js"></script>
<script>
  // Get credentials from window (set by config.js)
  if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
    alert('خطا: Supabase credentials تنظیم نشده‌اند. لطفاً config.js را بررسی کنید.');
    throw new Error('Missing Supabase credentials');
  }

  const supabase = window.supabase.createClient(
    window.SUPABASE_URL,
    window.SUPABASE_ANON_KEY
  );

  const statusEl = document.getElementById('status');
  const form = document.getElementById('resetForm');
  const success = document.getElementById('success');
  const fallback = document.getElementById('fallback');

  function getTokensFromHash() {
    const hash = location.hash.substring(1);
    const params = new URLSearchParams(hash);
    return {
      access_token: params.get('access_token'),
      refresh_token: params.get('refresh_token'),
      type: params.get('type'),
      error: params.get('error_description')
    };
  }

  async function init() {
    const { access_token, refresh_token, type, error } = getTokensFromHash();

    if (error) {
      statusEl.innerHTML = `<span class="err">لینک منقضی شده است</span>`;
      fallback.classList.remove('hidden');
      return;
    }

    if (access_token && refresh_token && type === 'recovery') {
      statusEl.textContent = 'در حال بررسی لینک...';

      const { error } = await supabase.auth.setSession({
        access_token,
        refresh_token
      });

      if (error) {
        statusEl.innerHTML = `<span class="err">توکن نامعتبر یا منقضی شده</span>`;
        fallback.classList.remove('hidden');
        return;
      }

      statusEl.textContent = 'رمز جدید را وارد کنید';
      form.classList.remove('hidden');
      return;
    }

    statusEl.textContent = 'لینک نامعتبر است';
    fallback.classList.remove('hidden');
  }

  window.useManualToken = async () => {
    const token = document.getElementById('manualToken').value.trim();
    if (!token) return alert('توکن را وارد کنید');

    const { error } = await supabase.auth.setSession({
      access_token: token,
      refresh_token: token   // ✅ بسیار مهم
    });

    if (error) {
      alert('توکن اشتباه یا منقضی شده');
      return;
    }

    location.reload();
  };

  form.onsubmit = async (e) => {
    e.preventDefault();
    const pw = document.getElementById('newPassword').value;

    if (pw.length < 6) return alert('حداقل ۶ کاراکتر');

    const { error } = await supabase.auth.updateUser({
      password: pw
    });

    if (error) return alert('خطا: ' + error.message);

    form.classList.add('hidden');
    success.classList.remove('hidden');

    setTimeout(() => {
      location.href = './';
    }, 2000);
  };

  init();
</script>

</body>
</html>