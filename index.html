<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>مدیریت باشگاه والیبال</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
<!-- Use Google Material Icons (more reliably available) -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<!-- Ensure Supabase library is loaded early for auth UI -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
  // Inline Supabase client initialization for embedded auth.
  (function(){
    const SUPA_URL = 'https://wtycgduarwpgnxxvwtgz.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0eWNnZHVhcndwZ254eHZ3dGd6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDMyNzUsImV4cCI6MjA3Mzg3OTI3NX0.uqjl1qWII_Yzw86uOHlesjH0YP4AL4QMhjFItPb2DjU';

    function tryInit() {
      try {
        const lib = (window.supabase && typeof window.supabase.createClient === 'function') ? window.supabase : (typeof supabase !== 'undefined' ? supabase : null);
        if (!lib) return false;
        // If the global looks like the library itself, create a client and expose it on window.supabase
        if (!window.__supabase_client_initialized) {
          window.supabase = lib.createClient(SUPA_URL, SUPA_KEY);
          window.__supabase_client_initialized = true;
          console.info('Supabase client initialized inline.');
        }
        return true;
      } catch (e) {
        console.warn('Supabase inline init failed:', e);
        return false;
      }
    }

    if (!tryInit()) {
      // Retry a few times while the UMD bundle loads
      let tries = 0;
      const maxTries = 12;
      const id = setInterval(() => {
        tries++;
        if (tryInit() || tries >= maxTries) {
          clearInterval(id);
          if (tries >= maxTries) console.warn('Supabase library not detected; embedded auth will remain offline until the client is provided.');
        }
      }, 250);
    }
  })();
</script>
  <!-- Supabase recovery helper: parse tokens from URL fragment and set session when client is ready -->
  <script>
    (function(){
      // Parse fragment like #access_token=...&refresh_token=...&expires_at=...
      function parseFragment(hash) {
        const out = {};
        if (!hash) return out;
        const str = hash.replace(/^#/, '');
        str.split('&').forEach(pair => {
          if (!pair) return;
          const idx = pair.indexOf('=');
          const key = idx === -1 ? decodeURIComponent(pair) : decodeURIComponent(pair.slice(0, idx));
          const val = idx === -1 ? '' : decodeURIComponent(pair.slice(idx + 1));
          out[key] = val;
        });
        return out;
      }

      function createPanel() {
        if (document.getElementById('recovery-panel')) return document.getElementById('recovery-panel');
        const panel = document.createElement('div');
        panel.id = 'recovery-panel';
        panel.style.position = 'fixed';
        panel.style.zIndex = 99999;
        panel.style.left = '12px';
        panel.style.bottom = '12px';
        panel.style.maxWidth = '420px';
        panel.style.width = 'calc(100% - 24px)';
        panel.style.background = 'rgba(255,255,255,0.98)';
        panel.style.border = '1px solid rgba(0,0,0,0.06)';
        panel.style.padding = '10px';
        panel.style.borderRadius = '10px';
        panel.style.boxShadow = '0 6px 16px rgba(0,0,0,0.12)';
        panel.style.fontSize = '13px';
        panel.style.direction = 'ltr';

        panel.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <strong style="font-size:13px;">Supabase: بازیابی نشست</strong>
            <button id="recovery-close" style="background:transparent;border:none;cursor:pointer;font-size:14px">✕</button>
          </div>
          <div style="margin-bottom:8px;">این پنل توکن‌ها را از fragment URL می‌خواند و تلاش می‌کند نشست را با Supabase تنظیم کند. اگر پیام خطا دیدید، می‌توانید توکن‌ها را دستی وارد کنید.</div>
          <div style="display:flex;gap:8px;margin-bottom:8px;">
            <input id="recovery-access" placeholder="access_token" style="flex:1;padding:8px;border:1px solid rgba(0,0,0,0.08);border-radius:6px" />
          </div>
          <div style="display:flex;gap:8px;margin-bottom:8px;">
            <input id="recovery-refresh" placeholder="refresh_token (اختیاری)" style="flex:1;padding:8px;border:1px solid rgba(0,0,0,0.08);border-radius:6px" />
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button id="recovery-set" class="btn">Set session</button>
          </div>
          <pre id="recovery-log" style="max-height:160px;overflow:auto;margin-top:8px;background:rgba(0,0,0,0.02);padding:8px;border-radius:6px;font-size:12px"></pre>
        `;

        document.body.appendChild(panel);
        document.getElementById('recovery-close').addEventListener('click', ()=> panel.remove());
        return panel;
      }

      function log(message) {
        console.log(message);
        try {
          const el = document.getElementById('recovery-log') || createPanel().querySelector('#recovery-log');
          if (!el) return;
          const time = new Date().toLocaleTimeString();
          el.textContent = `${time} - ${typeof message === 'string' ? message : JSON.stringify(message, null, 2)}\n` + el.textContent;
        } catch (e) { /* ignore */ }
      }

      async function trySetSession(tokens) {
        const panel = createPanel();
        document.getElementById('recovery-access').value = tokens.access_token || '';
        document.getElementById('recovery-refresh').value = tokens.refresh_token || '';

        if (!tokens.access_token) {
          log('no access_token found in fragment');
          return;
        }

        // Wait for supabase client to be ready
        let tries = 0;
        const maxTries = 20;
        const delay = 300;
        log('در تلاش برای پیدا کردن Supabase client...');
        while (tries < maxTries) {
          if (window.supabase && window.supabase.auth && typeof window.supabase.auth.setSession === 'function') break;
          tries++;
          await new Promise(r => setTimeout(r, delay));
        }

        if (!(window.supabase && window.supabase.auth && typeof window.supabase.auth.setSession === 'function')) {
          log('خطا: Supabase client در دسترس نیست. لطفاً مطمئن شوید کتابخانه Supabase بارگذاری شده و در تنظیمات صفحه قرار دارد.');
          return;
        }

        log('Supabase client پیدا شد؛ تنظیم نشست...');
        try {
          const { data, error } = await window.supabase.auth.setSession({ access_token: tokens.access_token, refresh_token: tokens.refresh_token });
          if (error) {
            log({ error: error.message || error });
          } else {
            log('نشست با موفقیت تنظیم شد.');
            log({ data });
            // Optionally clear the fragment so tokens aren't visible in URL
            try { history.replaceState(null, '', location.pathname + location.search); } catch (e) { /* ignore */ }
          }
        } catch (e) {
          log({ error: e && e.message ? e.message : String(e) });
        }
      }

      // Attach manual button handler
      function attachManualHandler() {
        const panel = createPanel();
        const btn = panel.querySelector('#recovery-set');
        btn.addEventListener('click', async ()=>{
          const a = panel.querySelector('#recovery-access').value.trim();
          const r = panel.querySelector('#recovery-refresh').value.trim();
          await trySetSession({ access_token: a, refresh_token: r });
        });
      }

      // Run on load
      document.addEventListener('DOMContentLoaded', ()=>{
        const frag = location.hash || '';
        const tokens = parseFragment(frag);
        if (tokens && tokens.access_token) {
          log('توکن‌ها از fragment تشخیص داده شد. تلاش برای تنظیم نشست...');
          attachManualHandler();
          trySetSession(tokens);
        } else {
          // create panel but keep it collapsed (user can open by calling createPanel in console)
          // show small unobtrusive button to open panel
          // recovery open button intentionally removed to keep UI minimal for mobile app build
        }
      });
    })();
  </script>
<link rel="manifest" href="./manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<meta name="theme-color" content="#0ea5e9">
<style>
/* Competitions: two-column tabs layout */
#view-competitions .matches-tabs {
  display: grid !important;
  grid-template-columns: repeat(2, 1fr) !important;
  gap: 8px !important;
  align-items: stretch;
}



#view-competitions .matches-tabs button {
  width: 100% !important;
  white-space: normal !important;
}
/* Keep tabs horizontal (single row) on very small screens (<700px) if needed */
@media (max-width:300px) {
  #view-competitions .matches-tabs {
    display:flex !important;
    flex-direction:row !important;
    overflow:auto !important;
    grid-template-columns: none !important;
  }
  #view-competitions .matches-tabs button { min-width:70px !important; flex:0 0 auto !important; }
}

/* Responsive team columns in match edit view */
.team-column img { max-width:72px; max-height:72px; }
.team-column .input[type="file"] { padding:6px; }
/* compact set inputs */
  .share-btn { cursor: pointer; background: transparent; border: none; }
  .share-btn svg { display: inline-block; vertical-align: middle; }
.small-set { width: 120px; padding:6px 8px; font-size:14px; box-sizing:border-box; }
@media (max-width:720px) { .small-set { width: 100%; } }
/* file inputs full-width */
.team-column input[type="file"].input { width: 100%; }
/* prevent columns and inputs from overflowing their card */
#view-match-edit .team-column { min-width:0; max-width:100%; }
#view-match-edit .card { overflow:hidden; }
#view-match-edit .input { max-width:100%; box-sizing:border-box; }
#view-match-edit .team-column .input.small-set { padding:6px; }
@media (max-width:720px) {
  #view-match-edit #matchFormPage { padding: 0 12px; }
  #view-match-edit .team-column { width:100%; }
  #view-match-edit > .card > .matchEditContent, #view-match-edit .card { overflow:visible; }
  #view-match-edit .team-column { flex: 1 1 100%; }
  #view-match-edit #matchFormPage { display:block; }
}


@media (min-width:721px) {
  #view-match-edit #matchFormPage { display:block; }
  #view-match-edit .team-column { min-width:0; }
}
  :root {
  --bg: #F9FAFB; /* همگام با modern */
  --header-bg: linear-gradient(180deg, rgba(230,247,255,0.5), rgba(179,229,252,0.5));
  --card: #ffffff;
  --muted: #6b7785;
  --accent: #3B82F6; /* آبی پررنگ modern */
  --accent-2: #34d399;
  --text: #111827;
  --text-inverse: #ffffff;
  --icon-stroke: #374151;
  --glass: rgba(255,255,255,0.85);
  --shadow: rgba(20,30,40,0.15);
  --danger: #dc2626;
  --warning: #f59e0b;
  --success: #22c55e;
  --border-radius: 16px;
  --base-font-size: 16px;
  --spacing-small: 8px;
  --spacing-medium: 12px;
  --spacing-large: 16px;
  --thumb-size: 56px;
  --btn-min-height: 44px;
  --btn-min-width: 80px;
  }
  [data-style="luxury"] {
    --bg: #111827; /* تیره مشکی/سرمه‌ای */
    --header-bg: linear-gradient(180deg, rgba(31,42,68,0.5), rgba(20,30,40,0.5));
    --card: #1E293B;
    --muted: #a0aec0;
    --accent: #FACC15; /* طلایی */
    --accent-2: #0EA5E9; /* فیروزه‌ای تیره */
    --text: #e2e8f0;
    --text-inverse: #1f2a44;
    --text-inverse: #1f2a44;
    --icon-stroke: #e2e8f0;
    --glass: rgba(44,62,80,0.85);
    --shadow: rgba(0,0,0,0.3);
  }
  [data-style="fun"] {
    --bg: #F3F4F6; /* طوسی خیلی روشن */
    --header-bg: linear-gradient(180deg, rgba(230,247,255,0.5), rgba(179,229,252,0.5));
    --card: #ffffff;
    --muted: #6b7785;
    --accent: #8B5CF6; /* بنفش */
    --accent-2: #06B6D4; /* فیروزه‌ای */
    --text: #1f2a44;
    --text-inverse: #ffffff;
    --icon-stroke: #ffffff;
    --glass: rgba(255,255,255,0.85);
    --shadow: rgba(20,30,40,0.15);
  }
  [data-style="modern"] {
    --bg: #F9FAFB; /* خاکستری خیلی روشن */
    --header-bg: linear-gradient(180deg, rgba(230,247,255,0.5), rgba(179,229,252,0.5));
    --card: #ffffff;
    --muted: #6b7785;
    --accent: #3B82F6; /* آبی پررنگ */
    --accent-2: #34d399;
    --text: #111827;
    --text-inverse: #ffffff;
    --icon-stroke: #374151;
    --glass: rgba(255,255,255,0.85);
    --shadow: rgba(20,30,40,0.15);
  }
  * {
    box-sizing: border-box;
    font-family: "Vazirmatn", Arial, sans-serif;
    margin: 0;
    padding: 0;
  }
  html, body {
    height: 100%;
    background: var(--bg);
    background-size: cover, 100px 100px;
    color: var(--text);
    -webkit-font-smoothing: antialiased;
  }
  .wrap {
    max-width: 100%;
    margin: 0 auto;
    padding: 8px;
    padding-bottom: 80px;
  }
  header {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  padding: 8px 12px;
  /* prefer explicit per-theme header variables, fallback to generic --header-bg */
  background: var(--header-bg, var(--header-bg-modern));
  height: 120px;
  /* use 100% instead of 100vw to avoid horizontal overflow when scrollbars present */
  width: 100%; /* full-bleed but respect scrollbar width */
  margin-left: 0;
  box-shadow: 0 6px 20px var(--shadow);
  animation: fadeIn 0.5s ease-in-out; /* انیمیشن ورود */
  }
  #appLogo {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    margin-right: 12px;
    margin-left: 8px;
    box-shadow: 0 2px 6px var(--shadow);
    overflow: hidden; /* ensure contained images are cropped to circle */
    display: inline-block;
    background: transparent; /* بک‌گراند شفاف برای PNG */
  }
  /* images placed inside the logo container fill and crop to circle */
  #appLogo img, #appLogo > img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    object-position: center center;
  }
  #appTitle {
    font-size: 24px;
    font-weight: 700; /* بولدتر برای فونت بهتر */
    color: var(--text);
  }
  .mobile-menu {
    display: flex;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    gap: 8px;
    background: var(--glass);
    backdrop-filter: blur(10px); /* بلور مدرن */
    padding: 8px;
    box-shadow: 0 -8px 24px var(--shadow);
    justify-content: space-around;
    z-index: 1000;
    height: 70px;
  }
  .menu-icon-btn {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: var(--text-inverse);
    transition: all 0.3s ease-in-out;
    box-shadow: 0 2px 6px var(--shadow);
    border: none;
  }
  .menu-icon-btn.home {
    width: 60px;
    height: 60px;
    margin-bottom: 10px;
    transform: translateY(-5px);
  }
  .menu-icon-btn:hover, .menu-icon-btn:active {
    transform: scale(1.1) rotate(5deg);
    box-shadow: 0 4px 12px rgba(14,165,233,0.4);
  }
  .menu-icon-btn svg {
    width: 32px; /* بزرگ‌تر کردن آیکون‌ها */
    height: 32px;
    stroke: var(--icon-stroke);
  }
  /* Inline small spinner used inside buttons (3 dots) */
  .inline-spinner { display:inline-flex; align-items:center; justify-content:center; visibility:hidden; opacity:0; width:18px; height:18px; }
  .inline-spinner::before, .inline-spinner::after, .inline-spinner > i { content: ''; display:inline-block; width:6px; height:6px; background:var(--text-inverse); border-radius:50%; margin:0 2px; opacity:0.7; }
  .inline-spinner.running::before { animation: dot 1s infinite ease-in-out 0s; }
  .inline-spinner.running > i { animation: dot 1s infinite ease-in-out 0.15s; }
  .inline-spinner.running::after { animation: dot 1s infinite ease-in-out 0.3s; }
  .inline-spinner.running { visibility:visible; opacity:1; }
  @keyframes dot { 0%,80%,100% { transform: translateY(0); opacity:0.3; } 40% { transform: translateY(-6px); opacity:1; } }
  /* Make account action buttons horizontal and responsive */
  #accountProfileContainer .card > div > div:last-child { display:flex; gap:8px; align-items:center; }
  #accountProfileContainer .card > div > div:last-child button { min-width:90px; }
  @media (max-width:320px) {
    .auth-form-container { padding:8px !important; }
    .form-tabs { gap:6px !important; }
    #embeddedAuthBox { padding:6px !important; }
    .form-content .form-group label { font-size:13px; }
    .form-content .form-control { font-size:14px; }
    #accountProfileContainer .card > div > div:last-child { flex-direction:row; gap:6px; }
  }
  /* Stack avatar above info and show action buttons in one row on small screens */
  @media (max-width:480px) {
    #accountProfileContainer .card > div { flex-direction: column !important; align-items: center; }
    #accountProfileContainer img#accountAvatar { width:96px !important; height:96px !important; margin-bottom:8px; }
    #accountProfileContainer .card > div > div:first-of-type { width:100%; text-align:center; }
    #accountProfileContainer .card > div > div:last-child { flex-direction:row !important; width:100%; justify-content:center; margin-top:10px; }
    #accountProfileContainer .card > div > div:last-child button { flex:1 1 auto; min-width:0; }
  }
  .btn {
  background: var(--card);
  border: 1px solid rgba(0,0,0,0.06);
  padding: var(--spacing-small) var(--spacing-small); /* کاهش پدینگ افقی از medium به small */
  border-radius: var(--border-radius);
  cursor: pointer;
  font-weight: 600;
  font-size: calc(var(--base-font-size) * 0.875);
  min-height: var(--btn-min-height);
  min-width: 60px; /* کاهش عرض حداقل از 80px به 60px */
  transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
  position: relative;
  overflow: hidden;
  display: inline-flex;
  flex-direction: row;
  align-items: center;
  gap: var(--spacing-small);
  color: var(--text);
}
  .btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.6s ease, height 0.6s ease;
  }
  .btn:hover::before {
    width: 300px;
    height: 300px;
  }
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px var(--shadow);
  }
  .btn.primary {
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    color: var(--text-inverse);
    border: none;
  }
  .btn.primary:hover {
    background: linear-gradient(90deg, var(--accent-2), var(--accent));
  }
  /* Competitions / Matches styles */
  .competitions-top { display:flex;justify-content:space-between;align-items:center;gap:12px; }
  .matches-tabs { display:flex;gap:8px;flex-wrap:nowrap;overflow:auto; }
  .matches-tabs button { white-space:nowrap; flex:0 0 auto; }
  .matches-list { display:flex;flex-direction:column;gap:10px; }
  .match-card { background:var(--card);border-radius:12px;padding:12px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 10px rgba(0,0,0,0.04); }
  .match-teams { text-align:right;min-width:140px; }
  .match-score { font-weight:700;font-size:18px; }
  .match-badges { display:flex;gap:8px;align-items:center; }
  .muted-small { color:var(--muted);font-size:13px; }

  /* modal form for creating/editing matches */
  .modal .modal-content { max-width:720px;width:100%; }
  #matchFormModal .modal-body { padding:12px; }
  #matchFormModal .form-row { display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px; }
  #matchFormModal .input { padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);min-height:40px; }

  /* upcoming birthdays truncation */
  .birthday-card .players-preview .player-row .meta { max-width: calc(var(--thumb-size) * 1.6); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  /* training preview spacing */
  #trainingPreview .player-row { margin-bottom:8px; }
  .btn.danger {
    background: linear-gradient(90deg, var(--danger), #ef4444);
    color: var(--text-inverse);
  }
  .btn.danger:hover {
    background: linear-gradient(90deg, #ef4444, var(--danger));
  }
  /* bottom tab bar */
  .bottom-tabs {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    justify-content: space-around;
    background: var(--glass);
    padding: 8px 6px;
    box-shadow: 0 -6px 18px var(--shadow);
    z-index: 1200;
  }
  .bottom-tabs .tab-btn {
    background: transparent;
    border: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    color: var(--text);
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    padding: 6px 8px;
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.03);
  }
  .bottom-tabs .tab-btn i, .bottom-tabs .tab-btn .material-icons { font-size: 24px; margin-bottom:2px; line-height:1; display:block; transition: transform 0.15s ease; }
  .bottom-tabs .tab-btn.active { color: var(--accent); }
  .bottom-tabs .tab-btn.active { font-weight:800; box-shadow:0 6px 14px rgba(0,0,0,0.08); transform:translateY(-2px); }
  .bottom-tabs .tab-btn.active i { transform: scale(1.18); }
  .tab-label { font-size: 12px; }
  /* Button variant: text then icon on the same row (icon on the right) */
  .btn.icon-right { display: inline-flex; flex-direction: row-reverse; align-items: center; justify-content: center; gap: 8px; white-space: nowrap; margin: 0 auto; }
  .btn.icon-right span { display: inline-block; direction: rtl; }
  .btn.icon-right img { display: inline-block; width: 24px; height: 24px; object-fit: cover; border-radius: 4px; margin-right: 8px; flex: 0 0 24px; }
  /* Center the icon+text button on small screens (mobile preview) */
  /* Profile action row: force single horizontal row inside profile card */
  .profile-action-row { display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:nowrap; overflow-x:auto; padding-bottom:6px; }
  .profile-action-row .btn { 
    flex:0 0 auto; 
    min-width:44px; /* smaller buttons to fit inside cards */
    padding:6px 8px;
    font-size:13px;
    flex-direction:row; /* keep icon and text on same row */
    align-items:center;
    gap:8px;
    white-space:nowrap;
    border-radius:10px;
    text-align:center; /* ensure label centered */
    display:inline-flex; justify-content:center; align-items:center;
  }
  .profile-action-row .btn img, .profile-action-row .btn i { width:20px; height:20px; flex:0 0 20px; }

  /* 2x2 tile grid for profile action buttons (rectangular tiles) */
  .action-tile-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    align-items: stretch;
  }
  .action-tile-grid .action-tile {
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 10px 12px;
    min-height: 56px;
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.06);
    background: var(--card);
    color: var(--text);
    font-weight: 700;
    cursor: pointer;
    text-align: center;
    white-space: nowrap;
  }
  .action-tile-grid .action-tile.primary { background: linear-gradient(90deg, var(--accent), var(--accent-2)); color: var(--text-inverse); border: none; }
  .action-tile-grid .action-tile.warn { background: linear-gradient(90deg, var(--warning), #f59e0b); color: var(--text-inverse); border: none; }
  /* membership card responsive tweaks */
  #membershipCard { transition: all 0.25s ease; }
  #membershipCard img { display:block; }
  @media (max-width:420px) {
    #membershipCard { width: 92vw; padding:10px; }
    #membershipCard div[style*="width:96px"] { width:76px; height:76px; }
    #membershipCard div[style*="font-size:18px"] { font-size:16px; }
  }

  /* More responsive behavior for membership preview */
  @media (max-width:640px) {
    /* make the inner grid wrap: use two columns and adjust rows so content doesn't overflow */
    #membershipCard > div { grid-template-columns: repeat(2, 1fr) !important; grid-template-rows: auto auto auto !important; gap:8px !important; }
    #membershipCard img { max-width:100%; height:auto; object-fit:cover; }
    #membershipCard [id^="cell"] { padding:6px !important; }
    #membershipCard #cell2 { font-size:18px !important; }
    #membershipCard #cell6 { font-size:14px !important; }
    #membershipCard #pcName { font-size:15px !important; }
    #membershipCard #pcBirth, #membershipCard #pcNational, #membershipCard #pcJoinDate, #membershipCard #pcExpire { font-size:12px !important; }
  }

  /* breakpoint at 600px: switch to 2 columns and allow auto row heights */
  @media (max-width:600px) {
    #membershipInnerGrid { grid-template-columns: repeat(2, 1fr) !important; grid-auto-rows: auto !important; gap:8px !important; }
    /* ensure image boxes don't overflow */
    #membershipInnerGrid img { max-height:140px; width:100%; height:auto; object-fit:cover; }
  }

  /* breakpoint at 420px: single column stacked layout */
  @media (max-width:420px) {
    #membershipInnerGrid { grid-template-columns: 1fr !important; grid-auto-rows: auto !important; gap:6px !important; }
    /* make important cells full width */
    #cell5, #cell6, #cell2, #cell4, #cell9, #cell8, #cell11 { grid-column: 1 / -1 !important; }
    #membershipInnerGrid img { max-height:120px; }
  }

  /* Prevent text overflow and ensure ellipsis if space is tight */
  #membershipCard [id^="pc"] { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  #membershipCard #pcName { white-space:normal; }

  /* Stronger rules for very small screens (<=320-360px) */
  @media (max-width:420px) {
    #membershipCard { width: min(92vw,520px); box-sizing: border-box; padding:8px; }
    /* switch to single column stack so items never overflow */
    #membershipCard > div { grid-template-columns: 1fr !important; grid-auto-rows: auto !important; gap:6px !important; }
    /* ensure key cells stretch full width and stack in sensible order */
    #cell5, #cell6, #cell2, #cell4, #cell9, #cell8, #cell11 { grid-column: 1 / -1 !important; }
    /* scale images and limit heights so they don't blow the card size */
    #membershipCard img { max-width:100%; max-height:140px; height:auto; display:block; }
    /* allow text to wrap and break long words */
    #membershipCard [id^="pc"] { white-space:normal; overflow-wrap: break-word; word-break: break-word; }
    /* clamp font sizes for extreme small widths */
    #membershipCard #pcName { font-size: clamp(13px, 4vw, 16px) !important; }
    #membershipCard #pcBirth, #membershipCard #pcNational, #membershipCard #pcJoinDate, #membershipCard #pcExpire { font-size: clamp(11px, 3.2vw, 13px) !important; }
    /* tighten paddings */
    #membershipCard [id^="cell"] { padding:4px !important; }
  }

  /* stricter small-screen rules for <=360px and <=320px */
  @media (max-width:360px) {
    #membershipInnerGrid { grid-template-columns: 1fr !important; grid-auto-rows: auto !important; gap:6px !important; }
    /* make each cell a flex column so image and text stack without overflow */
    #membershipInnerGrid > div[id^="cell"] { display:flex !important; flex-direction:column !important; align-items:flex-start !important; justify-content:center !important; box-sizing:border-box; overflow:hidden; }
    /* images scale down more aggressively */
    #membershipInnerGrid img { max-width:100%; width:100%; max-height:110px; height:auto; object-fit:cover; display:block; }
    #cell5 img#pcPhotoImg { max-height:120px; }
    #pcClubLogoImg { max-height:90px; width:auto; }
  }

  @media (max-width:320px) {
    #membershipCard { padding:6px !important; }
    #membershipInnerGrid { gap:5px !important; }
    #membershipInnerGrid img { max-height:90px !important; }
    #membershipInnerGrid > div[id^="cell"] { padding:4px !important; }
    /* make sure long names wrap into multiple lines rather than pushing layout */
    #pcName { white-space:normal !important; word-break:break-word !important; }
  }

  /* ensure cell containers hide overflow horizontally */
  #membershipInnerGrid > div { overflow:hidden; }

  /* apply transform scale based on computed --card-scale variable; clamp between 0.6 and 1 */
  .membership-scale-wrapper { transform: scale(var(--card-scale,1)); }
  /* enforce a minimum readable scale at very small widths */
  @media (max-width:360px) {
    :root { --card-scale: 0.65; }
    .membership-scale-wrapper { transform: scale(0.65); }
  }
  @media (min-width:361px) and (max-width:520px) {
    /* compute scale relative to 520px width */
    :root { --card-scale: calc((100vw - 32px) / 520); }
    .membership-scale-wrapper { transform: scale(var(--card-scale)); }
  }
  /* ensure transform doesn't create overflow by setting wrapper container height auto */
  #membershipCard { display:flex; justify-content:center; }
  .membership-scale-wrapper { display:block; }

  /* Accessibility: ensure no horizontal scroll inside card */
  #membershipCard { overflow: hidden; }

  /* Note card styles */
  .note-card { background: var(--card); border:1px solid rgba(0,0,0,0.06); padding:10px; border-radius:10px; box-shadow: 0 4px 10px rgba(2,6,23,0.04); }
  .note-card .note-meta { font-size:12px; color:var(--muted); margin-bottom:6px; display:flex;justify-content:space-between;align-items:center; }
  .note-actions { display:flex; gap:6px; }
  @media (max-width: 420px) {
    #showAllPlayersBtn.btn.icon-right {
      display: inline-flex !important;
      justify-content: center !important; /* center contents inside the button */
      margin: 0 auto !important; /* center the button itself in its container */
      min-width: 140px !important;
      padding: 10px 14px !important;
    }
    /* ensure the image keeps its spacing when centered */
    #showAllPlayersBtn.btn.icon-right img { margin-left: 8px; }
  }
  .btn.warning {
    background: linear-gradient(90deg, var(--warning), #fbbf24);
    color: var(--text-inverse);
  }
  .btn.warning:hover {
    background: linear-gradient(90deg, #fbbf24, var(--warning));
  }
  .btn.small {
  padding: calc(var(--spacing-small) * 0.75) calc(var(--spacing-medium) * 0.75);
  font-size: calc(var(--base-font-size) * 0.8125);
  min-height: calc(var(--btn-min-height) * 0.8);
  min-width: calc(var(--btn-min-width) * 0.8);
  }
  .card, .box {
  padding: 12px; /* use compact padding similar to players-stat-card */
  gap: 8px;
  background: var(--glass);
  border-radius: var(--border-radius);
  border: 1px solid rgba(0,0,0,0.06);
  }
  .grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr); /* two columns on wider screens */
  gap: 16px;
  margin-top: 16px;
  }
  .access-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* دو ستون */
    gap: 12px;
  }
  .access-grid .btn {
    width: 100%;
    aspect-ratio: 1 / 1; /* مربعی */
    justify-content: center;
    text-align: center;
    padding: 20px; /* بزرگ‌تر کردن */
    font-size: 16px;
    box-shadow: 0 4px 12px var(--shadow); /* سایه بیشتر برای جذابیت */
  }
  .access-grid .btn svg {
    width: 48px; /* بزرگ‌تر کردن آیکن دکمه‌های دسترسی */
    height: 48px;
  }
  .card {
    background: var(--glass);
    backdrop-filter: blur(5px); /* بلور برای کارت‌ها */
    padding: 16px;
    border-radius: var(--border-radius);
    box-shadow: 0 8px 24px var(--shadow);
    transition: transform 0.3s ease-in-out;
  }
  .card:hover {
    transform: translateY(-4px); /* انیمیشن هاور */
  }
  /* Ensure header title is on the left and actions on the right visually.
     We force the layout direction to LTR for the header container while
     keeping the textual direction of the title (RTL) intact so Persian text
     stays aligned to the right inside the title element. */
  .section-title {
    display: flex;
    direction: rtl; /* layout right-to-left so title sits on the right visually */
    align-items: center;
    margin-bottom: 12px;
    gap: 8px;
  }
  .section-title h3 { margin: 0; flex: 0 0 auto; direction: rtl; text-align: right; }
  .section-title .actions { margin-right: auto; display:flex; gap:8px; align-items:center; }
  .players-preview, .full-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .player-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px;
    border-radius: var(--border-radius);
    border: 1px solid rgba(0,0,0,0.04);
    background: var(--glass);
    transition: background 0.2s, transform 0.2s;
    cursor: pointer;
  }
  .transaction-card { border: 1px solid rgba(0,0,0,0.06); padding: 12px; border-radius: 10px; background: #fff; display:flex; flex-direction:column; align-items:stretch; gap:8px; margin-bottom:10px; }
  .transaction-info { display:flex; justify-content:space-between; gap:12px; align-items:center; }
  .transaction-meta { color:var(--muted); font-size:13px; }
  .transaction-actions { display:flex; gap:8px; justify-content:flex-end; flex-wrap:nowrap; align-items:center; white-space:nowrap; }
  .player-row:hover {
    background: rgba(14,165,233,0.1);
    transform: translateY(-2px);
  }
  /* Stats layout: big players card then two-column small stat cards */
  .players-stat-card {
    padding: 12px;
    border-radius: var(--border-radius);
    background: var(--glass);
    box-shadow: 0 8px 24px var(--shadow);
    margin-bottom: 12px;
  }
  /* ensure top players card spans full width of the stats grid */
  .players-stat-card { grid-column: 1 / -1; }
  .players-by-category { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-top:8px; }
  .players-by-category .category-row { display:flex; justify-content:space-between; align-items:center; padding:8px; border-radius:8px; background: rgba(0,0,0,0.03); }
  .players-by-category .category-row .category-count { color: var(--muted); font-weight:700; }
  .category-chip { display:flex; flex-direction:column; gap:4px; }
  /* Mobile: stack profile into a single column for small screens */
  @media (max-width: 768px) {
    .profile-grid { grid-template-columns: 1fr !important; grid-auto-rows: auto; }
    .profile-left, .profile-right { width: 100%; }
    .profile-left .card, .profile-right .card { margin-top: 8px; }
    #profileModalContent { padding: 12px; }
    #profileModalContent h3 { font-size: 18px; }
    #profileImg { width: 100%; height: auto; border-radius: 8px; }
    .players-by-category { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); }
    .small-stats-grid { grid-template-columns: 1fr 1fr; }
  }
  /* Tighter layout specifically for narrow phones/tablets under 700px */
  @media (max-width: 700px) {
    .players-preview { gap: 6px !important; padding-bottom: 6px !important; }
    .players-preview .player-row { padding: 4px !important; }
    .players-preview .player-thumb { width: 56px !important; height: 56px !important; border: 2px solid #fff !important; }
  .players-preview .player-row .meta { display: none !important; }
  /* but for birthdays preview we want the name/meta visible under thumb on small screens */
  #birthdaysToday .player-row .meta { display: block !important; text-align: center !important; margin-top: 6px !important; font-size: 12px !important; }
    #birthdaysToday .player-thumb { width: 56px !important; height: 56px !important; }
    /* reduce horizontal spacing so 4 items fit comfortably on many smaller phones */
    .players-preview .player-row { flex: 0 0 calc((100% - 18px) / 4) !important; min-width: calc((100% - 18px) / 4) !important; }
    /* ensure upcoming birthdays and birthdays today stay compact */
    #birthdaysToday .player-row { flex: 0 0 auto; margin-right: 8px; }
  }
  .small-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 8px; }
  .small-stats-grid .stat-card { padding: 12px; border-radius: var(--border-radius); background: var(--glass); }
  /* ensure stat-card adapts and percent box doesn't overflow */
  .stat-card { display:flex; flex-direction:column; justify-content:center; align-items:flex-start; min-width: 140px; }
  .stat-card strong { font-size: 20px; }
  .stat-card.center { align-items:center; text-align:center; }
  .player-thumb {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    overflow: hidden;
    background: var(--bg);
    flex: 0 0 56px;
    box-shadow: 0 2px 4px var(--shadow); /* سایه برای عکس‌ها */
    aspect-ratio: 1/1;
  }
  .player-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .meta {
    flex: 1;
    min-width: 0;
  }
  .meta strong {
    display: block;
    font-size: 16px;
  }
  .meta small {
    color: var(--muted);
    font-size: 13px;
  }
  /* list-thumb: larger square thumbnails for players list */
  .list-thumb {
    width: 96px;
    height: 96px;
    border-radius: 8px;
    overflow: hidden;
    flex: 0 0 96px;
  }
  @media (min-width: 480px) {
    .list-thumb { width: 112px; height: 112px; flex: 0 0 112px; }
  }
  /* place action buttons as two columns under meta on players list */
  .player-row .action-buttons { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 8px; width: 100%; }
  .badge {
    background: var(--accent);
    color: var(--text-inverse);
    padding: 6px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
  }
  .badge.warning {
    background: var(--warning);
  }
  .badge.danger {
    background: var(--danger);
  }
  .muted {
    color: var(--muted);
  }
  .search, .input, input[type='text'], input[type='number'], select {
    padding: 10px;
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.06);
    background: var(--glass);
    font-size: 14px;
    color: var(--text);
  }
  .jalali-input {
    cursor: pointer;
  }
  label {
    display: block;
    font-size: 13px;
    margin-bottom: 4px;
    color: var(--text);
  }
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 12px;
  }
  .form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 16px;
  }
  .hide {
  display: none !important;
}
  /* Global modal styles for dynamically-created modals (notes, receipts, etc.) */
  .modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 2500;
  }
  .modal::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 2500;
  }
  .modal .modal-content {
    position: relative;
    z-index: 2501;
    width: 100%;
    max-width: 560px;
    background: var(--card);
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 10px 30px var(--shadow);
  }
  .modal .modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .modal .modal-close { background:transparent; border:none; font-size:20px; padding:6px 8px; cursor:pointer; color:var(--muted); }
  /* place modal close button at top-right corner */
  .modal .modal-content { position:relative; }

  /* share modal action card styling (match birthday modal aesthetics) */
  .share-action-card { max-width:720px; margin:0 auto; }
  .share-action-card .share-controls { gap:12px; }
  /* New share modal layout styles */
  .share-modal-inner { max-width:720px; padding:12px; }
  .share-modal-inner #shareCard { border-radius:14px; box-shadow:0 8px 30px rgba(0,0,0,0.12); max-height:78vh; overflow:hidden; display:flex; flex-direction:column; }
  .share-color-row { justify-content:center; }
  .share-color-row label { margin-right:6px; }
  .share-buttons-row { justify-content:center; width:100%; gap:10px; }
  .share-buttons-row .btn { flex: 1 1 auto; min-width:0; max-width:360px; box-sizing:border-box; }
  /* ensure action row stays inside modal and doesn't overflow horizontally */
  .share-modal-inner { display:flex; flex-direction:column; align-items:stretch; }
  .share-preview-wrap { flex: 0 0 auto; }
  .share-controls-wrap { flex: 0 0 auto; }
  .share-actions-wrap { flex: 0 0 auto; display:flex; align-items:center; justify-content:center; }
  /* allow the card content to scroll internally if viewport is tight */
  .share-modal-inner .card-scroll { overflow:auto; max-height:62vh; }
  /* responsive tweaks */
  .share-modal-inner { box-sizing:border-box; }
  #shareCard img { max-width:100%; height:auto; }
  #shareCard { width:100%; }

  /* birthday-style share button */
  .birthday-share-btn { padding:10px 16px; border-radius:10px; font-weight:700; box-shadow:0 8px 20px rgba(14,165,233,0.12); }
  .birthday-share-btn.primary { background:var(--accent); color:var(--text-inverse); border:0; }
  .modal .modal-header .modal-close { position:absolute; right:8px; top:8px; }
  /* competitions modals: place close button on left for RTL visual preference */
  #matchFormModal .modal-header .modal-close, #matchDetailModal .modal-header .modal-close { left:8px; right:auto; }

  /* For the share modal keep the close button in-flow so it doesn't overflow the white modal */
  #shareOverlay .modal-close, #shareOverlay #closeShareOverlay { position:relative; right:auto; top:auto; margin:0; }
  /* match-detail close: plain text button (black) when it contains text */
  .match-detail-close {
    background: linear-gradient(180deg,#ef4444,#dc2626) !important;
    color: #fff !important;
    width: 40px;
    height: 40px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    box-shadow: 0 6px 18px rgba(220,38,38,0.18);
    font-weight: 700;
    position: absolute;
    left: 8px;
    top: 8px;
  }
  .modal .modal-body textarea { width:100%; min-height:140px; padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:var(--glass); color:var(--text); resize:vertical; }
  /* small chip used in detail modal for date/time and set badges */
  .detail-chip { display:inline-block; padding:6px 8px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.9); font-size:13px; margin-left:6px; }

/* Share overlay: override generic modal pseudo-backdrop to avoid duplicate layers */
#shareOverlay::before { display: none !important; }
  .jalali-calendar {
    /* Centered modal-style calendar */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--card);
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 10px 30px var(--shadow);
    z-index: 2600; /* above other UI layers */
    direction: ltr;
    animation: fadeIn 0.3s ease;
    max-width: 95vw;
    max-height: 80vh;
    overflow: auto;
  }
  .cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 36px);
    gap: 8px;
  }
  .cal-day {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 14px;
    color: var(--text);
  }
  .cal-day:hover {
    background: rgba(14,165,233,0.2);
  }
  .cal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    font-weight: 600;
    direction: rtl;
  }
  .cal-year-btn {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 6px;
    background: var(--glass);
    border: 1px solid rgba(0,0,0,0.1);
    cursor: pointer;
  }
  .stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 16px;
    text-align: center;
  }
  .stat-item {
    flex: 1;
    background: var(--glass);
    padding: 12px;
    border-radius: 10px;
    box-shadow: 0 2px 8px var(--shadow);
    min-width: 120px;
    transition: transform 0.3s;
  }
  .stat-item:hover {
    transform: scale(1.05); /* انیمیشن برای آمار */
  }
  .stat-item strong {
    display: block;
    font-size: 24px;
  }
  .stat-item small {
    color: var(--muted);
  }
  .score-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 4px;
    margin-top: 4px;
    font-size: 13px;
    color: var(--accent-2);
  }
  .topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 16px;
    position: relative;
  }
  .topbar > div {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  .view-more {
    color: var(--accent);
    text-decoration: none;
    font-size: 13px;
    margin-top: 8px;
    display: inline-block;
  }
  .mobile-search {
    display: none;
  }
  .note-btn {
    width: 32px;
    height: 32px;
    background: var(--glass);
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  .note-btn svg {
    width: 16px;
    height: 16px;
    stroke: var(--icon-stroke);
  }
  .note-btn.has-note {
    background: var(--warning);
    color: var(--text-inverse);
  }
  .settings-section {
    margin-top: 20px;
    text-align: center;
  }
  .settings-btn {
    margin: 0 4px;
  }
  .profile-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 8px;
    margin-top: 16px;
  }
  .players-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }
  .players-preview {
  display: flex;
  flex-direction: row;
  gap: 8px;
  overflow-x: auto; /* اسکرول افقی */
  overflow-y: hidden; /* جلوگیری از اسکرول عمودی */
  height: auto; /* ارتفاع داینامیک با توجه به سایز عکس */
  max-height: 140px; /* جلوگیری از بزرگ شدن بیش از حد */
  padding-bottom: 10px; /* فاصله از پایین */
  align-items: center; /* تراز کردن عمودی */
  white-space: nowrap; /* جلوگیری از شکستن به خط بعدی */
  -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
  touch-action: pan-x; /* allow horizontal pan inside this container */
  scroll-snap-type: x mandatory; /* snap items for nicer sliding */
  }
  .players-preview .player-row {
  /* make exactly 4 items visible across the container width; remaining items scroll horizontally */
  flex: 0 0 calc((100% - 36px) / 4); /* 3 gaps of 12px between 4 items */
  min-width: 88px;
  padding: 6px;
  border: none;
  background: none;
  cursor: pointer;
  display: inline-flex; /* اطمینان از چیدمان افقی */
  flex-direction: column;
  align-items: center;
  justify-content: center;
  scroll-snap-align: start;
  }
  .players-preview .player-row .meta {
    display: none;
  }
  .players-preview .player-thumb {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  overflow: hidden;
  background: #e2e8f0; /* بک‌گراند خاکستری برای وقتی عکس نیست */
  flex: none;
  aspect-ratio: 1/1; /* اطمینان از دایره بودن */
  border: 3px solid #ef4444; /* کادر قرمز مخصوص این باکس */
  display: flex;
  align-items: center;
  justify-content: center;
  }
  .players-preview .player-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover; /* اطمینان از پر شدن دایره بدون تغییر شکل */
  border-radius: 50%; /* دایره‌ای کردن تصویر */
  border: 2px solid #fff; /* حاشیه سفید کوچک برای جداسازی */
 }

/* birthdays specific layout: show name and days-left under thumbnail in the preview box */
#birthdaysToday { overflow-x: auto; overflow-y: hidden; padding-bottom: 8px; }
#birthdaysToday .player-row { padding: 6px; display: inline-flex; flex-direction: column; align-items: center; }
#birthdaysToday .player-row .meta { display: block; margin-top: 6px; text-align: center; }
#birthdaysToday .player-row .meta small { display:block; color: var(--muted); font-size: 12px; }

  /* list-thumb: used in full players list (left square thumbnail) */
  .list-thumb {
    width: 120px;
    height: 120px;
    border-radius: 8px;
    background: #f6f7fb;
    flex: 0 0 120px;
    overflow: hidden;
  }
  .list-thumb img { width: 100%; height: 100%; object-fit: cover; display:block; }
 .players-preview .player-thumb svg {
  width: 100%; /* SVG دقیقاً اندازه .player-thumb */
  height: 100%;
  border-radius: 50%; /* دایره‌ای کردن SVG */
  border: 2px solid #fff; /* حاشیه سفید برای هماهنگی با تصاویر */
 }
/* birthdaysToday: do not use red border for this box */
#birthdaysToday .player-thumb {
  border: 0; /* remove red ring specifically for birthdays */
  box-shadow: none;
}
/* overlay for upcoming birthdays */
.birthday-overlay {
  position: absolute;
  inset: 0;
  background: rgba(14,165,233,0.22);
  border-radius: 50%;
  pointer-events: none;
}
  .back-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    color: var(--text);
    position: absolute;
    top: -20px;
    right: 10px;
    padding: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: var(--card);
    box-shadow: 0 2px 4px var(--shadow);
  }
  .back-btn svg {
    width: 20px;
    height: 20px;
    stroke: var(--icon-stroke);
  }

  .birthday-card {
  background: linear-gradient(135deg, var(--accent), var(--accent-2)); /* گرادینت رنگی‌تر بر اساس قالب */
  position: relative;
  overflow: hidden;
  box-shadow: 0 8px 24px var(--shadow);
  color: var(--text-inverse); /* متن سفید */
  border-radius: var(--border-radius);
  padding: 16px;
}
.birthday-card::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, rgba(255,255,255,0.2), rgba(255,255,255,0)); /* سایه مورب */
  transform: rotate(45deg);
}
.birthday-card .section-title {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}
.birthday-card .section-title h3 {
  color: var(--text-inverse);
  font-size: 18px;
  margin: 0;
}
.birthday-icon-title {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #FF6B6B, #FFD700); /* گرادینت جذاب برای آیکون کیک */
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  animation: pulse 1.5s infinite;
}
.birthday-icon-title svg {
  width: 20px;
  height: 20px;
  fill: var(--text-inverse);
}
.birthday-card .player-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  background: rgba(255,255,255,0.1); /* کادر نیمه‌شفاف برای هر بازیکن */
  border-radius: var(--border-radius);
  position: relative;
  cursor: pointer;
}
.birthday-card .player-thumb {
  position: relative;
}
/* .birthday-icon-player {
  position: absolute;
  bottom: -5px;
  left: -5px;
  width: 24px;
  height: 24px;
  background: var(--warning);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  animation: pulse 1.5s infinite;
}
.birthday-icon-player svg {
  width: 16px;
  height: 16px;
  fill: var(--text-inverse);
} */
 
.birthday-card .meta {
  display: flex;
  flex-direction: column;
}
.birthday-card .meta strong {
  color: var(--text-inverse);
}
.birthday-card .meta small {
  color: rgba(255,255,255,0.8);
}
#noBirthdaysMsg {
  color: var(--text-inverse);
  text-align: center;
  margin-top: 12px;
}
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}


  @media (max-width: 768px) {
    .wrap { padding: 12px; padding-bottom: 80px; }
    .grid { grid-template-columns: 1fr; }
    .mobile-menu { display: flex; }
    .form-row { grid-template-columns: 1fr; }
    .cal-grid { grid-template-columns: repeat(7, 32px); }
    .cal-day { width: 32px; height: 32px; font-size: 13px; }
    .player-row { flex-wrap: wrap; }
    .player-row > div:last-child { flex-basis: 100%; display: flex; justify-content: center; gap: 8px; margin-top: 8px; }
    .topbar { flex-direction: column; align-items: stretch; }
    .topbar > div { width: 100%; }
    .profile-actions { grid-template-columns: repeat(2, 1fr); }
  .players-preview { display: flex; flex-direction: row; gap: 6px; overflow-x: auto; }
    .sessions-preview, .payments-preview, .expired-insurances { display: flex; flex-direction: column; gap: 10px; }
    .topbar div in #view-sessions { flex-direction: column; }
    .topbar div in #view-sessions input, select, button { width: 100%; }
    .card { margin-bottom: 16px; }
    .players-preview .meta { margin-top: 8px; font-size: 12px; }
  .players-preview .player-row { padding: 6px; }
    .health-grid { grid-template-columns: 1fr; }
    .access-grid .btn svg { width: 48px; height: 48px; } /* بزرگ‌تر در موبایل */
    .access-grid .btn { font-size: 14px; padding: 16px; }
  /* on tablets show 3 items per viewport (approx) */
  .players-preview .player-row { flex: 0 0 calc((100% - 20px) / 3); min-width: calc((100% - 20px) / 3); }
  }
  /* keep header action buttons inline and prevent wrapping on small screens */
  .section-title { display:flex; align-items:center; }
  .section-title .btn { white-space: nowrap; }
  @media (max-width: 480px) {
    .access-grid { grid-template-columns: repeat(2, 1fr); } /* نگه داشتن دو ستون حتی در کوچک، برای جلوگیری از ریختن */
    .menu-icon-btn svg { width: 28px; height: 28px; } /* تنظیم برای کوچک‌ترها */
  /* on small phones show 2 items per viewport */
  .players-preview .player-row { flex: 0 0 calc((100% - 12px) / 2); min-width: calc((100% - 12px) / 2); }
  .section-title .btn { padding:6px 8px; font-size:13px; }
  }
  @media (max-width: 360px) {
  :root {
    --base-font-size: 13px; /* فونت کوچکتر */
    --thumb-size: 40px; /* دایره‌های کوچکتر */
    --spacing-small: 6px;
    --spacing-medium: 8px;
    --shadow: rgba(20,30,40,0.1); /* سایه سبک‌تر */
    --glass: rgba(255,255,255,0.7); /* بلور کمتر */
    --btn-min-height: 36px; /* دکمه‌های کوچکتر اما قابل‌کلیک */
    --btn-min-width: 60px; /* عرض کوچکتر */
  }
  .access-grid {
    grid-template-columns: repeat(2, 1fr); /* حفظ دو ستون */
    gap: var(--spacing-small); /* فاصله کمتر */
  }
  .grid, .health-grid, .players-grid {
    grid-template-columns: 1fr; /* بقیه gridها تک ستون */
  }
  .btn {
    font-size: calc(var(--base-font-size) * 0.85); /* 11px حدوداً */
    min-height: var(--btn-min-height);
    min-width: var(--btn-min-width);
    padding: calc(var(--spacing-small) * 0.75) var(--spacing-small);
  }
  .btn.small {
    font-size: calc(var(--base-font-size) * 0.77); /* 10px حدوداً */
    min-height: 32px;
    min-width: 50px;
  }
  .menu-icon-btn {
    width: 36px;
    height: 36px;
  }
  .menu-icon-btn svg {
    width: 22px;
    height: 22px;
  }
  .player-thumb, .thumb {
  width: var(--thumb-size);
  height: var(--thumb-size);
  flex: 0 0 var(--thumb-size);
  border-radius: 8px; /* square-ish corners for card thumbnails */
  overflow: hidden;
  background: var(--bg);
  aspect-ratio: 1/1;
  border: 3px solid transparent;
  background-image: linear-gradient(to right, #ff0000, #ff4d4d, #d62976);
  background-origin: border-box;
  background-clip: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
  }

  /* Ensure player-card thumbnails keep the larger square size and override preview rules */
  .players-preview .player-row.player-card .player-thumb,
  .player-card .player-thumb {
    width: 88px !important;
    height: 88px !important;
    aspect-ratio: 1/1 !important;
    border-radius: 12px !important;
  }

  /* place thumbnail near the card's corner for player cards */
  .player-card { position: relative; }
  .player-card .player-thumb {
    position: absolute;
    top: 14px;
    left: 14px;
    width: 88px !important;
    height: 88px !important;
    z-index: 2;
    border-radius: 12px !important;
    aspect-ratio: 1/1 !important;
    overflow: hidden;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .player-card .player-thumb img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    border-radius: 12px !important;
    display: block;
  }
  .player-card > div {
   /* Increased left padding so absolute thumbnail doesn't overlap content
     and to create more horizontal breathing room between halves */
   padding-left: 180px !important;
   min-height: 110px;
   /* Make inner wrapper a flex row so left and right halves can center their content */
   display: flex !important;
   align-items: stretch !important;
  }
  .player-card .player-info-block {
    margin-bottom: 22px !important;
    text-align: center;
  }
  .player-card .action-buttons {
    margin-top: 10px !important;
    margin-bottom: 4px;
    /* Center buttons horizontally in their half and vertically within the card */
    align-items: center !important;
    justify-content: center !important;
    /* Make the action column wider and push it further from the center */
    flex: 0 0 200px !important;
    padding-left: 16px !important;
    display: flex !important;
    flex-direction: column !important;
  }
  /* very small screens: tighten preview gap even more */
  .players-preview { gap: 4px; }
  .players-preview .player-row {
    flex: 0 0 calc(33.33% - var(--spacing-small)); /* 3 بازیکن */
    min-width: calc(33.33% - var(--spacing-small));
  }
  .jalali-calendar .cal-grid {
    grid-template-columns: repeat(7, 26px);
  }
  .cal-day {
    width: 26px;
    height: 26px;
    font-size: calc(var(--base-font-size) * 0.77); /* 10px */
  }
  }
  body.mobile-active .mobile-menu { display: important; } /* !important رو حذف کن تا .hide بتونه override کنه */
  body.mobile-active .grid { grid-template-columns: 1fr !important; }
  body.mobile-active .form-row { grid-template-columns: 1fr !important; }
  body.mobile-active .player-row { flex-direction: column !important; align-items: center !important; text-align: center !important; }
  body.mobile-active .meta { text-align: center !important; }
  body.mobile-active .players-preview { display: flex !important; flex-direction: row !important; gap: 6px !important; overflow-x: auto !important; }
  body.mobile-active .players-preview .player-row { flex: 0 0 auto; flex-direction: column !important; text-align: center !important; }
  body.mobile-active .topbar { flex-direction: column !important; align-items: stretch !important; }
  body.mobile-active .topbar > div { width: 100% !important; }
  body.mobile-active .cal-grid { grid-template-columns: repeat(7, 32px) !important; }
  body.mobile-active .cal-day { width: 32px !important; height: 32px !important; font-size: 13px !important; }
  body.mobile-active .sessions-preview, .payments-preview, .expired-insurances { display: flex; flex-direction: column; gap: 10px; }
  body.mobile-active header { display: flex; }
  #view-players header, #view-coaches header, #view-sessions header, #view-payments header, #view-insurance header, #view-health header { display: none; }
  @media print {
    .no-print { display: none; }
    .player-row { page-break-inside: avoid; }
  }
  /* اضافه برای جذابیت ورزشی */
  .sports-bg {
    background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="20" fill="%230ea5e9" opacity="0.1"/%3E%3C/svg%3E');
    background-repeat: repeat;
  }
  .health-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
  }
  .health-card {
    background: var(--glass);
    padding: 16px;
    border-radius: 16px;
    box-shadow: 0 4px 12px var(--shadow);
  }
  .health-card .bmi-bar {
    height: 10px;
    border-radius: 5px;
    background: #e2e8f0;
    margin-top: 8px;
  }
  .health-card .bmi-fill {
    height: 100%;
    border-radius: 5px;
    transition: width 0.3s;
  }
  .health-card .event-btn {
    margin-top: 12px;
  }
  .event-list {
    margin-top: 8px;
  }
  .event-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
  }
  .event-item .event-text {
    flex: 1;
  }
  .event-item .event-actions {
    display: flex;
    gap: 4px;
  }
  /* Style for home players preview thumbs */
  .players-preview .player-row {
    padding: 0;
    border: none;
    background: none;
    cursor: pointer;
  }
  .players-preview .player-thumb {
    box-shadow: none;
  }
  #scoresContainer {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }
  .action-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .view-header {
    display: flex;
    align-items: center;
  justify-content: space-between;
  /* reverse visual order so back button sits on the right and title on the left (RTL pages) */
  flex-direction: row-reverse;
    padding: 16px;
    background: var(--header-bg);
    box-shadow: 0 4px 12px var(--shadow);
  }
  .view-header h3 {
    margin: 0;
  /* ensure the title text reads from left side when placed on the left */
  text-align: left;
  }
  .form-section {
    border: 1px solid rgba(0,0,0,0.06);
    padding: 12px;
    border-radius: 10px;
    background: var(--card);
    margin-bottom: 12px;
  }
  .view-header .back-btn {
    position: static;
  }
  /* competitions-specific: pin back button to left edge and keep it flush */
  #view-competitions .view-header { padding-left: 12px; }
  #view-competitions .view-header .back-btn { position: absolute; left: 12px; top: 12px; margin: 0; }
  /* ensure title isn't covered by absolute back button */
  #view-competitions .view-header h3 { margin-left: 48px; }
  .btn, .menu-icon-btn, .jalali-input, .player-row, .cal-day {
  touch-action: manipulation; /* حذف تأخیر 300ms */
}
.view-header.fixed {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000; /* مطمئن می‌شه هدر بالای بقیه عناصر باشه */
  background: var(--header-bg);
  box-shadow: 0 6px 20px var(--shadow); /* سایه برای ظاهر بهتر */
}
section:not(#view-home) {
  padding-top: 84px; /* ارتفاع تقریبی هدر to match larger full-width header */
}
/* Competitions / Matches styles */
.competitions-top {
  display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid rgba(0,0,0,0.06);
}
.competitions-top .left-actions, .competitions-top .right-actions {display:flex;gap:8px;align-items:center}
.matches-tabs {display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;align-items:center}
.matches-tabs button {padding:8px 12px;border-radius:10px;background:var(--glass);border:1px solid rgba(0,0,0,0.04);cursor:pointer;flex: 0 1 auto}
.matches-tabs button.active {background:var(--accent);color:var(--text-inverse);border-color:transparent}
.matches-list {display:flex;flex-direction:column;gap:12px}
.match-card {background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px var(--shadow);display:flex;align-items:center;justify-content:space-between;gap:12px}
.match-meta {display:flex;flex-direction:column;align-items:flex-end;gap:4px}
.match-score {font-weight:800;font-size:20px;margin:0 12px;min-width:80px;text-align:center}
.match-teams {display:flex;flex-direction:column;align-items:flex-end;min-width:120px}

/* responsive: team left/right with VS and scores centered */
@media (max-width:600px) {
  .match-card {flex-direction:row;align-items:center}
  .match-card .left-team, .match-card .right-team {flex:1}
  .match-card .vs {width:48px;text-align:center;font-weight:700}
  .match-score {min-width:56px;font-size:18px}
}
/* keep tabs horizontal down to small phones; change breakpoint to 770px so below that still stays inline */
@media (max-width:770px) {
  /* keep tabs horizontal on small screens (allow horizontal scroll) */
  .matches-tabs { display:flex; flex-direction:row; gap:8px; overflow:auto; white-space:nowrap; -webkit-overflow-scrolling:touch; }
  .matches-tabs button { flex:0 0 auto; min-width:80px; }
}

/* enforce horizontal tabs also under 700px specifically (override other rules) */
@media (max-width:700px) {
  .matches-tabs { display:flex !important; flex-direction:row !important; gap:8px !important; overflow:auto !important; white-space:nowrap !important; }
  .matches-tabs button { flex:0 0 auto !important; min-width:70px !important; }
}

/* on small screens stack tabs-box and controls vertically */
@media (max-width:600px) {
  .tabs-box { margin-bottom:8px; }
  .matches-controls { flex-direction:column; gap:8px; align-items:stretch; }
  .matches-controls input { width:100%; }
}

/* Make tabs vertical and full-width on small screens (mobile first) */
@media (max-width:600px) {
  .matches-tabs { display:flex;flex-direction:column;gap:8px; }
  .matches-tabs button { width:100%; text-align:center; }
}

/* controls box above tabs */
.matches-controls { background:var(--card);padding:8px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.04); box-sizing:border-box; overflow:hidden; }

/* make sure inputs and inner divs can shrink and wrap without overflowing */
.matches-controls { display:flex; flex-wrap:wrap; align-items:center; }
.matches-controls > div { flex: 1 1 auto; min-width:0; box-sizing:border-box; }
.matches-controls .input, .matches-controls input { min-width:0; flex:1 1 auto; box-sizing:border-box; overflow:hidden; }
/* keep small controls from stretching the row and ensure they remain clickable */
.matches-controls button, .matches-controls .btn { flex: 0 0 auto; margin:0; }

/* ensure compact clear button looks correct and doesn't force wider layout */
#clearMatchesDate { padding:6px 8px; width:34px; height:34px; display:inline-flex; align-items:center; justify-content:center; box-sizing:border-box; }

/* marker used in markup so we can target elements easily; not hidden by default */
.no-capture { box-sizing: border-box; }

/* class applied at runtime to hide controls during capture */
.capture-hide { visibility:hidden !important; pointer-events:none !important; }
.capture-hide.collapse { display:none !important; }

/* helpers for new markup */
.matches-controls-left { min-width:0; }
.matches-date-wrap { min-width:0; }

/* compact clear button in competitions controls */
#clearMatchesDate { padding:6px 8px; width:34px; height:34px; display:inline-flex; align-items:center; justify-content:center; }

/* precise match card layout requested */
.match-card .row-top { display:flex;justify-content:space-between;align-items:center;padding-bottom:6px;border-bottom:1px dashed rgba(0,0,0,0.04); }
.match-card .row-mid { display:flex;justify-content:space-between;align-items:center;padding:8px 0; }
.match-card .row-bottom { display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--muted); }
.match-card .team-name { font-weight:700; }
.match-card .score { font-weight:800; font-size:18px; min-width:56px; text-align:center; }
.match-kind {display:flex;gap:8px;align-items:center}
.match-status {font-size:13px}
.match-badges {display:flex;gap:8px;align-items:center}
.fab {position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:50%;background:var(--accent);color:var(--text-inverse);display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 8px 24px rgba(14,165,233,0.18);cursor:pointer;z-index:2000}
.muted-small {color:var(--muted);font-size:13px}

/* Share preview tweaks: keep controls out of the printed/captured card */
#shareCard input[type="color"], #shareCard button { -webkit-appearance: none; appearance: none; }
#shareCard .share-controls { margin-top:12px; display:flex; gap:8px; width:100%; }
#shareCard .share-controls > * { flex:1 1 auto; }
#shareCard .no-capture { visibility:visible; }

</style>
<script>
// Deterministic canvas renderer: draws the share card to a canvas and returns a PNG Blob
async function renderShareCanvasFromData(m, opts = {}) {
  const w = opts.width || 1080; const h = opts.height || 1920;
  const colorA = opts.colorA || '#ff6b6b'; const colorB = opts.colorB || '#ff9ac2';
  // create canvas
  const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  // background gradient
  // optionally draw court background image first (low opacity)
  try {
    const court = new Image(); court.crossOrigin = 'anonymous';
    const courtSrc = (opts.courtImage) ? opts.courtImage : 'icons/court.png';
    await new Promise((res, rej) => { court.onload = res; court.onerror = () => rej(new Error('court load failed')); court.src = courtSrc; });
    const cw = Math.floor(w * 0.7); const ch = Math.floor(h * 0.7);
    const cx = Math.floor((w - cw) / 2); const cy = Math.floor(h * 0.08);
    ctx.globalAlpha = 0.18; ctx.drawImage(court, cx, cy, cw, ch); ctx.globalAlpha = 1;
  } catch (e) {
    console.debug('court bg not available', e);
  }
  const g = ctx.createLinearGradient(0,0,0,h);
  g.addColorStop(0, colorA);
  g.addColorStop(1, colorB);
  ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
  // draw top padding spacer (visual offset)
  const topOffset = Math.floor(h * 0.08);
  // logos row
  const logoSize = Math.floor(w * 0.25);
  const logoY = topOffset + 60;
  const leftX = Math.floor(w * 0.2);
  const rightX = Math.floor(w * 0.8) - logoSize;
  // helper to draw image from src (handles data-urls and same-origin images)
  async function drawLogo(src, dx, dy, dSize) {
    if (!src) return;
    try {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      await new Promise((res, rej) => { img.onload = res; img.onerror = () => rej(new Error('logo load failed')); img.src = src; });
      // draw with rounded rect mask
      const r = Math.max(12, Math.floor(dSize * 0.12));
      roundRect(ctx, dx, dy, dSize, dSize, r, true, false);
      ctx.save();
      ctx.beginPath();
      roundedClip(ctx, dx, dy, dSize, dSize, r);
      ctx.drawImage(img, dx, dy, dSize, dSize);
      ctx.restore();
    } catch (err) {
      console.warn('drawLogo error', err, src);
      // draw placeholder circle
      ctx.fillStyle = 'rgba(255,255,255,0.12)'; ctx.beginPath(); ctx.arc(dx + dSize/2, dy + dSize/2, dSize/2 - 6, 0, Math.PI*2); ctx.fill();
    }
  }

  // rounded rect helper (stroke/fill)
  function roundRect(ctx, x, y, w, h, r, fill, stroke) {
    if (typeof r === 'undefined') r = 5;
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
    if (fill) ctx.fill();
    if (stroke) ctx.stroke();
  }
  function roundedClip(ctx, x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
    ctx.clip();
  }

  // draw logos (A left, B right)
  const logoA = (m.logoA && String(m.logoA).startsWith('data:')) ? m.logoA : (m.logoA || (state.settings && state.settings.logo) || 'icons/volleyball (1).png');
  const logoB = (m.logoB && String(m.logoB).startsWith('data:')) ? m.logoB : (m.logoB || 'icons/volleyball (1).png');
  await Promise.all([
    drawLogo(logoA, leftX, logoY, logoSize),
    drawLogo(logoB, rightX, logoY, logoSize)
  ]);

  // team names row
  ctx.fillStyle = '#ffffff'; ctx.textAlign = 'center';
  ctx.font = '700 64px Vazirmatn, sans-serif';
  const teamText = (m.teamA || '') + '  VS  ' + (m.teamB || '');
  ctx.fillText(teamText, w/2, logoY + logoSize + 110);

  // info box near bottom
  const infoBoxH = 220; const infoBoxW = Math.floor(w * 0.88); const infoX = Math.floor((w - infoBoxW)/2); const infoY = h - infoBoxH - 160;
  ctx.fillStyle = 'rgba(255,255,255,0.08)'; roundRect(ctx, infoX, infoY, infoBoxW, infoBoxH, 18, true, false);
  ctx.fillStyle = '#fff'; ctx.font = '600 28px Vazirmatn, sans-serif'; ctx.textAlign = 'left';
  const infoPad = 28; ctx.fillText('نوع: ' + (mapKindToPersian(m.kind) || '-'), infoX + infoPad, infoY + 50);
  ctx.fillText('تاریخ: ' + (m.date || '-'), infoX + infoPad, infoY + 96);
  ctx.fillText('مکان: ' + (m.venue || '-'), infoX + infoPad, infoY + 142);
  ctx.fillText('ساعت: ' + (m.time || '-'), infoX + infoPad, infoY + 188);

  // small title near top
  ctx.fillStyle = 'rgba(255,255,255,0.95)'; ctx.textAlign = 'center'; ctx.font = 'bold 44px Vazirmatn, sans-serif';
  ctx.fillText(m.title || ((m.teamA||'') + ' vs ' + (m.teamB||'')), w/2, topOffset + 40);

  // convert to blob
  return await new Promise((res, rej) => { canvas.toBlob(b => { if (b) res(b); else rej(new Error('toBlob failed')); }, 'image/png'); });
}
</script>
</head>
<body class="mobile-active sports-bg">
<div class="wrap">
  <main>
    <div id="view-root">
      <section id="view-home">
        <header id="appHeader">
          <img id="appLogo" src="./icons/logo.png" alt="لوگو">
          <span id="appTitle">مدیریت باشگاه والیبال</span>
        </header>
        <div class="grid">
  
          <div class="card">
            <div class="section-title" style="display:flex;align-items:center;gap:8px;">
              <h3 style="margin:0;">جدیدترین بازیکنان ثبت نامی</h3>
              <div class="actions">
                <button id="addPlayerBtn" class="btn primary" title="بازیکن جدید" style="padding:8px 12px;white-space:nowrap;">بازیکن جدید</button>
              </div>
            </div>
            <div id="playersPreview" class="players-preview"></div>
            <div style="margin-top: 12px; text-align: center;">
              <button id="showAllPlayersBtn" class="btn icon-right" style="padding:10px 18px;direction:ltr;min-width:220px;">
                <span>لیست بازیکنان</span>
                <img src="./icons/volleyball (7).png" alt="والیبال" />
              </button>
            </div>
          </div>

          <div class="card birthday-card">
  <div class="section-title">
    <h3>متولدین امروز</h3>
    <div class="birthday-icon-title">
      <svg viewBox="0 0 24 24">
        <path d="M12 2v2m-4 2v2m8 0v2M4 10h16v10a2 2 0 01-2 2H6a2 2 0 01-2-2V10z" fill="none" stroke="currentColor" stroke-width="2"/>
      </svg>
    </div>
  </div>
  <div id="birthdaysToday" class="players-preview"></div>
  <div id="noBirthdaysMsg" style="display: none;">هیچ تولدی امروز نیست</div>
</div>

          <!-- sessions card kept but button moved to header of players card for compact layout -->
          <div class="card">
            <div class="section-title">
                <h3>آخرین جلسات</h3>
                <div class="actions"><button id="addSessionFromHomeBtn" class="btn primary" style="padding:8px 12px;white-space:nowrap;">جلسه جدید</button></div>
              </div>
            <div id="sessionsPreview" class="sessions-preview"></div>
              <!-- removed show all sessions button per user request -->
          </div>
          
          <div class="card">
            <div class="section-title">
                <h3>برنامه تمرینات</h3>
                <div class="actions"><button id="addTrainingFromHomeBtn" class="btn primary" style="padding:8px 12px;white-space:nowrap;">تمرین جدید</button></div>
              </div>
          <div id="trainingPreview" class="training-preview"></div>
          </div>
          
          <div class="card">
              <div class="section-title">
                <h3>آخرین پرداخت‌ها</h3>
                <div class="actions"></div>
              </div>
              <div id="paymentsPreview" class="payments-preview"></div>
          </div>
          
          <div class="card" style="border-left: 4px solid var(--danger);">
            <!-- حذف مدیریت بیمه‌ها از صفحه اصلی -->
              <div class="section-title">
                <h3>بیمه‌های منقضی</h3>
              </div>
              <div id="expiredInsurances" class="expired-insurances"></div>
          </div>
        </div>

        <!-- Player share modal (image + text share options) -->
        <div id="playerShareOverlay" class="modal hide" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:10001;">
          <div style="position:fixed;inset:0;background:rgba(0,0,0,0.55);backdrop-filter:blur(4px);" id="playerShareBackdrop"></div>
          <div style="position:relative;z-index:10002;width:min(94vw,720px);max-height:90vh;display:flex;flex-direction:column;gap:8px;align-items:center;overflow:auto;padding:12px;">
            <div style="width:100%;background:#fff;border-radius:12px;padding:12px;box-shadow:0 10px 40px rgba(0,0,0,0.12);box-sizing:border-box;display:flex;flex-direction:column;gap:8px;">
              <div style="display:flex;align-items:center;justify-content:space-between;">
                <strong>اشتراک پروفایل بازیکن</strong>
                <button id="closePlayerShareOverlay" class="btn">بستن</button>
              </div>
              <div id="playerSharePreview" style="width:100%;display:flex;align-items:center;justify-content:center;padding:8px;">
                <div id="playerShareCard" style="width:320px;height:568px;border-radius:12px;overflow:hidden;border:1px solid rgba(0,0,0,0.06);background:linear-gradient(180deg,#ff6b6b,#ff9ac2);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:18px;">
                  <div id="playerSharePhotoWrap" style="width:120px;height:120px;border-radius:12px;overflow:hidden;background:#eee;margin-bottom:12px;"></div>
                  <div id="playerShareName" style="font-weight:800;color:#fff;margin-bottom:8px;">نام بازیکن</div>
                  <div id="playerShareDob" style="color:rgba(255,255,255,0.9);margin-bottom:8px;">تاریخ تولد: -</div>
                  <div id="playerShareSummary" style="color:#fff;font-size:13px;line-height:1.25;text-align:right;">سابقه عضویت / وضعیت جسمانی / مهارت • امتیاز</div>
                </div>
              </div>
              <div style="display:flex;gap:8px;justify-content:center;align-items:center;padding-top:8px;">
                <button id="playerShareImageBtn" class="btn primary birthday-share-btn">اشتراک عکس</button>
                <button id="playerShareTextBtn" class="btn">اشتراک متن پروفایل</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card" style="margin-top: 16px;">
          <div class="section-title">
            <h3>آمار کلی باشگاه</h3>
          </div>
          <div id="statsContainer" class="stats"></div>
        </div>
      </section>

      <!-- Full-page match create/edit view (top-level) -->
      <section id="view-match-edit" class="hide">
        <div class="view-header fixed">
          <h3 id="matchEditTitle">افزودن / ویرایش مسابقه</h3>
          <button class="back-btn" id="backFromMatchEdit"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="matchEditContent">
            <div id="matchFormPage">
              <!-- Status and Type controls will appear above teams -->
              <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px;">
                <div style="display:flex;gap:12px;align-items:center;justify-content:center;padding:8px;">
                  <label style="display:flex;align-items:center;gap:12px;font-size:18px;">
                    <input type="radio" name="formStatusRadio" id="statusScheduled" value="scheduled" style="width:20px;height:20px;" />
                    <span style="font-size:16px;">برنامه‌ریزی‌شده</span>
                  </label>
                  <label style="display:flex;align-items:center;gap:12px;font-size:18px;">
                    <input type="radio" name="formStatusRadio" id="statusFinished" value="finished" style="width:20px;height:20px;" />
                    <span style="font-size:16px;">انجام شده</span>
                  </label>
                </div>
                <div style="border-bottom:1px solid rgba(0,0,0,0.08);"></div>
                <div style="padding-top:10px;display:flex;gap:14px;flex-wrap:wrap;align-items:center;margin-top:6px;">
                  <label style="display:flex;align-items:center;gap:12px;font-size:20px;"><input type="radio" name="formTypeRadio" id="typeFriendly" value="friendly" style="width:22px;height:22px;"/> دوستانه</label>
                  <label style="display:flex;align-items:center;gap:12px;font-size:20px;"><input type="radio" name="formTypeRadio" id="typeLeague" value="league" style="width:22px;height:22px;"/> لیگ</label>
                  <label style="display:flex;align-items:center;gap:12px;font-size:20px;"><input type="radio" name="formTypeRadio" id="typeKnockout" value="knockout" style="width:22px;height:22px;"/> حذفی</label>
                  <label style="display:flex;align-items:center;gap:12px;font-size:20px;"><input type="radio" name="formTypeRadio" id="typeGroup" value="group" style="width:22px;height:22px;"/> گروهی</label>
                </div>
                <div style="border-bottom:1px solid rgba(0,0,0,0.08);margin-top:8px;"></div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:start;">
                <!-- Team A column -->
                <div class="team-column" style="display:flex;flex-direction:column;gap:8px;">
                  <label class="muted-small">تیم اول</label>
                  <input id="formTeamA" class="input" placeholder="تیم اول" />
                  <label class="muted-small" style="margin-top:6px;">لوگو تیم (از دستگاه)</label>
                  <input id="formTeamALogoFile" type="file" accept="image/*" class="input" />
                  <input id="formTeamALogo" type="hidden" />
                  <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px;align-items:flex-start;">
                    <img id="formTeamAPreview" src="" alt="پیش‌نمایش لوگو تیم اول" style="width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid rgba(0,0,0,0.06);display:none;" />
                    <div class="muted-small" id="formTeamACount">نتیجه ست: <span id="formTeamATotal">-</span></div>
                  </div>
                  <div class="sets-area" style="display:grid;grid-template-columns:1fr;gap:6px;margin-top:10px;">
                    <div style="display:grid;grid-template-columns:1fr;gap:6px;">
                      <input class="input small-set" id="formAset1" placeholder="ست1" />
                      <input class="input small-set" id="formAset2" placeholder="ست2" />
                      <input class="input small-set" id="formAset3" placeholder="ست3" />
                      <input class="input small-set" id="formAset4" placeholder="ست4" />
                      <input class="input small-set" id="formAset5" placeholder="ست5" />
                    </div>
                  </div>
                </div>
                <!-- Team B column -->
                <div class="team-column" style="display:flex;flex-direction:column;gap:8px;">
                  <label class="muted-small">تیم دوم</label>
                  <input id="formTeamB" class="input" placeholder="تیم دوم" />
                  <label class="muted-small" style="margin-top:6px;">لوگو تیم (از دستگاه)</label>
                  <input id="formTeamBLogoFile" type="file" accept="image/*" class="input" />
                  <input id="formTeamBLogo" type="hidden" />
                  <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px;align-items:flex-start;">
                    <img id="formTeamBPreview" src="" alt="پیش‌نمایش لوگو تیم دوم" style="width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid rgba(0,0,0,0.06);display:none;" />
                    <div class="muted-small" id="formTeamBCount">نتیجه ست: <span id="formTeamBTotal">-</span></div>
                  </div>
                  <div class="sets-area" style="display:grid;grid-template-columns:1fr;gap:6px;margin-top:10px;">
                    <div style="display:grid;grid-template-columns:1fr;gap:6px;">
                      <input class="input small-set" id="formBset1" placeholder="ست1" />
                      <input class="input small-set" id="formBset2" placeholder="ست2" />
                      <input class="input small-set" id="formBset3" placeholder="ست3" />
                      <input class="input small-set" id="formBset4" placeholder="ست4" />
                      <input class="input small-set" id="formBset5" placeholder="ست5" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="form-row" style="margin-top:8px;display:flex;gap:8px;align-items:center;">
                <input id="formDate" class="input jalali-input small-set" placeholder="تاریخ (YYYY/MM/DD)" />
                <input id="formTime" class="input small-set" placeholder="ساعت (HH:MM)" maxlength="5" />
              </div>
              <div class="form-row" style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-direction:column;">
                <input id="formHashtag" list="hashtagsList" class="input" placeholder="#هشتگ (اختیاری) مانند مسابقات-استانی-2025" style="width:100%;" />
                <datalist id="hashtagsList"></datalist>
              </div>
              <div class="form-row"><input id="formVenue" class="input" placeholder="مکان" style="flex:1;" /></div>
              <div class="form-row" style="flex-direction:column;">
                <label class="muted-small">یادداشت</label>
                <textarea id="formNotes" class="input" style="min-height:80px;"></textarea>
              </div>
              <div class="form-row" style="flex-direction:column;margin-top:8px;">
                <label class="muted-small">قوانین</label>
                <textarea id="formRules" class="input" style="min-height:60px;"></textarea>
              </div>
              <div class="form-row" style="margin-top:8px;">
                <label class="muted-small">تماس مسئول</label>
                <input id="formContact" class="input" placeholder="شماره تماس" />
              </div>
              <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;"><button id="saveMatchBtn" class="btn primary">ذخیره</button></div>
            </div>
          </div>
        </div>
      </section>
      <section id="view-players" class="hide">
        <div class="view-header fixed">
          <h3>بازیکنان</h3>
          <button class="back-btn" id="backPlayers"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <!-- Box 1: Actions (new player, export) -->
        <div class="card">
          <div style="display:flex;justify-content:flex-start;gap:8px;align-items:center;">
            <button id="openAddPlayerFromList" class="btn primary">بازیکن جدید</button>
            <button id="exportPlayersBtn" class="btn">خروجی لیست</button>
          </div>
        </div>

        <!-- Box 2: Filters and search -->
        <div class="card" style="margin-top:8px;">
          <div style="display:flex;flex-direction:column;gap:8px;">
            <div><!-- search stays full width -->
              <input id="playersSearch" class="search" placeholder="جستجوی سریع..." style="width:100%;" />
            </div>
            <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;align-items:center;">
              <div>
                <select id="filterCategory" class="input" style="width:100%;"><option value="">همه رده‌ها</option></select>
              </div>
              <div>
                <select id="filterInsurance" class="input" style="width:100%;"><option value="">همه بیمه‌ها</option><option value="expired">بیمه منقضی</option></select>
              </div>
              <div>
                <select id="sortPlayers" class="input" style="width:100%;"><option value="new">جدیدترین</option><option value="score">امتیاز</option><option value="name">نام</option></select>
              </div>
              <div>
                <!-- BMI filter: use a single select (dropdown) to match health page and simplify mobile UX -->
                <div id="bmiFilters">
                  <select id="filterBmi" class="input" style="width:100%;">
                    <option value="">همه BMI</option>
                    <option value="کم وزن">کم وزن</option>
                    <option value="سالم">سالم</option>
                    <option value="اضافه وزن">اضافه وزن</option>
                    <option value="چاق">چاق</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Box 3: Players list (direct, no extra card) -->
        <div id="playersList" class="full-list" style="margin-top:8px;"></div>
      </section>

      <section id="view-coaches" class="hide">
        <div class="view-header fixed">
          <h3>مربیان</h3>
          <button class="back-btn" id="backCoaches"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div class="topbar">
            <button id="addCoachBtn" class="btn primary">مربی جدید</button>
          </div>
          <div id="coachesList" class="full-list"></div>
        </div>
      </section>

      <section id="view-sessions" class="hide">
        <div class="view-header fixed">
          <h3>مدیریت تمرینات</h3>
          <button class="back-btn" id="backSessions"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <!-- tabs glued to header -->
          <div style="display:flex;gap:8px;border-bottom:1px solid rgba(0,0,0,0.06);padding-bottom:8px;margin-bottom:12px;">
            <button id="tabManageSessions" class="btn" style="border-bottom:2px solid #6366f1;">مدیریت جلسات</button>
            <button id="tabTrainingPlan" class="btn">برنامه تمرینات</button>
          </div>

          <div id="tabManageSessionsPanel">
            <div class="topbar">
              <div style="border:1px dashed rgba(0,0,0,0.08);padding:10px;border-radius:8px;">
                <div style="font-weight:700;margin-bottom:8px;">ایجاد جلسه جدید</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  <input id="sessionTitle" class="input" placeholder="عنوان جلسه (اختیاری)" />
                  <input id="sessionDate" class="input jalali-input" placeholder="تاریخ جلسه (YYYY/MM/DD)" style="text-align: center;" />
                  <select id="sessionCategory" class="input"><option value="">همه رده‌ها</option></select>
                  <select id="sessionCoach" class="input"><option value="">بدون مربی</option></select>
                  <button id="createSessionBtn" class="btn primary">ایجاد جلسه</button>
                </div>
              </div>
            </div>
            <div id="sessionsList" class="full-list"></div>
          </div>

          <div id="tabTrainingPlanPanel" style="display:none;">
            <div style="padding:6px 0 12px 0;">
              <div style="font-weight:700;margin-bottom:6px;">برنامهٔ تمرینات آینده</div>
            </div>
            <div style="margin-bottom:8px;">
              <div style="border:1px dashed rgba(0,0,0,0.08);padding:12px;border-radius:8px;display:flex;flex-direction:column;gap:8px;">
                <div style="font-weight:700;margin-bottom:4px;">یادداشت برنامهٔ تمرین</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                  <input id="planTitle" class="input" placeholder="عنوان تمرین" style="flex:1;min-width:180px;" />
                  <input id="planDate" class="input jalali-input" placeholder="تاریخ تمرین (YYYY/MM/DD)" style="width:130px;" />
                  <!-- اضافه شده: فیلد ساعت تمرین (ساعات 24-ساعته) -->
                  <div style="display:flex;gap:6px;align-items:center;">
                    <select id="planHour" class="input" style="width:70px;padding:6px;">
                      ${Array.from({length:24}).map((_,h)=>('<option value="'+String(h).padStart(2,'0')+'">'+String(h).padStart(2,'0')+'</option>')).join('')}
                    </select>
                    <select id="planMinute" class="input" style="width:60px;padding:6px;">
                      <option value="00">00</option>
                      <option value="15">15</option>
                      <option value="30">30</option>
                      <option value="45">45</option>
                    </select>
                  </div>
                  <!-- اضافه شده: انتخاب مربی برای برنامه تمرین -->
                  <select id="planCoach" class="input" style="width:160px;"></select>
                  <select id="planReminderMode" class="input" style="width:180px;"><option value="none">بدون یادآوری</option><option value="on_day">روز تمرین</option><option value="hours_2">2 ساعت قبل</option><option value="hours_24">24 ساعت قبل</option></select>
                </div>
                <textarea id="planBody" class="input" placeholder="خلاصه یا متن تمرین" style="min-height:140px;margin-top:4px;width:100%;resize:vertical"></textarea>
                        <div style="display:flex;gap:8px;margin-top:4px;align-items:center;">
                          <button id="savePlanBtn" class="btn primary">ذخیره برنامهٔ تمرین</button>
                          <div id="planSaveHint" class="muted" style="font-size:13px;">پس از ذخیره، برنامه در تب «برنامه تمرینات» نمایش داده می‌شود.</div>
                        </div>
              </div>
            </div>
            <div id="trainingPlanList" class="full-list"></div>
          </div>
        </div>
      </section>

      <!-- Competitions / Matches view -->
      <section id="view-competitions" class="hide">
        <div class="view-header fixed">
          <div style="display:flex;flex-direction:row;align-items:center;gap:8px;justify-content:flex-start;">
            <button class="back-btn" id="backCompetitions" style="margin-left:8px;"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
            <h3 style="margin:0;">مسابقات</h3>
          </div>
        </div>

        <div class="card">
          <div class="competitions-top">
            <div class="tabs-box" style="width:100%;margin-bottom:10px;background:var(--card);padding:8px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.04);">
              <div class="matches-tabs" id="matchesTabs" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start;">
                <button data-filter="all" class="active" style="flex:0 0 auto;min-width:80px;">همه</button>
                <button data-filter="scheduled" style="flex:0 0 auto;min-width:140px;">برنامه‌ریزی شده</button>
                <button data-filter="finished" style="flex:0 0 auto;min-width:110px;">انجام شده</button>
              </div>
            </div>
            <div class="matches-controls" style="display:flex;align-items:center;justify-content:space-between;gap:8px;width:100%;">
              <div class="matches-controls-left" style="display:flex;gap:8px;flex:1;align-items:center;min-width:0;">
                <input id="matchesSearch" class="input" placeholder="جستجو در مسابقات..." style="flex:1;min-width:140px;box-sizing:border-box;" />
                <div class="matches-date-wrap" style="display:flex;gap:6px;align-items:center;position:relative;min-width:0;">
                  <input id="matchesDateFilter" class="input jalali-input" placeholder="فیلتر بر اساس تاریخ (YYYY/MM/DD)" style="width:180px;text-align:center;box-sizing:border-box;" autocomplete="off" />
                  <button id="clearMatchesDate" class="btn" title="پاک کردن فیلتر">✖</button>
                  <div id="matchesDateWidget" style="position:absolute;right:0;top:46px;z-index:1200;display:none;box-shadow:0 10px 24px rgba(0,0,0,0.12);background:var(--card);border-radius:8px;padding:8px;min-width:300px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                      <button id="mdwPrev" class="btn">‹</button>
                      <div style="font-weight:700;"> <span id="mdwTitle">-</span> </div>
                      <button id="mdwNext" class="btn">›</button>
                    </div>
                    <div id="mdwGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;font-size:13px;"> <!-- days will render here -->
                    </div>
                    <div style="display:flex;justify-content:flex-end;margin-top:8px;gap:8px;"><button id="mdwToday" class="btn">امروز</button><button id="mdwClose" class="btn">بستن</button></div>
                  </div>
                </div>
              </div>
              <div class="muted-small" style="white-space:nowrap;">تعداد: <span id="matchesCount">0</span></div>
            </div>
          </div>

          <div id="matchesList" class="matches-list" style="margin-top:12px;"></div>
        </div>

        <div id="matchDetailModal" class="modal hide">
          <div class="modal-content">
              <div class="modal-header"><strong id="detailTitle">جزئیات مسابقه</strong><button class="modal-close match-detail-close" id="closeMatchDetail">×</button></div>
            <div class="modal-body" id="matchDetailBody"></div>
          </div>
        </div>

        <!-- Share overlay: framed preview + color selectors + action buttons -->
        <div id="shareOverlay" class="modal hide" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;">
          <div style="position:fixed;inset:0;background:rgba(0,0,0,0.55);backdrop-filter:blur(6px);" id="shareOverlayBackdrop"></div>
          <div class="share-modal-outer" style="position:relative;z-index:10000;width:min(94vw,740px);max-height:92vh;display:flex;flex-direction:column;gap:12px;align-items:center;overflow:auto;padding:8px;">
            <div class="share-modal-inner" style="width:100%;background:#fff;border-radius:14px;padding:12px;box-shadow:0 10px 40px rgba(0,0,0,0.12);box-sizing:border-box;display:flex;flex-direction:column;">
            <!-- framed preview box -->
            <div id="shareCard" class="share-preview-wrap" style="width:100%;/*aspect-ratio:9/16;*/border-radius:16px;overflow:hidden;border:1px solid rgba(0,0,0,0.06);background:linear-gradient(180deg,#ff6b6b,#ff9ac2);display:flex;flex-direction:column;max-height:76vh;">
              <div class="card-scroll" style="flex:1 1 auto;display:flex;flex-direction:column;padding:22px;gap:10px;align-items:center;justify-content:flex-start;">
                <div style="height:42px;flex-shrink:0"></div>
                <div id="shareLogosRow" style="width:100%;display:flex;align-items:center;justify-content:space-around;gap:12px;margin-bottom:8px;">
                  <img id="shareLogoA" src="icons/volleyball (1).png" alt="logoA" style="width:120px;height:120px;border-radius:12px;object-fit:contain;background:rgba(255,255,255,0.06);padding:8px;" />
                  <img id="shareLogoB" src="icons/volleyball (1).png" alt="logoB" style="width:120px;height:120px;border-radius:12px;object-fit:contain;background:rgba(255,255,255,0.06);padding:8px;" />
                </div>
                <div id="shareTeamsRow" style="width:100%;display:flex;align-items:center;justify-content:center;gap:12px;font-weight:900;color:#fff;font-size:22px;">
                  <div id="shareTeamA" style="flex:1;text-align:right;padding-right:10px;">تیم الف</div>
                  <div style="flex:0 0 auto;font-size:18px;opacity:0.95">VS</div>
                  <div id="shareTeamB" style="flex:1;text-align:left;padding-left:10px;">تیم ب</div>
                </div>
                <div id="shareInfo" style="width:100%;margin-top:10px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(0,0,0,0.04));color:#fff;display:flex;flex-direction:column;gap:8px;font-weight:600;">
                  <div style="display:flex;justify-content:space-between;"><span>نوع</span><span id="shareKind">-</span></div>
                  <div style="display:flex;justify-content:space-between;"><span>تاریخ</span><span id="shareDate">-</span></div>
                  <div style="display:flex;justify-content:space-between;"><span>مکان</span><span id="shareVenue">-</span></div>
                  <div style="display:flex;justify-content:space-between;"><span>ساعت</span><span id="shareTime">-</span></div>
                </div>
              </div>
            </div>

            <!-- color selectors (above buttons) -->
            <div class="share-controls-wrap" style="width:100%;display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;padding:6px 6px;flex:0 0 auto;">
              <div style="display:flex;align-items:center;gap:6px;"><label style="font-size:13px;color:var(--muted);">رنگ آغاز</label><input id="shareColorA" type="color" value="#ff6b6b" style="width:48px;height:34px;border-radius:6px;border:0;padding:0;" /></div>
              <div style="display:flex;align-items:center;gap:6px;"><label style="font-size:13px;color:var(--muted);">رنگ پایان</label><input id="shareColorB" type="color" value="#ff9ac2" style="width:48px;height:34px;border-radius:6px;border:0;padding:0;" /></div>
            </div>

            <!-- buttons row (side-by-side but responsive) -->
            <div class="share-actions-wrap" style="width:100%;display:flex;padding:8px 6px;flex:0 0 auto;">
              <div style="flex:1;display:flex;gap:10px;align-items:center;justify-content:space-between;">
                <button id="closeShareOverlay" class="btn" style="flex:1 1 auto;max-width:160px;">بستن</button>
                <button id="shareToSocialBtn" class="btn primary birthday-share-btn" style="flex:1 1 auto;max-width:420px;">اشتراک به صورت عکس</button>
              </div>
            </div>
            </div>
          </div>
        </div>

        <!-- Full-page match create/edit view was moved to be a top-level section -->

        

        <!-- Inline date filter replaced calendar modal for easier access -->

        <div class="fab" id="addMatchFab" title="افزودن مسابقه">+</div>
      </section>

      <section id="view-payments" class="hide">
        <div class="view-header fixed">
          <h3>مدیریت شهریه</h3>
          <button class="back-btn" id="backPayments"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div style="display: grid; gap: 12px; margin-top: 12px;">
            <div style="border:1px solid rgba(0,0,0,0.06);padding:12px;border-radius:8px;background:var(--card);">
              <div style="display:flex;flex-direction:column;gap:8px;">
                <input id="paymentPlayerSearch" class="input" placeholder="جستجوی بازیکن..." />
                <select id="paymentPlayer" class="input"><option value="">انتخاب بازیکن</option></select>
              </div>
              <div style="display: grid; gap: 8px; margin-top:8px;">
                <input id="paymentDate" class="input jalali-input" placeholder="تاریخ پرداخت (YYYY/MM/DD)" />
                <small class="muted">تاریخ پرداخت واقعی</small>
                <div style="display: flex; gap: 8px;">
                  <select id="paymentMonth" class="input"></select>
                  <select id="paymentYear" class="input"></select>
                </div>
                <small class="muted">ماه و سال دوره مالی شهریه</small>
                <input id="paymentAmount" class="input" placeholder="مبلغ (تومان)" type="text" />
                <select id="paymentType" class="input"><option value="">نوع پرداخت</option><option>نقد</option><option>رسید</option><option>کارت به کارت</option></select>
              </div>
              <div style="margin-top:8px;display:flex;justify-content:flex-end;">
                <button id="addPaymentBtn" class="btn primary">ثبت پرداخت</button>
              </div>
            </div>
            <hr style="margin: 12px 0;" />
            <div style="border:1px solid rgba(0,0,0,0.06);padding:12px;border-radius:8px;background:var(--card);display:flex;gap:8px;">
              <button id="showDebtorsBtn" class="btn warning">نمایش بدهکاران آخرین دوره</button>
              <button id="reportPaymentsBtn" class="btn">گزارش پرداخت</button>
            </div>
          </div>
          <div id="paymentList" class="full-list" style="margin-top:12px;"></div>
        </div>
      </section>

      <section id="view-insurance" class="hide">
        <div class="view-header fixed">
          <h3>مدیریت بیمه‌ها</h3>
          <button class="back-btn" id="backInsurance"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div class="topbar">
            <div>
              <select id="insuranceCategoryFilter" class="input"><option value="">همه رده‌ها</option></select>
              <select id="insuranceStatusFilter" class="input"><option value="">همه وضعیت‌ها</option><option value="active">فعال</option><option value="expired">منقضی</option><option value="none">بدون بیمه</option></select>
            </div>
          </div>
          <div id="insuranceList" class="full-list"></div>
        </div>
      </section>

      <section id="view-health" class="hide">
        <div class="view-header fixed">
          <h3>سلامت بازیکنان</h3>
          <button class="back-btn" id="backHealth"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div class="topbar">
            <div>
              <input id="healthSearch" class="search" placeholder="جستجوی بازیکن..." />
              <select id="healthBmiFilter" class="input"><option value="">همه وضعیت BMI</option><option value="کم وزن">کم وزن</option><option value="سالم">سالم</option><option value="اضافه وزن">اضافه وزن</option><option value="چاق">چاق</option></select>
              
            </div>
          </div>
          <div id="healthList" class="health-grid"></div>
        </div>
      </section>

      <section id="view-player-form" class="hide">
        <div class="view-header fixed">
          <h3 id="playerFormTitle">ثبت بازیکن</h3>
          <button class="back-btn" id="backPlayerForm"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="playerFormContent"></div>
        </div>
      </section>

      <section id="view-coach-form" class="hide">
        <div class="view-header fixed">
          <h3 id="coachFormTitle">افزودن مربی</h3>
          <button class="back-btn" id="backCoachForm"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="coachFormContent"></div>
        </div>
      </section>

      <section id="view-session-attendance" class="hide">
        <div class="view-header fixed">
          <h3 id="attendanceTitle">حضور/غیاب</h3>
          <button class="back-btn" id="backAttendance"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="attendanceContent"></div>
        </div>
      </section>

      <section id="view-note" class="hide">
        <div class="view-header fixed">
          <h3>یادداشت برای بازیکن</h3>
          <button class="back-btn" id="backNote"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="noteContent"></div>
        </div>
      </section>

      <section id="view-player-profile" class="hide">
        <div class="view-header fixed">
          <h3 id="profileTitle">پروفایل بازیکن</h3>
          <button class="back-btn" id="backProfile"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="profileContent"></div>
        </div>
      </section>

      <section id="view-membership" class="hide">
        <div class="view-header fixed">
          <h3 id="membershipTitle">صدور کارت عضویت</h3>
          <button class="back-btn" id="backMembership"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="membershipContent"></div>
        </div>
      </section>

      <section id="view-all-sessions" class="hide">
        <div class="view-header fixed">
          <h3 id="allSessionsTitle">همه جلسات</h3>
          <button class="back-btn" id="backAllSessions"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="allSessionsContent"></div>
        </div>
      </section>

      <section id="view-all-payments" class="hide">
        <div class="view-header fixed">
          <h3 id="allPaymentsTitle">همه پرداخت‌ها</h3>
          <button class="back-btn" id="backAllPayments"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="allPaymentsContent"></div>
        </div>
      </section>

  <!-- duplicate competitions section removed to keep single view-competitions block -->

      <section id="view-debtors" class="hide">
        <div class="view-header fixed">
          <h3>بدهکاران دوره</h3>
          <button class="back-btn" id="backDebtors"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="debtorsContent"></div>
        </div>
      </section>

      <section id="view-payment-report" class="hide">
        <div class="view-header fixed">
          <h3>گزارش پرداخت‌ها</h3>
          <button class="back-btn" id="backPaymentReport"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="paymentReportContent"></div>
        </div>
      </section>

      <section id="view-rank-editor" class="hide">
        <div class="view-header fixed">
          <h3>ویرایش رده‌ها</h3>
          <button class="back-btn" id="backRankEditor"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="rankEditorContent"></div>
        </div>
      </section>

      <section id="view-players-export" class="hide">
        <div class="view-header fixed">
          <h3>خروجی بازیکنان</h3>
          <button class="back-btn" id="backPlayersExport"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="playersExportContent"></div>
        </div>
      </section>

      <section id="view-event-form" class="hide">
        <div class="view-header fixed">
          <h3 id="eventFormTitle">ثبت رویداد</h3>
          <button class="back-btn" id="backEventForm"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="eventFormContent"></div>
        </div>
      </section>

      <section id="view-settings" class="hide">
        <div class="view-header fixed">
          <h3>ویرایش تنظیمات</h3>
          <button class="back-btn" id="backSettings"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="settingsContent"></div>
        </div>
      </section>

      <section id="view-edit-payment" class="hide">
        <div class="view-header fixed">
          <h3>ویرایش پرداخت</h3>
          <button class="back-btn" id="backEditPayment"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="editPaymentContent"></div>
        </div>
      </section>

      <section id="view-birthday-greeting" class="hide">
  <div class="view-header fixed">
    <h3>تبریک تولد</h3>
    <button class="back-btn" id="backBirthdayGreeting">
      <svg viewBox="0 0 24 24">
        <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/>
      </svg>
    </button>
  </div>
  <div class="card">
    <div id="birthdayGreetingContent" style="text-align: center; animation: fadeIn 0.5s ease-in-out;"></div>
  </div>
</section>

      <section id="view-account" class="hide">
       <div class="view-header fixed">
       <h3>حساب کاربری</h3>
       <button class="back-btn" id="backAccount"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
       </div>
       <div class="card" style="padding:0;overflow:visible;">
         <!-- Settings card (separate) -->
         <div class="card" style="padding:12px 16px; margin:12px; border-radius:12px; background:linear-gradient(90deg,#facc15,#fbbf24);">
             <div id="settingsBox" style="display:flex;justify-content:center;align-items:center;gap:12px;">
             <button id="settingsFromAccount" class="btn" style="background:transparent;border:none;color:#111;font-weight:700;">تنظیمات</button>
           </div>
         </div>
         <!-- Login / Signup card (separate) -->
         <div id="embeddedAuthBox" class="card" style="padding:12px;border-top:1px solid rgba(0,0,0,0.04);background:var(--card);border-radius:10px;margin:12px 12px 0 12px;">
           <div id="authDebug" style="font-size:13px;color:var(--muted);margin-bottom:8px;">وضعیت احراز هویت: بررسی...</div>
           <style>
             /* Scoped small adjustments to blend with host app */
             #embeddedAuthBox .auth-container { box-shadow:none; border-radius:12px; background:var(--card); }
             #embeddedAuthBox .tab-btn { font-size:14px; padding:10px; color:var(--muted); text-align:center; box-shadow: 0 1px 2px rgba(0,0,0,0.04); border-radius:10px; }
             #embeddedAuthBox .form-tabs { display:flex; flex-direction:row; gap:8px; margin-bottom:12px; flex-wrap:nowrap; }
             #embeddedAuthBox .form-tabs .tab-btn { flex:1; min-width:0; text-align:center; }
             #embeddedAuthBox .tab-btn.active { color:var(--accent); font-weight:700; box-shadow:0 4px 10px rgba(0,0,0,0.08); transform:translateY(-1px); }
             #embeddedAuthBox .form-content { padding-top:8px; }
               /* Ensure only active form-content is visible */
               #embeddedAuthBox .form-content { display:none !important; }
               #embeddedAuthBox .form-content.active { display:block !important; }
             #embeddedAuthBox .form-control { border:1px solid rgba(0,0,0,0.06); border-radius:10px; padding:10px 12px; box-sizing:border-box; min-height:40px; font-size:inherit; width:100%; }
             /* Ensure password input matches email input sizing */
             #embeddedAuthBox .password-row input { border:1px solid rgba(0,0,0,0.06); border-radius:10px; padding:10px 12px; box-sizing:border-box; min-height:40px; font-size:inherit; }
             #embeddedAuthBox #toggleLoginPassword { height:36px; }
             /* Password field layout: place eye button outside the input in a horizontal row */
             #embeddedAuthBox .form-group { position:relative; }
             #embeddedAuthBox .password-row { display:flex; gap:8px; align-items:center; min-width:0; }
             #embeddedAuthBox .password-row input { flex:1; padding-right:12px; min-width:0; }
             #toggleLoginPassword { border:none; background:transparent; padding:6px; width:34px; height:34px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; border-radius:6px; }
             #toggleLoginPassword svg { width:18px; height:18px; color:var(--muted); }
             @media (max-width:720px) {
               #embeddedAuthBox .auth-container { min-height: auto; }
               #embeddedAuthBox .auth-welcome { display:none; }
               #embeddedAuthBox .auth-form-container { padding:12px; }
               #embeddedAuthBox .tab-btn { font-size:13px; padding:8px; }
             }
           </style>

           <!-- Paste of user's auth HTML (trimmed head/doctype/script) -->
           <div class="auth-container" style="display:flex;flex-direction:column;">
             <div class="auth-welcome" style="padding:12px;border-radius:10px;margin-bottom:12px;">
               <h2 style="font-size:18px;margin-bottom:6px;color:var(--text);">به سیستم ما خوش آمدید</h2>
               <p style="font-size:13px;margin:0;color:var(--muted);">برای استفاده از تمامی امکانات سیستم، وارد شوید یا ثبت نام کنید.</p>
             </div>

             <div class="auth-form-container" style="padding:6px;position:relative;">
               <div id="connectionTop" style="display:flex;align-items:center;justify-content:flex-start;gap:10px;margin-bottom:10px;">
                 <span style="font-size:13px;color:var(--muted);">وضعیت اتصال:</span>
                 <span id="statusIndicator" class="status-indicator status-disconnected" style="width:12px;height:12px;border-radius:50%;display:inline-block;"></span>
                 <span id="statusText" style="font-size:13px;color:var(--muted);">آفلاین</span>
               </div>

               <div class="form-tabs" style="display:flex;gap:8px;margin-bottom:12px;">
                 <button class="tab-btn btn" data-tab="login" style="flex:1;border-radius:10px;">ورود</button>
                 <button class="tab-btn btn" data-tab="signup" style="flex:1;border-radius:10px;">ثبت نام</button>
                 <button class="tab-btn btn" data-tab="recovery" style="flex:1;border-radius:10px;">بازیابی</button>
               </div>

                <datalist id="recentEmails"></datalist>

               <div id="loginFormEmbedded" class="form-content active">
                 <div id="loginAlert" class="alert"></div>
                 <div class="form-group"><label for="loginEmail">ایمیل</label><input list="recentEmails" type="email" id="loginEmail" class="form-control" placeholder="ایمیل خود را وارد کنید"></div>
                 <div class="form-group">
                   <label for="loginPassword">رمز عبور</label>
                   <div class="password-row">
                     <input type="password" id="loginPassword" class="form-control" placeholder="رمز عبور خود را وارد کنید">
                     <button type="button" id="toggleLoginPassword" title="نمایش/مخفی کردن رمز">
                       <svg id="toggleLoginPasswordIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                     </button>
                   </div>
                 </div>
                 <button id="loginBtn" class="btn primary" style="width:100%;margin-top:8px;display:inline-flex;align-items:center;justify-content:center;gap:8px;">
                   <span class="inline-spinner" aria-hidden="true" style="width:18px;height:18px;border-radius:50%;"></span>
                   <span class="login-label">ورود</span>
                 </button>
                 <div id="loginLoading" class="loading"><div class="loading-spinner"></div></div>
               </div>

               <div id="signupFormEmbedded" class="form-content">
                 <div id="signupAlert" class="alert"></div>
                 <div class="form-group"><label for="signupEmail">ایمیل</label><input list="recentEmails" type="email" id="signupEmail" class="form-control" placeholder="ایمیل خود را وارد کنید"></div>
                 <div class="form-group"><label for="signupPassword">رمز عبور</label><input type="password" id="signupPassword" class="form-control" placeholder="رمز عبور خود را وارد کنید"></div>
                 <div class="form-group"><label for="confirmPassword">تکرار رمز عبور</label><input type="password" id="confirmPassword" class="form-control" placeholder="رمز عبور خود را تکرار کنید"></div>
                 <button id="signupBtn" class="btn primary" style="width:100%;margin-top:8px;display:inline-flex;align-items:center;justify-content:center;gap:8px;">
                   <span class="inline-spinner" aria-hidden="true" style="width:18px;height:18px;border-radius:50%;"></span>
                   <span class="signup-label">ثبت نام</span>
                 </button>
               </div>

               <div id="recoveryFormEmbedded" class="form-content">
                 <div id="recoveryAlert" class="alert"></div>
                 <div class="form-group"><label for="recoveryEmail">ایمیل</label><input type="email" id="recoveryEmail" class="form-control" placeholder="ایمیل خود را وارد کنید"></div>
                 <button id="recoveryBtn" class="btn primary" style="width:100%;margin-top:8px;display:inline-flex;align-items:center;justify-content:center;gap:8px;">
                   <span class="inline-spinner" aria-hidden="true" style="width:18px;height:18px;border-radius:50%;"></span>
                   <span class="recovery-label">ارسال لینک بازیابی</span>
                 </button>
               </div>
             </div>
           </div>
          <!-- Account profile container (populated after login) -->
          <div id="accountProfileContainer" style="margin-top:12px;display:none;">
            <div class="card" style="padding:12px;border-radius:10px;">
                <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
                <img id="accountAvatar" src="icons/icon-maskable-192.png" alt="avatar" style="width:72px;height:72px;border-radius:50%;object-fit:cover;" />
                  <div style="flex:1;min-width:0;">
                  <div id="accountName" style="font-weight:700;color:var(--text)">—</div>
                  <div id="accountEmail" style="color:var(--muted);font-size:13px">—</div>
                  <div id="accountPhone" style="color:var(--muted);font-size:13px">—</div>
                  <hr style="border:none;border-top:1px solid rgba(0,0,0,0.06);margin:10px 0;" />
                  <div style="display:flex;align-items:center;gap:8px;">
                    <div id="backupIcon" style="width:18px;height:18px;border-radius:50%;background:transparent;display:inline-block;vertical-align:middle;"></div>
                    <div id="backupStatus" style="font-size:13px;color:var(--muted);">--</div>
                  </div>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px;">
                  <button id="editProfileToggle" class="btn">ویرایش</button>
                  <button id="logoutBtn" class="btn" style="background:#ef4444;color:#fff;border:none;">خروج</button>
                  <div style="height:6px"></div>
                  <button id="backupNowBtn" class="btn">همگام‌سازی الآن</button>
                </div>
              </div>
            </div>
          </div>
          <!-- Editable profile box shown after login -->
          <div id="profileEditBox" style="margin-top:12px;display:none;">
            <div class="card" style="padding:12px;border-radius:10px;">
              <h3 style="margin:0 0 8px 0;">ویرایش پروفایل</h3>
              <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;">
                <!-- avatar editing via ImageKit -->
                <div style="min-width:120px;">
                  <img id="editAvatarPreview" src="icons/icon-maskable-192.png" alt="avatar" style="width:120px;height:120px;border-radius:12px;object-fit:cover;display:block;margin-bottom:8px;" />
                  <!-- module uploader (use the module uploader below) -->
                  <div id="uploadAvatarMsg" style="font-size:13px;color:var(--muted);margin-top:6px;"></div>
                </div>
                <!-- uploader removed per user request -->
                <div style="flex:1;min-width:220px;">
                  <div style="display:grid;gap:8px;">
                    <div><label>نام</label><input id="profileFirst" class="input" /></div>
                    <div><label>نام خانوادگی</label><input id="profileLast" class="input" /></div>
                    <div><label>ایمیل</label><input id="profileEmail" class="input" readonly /></div>
                    <div><label>تلفن</label><input id="profilePhone" class="input" /></div>
                    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
                      <button id="saveProfileBtn" class="btn primary">ذخیره پروفایل</button>
                    </div>
                    <div id="profileMsg" style="font-size:13px;color:var(--muted);margin-top:6px;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
         </div>
         <!-- END: embedded auth box -->
       </div>
     </section>
  <!-- MANAGEMENT VIEW REMOVED PER USER REQUEST -->
    </div>
  </main>
  <div id="jalaliCalendar" class="jalali-calendar hide" aria-hidden="true"></div>
  <!-- Birthday modal container -->
  <div id="birthdayModal" class="hide" aria-hidden="true" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:2000;">
    <div style="background:rgba(0,0,0,0.5);position:absolute;inset:0;" id="birthdayModalBackdrop"></div>
    <div id="birthdayModalCard" style="position:relative;background:var(--card);padding:20px;border-radius:12px;max-width:420px;width:90%;box-shadow:0 8px 30px var(--shadow);text-align:center;">
      <div id="birthdayModalContent"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center;">
        <button id="birthdayModalClose" class="btn">بستن</button>
      </div>
    </div>
  </div>
  <!-- Plan view modal -->
  <div id="planModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;padding:20px;z-index:2000;">
    <div style="background:#fff;max-width:720px;width:100%;border-radius:8px;padding:16px;box-shadow:0 6px 30px rgba(0,0,0,0.25);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <h3 id="planModalTitle" style="margin:0">عنوان</h3>
        <div><button class="btn" id="closePlanModal">بستن</button></div>
      </div>
      <div style="color:#666;margin-bottom:12px"><strong>تاریخ:</strong> <span id="planModalDate"></span></div>
      <div id="planModalBody" style="white-space:pre-wrap;color:#222"></div>
    </div>
  </div>

  <!-- ImageKit uploader removed -->
</div>

<!-- Receipt modal for sending payment receipts -->
<div id="receiptModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;padding:20px;z-index:2000;">
  <div style="background:#fff;max-width:520px;width:100%;border-radius:8px;padding:16px;box-shadow:0 6px 30px rgba(0,0,0,0.25);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h3 style="margin:0">ارسال رسید پرداخت</h3>
      <div><button class="btn" id="closeReceiptModal">بستن</button></div>
    </div>
    <div style="display:grid;gap:8px;">
      <div><strong id="receiptPlayerName">—</strong></div>
      <input id="receiptPhone" class="input" placeholder="شماره تلفن (والد یا بازیکن)" />
      <input id="receiptAmount" class="input" placeholder="مبلغ" />
      <textarea id="receiptNote" class="input" placeholder="متن رسید" style="min-height:100px"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button id="sendReceiptBtn" class="btn primary">ارسال (SMS)</button>
        <button id="saveReceiptBtn" class="btn">ذخیره رسید</button>
      </div>
    </div>
  </div>
</div>

<nav class="bottom-tabs" id="mobileMenu">
  <button class="tab-btn" id="tabAccount" title="حساب">
    <span class="material-icons">account_circle</span>
    <div class="tab-label">حساب</div>
  </button>
  <button class="tab-btn" id="tabPayments" title="شهریه">
    <span class="material-icons">attach_money</span>
    <div class="tab-label">شهریه</div>
  </button>
  <button class="tab-btn" id="tabCoaches" title="مربیان">
    <span class="material-icons">emoji_events</span>
    <div class="tab-label">مربیان</div>
  </button>
  <button class="tab-btn" id="tabSessions" title="تمرینات">
    <span class="material-icons">sports_volleyball</span>
    <div class="tab-label">تمرینات</div>
  </button>
  <button class="tab-btn" id="tabCompetitions" title="مسابقات">
    <span class="material-icons">military_tech</span>
    <div class="tab-label">مسابقات</div>
  </button>
</nav>

<script>
/* ================================================================
  SECTION: Helpers
  - small DOM helpers, string utilities, uid, escapeHtml, etc.
  ================================================================ */
/* Utility Helpers */
function qs(sel, root) { return (root || document).querySelector(sel); }

// Safe event binding helper: won't crash if element is missing
function on(sel, evt, fn, root = document) {
  const r = root || document;
  try {
    const els = r.querySelectorAll(sel);
    if (!els || els.length === 0) return;
    els.forEach(el => el.addEventListener(evt, fn, false));
  } catch (e) {
    // silent
  }

}

function qsa(sel, root) { return Array.from((root || document).querySelectorAll(sel)); }
function uid(prefix) { return (prefix || 'id') + '_' + Date.now() + '_' + Math.floor(Math.random() * 900); }
// Persistent device identifier (used for backups/devices registration)
function getDeviceId() {
  try {
    const key = 'vb_device_id_v1';
    let did = localStorage.getItem(key);
    if (!did) {
      // use a stable uuid-like value (not RFC4122) but good enough for client id
      did = 'dev_' + Date.now() + '_' + Math.floor(Math.random() * 1000000);
      localStorage.setItem(key, did);
    }
    return did;
  } catch (e) { return 'dev_unknown'; }
}
function getDeviceName() {
  try { return localStorage.getItem('vb_device_name') || (navigator.userAgent || 'unknown'); } catch(e){ return 'unknown'; }
}
function escapeHtml(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
// Map internal kind keys to Persian display labels
function mapKindToPersian(kind) {
  if (!kind) return '-';
  const k = String(kind).toLowerCase();
  if (k === 'friendly' || k === 'دوستانه') return 'دوستانه';
  if (k === 'league' || k === 'لیگ') return 'لیگ';
  if (k === 'knockout' || k === 'حذفی') return 'حذفی';
  if (k === 'group' || k === 'گروهی') return 'گروهی';
  if (k === 'tournament' || k === 'تورنمنت' || k === 'تورنامنت') return 'تورنمنت';
  return kind;
}
function normPersian(s) { return String(s || '').replace(/ي/g, 'ی').replace(/ك/g, 'ک').replace(/[\u200c\s]+/g, ' ').trim().toLowerCase(); }
function formatNumber(input) {
  try {
    // normalize Persian/Arabic-Indic digits to ASCII
    let s = String(input.value || '');
    const persianDigits = '۰۱۲۳۴۵۶۷۸۹';
    const arabicDigits = '٠١٢٣٤٥٦٧٨٩';
    for (let i = 0; i < 10; i++) {
      s = s.replace(new RegExp(persianDigits[i], 'g'), String(i));
      s = s.replace(new RegExp(arabicDigits[i], 'g'), String(i));
    }
    // remove any non-digit characters
    s = s.replace(/[^0-9]/g, '');
    // format with thousand separators
    s = s.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    input.value = s;
  } catch (e) {
    input.value = input.value.replace(/\D/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }
}

// Test helper: call `testCaptureShare(id)` from console to open overlay and capture
window.testCaptureShare = async function(matchId) {
  console.log('html2canvas available?', typeof html2canvas !== 'undefined');
  if (!matchId) {
    console.warn('Please provide a match id. Example: testCaptureShare("match-1");');
    return;
  }
  try {
    openShareOverlay(matchId);
    // small delay to allow overlay to render
    await new Promise(r => setTimeout(r, 220));
    const m = (state.competitions||[]).find(x=>x.id===matchId);
    if (!m) return console.warn('match not found in state');
    await captureAndShareModal(m);
    console.log('capture attempted');
  } catch (e) { console.error('testCaptureShare failed', e); }
}

// Capture the visible share modal quickly using html2canvas (MVP):
async function captureAndShareModal(m) {
  const overlay = qs('#shareOverlay');
  const card = qs('#shareCard');
  if (!overlay || !card) throw new Error('Share overlay or card not found');
  // Prefer deterministic canvas renderer (faster, no DOM snapshot):
  try {
    // prepare safe data (convert File logos to data URLs if necessary)
    const safeM = { ...m };
    async function fileToDataUrl(f) {
      if (!f) return f;
      if (typeof f === 'string') return f;
      if (!(f instanceof File)) return f;
      return await new Promise(res => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(f); });
    }
    try {
      safeM.logoA = await fileToDataUrl(safeM.logoA);
      safeM.logoB = await fileToDataUrl(safeM.logoB);
    } catch (e) {
      console.warn('logo conversion failed', e);
    }

    const colorA = (qs('#shareColorA') && qs('#shareColorA').value) || '#ff6b6b';
    const colorB = (qs('#shareColorB') && qs('#shareColorB').value) || '#ff9ac2';

    // If logos are missing from the match data, fall back to the visible image elements in the modal
    try {
      const domLogoA = (qs('#shareLogoA') && qs('#shareLogoA').src) || '';
      const domLogoB = (qs('#shareLogoB') && qs('#shareLogoB').src) || '';
      if (!safeM.logoA) safeM.logoA = domLogoA || (state.settings && state.settings.logo) || 'icons/volleyball (1).png';
      if (!safeM.logoB) safeM.logoB = domLogoB || 'icons/volleyball (1).png';
    } catch (e) { console.debug('logo fallback read failed', e); }

    // pass the visible court background (if present) to the deterministic renderer so it can draw it
    const courtEl = qs('#shareCourtBg');
    const courtImage = courtEl ? courtEl.src : null;

    const blob = await renderShareCanvasFromData(safeM, { width: 1080, height: 1920, colorA, colorB, courtImage });
    if (blob) {
      // attempt native share with files
      const file = new File([blob], (safeM.title||'match') + '.png', { type: 'image/png' });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try { await navigator.share({ files: [file], title: safeM.title || 'مسابقه', text: safeM.teamA + ' vs ' + safeM.teamB }); return; } catch (e) { console.warn('navigator.share(files) failed', e); }
      }
      // fallback: download
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = (safeM.title||'match') + '.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      return;
    }
  } catch (err) {
    console.warn('Renderer capture failed, falling back to DOM snapshot', err);
  }

  // Fallback: clone + html2canvas snapshot (previous behavior)
  const clone = card.cloneNode(true);
  clone.style.width = getComputedStyle(card).width;
  clone.style.height = getComputedStyle(card).height;
  clone.style.boxSizing = 'border-box';
  clone.style.margin = '0';
  clone.style.position = 'relative';
  clone.id = 'shareCardClone';

  Array.from(clone.querySelectorAll('.no-capture, button, input[type="color"], .share-controls')).forEach(el => {
    el.classList.add('capture-hide');
    if (el.classList && el.classList.contains('share-controls')) el.classList.add('collapse');
  });

  const stage = document.createElement('div');
  stage.style.position = 'fixed';
  stage.style.left = '-9999px';
  stage.style.top = '0';
  stage.style.zIndex = '99999';
  stage.appendChild(clone);
  document.body.appendChild(stage);

  try {
    const canvas = await html2canvas(clone, { backgroundColor: null, scale: 2, useCORS: true, allowTaint: true });
    const blob2 = await new Promise(res => canvas.toBlob(res, 'image/png'));
    const filesArray = [ new File([blob2], 'match.png', { type: 'image/png' }) ];
    if (navigator.canShare && navigator.canShare({ files: filesArray })) {
      try { await navigator.share({ files: filesArray, title: m.title || 'مسابقه', text: m.teamA + ' vs ' + m.teamB }); document.body.removeChild(stage); return; } catch (e) { console.warn('navigator.share(files) failed', e); }
    }
    const url = URL.createObjectURL(blob2);
    const a = document.createElement('a'); a.href = url; a.download = (m.title||'match') + '.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    document.body.removeChild(stage);
    return;
  } catch (e) {
    document.body.removeChild(stage);
    throw e;
  }
}

// Keep a stable reference to the primary capture implementation so wrapper can delegate
window._captureAndShareModalImpl = captureAndShareModal;

/* ================================================================
  SECTION: Date Utilities (Jalali <-> Gregorian)
  - conversion helpers, iso/jalali helpers, todayJalali, birthdays
  ================================================================ */
/* Jalali <-> Gregorian Utils */
function gregorian_to_jalali(gy, gm, gd) {
  gy = parseInt(gy); gm = parseInt(gm); gd = parseInt(gd);
  var g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
  var jy = (gy <= 1600) ? 0 : 979;
  gy -= (gy <= 1600) ? 621 : 1600;
  var gy2 = (gm > 2) ? (gy + 1) : gy;
  var days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100))
          + (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
  jy += 33 * (parseInt(days / 12053));
  days %= 12053;
  jy += 4 * (parseInt(days / 1461));
  days %= 1461;
  jy += parseInt((days - 1) / 365);
  if (days > 365) days = (days - 1) % 365;
  var jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
  var jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
  return [jy, jm, jd];
}
function jalali_to_gregorian(jy, jm, jd) {
  jy = parseInt(jy); jm = parseInt(jm); jd = parseInt(jd);
  var gy = (jy <= 979) ? 621 : 1600;
  jy -= (jy <= 979) ? 0 : 979;
  var days = (365 * jy) + ((parseInt(jy / 33)) * 8) + (parseInt(((jy % 33) + 3) / 4))
          + 78 + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186);
  gy += 400 * (parseInt(days / 146097));
  days %= 146097;
  if (days > 36524) {
      gy += 100 * (parseInt(--days / 36524));
      days %= 36524;
      if (days >= 365) days++;
  }
  gy += 4 * (parseInt((days) / 1461));
  days %= 1461;
  gy += parseInt((days - 1) / 365);
  if (days > 365) days = (days - 1) % 365;
  var gd = days + 1;
  var sal_a = [0, 31, ((gy % 4 == 0 && gy % 100 != 0) || (gy % 400 == 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
  var gm;
  for (gm = 0; gm < 13; gm++) {
      var v = sal_a[gm];
      if (gd <= v) break;
      gd -= v;
  }
  return [gy, gm, gd];
}
function isoToJalali(iso) {
  let d = new Date(iso);
  if (isNaN(d)) return '';
  let j = gregorian_to_jalali(d.getFullYear(), d.getMonth() + 1, d.getDate());
  return j[0] + '/' + String(j[1]).padStart(2, '0') + '/' + String(j[2]).padStart(2, '0');
}
function jalaliToISO(jalaliStr) {
  if (!jalaliStr || !jalaliStr.match(/^\d{4}\/\d{2}\/\d{2}$/)) return new Date().toISOString();
  let parts = jalaliStr.split('/').map(Number);
  let g = jalali_to_gregorian(parts[0], parts[1], parts[2]);
  return new Date(g[0], g[1] - 1, g[2]).toISOString();
}
function todayJalali() {
  let d = new Date();
  let r = gregorian_to_jalali(d.getFullYear(), d.getMonth() + 1, d.getDate());
  return r[0] + '/' + String(r[1]).padStart(2, '0') + '/' + String(r[2]).padStart(2, '0');
}
function isBirthdayToday(birthdate) {
  if (!birthdate || !birthdate.includes('/')) return false;
  const today = todayJalali(); // e.g., '1404/06/16'
  const [, todayMonth, todayDay] = today.split('/').map(Number);
  const [, birthMonth, birthDay] = birthdate.split('/').map(Number);
  return todayMonth === birthMonth && todayDay === birthDay;
}
// Returns array of players whose birthday is today
function getBirthdaysToday() {
  return (state.players || []).filter(p => isBirthdayToday(p.birthdate));
}
// Return up to n upcoming birthdays (excluding today), sorted by next occurrence
function getUpcomingBirthdays(n = 4) {
  let today = todayJalali().split('/').map(Number);
  let tMonth = today[1], tDay = today[2];
  function distance(birth) {
    if (!birth) return 9999;
    let parts = birth.split('/').map(Number);
    let m = parts[1], d = parts[2];
    // days until birthday in current year (approx by month/day ordering)
    let mm = m - tMonth;
    let dd = d - tDay;
    let dist = mm * 31 + dd;
    if (dist < 0) dist += 366; // next year
    return dist;
  }
  return (state.players || []).slice().sort((a,b) => distance(a.birthdate) - distance(b.birthdate)).filter(p => !isBirthdayToday(p.birthdate)).slice(0,n);
}
// days until next birthday for a Jalali birthdate string
function daysUntilBirthday(birthdate) {
  if (!birthdate) return '';
  // using jalali dates: compute next occurrence in current year or next year
  try {
    let parts = birthdate.split('/').map(Number);
    let now = todayJalali().split('/').map(Number);
    let year = now[0], m = parts[1], d = parts[2];
    let candidate = jalaliToISO(`${year}/${String(m).padStart(2,'0')}/${String(d).padStart(2,'0')}`);
    let cDate = new Date(candidate);
    let today = new Date();
    if (cDate < today) {
      candidate = jalaliToISO(`${year+1}/${String(m).padStart(2,'0')}/${String(d).padStart(2,'0')}`);
      cDate = new Date(candidate);
    }
    const diff = Math.ceil((cDate - today) / (1000*60*60*24));
    return diff;
  } catch(e) { return ''; }
}

// Tweak header background for each theme to be closer to the theme accent color
// (preference: subtle gradient using accent variables)
document.documentElement.style.setProperty('--header-bg-modern', 'linear-gradient(180deg, rgba(59,130,246,0.15), rgba(52,211,153,0.08))');
document.documentElement.style.setProperty('--header-bg-luxury', 'linear-gradient(180deg, rgba(250,204,21,0.12), rgba(14,165,233,0.06))');
document.documentElement.style.setProperty('--header-bg-fun', 'linear-gradient(180deg, rgba(139,92,246,0.12), rgba(6,182,212,0.06))');
// Apply these as defaults
document.querySelectorAll('[data-style]').forEach(el => {});
function isInsuranceExpired(insuranceDate) {
  if (!insuranceDate) return true;
  let parts = insuranceDate.split('/').map(Number);
  let g = jalali_to_gregorian(parts[0], parts[1], parts[2]);
  let insurance = new Date(g[0], g[1] - 1, g[2]);
  insurance.setFullYear(insurance.getFullYear() + 1);
  let today = new Date();
  return today > insurance;
}
function jalaliToDate(jalali) {
  if (!jalali) return new Date(0);
  let parts = jalali.split('/').map(Number);
  let g = jalali_to_gregorian(parts[0], parts[1], parts[2]);
  return new Date(g[0], g[1] - 1, g[2]);
}
function calculateMembershipDuration(joinDate) {
  if (!joinDate) return '—';
  let join = jalaliToDate(joinDate);
  let today = new Date();
  let years = today.getFullYear() - join.getFullYear();
  let months = today.getMonth() - join.getMonth();
  if (today.getDate() < join.getDate()) months--;
  if (months < 0) { years--; months += 12; }
  let parts = [];
  if (years > 0) parts.push(years + ' سال');
  if (months > 0) parts.push(months + ' ماه');
  return parts.length ? parts.join(' و ') : 'کمتر از یک ماه';
}

/* محاسبه سن دقیق */
function calcExactAge(birthJalali) {
  if (!birthJalali) return { years: 0, months: 0, days: 0 };
  let parts = String(birthJalali).split('/').map(Number);
  let today = todayJalali().split('/').map(Number);
  let years = today[0] - parts[0];
  let months = today[1] - parts[1];
  let days = today[2] - parts[2];
  if (days < 0) {
    months--;
    days += 30; // تقریبی
  }
  if (months < 0) {
    years--;
    months += 12;
  }
  return { years, months, days };
}

// تابع تعیین رده بر اساس سن (جایگزین determineCategory)
function determineCategory(age) {
  // age: { years, months, days, birthdate }
  const ranks = (state.settings && state.settings.ranks) ? state.settings.ranks : [
    { id: 'mini', name: 'مینی والیبال', minAgeYears: 0, maxAgeYears: 12 },
    { id: 'noonahal', name: 'نونهالان', minAgeYears: 13, maxAgeYears: 14 },
    { id: 'nojavanan', name: 'نوجوانان', minAgeYears: 15, maxAgeYears: 16 },
    { id: 'nojavanan_boghr', name: 'نوجوانان بزرگ', minAgeYears: 17, maxAgeYears: 18 },
    { id: 'javan', name: 'جوانان', minAgeYears: 19, maxAgeYears: 20 },
    { id: 'omid', name: 'امیدها', minAgeYears: 21, maxAgeYears: 22 },
    { id: 'adult', name: 'بزرگسالان', minAgeYears: 23, maxAgeYears: 200 }
  ];

  // Reference date to compute age against (Jalali). Prefer explicit ranksReferenceDate, otherwise use lastCategoryUpdate or today
  const refJ = (state.settings && state.settings.ranksReferenceDate) ? state.settings.ranksReferenceDate : ((state.settings && state.settings.lastCategoryUpdate) ? state.settings.lastCategoryUpdate : todayJalali());
  // compute exact age on ref date if birthdate present
  if (!age || typeof age !== 'object') return ranks[ranks.length-1].name;
  let years = age.years;
  // if birthdate provided, recalc age relative to reference date
  if (age.birthdate) {
    try {
      const birthParts = String(age.birthdate).split('/').map(Number);
      const refParts = String(refJ).split('/').map(Number);
      let y = refParts[0] - birthParts[0];
      let m = refParts[1] - birthParts[1];
      let d = refParts[2] - birthParts[2];
      if (d < 0) { m--; d += 30; }
      if (m < 0) { y--; m += 12; }
      years = y;
    } catch (e) { /* fallback to provided age.years */ }
  }

  // prefer explicit startDateJ overrides: if a rank has startDateJ and refJ is before it, skip it
  for (let r of ranks) {
    if (r.startDateJ) {
      try {
        const startISO = jalaliToISO(r.startDateJ);
        const refISO = jalaliToISO(refJ);
        if (new Date(refISO) < new Date(startISO)) continue; // rank not yet active at ref
      } catch(e) { /* ignore parse */ }
    }
    const minY = (typeof r.minAgeYears === 'number') ? r.minAgeYears : -1;
    const maxY = (typeof r.maxAgeYears === 'number') ? r.maxAgeYears : 999;
    if (years >= minY && years <= maxY) return r.name;
  }

  return ranks[ranks.length-1].name;
}

// تابع محاسبه زمان باقی‌مانده تا رده بعدی
function calculateTimeToNextCategory(age, category) {
  // تعریف سن هدف برای رده بعدی
  const nextAgeMap = {
    'مینی والیبال': 13,
    'نونهالان': 15,
    'نوجوانان': 17,
    'نوجوانان بزرگ': 19,
    'جوانان': 21,
    'امیدها': 23,
    'بزرگسالان': null
  };

  let nextAge = nextAgeMap[category];
  if (!nextAge) return 'این آخرین رده است.';

  // تاریخ مرجع
  let refDateStr = state.settings.lastCategoryUpdate || '11 دی 1404'; // پیش‌فرض اصلاح‌شده

  // تاریخ تولد از age.birthdate (فرمت جلالی: '1380/01/01')
  let birthParts = age.birthdate.split('/').map(Number); // [سال, ماه, روز]
  let birthYear = birthParts[0];
  let birthMonth = birthParts[1];
  let birthDay = birthParts[2];

  // تاریخ امروز (جلالی)
  let today = todayJalali(); // مثل '1404/06/10'
  let [todayYear, todayMonth, todayDay] = today.split('/').map(Number);

  // محاسبه سال تولد بعدی که بازیکن به سن nextAge می‌رسد
  let nextBirthYear = birthYear + nextAge;
  let nextBirthJ = `${nextBirthYear}/${birthMonth.toString().padStart(2, '0')}/${birthDay.toString().padStart(2, '0')}`;
  let nextBirthISO = jalaliToISO(nextBirthJ); // تبدیل به میلادی
  let nextBirthDate = new Date(nextBirthISO);

  // تاریخ امروز به میلادی
  let todayISO = jalaliToISO(today);
  let todayDate = new Date(todayISO);

  // محاسبه زمان باقی‌مانده تا تولد بعدی
  let delta = nextBirthDate - todayDate; // میلی‌ثانیه
  if (delta < 0) {
    // اگر تولد گذشته، به تولد سال بعد برو
    nextBirthYear++;
    nextBirthJ = `${nextBirthYear}/${birthMonth.toString().padStart(2, '0')}/${birthDay.toString().padStart(2, '0')}`;
    nextBirthISO = jalaliToISO(nextBirthJ);
    nextBirthDate = new Date(nextBirthISO);
    delta = nextBirthDate - todayDate;
  }

  // تبدیل دلتا به سال، ماه، روز
  let daysTotal = Math.floor(delta / (1000 * 60 * 60 * 24));
  let years = Math.floor(daysTotal / 365);
  let remainingDays = daysTotal % 365;
  let months = Math.floor(remainingDays / 30);
  let days = remainingDays % 30;

  // رده بعدی
  let nextCategory = determineCategory({ years: nextAge });

  // تنظیم نسبت به تاریخ مرجع
  // اگر تولد بعدی قبل از تاریخ مرجع باشد، رده تا مرجع بعدی تغییر نمی‌کند
  let refParts = refDateStr.split(' ');
  let refDay = parseInt(refParts[0]);
  let refMonth = monthNameToNumber(refParts[1]);
  let refYear = parseInt(refParts[2]);
  let refDateJ = `${refYear}/${refMonth.toString().padStart(2, '0')}/${refDay.toString().padStart(2, '0')}`;
  let refDateISO = jalaliToISO(refDateJ);
  let refDate = new Date(refDateISO);

  if (nextBirthDate < refDate && todayDate < refDate) {
    // تولد بعدی قبل از مرجع است، باید تا مرجع بعدی صبر کنیم
    let nextRefYear = refYear + 1;
    let nextRefJ = `${nextRefYear}/${refMonth.toString().padStart(2, '0')}/${refDay.toString().padStart(2, '0')}`;
    let nextRefISO = jalaliToISO(nextRefJ);
    let nextRefDate = new Date(nextRefISO);
    delta = nextRefDate - todayDate;
    daysTotal = Math.floor(delta / (1000 * 60 * 60 * 24));
    years = Math.floor(daysTotal / 365);
    remainingDays = daysTotal % 365;
    months = Math.floor(remainingDays / 30);
    days = remainingDays % 30;
  }

  // تولید متن خروجی
  let output = `${years} سال، ${months} ماه، ${days} روز مانده تا رده ${nextCategory} (نسبت به مرجع: ${refDateStr})`;
  return output;
}

/* ================================================================
  SECTION: Embedded Auth Wiring
  - wires the embedded auth box (ids: loginEmail/loginPassword/etc.)
  - uses global `supabase` if available
  - reuses showAlert/showLoading helpers if defined; otherwise provides small fallbacks
  ================================================================ */
;(function(){
  // fallbacks for showAlert / showLoading if not defined in scope yet
  function _showAlert(el, msg, type){
    if (!el) return; el.textContent = msg; el.className = 'alert alert-' + type; el.style.display = 'block';
    // longer display time (8s)
    setTimeout(()=>el.style.display='none',8000);
  }
  function _showLoading(el, show){ if (!el) return; el.style.display = show ? 'block' : 'none'; }

  const TA = document.getElementById('embeddedAuthBox');
  if (!TA) return;

  // Tab behavior
  TA.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
      // manage active tab style
      TA.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      // explicitly hide all forms then show target
      ['loginFormEmbedded','signupFormEmbedded','recoveryFormEmbedded'].forEach(id=>{ const e=document.getElementById(id); if(e) e.classList.remove('active'); });
      const tab = btn.dataset.tab;
      const id = ({login:'loginFormEmbedded', signup:'signupFormEmbedded', recovery:'recoveryFormEmbedded'})[tab];
      const el = document.getElementById(id);
      if (el) {
        el.classList.add('active');
        // ensure the form is visible inside the card
        el.scrollIntoView({behavior:'smooth', block:'start'});
        // clear any running login spinner if user navigates away
        try { const lb = document.getElementById('loginBtn'); if (lb) { const s = lb.querySelector('.inline-spinner'); if (s) s.classList.remove('running'); lb.disabled = false; } } catch(_){ }
      }
    });
  });

  // recent emails helper: store recent used emails for quick suggestions
  function getRecentEmails(){ try { const raw = localStorage.getItem('recentLoginEmails'); return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
  function addRecentEmail(email){ try { if (!email) return; let list = getRecentEmails(); list = list.filter(e=>e!==email); list.unshift(email); list = list.slice(0,10); localStorage.setItem('recentLoginEmails', JSON.stringify(list)); populateRecentEmails(); } catch(e){} }
  function populateRecentEmails(){ try { const list = getRecentEmails(); const dl = document.getElementById('recentEmails'); if (!dl) return; dl.innerHTML = ''; list.forEach(e=>{ const o = document.createElement('option'); o.value = e; dl.appendChild(o); }); } catch(e){} }
  // ensure tabs are horizontal (defensive, in case CSS forced column)
  try { const tabs = TA.querySelector('.form-tabs'); if (tabs) tabs.style.flexDirection = 'row'; } catch(e){}
  // populate datalist on init
  populateRecentEmails();

  // Helper accessors (use global helpers if available)
  const showAlert = window.showAlert || _showAlert;
  const showLoading = window.showLoading || _showLoading;

  // Login
  const loginBtn = document.getElementById('loginBtn');
  if (loginBtn) loginBtn.addEventListener('click', async function(){
    const alertEl = document.getElementById('loginAlert');
    const loadingEl = document.getElementById('loginLoading');
    const spinner = loginBtn.querySelector('.inline-spinner');
    const label = loginBtn.querySelector('.login-label');
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    if (!email || !password) return showAlert(alertEl,'لطفاً تمامی فیلدها را پر کنید','danger');
  // start inline spinner and disable button
  if (spinner) { spinner.classList.add('running'); }
    loginBtn.disabled = true;
    showLoading(loadingEl,true);
    try {
  // ensure UI shows login form
  TA.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  TA.querySelector('[data-tab="login"]').classList.add('active');
  ['loginFormEmbedded','signupFormEmbedded','recoveryFormEmbedded'].forEach(id=>{ const e=document.getElementById(id); if(e) e.classList.remove('active'); });
  document.getElementById('loginFormEmbedded').classList.add('active');
  const client = getSupabaseClient();
    if (!client) { setEmbeddedStatus(false); return showAlert(alertEl,'کلاینت Supabase مقداردهی نشده یا آماده نیست','danger'); }
    const { data, error } = await client.auth.signInWithPassword({ email, password });
      if (error) {
        // map common supabase/auth errors to Persian messages
        const msg = (error && error.message) ? error.message.toLowerCase() : '';
        if (msg.includes('invalid password') || msg.includes('invalid login') || msg.includes('invalid credentials') || msg.includes('invalid grant')) {
          showAlert(alertEl,'رمز عبور اشتباه است','danger');
        } else if (msg.includes('user not found') || msg.includes('no user') || msg.includes('not found') || msg.includes('email not found')) {
          showAlert(alertEl,'کاربری با این ایمیل یافت نشد','danger');
        } else {
          showAlert(alertEl, error.message || 'خطا در ورود','danger');
        }
      }
      else {
        showAlert(alertEl,'ورود موفقیت‌آمیز','success');
        try { addRecentEmail(email); } catch(_){}
        // Navigate to account view and show the full editable profile under the profile card
        try { showView('account'); } catch(e) {}
        try {
          // Keep the embedded auth box visible and show the minimal account card below it
          const pc = document.getElementById('accountProfileContainer'); if (pc) { pc.style.display = 'block'; pc.scrollIntoView({behavior:'smooth', block:'start'}); }
          if (window.loadProfile) await window.loadProfile(data.user);
          // Hide only the auth forms (keep account/profile card visible)
          try { if (typeof window.showAuthForms === 'function') window.showAuthForms(false); else { const eb = document.getElementById('embeddedAuthBox'); if (eb) eb.style.display = 'none'; } } catch(_){ }
          // automatic background backup disabled to avoid unexpected POST errors
          // (call backupNow manually via the "همگام‌سازی الآن" button)
          try { console.debug('post-login sync skipped (automatic backup disabled)'); } catch(_){ }
        } catch(e) { console.warn('post-login show profile failed', e); }
      }
    } catch(e){ showAlert(alertEl,'خطا در ارتباط','danger'); }
    finally {
      // stop inline spinner and re-enable
      try { if (spinner) { spinner.classList.remove('running'); } } catch(_){}
      try { loginBtn.disabled = false; } catch(_){}
      showLoading(loadingEl,false);
    }
  });

  // password show/hide toggle for embedded login
  (function(){
    const toggle = document.getElementById('toggleLoginPassword');
    const icon = document.getElementById('toggleLoginPasswordIcon');
    if (!toggle) return;
    toggle.addEventListener('click', ()=>{
      const pwd = document.getElementById('loginPassword');
      if (!pwd) return;
      if (pwd.type === 'password') {
        pwd.type = 'text';
        if (icon) icon.innerHTML = '<path d="M2 2l20 20"></path><path d="M10.58 10.58A3 3 0 0 0 13.42 13.42"></path><path d="M9.88 5.88A10 10 0 0 1 22 12a21.5 21.5 0 0 1-5 6"></path>';
      } else {
        pwd.type = 'password';
        if (icon) icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"></path><circle cx="12" cy="12" r="3"></circle>';
      }
    });
  })();

  // Signup
  const signupBtn = document.getElementById('signupBtn');
  if (signupBtn) signupBtn.addEventListener('click', async function(){
    const alertEl = document.getElementById('signupAlert');
    
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    if (!email || !password || !confirmPassword) return showAlert(alertEl,'لطفاً تمامی فیلدها را پر کنید','danger');
    if (password !== confirmPassword) return showAlert(alertEl,'رمز عبور مطابقت ندارد','danger');
    // ensure UI shows signup form
    TA.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    TA.querySelector('[data-tab="signup"]').classList.add('active');
    ['loginFormEmbedded','signupFormEmbedded','recoveryFormEmbedded'].forEach(id=>{ const e=document.getElementById(id); if(e) e.classList.remove('active'); });
    document.getElementById('signupFormEmbedded').classList.add('active');
    // start spinner and disable
    const spinner = signupBtn.querySelector('.inline-spinner'); if (spinner) spinner.classList.add('running'); signupBtn.disabled = true;
    try {
  const client = getSupabaseClient();
  if (!client) { setEmbeddedStatus(false); if (spinner) spinner.classList.remove('running'); signupBtn.disabled = false; return showAlert(alertEl,'کلاینت Supabase مقداردهی نشده یا آماده نیست','danger'); }
  const { data, error } = await client.auth.signUp({ email, password, options:{ emailRedirectTo: window.location.href } });
      if (error) showAlert(alertEl, error.message || 'خطا در ثبت نام','danger');
      else {
        showAlert(alertEl,'ثبت نام انجام شد، ایمیل خود را بررسی کنید','success');
        // If Supabase returned an authenticated user (depends on project settings), show profile or instruct to verify
        try {
          if (data && data.user) {
            try { addRecentEmail(email); } catch(_){ }
            // check for common confirmation flags on the returned user object
            const u = data.user || {};
            const isConfirmed = Boolean(u.confirmed_at || u.email_confirmed_at || u.email_confirmed);
            // hide auth forms
            try { if (typeof window.showAuthForms === 'function') window.showAuthForms(false); else { const eb = document.getElementById('embeddedAuthBox'); if (eb) eb.style.display = 'none'; } } catch(_){ }
            const pc = document.getElementById('accountProfileContainer');
            if (pc) pc.style.display = 'block';
            if (!isConfirmed) {
              // show a verification prompt instead of editable profile
              try { document.getElementById('accountName').textContent = 'لطفاً ایمیل خود را تأیید کنید'; } catch(_){ }
              try { document.getElementById('accountEmail').textContent = email || ''; } catch(_){ }
              // hide edit/save/backup buttons to avoid editing before confirmation
              try { document.getElementById('editProfileToggle').style.display = 'none'; } catch(_){ }
              try { document.getElementById('logoutBtn').style.display = 'inline-block'; } catch(_){ }
              try { document.getElementById('backupNowBtn').style.display = 'none'; } catch(_){ }
            } else {
              // confirmed - load profile and show editable UI
              // automatic post-signup backup disabled to avoid unexpected POST errors
              try { console.debug('post-signup sync skipped (automatic backup disabled)'); } catch(_){ }
              if (window.loadProfile) await window.loadProfile(data.user);
              try { const f = document.getElementById('profileFirst'); if (f) f.focus(); } catch(_){ }
            }
          }
        } catch(e) { console.warn('post-signup show profile failed', e); }
      }
    } catch(e){ showAlert(alertEl,'خطا در ارتباط','danger'); }
    finally { if (spinner) spinner.classList.remove('running'); signupBtn.disabled = false; }
  });

  // Recovery
  const recoveryBtn = document.getElementById('recoveryBtn');
  if (recoveryBtn) recoveryBtn.addEventListener('click', async function(){
    const alertEl = document.getElementById('recoveryAlert');
    const email = document.getElementById('recoveryEmail').value.trim();
    if (!email) return showAlert(alertEl,'لطفاً ایمیل را وارد کنید','danger');
    // ensure UI shows recovery form
    TA.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    TA.querySelector('[data-tab="recovery"]').classList.add('active');
    ['loginFormEmbedded','signupFormEmbedded','recoveryFormEmbedded'].forEach(id=>{ const e=document.getElementById(id); if(e) e.classList.remove('active'); });
    document.getElementById('recoveryFormEmbedded').classList.add('active');
    // start spinner and disable
    const rspinner = recoveryBtn.querySelector('.inline-spinner'); if (rspinner) rspinner.classList.add('running'); recoveryBtn.disabled = true;
    try {
  const client = getSupabaseClient();
  if (!client) { setEmbeddedStatus(false); if (rspinner) rspinner.classList.remove('running'); recoveryBtn.disabled = false; return showAlert(alertEl,'کلاینت Supabase مقداردهی نشده یا آماده نیست','danger'); }
  const { data, error } = await client.auth.resetPasswordForEmail(email, { redirectTo: 'https://pouriaabedi0073-sys.github.io/volleyball-club/reset-password.html' });
      if (error) showAlert(alertEl, error.message || 'خطا در درخواست','danger');
      else showAlert(alertEl,'لینک بازیابی به ایمیل شما ارسال شد','success');
    } catch(e){ showAlert(alertEl,'خطا در ارتباط','danger'); }
    finally { if (rspinner) rspinner.classList.remove('running'); recoveryBtn.disabled = false; }
  });

  // reflect connection status if global function exists
  if (typeof updateConnectionStatus === 'function') {
    // if Supabase exists now, mark connected
    try { if (typeof supabase !== 'undefined') updateConnectionStatus(true); }
    catch(_){}
  }

  // local status updater for embedded box
  function setEmbeddedStatus(connected) {
    const ind = document.getElementById('statusIndicator');
    const txt = document.getElementById('statusText');
    if (!ind || !txt) return;
    if (connected) {
      ind.classList.remove('status-disconnected'); ind.classList.add('status-connected');
      txt.textContent = 'آنلاین';
      txt.style.color = 'var(--accent)';
    } else {
      ind.classList.remove('status-connected'); ind.classList.add('status-disconnected');
      txt.textContent = 'آفلاین';
      txt.style.color = 'var(--muted)';
    }
  }

  // Load and render the current user's profile into the account area
  // Accept an optional `providedUser` to avoid race with auth state immediately after sign-in
  window.loadProfile = async function(providedUser) {
    try {
      const client = getSupabaseClient();
      if (!client) { setEmbeddedStatus(false); return; }
      setEmbeddedStatus(true);
      let user = providedUser || null;
      if (!user) {
        const { data: userData } = await client.auth.getUser();
        user = userData?.user || null;
      }
      if (!user) {
        // not signed in
        document.getElementById('accountProfileContainer').style.display = 'none';
        return;
      }
      // fetch profile row (first try selecting known columns)
      let profile = null;
      let fetchFailed = false; // track whether profile fetch ultimately failed
      try {
        const res = await client.from('profiles').select('first_name,last_name,phone,avatar_url,email').eq('id', user.id).maybeSingle();
        console.debug('profiles select result:', res);
        profile = res.data || null;
        if (res.error) throw res.error;
      } catch (err) {
        console.warn('Could not fetch profile with specific columns:', err && (err.message || err));
        console.debug('detailed error object:', err);
        // retry with a generic select in case PostgREST rejected the explicit columns (avoid 406)
        try {
          const res2 = await client.from('profiles').select('*').eq('id', user.id).maybeSingle();
          console.debug('profiles fallback select result:', res2);
          profile = res2.data || null;
          if (res2.error) throw res2.error;
        } catch (err2) {
          console.warn('Fallback profile fetch also failed:', err2 && (err2.message || err2));
          console.debug('fallback detailed error object:', err2);
          fetchFailed = true;
          try { const pm = document.getElementById('profileMsg'); if (pm) pm.textContent = 'پروفایل یافت نشد یا بازیابی نشد (خطای شبکه/پیکربندی)'; } catch(_){}
        }
      }
  // Render minimal fields and populate the editable form
  const accountEl = document.getElementById('accountProfileContainer'); if (accountEl) accountEl.style.display = 'block';
  document.getElementById('accountName').textContent = (profile && (profile.first_name || profile.last_name)) ? `${profile.first_name||''} ${profile.last_name||''}`.trim() : (user.email || 'کاربر');
  const displayEmail = (profile && profile.email) ? profile.email : (user.email || '');
  document.getElementById('accountEmail').textContent = displayEmail;
  document.getElementById('accountPhone').textContent = profile?.phone || '';
  if (profile && profile.avatar_url) document.getElementById('accountAvatar').src = profile.avatar_url;
  // populate edit fields if present (fallback to auth user when profile read fails)
  try { document.getElementById('profileFirst').value = (!fetchFailed && profile && profile.first_name) ? profile.first_name : ''; } catch(_){ }
  try { document.getElementById('profileLast').value = (!fetchFailed && profile && profile.last_name) ? profile.last_name : ''; } catch(_){ }
  try { document.getElementById('profileEmail').value = (!fetchFailed && profile && profile.email) ? profile.email : (user.email || ''); } catch(_){ }
  try { document.getElementById('profilePhone').value = (!fetchFailed && profile && profile.phone) ? profile.phone : ''; } catch(_){ }
  try { if (!fetchFailed && profile && profile.avatar_url) document.getElementById('editAvatarPreview').src = profile.avatar_url; } catch(_){ }
      // if no profile row exists, attempt to create a minimal one so the admin sees something
      if (!profile) {
        try {
          console.debug('No profile found — attempting to upsert minimal profile');
          const up = await client.from('profiles').upsert({ id: user.id, email: user.email || '' }, { returning: 'representation' });
          console.debug('profiles upsert result:', up);
          if (!up.error) {
            profile = up.data && Array.isArray(up.data) ? up.data[0] : up.data; // handle different client return shapes
            // try to re-fetch authoritative profile row (in case upsert returned null shape)
            try {
              const ref = await client.from('profiles').select('first_name,last_name,phone,avatar_url,email').eq('id', user.id).maybeSingle();
              console.debug('re-fetch after upsert result:', ref);
              if (ref && !ref.error) profile = ref.data || profile;
            } catch (rf) { console.debug('re-fetch after upsert failed', rf); }
          }
        } catch (uerr) {
          console.warn('Auto-upsert profile failed:', uerr && (uerr.message || uerr));
          fetchFailed = true;
        }
      }
    // Do not forcibly close the edit box here; let the user control it via the Edit button
    // (previous behavior hid the box which could interfere with the Edit button UX)
    } catch (e) {
      console.error('loadProfile failed', e);
    }
  };

  // Wire up profile edit inputs and buttons
  try {
    const saveBtn = document.getElementById('saveProfileBtn');
    if (saveBtn) saveBtn.addEventListener('click', async function(){
      try { if (typeof saveProfile === 'function') await saveProfile(); } catch(e){ console.warn('saveProfile failed', e); }
    });

    const backupBtn = document.getElementById('backupNowBtn');
    if (backupBtn) backupBtn.addEventListener('click', async function(){
      try { if (typeof backupNow === 'function') await backupNow(); } catch(e){ console.warn('backupNow failed', e); }
    });
  } catch(e){ console.warn('profile edit wiring failed', e); }

  // Edit profile toggle: show the edit box and ensure fields are populated
  try {
    const editToggle = document.getElementById('editProfileToggle');
    if (editToggle) editToggle.addEventListener('click', async function(){
      try {
        const pe = document.getElementById('profileEditBox');
        if (!pe) { console.debug('edit toggle clicked but #profileEditBox not found'); return; }
        const curr = window.getComputedStyle(pe).display;
        console.debug('edit toggle clicked; current display:', curr);
        if (curr === 'none' || curr === '') {
          // open — apply robust inline styles to ensure visibility
          pe.style.display = 'block';
          try {
            pe.style.visibility = 'visible'; pe.style.opacity = '1'; pe.style.zIndex = '9999';
            if (!document.getElementById('forceOpenProfileEditStyle')) {
              const s = document.createElement('style');
              s.id = 'forceOpenProfileEditStyle';
              s.textContent = '#profileEditBox.force-open{ display:block !important; visibility:visible !important; opacity:1 !important; z-index:9999 !important; position:relative !important; }';
              (document.head || document.documentElement).appendChild(s);
            }
            pe.classList.add('force-open');
            try {
              // temporary highlight to make the box obvious during debugging
              pe.style.outline = '3px solid rgba(220,20,60,0.9)';
              pe.style.boxShadow = '0 8px 24px rgba(0,0,0,0.2)';
              const prevBg = pe.style.backgroundColor;
              pe.style.backgroundColor = 'rgba(255,250,240,0.95)';
              setTimeout(()=>{
                try { pe.style.outline = ''; pe.style.boxShadow = ''; pe.style.backgroundColor = prevBg; } catch(_){ }
              }, 4000);
            } catch(_){ }
          } catch(_){ }
          try { if (typeof window.loadProfile === 'function') await window.loadProfile(); } catch(e){ console.warn('loadProfile on edit toggle failed', e); }
          try { const rect = pe.getBoundingClientRect(); console.debug('profileEditBox rect after open:', rect); } catch(_){ }
          try { pe.scrollIntoView({behavior:'smooth', block:'start'}); } catch(_){ }
          try { setTimeout(()=>{ const f = document.getElementById('profileFirst'); if (f) f.focus(); }, 120); } catch(_){ }
          console.debug('profileEditBox opened');
        } else {
          // close
          try { pe.style.display = 'none'; pe.style.visibility = 'hidden'; pe.classList.remove('force-open'); } catch(_){ }
          console.debug('profileEditBox closed');
        }
      } catch(e) { console.warn('edit toggle handler failed', e); }
    });
  } catch(e){ console.warn('editProfileToggle wiring failed', e); }

  // Logout wiring
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) logoutBtn.addEventListener('click', async function(){
    try {
      const client = getSupabaseClient();
      if (!client) return;
      await client.auth.signOut();
    } catch (e) { console.warn('Logout failed', e); }
  // ensure edit box closed, then hide profile and show auth forms again (preserve account card structure)
  try { const pe = document.getElementById('profileEditBox'); if (pe) pe.style.display = 'none'; } catch(_){ }
  try { document.getElementById('accountProfileContainer').style.display = 'none'; } catch(_){ }
    try { if (typeof window.showAuthForms === 'function') window.showAuthForms(true); else { const eb = document.getElementById('embeddedAuthBox'); if (eb) eb.style.display = 'block'; } } catch(_){ }
    try { showView('account'); } catch(_){ }
  });

  // initial status and robust client detection
  function getSupabaseClient(){
    try {
      const candidates = [window.supabase, window.supabaseClient, window.SUPABASE_CLIENT, window._supabase, window.__supabase, window.sb, window.sbClient];
      for (let c of candidates) if (c && c.auth && typeof c.auth.signInWithPassword === 'function') return c;
      return null;
    } catch(e){ return null; }
  }

  setEmbeddedStatus(!!getSupabaseClient());

  // try to update later if client is created after script parse
  let tries = 0;
  const statusInterval = setInterval(()=>{
    if (getSupabaseClient()) { setEmbeddedStatus(true); clearInterval(statusInterval); }
    tries++; if (tries > 50) { setEmbeddedStatus(false); clearInterval(statusInterval); }
  }, 200);

})();
/* Image Helper */
function imageFileToDataURL(file, maxKB) {
  return new Promise((resolve, reject) => {
    try {
      let fr = new FileReader();
      fr.onload = (e) => {
        let img = new Image();
        img.onload = () => {
          let MAX_WIDTH = 800;
          let w = img.width, h = img.height;
          if (w > MAX_WIDTH) { h = Math.round(h * (MAX_WIDTH / w)); w = MAX_WIDTH; }
          let canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          let ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          let quality = 0.8;
          let data = canvas.toDataURL('image/jpeg', quality);
          while ((data.length / 1024) > (maxKB || 500) && quality > 0.3) {
            quality -= 0.1;
            data = canvas.toDataURL('image/jpeg', quality);
          }
          resolve(data);
        };
        img.onerror = () => reject(new Error('invalid image'));
        img.src = e.target.result;
      };
      fr.onerror = () => reject(new Error('file read error'));
      fr.readAsDataURL(file);
    } catch (err) { reject(err); }
  });
}

/* ================================================================
  SECTION: Keep auth state across refresh
  - listens for Supabase auth state changes and restores UI
  - on load, tries to get current user and call loadProfile
  ================================================================ */
(function(){
  // Expose a global getSupabaseClient if not already present (used by saveProfile/backupNow)
  if (typeof window.getSupabaseClient !== 'function') {
    window.getSupabaseClient = function(){
      try {
        const candidates = [window.supabase, window.supabaseClient, window.SUPABASE_CLIENT, window._supabase, window.__supabase, window.sb, window.sbClient];
        for (let c of candidates) if (c && c.auth && typeof c.auth.signInWithPassword === 'function') return c;
        return null;
      } catch(e){ return null; }
    };
  }

  // Helper to hide/show only the auth forms (leave account/profile area visible)
  if (typeof window.showAuthForms !== 'function') {
    window.showAuthForms = function(show){
      try {
        const eb = document.getElementById('embeddedAuthBox'); if (!eb) return;
        const formContainer = eb.querySelector('.auth-form-container');
        const welcome = eb.querySelector('.auth-welcome');
        const tabs = eb.querySelector('.form-tabs');
        if (formContainer) formContainer.style.display = show ? '' : 'none';
        if (welcome) welcome.style.display = show ? '' : 'none';
        if (tabs) tabs.style.display = show ? '' : 'none';
      } catch(e){ /* ignore */ }
    };
  }
  function getClient(){
    try { return (window.supabase && typeof window.supabase.auth !== 'undefined') ? window.supabase : null; } catch(e){ return null; }
  }
  async function restore(){
    const client = getClient();
    const dbg = document.getElementById('authDebug');
    if (!client) {
      if (dbg) dbg.textContent = 'وضعیت: کلاینت Supabase پیدا نشد (library ممکن است بارگذاری نشده باشد)';
      return;
    }
    try {
      const { data } = await client.auth.getSession();
      const session = data && data.session;
      if (session && session.user) {
        if (dbg) dbg.textContent = 'وضعیت: سشن معتبر یافت شد؛ در حال بارگذاری پروفایل...';
        try { if (typeof window.showAuthForms === 'function') window.showAuthForms(false); else { const eb = document.getElementById('embeddedAuthBox'); if (eb) eb.style.display = 'none'; } } catch(_){ }
        try { await window.loadProfile(session.user); if (dbg) dbg.textContent = 'پروفایل بارگذاری شد'; } catch(e){ console.warn('restore loadProfile failed', e); if (dbg) dbg.textContent = 'پروفایل یافت نشد (خطا در loadProfile)'; }
      } else {
        if (dbg) dbg.textContent = 'وضعیت: سشن معتبر وجود ندارد — نمایش فرم لاگین';
        try { if (typeof window.showAuthForms === 'function') window.showAuthForms(true); else { const eb = document.getElementById('embeddedAuthBox'); if (eb) eb.style.display = 'block'; } } catch(_){ }
      }
    } catch(e){ console.debug('auth restore failed', e); if (dbg) dbg.textContent = 'خطا هنگام بررسی سشن'; }
  }
  // add onAuthStateChange if available
  const client = getClient();
  if (client && typeof client.auth.onAuthStateChange === 'function') {
    client.auth.onAuthStateChange((event, session) => {
      const dbg = document.getElementById('authDebug');
      if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
        if (dbg) dbg.textContent = `رویداد: ${event} — بارگذاری پروفایل...`;
        try { if (typeof window.showAuthForms === 'function') window.showAuthForms(false); else { const eb = document.getElementById('embeddedAuthBox'); if (eb) eb.style.display = 'none'; } } catch(_){ }
        try { if (session && session.user) window.loadProfile(session.user); else window.loadProfile(); if (dbg) dbg.textContent = 'پروفایل بارگذاری شد'; } catch(e){ console.warn('onAuth loadProfile failed', e); if (dbg) dbg.textContent = 'خطا در بارگذاری پروفایل پس از رویداد'; }
      } else if (event === 'SIGNED_OUT') {
        if (dbg) dbg.textContent = 'رویداد: SIGNED_OUT — نمایش فرم لاگین';
        try { document.getElementById('accountProfileContainer').style.display = 'none'; } catch(_){ }
        try { if (typeof window.showAuthForms === 'function') window.showAuthForms(true); else { const eb = document.getElementById('embeddedAuthBox'); if (eb) eb.style.display = 'block'; } } catch(_){ }
      }
    });
  }
  // try restore on next tick (allow client init)
  setTimeout(restore, 600);
  // also attempt again after a short interval in case client loads later
  let tries = 0; const id = setInterval(()=>{ tries++; if (getClient()) { clearInterval(id); restore(); } if (tries>10) clearInterval(id); }, 400);
})();

    /* Save profile to Supabase and create backups */
    async function saveProfile() {
      try {
        const client = getSupabaseClient();
        if (!client) throw new Error('Supabase client not ready');
        const { data: userData } = await client.auth.getUser();
        const user = userData?.user; if (!user) throw new Error('Not signed in');
        const first_name = (document.getElementById('profileFirst') && document.getElementById('profileFirst').value) || '';
        const last_name = (document.getElementById('profileLast') && document.getElementById('profileLast').value) || '';
  // prefer the authenticated user's email to avoid accidental overwrites
  const emailField = (document.getElementById('profileEmail') && document.getElementById('profileEmail').value) || '';
  const email = user.email || emailField || '';
        const phone = (document.getElementById('profilePhone') && document.getElementById('profilePhone').value) || '';
  const avatar_el = document.getElementById('accountAvatar');
  const avatar_url = (avatar_el && avatar_el.src) ? avatar_el.src : null;

        const payload = { id: user.id, first_name, last_name, phone, email, avatar_url };
        const { data, error } = await client.from('profiles').upsert(payload, { returning: 'representation' });
        if (error) throw error;
        // update UI
        try { document.getElementById('accountName').textContent = `${first_name} ${last_name}`.trim() || email; } catch(_){}
  try { if (avatar_url) document.getElementById('accountAvatar').src = avatar_url; } catch(_){ }
  try { document.getElementById('accountPhone').textContent = phone || ''; } catch(_){ }
        try { const msg = document.getElementById('profileMsg'); if (msg) { msg.textContent = 'پروفایل ذخیره شد'; setTimeout(()=>{ msg.textContent = ''; }, 2500); } } catch(_){}
        return data;
      } catch (e) {
        console.error('saveProfile error', e);
        try { const msg = document.getElementById('profileMsg'); if (msg) msg.textContent = 'خطا در ذخیره پروفایل'; } catch(_){}
        throw e;
      }
    }

    async function backupNow() {
      try {
        const client = getSupabaseClient(); if (!client) throw new Error('Supabase client not ready');
        const { data: userData } = await client.auth.getUser(); const user = userData?.user; if (!user) throw new Error('Not signed in');
        // snapshot the entire app state (players, coaches, sessions, payments, etc.)
        // `state` is the in-memory app state persisted to localStorage
        let snapshot = JSON.parse(JSON.stringify(window.state || {}));
        // if snapshot is empty, try to read saved localStorage state
        try {
          const isEmpty = Object.keys(snapshot).length === 0;
          if (isEmpty && typeof STORAGE_KEY !== 'undefined') {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
              try { snapshot = JSON.parse(raw); } catch(_){}
            }
          }
        } catch(e) { /* ignore */ }
        // Safer flow: attempt to update an existing backup row, otherwise insert a new one.
        const deviceId = getDeviceId();
        const deviceName = getDeviceName();
        const nowIso = new Date().toISOString();
        try {
          const updated = await client.from('backups').update({ data: snapshot, device_id: deviceId, operation: 'sync', updated_at: nowIso, created_at: nowIso }).eq('user_id', user.id).select();
          console.debug('backup update result:', updated);
          if (updated && !updated.error && updated.data && updated.data.length > 0) {
            try { const b = document.getElementById('backupStatus'); if (b) b.textContent = 'همگام‌سازی به‌روز شد'; } catch(_){ }
            try { const ic = document.getElementById('backupIcon'); if (ic) ic.style.background = 'linear-gradient(90deg,#16a34a,#10b981)'; } catch(_){ }
            return updated.data;
          }
        } catch (updErr) {
          console.debug('backup update failed (will try insert):', updErr);
        }
        // If update didn't apply, insert a new backup record (safe fallback)
        try {
          const ins = await client.from('backups').insert([{ user_id: user.id, data: snapshot, device_id: deviceId, operation: 'sync', revision: 1, created_at: nowIso, updated_at: nowIso }]);
          if (ins && ins.error) throw ins.error;
          try { const b = document.getElementById('backupStatus'); if (b) b.textContent = 'همگام‌سازی انجام شد'; } catch(_){ }
          try { const ic = document.getElementById('backupIcon'); if (ic) ic.style.background = 'linear-gradient(90deg,#16a34a,#10b981)'; } catch(_){ }
          return ins.data;
        } catch (insErr) {
          console.debug('backup insert failed:', insErr);
          throw insErr;
        }
  try { const b = document.getElementById('backupStatus'); if (b) b.textContent = 'همگام‌سازی انجام شد'; } catch(_){ }
        try { const ic = document.getElementById('backupIcon'); if (ic) ic.style.background = 'linear-gradient(90deg,#16a34a,#10b981)'; } catch(_){ }
        return ins.data;
      } catch (e) {
        console.error('backupNow error', e);
  try { const b = document.getElementById('backupStatus'); if (b) b.textContent = 'همگام‌سازی تکمیل نشد — دستی انجام دهید'; } catch(_){ }
        try { const ic = document.getElementById('backupIcon'); if (ic) ic.style.background = 'transparent'; } catch(_){ }
        throw e;
      }
    }

  // Toggle edit profile box from account card
  (function(){
    try {
      const toggle = document.getElementById('editProfileToggle');
      if (toggle) toggle.addEventListener('click', async function(){
        try {
          const pe = document.getElementById('profileEditBox');
          if (!pe) { console.debug('edit toggle clicked but #profileEditBox not found'); return; }
          const curr = window.getComputedStyle(pe).display;
          if (curr === 'none' || curr === '') {
            pe.style.display = 'block';
            try { if (typeof window.loadProfile === 'function') await window.loadProfile(); } catch(e){ console.warn('loadProfile on edit toggle failed', e); }
            try { pe.scrollIntoView({behavior:'smooth', block:'start'}); } catch(_){ }
          } else {
            pe.style.display = 'none';
          }
        } catch(e){ console.warn('toggle edit failed', e); }
      });
    } catch(e) { /* ignore */ }
  })();

  /* ImageKit integration (client-side) ----------------------------------
    Using ImageKit.io for image hosting. You must provide an authentication
    endpoint on your server that returns a token for uploads (see ImageKit docs).
    Minimal client setup below uses the provided publicKey and urlEndpoint.
  */
  // load ImageKit script dynamically if not present
  (function(){
    try {
      if (typeof ImageKit === 'undefined') {
        const s = document.createElement('script');
        s.src = 'https://unpkg.com/imagekit-javascript/dist/imagekit.min.js';
        s.async = true;
        (document.head || document.body).appendChild(s);
      }
    } catch(e){}
  })();

  // Initialize ImageKit instance (use your public key & endpoint)
  let __imagekit = null;
  function initImageKit() {
    try {
      if (typeof ImageKit === 'undefined') return;
      if (__imagekit) return __imagekit;
      __imagekit = new ImageKit({
        publicKey: 'public_z44cHiHVzvCvDlKJNtfsCiHg+MY=',
        urlEndpoint: 'https://ik.imagekit.io/vviiiq5g29',
        authenticationEndpoint: '/imagekit-auth' // replace with your server auth path
      });
      return __imagekit;
    } catch(e){ console.warn('initImageKit failed', e); }
  }

  // Note: module uploader (fileInput/uploadBtn) is used instead of the older inline uploader.

// toggleAuthBtn removed per user request; no-op placeholder left intentionally

    /* ================================================================
  SECTION: State & Persistence
  - localStorage key, state object, load/save, seeding
  ================================================================ */
/* Storage & State */
const STORAGE_KEY = 'vb_dashboard_v8'; // بروزرسانی نسخه
let state = { players: [], coaches: [], sessions: [], payments: [], settings: { title: 'مدیریت باشگاه والیبال', logo: 'https://www.transparentpng.com/thumb/volleyball/2esoDe-volleyball-transparent-background.png', style: 'modern', lastCategoryUpdate: '11 دی 1403', ranks: null, ranksReferenceDate: null } };
// competitions storage
state.competitions = state.competitions || [];
// currently selected date filter for matches (YYYY/MM/DD)
let selectedMatchesDate = null;
let customStoragePath = null;

function loadState() {
  try {
    let raw = localStorage.getItem(STORAGE_KEY);
    if (raw) state = JSON.parse(raw);
    else seedSample();
    state.user = state.user || {loggedIn: false}; // خط جدید
  } catch (e) {
    console.error(e);
    seedSample();
    state.user = state.user || {loggedIn: false}; // خط جدید برای حالت خطا
  }

  // بروزرسانی اتومات رده‌ها
  state.players.forEach(p => {
    if (p.birthdate) {
      let age = calcExactAge(p.birthdate);
      p.category = determineCategory(age);
    }
    if (!p.events) p.events = [];
  });
  // بروزرسانی تاریخ آخرین آپدیت رده‌ها
  let todayParts = todayJalali().split('/').map(Number);
  let updateYear = parseInt(state.settings.lastCategoryUpdate.split(' ')[2] || '1403');
  if (todayParts[1] > 10 || (todayParts[1] === 10 && todayParts[2] >= 11)) {
    if (updateYear < todayParts[0]) {
      state.settings.lastCategoryUpdate = `11 دی ${todayParts[0]}`;
    }
  } else {
    if (updateYear < todayParts[0] - 1) {
      state.settings.lastCategoryUpdate = `11 دی ${todayParts[0] - 1}`;
    }
  }
  saveState();
}

function logSampleCategories() {
  try {
    console.group('Sample players categories');
    (state.players || []).forEach(p => {
      const cat = p.birthdate ? determineCategory(Object.assign(calcExactAge(p.birthdate), { birthdate: p.birthdate })) : (p.category || '—');
      console.log(p.name + ' — birth: ' + (p.birthdate || '—') + ' — category: ' + cat);
    });
    console.groupEnd();
  } catch(e){ console.warn('logSampleCategories failed', e); }
}

// call logger after seeding (useful on first load)
try { if (!localStorage.getItem(STORAGE_KEY)) { logSampleCategories(); } } catch(e){}
function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  // also attempt to store an online backup of the current profile/state
  try {
    if (typeof backupNow === 'function') {
      // fire-and-forget; update UI status on completion inside backupNow
      backupNow().catch(e => { console.warn('background backup failed', e); });
    }
  } catch(e){ console.debug('backup call from saveState failed', e); }
}
function seedSample() {
  state.players = [];
  state.coaches = [];
  state.sessions = [];
  state.payments = [];
  state.settings = { title: 'مدیریت باشگاه والیبال', logo: 'https://www.transparentpng.com/thumb/volleyball/2esoDe-volleyball-transparent-background.png', style: 'modern', lastCategoryUpdate: '11 دی 1403', ranks: null, ranksReferenceDate: null };
  let now = Date.now();
  // sample players covering each rank (male)
  state.players.push({ id: uid('p'), name: 'آریا کوچک', birthdate: '1394/01/15', joinDate: todayJalali(), category: '', favoritePosition: 'OH', phone: '09120001011', fatherName: 'لیلا', nationalCode: '1000000001', photo: '', height: 140, weight: 35, insuranceDate: todayJalali(), scores: {}, createdAt: new Date(now - 950000).toISOString(), events: [] });
  state.players.push({ id: uid('p'), name: 'بهرام نور', birthdate: '1390/05/10', joinDate: todayJalali(), category: '', favoritePosition: 'L', phone: '09120001012', fatherName: 'حمید', nationalCode: '1000000002', photo: '', height: 150, weight: 45, insuranceDate: todayJalali(), scores: {}, createdAt: new Date(now - 900000).toISOString(), events: [] });
  state.players.push({ id: uid('p'), name: 'پویان کریمی', birthdate: '1389/07/10', joinDate: todayJalali(), category: '', favoritePosition: 'MB', phone: '09120001013', fatherName: 'کریم', nationalCode: '1000000003', photo: '', height: 160, weight: 50, insuranceDate: todayJalali(), scores: {}, createdAt: new Date(now - 850000).toISOString(), events: [] });
  state.players.push({ id: uid('p'), name: 'تندیس رحیمی', birthdate: '1387/03/20', joinDate: todayJalali(), category: '', favoritePosition: 'OH', phone: '09120001014', fatherName: 'رحیم', nationalCode: '1000000004', photo: '', height: 170, weight: 60, insuranceDate: todayJalali(), scores: {}, createdAt: new Date(now - 800000).toISOString(), events: [] });
  state.players.push({ id: uid('p'), name: 'جواد ملکی', birthdate: '1385/11/01', joinDate: todayJalali(), category: '', favoritePosition: 'ST', phone: '09120001015', fatherName: 'ملک', nationalCode: '1000000005', photo: '', height: 180, weight: 70, insuranceDate: todayJalali(), scores: {}, createdAt: new Date(now - 750000).toISOString(), events: [] });
  state.players.push({ id: uid('p'), name: 'حسین صالحی', birthdate: '1382/08/25', joinDate: todayJalali(), category: '', favoritePosition: 'MB', phone: '09120001016', fatherName: 'صالح', nationalCode: '1000000006', photo: '', height: 185, weight: 80, insuranceDate: todayJalali(), scores: {}, createdAt: new Date(now - 700000).toISOString(), events: [] });
  state.players.push({ id: uid('p'), name: 'داریوش مرندی', birthdate: '1378/04/10', joinDate: todayJalali(), category: '', favoritePosition: 'L', phone: '09120001017', fatherName: 'مهران', nationalCode: '1000000007', photo: '', height: 190, weight: 85, insuranceDate: todayJalali(), scores: {}, createdAt: new Date(now - 650000).toISOString(), events: [] });

  // default rank definitions (editable in Rank Editor). Each item: { id, name, minAgeYears, maxAgeYears, startDateJ }
  // startDateJ (optional) allows specifying a Jalali date from which this category applies (manual override per user request)
  state.settings.ranks = state.settings.ranks || [
    { id: 'mini', name: 'مینی والیبال', minAgeYears: 0, maxAgeYears: 12, startDateJ: '' },
    { id: 'noonahal', name: 'نونهالان', minAgeYears: 13, maxAgeYears: 14, startDateJ: '' },
    { id: 'nojavanan', name: 'نوجوانان', minAgeYears: 15, maxAgeYears: 16, startDateJ: '' },
    { id: 'nojavanan_boghr', name: 'نوجوانان بزرگ', minAgeYears: 17, maxAgeYears: 18, startDateJ: '' },
    { id: 'javan', name: 'جوانان', minAgeYears: 19, maxAgeYears: 20, startDateJ: '' },
    { id: 'omid', name: 'امیدها', minAgeYears: 21, maxAgeYears: 22, startDateJ: '' },
    { id: 'adult', name: 'بزرگسالان', minAgeYears: 23, maxAgeYears: 200, startDateJ: '' }
  ];
  state.settings.ranksReferenceDate = state.settings.ranksReferenceDate || state.settings.lastCategoryUpdate || todayJalali();
  state.coaches.push({
    id: uid('c'), name: 'محمد محمدی', title: 'مربی اصلی', phone: '09120000010', photo: '', createdAt: new Date(now - 600000).toISOString()
  });
  // نمونهٔ برنامه‌های تمرین (notes)
  state.trainingPlans = [];
  state.sessions.push({
    id: uid('s'), title: 'جلسه تمرینی', date: jalaliToISO(todayJalali()), category: 'جوانان', coachId: state.coaches[0].id,
    attendances: { [state.players[0].id]: { present: true, reason: '' }, [state.players[1].id]: { present: false, reason: 'بیمار' } },
    createdAt: new Date(now - 500000).toISOString()
  });
  state.payments.push({
    id: uid('pay'), playerId: state.players[0].id, date: jalaliToISO(todayJalali()), amount: 500000, paymentMonth: 'فروردین', paymentYear: '1403', type: 'نقد',
    createdAt: new Date(now - 400000).toISOString()
  });
  saveState();
}

// seed sample competitions if none
function ensureCompetitionsSeed() {
  state.competitions = state.competitions || [];
  if (state.competitions.length === 0) {
    const nowJ = todayJalali();
    state.competitions.push({ id: uid('m'), teamA: 'تیم الف', teamB: 'تیم ب', scoreA: 2, scoreB: 1, date: nowJ, time: '18:30', kind: 'tournament', title: 'تورنمنت تابستانه', status: 'finished', venue: 'ورزشگاه مرکزی', sets: [[25,20],[22,25],[15,13]] });
    // future match
    let future = addDaysJalali(nowJ, 7);
    state.competitions.push({ id: uid('m'), teamA: 'تیم ج', teamB: 'تیم د', scoreA: null, scoreB: null, date: future, time: '16:00', kind: 'friendly', title: 'دوستی دوستانه', status: 'scheduled', venue: '' });
    saveState();
  }
}

function renderCompetitionsPage() {
  ensureCompetitionsSeed();
  // (team filter removed) keep teams available in state if needed later
  // set count and list
  renderMatchesList();
  // wire tab clicks
  qsa('#matchesTabs button').forEach(b => b.addEventListener('click', (e)=>{
    qsa('#matchesTabs button').forEach(x=>x.classList.remove('active'));
    e.currentTarget.classList.add('active');
    renderMatchesList();
  }));

  // Robust bindings: clone visible nodes and attach event listeners directly
  const bindClickOnce = (sel, handler) => {
    const el = qs(sel);
    if (!el) return console.warn('Missing element for binding:', sel);
    try {
      const n = el.cloneNode(true);
      el.parentNode.replaceChild(n, el);
      // attach click and pointerdown as fallback
      n.addEventListener('click', (ev)=>{ console.debug('bindClickOnce click:', sel); handler(ev); }, false);
      n.addEventListener('pointerdown', (ev)=>{ console.debug('bindClickOnce pointerdown:', sel); handler(ev); }, { passive: true });
    } catch (e) {
      // fallback
      el.addEventListener('click', (ev)=>{ console.debug('bindClickOnce fallback click:', sel); handler(ev); }, false);
      el.addEventListener('pointerdown', (ev)=>{ console.debug('bindClickOnce fallback pointerdown:', sel); handler(ev); }, { passive: true });
    }
  };

  // FAB: open form
  bindClickOnce('#addMatchFab', () => openMatchForm());
  console.debug('renderCompetitionsPage: bound #addMatchFab');

  // Inline date filter: user can type/paste date or clear quickly
  // store selected date in `selectedMatchesDate` (YYYY/MM/DD) or null
  if (qs('#matchesDateFilter')) {
    const dEl = qs('#matchesDateFilter');
    const newD = dEl.cloneNode(true); dEl.parentNode.replaceChild(newD, dEl);
    newD.addEventListener('input', (e)=>{
      const v = e.currentTarget.value.trim();
      selectedMatchesDate = v === '' ? null : v;
      renderMatchesList();
    }, false);
    // ensure clicking/focusing opens the inline widget
    newD.addEventListener('focus', ()=>{ try { openJalaliCalendarForMatches(); const ev = new Event('click'); newD.dispatchEvent(ev); } catch(e){ console.warn(e); } }, false);
    newD.addEventListener('click', (ev)=>{ try{ openJalaliCalendarForMatches(); ev.stopPropagation(); }catch(e){console.warn(e);} }, false);
  }
  bindClickOnce('#clearMatchesDate', ()=>{
    const inpt = qs('#matchesDateFilter'); if (inpt) { inpt.value = ''; }
    selectedMatchesDate = null; renderMatchesList();
  });

  // back button
  bindClickOnce('#backCompetitions', ()=> showView('home'));

  // Search input: attach input listener directly (not passive)
  const searchEl = qs('#matchesSearch');
  if (searchEl) {
    const newSearch = searchEl.cloneNode(true);
    searchEl.parentNode.replaceChild(newSearch, searchEl);
    newSearch.addEventListener('input', renderMatchesList, false);
  } else console.warn('Search input not found: #matchesSearch');
}

function renderMatchesList() {
  let list = qs('#matchesList'); list.innerHTML = '';
  const active = qs('#matchesTabs button.active')?.dataset.filter || 'all';
  const team = null; const type = null;
  const searchQ = qs('#matchesSearch') ? qs('#matchesSearch').value.trim().toLowerCase() : '';
  let matches = (state.competitions || []).slice().sort((a,b)=> new Date(jalaliToISO(a.date)) - new Date(jalaliToISO(b.date)) );
  matches = matches.filter(m=>{
    if (active === 'scheduled' && m.status !== 'scheduled') return false;
    if (active === 'finished' && m.status !== 'finished') return false;
  // only 'all', 'scheduled', 'finished' are supported tabs now
    if (selectedMatchesDate && m.date !== selectedMatchesDate) return false;
    if (searchQ) {
      const hay = ((m.teamA||'') + ' ' + (m.teamB||'') + ' ' + (m.title||'') + ' ' + (m.date||'')).toLowerCase();
      if (!hay.includes(searchQ)) return false;
    }
    return true;
  });
  qs('#matchesCount').textContent = matches.length;
  if (matches.length === 0) { list.innerHTML = '<div class="muted">هیچ مسابقه‌ای یافت نشد</div>'; return; }
  // (design placeholder removed) -- only real matches will be listed
  matches.forEach(m=>{
    let card = document.createElement('div'); card.className = 'match-card';
    // compute display score
    let displayScore = '';
    if (m.status === 'scheduled') displayScore = 'VS';
    else if (Array.isArray(m.sets) && m.sets.length>0) {
      let aWins = 0, bWins = 0; m.sets.forEach(s=>{ const a=s[0]||0, b=s[1]||0; if (a>b) aWins++; if (b>a) bWins++; });
      displayScore = `${aWins} - ${bWins}`;
    } else if (m.scoreA==null || m.scoreB==null) displayScore = '-';
    else displayScore = `${escapeHtml(String(m.scoreA))} - ${escapeHtml(String(m.scoreB))}`;
    const logoA = escapeHtml(m.logoA || (state.settings && state.settings.logo) || 'icons/volleyball (1).png');
    const logoB = escapeHtml(m.logoB || '');
    card.innerHTML = `
      <div style="flex:1;display:flex;flex-direction:column;gap:8px;">
        <div class="row-top" style="display:flex;justify-content:space-between;align-items:center;">
          <div class="team-name" style="text-align:right;flex:1;display:flex;align-items:center;gap:8px;justify-content:flex-end">${escapeHtml(m.teamA)}<img src="${logoA}" alt="logoA" style="width:36px;height:36px;border-radius:6px;object-fit:contain"/></div>
          <div class="score" style="min-width:60px;text-align:center">${displayScore}</div>
          <div class="team-name" style="text-align:left;flex:1;display:flex;align-items:center;gap:8px"><img src="${logoB || 'icons/volleyball (1).png'}" alt="logoB" style="width:36px;height:36px;border-radius:6px;object-fit:contain"/>${escapeHtml(m.teamB)}</div>
        </div>
        <div class="row-mid" style="display:flex;justify-content:center;align-items:center;gap:12px;">
          <div class="match-kind muted-small">${mapKindToPersian(m.kind) || ''}</div>
          <div class="match-status muted-small">${m.status==='finished'?'انجام شده':'برنامه‌ریزی‌شده'}</div>
          <div style="display:flex;gap:6px;align-items:center;">
            <button class="btn small" data-id="${m.id}">جزییات</button>
            <button class="btn small share-btn" data-share-id="${m.id}" title="اشتراک‌گذاری" aria-label="اشتراک‌گذاری">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M16 6l-4-4-4 4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M12 2v13" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </button>
          </div>
        </div>
        <div class="row-bottom" style="display:flex;justify-content:space-between;align-items:center;">
          <div class="muted-small">📅 ${m.date || '-'}</div>
          <div class="muted-small">⏰ ${m.time ? escapeHtml(m.time) : '-'} • ${escapeHtml(m.venue || '-')}</div>
        </div>
      </div>
    `;
  card.querySelector('button[data-id]').addEventListener('click', ()=> openMatchDetail(m.id));
  const shareBtn = card.querySelector('button[data-share-id]');
  if (shareBtn) shareBtn.addEventListener('click', ()=> openShareOverlay(m.id));
    list.appendChild(card);
  });
}

// Delegated handler: ensure share buttons work even if created via innerHTML
// Delegated handler: ensure share buttons work even if created via innerHTML
document.addEventListener('click', function(evt){
  try {
    let el = evt.target;
    while (el && el !== document) {
      if (el.getAttribute && el.getAttribute('data-share-id')) {
        const id = el.getAttribute('data-share-id'); if (!id) return; openShareOverlay(id); return;
      }
      el = el.parentNode;
    }
  } catch (e) { console.warn('delegated share handler error', e); }
});

function openMatchDetail(id) {
  let m = (state.competitions||[]).find(x=>x.id===id);
  if (!m) return alert('مسابقه پیدا نشد');
  let body = qs('#matchDetailBody');
  // build notes/rules/contact from the match object
  const noteLines = [];
  if (m.notes && String(m.notes).trim()) noteLines.push(`یادداشت: ${escapeHtml(m.notes)}`);
  if (m.rules && String(m.rules).trim()) noteLines.push(`قوانین: ${escapeHtml(m.rules)}`);
  if (m.contact && String(m.contact).trim()) noteLines.push(`تماس مسئول: ${escapeHtml(m.contact)}`);
  let notesHtml = noteLines.length ? `<ul style="margin:8px 0 0 0;padding-left:18px;">${noteLines.map(l=>`<li>${l}</li>`).join('')}</ul>` : '';
  // compute display score/hyphen-separated
  let displayScore = '';
  if (m.status === 'scheduled') displayScore = 'VS';
  else if (Array.isArray(m.sets) && m.sets.length>0) { let aWins=0,bWins=0; m.sets.forEach(s=>{const a=s[0]||0,b=s[1]||0; if(a>b) aWins++; if(b>a) bWins++;}); displayScore = `${aWins} - ${bWins}`; }
  else displayScore = (m.scoreA==null||m.scoreB==null) ? '-' : `${escapeHtml(String(m.scoreA))} - ${escapeHtml(String(m.scoreB))}`;
  // build per-set display if available
  let setsHtml = '';
  if (Array.isArray(m.sets) && m.sets.length>0) {
    const parts = m.sets.map((s,idx)=>{
      const a = s[0] == null ? '-' : String(s[0]);
      const b = s[1] == null ? '-' : String(s[1]);
      return `<span class="detail-chip">ست ${idx+1}: ${escapeHtml(a)} - ${escapeHtml(b)}</span>`;
    });
    setsHtml = `<div style="margin-top:8px;">${parts.join(' ')}</div>`;
  }
  const logoA = escapeHtml(m.logoA || (state.settings && state.settings.logo) || 'icons/volleyball (1).png');
  const logoB = escapeHtml(m.logoB || 'icons/volleyball (1).png');
  body.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:8px;">
    <div class="row-top" style="display:flex;justify-content:space-between;align-items:center;">
    <div style="text-align:right;flex:1;display:flex;align-items:center;justify-content:flex-end;gap:8px"><div class="team-name">${escapeHtml(m.teamA)}</div> <img src="${logoA}" style="width:48px;height:48px;object-fit:contain;border-radius:6px"/></div>
  <div style="text-align:center;min-width:80px;font-weight:800">${escapeHtml(String(displayScore))}</div>
    <div style="text-align:left;flex:1;display:flex;align-items:center;gap:8px"><img src="${logoB}" style="width:48px;height:48px;object-fit:contain;border-radius:6px"/> <div class="team-name">${escapeHtml(m.teamB)}</div></div>
  </div>
      <div class="row-mid" style="display:flex;justify-content:center;gap:12px;align-items:center;">
  <div class="match-kind muted-small">${mapKindToPersian(m.kind) || '-'}</div>
        <div class="match-status muted-small">${m.status==='finished' ? 'انجام شده' : 'برنامه‌ریزی‌شده'}</div>
      </div>
      <div class="row-bottom" style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <div><span class="detail-chip">📅 ${m.date || '-'}</span></div>
        <div><span class="detail-chip">⏰ ${m.time ? escapeHtml(m.time) : '-'}</span> <span class="detail-chip">${escapeHtml(m.venue || '-')}</span></div>
      </div>
  <div style="margin-top:8px;">${notesHtml}</div>
  ${setsHtml}
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;"><button id="editMatchBtn" class="btn">ویرایش</button><button id="delMatchBtn" class="btn danger">حذف</button></div>
    </div>
  `;
  console.debug('openMatchDetail: opening detail for', id);
  qs('#matchDetailModal').classList.remove('hide');
  // Create explicit control buttons (close/edit/delete) and attach handlers
  // ensure header close button exists and works
  const headerClose = qs('#closeMatchDetail');
  if (headerClose) {
    try { headerClose.removeEventListener && headerClose.removeEventListener('click', ()=>{}); } catch(e){}
    // Keep existing button content (we set it in HTML). Ensure white color for contrast on red background.
    headerClose.style.color = '#fff';
    headerClose.setAttribute('aria-label', 'بستن');
    headerClose.onclick = () => qs('#matchDetailModal').classList.add('hide');
  }
  // footer buttons: find the container and re-wire buttons
  const footerEdit = qs('#editMatchBtn');
  const footerDel = qs('#delMatchBtn');
  if (footerEdit) {
    footerEdit.onclick = (e) => { e.preventDefault(); console.debug('edit button clicked for', id); qs('#matchDetailModal').classList.add('hide'); openMatchForm(id); };
  }
  if (footerDel) {
    footerDel.onclick = (e) => { e.preventDefault(); if (confirm('حذف شود؟')) { state.competitions = state.competitions.filter(x=>x.id!==id); saveState(); qs('#matchDetailModal').classList.add('hide'); renderMatchesList(); } };
  }
}

function openMatchForm(editId) {
  console.debug('openMatchForm invoked, editId=', editId);
  // new full-page create/edit
  const isEdit = !!editId;
  let obj = isEdit ? JSON.parse(JSON.stringify(state.competitions.find(x=>x.id===editId))) : { id: uid('m'), status: 'scheduled', sets: [] };
  showView('match-edit');
  qs('#matchEditTitle').textContent = isEdit ? 'ویرایش مسابقه' : 'افزودن مسابقه';
  // default team A from club title/logo if creating
  const defaultClub = state.settings && state.settings.title ? state.settings.title : '';
  const defaultLogo = (state.settings && state.settings.logo) ? state.settings.logo : 'icons/volleyball (1).png';
  qs('#formTeamA').value = obj.teamA || defaultClub;
  qs('#formTeamALogo').value = obj.logoA || defaultLogo;
  qs('#formTeamB').value = obj.teamB || '';
  qs('#formTeamBLogo').value = obj.logoB || 'icons/volleyball (1).png';
  qs('#formDate').value = obj.date || todayJalali();
  qs('#formTime').value = obj.time || '';
  // initialize radios for status/type
  try { if (obj.status === 'finished') { const s = qs('#statusFinished'); if (s) s.checked = true; } else { const s = qs('#statusScheduled'); if (s) s.checked = true; } } catch(e){}
  try { const t = (obj.kind||'friendly'); const sel = qs('#type'+ (t.charAt(0).toUpperCase()+t.slice(1)) ); if (sel) sel.checked = true; } catch(e){}
  qs('#formVenue').value = obj.venue || '';
  qs('#formNotes').value = obj.notes || '';
  qs('#formRules').value = obj.rules || '';
  qs('#formContact').value = obj.contact || '';
  // populate sets into static inputs (5 fields)
  const sets = Array.isArray(obj.sets) ? obj.sets : [];
  for (let i=1;i<=5;i++) {
    qs(`#formAset${i}`).value = sets[i-1] ? (sets[i-1][0] ?? '') : '';
    qs(`#formBset${i}`).value = sets[i-1] ? (sets[i-1][1] ?? '') : '';
  }
  // show previews for logos if available
  const showPreview = (imgEl, val) => {
    if (!imgEl) return;
    if (val && val.trim()) { imgEl.src = val; imgEl.style.display = 'block'; }
    else { imgEl.src = defaultLogo; imgEl.style.display = 'block'; }
  };
  // if logo inputs empty, use default club logo for preview
  if (!qs('#formTeamALogo').value || !qs('#formTeamALogo').value.trim()) qs('#formTeamALogo').value = defaultLogo;
  if (!qs('#formTeamBLogo').value || !qs('#formTeamBLogo').value.trim()) qs('#formTeamBLogo').value = defaultLogo;
  showPreview(qs('#formTeamAPreview'), qs('#formTeamALogo').value);
  showPreview(qs('#formTeamBPreview'), qs('#formTeamBLogo').value);

  // --- New: populate hashtag suggestions list from existing competitions ---
  (function populateHashtags(){
    try {
      const list = qs('#hashtagsList'); if (!list) return;
      // collect unique saved hashtags
      const seen = new Set();
      (state.competitions||[]).forEach(c=>{ if (c && c.hashtag) seen.add(c.hashtag); });
      // clear and add
      list.innerHTML = '';
      Array.from(seen).forEach(h => { const opt = document.createElement('option'); opt.value = h; list.appendChild(opt); });
    } catch(e) { console.warn('populateHashtags failed', e); }
  })();

  // wire file inputs to read data URLs and set preview + hidden logo input
  const wireFile = (fileInputId, logoInputId, previewId) => {
    const fi = qs(fileInputId); const li = qs(logoInputId); const pi = qs(previewId);
    if (!fi) return;
    fi.onchange = (ev) => {
      const f = fi.files && fi.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const url = e.target.result;
        if (li) li.value = url;
        if (pi) { pi.src = url; pi.style.display = 'block'; }
      };
      reader.readAsDataURL(f);
    };
  };
  wireFile('#formTeamALogoFile','#formTeamALogo','#formTeamAPreview');
  wireFile('#formTeamBLogoFile','#formTeamBLogo','#formTeamBPreview');

  // compute set totals live
  const computeTotals = () => {
    let aTotal = 0, bTotal = 0;
    for (let i=1;i<=5;i++){
      const aEl = qs(`#formAset${i}`); const bEl = qs(`#formBset${i}`);
      const a = aEl ? String(aEl.value || '').trim() : '';
      const b = bEl ? String(bEl.value || '').trim() : '';
      const an = a === '' ? null : Number(a);
      const bn = b === '' ? null : Number(b);
      if (an != null && bn != null) {
        if (an > bn) aTotal++; else if (bn > an) bTotal++;
      }
    }
    if (qs('#formTeamATotal')) qs('#formTeamATotal').textContent = aTotal || '-';
    if (qs('#formTeamBTotal')) qs('#formTeamBTotal').textContent = bTotal || '-';
  };
  for (let i=1;i<=5;i++) { const ael = qs(`#formAset${i}`); const bel = qs(`#formBset${i}`); if (ael) ael.oninput=computeTotals; if (bel) bel.oninput=computeTotals; }
  computeTotals();
  // ensure sets-area visibility default based on selected status radio
  const updateSetsVisibility = () => {
    const finished = qs('#statusFinished');
    const show = !!(finished && finished.checked);
    qsa('.sets-area').forEach(el=> el.style.display = show ? 'grid' : 'none');
  };
  // wire radios to update sets visibility
  const sA = qs('#statusScheduled'); const sB = qs('#statusFinished'); if (sA) sA.onchange = updateSetsVisibility; if (sB) sB.onchange = updateSetsVisibility;
  // wire type radios (they are true radios by name, so no need to enforce)
  const typeIds = ['typeFriendly','typeLeague','typeKnockout','typeGroup'];
  // set defaults if none selected
  (function setDefaults(){ if (!qs('#statusScheduled') && !qs('#statusFinished')) { const s = qs('#statusScheduled'); if (s) s.checked = true; } if (!typeIds.some(id=>qs('#'+id) && qs('#'+id).checked)) { const tf = qs('#typeFriendly'); if (tf) tf.checked = true; } updateSetsVisibility(); })();
  // time input: auto-insert ':' after 2 digits and validate HH:MM
  const timeInput = qs('#formTime');
  if (timeInput) {
    timeInput.oninput = (ev) => {
      let v = timeInput.value.replace(/[^0-9:]/g, '');
      v = v.replace(/:/g, '');
      if (v.length > 2) v = v.slice(0,2) + ':' + v.slice(2,4);
      if (v.length > 5) v = v.slice(0,5);
      timeInput.value = v;
    };
    timeInput.onblur = () => {
      const val = timeInput.value;
      if (!val) return;
      const m = val.match(/^(\d{1,2}):(\d{2})$/);
      if (!m) { alert('فرمت زمان باید HH:MM باشد'); timeInput.focus(); return; }
      const hh = Number(m[1]); const mm = Number(m[2]);
      if (hh<0 || hh>23 || mm<0 || mm>59) { alert('ساعت معتبر نیست (00:00 - 23:59)'); timeInput.focus(); }
    };
  }
  // wire back button
  const backBtn = qs('#backFromMatchEdit'); if (backBtn) { backBtn.onclick = ()=> showView('competitions'); }
  // save handler — collect fields and persist
  const saveBtnEl = qs('#saveMatchBtn'); if (saveBtnEl) {
    saveBtnEl.addEventListener('click', (ev)=>{ try { ev.preventDefault();
  obj.teamA = qs('#formTeamA').value.trim(); obj.teamB = qs('#formTeamB').value.trim(); obj.date = qs('#formDate').value.trim(); obj.time = qs('#formTime').value.trim(); obj.venue = qs('#formVenue').value.trim();
  // status from radios
  obj.status = (qs('#statusFinished') && qs('#statusFinished').checked) ? 'finished' : 'scheduled';
  // kind/type from radios
  let selType = null; typeIds.forEach(tid => { const e = qs('#'+tid); if (e && e.checked) selType = e.value || tid.replace('type','').toLowerCase(); });
  if (!selType) { alert('لطفا نوع مسابقه را انتخاب کنید'); return; }
  obj.kind = selType;
  // hashtag
  const hashtagInput = qs('#formHashtag'); if (hashtagInput) obj.hashtag = hashtagInput.value.trim().replace(/^#+/,'');
  // logos: if user uploaded a file we stored a dataURL in the input; otherwise fallback to entered URL or defaults
  obj.logoA = (qs('#formTeamALogo') && qs('#formTeamALogo').value.trim()) || defaultLogo;
  obj.logoB = (qs('#formTeamBLogo') && qs('#formTeamBLogo').value.trim()) || '';
    obj.notes = qs('#formNotes').value.trim();
    obj.rules = qs('#formRules').value.trim();
    obj.contact = qs('#formContact').value.trim();
      // collect static sets 1..5
      const newSets = [];
      for (let i=1;i<=5;i++) {
        const a = qs(`#formAset${i}`).value.trim(); const b = qs(`#formBset${i}`).value.trim();
        if (a === '' && b === '') continue;
        newSets.push([ a === '' ? null : Number(a), b === '' ? null : Number(b) ]);
      }
      obj.sets = newSets;
      if (!obj.teamA || !obj.teamB) { alert('نام هر دو تیم لازم است'); return; }
  if (isEdit) { let idx = state.competitions.findIndex(x=>x.id===editId); if (idx!==-1) state.competitions[idx]=obj; }
      else state.competitions.unshift(obj);
  // update hashtags datalist after save
  try { const list = qs('#hashtagsList'); if (list && obj.hashtag) { const exists = Array.from(list.children).some(o=>o.value===obj.hashtag); if (!exists) { const o = document.createElement('option'); o.value = obj.hashtag; list.appendChild(o); } } } catch(e){}
      saveState(); showView('competitions'); renderMatchesList(); } catch(err) { console.error('saveMatch failed', err); alert('خطا هنگام ذخیره مسابقه — کنسول را بررسی کنید.'); } }, false);
  }
}

// --- Share card generation ---
function openShareOverlay(matchId) {
  const m = (state.competitions||[]).find(x=>x.id===matchId);
  if (!m) return alert('مسابقه پیدا نشد');
  console.debug('openShareOverlay called for', matchId);
  // fill overlay fields (use safe checks because markup may vary)
  const elTitle = qs('#shareTitle'); if (elTitle) elTitle.textContent = m.title || (m.teamA + ' vs ' + m.teamB);
  const elKind = qs('#shareKind'); if (elKind) elKind.textContent = mapKindToPersian(m.kind) || '-';
  const elDate = qs('#shareDate'); if (elDate) elDate.textContent = m.date || '-';
  const elVenue = qs('#shareVenue'); if (elVenue) elVenue.textContent = m.venue || '-';
  const elTime = qs('#shareTime'); if (elTime) elTime.textContent = m.time || '-';
  // logos into the card
  const logoA = m.logoA || (state.settings && state.settings.logo) || 'icons/volleyball (1).png';
  const logoB = m.logoB || 'icons/volleyball (1).png';
  const imgA = qs('#shareLogoA'); const imgB = qs('#shareLogoB');
  if (imgA) imgA.src = logoA; if (imgB) imgB.src = logoB;
  // set team name fields and VS (new layout)
  const tA = qs('#shareTeamA'); const tB = qs('#shareTeamB');
  if (tA) tA.textContent = m.teamA || '';
  if (tB) tB.textContent = m.teamB || '';
  // show overlay
  qs('#shareOverlay').classList.remove('hide');
  // apply current colors to the visible card (live preview)
  const card = qs('#shareCard');
  const colorAInput = qs('#shareColorA'); const colorBInput = qs('#shareColorB');
  function applyCardColors() {
    const a = (colorAInput && colorAInput.value) || '#ff6b6b';
    const b = (colorBInput && colorBInput.value) || '#ff9ac2';
    if (card) card.style.background = `linear-gradient(180deg, ${a}, ${b})`;
  }
  applyCardColors();
  if (colorAInput) colorAInput.oninput = applyCardColors; if (colorBInput) colorBInput.oninput = applyCardColors;
  // insert court image behind the gradient if available
  const courtImgPath = 'icons/court.png';
  if (card) {
    // add background image element if not present
    if (!qs('#shareCourtBg')) {
  const bg = document.createElement('img'); bg.id = 'shareCourtBg'; bg.src = courtImgPath; bg.style.position = 'absolute'; bg.style.width = '70%'; bg.style.height = '70%'; bg.style.left = '50%'; bg.style.top = '50%'; bg.style.transform = 'translate(-50%, -50%)'; bg.style.objectFit = 'contain'; bg.style.opacity = '0.18'; bg.style.zIndex = '1'; card.prepend(bg);
      // ensure existing content stays above bg
      Array.from(card.querySelectorAll(':scope > *:not(#shareCourtBg)')).forEach(el=> el.style.zIndex = '2');
    }
  }
  // backdrop click closes overlay
  const backdrop = qs('#shareOverlayBackdrop'); if (backdrop) { backdrop.onclick = ()=> qs('#shareOverlay').classList.add('hide'); }
  // wire actions (use direct listeners so cloning doesn't break handlers)
  const closeBtn = qs('#closeShareOverlay');
  if (closeBtn) { try { closeBtn.onclick = null; } catch(e){}; closeBtn.addEventListener('click', ()=> qs('#shareOverlay').classList.add('hide')); }
  const socialBtn = qs('#shareToSocialBtn');
  if (socialBtn) {
    try { socialBtn.onclick = null; } catch(e){}
    socialBtn.addEventListener('click', async () => {
      socialBtn.disabled = true;
      socialBtn.textContent = 'در حال ساخت تصویر...';
      try {
        await captureAndShareModal(m);
      } catch(e) {
        console.warn('capture flow failed, falling back to renderer', e);
        try { await shareToSocial(m); } catch(err) { console.error('share action failed', err); alert('خطا در اشتراک‌گذاری'); }
      }
      socialBtn.disabled = false;
      socialBtn.textContent = 'اشتراک به\u200cصورت عکس';
    });
  }
}

async function shareToSocial(m) {
  // try navigator.share with text + URL; fallback to taking a snapshot of the card via html2canvas-like approach (simple canvas fallback)
  const text = `${m.title || ''}\n${m.teamA || ''} - ${m.teamB || ''}\n${m.date || ''} ${m.time || ''} @ ${m.venue || ''}`;
  if (navigator.share) {
    try {
      await navigator.share({ title: m.title || 'مسابقه', text });
      return;
    } catch (e) {
      console.warn('navigator.share failed', e);
    }
  }
  // fallback: capture the `#shareCard` using html2canvas at story resolution (1080x1920)
  // Use deterministic canvas renderer (avoids html2canvas / CORS issues)
  try {
    const colorA = (qs('#shareColorA') && qs('#shareColorA').value) || '#ff6b6b';
    const colorB = (qs('#shareColorB') && qs('#shareColorB').value) || '#ff9ac2';
    // ensure logos are accessible: if logo fields are File objects, convert to data URLs first
    const safeM = { ...m };
    try {
      if (safeM.logoA && safeM.logoA instanceof File) {
        safeM.logoA = await new Promise(res => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(safeM.logoA); });
      }
      if (safeM.logoB && safeM.logoB instanceof File) {
        safeM.logoB = await new Promise(res => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(safeM.logoB); });
      }
    } catch(e) { console.debug('logo File -> dataURL conversion failed', e); }

    const blob = await renderShareCanvasFromData(safeM, { width: 1080, height: 1920, colorA, colorB });
    if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'match-story.png', { type: blob.type })] })) {
      try {
        await navigator.share({ files: [new File([blob], 'match-story.png', { type: blob.type })], title: m.title || 'مسابقه' });
        return;
      } catch (e) { console.warn('share with file failed', e); }
    }
    // fallback: download
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'match-story.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  } catch (e) {
    console.error('shareToSocial (canvas renderer) failed', e);
    try {
      console.debug('shareToSocial: falling back to previous text-only story image');
      await fallbackTextStory(m);
      return;
    } catch (fbErr) {
      console.error('fallbackTextStory also failed', fbErr);
      alert('خطا در تولید تصویر اشتراک');
    }
  }
}

// Renderer for player profile story image (1080x1920 scaled to preview)
async function renderPlayerCanvasFromData(p, opts = {}) {
  const w = opts.width || 1080; const h = opts.height || 1920;
  const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  // background gradient
  const colorA = opts.colorA || '#ff6b6b'; const colorB = opts.colorB || '#ff9ac2';
  const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,colorA); g.addColorStop(1,colorB);
  ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
  // draw optional photo box
  const photoSize = Math.floor(w * 0.24); const photoX = Math.floor((w - photoSize)/2); const photoY = Math.floor(h * 0.08);
  try {
    if (p.photo) {
      const img = new Image(); img.crossOrigin = 'anonymous'; await new Promise((res, rej)=>{ img.onload = res; img.onerror = rej; img.src = p.photo; });
      // draw circular/rounded photo
      const r = Math.floor(photoSize * 0.12);
      roundRect(ctx, photoX, photoY, photoSize, photoSize, r, true, false);
      ctx.save(); roundedClip(ctx, photoX, photoY, photoSize, photoSize, r); ctx.drawImage(img, photoX, photoY, photoSize, photoSize); ctx.restore();
    } else {
      ctx.fillStyle = 'rgba(255,255,255,0.16)'; ctx.fillRect(photoX, photoY, photoSize, photoSize);
    }
  } catch (e) { console.debug('player photo draw failed', e); }
  // draw name
  // draw name centered under photo
  ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.font = '700 64px Vazirmatn, sans-serif';
  const nameY = photoY + photoSize + 90;
  ctx.fillText(p.name || '-', w/2, nameY);
  // draw stacked centered info lines (multiline wrap helper)
  function drawWrappedCenter(text, x, startY, maxWidth, lineHeight, font) {
    ctx.font = font;
    const words = String(text || '').split(/\s+/);
    const lines = [];
    let line = '';
    words.forEach((wrd) => {
      const test = line ? (line + ' ' + wrd) : wrd;
      const m = ctx.measureText(test).width;
      if (m > maxWidth && line) { lines.push(line); line = wrd; } else { line = test; }
    });
    if (line) lines.push(line);
    lines.forEach((ln, idx) => { ctx.fillText(ln, x, startY + idx * lineHeight); });
    return lines.length;
  }
  const infoX = Math.floor(w * 0.12); const infoW = Math.floor(w * 0.76);
  let lineY = nameY + 48;
  ctx.fillStyle = 'rgba(255,255,255,0.95)';
  drawWrappedCenter('تاریخ تولد: ' + (p.birthdate || '-'), w/2, lineY, infoW, 42, '600 30px Vazirmatn, sans-serif'); lineY += 48;
  drawWrappedCenter('سابقه عضویت: ' + (p.joinDate || '-'), w/2, lineY, infoW, 40, '500 28px Vazirmatn, sans-serif'); lineY += 44;
  drawWrappedCenter('قد/وزن: ' + ((p.height || '-') + 'cm / ' + (p.weight || '-') + 'kg'), w/2, lineY, infoW, 40, '500 28px Vazirmatn, sans-serif'); lineY += 44;
  drawWrappedCenter('مهارت: ' + (p.skills || '-') + ' • امتیاز: ' + (p.score || '-'), w/2, lineY, infoW, 40, '600 30px Vazirmatn, sans-serif');
  // return blob
  return await new Promise((res, rej) => { canvas.toBlob(b => { if (b) res(b); else rej(new Error('toBlob failed')); }, 'image/png'); });
}

// Helpers for rounded drawing (reuse existing functions names from renderer)
function roundRect(ctx, x, y, w, h, r, fill, stroke) {
  if (typeof r === 'undefined') r = 5; ctx.beginPath(); ctx.moveTo(x + r, y); ctx.arcTo(x + w, y, x + w, y + h, r); ctx.arcTo(x + w, y + h, x, y + h, r); ctx.arcTo(x, y + h, x, y, r); ctx.arcTo(x, y, x + w, y, r); ctx.closePath(); if (fill) ctx.fill(); if (stroke) ctx.stroke();
}
function roundedClip(ctx, x, y, w, h, r) { ctx.beginPath(); ctx.moveTo(x + r, y); ctx.arcTo(x + w, y, x + w, y + h, r); ctx.arcTo(x + w, y + h, x, y + h, r); ctx.arcTo(x, y + h, x, y, r); ctx.arcTo(x, y, x + w, y, r); ctx.closePath(); ctx.clip(); }

// Open the player share modal and populate preview
function openPlayerShareOverlay(playerId) {
  console.debug('openPlayerShareOverlay called for', playerId);
  const p = (state.players||[]).find(x=>x.id===playerId);
  if (!p) return alert('بازیکن پیدا نشد');
  const overlay = qs('#playerShareOverlay');
  if (!overlay) return alert('پنجرهٔ اشتراک پیدا نشد');
  // Move overlay to document.body to avoid clipping by parent stacking contexts
  try { if (overlay.parentNode !== document.body) document.body.appendChild(overlay); } catch(e) { console.warn('could not move overlay to body', e); }
  // force visibility and ensure it's on top
  overlay.classList.remove('hide');
  overlay.style.position = 'fixed'; overlay.style.inset = '0'; overlay.style.left = '0'; overlay.style.top = '0'; overlay.style.right = '0'; overlay.style.bottom = '0';
  overlay.style.display = 'flex';
  overlay.style.zIndex = 10050;
  // ensure backdrop stays under the content and content is interactive
  try {
    const children = Array.from(overlay.children || []);
    children.forEach(ch => {
      if (!ch) return;
      if (ch.id === 'playerShareBackdrop') {
        ch.style.position = 'fixed'; ch.style.inset = '0'; ch.style.left = '0'; ch.style.top = '0';
        ch.style.right = '0'; ch.style.bottom = '0'; ch.style.zIndex = '10048'; ch.style.display = 'block';
        ch.style.pointerEvents = 'auto';
      } else {
        // modal content(s) should be above the backdrop and accept pointer events
        ch.style.position = ch.style.position || 'relative'; ch.style.zIndex = '10052'; ch.style.pointerEvents = 'auto';
      }
    });
  } catch (e) { console.warn('failed set overlay child z-indexes', e); }
  // scroll into view and focus close button so user notices the modal
  try { overlay.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(e){}
  setTimeout(()=>{ const cb = qs('#closePlayerShareOverlay'); if (cb) { try{ cb.focus(); }catch(e){} } }, 80);
  // small visual cue for environments where console isn't visible
  try { const cue = document.createElement('div'); cue.textContent = 'پنجرهٔ اشتراک باز شد'; cue.style.position='fixed'; cue.style.right='16px'; cue.style.top='16px'; cue.style.background='rgba(0,0,0,0.8)'; cue.style.color='#fff'; cue.style.padding='8px 12px'; cue.style.borderRadius='8px'; cue.style.zIndex='10060'; document.body.appendChild(cue); setTimeout(()=>cue.remove(),1200); } catch(e){}
  qs('#playerSharePhotoWrap').innerHTML = p.photo ? `<img src="${p.photo}" style="width:100%;height:100%;object-fit:cover;">` : '<div class="muted">بدون عکس</div>';
  qs('#playerShareName').textContent = p.name || '-';
  qs('#playerShareDob').textContent = 'تاریخ تولد: ' + (p.birthdate || '-');
  const summ = `سابقه: ${p.joinDate||'-'} • وضعیت: ${p.height||'-'}/${p.weight||'-'} • مهارت: ${p.skills||'-'} • امتیاز: ${p.score||'-'}`;
  qs('#playerShareSummary').textContent = summ;
  // wire buttons
  qs('#playerShareImageBtn').onclick = async () => { qs('#playerShareImageBtn').disabled = true; try { await captureAndSharePlayerProfile(p); } catch(e){ console.error(e); alert('خطا در تولید تصویر'); } qs('#playerShareImageBtn').disabled = false; };
  qs('#playerShareTextBtn').onclick = async () => { const text = formatPlayerProfileText(p); try { if (navigator.share) await navigator.share({ title: p.name||'پروفایل بازیکن', text }); else { await navigator.clipboard.writeText(text); alert('متن پروفایل در کلیپ‌بورد کپی شد'); } } catch(e){ console.error('share text failed', e); alert('اشتراک متن انجام نشد'); } };
  qs('#closePlayerShareOverlay').onclick = () => qs('#playerShareOverlay').classList.add('hide');
}

// Create image and share/download it
async function captureAndSharePlayerProfile(p) {
  // create blob via renderer
  const blob = await renderPlayerCanvasFromData(p, { width:1080, height:1920 });
  if (!blob) throw new Error('render failed');
  const file = new File([blob], (p.name||'player') + '.png', { type: 'image/png' });
  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try { await navigator.share({ files: [file], title: p.name || 'پروفایل بازیکن' }); return; } catch (e) { console.warn('navigator.share(files) failed', e); }
  }
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = (p.name||'player') + '.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function formatPlayerProfileText(p) {
  // build richer textual profile
  const age = p.birthdate ? calcExactAge(p.birthdate) : null;
  const category = age ? determineCategory(age) : (p.category || '-');
  const payments = (state.payments || []).filter(x => x.playerId === p.id).slice(-5).reverse().map(x => `${x.amount} (${isoToJalali(x.date)})`).join('؛ ') || 'هیچ پرداختی ثبت نشده';
  const recentNotes = (p.events || []).slice(-5).reverse().map(e => `${e.date}${e.author ? ' • ' + (e.author.name||'') : ''}: ${e.text}`).join('\n') || 'بدون یادداشت';
  return `پروفایل بازیکن: ${p.name || '-'}\nاطلاعات تماس: ${p.phone||'-'}\nتاریخ تولد: ${p.birthdate || '-'}\nرده/رده‌سنی: ${category}\nسابقه عضویت: ${p.joinDate || '-'}\nقد: ${p.height||'-'} cm • وزن: ${p.weight||'-'} kg\nمهارت: ${p.skills || '-'} • امتیاز: ${p.score || '-'}\n\nآخرین پرداخت‌ها: ${payments}\n\nیادداشت‌های اخیر:\n${recentNotes}`;
}

// Backwards-compatible wrapper: delegate to the primary capture implementation.
async function captureAndShareModal(match) {
  // If called without a match, try to infer the currently opened match from the overlay
  if (!match) {
    try {
      const overlay = qs('#shareOverlay'); if (!overlay || overlay.classList.contains('hide')) return;
      const title = qs('#shareTitle') ? qs('#shareTitle').textContent : null;
      const candidate = (state.competitions||[]).find(x => (x.title && x.title === title) || (x.teamA && (title||'').includes(x.teamA)) || (x.teamB && (title||'').includes(x.teamB)));
      if (candidate) match = candidate; else { console.debug('captureAndShareModal: no match inferred'); return; }
    } catch (e) { console.debug('capture wrapper infer failed', e); return; }
  }
  if (typeof window._captureAndShareModalImpl === 'function') return await window._captureAndShareModalImpl(match);
  // fallback: nothing to do
  console.debug('No capture implementation available');
}
// Fallback: create a simple text-only story image and trigger download/share
async function fallbackTextStory(m) {
  try {
    const outCanvas = document.createElement('canvas'); outCanvas.width = 1080; outCanvas.height = 1920;
    const ctx = outCanvas.getContext('2d');
    // background
    const g = ctx.createLinearGradient(0,0,outCanvas.width,outCanvas.height);
    g.addColorStop(0,'#ff6b6b'); g.addColorStop(1,'#ff9ac2');
    ctx.fillStyle = g; ctx.fillRect(0,0,outCanvas.width,outCanvas.height);
    // title
    ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.font = 'bold 48px Vazirmatn, sans-serif';
    ctx.fillText(m.title || (m.teamA + ' vs ' + m.teamB), outCanvas.width/2, 220);
    // teams
    ctx.font = '700 64px Vazirmatn, sans-serif'; ctx.fillText((m.teamA||'') + '  VS  ' + (m.teamB||''), outCanvas.width/2, 520);
    // date/time/venue
    ctx.font = '500 28px Vazirmatn, sans-serif'; ctx.fillText((m.date || '-') + '   •   ' + (m.time || '-'), outCanvas.width/2, outCanvas.height - 260);
    ctx.fillText(m.venue || '-', outCanvas.width/2, outCanvas.height - 210);
    // convert
    const blob = await new Promise(res => outCanvas.toBlob(res, 'image/png'));
    if (!blob) throw new Error('Failed to create blob');
    // try to share
    if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'match-story.png', { type: blob.type })] })) {
      try { await navigator.share({ files: [new File([blob], 'match-story.png', { type: blob.type })], title: m.title || 'مسابقه' }); return; }
      catch (err) { console.warn('navigator.share fallback failed', err); }
    }
    // download fallback
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'match-story.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  } catch (err) {
    console.error('fallbackTextStory failed', err);
    alert('خطا در تولید تصویر اشتراک');
  }
}

function openJalaliCalendarForMatches() {
  // calendar modal removed; focus the inline date filter for convenience
  const el = qs('#matchesDateFilter'); if (el) { el.focus(); el.scrollIntoView({behavior:'smooth',block:'center'}); }
}

// --- Inline Jalali calendar widget for matches date filter ---
(function(){
  let current = null; // { y, m }
  const widget = () => qs('#matchesDateWidget');
  const grid = () => qs('#mdwGrid');
  const title = () => qs('#mdwTitle');
  function openWidget() { const w = widget(); if (!w) return; w.style.display = 'block'; document.addEventListener('click', outsideHide); }
  function closeWidget() { const w = widget(); if (!w) return; w.style.display = 'none'; document.removeEventListener('click', outsideHide); }
  function outsideHide(e) {
    const w = widget(); if (!w) return; const input = qs('#matchesDateFilter');
    if (!w.contains(e.target) && e.target !== input) closeWidget();
  }
  function pad(n){ return String(n).padStart(2,'0'); }
  function renderMonth(y,m){
    current = { y, m };
    if (!grid()||!title()) return;
    // title: year/month
    title().textContent = `${y}/${pad(m)}`;
    // compute first day of month weekday and days in month using jalali_to_gregorian
    // create days array
    const days = [];
    // find weekday of first day: convert to ISO and use Date
    const firstISO = jalaliToISO(`${y}/${pad(m)}/01`);
    const wd = new Date(firstISO).getDay(); // 0 (Sun) .. 6
    // Jalali week in UI will start on Sat (but we'll align with existing locale using JS weekday)
    const daysInMonth = (function(){
      // determine by trying next month day 1 minus one day
      let nextM = m+1, nextY = y; if (nextM>12){ nextM=1; nextY++; }
      const nextISO = jalaliToISO(`${nextY}/${pad(nextM)}/01`);
      const d = new Date(nextISO); d.setDate(d.getDate()-1);
      const j = gregorian_to_jalali(d.getFullYear(), d.getMonth()+1, d.getDate()); return j[2];
    })();
    // clear grid and render empty slots + days
    grid().innerHTML = '';
    // render weekday headers (short Persian)
    const wNames = ['ش','ی','د','س','چ','پ','ج']; // Sat..Fri (approx short)
    wNames.forEach(n=>{ const el = document.createElement('div'); el.style.fontWeight='700'; el.style.textAlign='center'; el.style.padding='6px 0'; el.textContent = n; grid().appendChild(el); });
    for (let i=0;i< (7*6); i++){ // 6 rows to cover all months
      const cell = document.createElement('div'); cell.style.minHeight='34px'; cell.style.textAlign='center'; cell.style.padding='6px 4px'; cell.style.borderRadius='6px';
      const hdrCount = 7; // first row is weekdays so skip placing day numbers until index >=7
      if (i < hdrCount) continue; // skip header placeholders since already added
    }
    // We will render days starting after weekday header row; create separate container for numbers
    const numsContainer = document.createElement('div'); numsContainer.style.gridColumn = '1/-1'; numsContainer.style.display='grid'; numsContainer.style.gridTemplateColumns='repeat(7,1fr)'; numsContainer.style.gap='6px';
    // compute offset: weekday of first date (JS getDay) where Sun=0; we want to align to Sat-first view; shift accordingly
    // Convert JS weekday to index where Sat=0: ((wd+1)%7)
    const offset = ((wd + 1) % 7);
    for (let i=0;i<offset;i++){ const e = document.createElement('div'); numsContainer.appendChild(e); }
    for (let d=1; d<=daysInMonth; d++){
      const e = document.createElement('button'); e.className='btn'; e.style.padding='6px'; e.style.width='100%'; e.style.boxSizing='border-box'; e.textContent = String(d);
      e.addEventListener('click', ()=>{
        const val = `${y}/${pad(m)}/${pad(d)}`;
        const inpt = qs('#matchesDateFilter'); if (inpt) inpt.value = val;
        selectedMatchesDate = val; renderMatchesList(); closeWidget();
      });
      numsContainer.appendChild(e);
    }
    // append empty cells to complete grid (optional)
    const totalCells = offset + daysInMonth; const trailing = (7 - (totalCells % 7)) % 7;
    for (let i=0;i<trailing;i++) numsContainer.appendChild(document.createElement('div'));
    // now put weekdays header + numbers into mdwGrid
    const mdw = grid(); mdw.innerHTML = ''; wNames.forEach(n=>{ const h = document.createElement('div'); h.style.fontWeight='700'; h.style.textAlign='center'; h.style.padding='6px 0'; h.textContent = n; mdw.appendChild(h); });
    mdw.appendChild(numsContainer);
  }
  // nav handlers
  function initWidget(){
    const inpt = qs('#matchesDateFilter'); if (!inpt) return;
    const w = widget(); if (!w) return;
    inpt.addEventListener('focus', ()=>{ // open and set to input month or today
      const parts = (inpt.value || todayJalali()).split('/').map(Number);
      renderMonth(parts[0], parts[1]); openWidget();
    }, false);
    inpt.addEventListener('click', (e)=>{ e.stopPropagation(); const parts = (inpt.value || todayJalali()).split('/').map(Number); renderMonth(parts[0], parts[1]); openWidget(); }, false);
  const prevBtn = qs('#mdwPrev'); if (prevBtn) prevBtn.addEventListener('click', ()=>{ if (!current) return; let y=current.y, m=current.m-1; if (m<1){ m=12; y--; } renderMonth(y,m); });
  const nextBtn = qs('#mdwNext'); if (nextBtn) nextBtn.addEventListener('click', ()=>{ if (!current) return; let y=current.y, m=current.m+1; if (m>12){ m=1; y++; } renderMonth(y,m); });
  const todayBtn = qs('#mdwToday'); if (todayBtn) todayBtn.addEventListener('click', ()=>{ const t = todayJalali().split('/').map(Number); renderMonth(t[0], t[1]); const inpt = qs('#matchesDateFilter'); if (inpt) inpt.value = todayJalali(); selectedMatchesDate = todayJalali(); renderMatchesList(); closeWidget(); });
  const closeBtn = qs('#mdwClose'); if (closeBtn) closeBtn.addEventListener('click', ()=>{ closeWidget(); });
    // clicking calendar icon (if any) or calling openJalaliCalendarForMatches should focus; we already wired that function
  }
  // expose init on DOM ready for competitions page
  document.addEventListener('DOMContentLoaded', ()=>{ try{ initWidget(); }catch(e){console.warn('initWidget failed',e);} });
})();

/* ================================================================
  SECTION: Views & Rendering
  - renderHome, renderPlayersPage, renderPlayerProfile, etc.
  ================================================================ */
/* Views & Rendering */
/* renderRankEditor moved here so it is available before showView is called */
function renderRankEditor() {
  const content = qs('#rankEditorContent');
  // Ensure we have a usable ranks array (handle older backups where ranks may be null)
  const defaultRanks = [
    { id: 'mini', name: 'مینی والیبال', minAgeYears: 0, maxAgeYears: 12, startDateJ: '' },
    { id: 'noonahal', name: 'نونهالان', minAgeYears: 13, maxAgeYears: 14, startDateJ: '' },
    { id: 'nojavanan', name: 'نوجوانان', minAgeYears: 15, maxAgeYears: 16, startDateJ: '' },
    { id: 'nojavanan_boghr', name: 'نوجوانان بزرگ', minAgeYears: 17, maxAgeYears: 18, startDateJ: '' },
    { id: 'javan', name: 'جوانان', minAgeYears: 19, maxAgeYears: 20, startDateJ: '' },
    { id: 'omid', name: 'امیدها', minAgeYears: 21, maxAgeYears: 22, startDateJ: '' },
    { id: 'adult', name: 'بزرگسالان', minAgeYears: 23, maxAgeYears: 200, startDateJ: '' }
  ];
  if (!state.settings) state.settings = {};
  if (!state.settings.ranks) state.settings.ranks = defaultRanks.slice();
  const ranks = state.settings.ranks;
  // reference date: can be manual or automatic. store mode in state.settings.ranksRefMode = 'auto'|'manual'
  if (!state.settings.ranksRefMode) state.settings.ranksRefMode = 'auto';
  // ensure ranksReferenceDate exists for display. If mode is auto, default to the upcoming yyyy/10/11 (11 Dey)
  if (!state.settings.ranksReferenceDate) {
    if (state.settings.ranksRefMode === 'auto') {
      const t = todayJalali().split('/').map(Number);
      const thisYearCutoff = `${t[0]}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
      if (jalaliToISO(todayJalali()) < jalaliToISO(thisYearCutoff)) {
        state.settings.ranksReferenceDate = thisYearCutoff;
      } else {
        state.settings.ranksReferenceDate = `${t[0]+1}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
      }
    } else {
      state.settings.ranksReferenceDate = state.settings.lastCategoryUpdate || todayJalali();
    }
  }
  const refDate = state.settings.ranksReferenceDate;
  content.innerHTML = `
    <style>
      /* Rank Editor responsive tweaks - tightened per user request */
      #rankEditorContent { font-size:11px; }
      #rankEditorContent .rank-row { display:flex;gap:4px;align-items:center;flex-wrap:wrap; }
      #rankEditorContent .rank-name { flex:1 1 100px;min-width:48px;max-width:170px;font-size:11px;padding:4px; }
      #rankEditorContent .rank-min, #rankEditorContent .rank-max { width:56px;text-align:center;flex:0 0 auto;font-size:11px;padding:4px; }
      #rankEditorContent .delete-rank { padding:4px 6px; font-size:12px; width:30px; height:30px; border-radius:4px; }
      @media (max-width:360px){
        #rankEditorContent .delete-rank { width:20px; height:20px; padding:2px 4px; font-size:10px; }
        #rankEditorContent .rank-name { max-width:140px; }
        #rankEditorContent .rank-min, #rankEditorContent .rank-max { width:52px; }
      }
      #rankEditorContent .ref-box { border:1px solid rgba(0,0,0,0.06);padding:6px;border-radius:8px;background:#fff; }
      #rankEditorContent .controls-row { display:block; }
      #rankEditorContent .controls-row .buttons { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; align-items:center; }
      #rankEditorContent .controls-row button { padding:6px 6px; font-size:12px }
      @media (max-width:420px){
        #rankEditorContent .controls-row .buttons { grid-template-columns:repeat(2,1fr); }
      }
      @media (max-width:320px){
        #rankEditorContent .controls-row .buttons { grid-template-columns:1fr; }
        #rankEditorContent .controls-row button{width:100%;}
      }
    </style>
    <div id="rankEditorContent" style="display:flex;flex-direction:column;gap:10px;">
      <div class="ref-box">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
          <div style="font-weight:700;">تاریخ مرجع آپدیت رده ها</div>
          <div style="display:flex;align-items:center;gap:8px;"> 
            <label style="display:flex;align-items:center;gap:6px;"> <input type="radio" name="ranksRefMode" value="auto" ${state.settings.ranksRefMode === 'auto' ? 'checked' : ''}/> خودکار</label>
            <label style="display:flex;align-items:center;gap:6px;"> <input type="radio" name="ranksRefMode" value="manual" ${state.settings.ranksRefMode === 'manual' ? 'checked' : ''}/> دستی</label>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
          <input id="ranksRefDate" class="input jalali-input" value="${refDate}" style="max-width:160px;" />
          <div id="ranksRefStatus" style="font-weight:700;padding:6px;border-radius:4px;">&nbsp;</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;font-weight:700;padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.06);;flex-wrap:wrap;">
  <div style="flex:1;min-width:80px;text-align:center;">رده‌ها</div>
        <div style="width:100px;text-align:center;">سن شروع<div style="font-size:12px;color:var(--muted);font-weight:400;">(شامل رده می‌شود)</div></div>
        <div style="width:100px;text-align:center;">سن پایان<div style="font-size:12px;color:var(--muted);font-weight:400;">(شامل رده می‌شود)</div></div>
        <div style="width:48px;text-align:center;">حذف</div>
      </div>
      <div id="ranksRows" style="display:flex;flex-direction:column;gap:8px;">
        ${ranks.map((r, idx) => `
          <div class="rank-row" data-idx="${idx}" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <input class="input rank-name" data-idx="${idx}" data-field="name" value="${escapeHtml(r.name)}" style="flex:1 1 110px;min-width:56px;max-width:200px;" />
            <input class="input rank-min" data-idx="${idx}" data-field="minAge" value="${r.minAgeYears}" style="width:72px;text-align:center;flex:0 0 auto;" />
            <input class="input rank-max" data-idx="${idx}" data-field="maxAge" value="${r.maxAgeYears}" style="width:72px;text-align:center;flex:0 0 auto;" />
            <button class="btn small danger delete-rank" data-idx="${idx}" title="حذف">×</button>
          </div>
        `).join('')}
      </div>
      <div class="controls-row" style="margin-top:8px;">
        <div class="buttons">
          <button id="addRankBtn" class="btn">افزودن</button>
          <button id="resetRanksBtn" class="btn danger">ریست</button>
          <button id="saveRanksBtn" class="btn primary">ذخیره</button>
        </div>
      </div>
    </div>
  `;

  // removed Cancel button per UX request; navigation handled by header/back
  // delete handler
  content.querySelectorAll('.delete-rank').forEach(btn => btn.addEventListener('click', (e) => {
    const idx = Number(btn.dataset.idx);
    if (!confirm('آیا از حذف این رده مطمئن هستید؟')) return;
    state.settings.ranks.splice(idx, 1);
    saveState();
    renderRankEditor();
  }));

  on('#addRankBtn', 'click', () => {
    const id = 'r' + Math.floor(Math.random()*100000);
    state.settings.ranks.push({ id, name: 'رده جدید', minAgeYears: 0, maxAgeYears: 0 });
    saveState(); renderRankEditor();
  });

  on('#resetRanksBtn', 'click', () => {
    if (!confirm('بازنشانی رده‌ها به پیش‌فرض انجام شود؟')) return;
    state.settings.ranks = defaultRanks.slice();
    state.settings.ranksReferenceDate = state.settings.lastCategoryUpdate || todayJalali();
    // apply defaults to existing players by recalculating categories
    state.players.forEach(p => { if (p.birthdate) p.category = determineCategory(calcExactAge(p.birthdate)); });
    saveState(); renderRankEditor(); refreshCategorySelects(); showToast('رده‌ها به پیش‌فرض بازنشانی شدند');
  });

  on('#saveRanksBtn', 'click', () => {
    const rows = Array.from(qsa('#ranksRows .rank-row'));
    const newRanks = rows.map((row, idx) => {
      const name = qs('.rank-name', row).value || ('رده ' + (idx+1));
      const minA = parseInt(qs('.rank-min', row).value) || 0;
      const maxA = parseInt(qs('.rank-max', row).value) || 200;
      return { id: state.settings.ranks[idx]?.id || ('r'+idx), name, minAgeYears: minA, maxAgeYears: maxA };
    });
    state.settings.ranks = newRanks;
    const ref = qs('#ranksRefDate').value || todayJalali();
    state.settings.ranksReferenceDate = ref;
    if (state.settings.ranksRefMode === 'manual') {
      state.settings.lastCategoryUpdate = `ویرایش دستی ${ref}`;
    } else {
      state.settings.lastCategoryUpdate = `خودکار ${ref}`;
    }
    // apply ranks to all players (recompute their categories)
    state.players.forEach(p => { if (p.birthdate) p.category = determineCategory(calcExactAge(p.birthdate)); });
    saveState();
    refreshCategorySelects();
    // show a clear saved confirmation and navigate back shortly after
    showToast('ذخیره شد');
    setTimeout(()=> showView('settings'), 700);
  });

  // header back button routing to settings (if present in header)
  try { on('#backRankEditor', 'click', () => { showView('settings'); }); } catch(e) {}

  // handle auto/manual mode switching and status color
  const statusEl = qs('#ranksRefStatus');
  function updateRefModeUI(){
    const mode = state.settings.ranksRefMode || 'auto';
    const ref = state.settings.ranksReferenceDate || todayJalali();
    if (mode === 'auto'){
      // Auto mode: compute next upcoming cutoff = yyyy/10/11 based on today's jalali year
      const today = todayJalali();
      const todayParts = today.split('/').map(Number);
      const cutoffThisYear = `${todayParts[0]}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
      const cutoffNextYear = `${todayParts[0]+1}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
      const chosen = (jalaliToISO(today) <= jalaliToISO(cutoffThisYear)) ? cutoffThisYear : cutoffNextYear;
      const refInput = qs('#ranksRefDate');
      if (refInput) refInput.value = chosen;
      // if stored ref is older than chosen, update and re-evaluate
      if (!state.settings.ranksReferenceDate || jalaliToISO(state.settings.ranksReferenceDate) < jalaliToISO(chosen)){
        state.settings.ranksReferenceDate = chosen;
        state.settings.lastCategoryUpdate = `خودکار ${chosen}`;
        state.players.forEach(p => { if (p.birthdate) p.category = determineCategory(Object.assign(calcExactAge(p.birthdate), { birthdate: p.birthdate })); });
        saveState();
        showToast(`مرجع رده‌ها به‌صورت خودکار به ${chosen} بروزرسانی شد`);
      }
      statusEl.textContent = 'خودکار';
      statusEl.style.background = '#e6ffed';
      statusEl.style.color = '#137333';
    } else {
      // manual mode: show stored manual date in the input
      const refInput = qs('#ranksRefDate');
      if (refInput) refInput.value = state.settings.ranksReferenceDate || todayJalali();
      statusEl.textContent = 'دستی';
      statusEl.style.background = '#fff7e6';
      statusEl.style.color = '#92400e';
    }
    // enable/disable ref input depending on mode; color text green/yellow
    const refInput = qs('#ranksRefDate');
    if (refInput) {
      refInput.disabled = (mode !== 'manual');
      refInput.style.color = (mode === 'auto') ? '#137333' : '#92400e';
      refInput.style.fontWeight = (mode === 'auto') ? '700' : '600';
    }
  }
  // radio change handlers
  qsa('input[name="ranksRefMode"]').forEach(r => r.addEventListener('change', (e)=>{
    const newMode = e.target.value;
    state.settings.ranksRefMode = newMode;
    if (newMode === 'auto'){
      // compute nearest cutoff yyyy/10/11 based on today's jalali year
      const today = todayJalali();
      const parts = today.split('/').map(Number);
      const cutoffThisYear = `${parts[0]}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
      const cutoffNextYear = `${parts[0]+1}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
      const chosen = (jalaliToISO(today) <= jalaliToISO(cutoffThisYear)) ? cutoffThisYear : cutoffNextYear;
      state.settings.ranksReferenceDate = chosen;
      state.settings.lastCategoryUpdate = `خودکار ${chosen}`;
      // re-evaluate player categories immediately for the chosen cutoff
      state.players.forEach(p => { if (p.birthdate) p.category = determineCategory(Object.assign(calcExactAge(p.birthdate), { birthdate: p.birthdate })); });
    } else {
      // manual: preserve existing manual date if present, otherwise default to last update or today
      if (!state.settings.ranksReferenceDate) state.settings.ranksReferenceDate = state.settings.lastCategoryUpdate || todayJalali();
    }
    saveState(); updateRefModeUI();
  }));
  // when manual, allow editing ref input; when auto, disable manual editing
  qs('#ranksRefDate').addEventListener('input', (e)=>{
    if (state.settings.ranksRefMode === 'manual') {
      state.settings.ranksReferenceDate = e.target.value;
      saveState();
    }
  });
  // ensure jalali calendar hooks are attached for the ref input
  try{ attachJalaliInputs(content); } catch(e){}
  // initial UI update
  try{ updateRefModeUI(); } catch(e){}
}
function showView(viewId, params = {}, noPush = false) {
  qsa('#view-root > section').forEach(s => s.classList.add('hide'));
  qs(`#view-${viewId}`).classList.remove('hide');
  
  if (viewId === 'home') {
    qs('#appHeader').style.display = 'flex';
    renderHome();
  } else {
    qs('#appHeader').style.display = 'none';
  }
  if (viewId === 'players') renderPlayersPage();
  if (viewId === 'coaches') renderCoaches();
  if (viewId === 'sessions') renderSessionsPage();
  if (viewId === 'payments') renderPaymentsPage();
  if (viewId === 'insurance') renderInsurancePage();
  if (viewId === 'health') renderHealthPage();
  if (viewId === 'player-form') renderPlayerForm(params.player);
  if (viewId === 'coach-form') renderCoachForm(params.coach);
  if (viewId === 'session-attendance') renderSessionAttendance(params.sessionId);
  if (viewId === 'note') renderNote(params.playerId, params.currentNote, params.callback, params.sessionId, params.tempAttendances);
  if (viewId === 'player-profile') renderPlayerProfile(params.playerId);
  // If caller requests the share overlay to open when showing profile, do so after render
  try {
    if (viewId === 'player-profile' && params && params.openShare) {
      // delay slightly to allow renderPlayerProfile to finish DOM updates
      setTimeout(() => {
        try { openPlayerShareOverlay(params.playerId); } catch (e) { console.error('auto-openPlayerShareOverlay failed', e); }
      }, 80);
    }
  } catch (e) { console.warn('showView openShare param handling failed', e); }
  if (viewId === 'membership') renderMembershipCard(params.playerId);
  if (viewId === 'competitions') renderCompetitionsPage();
  if (viewId === 'all-sessions') renderAllSessions(params.playerId);
  if (viewId === 'all-payments') renderAllPayments(params.playerId);
  if (viewId === 'debtors') renderDebtors();
  if (viewId === 'payment-report') renderPaymentReport();
  if (viewId === 'players-export') renderPlayersExport();
  if (viewId === 'rank-editor') {
    if (typeof renderRankEditor === 'function') {
      try { renderRankEditor(); } catch (e) { console.error('renderRankEditor threw', e); }
    } else {
      console.warn('renderRankEditor not available yet — retrying shortly');
      // Retry once after a short delay in case the function is defined later in the script
      setTimeout(() => {
        if (typeof renderRankEditor === 'function') {
          try { renderRankEditor(); } catch (e) { console.error('renderRankEditor threw on retry', e); }
        } else {
          console.error('renderRankEditor still not defined — opening Settings instead');
          showView('settings');
        }
      }, 120);
    }
  }
  if (viewId === 'event-form') renderEventForm(params.playerId, params.eventIndex);
  if (viewId === 'settings') renderSettings();
  if (viewId === 'edit-payment') renderEditPayment(params.pay);
  // اضافه کردن شرط برای ویو تبریک تولد
  if (viewId === 'birthday-greeting') renderBirthdayGreeting(params.playerId);

  // کنترل منوی پایین
  const mobileMenu = qs('#mobileMenu');
  if (['home', 'account'].includes(viewId)) {
    mobileMenu.classList.remove('hide');
    console.log('Showing mobileMenu for viewId:', viewId); // دیباگ
  } else {
    mobileMenu.classList.add('hide');
    console.log('Hiding mobileMenu for viewId:', viewId); // دیباگ
  }
  if (!mobileMenu) {
    console.error('Error: #mobileMenu not found in DOM');
    return; // خروج از تابع اگر منو پیدا نشد
  }
  console.log('viewId received:', viewId, typeof viewId);
  window.scrollTo(0, 0); // اسکرول به بالا
  if (!noPush) history.pushState({ view: viewId, params }, '', `#${viewId}`);
}
function applySettings() {
  qs('#appTitle').textContent = state.settings.title;
  qs('#appLogo').src = state.settings.logo || 'icons/logo.png';
  document.body.dataset.style = state.settings.style;
}


/* simple calculateAge helper (commented out - use calcExactAge instead)
function calculateAge(birthdate) {
  if (!birthdate) return 'نامشخص';
  const [bYear, bMonth, bDay] = birthdate.split('/').map(Number);
  const [tYear, tMonth, tDay] = todayJalali().split('/').map(Number);
  let age = tYear - bYear;
  if (tMonth < bMonth || (tMonth === bMonth && tDay < bDay)) age--;
  return age + ' سال';
}
*/

function renderHome() {
  applySettings();
  // آخرین بازیکنان
  let playersPreview = qs('#playersPreview');
  playersPreview.innerHTML = '';
  // ensure container is a no-wrap horizontal scroller and will show up to 4 items' width
  playersPreview.style.display = 'flex';
  playersPreview.style.flexWrap = 'nowrap';
  playersPreview.style.overflowX = 'auto';
  playersPreview.style.gap = '12px';
  // render newest players: show only the 4 most-recent items and let the rest be scrollable
  state.players
    .slice()
    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
    .slice(0, 4)
    .forEach(p => {
      let row = document.createElement('div');
      row.className = 'player-row';
  // rely on CSS for responsive sizing/scroll-snap; keep only semantic class
  // (removed inline flex sizing so media queries can control item width)
      row.innerHTML = `
        <div class="player-thumb">${p.photo ? `<img src="${p.photo}" alt="${escapeHtml(p.name)}">` : '<svg width="36" height="36" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>'}</div>
        <div class="meta"><strong>${escapeHtml(p.name)}</strong><small class="muted">${p.category || ''}</small></div>
      `;
      row.addEventListener('click', () => showView('player-profile', {playerId: p.id}));
      playersPreview.appendChild(row);
    });
    // ensure preview is touch-scrollable and compact on small screens
    try { enableHorizontalSwipeLock(); } catch (e) {}
  // enable swipe lock for better touch behavior
  try { enableHorizontalSwipeLock(); } catch (e) {}
  
    
  // رندر باکس تولد: اگر امروز کسی تولد نداشت، عنوان را به "تولدهای پیش رو" تغییر بده
  let birthdaysToday = document.querySelector('#birthdaysToday');
  birthdaysToday.innerHTML = '';
  let titleEl = document.querySelector('.birthday-card .section-title h3');
  let todayPlayers = getBirthdaysToday(); // players whose birthday is today
  let noBirthdaysMsg = document.querySelector('#noBirthdaysMsg');
  if (todayPlayers.length === 0) {
    // عنوان را به تولدهای پیش رو تغییر می‌دهیم
    if (titleEl) titleEl.textContent = 'تولدهای پیش رو';
    noBirthdaysMsg.style.display = 'none';
    // show up to 4 upcoming birthdays and make the box scrollable if there are more
    let upcoming = getUpcomingBirthdays(8).slice(0, 4);
    upcoming.forEach(p => {
      let dist = daysUntilBirthday(p.birthdate);
      let row = document.createElement('div');
      row.className = 'player-row upcoming-birthday';
      row.innerHTML = `
        <div class="player-thumb">${p.photo ? `<img src="${p.photo}" alt="${escapeHtml(p.name)}">` : '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>'}</div>
        <div class="meta"><strong>${escapeHtml(p.name)}</strong><small>${dist} روز مانده</small></div>
      `;
      row.addEventListener('click', () => openBirthdayModal(p.id));
      // add blue overlay layer to indicate upcoming
      let thumb = row.querySelector('.player-thumb');
      let overlay = document.createElement('div');
      overlay.className = 'birthday-overlay';
      overlay.title = 'به زودی تولد';
      thumb.style.position = 'relative';
      thumb.appendChild(overlay);
      birthdaysToday.appendChild(row);
    });
    birthdaysToday.style.overflowX = 'auto';
    try { enableHorizontalSwipeLock(); } catch (e) {}
  } else {
    if (titleEl) titleEl.textContent = 'متولدین امروز';
    noBirthdaysMsg.style.display = 'none';
    // show up to 4 birthdays today; display how many years they turned
    todayPlayers.slice(0,4).forEach(p => {
      let age = { years: '—' };
      try { age = calcExactAge(p.birthdate); } catch(e) {}
      let ageText = age && typeof age.years === 'number' ? `${age.years} ساله شد` : (p.category || '');
      let row = document.createElement('div');
      row.className = 'player-row';
      row.innerHTML = `
        <div class="player-thumb">${p.photo ? `<img src="${p.photo}" alt="${escapeHtml(p.name)}">` : '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>'}</div>
        <div class="meta"><strong>${escapeHtml(p.name)}</strong><small>${ageText}</small></div>
      `;
      row.addEventListener('click', () => openBirthdayModal(p.id));
      birthdaysToday.appendChild(row);
    });
    if (todayPlayers.length > 4) {
      birthdaysToday.style.overflowX = 'auto';
      try { enableHorizontalSwipeLock(); } catch (e) {}
    } else {
      birthdaysToday.style.overflowX = '';
    }
  }
  
  
  // آخرین جلسات
  let sessionsPreview = qs('#sessionsPreview');
  sessionsPreview.innerHTML = '';
    state.sessions.slice(0, 3).forEach(s => {
    let attCount = Object.values(s.attendances || {}).filter(a => a.present).length;
    let row = document.createElement('div');
    row.className = 'player-row';
    // compact layout: put attendee badge at the right side and date/category to its left
    row.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;width:100%">
        <div class="meta" style="flex:1;min-width:0"><strong>${escapeHtml(s.title || 'جلسه')}</strong><small style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${isoToJalali(s.date)} • ${s.category || '—'}</small></div>
        <div style="margin-right:12px;flex:0 0 auto"><div class="badge">${attCount} حاضر</div></div>
      </div>
    `;
    row.addEventListener('click', () => showView('session-attendance', {sessionId: s.id}));
    sessionsPreview.appendChild(row);
  });

  // باکس تمرینات برنامه‌ریزی‌شده (زیر آخرین جلسات)
  let trainingPreviewBox = qs('#trainingPreview');
  if (trainingPreviewBox) {
    trainingPreviewBox.innerHTML = '';
  // header contains add button in DOM; no dynamic insertion here

    // compute upcoming plans (date >= today), sort by date ascending, take up to 3 nearest
    let now = new Date();
    let upcoming = (state.trainingPlans || []).slice().filter(pl => {
      if (!pl.date) return false;
      let iso = jalaliToISO(pl.date);
      let d = new Date(iso);
      return d >= now;
    }).sort((a,b) => new Date(jalaliToISO(a.date)) - new Date(jalaliToISO(b.date))).slice(0,3);

    if (upcoming.length === 0) {
      let empty = document.createElement('div'); empty.className = 'muted'; empty.textContent = 'هیچ برنامهٔ تمرینی برنامه‌ریزی نشده';
      trainingPreviewBox.appendChild(empty);
    } else {
      upcoming.forEach(pl => {
        let node = document.createElement('div');
        node.className = 'player-row';
        // show a short inline excerpt and a 'بیشتر' toggle to view full text inline
        let excerpt = pl.body ? (pl.body.length > 80 ? pl.body.slice(0,80) + '…' : pl.body) : '';
        node.innerHTML = `
          <div class="meta"><strong>${escapeHtml(pl.title)}</strong><small>${pl.date || ''} ${pl.time ? '• ' + pl.time : ''}</small></div>
          <div class="muted plan-excerpt">${escapeHtml(excerpt)}</div>
          <button class="btn tiny show-full-plan" style="margin-top:6px;">بیشتر</button>
        `;
        // toggle inline expansion to full body
        node.querySelector('.show-full-plan').addEventListener('click', (e) => {
          e.stopPropagation();
          let ex = node.querySelector('.plan-excerpt');
          if (!ex) return;
          if (ex.dataset.full === '1') {
            // currently full, collapse back to excerpt
            ex.textContent = pl.body && pl.body.length > 80 ? pl.body.slice(0,80) + '…' : (pl.body || '');
            ex.dataset.full = '0';
            e.target.textContent = 'بیشتر';
          } else {
            ex.textContent = pl.body || '';
            ex.dataset.full = '1';
            e.target.textContent = 'بستن';
          }
        });
        // clicking the row still opens modal as before for full view
        node.addEventListener('click', () => {
          try {
            let modal = qs('#planModal');
            if (!modal) return;
            qs('#planModalTitle').textContent = pl.title || '';
            qs('#planModalDate').textContent = pl.date || '';
            qs('#planModalBody').textContent = pl.body || '';
            modal.style.display = 'flex';
          } catch(e) {}
        });
        trainingPreviewBox.appendChild(node);
      });
    }
  }

  // آخرین پرداخت‌ها
  let paymentsPreview = qs('#paymentsPreview');
  paymentsPreview.innerHTML = '';
  state.payments.slice(0, 3).forEach(pay => {
    let player = state.players.find(p => p.id === pay.playerId);
    let row = document.createElement('div');
    row.className = 'player-row';
    // show payment type before the amount
    row.innerHTML = `
      <div class="meta"><strong>${player ? escapeHtml(player.name) : '—'}</strong><small>${isoToJalali(pay.date)} • ${pay.type || '—'} • ${Number(pay.amount).toLocaleString()} تومان</small></div>
    `;
    paymentsPreview.appendChild(row);
  });

  // بیمه‌های منقضی
  let expired = qs('#expiredInsurances');
  expired.innerHTML = '';
  state.players.filter(p => isInsuranceExpired(p.insuranceDate)).slice(0, 3).forEach(p => {
    let row = document.createElement('div');
    row.className = 'player-row';
    row.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;width:100%">
        <div class="meta" style="flex:1;min-width:0"><strong>${escapeHtml(p.name)}</strong><small style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.insuranceDate || '—'}</small></div>
        <div style="margin-right:12px;flex:0 0 auto"><div class="badge danger" style="padding:6px 8px;font-size:12px;">منقضی</div></div>
      </div>
    `;
    expired.appendChild(row);
  });

  // آمار کلی
  let stats = qs('#statsContainer');
  stats.innerHTML = '';
  let totalPlayers = state.players.length;
  let totalSessions = state.sessions.length;
  // per-category counts
  const counts = state.players.reduce((acc, p) => {
    const c = p.category || 'نامشخص';
    acc[c] = (acc[c] || 0) + 1;
    return acc;
  }, {});
  // percent of players who have any payment recorded
  const paidPlayers = new Set(state.payments.map(pay => pay.playerId));
  const percentPaid = totalPlayers ? Math.round((paidPlayers.size / totalPlayers) * 100) : 0;
  // compute current and previous payment sums based on paymentMonth/paymentYear fields
  const nowJ = todayJalali().split('/').map(Number); // [YYYY,MM,DD]
  const currentYear = String(nowJ[0]);
  const currentMonth = String(nowJ[1]).padStart(2, '0');
  // previous month handling
  let prevMonth = nowJ[1] - 1;
  let prevYear = nowJ[0];
  if (prevMonth < 1) { prevMonth = 12; prevYear -= 1; }
  const prevMonthStr = String(prevMonth).padStart(2, '0');
  const prevYearStr = String(prevYear);
  // normalize paymentMonth which may be stored as numeric string or Persian month name
  const normalizePaymentMonth = (pm) => {
    if (!pm && pm !== 0) return '';
    // try numeric
    const n = Number(pm);
    if (!isNaN(n) && n > 0) return String(n).padStart(2, '0');
    // fallback: treat as month name
    try {
      const mNum = monthNameToNumber(pm);
      return String(mNum).padStart(2, '0');
    } catch (e) {
      return '';
    }
  };

  const currentSum = state.payments.filter(pay => normalizePaymentMonth(pay.paymentMonth) === currentMonth && String(pay.paymentYear) === currentYear).reduce((acc,p)=>acc+Number(p.amount),0);
  const prevSum = state.payments.filter(pay => normalizePaymentMonth(pay.paymentMonth) === prevMonthStr && String(pay.paymentYear) === prevYearStr).reduce((acc,p)=>acc+Number(p.amount),0);
  // build categories list (rows)
  // prefer a sensible order for common categories, but also include any custom categories
  const preferred = ['مینی','نونهال','نوجوان','جوانان','زیر 20 سال','امید','بزرگسال','بازیکنان'];
  const allCats = Object.keys(counts).filter(Boolean);
  // ensure we include all categories: start with preferred that exist, then append any remaining dynamic categories
  const ordered = [];
  preferred.forEach(c => { if (allCats.includes(c) && !ordered.includes(c)) ordered.push(c); });
  allCats.sort().forEach(c => { if (!ordered.includes(c)) ordered.push(c); });
  // if no categories found, show preferred defaults with zero
  if (ordered.length === 0) ordered.push(...preferred);
  let categoriesHtml = '<div class="players-by-category">';
  ordered.forEach(name => {
    const num = counts[name] || 0;
    categoriesHtml += `<div class="category-row"><div class="category-name">${escapeHtml(name)}</div><div class="category-count">${num}</div></div>`;
  });
  categoriesHtml += '</div>';

  // construct the new stats layout: a big players card with all detected categories
  // then render the small stat cards as direct children of the .stats grid so
  // they appear in two columns below the full-width players card.
  stats.innerHTML = `
    <div class="players-stat-card card">
      <div class="section-title"><h3>تعداد بازیکنان</h3></div>
      <div style="font-size:28px;font-weight:700;margin:8px 0;">${totalPlayers}</div>
      ${categoriesHtml}
    </div>
    <div class="stat-card card"><div class="section-title"><h3>تعداد جلسات</h3></div><div><strong>${totalSessions}</strong></div></div>
    <div class="stat-card card"><div class="section-title"><h3>درصد پرداخت‌شده</h3></div><div><strong>${percentPaid}%</strong></div></div>
    <div class="stat-card card"><div class="section-title"><h3>درآمد دوره جاری</h3></div><div><strong>${(currentSum).toLocaleString()}</strong></div></div>
    <div class="stat-card card"><div class="section-title"><h3>درآمد دوره قبل</h3></div><div><strong>${(prevSum).toLocaleString()}</strong></div></div>
  `;
}

function renderBirthdayGreeting(playerId) {
  let content = qs('#birthdayGreetingContent');
  let p = state.players.find(x => x.id === playerId); // فرض: state.players آرایه بازیکن‌هاست
  if (!p) return showView('home'); // اگه بازیکن پیدا نشد، برگرد به خانه

  let age = calcExactAge(p.birthdate);
  let greetingMsg = `تولدت مبارک ${p.name}! حالا ${age.years} ساله شدی. امیدوارم سالی پر از موفقیت در والیبال داشته باشی! 🎉`;

  content.innerHTML = `
    <div style="padding: 16px; background: linear-gradient(135deg, #FF6B6B, #FFD700); border-radius: 16px; color: #fff; animation: pulse 1.5s infinite;">
      <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; margin: 0 auto;">
        ${p.photo ? `<img src="${p.photo}" style="width: 100%; height: 100%; object-fit: cover;" alt="${p.name}">` : '<div>بدون عکس</div>'}
      </div>
      <h2 style="margin-top: 12px;">${greetingMsg}</h2>
      <div class="form-actions" style="margin-top: 16px;">
        <button id="shareBirthday" class="btn primary">اشتراک‌گذاری</button>
        <button id="closeBirthday" class="btn">بستن</button>
      </div>
    </div>
  `;

  on('#closeBirthday', 'click', () => showView('home'));
  on('#backBirthdayGreeting', 'click', () => { if (!goBack()) showView('home'); });
  on('#shareBirthday', 'click', () => {
    html2canvas(content).then(canvas => {
      let imgData = canvas.toDataURL('image/png');
      if (navigator.share) {
        fetch(imgData).then(res => res.blob()).then(blob => {
          navigator.share({
            files: [new File([blob], 'birthday.png', { type: 'image/png' })],
            title: 'تبریک تولد',
            text: greetingMsg
          });
        });
      } else {
        let a = document.createElement('a');
        a.href = imgData;
        a.download = 'birthday.png';
        a.click();
      }
    });
  });
}

function populateCategoryFilter(select) {
  let categories = [...new Set(state.players.map(p => p.category))].filter(Boolean);
  select.innerHTML = '<option value="">همه رده‌ها</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
}

function populateCategoriesFromRanks(select, firstOptionText = 'انتخاب رده', selected = ''){
  if (!select) return;
  const ranks = (state.settings && state.settings.ranks && state.settings.ranks.length) ? state.settings.ranks : defaultRanks;
  let opts = ranks.map(r => `<option value="${escapeHtml(r.name)}" ${selected === r.name ? 'selected' : ''}>${escapeHtml(r.name)}</option>`).join('');
  opts += `<option value="نامشخص" ${selected === 'نامشخص' ? 'selected' : ''}>نامشخص</option>`;
  select.innerHTML = `<option value="">${firstOptionText}</option>` + opts;
}

function refreshCategorySelects(){
  // try to update common selects if they exist in DOM
  populateCategoriesFromRanks(qs('#p_category'), 'انتخاب رده');
  populateCategoriesFromRanks(qs('#sessionCategory'), 'همه رده‌ها');
  populateCategoriesFromRanks(qs('#filterCategory'), 'همه رده‌ها');
  populateCategoriesFromRanks(qs('#reportCategory'), 'همه رده‌ها');
  populateCategoriesFromRanks(qs('#exportCategory'), 'همه رده‌ها');
  populateCategoriesFromRanks(qs('#insuranceCategoryFilter'), 'همه رده‌ها');
}

function populateCoachSelect(select) {
  select.innerHTML = '<option value="">بدون مربی</option>' + state.coaches.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
}

function populatePaymentMonthYear(monthId = 'paymentMonth', yearId = 'paymentYear') {
  let monthSelect = qs('#' + monthId);
  let months = ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'];
  monthSelect.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');
  let yearSelect = qs('#' + yearId);
  let currentYear = parseInt(todayJalali().split('/')[0]);
  yearSelect.innerHTML = '';
  for (let y = currentYear - 2; y <= currentYear + 10; y++) {
    let opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    if (y === currentYear) opt.selected = true;
    yearSelect.appendChild(opt);
  }
}

function populatePaymentPlayerSelect(search = '') {
  let select = qs('#paymentPlayer');
  let q = normPersian(search);
  let filtered = state.players.filter(p => normPersian(p.name).includes(q));
  select.innerHTML = '<option value="">انتخاب بازیکن</option>' + filtered.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
}

function renderPlayersPage() {
  let list = qs('#playersList');
  list.innerHTML = '';
  let q = normPersian(qs('#playersSearch').value || '');
  let cat = qs('#filterCategory').value;
  let ins = qs('#filterInsurance').value;
  // BMI filter (single select)
  let bmiSelected = qs('#filterBmi') ? qs('#filterBmi').value : '';
  let sort = qs('#sortPlayers').value;
  let arr = state.players.slice();
  if (q) arr = arr.filter(p => normPersian(p.name).includes(q));
  if (cat) arr = arr.filter(p => p.category === cat);
  if (bmiSelected) {
    arr = arr.filter(p => {
      let bmiData = calculateBMI(p.height, p.weight);
      let status = bmiData ? bmiData.status : null;
      return status === bmiSelected;
    });
  }
  if (ins === 'expired') arr = arr.filter(p => isInsuranceExpired(p.insuranceDate));
  if (sort === 'new') arr.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  if (sort === 'score') arr.sort((a, b) => calcAverageScore(b) - calcAverageScore(a));
  if (sort === 'name') arr.sort((a, b) => a.name.localeCompare(b.name));
  arr.forEach(p => {
    console.debug('[renderPlayersPage] player', p.id, p.name, 'gender=', p.gender, 'photo=', p.photo);
    let node = document.createElement('div');
    node.className = 'player-row player-card';
    // determine placeholder based on gender
    let placeholder = p.gender === 'female' ? './icons/volleyball-player (3).png' : './icons/volleyball-player (4).png';
    let imgSrc = p.photo || placeholder;
    let avgScore = calcAverageScore(p);
    const ageObj = p.birthdate ? (() => { try { return calcExactAge(p.birthdate); } catch(e){ return null; } })() : null;
    const ageText = ageObj && ageObj.years ? (ageObj.years + ' سال') : '—';
    // If a BMI filter is active, show health summary instead of action buttons
    if (bmiSelected) {
      const bmiData = calculateBMI(p.height, p.weight) || {bmi: '—', status: '—', color: '#cbd5e1', percent: 0};
      node.innerHTML = `
      <div style="display:flex;gap:12px;align-items:stretch;justify-content:space-between;padding:10px;">
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;min-width:0;flex:1;">
          <div class="player-thumb list-thumb">
            <img src="${imgSrc}" />
          </div>
          <div class="player-info-block" style="text-align:center;">
            <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(p.name)}</div>
            <div style="font-size:13px;color:var(--muted);">${p.category || '—'} • ${ageText}</div>
          </div>
        </div>
        <div class="action-buttons" style="display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;flex:0 0 200px;">
          <div style="text-align:center;font-weight:700;">وضعیت سلامت</div>
          <div style="font-size:13px;color:var(--muted);">قد: ${p.height || '—'} cm</div>
          <div style="font-size:13px;color:var(--muted);">وزن: ${p.weight || '—'} kg</div>
          <div style="font-size:13px;color:var(--muted);">BMI: ${bmiData.bmi}</div>
          <div style="font-size:13px;color:var(--muted);">${bmiData.status}</div>
          <div style="width:90%;height:8px;background:#eef2ff;border-radius:6px;overflow:hidden;margin-top:6px;">
            <div style="width:${bmiData.percent}%;height:100%;background:${bmiData.color};border-radius:6px;"></div>
          </div>
        </div>
      </div>
      `;
    } else {
      node.innerHTML = `
      <div style="display:flex;gap:12px;align-items:stretch;justify-content:space-between;padding:10px;">
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;min-width:0;flex:1;">
          <div class="player-thumb list-thumb">
            <img src="${imgSrc}" />
          </div>
          <div class="player-info-block" style="text-align:center;">
            <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(p.name)}</div>
            <div style="font-size:13px;color:var(--muted);">${p.category || '—'} • امتیاز: ${avgScore} • ${ageText}</div>
          </div>
        </div>
        <div class="action-buttons" style="display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;flex:0 0 200px;">
          <button class="btn small profile-btn" style="min-width:140px;">پروفایل</button>
          <button class="btn small pay-btn" style="min-width:140px;">پرداخت</button>
          <button class="btn small edit-btn" style="min-width:140px;">ویرایش</button>
          <button class="btn small danger del-btn" style="min-width:140px;">حذف</button>
        </div>
      </div>
      `;
    }
    const profileBtn = node.querySelector('.profile-btn');
    const payBtn = node.querySelector('.pay-btn');
    const editBtn = node.querySelector('.edit-btn');
    const delBtn = node.querySelector('.del-btn');
    // thumbnail click should open profile in all modes
    const thumb = node.querySelector('.player-thumb');
    if (thumb) thumb.addEventListener('click', () => showView('player-profile', {playerId: p.id}));
    if (profileBtn) profileBtn.addEventListener('click', () => showView('player-profile', {playerId: p.id}));
    if (payBtn) payBtn.addEventListener('click', () => openPaymentModal(p.id));
    if (editBtn) editBtn.addEventListener('click', () => showView('player-form', {player: p}));
    if (delBtn) delBtn.addEventListener('click', () => {
      if (confirm('حذف شود؟')) {
        state.players = state.players.filter(x => x.id !== p.id);
        state.sessions.forEach(s => { if (s.attendances) delete s.attendances[p.id]; });
        state.payments = state.payments.filter(x => x.playerId !== p.id);
        saveState();
        renderPlayersPage();
        renderHome();
      }
    });
    list.appendChild(node);
  });
  populateCategoryFilter(qs('#filterCategory'));
}

// Add a touch-direction handler so horizontal swipes inside .players-preview
// prevent the page from vertically scrolling on browsers/webviews that ignore
// touch-action CSS. This is a small, conservative handler that only calls
// preventDefault when the gesture is clearly horizontal.
function enableHorizontalSwipeLock() {
  let containers = document.querySelectorAll('.players-preview');
  containers.forEach(container => {
    let startX = 0, startY = 0, locked = false;
    const threshold = 5; // px before we consider it a move
    function onStart(e) {
      if (!e.touches || e.touches.length !== 1) return;
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      locked = false;
    }
    function onMove(e) {
      if (!e.touches || e.touches.length !== 1) return;
      const dx = e.touches[0].clientX - startX;
      const dy = e.touches[0].clientY - startY;
      if (locked) {
        // we already determined it's horizontal
        e.preventDefault();
        return;
      }
      if (Math.abs(dx) > Math.abs(dy) + threshold) {
        locked = true;
        // prevent the page from scrolling vertically while user is
        // performing a horizontal pan inside the container
        e.preventDefault();
      }
    }
    function onEnd() { startX = startY = 0; locked = false; }
    container.addEventListener('touchstart', onStart, {passive: true});
    container.addEventListener('touchmove', onMove, {passive: false});
    container.addEventListener('touchend', onEnd, {passive: true});
    container.addEventListener('touchcancel', onEnd, {passive: true});
  });
}

function calcAverageScore(player) {
  let scores = Object.values(player.scores || {});
  return scores.length ? (scores.reduce((a, b) => a + Number(b), 0) / scores.length).toFixed(1) : 0;
}

function renderCoaches() {
  let list = qs('#coachesList');
  list.innerHTML = '';
  state.coaches.forEach(c => {
    let node = document.createElement('div');
    node.className = 'player-row';
    let imgHtml = c.photo ? `<img src="${c.photo}">` : `<svg width="36" height="36" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>`;
    node.innerHTML = `
      <div class="player-thumb">${imgHtml}</div>
      <div class="meta"><strong>${escapeHtml(c.name)}</strong><small>${c.title || '—'} • ${c.phone || '—'}</small></div>
      <button class="btn small edit-coach">ویرایش</button>
      <button class="btn small danger del-coach">حذف</button>
    `;
    node.querySelector('.edit-coach').addEventListener('click', () => showView('coach-form', {coach: c}));
    node.querySelector('.del-coach').addEventListener('click', () => {
      if (confirm('حذف شود؟')) {
        state.coaches = state.coaches.filter(x => x.id !== c.id);
        state.sessions.forEach(s => { if (s.coachId === c.id) s.coachId = null; });
        saveState();
        renderCoaches();
      }
    });
    list.appendChild(node);
  });
  populateCoachSelect(qs('#sessionCoach'));
}

function renderSessionsPage() {
  // render manage sessions tab
  let managePanel = qs('#tabManageSessionsPanel');
  let list = managePanel ? managePanel.querySelector('#sessionsList') : qs('#sessionsList');
  if (!list) return;
  list.innerHTML = '';
  state.sessions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(s => {
    let attCount = Object.values(s.attendances || {}).filter(a => a.present).length;
    let coach = state.coaches.find(c => c.id === s.coachId);
    let node = document.createElement('div');
    node.className = 'player-row';
    node.innerHTML = `
      <div class="meta"><strong>${escapeHtml(s.title || 'جلسه')}</strong><small>${isoToJalali(s.date)} • ${s.category || '—'} • مربی: ${coach ? escapeHtml(coach.name) : '—'}</small></div>
      <div style="display:flex;gap:8px;align-items:center;">
        <div class="badge">${attCount} حاضر</div>
        <button class="btn small att-btn">حضورغیاب</button>
        <button class="btn small danger del-sess">حذف</button>
      </div>
    `;
    node.querySelector('.att-btn').addEventListener('click', () => showView('session-attendance', {sessionId: s.id}));
    node.querySelector('.del-sess').addEventListener('click', () => {
      if (confirm('حذف شود؟')) {
        state.sessions = state.sessions.filter(x => x.id !== s.id);
        saveState();
        renderSessionsPage();
        renderHome();
      }
    });
    list.appendChild(node);
  });
  populateCategoryFilter(qs('#sessionCategory'));
  populateCoachSelect(qs('#sessionCoach'));

  // render training plan tab (upcoming sessions)
  let planPanel = qs('#tabTrainingPlanPanel');
  if (planPanel) {
    let planList = planPanel.querySelector('#trainingPlanList');
    planList.innerHTML = '';
    // upcoming sessions: date >= today
    let today = new Date();
    state.sessions
      .slice()
      .filter(s => new Date(s.date) >= today)
      .sort((a,b) => new Date(a.date) - new Date(b.date))
      .forEach(s => {
        let coach = state.coaches.find(c => c.id === s.coachId);
        let item = document.createElement('div');
        item.className = 'player-row';
        let reminderKey = `reminder_${s.id}`;
        let reminderOn = localStorage.getItem(reminderKey) === '1';
        item.innerHTML = `
          <div class="meta"><strong>${escapeHtml(s.title || 'جلسه')}</strong><small>${isoToJalali(s.date)} • ${s.category || '—'} • مربی: ${coach ? escapeHtml(coach.name) : '—'}</small></div>
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" class="reminder-toggle" data-id="${s.id}" ${reminderOn? 'checked' : ''} /> یادآوری
            </label>
            <button class="btn small" data-id="${s.id}">ویرایش برنامه</button>
          </div>
        `;
        planList.appendChild(item);
      });

      // render saved training plan notes inside the training tab
      let trainingNotes = planPanel.querySelector('#trainingPlanList');
      if (trainingNotes) {
        // prepend session-derived items are already there; now list explicit plans
        (state.trainingPlans || []).forEach(pl => {
          let plNode = document.createElement('div');
          plNode.className = 'player-row';
          plNode.id = `planItem-${pl.id}`;
          plNode.innerHTML = `
            <div class="meta"><strong>${escapeHtml(pl.title)}</strong><small>${pl.date || ''}</small></div>
            <div class="muted">${escapeHtml((pl.body||'').slice(0,120))}${(pl.body||'').length>120? '…' : ''}</div>
            <div style="margin-top:6px;display:flex;gap:8px;">
              <button class="btn small view-plan" data-id="${pl.id}">مشاهده</button>
              <button class="btn small edit-plan" data-id="${pl.id}">ویرایش</button>
              <button class="btn small danger del-plan" data-id="${pl.id}">حذف</button>
            </div>
            <div class="plan-full" style="display:none;margin-top:8px;border-top:1px dashed rgba(0,0,0,0.06);padding-top:8px;">${escapeHtml(pl.body || '')}</div>
          `;
          trainingNotes.appendChild(plNode);
        });

      // populate coach select inside the plan tab
      try { populateCoachSelect(planPanel.querySelector('#planCoach')); } catch(e) {}
      // populate hour select (00-23)
      try {
        let ph = planPanel.querySelector('#planHour');
        if (ph) {
          ph.innerHTML = Array.from({length:24}).map((_,i)=>{const v=('0'+i).slice(-2); return `<option value="${v}">${v}</option>`}).join('');
        }
      } catch(e) {}

      // attach view handlers
        // view/edit/delete handlers
  trainingNotes.querySelectorAll('.view-plan').forEach(b => b.addEventListener('click', (e) => {
          let id = e.currentTarget.dataset.id;
          let pl = (state.trainingPlans||[]).find(x => x.id === id);
          if (!pl) return;
          // open modal with full content
          let modal = qs('#planModal');
          if (!modal) return;
          qs('#planModalTitle').textContent = pl.title;
          qs('#planModalDate').textContent = pl.date || '';
          qs('#planModalBody').textContent = pl.body || '';
          modal.style.display = 'flex';
        }));
  trainingNotes.querySelectorAll('.del-plan').forEach(b => b.addEventListener('click', (e) => {
          let id = e.currentTarget.dataset.id;
          if (!confirm('حذف شود؟')) return;
          state.trainingPlans = (state.trainingPlans||[]).filter(x => x.id !== id);
          saveState();
          renderSessionsPage();
          showToast('یادداشت حذف شد');
        }));
  trainingNotes.querySelectorAll('.edit-plan').forEach(b => b.addEventListener('click', (e) => {
          let id = e.currentTarget.dataset.id;
          let pl = (state.trainingPlans||[]).find(x => x.id === id);
          if (!pl) return;
          console.debug('[plan] edit clicked, populate form with plan', id, pl && pl.title);
          // populate form in tab for editing (including time and coach)
          let root = planPanel || document;
          try { root.querySelector('#planTitle').value = pl.title; } catch(e) {}
          try { root.querySelector('#planDate').value = pl.date || ''; } catch(e) {}
          // populate hour/minute selects from stored time if present
          if (pl.time) {
            let parts = String(pl.time).split(':');
            try { root.querySelector('#planHour').value = parts[0].padStart(2,'0'); } catch(e) {}
            try { root.querySelector('#planMinute').value = (parts[1] || '00').padStart(2,'0'); } catch(e) {}
          } else {
            try { root.querySelector('#planHour').value = '09'; } catch(e) {}
            try { root.querySelector('#planMinute').value = '00'; } catch(e) {}
          }
          try { root.querySelector('#planBody').value = pl.body || ''; } catch(e) {}
          try { root.querySelector('#planCoach').value = pl.coachId || ''; } catch(e) {}
          try { root.querySelector('#planReminderMode').value = pl.reminder || 'none'; } catch(e) {}
          // set save button into edit mode
          let saveBtn = planPanel.querySelector('#savePlanBtn') || qs('#savePlanBtn');
          saveBtn.dataset.editId = pl.id;
          // switch to the training tab and focus the body textarea for quick edit
          qs('#tabTrainingPlan').click();
          setTimeout(() => {
            try {
              let el = planPanel.querySelector('#planBody') || qs('#planBody');
              if (el) {
                el.focus();
                el.setSelectionRange(el.value.length, el.value.length);
              }
            } catch(e) {}
          }, 200);
          showToast('حالا می‌توانید تغییرات را ذخیره کنید');
        }));
      }

    // attach reminder toggle handlers
    planPanel.querySelectorAll('.reminder-toggle').forEach(cb => {
      cb.addEventListener('change', (e) => {
        let id = e.currentTarget.dataset.id;
        let key = `reminder_${id}`;
        if (e.currentTarget.checked) {
          localStorage.setItem(key, '1');
          // optionally schedule Notification if permissions
          if (window.Notification && Notification.permission === 'granted') {
            Notification.requestPermission();
          }
        } else {
          localStorage.removeItem(key);
        }
      });
    });
  }

  // Close plan modal handler
  try {
    on('#closePlanModal', 'click', () => {
      let modal = qs('#planModal');
      if (modal) modal.style.display = 'none';
    });
  } catch(e) {}

  // tab switching handlers
  try {
    on('#tabManageSessions', 'click', () => {
      qs('#tabManageSessionsPanel').style.display = '';
      qs('#tabTrainingPlanPanel').style.display = 'none';
      qs('#tabManageSessions').style.borderBottom = '2px solid #6366f1';
      qs('#tabTrainingPlan').style.borderBottom = 'none';
    });
    on('#tabTrainingPlan', 'click', () => {
      qs('#tabManageSessionsPanel').style.display = 'none';
      qs('#tabTrainingPlanPanel').style.display = '';
      qs('#tabTrainingPlan').style.borderBottom = '2px solid #6366f1';
      qs('#tabManageSessions').style.borderBottom = 'none';
    });
  } catch (e) { console.error(e); }
}

// handlers for training plan creation saved in state.trainingPlans
try {
  on('#savePlanBtn', 'click', () => {
  // scope all plan inputs to the training tab panel to avoid duplicate-id conflicts
  let planRoot = qs('#tabTrainingPlanPanel') || document;
  let title = planRoot.querySelector('#planTitle')?.value?.trim();
  let date = planRoot.querySelector('#planDate')?.value?.trim();
  let hour = (planRoot.querySelector('#planHour') && planRoot.querySelector('#planHour').value) ? planRoot.querySelector('#planHour').value : '09';
  let minute = (planRoot.querySelector('#planMinute') && planRoot.querySelector('#planMinute').value) ? planRoot.querySelector('#planMinute').value : '00';
  let time = `${hour}:${minute}`;
  let coachId = planRoot.querySelector('#planCoach')?.value || '';
  let body = planRoot.querySelector('#planBody')?.value?.trim();
  let reminderMode = planRoot.querySelector('#planReminderMode')?.value || 'none';
    if (!title) return showToast('عنوان تمرین را وارد کنید');
    state.trainingPlans = state.trainingPlans || [];
    let editId = qs('#savePlanBtn').dataset.editId;
    if (editId) {
      // update existing
      let idx = state.trainingPlans.findIndex(x => x.id === editId);
      if (idx > -1) {
        state.trainingPlans[idx] = { ...state.trainingPlans[idx], title, date, time, coachId, body, reminder: reminderMode, updatedAt: new Date().toISOString() };
      }
      try { delete qs('#savePlanBtn').dataset.editId; } catch(e) {}
    } else {
      let plan = { id: uid('tp'), title, date, time, coachId, body, reminder: reminderMode, createdAt: new Date().toISOString() };
      state.trainingPlans.unshift(plan);
    }
    saveState();
    renderSessionsPage();
    // immediate defensive clear (run synchronously) to remove any lingering values
    try {
      const names = ['planTitle','planDate','planHour','planMinute','planCoach','planBody','planReminderMode'];
      names.forEach(name => {
        try {
          const nodes = document.querySelectorAll('#' + name);
          nodes.forEach(el => {
            if (!el) return;
            const tag = (el.tagName || '').toUpperCase();
            if (tag === 'SELECT') {
              if (name === 'planHour' || name === 'planMinute') el.value = '00';
              else if (name === 'planReminderMode') el.value = 'none';
              else el.selectedIndex = 0;
            } else if (tag === 'INPUT' || tag === 'TEXTAREA') {
              if (name === 'planHour' || name === 'planMinute') el.value = '00';
              else if (name === 'planReminderMode') el.value = 'none';
              else el.value = '';
            } else {
              try { el.textContent = ''; } catch(e) {}
            }
          });
        } catch(e){}
      });
      try { let sb = qs('#savePlanBtn'); if (sb && sb.dataset && sb.dataset.editId) delete sb.dataset.editId; } catch(e) {}
    } catch(e) {}
    showToast('یادداشت تمرین ذخیره شد');
  // clear inputs and hide any open modal
  try { if (planRoot.querySelector('#planTitle')) planRoot.querySelector('#planTitle').value = ''; } catch(e) {}
  try { if (planRoot.querySelector('#planDate')) planRoot.querySelector('#planDate').value = ''; } catch(e) {}
  try { if (planRoot.querySelector('#planHour')) planRoot.querySelector('#planHour').value = '00'; } catch(e) {}
  try { if (planRoot.querySelector('#planMinute')) planRoot.querySelector('#planMinute').value = '00'; } catch(e) {}
  try { if (planRoot.querySelector('#planCoach')) planRoot.querySelector('#planCoach').value = ''; } catch(e) {}
  try { if (planRoot.querySelector('#planBody')) planRoot.querySelector('#planBody').value = ''; } catch(e) {}
  try { if (planRoot.querySelector('#planReminderMode')) planRoot.querySelector('#planReminderMode').value = 'none'; } catch(e) {}
  try { let modal = qs('#planModal'); if (modal) { modal.style.display = 'none'; qs('#planModalTitle').textContent = ''; qs('#planModalDate').textContent = ''; qs('#planModalBody').textContent = ''; } } catch(e) {}
  // defensive clear: rerun clear shortly after render in case something repopulates the form
  setTimeout(() => {
    try {
      const ids = ['planTitle','planDate','planHour','planMinute','planCoach','planBody','planReminderMode'];
      ids.forEach(name => {
        try {
          // clear all elements that mistakenly share the same id (duplicate-ID situation)
          const nodes = document.querySelectorAll('#' + name);
          nodes.forEach(el => {
            if (!el) return;
            const tag = (el.tagName || '').toUpperCase();
            if (tag === 'SELECT') {
              if (name === 'planHour' || name === 'planMinute') el.value = '00';
              else if (name === 'planReminderMode') el.value = 'none';
              else el.selectedIndex = 0;
            } else if (tag === 'INPUT' || tag === 'TEXTAREA') {
              if (name === 'planHour' || name === 'planMinute') el.value = '00';
              else if (name === 'planReminderMode') el.value = 'none';
              else el.value = '';
            } else {
              // fallback: clear textContent if present
              try { el.textContent = ''; } catch(e) {}
            }
          });
        } catch (e) {}
      });
      try { let sb = qs('#savePlanBtn'); if (sb && sb.dataset && sb.dataset.editId) delete sb.dataset.editId; } catch(e) {}
      console.debug('[plan] post-clear run (all ids): planBody=', Array.from(document.querySelectorAll('#planBody')).map(n=>n.value || n.textContent));
    } catch(e) { console.error('[plan] post-clear error', e); }
  }, 120);
  // debug: log form state after save/clear to trace lingering values
  try { console.debug('[plan] after save: editId cleared, planTitle=', qs('#planTitle')?.value, 'planDate=', qs('#planDate')?.value, 'planHour=', qs('#planHour')?.value, 'planMinute=', qs('#planMinute')?.value, 'planCoach=', qs('#planCoach')?.value, 'planBody=', qs('#planBody')?.value); } catch(e) {}
  });
} catch(e) {}

try { on('#createTrainingPlan', 'click', () => { qs('#tabTrainingPlan').click(); window.scrollTo(0,0); }); } catch(e) {}
try { on('#addTrainingFromHomeBtn', 'click', () => {
    // navigate to sessions view so renderSessionsPage runs and binds tab handlers
    try { showView('sessions'); } catch(e) {}
    // give renderSessionsPage a tick then activate the training tab
    setTimeout(() => {
      try { qs('#tabTrainingPlan').click(); } catch(e) {}
      try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch(e) {}
      setTimeout(() => {
        try {
          let root = qs('#tabTrainingPlanPanel') || document;
          let el = root.querySelector('#planTitle') || root.querySelector('#planBody') || qs('#planTitle');
          if (el) { el.focus(); if (el.select) el.select(); }
        } catch(e) {}
      }, 120);
    }, 40);
  }); } catch(e) {}

function addPayment(dateStr, amount, type, pMonth, pYear, playerId) {
  if (!playerId) return alert('بازیکن را انتخاب کنید');
  if (!amount) return alert('مبلغ را وارد کنید');
  // If payment month/year not provided, derive from the Jalali date string (YYYY/MM/DD)
  try {
    if (!pMonth || !pYear) {
      const parts = (dateStr || todayJalali()).split('/').map(s => s && s.trim());
      if (parts.length >= 2) {
        pYear = pYear || parts[0];
        pMonth = pMonth || parts[1];
      }
    }
  } catch (e) {
    // fallback: leave pMonth/pYear as-is
  }

  // normalize month to two digits and year to string
  const paymentMonthNorm = String(pMonth || '').padStart(2, '0');
  const paymentYearNorm = String(pYear || '');

  let pay = {
    id: uid('pay'), playerId, date: jalaliToISO(dateStr), amount, paymentMonth: paymentMonthNorm, paymentYear: paymentYearNorm, type,
    createdAt: new Date().toISOString()
  };
  state.payments.unshift(pay);
  saveState();
  renderPaymentsPage();
  renderHome();
}

function renderPaymentsPage() {
  let list = qs('#paymentList');
  list.innerHTML = '';
  state.payments.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(pay => {
    let player = state.players.find(p => p.id === pay.playerId);
    let node = document.createElement('div');
    node.className = 'transaction-card';
    node.innerHTML = `
      <div class="transaction-info">
        <div>
          <strong>${player ? escapeHtml(player.name) : '—'}</strong>
          <div class="transaction-meta">${isoToJalali(pay.date)} • ${Number(pay.amount).toLocaleString()} تومان • دوره: ${pay.paymentMonth}/${pay.paymentYear}</div>
        </div>
        <div class="transaction-meta" style="min-width:80px;text-align:right">${pay.type || '—'}</div>
      </div>
      <div class="transaction-actions">
        <button class="btn small send-receipt">ارسال رسید</button>
        <button class="btn small edit-pay">ویرایش</button>
        <button class="btn small danger del-pay">حذف</button>
      </div>
    `;
    // send receipt handler: open receipt modal and prefills with phone
    node.querySelector('.send-receipt').addEventListener('click', () => {
      let phone = player ? (player.parentPhone || player.phone || '') : '';
      let modal = qs('#receiptModal');
      if (!modal) return alert('مدیریت رسید موجود نیست');
      qs('#receiptPlayerName').textContent = player ? player.name : '—';
      qs('#receiptPhone').value = phone;
      qs('#receiptAmount').value = Number(pay.amount).toLocaleString();
      qs('#receiptNote').value = `رسید پرداخت شهریه به مبلغ ${Number(pay.amount).toLocaleString()} تومان برای دوره ${pay.paymentMonth}/${pay.paymentYear}`;
      modal.style.display = 'flex';
    });
    node.querySelector('.edit-pay').addEventListener('click', () => showView('edit-payment', {pay}));
    node.querySelector('.del-pay').addEventListener('click', () => {
      if (confirm('حذف شود؟')) {
        state.payments = state.payments.filter(x => x.id !== pay.id);
        saveState();
        renderPaymentsPage();
        renderHome();
      }
    });
    list.appendChild(node);
  });
  populatePaymentMonthYear();
  populatePaymentPlayerSelect();
}

function renderEditPayment(pay) {
  let content = qs('#editPaymentContent');
  content.innerHTML = `
    <div style="display: grid; gap: 12px; margin-top: 12px;">
      <input id="editPaymentDate" class="input jalali-input" value="${isoToJalali(pay.date)}" />
      <div style="display: flex; gap: 8px;">
        <select id="editPaymentMonth" class="input"></select>
        <select id="editPaymentYear" class="input"></select>
      </div>
      <input id="editPaymentAmount" class="input" value="${Number(pay.amount).toLocaleString()}" type="text" />
      <select id="editPaymentType" class="input">
        <option value="">نوع پرداخت</option><option>نقد</option><option>رسید</option><option>کارت به کارت</option>
      </select>
      <div class="form-actions">
        <button id="saveEditPayment" class="btn primary">ذخیره</button>
        <button id="cancelEditPayment" class="btn">انصراف</button>
      </div>
    </div>
  `;
  populatePaymentMonthYear('editPaymentMonth', 'editPaymentYear');
  qs('#editPaymentMonth').value = pay.paymentMonth;
  qs('#editPaymentYear').value = pay.paymentYear;
  qs('#editPaymentType').value = pay.type;
  on('#editPaymentAmount', 'input', (e) => formatNumber(e.target));
  on('#cancelEditPayment', 'click', () => showView('payments'));
  on('#saveEditPayment', 'click', () => {
    let dateStr = qs('#editPaymentDate').value || isoToJalali(pay.date);
    let amount = qs('#editPaymentAmount').value.replace(/,/g, '');
    let type = qs('#editPaymentType').value || '';
    let pMonth = qs('#editPaymentMonth').value;
    let pYear = qs('#editPaymentYear').value;
    pay.date = jalaliToISO(dateStr);
    pay.amount = amount;
    pay.type = type;
    pay.paymentMonth = pMonth;
    pay.paymentYear = pYear;
    pay.updatedAt = new Date().toISOString();
    saveState();
    showView('payments');
  });
}

function renderDebtors() {
  let content = qs('#debtorsContent');
  let todayParts = todayJalali().split('/').map(Number);
  let currentMonth = ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'][todayParts[1] - 1];
  let currentYear = todayParts[0].toString();
  let monthSessions = state.sessions.filter(s => {
    let sDate = isoToJalali(s.date).split('/').map(Number);
    return sDate[0] === todayParts[0] && sDate[1] === todayParts[1];
  });
  let debtors = state.players.filter(p => {
    let sessionsAttended = monthSessions.filter(s => s.attendances?.[p.id]?.present).length;
    let paid = state.payments.some(pay => pay.playerId === p.id && pay.paymentMonth === currentMonth && pay.paymentYear === currentYear);
    return sessionsAttended >= 4 && !paid;
  });
  content.innerHTML = `
    <div class="muted" style="margin-bottom:8px;">هر بازیکنی که در این ماه حداقل 4 جلسه حضور داشته باشد و شهریه را پرداخت نکرده باشد، در این لیست نمایش داده می‌شود.</div>
    ${debtors.map(p => `
      <div class="player-row">
        <div class="meta"><strong>${escapeHtml(p.name)}</strong><small>${p.category || '—'}</small></div>
        <button class="btn small pay-debt">پرداخت</button>
      </div>
    `).join('') || '<div class="muted">هیچ بدهکاری نیست</div>'}
  `;
  qsa('.pay-debt').forEach(btn => {
    let row = btn.closest('.player-row');
    let name = row.querySelector('strong').textContent;
    let player = state.players.find(p => p.name === name);
    btn.addEventListener('click', () => {
      showView('payments');
      qs('#paymentPlayer').value = player.id;
      qs('#paymentPlayerSearch').value = player.name;
      qs('#paymentMonth').value = currentMonth;
      qs('#paymentYear').value = currentYear;
    });
  });
}

function renderPaymentReport() {
  let content = qs('#paymentReportContent');
  content.innerHTML = `
    <div style="margin-top: 12px; display: grid; gap: 12px;">
      <select id="reportCategory" class="input" style="direction: rtl;"><option value="">همه رده‌ها</option></select>
      <div style="display: flex; gap: 8px;">
        <select id="reportMonth" class="input" style="direction: rtl;"></select>
        <select id="reportYear" class="input" style="direction: rtl;"></select>
      </div>
      <div id="reportPeriodLabel" style="font-weight:700; text-align:center;">دوره: -</div>
      <div style="display:flex;gap:8px;align-items:center;justify-content:center;">
        <button id="exportPdfBtn" class="btn">خروجی PDF</button>
        <button id="exportExcelBtn" class="btn">خروجی Excel</button>
      </div>
      <div id="reportList" style="max-height: 40vh; overflow: auto;"></div>
    </div>
  `;
  populateCategoryFilter(qs('#reportCategory'));
  populatePaymentMonthYear('reportMonth', 'reportYear');
  let month = qs('#reportMonth').value;
  let year = qs('#reportYear').value;
  let category = qs('#reportCategory').value;
  renderReportList(month, year, category);
  function updateReportPeriod(){
    const m = qs('#reportMonth').value || '-';
    const y = qs('#reportYear').value || '-';
    const c = qs('#reportCategory').value || 'همه رده‌ها';
    const label = qs('#reportPeriodLabel'); if (label) label.textContent = `دوره: ${m} ${y} — ${c}`;
  }
  on('#reportMonth', 'change', () => { updateReportPeriod(); renderReportList(qs('#reportMonth').value, qs('#reportYear').value, qs('#reportCategory').value); });
  on('#reportYear', 'change', () => { updateReportPeriod(); renderReportList(qs('#reportMonth').value, qs('#reportYear').value, qs('#reportCategory').value); });
  on('#reportCategory', 'change', () => { updateReportPeriod(); renderReportList(qs('#reportMonth').value, qs('#reportYear').value, qs('#reportCategory').value); });
  on('#exportPdfBtn', 'click', () => { month = qs('#reportMonth').value; year = qs('#reportYear').value; category = qs('#reportCategory').value; updateReportPeriod(); exportPaymentsToPdf(month, year, category); });
  on('#exportExcelBtn', 'click', () => { month = qs('#reportMonth').value; year = qs('#reportYear').value; category = qs('#reportCategory').value; updateReportPeriod(); exportPaymentsToExcel(month, year, category); });
}

function renderReportList(month, year, category) {
  let list = qs('#reportList');
  list.innerHTML = '';
  let filteredPlayers = state.players.slice();
  if (category) filteredPlayers = filteredPlayers.filter(p => p.category === category);
  let monthSessions = state.sessions.filter(s => {
    let sDate = isoToJalali(s.date).split('/').map(Number);
    return sDate[0].toString() === year && ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'].indexOf(month) + 1 === sDate[1];
  });
  filteredPlayers.forEach(p => {
    let paid = state.payments.some(pay => pay.playerId === p.id && pay.paymentMonth === month && pay.paymentYear === year);
    let sessionsAttended = monthSessions.filter(s => s.attendances?.[p.id]?.present).length;
    let row = document.createElement('div');
    row.className = 'player-row';
    const statusText = paid ? 'پرداخت شده' : 'بدهکار';
    const statusColor = paid ? 'color: #16a34a; font-weight:700;' : 'color: #dc2626; font-weight:700;';
    row.innerHTML = `
      <div class="meta"><strong>${escapeHtml(p.name)}</strong><small>پرداخت: <span style="${statusColor}">${statusText}</span> • حضور: ${sessionsAttended} جلسه</small></div>
    `;
    list.appendChild(row);
  });
}

function exportPaymentsToPdf(month, year, category) {
  const reportEl = qs('#reportList');
  if (!reportEl) return showToast('لیست گزارش پیدا نشد');
  const period = `دوره: ${month || '-'} ${year || '-'} — ${category || 'همه رده‌ها'}`;
  // create a temporary wrapper so the period header is included in the captured image
  const wrapper = document.createElement('div');
  wrapper.style.position = 'fixed';
  wrapper.style.left = '-9999px';
  wrapper.style.top = '0';
  wrapper.style.background = '#ffffff';
  wrapper.style.padding = '12px';
  wrapper.innerHTML = `<div style="font-weight:700; text-align:center; margin-bottom:8px;">${period}</div><div style="background:#fff;">${reportEl.innerHTML}</div>`;
  document.body.appendChild(wrapper);
  html2canvas(wrapper, { backgroundColor: '#ffffff', scale: 2 }).then(canvas => {
    try {
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf || window.jspdf ? window.jspdf : window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const imgProps = pdf.getImageProperties(imgData);
      const imgWidth = pageWidth - 20; // margins
      const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
      pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
      const safeMonth = (month || '').toString().replace(/\s+/g, '_');
      const safeYear = (year || '').toString().replace(/\s+/g, '_');
      const fileName = `payments_report_${safeMonth || 'all'}_${safeYear || 'all'}.pdf`;
      pdf.save(fileName);
    } catch (e) { console.error('PDF export failed', e); showToast('خروجی PDF موفقیت‌آمیز نبود'); }
    document.body.removeChild(wrapper);
  }).catch(e => { console.error('html2canvas failed', e); showToast('خطا در تهیه تصویر برای PDF'); document.body.removeChild(wrapper); });
}

function exportPaymentsToExcel(month, year, category) {
  const period = `دوره: ${month || '-'} ${year || '-'} — ${category || 'همه رده‌ها'}`;
  let csv = `${period}\nنام,پرداخت,حضور\n`;
  let filteredPlayers = state.players.slice();
  if (category) filteredPlayers = filteredPlayers.filter(p => p.category === category);
  let monthSessions = state.sessions.filter(s => {
    let sDate = isoToJalali(s.date).split('/').map(Number);
    return sDate[0].toString() === year && ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'].indexOf(month) + 1 === sDate[1];
  });
  filteredPlayers.forEach(p => {
    let paid = state.payments.some(pay => pay.playerId === p.id && pay.paymentMonth === month && pay.paymentYear === year) ? 'پرداخت شده' : 'بدهکار';
    let sessionsAttended = monthSessions.filter(s => s.attendances?.[p.id]?.present).length;
    csv += `${p.name},${paid},${sessionsAttended}\n`;
  });
  let blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
  let url = URL.createObjectURL(blob);
  let a = document.createElement('a');
  a.href = url;
  const safeMonth = (month || '').toString().replace(/\s+/g, '_');
  const safeYear = (year || '').toString().replace(/\s+/g, '_');
  a.download = `payments_report_${safeMonth || 'all'}_${safeYear || 'all'}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function renderPlayersExport() {
  let content = qs('#playersExportContent');
  content.innerHTML = `
    <select id="exportCategory" class="input"><option value="">همه رده‌ها</option></select>
    <div class="form-actions">
      <button id="exportPlayers" class="btn primary">خروجی لیست</button>
    </div>
  `;
  populateCategoryFilter(qs('#exportCategory'));
  on('#exportPlayers', 'click', () => {
    let cat = qs('#exportCategory').value;
    exportPlayersToExcel(cat);
    showView('players');
  });
}

function exportPlayersToExcel(category) {
  let csv = 'نام,رده,تاریخ تولد,تاریخ عضویت,تاریخ بیمه,پست,تلفن,کد ملی,نام پدر,قد,وزن\n';
  let filtered = state.players.slice();
  if (category) filtered = filtered.filter(p => p.category === category);
  filtered.forEach(p => {
    csv += `${p.name},${p.category || ''},${p.birthdate || ''},${p.joinDate || ''},${p.insuranceDate || ''},${p.favoritePosition || ''},${p.phone || ''},${p.nationalCode || ''},${p.fatherName || ''},${p.height || ''},${p.weight || ''}\n`;
  });
  let blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
  let url = URL.createObjectURL(blob);
  let a = document.createElement('a');
  a.href = url;
  a.download = 'players_report.csv';
  a.click();
  URL.revokeObjectURL(url);
}
/* applyTheme(theme) {
  const validThemes = ['luxury', 'fun', 'modern'];
  const selectedTheme = validThemes.includes(theme) ? theme : 'modern'; // پیش‌فرض modern
  document.documentElement.setAttribute('data-style', selectedTheme);
  state.settings.theme = selectedTheme;
  saveState();
} */
function renderPlayerForm(player = null) {
  let isEdit = !!player;
  let title = qs('#playerFormTitle');
  title.textContent = isEdit ? 'ویرایش بازیکن' : 'ثبت بازیکن';
  let content = qs('#playerFormContent');
  let scores = player ? player.scores || {} : {};
  let birth = player ? player.birthdate || '' : '';
  let insurance = player ? player.insuranceDate || '' : '';
  content.innerHTML = `
    <div style="display: flex; flex-direction: column; align-items: center; margin-top: 12px; width:100%;">
      <div style="width: 120px; height: 120px; border-radius: 12px; overflow: hidden; background: #e2e8f0;" id="previewPhoto">
        ${player && player.photo ? `<img src="${player.photo}" style="width: 100%; height: 100%; object-fit: cover;">` : (player && player.gender ? `<img src="./icons/${player.gender === 'female' ? 'volleyball-player (3).png' : 'volleyball-player (4).png'}" style="width:100%;height:100%;object-fit:cover;">` : '<div class="muted">عکس</div>')}
      </div>
      <div style="display: flex; gap: 8px; margin-top: 8px;">
        <label class="btn primary" style="padding: 8px 16px; font-size: 14px;">انتخاب عکس<input id="p_photo" type="file" accept="image/*" style="display: none;"></label>
        <button id="removePhotoBtn" class="btn small" ${player && player.photo ? '' : 'disabled'}>حذف عکس</button>
      </div>

      <div style="width:100%; margin-top:12px;">
        <div class="form-section">
          <h4 style="margin:0 0 8px 0">اطلاعات شخصی</h4>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <div>
              <label for="p_name">نام کامل</label>
              <input id="p_name" class="input" type="text" value="${player ? escapeHtml(player.name || '') : ''}">
            </div>
            <div>
              <label for="p_father">نام پدر</label>
              <input id="p_father" class="input" type="text" value="${player ? escapeHtml(player.fatherName || '') : ''}">
            </div>
            <div>
              <label for="p_nationalCode">کد ملی</label>
              <input id="p_nationalCode" class="input" type="text" value="${player ? escapeHtml(player.nationalCode || '') : ''}">
            </div>
            <div>
              <label for="p_phone">تلفن</label>
              <input id="p_phone" class="input" type="text" value="${player ? escapeHtml(player.phone || '') : ''}">
            </div>
            <div>
              <label for="p_parentPhone">تلفن والد</label>
              <input id="p_parentPhone" class="input" type="text" value="${player ? escapeHtml(player.parentPhone || '') : ''}">
            </div>
            <div>
              <label for="p_gender">جنسیت</label>
              <select id="p_gender" class="input">
                <option value="male">پسر</option>
                <option value="female">دختر</option>
              </select>
            </div>
            <div>
              <label for="p_birth">تاریخ تولد (YYYY/MM/DD)</label>
              <input id="p_birth" class="input jalali-input" value="${birth}" readonly="readonly" />
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4 style="margin:0 0 8px 0">پروفایل ورزشی</h4>
          <div class="form-row">
            <div>
              <label for="p_join">تاریخ عضویت (YYYY/MM/DD)</label>
              <input id="p_join" class="input jalali-input" value="${player ? player.joinDate : todayJalali()}">
            </div>
          </div>
          <div class="form-row">
            <div>
              <label for="p_insurance">تاریخ بیمه (YYYY/MM/DD)</label>
              <input id="p_insurance" class="input jalali-input" value="${insurance}" readonly="readonly" />
            </div>
            <div>
              <label for="p_category">رده</label>
              <select id="p_category" class="input"></select>
            </div>
          </div>
          <div class="form-row">
            <div>
              <label for="p_position">پست</label>
              <select id="p_position" class="input">
                <option value="">انتخاب پست</option>
                <option value="OH">Outside Hitter</option>
                <option value="OPP">Opposite Hitter</option>
                <option value="L">Libero</option>
                <option value="ST">Setter</option>
                <option value="MB">Middle Blocker</option>
              </select>
            </div>
            <div>
              <label for="p_jersey">شماره پیراهن</label>
              <input id="p_jersey" class="input" type="text" value="${player ? escapeHtml(player.jersey || '') : ''}">
            </div>
          </div>
          <div class="form-row">
            <div>
              <label for="p_height">قد (cm)</label>
              <input id="p_height" class="input" type="number" value="${player ? player.height : ''}">
            </div>
            <div>
              <label for="p_weight">وزن (kg)</label>
              <input id="p_weight" class="input" type="number" value="${player ? player.weight : ''}">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4 style="margin:0 0 8px 0">مهارت‌ها و امتیازات</h4>
          <div id="scoresContainer"></div>
        </div>

        <div class="form-actions">
          <button id="savePlayerBtn" class="btn primary">ذخیره</button>
        </div>
      </div>
    </div>
  `;
  attachJalaliInputs(content); // بعد از تکمیل content.innerHTML
  // populate category select with current ranks and select player's category if editing
  try{ populateCategoriesFromRanks(qs('#p_category'), 'انتخاب رده', player ? player.category : ''); } catch(e){}
  // ... بقیه کد بدون تغییر
  function updateCategoryAndPosition() {
  let birthInput = qs('#p_birth');
  let categoryInput = qs('#p_category');
  let positionInput = qs('#p_position');

  // بررسی وجود المنت‌ها
  if (!birthInput || !categoryInput || !positionInput) {
    console.warn('One or more required elements (#p_birth, #p_category, #p_position) not found');
    return;
  }

  let birth = birthInput.value;
  if (!birth || !birth.match(/^\d{4}\/\d{2}\/\d{2}$/)) {
    console.warn('Invalid birthdate format:', birth);
    categoryInput.value = '';
    positionInput.value = '';
    positionInput.disabled = true;
    positionInput.options[0].text = 'انتخاب پست';
    renderScoreFields('', null);
    return;
  }

  try {
  let age = calcExactAge(birth);
  age.birthdate = birth;
  let category = determineCategory(age);
    categoryInput.value = category || 'نامشخص';

    // مدیریت پست و امتیازات
    if (category === 'مینی والیبال' || category === 'نونهالان') {
      positionInput.value = '';
      positionInput.disabled = true;
      positionInput.options[0].text = 'همه پست‌ها';
      renderScoreFields(category, null);
    } else {
      positionInput.disabled = false;
      positionInput.options[0].text = 'انتخاب پست';
      renderScoreFields(category, positionInput.value || null);
    }
  } catch (e) {
    console.error('Error in updateCategoryAndPosition:', e);
    categoryInput.value = 'خطا';
    positionInput.value = '';
    positionInput.disabled = true;
    positionInput.options[0].text = 'انتخاب پست';
    renderScoreFields('', null);
  }
}

  on('#p_birth', 'change', updateCategoryAndPosition);
  on('#p_position', 'change', () => renderScoreFields(qs('#p_category').value, qs('#p_position').value));

  updateCategoryAndPosition();
  if (player) {
    qs('#p_position').value = player.favoritePosition || '';
    for (let key in scores) {
      let input = qs(`#score_${key}`);
      if (input) input.value = scores[key];
    }
  // populate additional fields
  if (qs('#p_jersey')) qs('#p_jersey').value = player.jersey || '';
  if (qs('#p_parentPhone')) qs('#p_parentPhone').value = player.parentPhone || '';
  if (qs('#p_gender')) qs('#p_gender').value = player.gender || 'male';
  }
  
  on('#p_photo', 'change', e => {
    let f = e.target.files[0];
    if (!f) return;
    imageFileToDataURL(f, 500).then(data => {
      let prev = qs('#previewPhoto');
      if (prev.querySelector('img')) {
        prev.querySelector('img').src = data;
      } else {
        prev.innerHTML = '';
        let img = document.createElement('img');
        img.src = data;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        prev.appendChild(img);
      }
      qs('#removePhotoBtn').disabled = false;
      qs('#p_photo').dataset.dataurl = data;
    }).catch(err => alert('خطا در خواندن تصویر'));
  });

  on('#removePhotoBtn', 'click', () => {
    qs('#previewPhoto').innerHTML = '<div class="muted">عکس</div>';
    qs('#p_photo').value = '';
    qs('#p_photo').dataset.dataurl = '';
    qs('#removePhotoBtn').disabled = true;
  });

  on('#savePlayerBtn', 'click', () => {
    let name = qs('#p_name').value.trim();
    if (!name) return alert('نام را وارد کنید');
    let birth = qs('#p_birth').value.trim();
    let join = qs('#p_join').value.trim() || todayJalali();
    let insurance = qs('#p_insurance').value.trim();
    let category = qs('#p_category').value;
    let pos = qs('#p_position').value;
  let phone = qs('#p_phone').value;
  let parentPhone = qs('#p_parentPhone') ? qs('#p_parentPhone').value.trim() : '';
  let jersey = qs('#p_jersey') ? qs('#p_jersey').value.trim() : '';
    let nationalCode = qs('#p_nationalCode').value;
    let father = qs('#p_father').value;
    let height = qs('#p_height').value;
    let weight = qs('#p_weight').value;
    
    let scores = {};
    qsa('#scoresContainer input[type="number"]').forEach(input => {
      let key = input.id.replace('score_', '');
      scores[key] = input.value || 0;
    });
    
  // Determine photo: prefer uploaded image, else keep existing, else use gender placeholder
  let uploaded = qs('#p_photo').dataset.dataurl || '';
  let existing = player ? (player.photo || '') : '';
  let gender = qs('#p_gender') ? (qs('#p_gender').value || 'male') : 'male';
  gender = ('' + gender).toLowerCase().startsWith('f') ? 'female' : 'male';
  let placeholder = `./icons/${gender === 'female' ? 'volleyball-player (3).png' : 'volleyball-player (4).png'}`;
  let photoData = uploaded || existing || placeholder;
  console.debug('[savePlayer] chosen source=', uploaded ? 'uploaded' : (existing ? 'existing' : 'placeholder'), 'name=', name, 'gender=', gender, 'photoData=', photoData);

    let savedPlayerId = null;
    if (isEdit) {
      let idx = state.players.findIndex(x => x.id === player.id);
      if (idx > -1) {
        state.players[idx] = {
          ...state.players[idx],
          name, birthdate: birth, joinDate: join, insuranceDate: insurance, category, favoritePosition: pos,
          phone, parentPhone, jersey, nationalCode, fatherName: father, height, weight, scores, photo: photoData, gender: gender, updatedAt: new Date().toISOString()
        };
        savedPlayerId = state.players[idx].id;
      }
    } else {
      const newId = uid('p');
      state.players.push({
        id: newId, name, birthdate: birth, joinDate: join, insuranceDate: insurance, category, favoritePosition: pos,
        phone, parentPhone, jersey, nationalCode, fatherName: father, height, weight, scores, photo: photoData, gender: gender, createdAt: new Date().toISOString(), events: []
      });
      savedPlayerId = newId;
    }
    saveState();
    // After saving, go back to the saved player's profile
    if (savedPlayerId) {
      showView('player-profile', { playerId: savedPlayerId });
      renderPlayerProfile(savedPlayerId);
    } else {
      // fallback
      showView('players');
      renderHome();
    }
  });
  on('#backPlayerForm', 'click', () => { if (!goBack()) return; });
}

function renderScoreFields(category, position) {
  let container = qs('#scoresContainer');
  container.innerHTML = '';
  let fields = getPositionSpecificFields(position);
  fields.forEach(key => {
    let div = document.createElement('div');
    div.innerHTML = `
      <label for="score_${key}">${key}</label>
      <input id="score_${key}" type="number" min="0" max="10" step="1" class="input">
    `;
    container.appendChild(div);
  });
}

function getPositionSpecificFields(position) {
  if (!position) return ['سرویس', 'حمله', 'دریافت', 'توپگیری', 'جاگیری', 'نظم_تیمی'];
  switch (position) {
    case 'OH': // Outside Hitter
      return ['سرویس', 'حمله', 'دریافت', 'توپگیری', 'جاگیری', 'نظم_تیمی'];
    case 'OPP': // Opposite Hitter
      return ['سرویس', 'حمله', 'دریافت', 'توپگیری', 'جاگیری', 'نظم_تیمی'];
    case 'L': // Libero
      return ['دریافت', 'توپگیری', 'جاگیری', 'نظم_تیمی'];
    case 'ST': // Setter
      return ['سرویس', 'پاس', 'دریافت', 'توپگیری', 'جاگیری', 'نظم_تیمی'];
    case 'MB': // Middle Blocker
      return ['سرویس', 'حمله', 'بلوک', 'جاگیری', 'نظم_تیمی'];
    default:
      return ['سرویس', 'حمله', 'دریافت', 'توپگیری', 'جاگیری', 'نظم_تیمی'];
  }
}

function renderCoachForm(coach) {
  let isEdit = !!coach;
  let title = qs('#coachFormTitle');
  title.textContent = isEdit ? 'ویرایش مربی' : 'افزودن مربی';
  let content = qs('#coachFormContent');
  content.innerHTML = `
    <div style="display: flex; gap: 12px; align-items: flex-start; margin-top: 12px;">
      <div style="width: 120px; height: 120px; border-radius: 12px; overflow: hidden; background: #e2e8f0;" id="coachPreview">
        ${coach?.photo ? `<img src="${coach.photo}" style="width: 100%; height: 100%; object-fit: cover;">` : 'عکس'}
      </div>
      <div style="flex: 1;">
        <div class="form-row">
          <div>
            <label for="c_name">نام کامل</label>
            <input id="c_name" type="text" value="${coach ? escapeHtml(coach.name) : ''}">
          </div>
          <div>
            <label for="c_title">سمت/عنوان</label>
            <input id="c_title" type="text" value="${coach ? escapeHtml(coach.title || '') : ''}">
          </div>
        </div>
        <div class="form-row">
          <div>
            <label for="c_phone">تلفن</label>
            <input id="c_phone" type="text" value="${coach ? escapeHtml(coach.phone || '') : ''}">
          </div>
          <div style="display: flex; gap: 8px; align-items: flex-end;">
            <label class="btn">عکس<input id="c_photo" type="file" accept="image/*" style="display: none;"></label>
            <button id="removeCoachPhoto" class="btn" ${coach?.photo ? '' : 'disabled'}>حذف</button>
          </div>
        </div>
        <div class="form-actions">
          <button id="saveCoach" class="btn primary">${isEdit ? 'ذخیره' : 'افزودن'}</button>
          <button id="cancelCoach" class="btn">انصراف</button>
        </div>
      </div>
    </div>
  `;

  on('#cancelCoach', 'click', () => showView('coaches'));
  on('#c_photo', 'change', e => {
    let f = e.target.files[0];
    if (!f) return;
    imageFileToDataURL(f, 500).then(data => {
      qs('#coachPreview').innerHTML = `<img src="${data}" style="width: 100%; height: 100%; object-fit: cover;">`;
      qs('#c_photo').dataset.dataurl = data;
      qs('#removeCoachPhoto').disabled = false;
    }).catch(err => alert('خطا در خواندن عکس'));
  });
  on('#removeCoachPhoto', 'click', () => {
    qs('#coachPreview').innerHTML = 'عکس';
    qs('#c_photo').dataset.dataurl = '';
    qs('#removeCoachPhoto').disabled = true;
  });

  on('#saveCoach', 'click', () => {
    let name = qs('#c_name').value.trim();
    if (!name) return alert('نام را وارد کنید');
    let title = qs('#c_title').value.trim();
    let phone = qs('#c_phone').value.trim();
    let photo = qs('#c_photo').dataset.dataurl || (coach ? coach.photo || '' : '');
    if (isEdit) {
      let idx = state.coaches.findIndex(x => x.id === coach.id);
      if (idx > -1) state.coaches[idx] = { ...state.coaches[idx], name, title, phone, photo, updatedAt: new Date().toISOString() };
    } else {
      state.coaches.push({ id: uid('c'), name, title, phone, photo, createdAt: new Date().toISOString() });
    }
    saveState();
    showView('coaches');
    renderHome();
  });
  on('#backCoachForm', 'click', () => { if (!goBack()) return; });
}

function createSession() {
  let title = qs('#sessionTitle').value.trim();
  let dateStr = qs('#sessionDate').value || todayJalali();
  let category = qs('#sessionCategory').value || null;
  let coachId = qs('#sessionCoach').value || null;
  let id = uid('s');
  let s = { id, title, date: jalaliToISO(dateStr), category, coachId, createdAt: new Date().toISOString(), attendances: {} };
  state.sessions.unshift(s);
  saveState();
  qs('#sessionTitle').value = '';
  qs('#sessionDate').value = '';
  renderSessionsPage();
  renderHome();
}

function renderSessionAttendance(id) {
  let s = state.sessions.find(x => x.id === id);
  if (!s) return;
  let title = qs('#attendanceTitle');
  title.textContent = `حضور/غیاب — ${escapeHtml(s.title)}`;
  let content = qs('#attendanceContent');
  let sessionDate = jalaliToDate(isoToJalali(s.date));
  let html = '';
  let filteredPlayers = state.players.filter(p => jalaliToDate(p.joinDate) <= sessionDate);
  if (s.category) filteredPlayers = filteredPlayers.filter(p => p.category === s.category);
  filteredPlayers.forEach(p => {
    let att = s.attendances?.[p.id] || { present: false, reason: '' };
    let imgHtml = p.photo ? `<img src="${p.photo}" alt="avatar">` : `<svg width="36" height="36" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>`;
    html += `
      <div style="display: flex; align-items: center; gap: 12px; padding: 8px; border-bottom: 1px dashed rgba(0,0,0,0.06);">
        <div class="player-thumb">${imgHtml}</div>
        <div class="meta"><strong>${escapeHtml(p.name)}</strong><small>${p.category || ''}</small></div>
        <label style="display: flex; gap: 8px;"><input type="checkbox" data-player="${p.id}" ${att.present ? 'checked' : ''}> حاضر</label>
        <button class="note-btn${att.reason ? ' has-note' : ''}" data-reason-btn="${p.id}"><svg viewBox="0 0 24 24"><path d="M3 3h18v18H3z" stroke="currentColor" stroke-width="2" fill="none"/><path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
      </div>
    `;
  });
  html += `
    <div class="form-actions">
      <button id="saveAttendance" class="btn primary">ذخیره</button>
      <button id="closeAttendance" class="btn">بستن</button>
    </div>
  `;
  content.innerHTML = html;
  on('#closeAttendance', 'click', () => showView('sessions'));
  qsa('[data-reason-btn]').forEach(btn => {
    let pid = btn.dataset.reasonBtn;
    let att = s.attendances?.[pid] || { reason: '' };
    btn.addEventListener('click', () => {
      // ذخیره موقت حضور
      let tempAttendances = {};
      filteredPlayers.forEach(pl => {
        let cb = qs(`[data-player="${pl.id}"]`);
        if (cb) {
          tempAttendances[pl.id] = { ...s.attendances[pl.id], present: !!cb.checked };
        }
      });
      showView('note', {playerId: pid, currentNote: att.reason, callback: (newReason) => {
        s.attendances[pid] = { ...s.attendances[pid], reason: newReason };
      }, sessionId: id, tempAttendances});
    });
  });
  on('#saveAttendance', 'click', () => {
    filteredPlayers.forEach(p => {
      let cb = qs(`[data-player="${p.id}"]`);
      if (cb) {
        s.attendances[p.id] = { ...s.attendances[p.id], present: !!cb.checked };
      }
    });
    saveState();
    showView('sessions');
  });
  on('#backAttendance', 'click', () => { if (!goBack()) return; });
}

function renderNote(playerId, currentNote, callback, sessionId, tempAttendances) {
  let content = qs('#noteContent');
  content.innerHTML = `
    <textarea id="noteText" class="input" style="height: 120px; margin-top: 12px;">${escapeHtml(currentNote)}</textarea>
    <div class="form-actions">
      <button id="saveNote" class="btn primary">ذخیره</button>
      <button id="cancelNote" class="btn">انصراف</button>
    </div>
  `;
  on('#cancelNote', 'click', () => {
    showView('session-attendance', {sessionId});
    // برگرداندن تیک‌ها
    let keys = Object.keys(tempAttendances);
    keys.forEach(pid => {
      let cb = qs(`[data-player="${pid}"]`);
      if (cb) cb.checked = tempAttendances[pid].present;
    });
  });
  on('#saveNote', 'click', () => {
    let newNote = qs('#noteText').value.trim();
    callback(newNote);
    saveState();
    showView('session-attendance', {sessionId});
    // برگرداندن تیک‌ها
    let keys = Object.keys(tempAttendances);
    keys.forEach(pid => {
      let cb = qs(`[data-player="${pid}"]`);
      if (cb) cb.checked = tempAttendances[pid].present;
    });
  });
  on('#backNote', 'click', () => {
    showView('session-attendance', {sessionId});
    // برگرداندن تیک‌ها
    let keys = Object.keys(tempAttendances);
    keys.forEach(pid => {
      let cb = qs(`[data-player="${pid}"]`);
      if (cb) cb.checked = tempAttendances[pid].present;
    });
  });
}

function renderPlayerProfile(id) {
  let title = qs('#profileTitle');
  if (!title) {
    console.error('Element #profileTitle not found');
    return showView('players');
  }
  title.textContent = 'پروفایل بازیکن';

  let content = qs('#profileContent');
  if (!content) {
    console.error('Element #profileContent not found');
    return showView('players');
  }

  let p = state.players.find(x => x.id === id);
  if (!p) {
    console.warn('Player not found for ID:', id);
    alert('پروفایل پیدا نشد');
    return showView('players');
  }

  // بررسی و تنظیم birthdate
  if (!p.birthdate || typeof p.birthdate !== 'string' || !p.birthdate.includes('/')) {
    console.warn('Invalid or missing birthdate for player:', p);
    p.birthdate = todayJalali(); // تاریخ پیش‌فرض امروز
  }

  let age;
  try {
    age = calcExactAge(p.birthdate); // سن دقیق
    if (!age.birthdate) age.birthdate = p.birthdate; // اطمینان از وجود birthdate
  } catch (e) {
    console.error('Error in calcExactAge:', e);
    age = { years: 0, months: 0, days: 0, birthdate: p.birthdate };
  }

  // محاسبه رده با determineCategory
  let category;
  try {
    category = determineCategory(age);
  } catch (e) {
    console.error('Error in determineCategory:', e);
    category = 'نامشخص';
  }

  // time-to-next-category removed by request
  let timeToNext = null;

  // بررسی و تنظیم sessions
  let sessions = [];
  try {
    sessions = state.sessions
      .filter(s => s.attendances?.[p.id]?.present)
      .map(s => ({
        title: s.title || 'جلسه',
        date: isoToJalali(s.date) || '—',
        category: s.category || '—'
      }));
  } catch (e) {
    console.error('Error processing sessions:', e);
  }

  // بررسی و تنظیم payments
  let payments = [];
  try {
    payments = state.payments
      .filter(x => x.playerId === p.id)
      .map(pay => ({
        amount: Number(pay.amount).toLocaleString() || '—',
        date: isoToJalali(pay.date) || '—',
        period: pay.paymentMonth && pay.paymentYear ? `${pay.paymentMonth}/${pay.paymentYear}` : '—',
        type: pay.type || '—'
      }));
  } catch (e) {
    console.error('Error processing payments:', e);
  }

  // remember current player on the profile view root to support delegated actions
  try {
    const profileView = qs('#view-player-profile'); if (profileView) profileView.dataset.currentPlayer = p.id;
    // delegated click: if any element inside view with id 'shareProfile' is clicked, open share overlay
    if (profileView && !profileView._shareDelegated) {
      profileView.addEventListener('click', (ev) => {
        try {
          const target = ev.target.closest ? ev.target.closest('#shareProfile') : (ev.target.id === 'shareProfile' ? ev.target : null);
          if (target) {
            const cid = profileView.dataset.currentPlayer;
            if (cid) openPlayerShareOverlay(cid);
          }
        } catch (e) { console.warn('delegated share handler error', e); }
      });
      profileView._shareDelegated = true;
    }
  } catch (e) { console.warn('profile view delegation setup failed', e); }

  // بررسی و تنظیم scores
  let scores = p.scores || {};
  let avgScore;
  try {
    avgScore = calcAverageScore(p) || '—';
  } catch (e) {
    console.error('Error in calcAverageScore:', e);
    avgScore = 'نامشخص';
  }

  // بررسی وضعیت بیمه
  let expired = false;
  let insuranceStatus = 'بیمه‌ای ثبت نشده';
  try {
    expired = isInsuranceExpired(p.insuranceDate);
    insuranceStatus = p.insuranceDate ? (expired ? 'منقضی' : 'فعال') + ` (${p.insuranceDate})` : 'بیمه‌ای ثبت نشده';
  } catch (e) {
    console.error('Error in isInsuranceExpired:', e);
  }

  // محاسبه سابقه عضویت
  let membershipDuration;
  try {
    membershipDuration = calculateMembershipDuration(p.joinDate) || '—';
  } catch (e) {
    console.error('Error in calculateMembershipDuration:', e);
    membershipDuration = 'نامشخص';
  }

  // محاسبه BMI
  let bmiHtml;
  try {
    let bmiData = calculateBMI(p.height, p.weight);
    bmiHtml = bmiData
      ? `
        <div><strong>شاخص سلامت (BMI):</strong> ${bmiData.bmi} (${bmiData.status})</div>
        <div style="background: #e2e8f0; height: 10px; border-radius: 5px; position: relative; margin-top: 4px; margin-bottom: 8px;">
          <div style="width: ${bmiData.percent}%; background: ${bmiData.color}; height: 100%; border-radius: 5px;"></div>
        </div>
        <small>اضافه وزن: ${bmiData.excessWeight.toFixed(1)} kg</small>
      `
      : '<div>اطلاعات کافی برای محاسبه BMI نیست</div>';
  } catch (e) {
    console.error('Error in calculateBMI:', e);
    bmiHtml = '<div>خطا در محاسبه BMI</div>';
  }

  // بررسی و تنظیم رویدادها
  let eventsHtml;
  try {
    eventsHtml = p.events && Array.isArray(p.events) && p.events.length > 0
      ? p.events.map((e, idx) => `<div class="muted">${escapeHtml(e.text)} (${e.date})</div>`).join('')
      : '<div class="muted">بدون رویداد</div>';
  } catch (e) {
    console.error('Error processing events:', e);
    eventsHtml = '<div class="muted">خطا در بارگذاری رویدادها</div>';
  }

  // محاسبه وضعیت قد نسبت به میانگین استاندارد بر اساس سن و جنس
  let statureStatus = '';
  try {
    const statureTable = {
      1: { male:75, female:74 },2:{male:87,female:86},3:{male:95,female:94},4:{male:102,female:101},5:{male:109,female:108},6:{male:115,female:115},7:{male:121,female:121},8:{male:127,female:128},9:{male:133,female:134},10:{male:138,female:139},11:{male:144,female:145},12:{male:149,female:151},13:{male:156,female:156},14:{male:163,female:158},15:{male:169,female:160},16:{male:173,female:162},17:{male:175,female:163},18:{male:176,female:163}
    };
    const ageY = Math.max(1, Math.min(18, Number(age.years) || 1));
    const expected = (p.gender === 'female') ? (statureTable[ageY].female || statureTable[ageY].male) : (statureTable[ageY].male || statureTable[ageY].female);
    if (p.height) {
      const diff = Number(p.height) - expected;
      if (Math.abs(diff) < 2) statureStatus = 'خوبه';
      else if (diff >= 6) statureStatus = 'عالیه';
      else if (diff >= 2) statureStatus = 'کمی بلند';
      else if (diff <= -6) statureStatus = 'ضعیف';
      else if (diff <= -2) statureStatus = 'کمی کوتاه';
      else statureStatus = 'خوبه';
    }
  } catch(e) { console.error('stature calc error', e); }

  // تولید HTML پروفایل (طرح جدید: ستون چپ عکس/وضعیت/یادداشت، ستون راست اطلاعات/مهارت‌ها/جلسات/پرداخت‌ها)
  let profileHtml = `
  <div class="profile-grid" style="display:grid;grid-template-columns:260px 1fr;gap:12px;align-items:start;" id="profileModalContent">
    <div class="profile-left">
      <div class="card" style="text-align:center;padding:16px;">
        <div style="width:160px;height:160px;border-radius:12px;overflow:hidden;margin:0 auto;background:#e2e8f0;">
          ${p.photo ? `<img id="profileImg" src="${p.photo}" style="width:100%;height:100%;object-fit:cover;">` : '<div class="muted">بدون عکس</div>'}
        </div>
        <h3 style="margin-top:12px;">${escapeHtml(p.name || '—')}</h3>
        <div id="categoryDisplay" class="muted" style="cursor:pointer;">رده: ${category || '—'}</div>
  <!-- time-to-next-category removed -->
        <div class="badge ${expired ? 'danger' : expired === false ? '' : 'warning'}" style="margin-top:8px;">بیمه: ${insuranceStatus}</div>
      </div>

      <!-- action buttons: single responsive horizontal row -->
      <div class="card" style="margin-top:8px;padding:12px;">
        <div class="profile-action-row" style="display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:nowrap;">
            <button id="addPaymentFromProfile" class="btn primary" style="flex:1 1 auto;min-width:90px;max-width:220px;">ثبت پرداخت</button>
            <button id="editFromProfile" class="btn" style="flex:1 1 auto;min-width:90px;max-width:220px;">ویرایش</button>
            <button id="shareProfile" class="btn" style="flex:1 1 auto;min-width:90px;max-width:220px;">اشتراک‌گذاری</button>
          </div>
      </div>

      <div class="card" style="margin-top:8px;">
        <div class="section-title"><h3>اطلاعات فردی</h3></div>
        <div style="text-align:right;display:grid;gap:8px;">
          <div><strong>کد ملی:</strong> ${escapeHtml(p.nationalCode || '—')}</div>
          <div><strong>تلفن:</strong> ${escapeHtml(p.phone || '—')}</div>
          <div><strong>نام پدر:</strong> ${escapeHtml(p.fatherName || '—')}</div>
          <div><strong>شماره والد:</strong> ${escapeHtml(p.parentPhone || '—')}</div>
          <div><strong>تاریخ تولد:</strong> ${p.birthdate || '—'}</div>
          <div><strong>سن:</strong> ${typeof age === 'object' ? ( (typeof age.years !== 'undefined' ? age.years : '—') + ' سال، ' + (typeof age.months !== 'undefined' ? age.months : '—') + ' ماه، ' + (typeof age.days !== 'undefined' ? age.days : '—') + ' روز' ) : '—'}</div>
          <div><strong>تاریخ عضویت:</strong> ${p.joinDate || '—'}</div>
          <div><strong>سابقه عضویت:</strong> ${membershipDuration}</div>
        </div>
      </div>

      <div class="card" style="margin-top:8px;">
        <h4 style="margin:0 0 8px 0">وضعیت جسمانی</h4>
        <div>${bmiHtml}</div>
        <div style="margin-top:8px;"><strong>قد:</strong> ${p.height ? p.height + ' cm' : '—'} ${statureStatus ? ('<span class="muted">(' + statureStatus + ')</span>') : ''}</div>
        <div><strong>وزن:</strong> ${p.weight ? p.weight + ' kg' : '—'}</div>
      </div>
    </div>

    <div class="profile-right">
      <div class="card">
        <div class="section-title"><h3>مهارت‌ها و امتیازها</h3></div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
            <div style="display:flex;align-items:center;gap:8px;"><img src="./icons/jersey.png" alt="jersey" style="width:28px;height:28px;object-fit:contain;"> <strong style="margin-right:6px;">${escapeHtml(p.jersey || '—')}</strong></div>
            <div class="muted" style="font-size:13px;">پست: ${escapeHtml(p.favoritePosition || '—')}</div>
          </div>
          <div><strong>امتیاز کلی:</strong> <span class="badge">${avgScore}</span></div>
        </div>
        <div style="margin-top:8px;" class="score-list">
          ${Object.keys(scores).length ? Object.keys(scores).map(key => `<div>${escapeHtml(key)}: ${scores[key] || 0}</div>`).join('') : '<div class="muted">هیچ امتیازی ثبت نشده</div>'}
        </div>

      </div>

  <!-- action-buttons moved to left column -->

  <div class="card" style="margin-top:8px;">
        <div class="section-title"><h3>جلسات اخیر و پرداخت‌ها</h3></div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;">
          <div style="flex:1;min-width:200px;">
            <strong>جلسات شرکت‌کرده (${sessions.length})</strong>
            ${sessions.length ? `<div style="margin-top:8px; max-height:200px; overflow:auto;">${sessions.slice(0,5).map(s => `<div>${escapeHtml(s.title)} - ${s.date} (${s.category})</div>`).join('')}${sessions.length>5?`<div style="margin-top:6px;"><a href="#" class="view-more show-all-sessions">مشاهده همه جلسات (${sessions.length})</a></div>`:''}</div>` : '<div class="muted">هیچ جلسه‌ای</div>'}
          </div>
          <div style="flex:1;min-width:200px;">
            <strong>پرداخت‌ها (${payments.length})</strong>
            ${payments.length ? `<div style="margin-top:8px; max-height:200px; overflow:auto;">${payments.slice(0,5).map(pay => `<div>${pay.amount} تومان - ${pay.date} - ${pay.period} (${escapeHtml(pay.type)})</div>`).join('')}${payments.length>5?`<div style="margin-top:6px;"><a href="#" class="view-more show-all-payments">مشاهده همه پرداخت‌ها (${payments.length})</a></div>`:''}</div>` : '<div class="muted">هیچ پرداختی</div>'}
          </div>
        </div>
      </div>

        <!-- notes moved to the very bottom with add-note button -->
        <div class="card" style="margin-top:8px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <h4 style="margin:0">یادداشت‌ها</h4>
            <button id="addNoteFromProfile" title="یادداشت جدید" class="btn primary" style="padding:8px 12px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.08);">+ افزودن یادداشت</button>
          </div>
          <div id="profileNotesContent" style="display:grid;gap:8px;grid-template-columns:1fr;">${/* notes will be injected by JS */''}</div>
        </div>

        <!-- membership card issuance button inside action area (kept near other actions) -->
        <div style="display:none;"> <!-- placeholder to keep structure clear -->
        </div>
    </div>
  </div>
  `;

  try {
    content.innerHTML = profileHtml;
  } catch (e) {
    console.error('Error setting profile HTML:', e);
    return showView('players');
  }

  // render notes list as cards
  try {
    const notesContainer = qs('#profileNotesContent');
    if (notesContainer) {
      notesContainer.innerHTML = '';
      const notes = p.events && Array.isArray(p.events) ? p.events.slice().reverse() : [];
      if (!notes.length) {
        notesContainer.innerHTML = '<div class="muted">بدون یادداشت</div>';
      } else {
        notes.forEach((n, idx) => {
          const card = document.createElement('div');
          card.className = 'note-card';
          // show author name (if available) before the date
          const authorName = (n && n.author && n.author.name) ? escapeHtml(n.author.name) + ' • ' : '';
          card.innerHTML = `
            <div class="note-meta"><div>${authorName}${escapeHtml(n.date || '')}</div><div class="note-actions"><button class="btn small" data-edit-idx="${idx}">ویرایش</button><button class="btn small danger" data-del-idx="${idx}">حذف</button></div></div>
            <div class="note-body">${escapeHtml(n.text)}</div>
          `;
          notesContainer.appendChild(card);
        });
        // wire edit/delete
        notesContainer.querySelectorAll('[data-edit-idx]').forEach(b => b.addEventListener('click', (e) => {
          const i = Number(e.currentTarget.dataset.editIdx);
          openNotesModal(p.id, i);
        }));
        notesContainer.querySelectorAll('[data-del-idx]').forEach(b => b.addEventListener('click', (e) => {
          const i = Number(e.currentTarget.dataset.delIdx);
          if (confirm('حذف شود؟')) {
            p.events.splice(i, 1);
            saveState();
            renderPlayerProfile(p.id);
          }
        }));
      }
    }
  } catch (e) { console.error('Error rendering notes list', e); }

  // اتصال event listenerها
  try {
  // #closeProfile button was removed from the template; no handler needed
  on('#editFromProfile', 'click', () => showView('player-form', { player: p }));
  on('#addPaymentFromProfile', 'click', () => openPaymentModal(p.id));
  on('#addNoteFromProfile', 'click', () => openNotesModal(p.id, null));
    on('#shareProfile', 'click', () => openPlayerShareOverlay(p.id));
    // Defensive binding: attach direct event handler to the actual element
    try {
      const _sp = qs('#shareProfile');
      if (_sp) {
        // remove previous handler if present
        try { if (_sp._sharedHandler) _sp.removeEventListener('click', _sp._sharedHandler); } catch(_e){}
        _sp._sharedHandler = function(e){ e.preventDefault && e.preventDefault(); try { openPlayerShareOverlay(p.id); } catch(err){ console.error('openPlayerShareOverlay error', err); } };
        _sp.addEventListener('click', _sp._sharedHandler, false);
      }
    } catch(e) { console.warn('defensive shareProfile binding failed', e); }

  // صدور کارت عضویت removed: nothing to wire

    if (qs('.show-all-sessions')) {
      qs('.show-all-sessions').addEventListener('click', () => showView('all-sessions', { playerId: p.id }));
    }
    if (qs('.show-all-payments')) {
      qs('.show-all-payments').addEventListener('click', () => showView('all-payments', { playerId: p.id }));
    }

    // timeToNextDisplay removed — no toggle binding needed

  on('#backProfile', 'click', () => { if (!goBack()) showView('players'); });
  // back button for membership view
  try { on('#backMembership', 'click', () => { if (!goBack()) showView('players'); }); } catch(e) {}
  } catch (e) {
    console.error('Error attaching event listeners:', e);
  }
}

function renderAllSessions(playerId) {
  let title = qs('#allSessionsTitle');
  title.textContent = 'همه جلسات';
  let content = qs('#allSessionsContent');
  let p = state.players.find(x => x.id === playerId);
  if (!p) return;
  let sessions = state.sessions.filter(s => s.attendances?.[p.id]?.present).map(s => ({
    title: s.title || 'جلسه',
    date: isoToJalali(s.date),
    category: s.category
  }));
  
  content.innerHTML = `
    ${sessions.map(s => `
      <div style="padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.1);">
        <div><strong>${s.title}</strong></div>
        <div class="muted">${s.date} • ${s.category || '—'}</div>
      </div>
    `).join('')}
    <div class="form-actions">
      <button id="closeAllSessions" class="btn">بستن</button>
    </div>
  `;
  on('#closeAllSessions', 'click', () => { if (!goBack()) showView('player-profile', {playerId}); });
  on('#backAllSessions', 'click', () => { if (!goBack()) showView('player-profile', {playerId}); });
}

function renderAllPayments(playerId) {
  let title = qs('#allPaymentsTitle');
  title.textContent = 'همه پرداخت‌ها';
  let content = qs('#allPaymentsContent');
  let p = state.players.find(x => x.id === playerId);
  if (!p) return;
  let payments = state.payments.filter(x => x.playerId === p.id).map(pay => ({
    amount: Number(pay.amount).toLocaleString(),
    date: isoToJalali(pay.date),
    period: pay.paymentMonth && pay.paymentYear ? `${pay.paymentMonth}/${pay.paymentYear}` : '—',
    type: pay.type || '—'
  }));
  
  content.innerHTML = `
    ${payments.map(p => `
      <div style="padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.1);">
        <div><strong>${p.amount} تومان</strong></div>
        <div class="muted">${p.date} • دوره: ${p.period} • ${p.type}</div>
      </div>
    `).join('')}
    <div class="form-actions">
      <button id="closeAllPayments" class="btn">بستن</button>
    </div>
  `;
  on('#closeAllPayments', 'click', () => showView('player-profile', {playerId}));
  on('#backAllPayments', 'click', () => { if (!goBack()) showView('player-profile', {playerId}); });
}

// نمایش مودال اشتراک‌گذاری پروفایل (متن، PDF، HTML)
function renderShareProfile(playerId) {
  let title = qs('#shareTitle');
  if (title) title.textContent = 'اشتراک‌گذاری پروفایل';
  let content = qs('#shareContent');
  let p = state.players.find(x => x.id === playerId);
  if (!p) return showView('players');

  let textExport = `پروفایل ${p.name}\nتلفن: ${p.phone || '—'}\nرده: ${determineCategory(calcExactAge(p.birthdate))}\nتوضیحات: ${p.notes || ''}`;

  content.innerHTML = `
    <div style="display:grid;gap:8px;">
      <div><strong>گزینه‌ها:</strong></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="exportText" class="btn">کپی به صورت متن</button>
        <button id="exportHtml" class="btn">دانلود HTML</button>
        <button id="exportPdf" class="btn primary">ساخت PDF</button>
      </div>
      <div style="margin-top:12px;">نمایش پیش‌نمایش:</div>
      <pre id="sharePreview" style="background:#f7fafc;padding:8px;border-radius:6px;max-height:200px;overflow:auto;">${escapeHtml(textExport)}</pre>
    </div>
  `;

  on('#exportText', 'click', () => {
    navigator.clipboard?.writeText(textExport).then(() => alert('متن کپی شد')).catch(() => alert('کپی ناموفق'));
  });

  on('#exportHtml', 'click', () => {
    let html = `<!doctype html><html><head><meta charset="utf-8"><title>پروفایل ${escapeHtml(p.name)}</title></head><body><h1>${escapeHtml(p.name)}</h1><p>تلفن: ${escapeHtml(p.phone || '—')}</p><p>رده: ${escapeHtml(determineCategory(calcExactAge(p.birthdate)))}</p><p>یادداشت‌ها:${escapeHtml(p.notes || '')}</p></body></html>`;
    let blob = new Blob([html], { type: 'text/html' });
    let a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `profile-${p.id}.html`;
    a.click();
  });

  on('#exportPdf', 'click', () => {
    // ساده: از html2canvas و jsPDF استفاده می‌کنیم (اگر jsPDF موجود باشد)
    html2canvas(qs('#profileModalContent'), { backgroundColor: '#fff' }).then(canvas => {
      try {
        if (window.jsPDF) {
          let imgData = canvas.toDataURL('image/png');
          let pdf = new jsPDF({ unit: 'pt', format: 'a4' });
          let ratio = Math.min(595 / canvas.width, 842 / canvas.height);
          pdf.addImage(imgData, 'PNG', 0, 0, canvas.width * ratio, canvas.height * ratio);
          pdf.save(`profile-${p.id}.pdf`);
        } else {
          // fallback: download image
          let a = document.createElement('a');
          a.href = canvas.toDataURL('image/png');
          a.download = `profile-${p.id}.png`;
          a.click();
        }
      } catch (e) {
        console.error('Error exporting PDF:', e);
        alert('شبکهٔ خروجی موفق نشد');
      }
    }).catch(e => { console.error(e); alert('خطا در گرفتن تصویر'); });
  });

  on('#closeShare', 'click', () => showView('player-profile', { playerId }));
}

// نمایش مودال صدور کارت عضویت با خروجی تصویر
function renderMembershipCard(playerId) {
  let title = qs('#membershipTitle'); if (title) title.textContent = 'صدور کارت عضویت';
  let content = qs('#membershipContent');
  let p = state.players.find(x => x.id === playerId);
  if (!p) return showView('players');
  // New layout: settings box, preview box, buttons box
  content.innerHTML = `
    <div style="display:grid;gap:12px;">
      <div class="card" style="display:flex;flex-direction:column;gap:8px;">
        <div style="font-weight:700">تنظیمات کارت</div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="font-size:13px;margin-left:6px">رنگ آغاز</label>
            <input id="memColorA" type="color" value="#06B6D4" />
            <label style="font-size:13px;margin-left:6px">رنگ پایان</label>
            <input id="memColorB" type="color" value="#8B5CF6" />
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="margin-left:6px">رنگ فونت</label>
            <input id="memFontColor" type="color" value="#0f172a" />
          </div>
          <div style="display:flex;gap:10px;align-items:center;margin-top:6px;flex-basis:100%">
            <label style="font-size:13px;margin-right:6px">نمایش در کارت:</label>
            <label style="display:flex;align-items:center;gap:6px"><input id="chkPhoto" type="checkbox" checked /> عکس</label>
            <label style="display:flex;align-items:center;gap:6px"><input id="chkClubLogo" type="checkbox" checked /> لوگوی باشگاه</label>
            <label style="display:flex;align-items:center;gap:6px"><input id="chkBirth" type="checkbox" checked /> تاریخ تولد</label>
            <label style="display:flex;align-items:center;gap:6px"><input id="chkNational" type="checkbox" checked /> کد ملی</label>
            <label style="display:flex;align-items:center;gap:6px"><input id="chkJoinDate" type="checkbox" checked /> تاریخ عضویت</label>
            <label style="display:flex;align-items:center;gap:6px"><input id="chkClubName" type="checkbox" checked /> نام باشگاه</label>
          </div>
        </div>
      </div>

      <div class="card" style="display:flex;flex-direction:column;align-items:center;">
        <div style="font-weight:700;margin-bottom:8px;">پیش‌نمایش کارت عضویت</div>
        <div id="membershipCard" style="position:relative;--card-original-width:520;--card-original-height:380px;--card-scale: min(1, calc((100vw - 32px) / 520));max-width:98vw;max-width:520px;width:100%;min-height:220px;padding:10px;border-radius:12px;background:linear-gradient(135deg,#06B6D4 0%,#8B5CF6 100%);color:#0f172a;direction:rtl;font-family:'Vazirmatn',sans-serif;overflow:hidden;border:1px solid rgba(0,0,0,0.06);">
          <!-- scale wrapper: actual card content is 520px wide and will scale down via transform -->
          <div class="membership-scale-wrapper" style="width:520px;margin:0 auto;transform-origin:top center;">
          <!-- explicit placement for 12 cells (rows adjusted to 30/40/30) -->
          <div id="membershipInnerGrid" style="display:grid;grid-template-rows:auto;grid-auto-rows:1fr;grid-template-columns:repeat(4,1fr);gap:6px;width:100%;min-height:100%;align-items:stretch;">
            <!-- row1 col1 (empty) -->
            <div style="grid-row:1;grid-column:1;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center;color:rgba(15,23,42,0.9);font-weight:700;font-size:18px"></div>
            <!-- 2-3 merged: club name spanning columns 2 and 3 -->
            <div id="cell2" style="grid-row:1;grid-column:2 / span 2;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px">${escapeHtml(state.settings.title || 'باشگاه')}</div>
            <!-- 4: club logo -->
            <div id="cell4" style="grid-row:1;grid-column:4;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center;">
              <img id="pcClubLogoImg" src="${escapeHtml(state.settings.logo || 'icons/logo.png')}" style="max-width:100%;max-height:100%;object-fit:contain" />
            </div>

            <!-- 5: profile photo -->
            <div id="cell5" style="grid-row:2;grid-column:1;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center;">
              ${p.photo?`<img id="pcPhotoImg" src="${p.photo}" style="width:100%;height:100%;object-fit:cover">`:`<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#94a3b8">عکس</div>`}
            </div>
            <!-- 6: stacked player info (span visually) -->
            <div id="cell6" style="grid-row:2;grid-column:2 / span 2;border-radius:6px;padding:6px;display:flex;flex-direction:column;align-items:flex-start;justify-content:center;text-align:left;font-weight:700;">
              <div id="pcName" style="font-size:16px;color:var(--mem-font-color, #0f172a);">${escapeHtml(p.name)}</div>
              <div id="pcBirth" style="font-size:13px;color:var(--mem-font-color, rgba(15,23,42,0.85));margin-top:6px">تاریخ تولد: ${escapeHtml(isoToJalali(p.birthdate) || '—')}</div>
              <div id="pcNational" style="font-size:13px;color:var(--mem-font-color, rgba(15,23,42,0.85));margin-top:6px">کد ملی: ${escapeHtml(p.nationalCode || '—')}</div>
            </div>
            <!-- 7 placeholder (right column of row 2 if needed) -->
            <div id="cell7" style="grid-row:2;grid-column:4;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center;color:rgba(15,23,42,0.9);"></div>

            <!-- 8: volleyball (2) image -->
            <div id="cell8" style="grid-row:3;grid-column:1;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center;color:rgba(15,23,42,0.9);">
              <img src="icons/volleyball (2).png" style="max-width:100%;max-height:100%;object-fit:contain" />
            </div>
            <!-- 9-10 merged: join & expiry stacked (join emphasized) -->
            <div id="cell9" style="grid-row:3;grid-column:2 / span 2;border-radius:6px;padding:6px;display:flex;flex-direction:column;align-items:flex-start;justify-content:center;text-align:left;">
              <div id="pcJoinDate" style="font-size:15px;font-weight:800">تاریخ عضویت: ${escapeHtml(p.joinDate || '—')}</div>
              <div id="pcExpire" style="margin-top:6px;font-size:13px">تاریخ انقضا: ${escapeHtml(p.expiryDate || 'مادام\u200cالعمر')}</div>
            </div>
            <!-- 11: volleyball-player centered -->
            <div id="cell11" style="grid-row:3;grid-column:4;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center;color:rgba(15,23,42,0.9);">
              <img src="icons/volleyball-player.png" style="max-width:70%;max-height:70%;object-fit:contain" />
            </div>
            <!-- 12 placeholder (unused) -->
            <div id="cell12" style="display:none"></div>
          </div>
          </div>
          <!-- overlay removed - volleyball icons moved into cells 8 and 11 -->
        </div>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-start;">
        <button id="downloadCardImage" class="btn primary">دانلود کارت</button>
        <button id="shareCard" class="btn">اشتراک‌گذاری</button>
        <button id="printCard" class="btn">چاپ</button>
      </div>
    </div>
  `;

  // wire settings -> preview updates
  (function(){
    const card = qs('#membershipCard');
    const colorA = qs('#memColorA');
    const colorB = qs('#memColorB');
    
    const pcPhoto = qs('#pcPhoto');
    const pcPhotoImg = qs('#pcPhotoImg');
    const pcClubLogo = qs('#pcClubLogo');
    const pcClubLogoImg = qs('#pcClubLogoImg');
    const pcBirth = qs('#pcBirth');
    const pcNational = qs('#pcNational');
    const pcJoinDate = qs('#pcJoinDate');
    const pcClubName = qs('#pcClubName');
  const memFontColor = qs('#memFontColor');
  // checkboxes
  const chkPhoto = qs('#chkPhoto');
  const chkClubLogo = qs('#chkClubLogo');
  const chkBirth = qs('#chkBirth');
  const chkNational = qs('#chkNational');
  const chkJoinDate = qs('#chkJoinDate');
  const chkClubName = qs('#chkClubName');

  function applyColors(){
      const a = colorA ? colorA.value : '#06B6D4';
      const b = colorB ? colorB.value : '#8B5CF6';
      if (card) card.style.background = `linear-gradient(135deg, ${a} 0%, ${b} 100%)`;
      // apply font color/weight CSS variables
      const fc = memFontColor ? memFontColor.value : '#0f172a';
  const fw = '700';
      if (card) {
        card.style.setProperty('--mem-font-color', fc);
        // apply to specific elements as inline style too for better html2canvas capture
        const nameEl = qs('#pcName'); if (nameEl) { nameEl.style.color = fc; nameEl.style.fontWeight = fw; }
        const birthEl = qs('#pcBirth'); if (birthEl) { birthEl.style.color = fc; birthEl.style.fontWeight = fw; }
        const natEl = qs('#pcNational'); if (natEl) { natEl.style.color = fc; natEl.style.fontWeight = fw; }
      }
    }
    function applyVisibility(){
  if (pcPhoto) pcPhoto.style.display = (chkPhoto && chkPhoto.checked) ? 'block' : 'none';
  if (pcClubLogoImg) pcClubLogoImg.style.display = (chkClubLogo && chkClubLogo.checked) ? 'block' : 'none';
  if (pcBirth) pcBirth.style.display = (chkBirth && chkBirth.checked) ? 'block' : 'none';
  if (pcNational) pcNational.style.display = (chkNational && chkNational.checked) ? 'block' : 'none';
  if (pcJoinDate) pcJoinDate.style.display = (chkJoinDate && chkJoinDate.checked) ? 'block' : 'none';
  if (pcClubName) pcClubName.style.display = (chkClubName && chkClubName.checked) ? 'block' : 'none';
    }
    // compute and apply scale for the inner wrapper so the whole card scales proportionally
    function applyCardScale(){
      const wrapper = qs('.membership-scale-wrapper');
      if (!wrapper || !card) return;
      // available width inside card (accounting for card padding)
      const padding = 20; // approximate
      const avail = Math.max(200, card.clientWidth - padding);
      const base = 520; // design width
      let scale = Math.min(1, avail / base);
      if (scale < 0.5) scale = 0.5; // minimum readable
      // Instead of transform, resize the wrapper so the parent flow adapts
      const newWidth = Math.round(base * scale);
      wrapper.style.width = newWidth + 'px';
      // scale fonts by adjusting root font-size on the wrapper
      const baseFont = 16; // reference
      wrapper.style.fontSize = (baseFont * scale) + 'px';
      // adjust images max-height proportional to scale
      const imgs = wrapper.querySelectorAll('img');
      imgs.forEach(i => { i.style.maxHeight = Math.round(140 * scale) + 'px'; });
    }
    // run on init and on resize
    applyCardScale();
    window.addEventListener('resize', applyCardScale);
    if (colorA) colorA.addEventListener('input', applyColors);
    if (colorB) colorB.addEventListener('input', applyColors);
    if (memFontColor) memFontColor.addEventListener('input', applyColors);
    [chkPhoto,chkClubLogo,chkBirth,chkNational,chkJoinDate,chkClubName].forEach(ch=>{ if (ch) ch.addEventListener('change', applyVisibility); });
    // run initial
    applyColors(); applyVisibility();
  applyCardScale();

  // ensure club logo fallback
  if (pcClubLogoImg && (!pcClubLogoImg.src || pcClubLogoImg.src.trim()==='')) pcClubLogoImg.src = 'icons/logo.png';

    // download/share/print handlers (reuse existing share/download logic for cards)
    const downloadBtn = qs('#downloadCardImage');
    const shareBtn = qs('#shareCard');
    const printBtn = qs('#printCard');
    async function captureCardAndDownload(){
      try{
        const outCanvas = document.createElement('canvas'); outCanvas.width = 1080; outCanvas.height = 640; const ctx = outCanvas.getContext('2d');
        // draw gradient background
  const colA = colorA ? colorA.value : '#e0f2fe'; const colB = colorB ? colorB.value : '#bae6fd';
        const g = ctx.createLinearGradient(0,0,0,outCanvas.height); g.addColorStop(0,colA); g.addColorStop(1,colB); ctx.fillStyle = g; ctx.fillRect(0,0,outCanvas.width,outCanvas.height);
        // render simple text and images by drawing img elements where available
        // draw club logo (right)
        const logoImg = pcClubLogoImg && pcClubLogoImg.src ? await loadImage(pcClubLogoImg.src) : null;
  const photoImg = pcPhotoImg && pcPhotoImg.src ? await loadImage(pcPhotoImg.src) : null;
        if (logoImg) ctx.drawImage(logoImg, outCanvas.width-140, 40, 96, 96);
        if (photoImg) ctx.drawImage(photoImg, 40, 160, 176, 176);
        // draw name and stacked info (approx positions)
        ctx.fillStyle = '#0f172a'; ctx.font = '700 48px Vazirmatn, sans-serif'; ctx.textAlign='left';
        const nameX = 240; const nameY = 210;
        ctx.fillText((qs('#pcName')?.textContent)||'', nameX, nameY);
        ctx.font = '400 28px Vazirmatn, sans-serif';
  // show birth/national if present
  const birthText = (qs('#pcBirth')?.textContent) || '';
  const natText = (qs('#pcNational')?.textContent) || '';
  if (birthText) ctx.fillText(birthText, nameX, nameY + 48);
  if (natText) ctx.fillText(natText, nameX, nameY + 92);
        // validity bottom-left and volleyball icon bottom-right
  ctx.font = '400 24px Vazirmatn, sans-serif';
  // expiry default to مادام‌العمر if empty
  const expiryText = (qs('#pcExpire')?.textContent) || 'تاریخ انقضا: مادام‌العمر';
  ctx.fillText(expiryText, 36, outCanvas.height - 36);
        const volleyImg = await loadImage('icons/volleyball-player.png');
        if (volleyImg) ctx.drawImage(volleyImg, outCanvas.width - 76, outCanvas.height - 76, 64, 64);
        const blob = await new Promise(res => outCanvas.toBlob(res,'image/png'));
        if (!blob) throw new Error('capture failed');
  const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href=url; link.download = `${escapeFileName(p.name)}-membership.png`; document.body.appendChild(link); link.click(); link.remove(); URL.revokeObjectURL(url);
      } catch(err){ console.error('capture failed',err); alert('خطا در تولید تصویر کارت'); }
    }
    if (downloadBtn) downloadBtn.addEventListener('click', captureCardAndDownload);
    if (shareBtn) shareBtn.addEventListener('click', async ()=>{ try{ await captureCardAndDownload(); alert('تصویر برای اشتراک تهیه شد'); }catch(e){console.warn(e);} });
    if (printBtn) printBtn.addEventListener('click', ()=>{ window.print(); });

    // helper to load image
    function loadImage(src){ return new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=(e)=>res(null); i.src=src; }); }
    function escapeFileName(s){ return (s||'card').replace(/[^a-z0-9\-_.]/gi,'_'); }
  })();

  // header back should return to player profile
  try { on('#backMembership', 'click', () => { if (!goBack()) showView('player-profile', { playerId }); }); } catch(e) { }

  // دانلود تصویر کارت
  on('#downloadCardImage', 'click', () => {
    html2canvas(qs('#membershipCard'), { backgroundColor: null, scale: 2 }).then(canvas => {
      let a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = `membership-${p.id}.png`;
      a.click();
    }).catch(e => { console.error(e); alert('خطا در ساخت تصویر'); });
  });

  // دانلود تصویر کارت
  on('#downloadCardImage', 'click', () => {
    html2canvas(qs('#membershipCard'), { backgroundColor: null, scale: 2 }).then(canvas => {
      let a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = `membership-${p.id}.png`;
      a.click();
    }).catch(e => { console.error(e); alert('خطا در ساخت تصویر'); });
  });

  // اشتراک‌گذاری کارت: ابتدا تلاش برای Web Share با فایل، سپس fallback به تصویر دانلود
  on('#shareCard', 'click', () => {
    html2canvas(qs('#membershipCard'), { backgroundColor: null, scale: 2 }).then(canvas => {
      canvas.toBlob(blob => {
        if (!blob) return alert('خطا در تهیه تصویر');
        let file = new File([blob], `membership-${p.id}.png`, { type: 'image/png' });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({ files: [file], title: `کارت عضویت ${p.name}`, text: 'کارت عضویت' }).catch(() => alert('اشتراک‌گذاری شکست خورد'));
        } else if (navigator.share) {
          // بعضی مرورگرها share را بدون files پشتیبانی می‌کنند
          let url = URL.createObjectURL(file);
          navigator.share({ title: `کارت عضویت ${p.name}`, text: 'کارت عضویت', url }).catch(() => alert('اشتراک‌گذاری شکست خورد'));
        } else {
          // fallback: دانلود تصویر و اطلاع دادن به کاربر
          let a = document.createElement('a');
          a.href = URL.createObjectURL(file);
          a.download = `membership-${p.id}.png`;
          a.click();
          alert('اشتراک‌گذاری مستقیم پشتیبانی نمی‌شود؛ تصویر دانلود شد.');
        }
      }, 'image/png');
    }).catch(e => { console.error(e); alert('خطا در آماده‌سازی تصویر برای اشتراک‌گذاری'); });
  });

  on('#printCard', 'click', () => {
    let w = window.open('', '_blank');
    w.document.write('<html><head><meta charset="utf-8"><title>کارت عضویت</title><style>body{margin:0;padding:20px;background:#fff}</style></head><body>' + qs('#membershipCard').outerHTML + '</body></html>');
    w.document.close();
    w.focus();
    w.print();
  });
  // no bottom close button; header back handles return to profile
}

// Notes modal helpers (global)
function openNotesModal(playerId, noteIndex) {
  let p = state.players.find(x => x.id === playerId);
  if (!p) return alert('بازیکن پیدا نشد'); // Check if player exists
  // helper to populate coach/author select (kept local to this modal)
  function populateNotesAuthorsLocal() {
    try {
      const sel = qs('#notesAuthorSelect'); if (!sel) return;
      sel.innerHTML = '';
      const coaches = (state.coaches || []);
      if (!coaches.length) {
        const o = document.createElement('option'); o.value = ''; o.textContent = '— بدون مربی —'; sel.appendChild(o);
        return;
      }
      const empty = document.createElement('option'); empty.value = ''; empty.textContent = 'انتخاب مربی'; sel.appendChild(empty);
      coaches.forEach(c => {
        const o = document.createElement('option'); o.value = c.id; o.textContent = c.name || c.title || ('مربی'); sel.appendChild(o);
      });
    } catch (e) { console.warn('populateNotesAuthorsLocal failed', e); }
  }
  // Additional logic can be added here
  // create modal if not exists
  let m = qs('#notesModalGlobal');
  if (!m) {
    m = document.createElement('div');
    m.id = 'notesModalGlobal';
    m.className = 'modal hide';
    m.setAttribute('role', 'dialog');
    m.setAttribute('aria-modal', 'true');
    m.innerHTML = `
      <div class="modal-content">
        <div class="modal-header" style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
          <div style="display:flex;align-items:center;gap:8px;">
            <h3 id="notesModalTitle">یادداشت مربی</h3>
            <select id="notesAuthorSelect" class="input" style="min-width:160px;font-size:13px;padding:6px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);"></select>
          </div>
        </div>
        <div class="modal-body"><textarea id="notesGlobalInput" placeholder="نقاط قوت و ضعف..."></textarea></div>
        <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:8px;"><button class="btn" id="notesCloseBtn">بستن</button> <button class="btn primary" id="notesSaveBtn">ذخیره</button></div>
      </div>`;
    document.body.appendChild(m);
    // populate authors into the select
    populateNotesAuthorsLocal();
    on('#notesCloseBtn', 'click', () => closeNotesModal());
    on('#notesSaveBtn', 'click', () => {
      try {
        let txt = qs('#notesGlobalInput').value.trim();
        if (!p.events) p.events = [];
        const sel = qs('#notesAuthorSelect');
        const selId = sel ? sel.value : '';
        const coach = (state.coaches || []).find(c => c.id === selId) || null;
        const author = coach ? { id: coach.id, name: coach.name } : null;
        if (m._editingIndex >= 0) {
          // edit existing (preserve author if none selected)
          const prev = p.events[m._editingIndex] || {};
          p.events[m._editingIndex] = { date: todayJalali(), text: txt, author: (author || prev.author || null) };
        } else {
          // new note
          p.events.push({ date: todayJalali(), text: txt, author });
        }
        p.notes = p.events.length ? p.events[p.events.length - 1].text : '';
        saveState();
        closeNotesModal();
        renderPlayerProfile(playerId);
      } catch (err) { console.error('notes save handler failed', err); alert('خطا هنگام ذخیره یادداشت'); }
    });
    // close when clicking backdrop (outside modal-content)
    m.addEventListener('click', (ev) => {
      if (ev.target === m) closeNotesModal();
    });
  }
  // prepare modal state
  m._editingIndex = (typeof noteIndex !== 'undefined' && noteIndex !== null) ? noteIndex : -1;
  if (m._editingIndex >= 0) {
    qs('#notesModalTitle').textContent = 'ویرایش یادداشت';
    qs('#notesGlobalInput').value = (p.events && p.events[m._editingIndex]) ? p.events[m._editingIndex].text : '';
  // set author select to existing note author if present
  try { const sel = qs('#notesAuthorSelect'); if (sel) { const existing = (p.events && p.events[m._editingIndex] && p.events[m._editingIndex].author) ? p.events[m._editingIndex].author.id : ''; if (existing) { sel.value = existing; } else { sel.value = ''; } } } catch(e){}
  } else {
    qs('#notesModalTitle').textContent = 'یادداشت جدید';
    qs('#notesGlobalInput').value = '';
  // ensure authors are freshly populated
  try { populateNotesAuthorsLocal(); } catch(e) {}
  }
  m.classList.remove('hide');
  // focus textarea for faster entry
  setTimeout(() => {
    let ta = qs('#notesGlobalInput'); if (ta) ta.focus();
  }, 60);
}

function closeNotesModal() {
  let m = qs('#notesModalGlobal');
  if (!m) return;
  m.classList.add('hide');
}

function renderInsurancePage() {
  let list = qs('#insuranceList');
  list.innerHTML = '';
  let cat = qs('#insuranceCategoryFilter').value;
  let status = qs('#insuranceStatusFilter').value;
  let arr = state.players.slice();
  if (cat) arr = arr.filter(p => p.category === cat);
  if (status === 'active') arr = arr.filter(p => p.insuranceDate && !isInsuranceExpired(p.insuranceDate));
  if (status === 'expired') arr = arr.filter(p => p.insuranceDate && isInsuranceExpired(p.insuranceDate));
  if (status === 'none') arr = arr.filter(p => !p.insuranceDate);
  arr.forEach(p => {
    let node = document.createElement('div');
    node.className = 'player-row';
    let imgHtml = p.photo ? `<img src="${p.photo}">` : `<svg width="36" height="36" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>`;
    let exp = isInsuranceExpired(p.insuranceDate);
    let st = p.insuranceDate ? (exp ? 'منقضی' : 'فعال') : 'بدون بیمه';
    let badgeClass = p.insuranceDate ? (exp ? 'danger' : 'success') : 'warning';
    node.innerHTML = `
      <div class="player-thumb">${imgHtml}</div>
      <div class="meta"><strong>${escapeHtml(p.name)}</strong><small>${p.category || '—'} • ${p.insuranceDate || '—'}</small></div>
      <div class="badge ${badgeClass}">${st}</div>
      <button class="btn small edit-ins-btn">ویرایش</button>
    `;
    node.querySelector('.edit-ins-btn').addEventListener('click', () => showView('player-form', {player: p}));
    list.appendChild(node);
  });
  populateCategoryFilter(qs('#insuranceCategoryFilter'));
}

function calculateBMI(heightCm, weightKg) {
  if (!heightCm || !weightKg) return null;
  let heightM = heightCm / 100;
  let bmi = (weightKg / (heightM * heightM)).toFixed(1);
  let status, color, percent;
  let idealWeight = heightM * heightM * 22.5; // BMI ایده‌آل متوسط 22.5
  let excessWeight = weightKg - idealWeight;
  if (bmi < 18.5) { status = 'کم وزن'; color = '#fbbf24'; percent = (bmi / 18.5) * 25; }
  else if (bmi < 25) { status = 'سالم'; color = '#22c55e'; percent = 25 + ((bmi - 18.5) / 6.5) * 25; }
  else if (bmi < 30) { status = 'اضافه وزن'; color = '#f59e0b'; percent = 50 + ((bmi - 25) / 5) * 25; }
  else { status = 'چاق'; color = '#ef4444'; percent = 75 + ((bmi - 30) / 10) * 25; }
  percent = Math.min(100, percent);
  return { bmi, status, color, percent, excessWeight };
}

function renderHealthPage() {
  let list = qs('#healthList');
  list.innerHTML = '';
  let q = normPersian(qs('#healthSearch').value || '');
  let bmiFilter = qs('#healthBmiFilter').value;
  let arr = state.players.slice();
  if (q) arr = arr.filter(p => normPersian(p.name).includes(q));
  if (bmiFilter) arr = arr.filter(p => {
    let bmiData = calculateBMI(p.height, p.weight);
    return bmiData && bmiData.status === bmiFilter;
  });
  arr.forEach(p => {
    let bmiData = calculateBMI(p.height, p.weight);
    let bmiHtml = bmiData ? `
      <div class="bmi-bar">
        <div class="bmi-fill" style="width: ${bmiData.percent}%; background: ${bmiData.color};"></div>
      </div>
      <small>${bmiData.bmi} - ${bmiData.status}</small>
      <small>چربی تقریبی بدن: ${(bmiData.bmi * 1.2).toFixed(1)}%</small>
      <small>اضافه وزن: ${bmiData.excessWeight.toFixed(1)} kg</small>
    ` : '<div class="muted">اطلاعات کافی نیست (قد/وزن)</div>';
    let eventsHtml = p.events.length > 0 ? p.events.map((e, idx) => `
      <div class="event-item">
        <div class="event-text">${e.text} (${e.date})</div>
        <div class="event-actions">
          <button class="btn small edit-event-btn">ویرایش</button>
          <button class="btn small danger delete-event-btn">حذف</button>
        </div>
      </div>
    `).join('') : '<div class="muted">بدون رویداد</div>';
    let card = document.createElement('div');
    card.className = 'health-card';
    card.innerHTML = `
      <div style="display: flex; gap: 12px; align-items: center;">
        <div class="player-thumb">${p.photo ? `<img src="${p.photo}">` : '<svg width="56" height="56" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>'}</div>
        <div>
          <strong>${escapeHtml(p.name)}</strong>
          <small>${p.category || '—'}</small>
        </div>
      </div>
      ${bmiHtml}
      <div style="margin-top: 8px;"><strong>رویدادها:</strong>
        <div class="event-list">${eventsHtml}</div>
      </div>
      <button class="btn small event-btn add-event-btn">ثبت رویداد</button>
    `;
    card.querySelector('.player-thumb').addEventListener('click', () => showView('player-profile', {playerId: p.id}));
    card.querySelector('.add-event-btn').addEventListener('click', () => showView('event-form', {playerId: p.id}));
    let eventItems = card.querySelectorAll('.event-item');
    eventItems.forEach((item, idx) => {
      item.querySelector('.edit-event-btn').addEventListener('click', () => showView('event-form', {playerId: p.id, eventIndex: idx}));
      item.querySelector('.delete-event-btn').addEventListener('click', () => deleteEvent(p.id, idx));
    });
    list.appendChild(card);
  });
  on('#healthSearch', 'input', renderHealthPage);
  on('#healthBmiFilter', 'change', renderHealthPage);
  on('#addHealthEventBtn', 'click', () => {
    let playerId = prompt('شناسه بازیکن را وارد کنید');
    if (playerId) showView('event-form', {playerId});
  });
}

function getExtensionFromContentType(type) {
  if (!type) return '.png';
  if (type.includes('jpeg')) return '.jpg';
  if (type.includes('png')) return '.png';
  if (type.includes('gif')) return '.gif';
  if (type.includes('svg')) return '.svg';
  return '.bin';
}

function renderEventForm(playerId, eventIndex = -1) {
  let title = qs('#eventFormTitle');
  title.textContent = eventIndex >= 0 ? 'ویرایش رویداد' : 'ثبت رویداد';
  let content = qs('#eventFormContent');
  let p = state.players.find(x => x.id === playerId);
  if (!p) return alert('بازیکن پیدا نشد');
  let event = eventIndex >= 0 ? p.events[eventIndex] : { text: '', date: todayJalali() };
  content.innerHTML = `
    <textarea id="eventText" class="input" placeholder="توضیح رویداد..." style="height: 100px; margin-top: 12px;">${event.text}</textarea>
    <label for="eventDate">تاریخ رویداد</label>
    <input id="eventDate" class="input jalali-input" value="${event.date}" />
    <div class="form-actions">
      <button id="saveEvent" class="btn primary">ذخیره</button>
      <button id="cancelEvent" class="btn">انصراف</button>
    </div>
  `;
  on('#cancelEvent', 'click', () => showView('health'));
  on('#saveEvent', 'click', () => {
    let text = qs('#eventText').value.trim();
    let date = qs('#eventDate').value || todayJalali();
    if (text) {
      if (eventIndex >= 0) {
        p.events[eventIndex] = { text, date };
      } else {
        p.events.push({ text, date });
      }
      saveState();
      showView('health');
    } else {
      alert('توضیح رویداد را وارد کنید');
    }
  });
  on('#backEventForm', 'click', () => { if (!goBack()) showView('health'); });
}

function deleteEvent(playerId, index) {
  if (confirm('حذف شود؟')) {
    let p = state.players.find(x => x.id === playerId);
    if (p) p.events.splice(index, 1);
    saveState();
    renderHealthPage();
  }
}

function renderSettings() {
  let content = qs('#settingsContent');
  let dataSize = (localStorage.getItem(STORAGE_KEY)?.length / 1024 || 0).toFixed(2);
  let lastUpdate = state.settings.lastCategoryUpdate || '11 دی 1403';
  // determine display date and color for ranks reference based on mode
  const refMode = state.settings.ranksRefMode || 'auto';
  let displayDate;
  if (refMode === 'auto'){
    const today = todayJalali();
    const parts = today.split('/').map(Number);
    const cutoffThisYear = `${parts[0]}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
    const cutoffNextYear = `${parts[0]+1}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
    displayDate = (jalaliToISO(today) <= jalaliToISO(cutoffThisYear)) ? cutoffThisYear : cutoffNextYear;
  } else {
    displayDate = state.settings.ranksReferenceDate || lastUpdate;
  }
  const displayColor = (refMode === 'auto') ? '#137333' : '#92400e';
  content.innerHTML = `
    <div style="display: grid; gap: 18px; margin-top: 12px;">
  <label for="settingsTitle" style="font-size:15px;">عنوان برنامه</label>
  <input id="settingsTitle" class="input" value="${state.settings.title}" style="font-size:20px;padding:12px;" />
  <hr style="border:none;border-top:1px solid rgba(0,0,0,0.04);" />
  <label style="font-size:15px;">لوگو</label>
      <div style="display:flex;align-items:center;gap:12px;">
        <input id="settingsLogo" type="file" accept="image/*" />
        <img id="settingsLogoPreview" src="${escapeHtml(state.settings.logo || 'icons/icon-192.png')}" style="width:56px;height:56px;border-radius:8px;object-fit:cover;border:1px solid rgba(0,0,0,0.06);" />
      </div>
  <hr style="border:none;border-top:1px solid rgba(0,0,0,0.04);" />
  <label style="font-size:15px;">سبک برنامه</label>
  <select id="settingsStyle" class="input" style="font-size:16px;padding:10px;">
        <option value="modern" ${state.settings.style === 'modern' ? 'selected' : ''}>سبک مدرن و دوستانه</option>
        <option value="fun" ${state.settings.style === 'fun' ? 'selected' : ''}>سبک شاد و رنگی</option>
        <option value="luxury" ${state.settings.style === 'luxury' ? 'selected' : ''}>سبک لوکس و حرفه‌ای</option>
      </select>
  <hr style="border:none;border-top:1px solid rgba(0,0,0,0.04);" />
  <div style="display:flex;align-items:center;gap:8px;">
    <div style="flex:1;">مرجع آپدیت رده‌ها: <strong style="color:${displayColor};font-weight:700;">${displayDate}</strong></div>
      <div style="flex:0;">
      <button id="openRankEditorFromSettings" class="btn small" style="background:linear-gradient(90deg,#facc15,#f59e0b);color:#111;padding:8px 12px;font-weight:700;box-shadow:0 4px 10px rgba(0,0,0,0.09);">ویرایش رده‌ها</button>
    </div>
  </div>
  <hr style="border:none;border-top:1px solid rgba(0,0,0,0.04);" />
  <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:6px;">
    <button id="backupBtnInSettings" class="btn">ذخیره بک آپ در دستگاه</button>
    <button id="shareBackupBtn" class="btn">اشتراک‌گذاری بک آپ</button>
    <button id="restoreBtnInSettings" class="btn">وارد کردن بک‌آپ (ZIP/JSON)</button>
    <button id="clearAllData" class="btn danger">پاک کردن تمام داده‌ها</button>
  </div>
  <div class="form-actions" style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
    <button id="saveSettings" class="btn primary">ذخیره</button>
  </div>
  <hr style="margin-top:16px;border:none;border-top:1px solid rgba(0,0,0,0.06);" />
  <div style="margin-top:8px;color:var(--muted);font-size:13px;text-align:center;"> 
    <div>برنامه طراحی شده توسط پوریا عابدی</div>
    <div style="margin-top:6px;">حجم داده‌های ذخیره شده: ${dataSize} KB</div>
  </div>
    </div>
  `;
  // direct binding: button exists after innerHTML assignment
  const openRankBtn = qs('#openRankEditorFromSettings');
  if (openRankBtn) openRankBtn.addEventListener('click', () => showView('rank-editor'));
  on('#cancelSettings', 'click', () => showView('account'));
  on('#saveSettings', 'click', () => {
    state.settings.title = qs('#settingsTitle').value || 'مدیریت باشگاه والیبال';
    state.settings.style = qs('#settingsStyle').value;
    let file = qs('#settingsLogo').files[0];
    if (file) {
      imageFileToDataURL(file, 100).then(data => {
        state.settings.logo = data;
        saveState();
        applySettings();
        showView('account');
        renderHome();
      });
    } else {
      saveState();
      applySettings();
      showView('account');
      renderHome();
    }
  });
  // Create backup: JSON + player profile images inside folder, zipped automatically
  on('#backupBtnInSettings', 'click', async () => {
    try {
      const zip = new JSZip();
      // add JSON state
      const jsonStr = JSON.stringify(state, null, 2);
      zip.file('volleyball_backup.json', jsonStr);
      // add images under folder 'player_images/'
      const imgFolder = zip.folder('player_images');
      // gather unique image URLs from players
      const imgs = [...new Set((state.players || []).map(p => p.photo).filter(Boolean))];
      for (let i = 0; i < imgs.length; i++) {
        const url = imgs[i];
        try {
          // if data URL already, use it directly
          if (String(url).startsWith('data:')) {
            // convert dataURL to binary and add
            const dataParts = url.split(',');
            const meta = dataParts[0];
            const b64 = dataParts[1];
            const content = atob(b64);
            const arr = new Uint8Array(content.length);
            for (let j = 0; j < content.length; j++) arr[j] = content.charCodeAt(j);
            imgFolder.file(`image_${i}.png`, arr);
          } else {
            const resp = await fetch(url);
            const blob = await resp.blob();
            imgFolder.file(`image_${i}${getExtensionFromContentType(blob.type)}`, blob);
          }
        } catch (e) {
          console.warn('Failed to fetch image for backup', url, e);
        }
      }
      const content = await zip.generateAsync({type: 'blob'});
      const backupName = `volleyball_backup_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.zip`;
      // trigger download
      const a = document.createElement('a');
      a.href = URL.createObjectURL(content);
      a.download = backupName;
      a.click();
      URL.revokeObjectURL(a.href);
    } catch (e) {
      console.error('Backup failed', e);
      alert('خطا در تولید بک‌آپ');
    }
  });

  // Share backup: create zip and call navigator.share if available, fallback to download
  on('#shareBackupBtn', 'click', async () => {
    try {
      const zip = new JSZip();
      zip.file('volleyball_backup.json', JSON.stringify(state, null, 2));
      const imgFolder = zip.folder('player_images');
      const imgs = [...new Set((state.players || []).map(p => p.photo).filter(Boolean))];
      for (let i = 0; i < imgs.length; i++) {
        const url = imgs[i];
        try {
          if (String(url).startsWith('data:')) {
            const dataParts = url.split(',');
            const b64 = dataParts[1];
            const content = atob(b64);
            const arr = new Uint8Array(content.length);
            for (let j = 0; j < content.length; j++) arr[j] = content.charCodeAt(j);
            imgFolder.file(`image_${i}.png`, arr);
          } else {
            const resp = await fetch(url);
            const blob = await resp.blob();
            imgFolder.file(`image_${i}${getExtensionFromContentType(blob.type)}`, blob);
          }
        } catch (e) { console.warn('image fetch failed', url, e); }
      }
      const content = await zip.generateAsync({type: 'blob'});
      const file = new File([content], `volleyball_backup_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.zip`, { type: 'application/zip' });
      // try navigator.share safely
      let canShareFiles = false;
      try {
        canShareFiles = !!(navigator.canShare && typeof navigator.canShare === 'function' && navigator.canShare({ files: [file] }));
      } catch (e) { console.warn('navigator.canShare error', e); }
      if (canShareFiles) {
        try { await navigator.share({ files: [file], title: 'Backup Volleyball App', text: 'بک‌آپ داده‌های باشگاه' }); return; } catch(e) { console.warn('share files failed', e); }
      } else {
        // inform user that file-sharing is not available in this browser
        alert('اشتراک‌گذاری فایل در این مرورگر پشتیبانی نمی‌شود. لطفاً از گوشی همراه استفاده کنید یا فایل را دانلود کنید.');
      }
      try {
        if (navigator.share && typeof navigator.share === 'function') {
          // some platforms don't support files but accept URLs
          try {
            await navigator.share({ title: 'Backup Volleyball App', text: 'بک‌آپ داده‌های باشگاه' });
            // as a fallback, still offer download if share didn't include files
          } catch (err) {
            console.warn('navigator.share without files failed', err);
          }
        }
      } catch (e) { console.warn('navigator.share error', e); }
      // fallback to download with clear user notice
      const a = document.createElement('a');
      a.href = URL.createObjectURL(content);
      a.download = `volleyball_backup_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.zip`;
      a.click();
      URL.revokeObjectURL(a.href);
    } catch (e) {
      console.error('Share backup failed', e);
      alert('اشتراک‌گذاری ممکن نبود؛ فایل دانلود شد یا خطا رخ داده است');
    }
  });
  // logo preview handler (after elements exist)
  setTimeout(() => {
    const logoInput = qs('#settingsLogo');
    const logoPreview = qs('#settingsLogoPreview');
    if (logoInput && logoPreview) {
      logoInput.addEventListener('change', async (ev) => {
        const f = ev.target.files[0];
        if (!f) return;
        const data = await imageFileToDataURL(f, 100).catch(() => null);
        if (data) logoPreview.src = data;
      });
    }
  }, 50);
  on('#restoreBtnInSettings', 'click', () => {
    let input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,.zip';
    input.onchange = async e => {
      let file = e.target.files[0];
      if (!file) return;
      try {
        if (file.name.endsWith('.zip')) {
          const jszip = new JSZip();
          const z = await jszip.loadAsync(file);
          if (z.files['volleyball_backup.json']) {
            const txt = await z.files['volleyball_backup.json'].async('string');
            state = JSON.parse(txt);
            saveState();
            alert('بک‌آپ وارد شد');
            location.reload();
          } else {
            alert('فایل ZIP معتبر نیست');
          }
        } else {
          const text = await file.text();
          state = JSON.parse(text);
          saveState();
          alert('بک‌آپ وارد شد');
          location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('خطا در وارد کردن بک‌آپ');
      }
    };
    input.click();
  });
  on('#clearAllData', 'click', () => {
    if (confirm('آیا مطمئن هستید که می‌خواهید تمام داده‌ها را پاک کنید؟')) {
      localStorage.clear();
      state = {};
      seedSample();
      saveState();
      alert('تمام داده‌ها پاک شد');
      location.reload();
    }
  });
  on('#backSettings', 'click', () => { showView('account'); });
}

function openPaymentModal(playerId) {
  showView('payments');
  qs('#paymentPlayer').value = playerId;
  let player = state.players.find(x => x.id === playerId);
  if (player) qs('#paymentPlayerSearch').value = player.name;
}

/* ================================================================
  SECTION: Jalali Datepicker & Calendar UI
  - calendar rendering, input attaching, show/hide helpers
  ================================================================ */
/* Jalali Datepicker */
const calendar = qs('#jalaliCalendar');
let activeInput = null;

function showJalaliCalendar(inputEl) {
  activeInput = inputEl;
  calendar.innerHTML = '';
  calendar.classList.remove('hide');
  calendar.setAttribute('aria-hidden', 'false');
  // Use CSS fixed centering; do not position relative to input to ensure consistent centered display
  calendar.style.top = '';
  calendar.style.left = '';
  calendar.style.transform = 'translate(-50%, -50%)';
  let cur = inputEl.value && inputEl.value.match(/^\d{4}\/\d{2}\/\d{2}$/) ? inputEl.value : todayJalali();
  let parts = cur.split('/').map(Number);
  renderCalendar(parts[0], parts[1], parts[2]);
}

function hideJalaliCalendar() {
  calendar.classList.add('hide');
  calendar.setAttribute('aria-hidden', 'true');
  calendar.innerHTML = '';
  if (activeInput && activeInput.id === 'p_birth') {
    try { if (typeof updateCategoryAndPosition === 'function') updateCategoryAndPosition(); } catch(_){ }
  }
  activeInput = null;
}

function renderCalendar(year, month, selectedDay) {
  calendar.innerHTML = '';
  // header (year/month controls + nav)
  let header = document.createElement('div');
  header.className = 'cal-header';

  let yearSelect = document.createElement('select');
  yearSelect.className = 'input';
  yearSelect.style.width = '80px';
  for (let y = 1300; y <= year + 50; y++) {
    let option = document.createElement('option');
    option.value = y;
    option.textContent = y;
    if (y === year) option.selected = true;
    yearSelect.appendChild(option);
  }

  let monthSelect = document.createElement('select');
  monthSelect.className = 'input';
  monthSelect.style.width = '120px';
  let months = ['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'];
  months.forEach((m, i) => {
    let option = document.createElement('option');
    option.value = i + 1;
    option.textContent = m;
    if (i + 1 === month) option.selected = true;
    monthSelect.appendChild(option);
  });

  let prevBtn = document.createElement('button'); prevBtn.className = 'btn small'; prevBtn.textContent = '<';
  let nextBtn = document.createElement('button'); nextBtn.className = 'btn small'; nextBtn.textContent = '>';

  header.appendChild(yearSelect);
  header.appendChild(monthSelect);
  header.appendChild(prevBtn);
  header.appendChild(nextBtn);
  calendar.appendChild(header);

  yearSelect.addEventListener('change', () => renderCalendar(parseInt(yearSelect.value), month, selectedDay));
  monthSelect.addEventListener('change', () => renderCalendar(year, parseInt(monthSelect.value), selectedDay));
  prevBtn.addEventListener('click', () => { month--; if (month < 1) { month = 12; year--; } renderCalendar(year, month, selectedDay); });
  nextBtn.addEventListener('click', () => { month++; if (month > 12) { month = 1; year++; } renderCalendar(year, month, selectedDay); });

  // calendar grid
  let grid = document.createElement('div');
  grid.className = 'cal-grid';

  // week day headers (Saturday..Friday)
  let weekTitles = ['ش','ی','د','س','چ','پ','ج'];
  weekTitles.forEach(w => {
    let t = document.createElement('div');
    t.style.textAlign = 'center';
    t.style.fontSize = '13px';
    t.style.color = 'var(--muted)';
    t.style.fontWeight = '600';
    t.textContent = w;
    grid.appendChild(t);
  });

  // compute first-day offset by converting Jalali(year,month,1) to Gregorian and reading weekday
  let gFirst = jalali_to_gregorian(year, month, 1);
  let dFirst = new Date(gFirst[0], gFirst[1] - 1, gFirst[2]);
  // JS: 0=Sunday .. 6=Saturday. Our week starts Saturday (index 0), so map as follows:
  let offset = (dFirst.getDay() + 1) % 7;

  // compute days in month by measuring difference to first day of next month
  let gNext = (month < 12) ? jalali_to_gregorian(year, month + 1, 1) : jalali_to_gregorian(year + 1, 1, 1);
  let dNext = new Date(gNext[0], gNext[1] - 1, gNext[2]);
  let daysInMonth = Math.round((dNext - dFirst) / (1000 * 60 * 60 * 24));

  // add blank placeholders for offset
  for (let i = 0; i < offset; i++) {
    let blank = document.createElement('div');
    grid.appendChild(blank);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    let cell = document.createElement('div');
    cell.className = 'cal-day';
    if (d === selectedDay) { cell.style.background = 'var(--accent)'; cell.style.color = '#fff'; }
    cell.textContent = d;
    cell.addEventListener('click', () => {
      if (activeInput) {
        activeInput.value = `${year}/${String(month).padStart(2, '0')}/${String(d).padStart(2, '0')}`;
        activeInput.dispatchEvent(new Event('change'));
      }
      hideJalaliCalendar();
    });
    grid.appendChild(cell);
  }

  calendar.appendChild(grid);
}

function attachJalaliInputs(root = document) {
  qsa('.jalali-input', root).forEach(inp => {
    inp.addEventListener('keydown', e => e.preventDefault());
    inp.addEventListener('paste', e => e.preventDefault());
    inp.addEventListener('input', e => { if (e.inputType !== 'insertFromPaste') inp.value = inp.value.slice(0, -1); });
    inp.addEventListener('focus', () => showJalaliCalendar(inp));
    inp.addEventListener('click', () => showJalaliCalendar(inp));
  });
  document.addEventListener('click', e => {
    if (calendar.contains(e.target)) return;
    let inputs = qsa('.jalali-input');
    let isInp = Array.from(inputs).some(i => i === e.target);
    if (!isInp) hideJalaliCalendar();
  });
}
// تابع کمکی برای تبدیل نام ماه به عدد
function monthNameToNumber(monthName) {
  const months = {
    'فروردین': 1, 'اردیبهشت': 2, 'خرداد': 3, 'تیر': 4, 'مرداد': 5, 'شهریور': 6,
    'مهر': 7, 'آبان': 8, 'آذر': 9, 'دی': 10, 'بهمن': 11, 'اسفند': 12
  };
  return months[monthName] || 10; // پیش‌فرض 'دی' = 10
}

// تابع کمکی برای تبدیل عدد ماه به نام
function numberToMonthName(monthNumber) {
  const months = {
    1: 'فروردین', 2: 'اردیبهشت', 3: 'خرداد', 4: 'تیر', 5: 'مرداد', 6: 'شهریور',
    7: 'مهر', 8: 'آبان', 9: 'آذر', 10: 'دی', 11: 'بهمن', 12: 'اسفند'
  };
  return months[monthNumber] || 'دی'; // پیش‌فرض 'دی'
}

// تابع بروزرسانی تاریخ مرجع
function updateCategoryReferenceDate() {
  let today = todayJalali(); // تاریخ امروز، مثل '1404/06/10'
  let [todayYear, todayMonth, todayDay] = today.split('/').map(Number);
  
  let lastUpdate = state.settings.lastCategoryUpdate || '11 دی 1403';
  let refDay, refMonth, refYear, refMonthStr;

  // بررسی فرمت‌های مختلف تاریخ مرجع
  if (lastUpdate.includes('/')) {
    // فرمت: 1403/10/11
    [refYear, refMonth, refDay] = lastUpdate.split('/').map(Number);
    refMonthStr = numberToMonthName(refMonth);
  } else if (lastUpdate.split(' ').length === 3 && !lastUpdate.includes('undefined')) {
    // فرمت: 11 دی 1403
    [refDay, refMonthStr, refYear] = lastUpdate.split(' ');
    refMonth = monthNameToNumber(refMonthStr);
    refDay = parseInt(refDay);
    refYear = parseInt(refYear);
  } else {
    // فرمت نامعتبر (مثل 11 undefined 1404)
    console.warn('فرمت تاریخ مرجع نامعتبر است، تنظیم به پیش‌فرض');
    refDay = 11;
    refMonth = 10;
    refYear = todayYear; // استفاده از سال امروز به جای پیش‌فرض
    refMonthStr = 'دی';
  }

  // لاگ برای دیباگ
  console.log('تاریخ امروز:', today);
  console.log('تاریخ مرجع فعلی:', lastUpdate);
  console.log('پارامترهای مرجع:', { refDay, refMonth, refYear, refMonthStr });

  // بررسی فرمت معتبر
  if (!refDay || !refMonth || !refYear || isNaN(refDay) || isNaN(refMonth) || isNaN(refYear)) {
    console.warn('فرمت تاریخ مرجع نامعتبر است، تنظیم به پیش‌فرض');
    refDay = 11;
    refMonth = 10;
    refYear = todayYear;
    refMonthStr = 'دی';
  }

  // اگر سال امروز بزرگتر از سال مرجع است، یا در همان سال اما بعد از تاریخ مرجع
  if (todayYear > refYear || 
      (todayYear === refYear && (todayMonth > refMonth || (todayMonth === refMonth && todayDay >= refDay)))) {
    refYear = todayYear + (todayMonth > refMonth || (todayMonth === refMonth && todayDay >= refDay) ? 1 : 0);
    state.settings.lastCategoryUpdate = `${refDay} ${refMonthStr} ${refYear}`;
    saveState(); // ذخیره تغییرات
    console.log('تاریخ مرجع بروز شد به:', state.settings.lastCategoryUpdate);
  } else {
    // اگر بروزرسانی لازم نیست، همچنان فرمت را اصلاح کنیم
    state.settings.lastCategoryUpdate = `${refDay} ${refMonthStr} ${refYear}`;
    saveState();
    console.log('بروزرسانی لازم نبود، تاریخ مرجع اصلاح شد به:', state.settings.lastCategoryUpdate);
  }
}

/* Event Binding & Init */
document.addEventListener('DOMContentLoaded', () => {
  
  loadState();
  updateCategoryReferenceDate();  // اضافه شده اینجا
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register("./sw.js")
      .then(reg => {
        console.log('Service Worker registered');
        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              if (confirm('نسخه جدید موجود است. بروزرسانی کنید؟')) {
                newWorker.postMessage({ action: 'skipWaiting' });
              }
            }
          });
        });
      })
      .catch(err => console.error('Service Worker registration failed:', err));
  }

  // PWA install prompt
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // نشان دادن دکمه نصب اگر لازم باشد
    let installBtn = document.createElement('button');
    installBtn.className = 'btn primary';
    installBtn.textContent = 'نصب اپ';
    installBtn.style.position = 'fixed';
    installBtn.style.bottom = '80px';
    installBtn.style.left = '50%';
    installBtn.style.transform = 'translateX(-50%)';
    installBtn.addEventListener('click', () => {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choice) => {
        if (choice.outcome === 'accepted') {
          console.log('اپ نصب شد');
        }
        deferredPrompt = null;
      });
    });
    document.body.appendChild(installBtn);
    setTimeout(() => installBtn.remove(), 10000); // پنهان پس از 10 ثانیه
  });

  //qs('#mobileMenu').classList.add('hide');  مخفی کردن اولیه منو

  // enable horizontal swipe lock on players preview containers as a fallback
  // for browsers/webviews that ignore CSS touch-action.
  try { enableHorizontalSwipeLock(); } catch (e) { console.debug('swipeLock init failed', e); }

  on('#homeMenu', 'click', () => showView('home'));
  on('#accountMenu', 'click', () => showView('account'));
  // management menu removed
  on('#playersBtnAccess', 'click', () => showView('players'));
  on('#coachesBtnAccess', 'click', () => showView('coaches'));
  // healthBtnAccess removed from DOM to avoid duplicate access points

  

  // record last back press for double-press-to-exit behaviour
  let _lastBackAt = 0;
  function goBack() {
    // if there's history state to go back to, just go back
    if (history.state && history.state.view) {
      history.back();
      return true;
    }
    // no app history left — implement double-press-to-exit
    const now = Date.now();
    if (now - _lastBackAt < 1500) {
      // allow default behaviour (close) by returning false
      return false;
    }
    _lastBackAt = now;
    showToast('برای خروج دوباره بازگشت را فشار دهید', 1400);
    return true; // handled (prevent default)
  }

  // expose globally so handlers created earlier can call it
  try { window.goBack = goBack; } catch (e) { console.warn('Unable to expose goBack on window', e); }

  function handleAndroidBack() {
    try {
      return goBack();
    } catch (e) { return false; }
  }

  try { window.handleAndroidBack = handleAndroidBack; } catch (e) { console.warn('Unable to expose handleAndroidBack on window', e); }

  // When the user navigates via browser back/forward, reflect the view
  window.addEventListener('popstate', (ev) => {
    try {
      const stateObj = ev.state;
      if (stateObj && stateObj.view) {
        // render without pushing a new history entry
        showView(stateObj.view, stateObj.params || {}, true);
      } else {
        // fallback: show home
        showView('home', {}, true);
      }
    } catch (e) {
      console.warn('popstate handler failed', e);
    }
  });

  // basic toast helper
  function showToast(msg, timeout = 1800) {
    let t = qs('#__app_toast');
    if (!t) {
      t = document.createElement('div');
      t.id = '__app_toast';
      t.style.position = 'fixed';
      t.style.bottom = '90px';
      t.style.left = '50%';
      t.style.transform = 'translateX(-50%)';
      t.style.background = 'rgba(0,0,0,0.75)';
      t.style.color = '#fff';
      t.style.padding = '8px 12px';
      t.style.borderRadius = '8px';
      t.style.zIndex = 3000;
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.opacity = '1';
    clearTimeout(t._to);
    t._to = setTimeout(() => { t.style.opacity = '0'; }, timeout);
  }
  on('#paymentsBtnAccess', 'click', () => showView('payments'));
  on('#sessionsBtnAccess', 'click', () => showView('sessions'));
  on('#tabCompetitions', 'click', () => showView('competitions'));
  on('#backPlayers', 'click', () => { if (!goBack()) return; });
  on('#backCoaches', 'click', () => { if (!goBack()) return; });
  on('#backSessions', 'click', () => { if (!goBack()) return; });
  on('#backPayments', 'click', () => { if (!goBack()) showView('home'); });
  on('#backInsurance', 'click', () => { if (!goBack()) return; });
  on('#backHealth', 'click', () => { if (!goBack()) return; });
  on('#backPlayersExport', 'click', () => { if (!goBack()) return; });
  on('#backPaymentReport', 'click', () => { if (!goBack()) showView('home'); });
  on('#backManagement', 'click', () => { if (!goBack()) return; });
  on('#backAccount', 'click', () => { showView('home'); });
  on('#backDebtors', 'click', () => { if (!goBack()) showView('payments'); });
  // BMI filter: use dropdown #filterBmi on players page
  on('#filterBmi', 'change', renderPlayersPage);
  on('#settingsFromAccount', 'click', () => showView('settings'));

// ensure Rank Editor link updates when showing settings
function showSettingsAndRankInfo() {
  renderSettings();
}

  on('#addPlayerBtn', 'click', () => showView('player-form'));
  on('#openAddPlayerFromList', 'click', () => showView('player-form'));
  on('#addCoachBtn', 'click', () => showView('coach-form'));
  on('#createCompetitionBtn', 'click', () => {
    showView('competitions');
    renderCompetitions();
    // show a simple prompt flow: competition name -> add matches later
    let name = prompt('نام مسابقه را وارد کنید:');
    if (!name) return;
    let comp = { id: uid('comp'), name, type: 'competition', createdAt: new Date().toISOString(), matches: [] };
    state.competitions.push(comp);
    saveState();
    renderCompetitions();
  });
  on('#createTournamentBtn', 'click', () => {
    showView('competitions');
    renderCompetitions();
    let name = prompt('نام تورنومنت را وارد کنید:');
    if (!name) return;
    let t = { id: uid('tourn'), name, type: 'tournament', createdAt: new Date().toISOString(), matches: [] };
    state.competitions.push(t);
    saveState();
    renderCompetitions();
  });
  on('#backCompetitions', 'click', () => { if (!goBack()) showView('home'); });
  on('#createSessionBtn', 'click', createSession);
  on('#addSessionFromHomeBtn', 'click', () => {
    showView('sessions');
    qs('#sessionDate').value = todayJalali();
  });
  on('#playersSearch', 'input', renderPlayersPage);
  on('#filterCategory', 'change', renderPlayersPage);
  on('#filterInsurance', 'change', renderPlayersPage);
  on('#sortPlayers', 'change', renderPlayersPage);
  on('#showAllPlayersBtn', 'click', () => showView('players'));
  // removed showAllSessionsBtn and showAllPaymentsBtn handlers per UI changes
  // removed showAllInsurancesBtn handler
  // addPaymentFromHomeBtn removed from home UI
  on('#addPaymentBtn', 'click', () => {
    let dateStr = qs('#paymentDate').value || todayJalali();
    let amount = qs('#paymentAmount').value.replace(/,/g, '');
    let type = qs('#paymentType').value || '';
    let pMonth = qs('#paymentMonth').value;
    let pYear = qs('#paymentYear').value;
    let playerId = qs('#paymentPlayer').value;
    addPayment(dateStr, amount, type, pMonth, pYear, playerId);
    qs('#paymentAmount').value = '';
    qs('#paymentDate').value = '';
    qs('#paymentMonth').value = '';
    qs('#paymentYear').value = '';
    qs('#paymentPlayerSearch').value = '';
  });
  on('#paymentPlayerSearch', 'input', (e) => populatePaymentPlayerSelect(e.target.value));
  on('#paymentAmount', 'input', (e) => formatNumber(e.target));
  on('#showDebtorsBtn', 'click', () => showView('debtors'));
  on('#reportPaymentsBtn', 'click', () => showView('payment-report'));
  on('#insuranceCategoryFilter', 'change', renderInsurancePage);
  on('#insuranceStatusFilter', 'change', renderInsurancePage);
  on('#exportPlayersBtn', 'click', () => showView('players-export'));
  on('#accountMenu', 'click', () => showView('account'));

  on('#loginForm', 'submit', (e) => {
    e.preventDefault();
    let username = qs('#username').value.trim();
    let password = qs('#password').value.trim();
    if (username === 'admin' && password === '123') {
      state.user.loggedIn = true;
      saveState();
      alert('لاگین موفق!');
    } else {
      alert('نام کاربری یا رمز اشتباه است');
    }
  });

  // bottom-tabs: wire new mobile tab buttons to app views and manage active state
  function setActiveBottomTab(id) {
    qsa('.bottom-tabs .tab-btn').forEach(b => b.classList.remove('active'));
    let el = qs('#' + id);
    if (el) el.classList.add('active');
  }
  try { on('#tabAccount', 'click', () => { showView('account'); setActiveBottomTab('tabAccount'); }); } catch(e) {}
  try { on('#tabPayments', 'click', () => { showView('payments'); setActiveBottomTab('tabPayments'); }); } catch(e) {}
  try { on('#tabCoaches', 'click', () => { showView('coaches'); setActiveBottomTab('tabCoaches'); }); } catch(e) {}
  try { on('#tabSessions', 'click', () => { showView('sessions'); setActiveBottomTab('tabSessions'); }); } catch(e) {}
  try { on('#tabCompetitions', 'click', () => { showView('competitions'); setActiveBottomTab('tabCompetitions'); }); } catch(e) {}

  // set initial active tab based on current history state (if any)
  setTimeout(() => {
    try {
      const v = (history.state && history.state.view) ? history.state.view : 'home';
      switch (v) {
        case 'account': setActiveBottomTab('tabAccount'); break;
        case 'payments': setActiveBottomTab('tabPayments'); break;
        case 'coaches': setActiveBottomTab('tabCoaches'); break;
        case 'sessions': setActiveBottomTab('tabSessions'); break;
        case 'competitions': setActiveBottomTab('tabCompetitions'); break;
        default: break;
      }
    } catch (e) {}
  }, 80);

  applySettings();

  // receipt modal actions
  try { on('#closeReceiptModal', 'click', () => { let m = qs('#receiptModal'); if (m) m.style.display = 'none'; }); } catch(e) {}
  try { on('#sendReceiptBtn', 'click', () => {
    let phone = qs('#receiptPhone').value.replace(/[^0-9+]/g, '');
    let text = qs('#receiptNote').value || '';
    if (!phone) return alert('شماره تلفن را وارد کنید');
    // open sms: link to allow sending via device (works on mobile)
    window.location.href = `sms:${phone}?body=${encodeURIComponent(text)}`;
  }); } catch(e) {}
  try { on('#saveReceiptBtn', 'click', () => {
    // save a simple local record of receipts (not robust)
    let r = { id: uid('r'), phone: qs('#receiptPhone').value, amount: qs('#receiptAmount').value, note: qs('#receiptNote').value, createdAt: new Date().toISOString() };
    state.receipts = state.receipts || [];
    state.receipts.unshift(r);
    saveState();
    showToast('رسید ذخیره شد');
    let m = qs('#receiptModal'); if (m) m.style.display = 'none';
  }); } catch(e) {}
  renderHome();
  renderPlayersPage();
  renderCoaches();
  renderSessionsPage();
  renderPaymentsPage();
  renderInsurancePage();
  renderHealthPage();
  attachJalaliInputs();

  // initial history state: ensure home is the default entry
  history.replaceState({ view: 'home' }, '', '#home');
});

// Birthday modal controls
function openBirthdayModal(playerId) {
  const modal = qs('#birthdayModal');
  const content = qs('#birthdayModalContent');
  const p = state.players.find(x => x.id === playerId);
  if (!p) return alert('بازیکن پیدا نشد');
  const age = calcExactAge(p.birthdate);
  const todayFlag = isBirthdayToday(p.birthdate);
  const clubName = escapeHtml(state.settings.title || 'باشگاه');
  const clubLogo = state.settings.logo || '';
  // if player's birthday is today -> full greeting modal; otherwise simple upcoming modal
  if (todayFlag) {
    const defaultMsg = `تولدت مبارک 🌟 ${escapeHtml(p.name)} عزیز! امیدوارم سال جدید برات سرشار از انگیزه، پیروزی‌های بزرگ و روزهای پر از لبخند باشه. همیشه پرقدرت بدرخشی.`;
    content.innerHTML = `
      <div id="birthdayCard" style="padding:14px;background:linear-gradient(135deg,#fff,#f7fbff);border-radius:12px;border:1px solid rgba(0,0,0,0.06);max-width:720px;">
        <div style="display:flex;flex-direction:column;align-items:center;">
          <div style="display:flex;flex-direction:column;align-items:center;gap:6px;width:100%;">
            <div style="width:56px;height:56px;border-radius:8px;overflow:hidden;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.08);">${clubLogo?`<img src="${clubLogo}" style="width:100%;height:100%;object-fit:contain;">`:''}</div>
            <div style="font-weight:700;font-size:16px;margin-top:4px;">${clubName}</div>
          </div>
          <div style="width:100%;display:flex;gap:12px;align-items:center;margin-top:12px;">
            <div style="flex:0 0 120px;">
              <div style="width:120px;height:120px;border-radius:12px;overflow:hidden;background:#e2e8f0;box-shadow:0 6px 18px rgba(2,6,23,0.04);">
                ${p.photo?`<img src="${p.photo}" style="width:100%;height:100%;object-fit:cover;">`:'<svg width="120" height="120" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>'}
              </div>
            </div>
            <div style="flex:1;display:flex;flex-direction:column;justify-content:center;">
              <div style="font-size:18px;font-weight:800;">${escapeHtml(p.name)}</div>
              <div style="color:var(--muted);margin-top:6px;font-size:13px;">${p.category || '—'} • سن: ${age.years} سال</div>
            </div>
          </div>
          <div style="width:100%;margin-top:14px;">
            <textarea id="birthdayMessageText" style="width:100%;min-height:160px;border:1px solid rgba(0,0,0,0.06);border-radius:8px;padding:12px;font-size:15px;resize:vertical;direction:rtl;">${defaultMsg}</textarea>
          </div>
        </div>
      </div>
      <!-- action area: kept OUTSIDE #birthdayCard so it won't be included in shared image -->
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px;align-items:center;">
        <div style="display:flex;gap:8px;align-items:center;">
          <label for="birthdayPhoneInput" style="font-size:13px;color:var(--muted);">شماره:</label>
          <input id="birthdayPhoneInput" type="tel" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);width:160px;text-align:left;" value="${escapeHtml(p.phone || '')}">
        </div>
        <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
          <button id="sendBirthdaySms" class="btn primary">ارسال SMS</button>
          <button id="shareBirthdayImage" class="btn">اشتراک به‌صورت عکس</button>
        </div>
      </div>
    `;
  } else {
    // upcoming birthday: show a compact modal with days remaining
    const days = daysUntilBirthday(p.birthdate) || '—';
    content.innerHTML = `
      <div style="padding:18px;max-width:420px;text-align:center;">
        <div style="font-size:18px;font-weight:800;margin-bottom:8px;">${escapeHtml(p.name)}</div>
        <div style="color:var(--muted);margin-bottom:12px;">${days} روز مانده تا تولد</div>
        <div><button class="btn" id="closeUpcomingBirthday">بستن</button></div>
      </div>
    `;
    setTimeout(()=>{
      on('#closeUpcomingBirthday','click',()=>{ if (modal) modal.classList.add('hide'); modal.style.display='none'; });
    },40);
  }
  // attach handlers for share buttons
  setTimeout(() => {
  let smsBtn = qs('#sendBirthdaySms');
  let imgBtn = qs('#shareBirthdayImage');
    if (smsBtn) smsBtn.addEventListener('click', () => {
      // open sms app with recipient and body prefilled; fallback copies to clipboard
      const phoneInput = qs('#birthdayPhoneInput');
      const msgArea = qs('#birthdayMessageText');
      const to = phoneInput?.value?.trim() || '';
      const body = (msgArea?.value || defaultMsg) + ` — از طرف ${clubName}`;
      const encoded = encodeURIComponent(body);
      try {
        // common pattern: sms:<number>?body=...
        const smsUrl = `sms:${to}?body=${encoded}`;
        window.location.href = smsUrl;
      } catch (e) {
        navigator.clipboard?.writeText(body);
        alert('متن پیام در کلیپ‌بورد کپی شد. آن را در برنامه پیامک الصاق و شماره را وارد کنید.');
      }
    });
    if (imgBtn) imgBtn.addEventListener('click', () => {
      // clone the card and replace textarea with full-message div so the entire text is captured
      const card = qs('#birthdayCard');
      const clone = card.cloneNode(true);
      const textarea = clone.querySelector('#birthdayMessageText');
      const fullText = qs('#birthdayMessageText')?.value || defaultMsg;
      if (textarea) {
        const div = document.createElement('div');
        div.style.whiteSpace = 'pre-wrap';
        div.style.fontSize = '15px';
        div.style.direction = 'rtl';
        div.style.lineHeight = '1.4';
        div.style.padding = '10px';
        div.style.borderRadius = '8px';
        div.style.border = '1px solid rgba(0,0,0,0.06)';
        div.textContent = fullText;
        textarea.parentNode.replaceChild(div, textarea);
      }
      // place clone off-screen for rendering
      clone.style.boxSizing = 'border-box';
      clone.style.width = card.offsetWidth + 'px';
      clone.style.background = getComputedStyle(card).backgroundColor || '#ffffff';
      clone.style.padding = getComputedStyle(card).padding;
      clone.style.position = 'fixed';
      clone.style.left = '-9999px';
      document.body.appendChild(clone);
      html2canvas(clone, { backgroundColor: '#ffffff', scale: 2 }).then(canvas => {
        canvas.toBlob(blob => {
          if (!blob) return alert('خطا در تولید تصویر');
          const file = new File([blob], `${normPersian(p.name).replace(/\s+/g,'_')}_birthday.png`, { type: 'image/png' });
          if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            navigator.share({ files: [file], title: `تبریک تولد ${p.name}`, text: fullText });
          } else {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            a.click();
            URL.revokeObjectURL(url);
          }
        });
      }).catch(err => alert('خطا در آماده‌سازی تصویر')).finally(() => { clone.remove(); });
    });
  // share-link removed per user request
  }, 50);
  modal.classList.remove('hide');
  modal.setAttribute('aria-hidden','false');
  on('#birthdayModalClose', 'click', closeBirthdayModal);
  on('#birthdayModalBackdrop', 'click', closeBirthdayModal);
  // focus management: save last focused element and trap focus inside modal
  const lastFocus = document.activeElement;
  modal._lastFocus = lastFocus;
  const focusableSelector = 'a[href], button, textarea, input, select, [tabindex]:not([tabindex="-1"])';
  const focusable = Array.from(qs('#birthdayModal').querySelectorAll(focusableSelector)).filter(el => !el.disabled && el.offsetParent !== null);
  if (focusable.length) focusable[0].focus();
  function trap(e) {
    if (e.key === 'Tab') {
      const idx = focusable.indexOf(document.activeElement);
      if (e.shiftKey) {
        if (idx === 0) { e.preventDefault(); focusable[focusable.length - 1].focus(); }
      } else {
        if (idx === focusable.length - 1) { e.preventDefault(); focusable[0].focus(); }
      }
    } else if (e.key === 'Escape') {
      closeBirthdayModal();
    }
  }
  window.addEventListener('keydown', trap);
  // store to remove when closing
  modal._trapHandler = trap;
}

function closeBirthdayModal() {
  const modal = qs('#birthdayModal');
  modal.classList.add('hide');
  modal.setAttribute('aria-hidden','true');
  // remove focus trap and restore focus
  if (modal._trapHandler) {
    window.removeEventListener('keydown', modal._trapHandler);
    delete modal._trapHandler;
  }
  if (modal._lastFocus) {
    try { modal._lastFocus.focus(); } catch (e) {}
    delete modal._lastFocus;
  }
}

calendar.addEventListener('click', e => e.stopPropagation());
window.addEventListener('keydown', e => {
  if (e.key === 'Escape') { hideJalaliCalendar(); }
});
window.addEventListener('beforeunload', saveState);

// برای آفلاین، اگر آنلاین نبود، از cache استفاده کن
if (!navigator.onLine) {
  alert('اپ آفلاین است. داده‌ها از کش لود شدند.');
}

// بروزرسانی service worker
navigator.serviceWorker.addEventListener('controllerchange', () => {
  window.location.reload();
});

</script>
  <script src="sw-register.js"></script>
</body>
</html>
