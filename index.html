<!-- ...existing code... -->
<!-- ...existing code... -->
<!doctype html>
<html lang="fa" dir="rtl">
<head>
<!-- sync-hybrid removed: use backupClient (backup.js) for backup/restore flows -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>مدیریت باشگاه والیبال</title>
<meta name="description" content="سیستم جامع مدیریت باشگاه والیبال با قابلیت مدیریت بازیکنان، کارت عضویت، مسابقات و حساب‌های مالی" />
<meta name="theme-color" content="#f59e0b" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="والیبال" />
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
<link rel="canonical" href="https://pouriaabedi0073-sys.github.io/volleyball-club/" />
<!-- TWA related tags -->
<meta name="google-site-verification" content="YOUR_VERIFICATION_CODE" />
<meta name="apple-itunes-app" content="app-id=YOUR_APP_ID" />
<link rel="assetlinks.json" href=".well-known/assetlinks.json" />
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
<!-- Use Google Material Icons (more reliably available) -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* inline small spinner used next to buttons */
    .inline-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(0,0,0,0.12);
      border-top-color: rgba(0,0,0,0.5);
      animation: spin 0.9s linear infinite;
      vertical-align: middle;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .profile-status-box { background: linear-gradient(180deg,#ecfdf5,#ffffff); padding:8px;border-radius:8px;margin-bottom:8px; }
    .profile-status-box .status-item{ display:flex; gap:8px; align-items:center; color:#065f46; font-size:0.95em; margin:4px 0 }
    .profile-status-box .status-item .status-text{ color: #064e3b }
  </style>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<!-- Ensure Supabase library is loaded early for auth UI -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
      // Minimal Supabase client initializer: prefer window vars if set, otherwise use project defaults
      (function(){
        try {
          if (typeof window.SUPABASE_URL === 'undefined') window.SUPABASE_URL = 'https://wtycgduarwpgnxxvwtgz.supabase.co';
          if (typeof window.SUPABASE_ANON_KEY === 'undefined') window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0eWNnZHVhcndwZ254eHZ3dGd6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDMyNzUsImV4cCI6MjA3Mzg3OTI3NX0.uqjl1qWII_Yzw86uOHlesjH0YP4AL4QMhjFItPb2DjU';
          // Initialize client if supabase lib is available
          try {
              if (typeof supabase !== 'undefined' && supabase && typeof supabase.createClient === 'function') {
              const client = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
              window.supabase = client;
              window.supabaseClient = client;
            } else if (window.supabase && typeof window.supabase.createClient === 'function') {
              // already present (UMD injected), create a namespaced client
              const client = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
              window.supabase = client;
              window.supabaseClient = client;
            }
          } catch(e) { console.warn('supabase client init failed', e); }

          // Supabase .from(...).select wrapper to catch select lists containing player_name (debug helper)
          try {
            const sup = window.supabase;
            if (sup && typeof sup.from === 'function') {
              const _from = sup.from.bind(sup);
              sup.from = function(table) {
                const q = _from(table);
                if (q && typeof q.select === 'function') {
                  const _select = q.select.bind(q);
                  q.select = function(sel) {
                    try {
                      if (String(sel || '').includes('player_name')) {
                        console.group('%cDEBUG: detected player_name in supabase select','color:#b45309;font-weight:bold');
                        console.log('table:', table);
                        console.log('select:', sel);
                        console.trace();
                        console.groupEnd();
                      }
                    } catch(e){}
                    return _select.apply(this, arguments);
                  };
                }
                return q;
              };
            }
          } catch(e) { console.warn('supabase select wrapper install failed', e); }

          console.info('Debug wrapper for player_name installed.');

          // Runtime detector: catch any runtime attempts to call supabase.from('users')
          try {
            const sup = window.supabase;
            if (sup && typeof sup.from === 'function') {
              const _from = sup.from.bind(sup);
              sup.from = function(table) {
                if (String(table).toLowerCase() === 'users') {
                  try {
        // editEmail removed from form; skip setting email
                    console.trace();
                    console.groupEnd();
                  } catch (e) { console.warn('users detect trace failed', e); }
                }
                return _from.apply(this, arguments);
              };
            }
          } catch (e) { console.warn('install users runtime detector failed', e); }

        } catch (e) { console.warn('supabase init wrapper failed', e); }
      })();
    </script>
<link rel="manifest" href="./manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<meta name="theme-color" content="#0ea5e9">
<style>
/* Competitions: two-column tabs layout */
#view-competitions .matches-tabs {
  display: grid !important;
  grid-template-columns: repeat(2, 1fr) !important;
  gap: 8px !important;
  align-items: stretch;
}



#view-competitions .matches-tabs button {
  width: 100% !important;
  white-space: normal !important;
}
/* Keep tabs horizontal (single row) on very small screens (<700px) if needed */
@media (max-width:300px) {
  #view-competitions .matches-tabs {
    display:flex !important;
    flex-direction:row !important;
    overflow:auto !important;
    grid-template-columns: none !important;
  }
  #view-competitions .matches-tabs button { min-width:70px !important; flex:0 0 auto !important; }
}

/* Responsive team columns in match edit view */
.team-column img { max-width:72px; max-height:72px; }
.team-column .input[type="file"] { padding:6px; }
/* compact set inputs */
  .share-btn { cursor: pointer; background: transparent; border: none; }
  .share-btn svg { display: inline-block; vertical-align: middle; }
.small-set { width: 120px; padding:6px 8px; font-size:14px; box-sizing:border-box; }
@media (max-width:720px) { .small-set { width: 100%; } }
/* file inputs full-width */
.team-column input[type="file"].input { width: 100%; }
/* prevent columns and inputs from overflowing their card */
#view-match-edit .team-column { min-width:0; max-width:100%; }
#view-match-edit .card { overflow:hidden; }
#view-match-edit .input { max-width:100%; box-sizing:border-box; }
#view-match-edit .team-column .input.small-set { padding:6px; }
@media (max-width:720px) {
  #view-match-edit #matchFormPage { padding: 0 12px; }
  #view-match-edit .team-column { width:100%; }
  #view-match-edit > .card > .matchEditContent, #view-match-edit .card { overflow:visible; }
  #view-match-edit .team-column { flex: 1 1 100%; }
  #view-match-edit #matchFormPage { display:block; }
}


@media (min-width:721px) {
  #view-match-edit #matchFormPage { display:block; }
  #view-match-edit .team-column { min-width:0; }
}
  /* Main theme tokens (replaced legacy per-user request) */
  :root {
    --bg: #f8faff;
    --header-bg: rgba(255,255,255,0.88); /* glassy white */
    --card: #ffffff;
    --muted: #6b7785;
    --accent: #1e88e5; /* volleyball blue */
    --accent-2: #ffb300; /* volleyball yellow */
    --text: #111827;
    --text-inverse: #ffffff;
    --icon-stroke: #374151;
    --glass: rgba(255,255,255,0.9);
    --shadow: rgba(20,30,40,0.12);
    --danger: #dc2626;
    --warning: #f59e0b;
    --success: #22c55e;
    --border-radius: 16px;
    --base-font-size: 16px;
    --spacing-small: 8px;
    --spacing-medium: 12px;
    --spacing-large: 16px;
    --thumb-size: 56px;
    --btn-min-height: 44px;
    --btn-min-width: 80px;
  }
  * {
    box-sizing: border-box;
    font-family: "Vazirmatn", Arial, sans-serif;
    margin: 0;
    padding: 0;
  }
  html, body {
    height: 100%;
    background: var(--bg);
    background-size: cover, 100px 100px;
    color: var(--text);
    -webkit-font-smoothing: antialiased;
  }
  .wrap {
    max-width: 100%;
    margin: 0 auto;
    padding: 8px;
    padding-bottom: 80px;
  }
  header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  /* تنظیمات جدید شیشه‌ای */
  background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.4) 100%);
  border: 1px solid rgba(255,255,255,0.25);
  backdrop-filter: blur(20px) saturate(160%);
  -webkit-backdrop-filter: blur(20px) saturate(160%);
  height: 94px;
  position: relative;
  /* use 100% instead of 100vw to avoid horizontal overflow when scrollbars present */
  width: 100%; /* full-bleed but respect scrollbar width */
  margin-left: 0;
  box-shadow: 0 6px 20px var(--shadow);
  animation: fadeIn 0.5s ease-in-out; /* انیمیشن ورود */
  }
  #appLogo {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    margin-right: 12px;
    margin-left: 8px;
    box-shadow: 0 2px 6px var(--shadow);
    overflow: hidden; /* ensure contained images are cropped to circle */
    display: inline-block;
    background: transparent; /* بک‌گراند شفاف برای PNG */
  }
  /* images placed inside the logo container fill and crop to circle */
  #appLogo img, #appLogo > img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  /* افکت موج نوری برای عنوان */
  @keyframes shimmer {
    0% { background-position: -200% center; }
    100% { background-position: 200% center; }
  }
  
  #appTitle {
    font-family: "Vazirmatn FD", "Vazirmatn", system-ui, sans-serif;
    font-weight: 700;
    font-size: 1.7rem;
    background: linear-gradient(90deg, 
      var(--accent) 0%, 
      #3b82f6 25%,
      var(--accent) 50%,
      #3b82f6 75%,
      var(--accent) 100%
    );
    background-size: 200% auto;
    color: transparent;
    -webkit-background-clip: text;
    background-clip: text;
    animation: shimmer 4s ease-in-out infinite;
    text-shadow: 0 2px 4px rgba(0,0,0,0.08);
    letter-spacing: -0.01em;
    display: block;
    object-position: center center;
  }
  #appTitle {
    font-size: 20px;
    font-weight: 700; /* بولدتر برای فونت بهتر */
    color: var(--text);
  }

  /* Theme switch button styling inside header (header-specific switch) */
  .theme-switch { display:inline-flex; align-items:center; justify-content:center; }
  /* legacy floating switch kept in DOM but hidden; header uses its own visible control */
  body > .theme-switch { display: none !important; }

  /* Header switch (text + switch) */
  .header-theme-switch { display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none; }
  .header-theme-switch .switch-track { width:48px; height:28px; background:var(--card); border-radius:999px; display:block; padding:3px; box-sizing:content-box; position:relative; transition:background 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease; border:2px solid rgba(0,0,0,0.12); }
  .header-theme-switch .switch-thumb { width:22px; height:22px; border-radius:50%; background:var(--muted); display:block; position:absolute; left:3px; top:3px; transition:left 0.18s ease, background 0.18s ease; box-shadow:0 3px 8px rgba(0,0,0,0.12); }
  /* dark mode visuals (apply when document root has theme-dark) */
  .theme-dark .header-theme-switch .switch-track { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.06); }
  .theme-dark .header-theme-switch .switch-thumb { background: var(--accent-2); left: calc(100% - 3px - 22px); }
  /* also react to the actual input checked state (keeps UI responsive even before theme-class toggles) */
  .header-theme-switch input:checked + .switch-track { border-color: var(--accent-2); background: rgba(255,255,255,0.03); }
  .header-theme-switch input:checked + .switch-track .switch-thumb { left: calc(100% - 3px - 22px); background: var(--accent-2); }
  .header-theme-switch:focus-within, .header-theme-switch input:focus + .switch-track { outline: 3px solid rgba(30,136,229,0.12); outline-offset: 2px; }
  /* visually-hidden helper that doesn't cause focus-to-scroll issues */
  .visually-hidden { position: absolute !important; width: 1px !important; height: 1px !important; padding: 0 !important; margin: -1px !important; overflow: hidden !important; clip: rect(0 0 0 0) !important; white-space: nowrap !important; border: 0 !important; }
  .mobile-menu {
    display: flex;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    gap: 8px;
    background: var(--glass);
    backdrop-filter: blur(10px); /* بلور مدرن */
    padding: 8px;
    box-shadow: 0 -8px 24px var(--shadow);
    justify-content: space-around;
    z-index: 1000;
    height: 70px;
  }
  .menu-icon-btn {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: var(--accent);
    color: var(--text-inverse);
    transition: all 0.3s ease-in-out;
    box-shadow: 0 2px 6px var(--shadow);
    border: none;
  }
  .menu-icon-btn.home {
      /* home button visual styles only; JavaScript moved to script blocks */
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  #accountProfileContainer .card > div > div > #accountEmail,
  #accountProfileContainer .card > div > div > #accountPhone { display:block; width:100%; }
  
    /* FORCE vertical stacking for profile action rows and sync controls (all breakpoints) */
    #accountProfileContainer .card .action-row { display:flex; flex-direction:column !important; width:100%; gap:8px; }
    #accountProfileContainer .card .action-row .btn, #accountProfileContainer .card .profile-actions .btn { width:100%; }
    #accountProfileContainer .card #profileSyncControls { width:100%; display:flex; flex-direction:column; gap:8px; align-items:center; }
  /* Modern app-like button style (2025) */
  .btn {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
    border: 1px solid rgba(0,0,0,0.06);
    padding: 12px 16px; /* larger touch target */
    border-radius: 14px; /* pill-like */
    cursor: pointer;
    font-weight: 700;
    font-size: calc(var(--base-font-size) * 1);
    min-height: 48px;
    min-width: 72px;
    transition: transform 0.18s cubic-bezier(.2,.9,.2,1), box-shadow 0.18s, background 0.18s;
    position: relative;
    overflow: visible;
    display: inline-flex;
    flex-direction: row;
    align-items: center;
    gap: 12px;
    color: var(--text);
    box-shadow: 0 6px 18px rgba(12,18,28,0.06);
    -webkit-tap-highlight-color: transparent;
    backface-visibility: hidden;
    will-change: transform;
  }
  .btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.6s ease, height 0.6s ease;
  }
  .btn::before {
    /* subtle ripple for clicks on desktop */
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.08);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.45s ease, height 0.45s ease, opacity 0.45s;
    opacity: 0;
  }
  .btn:active::before { width: 260px; height: 260px; opacity: 1; }
  .btn:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(12,18,28,0.12); }
  .btn:active { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(12,18,28,0.10); }
  .btn.primary {
    background: var(--accent-2);
    color: var(--text-inverse);
    border: none;
  }
  .btn.primary:hover {
    filter: brightness(0.96);
  }

  /* secondary flat button (blue) */
  .btn.secondary {
    background: var(--accent); /* restored solid blue */
    color: var(--text-inverse);
    border: none;
  }
  .btn.secondary:hover { filter: brightness(0.98); }

  /* 3D tactile hero button: beveled / pop-out look for tactile depth */
  .btn.mobile-hero {
    --mh-h: 52px;
    --mh-radius: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    width: 100%;
    max-width: 420px;
    margin: 0 auto;
    padding: 14px 20px;
    height: var(--mh-h);
    border-radius: var(--mh-radius);
    color: var(--text-inverse);
    border: none;
    /* Base gradient for material depth */
    background: linear-gradient(180deg, #ff6b4a 0%, #e63f5a 100%);
    /* outer drop shadow + subtle inner bevel */
    box-shadow: 0 20px 40px rgba(10,16,30,0.32), inset 0 -3px 8px rgba(0,0,0,0.12);
    transform-style: preserve-3d;
    perspective: 900px;
    transition: transform 240ms cubic-bezier(.2,.9,.25,1), box-shadow 240ms, filter 180ms;
    position: relative;
    overflow: visible;
  }

  /* Top glossy bevel */
  .btn.mobile-hero::before {
    content: '';
    position: absolute;
    left: 0; right: 0; top: 0;
    height: 42%;
    border-top-left-radius: var(--mh-radius);
    border-top-right-radius: var(--mh-radius);
    background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.02));
    pointer-events: none;
    transform: translateZ(20px);
  }

  /* Floating shadow plate to enhance 3D effect */
  .btn.mobile-hero::after {
    content: '';
    position: absolute;
    left: 8%; right: 8%;
    bottom: -12px;
    height: 14px;
    background: radial-gradient(ellipse at center, rgba(0,0,0,0.38), rgba(0,0,0,0.06));
    border-radius: 50%;
    filter: blur(6px);
    transition: bottom 240ms, opacity 240ms;
    opacity: 1;
    pointer-events: none;
  }

  /* Icon and content pop forward */
  .btn.mobile-hero .btn-icon { transform: translateZ(28px); width:28px !important; height:28px !important; }

  /* Hover: lift and rotate slightly to emphasize depth */
  .btn.mobile-hero:hover { transform: translateY(-10px) rotateX(6deg) translateZ(18px); box-shadow: 0 32px 64px rgba(8,12,20,0.36); }
  .btn.mobile-hero:active { transform: translateY(2px) rotateX(0deg) translateZ(0); box-shadow: 0 10px 22px rgba(8,12,20,0.22); }

  @media (min-width: 720px) {
    .btn.mobile-hero { width: auto; min-width: 220px; max-width: none; border-radius: 12px; }
  }

  /* Reduce shadow and animation specifically for the players list button to make it subtler */
  #showAllPlayersBtn {
    /* softer base shadow */
    box-shadow: 0 8px 16px rgba(8,12,20,0.14) !important;
    transition: transform 140ms cubic-bezier(.2,.9,.2,1), box-shadow 140ms !important;
  }
  #showAllPlayersBtn:hover {
    /* smaller lift than the global mobile-hero hover */
    transform: translateY(-4px) rotateX(3deg) translateZ(8px) !important;
    box-shadow: 0 12px 24px rgba(8,12,20,0.18) !important;
  }
  #showAllPlayersBtn:active {
    transform: translateY(0) rotateX(0) translateZ(0) !important;
    box-shadow: 0 6px 12px rgba(8,12,20,0.12) !important;
  }
  /* disable any floating animation if present */
  #showAllPlayersBtn.mh-animate { animation: none !important; }

  /* Mobile-friendly flat hero (no 3D) for compact actions */
  .btn.mobile-friendly {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    max-width: 420px;
    padding: 12px 16px;
    height: 52px;
    border-radius: 12px;
    background: linear-gradient(90deg, var(--accent), color-mix(in srgb, var(--accent) 60%, #000 40%));
    color: var(--text-inverse);
    border: none;
    box-shadow: 0 8px 20px rgba(10,18,30,0.12);
    transition: transform 160ms ease, box-shadow 160ms ease;
    -webkit-tap-highlight-color: transparent;
  }
  .btn.mobile-friendly:active { transform: translateY(2px) scale(0.997); box-shadow: 0 6px 14px rgba(10,18,30,0.10); }
  @media (min-width:720px) { .btn.mobile-friendly { width: auto; min-width: 180px; } }

  /* Button icon helper: use inline SVG <use> or sprite via injector */
  .btn .icon {
    width: 18px;
    height: 18px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-inline-start: 8px; /* spacing that respects RTL/LTR */
    vertical-align: middle;
    color: inherit;
  }
  .btn .btn-icon { width:18px; height:18px; display:inline-block; vertical-align:middle; }
  /* make the player-list button icon slightly larger for visibility */
  #showAllPlayersBtn .btn-icon { width:26px !important; height:26px !important; }
  /* helper to make monochrome/SVG icons appear white on colored buttons */
  .btn .btn-icon.white-icon { filter: brightness(0) invert(1); }

  /* Home page specific styling */
  #view-home .section-title h3 { font-size: 16px; }
  .section-title { padding-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.06); margin-bottom: 12px; }
  /* Make main page buttons yellow with white text by default */
  #view-home .btn.primary { background: var(--accent-2); color: var(--text-inverse); }
  /* ensure show-list button can be blue via .secondary */
  #view-home .btn.secondary { background: var(--accent); color: var(--text-inverse); }

  /* Header text color (title/logo area) should be blue */
  header, header #appTitle { color: var(--accent); }
  /* Also make per-view fixed headers match the blue accent */
  .view-header h3 { color: var(--accent); }
  /* Competitions / Matches styles */
  .competitions-top { display:flex;justify-content:space-between;align-items:center;gap:12px; }
  .matches-tabs { display:flex;gap:8px;flex-wrap:nowrap;overflow:auto; }
  .matches-tabs button { white-space:nowrap; flex:0 0 auto; }
  .matches-list { display:flex;flex-direction:column;gap:10px; }
  .match-card { background:var(--card);border-radius:12px;padding:12px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 10px rgba(0,0,0,0.04); }
  .match-teams { text-align:right;min-width:140px; }
  .match-score { font-weight:700;font-size:18px; }
  .match-badges { display:flex;gap:8px;align-items:center; }
  .muted-small { color:var(--muted);font-size:13px; }

  /* modal form for creating/editing matches */
  .modal .modal-content { max-width:720px;width:100%; }
  #matchFormModal .modal-body { padding:12px; }
  #matchFormModal .form-row { display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px; }
  #matchFormModal .input { padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);min-height:40px; }

  /* upcoming birthdays truncation */
  .birthday-card .players-preview .player-row .meta { max-width: calc(var(--thumb-size) * 1.6); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  /* training preview spacing */
  #trainingPreview .player-row { margin-bottom:8px; }
  .btn.danger {
    background: linear-gradient(90deg, var(--danger), #ef4444);
    color: var(--text-inverse);
  }
  .btn.danger:hover {
    background: linear-gradient(90deg, #ef4444, var(--danger));
  }
  /* bottom tab bar */
  .bottom-tabs {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    justify-content: space-around;
    background: var(--glass);
    padding: 8px 6px;
    box-shadow: 0 -6px 18px var(--shadow);
    z-index: 1200;
  }
  .bottom-tabs .tab-btn {
    background: transparent;
    border: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    color: var(--text);
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    padding: 6px 8px;
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.03);
  }
  .bottom-tabs .tab-btn i, .bottom-tabs .tab-btn .material-icons, .bottom-tabs .tab-btn img { font-size: 24px; margin-bottom:2px; line-height:1; display:block; transition: transform 0.15s ease; }
  .bottom-tabs .tab-btn { position: relative; }
  .bottom-tabs .tab-btn.logged-in::after {
    content: '';
    position: absolute;
    right: 10px;
    top: 6px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent, #16a34a);
    box-shadow: 0 0 6px rgba(22,163,74,0.24);
  }
  .bottom-tabs .tab-btn.logged-in .tab-label { color: var(--accent, #16a34a) !important; font-weight: 800; }
  /* colorize the PNG icon slightly when logged-in to make the state more visible */
  .bottom-tabs .tab-btn.logged-in img { filter: invert(37%) sepia(72%) saturate(478%) hue-rotate(95deg) brightness(93%) contrast(90%); }
  /* Extra selector: if the label itself gets a class set from JS, ensure it also changes color */
  .bottom-tabs .tab-btn .tab-label.logged-in-label { color: var(--accent, #16a34a) !important; font-weight: 800; }
  .bottom-tabs .tab-btn.active { color: var(--accent); }
  .bottom-tabs .tab-btn.active { font-weight:800; box-shadow:0 6px 14px rgba(0,0,0,0.08); transform:translateY(-2px); }
  .bottom-tabs .tab-btn.active i, .bottom-tabs .tab-btn.active img { transform: scale(1.18); }
  .tab-label { font-size: 12px; }
  /* touch / mobile interaction improvements */
  .tab-btn, .btn { touch-action: manipulation; -webkit-tap-highlight-color: transparent; user-select: none; }
  /* visual disabled state used by JS guards */
  .btn.disabled, .tab-btn.disabled { pointer-events: none; opacity: 0.6; transform: translateY(0); }
  /* temporary full-page blocker injected when menu touch starts to prevent click-through */
  .menu-blocker {
    position: fixed;
    inset: 0;
    z-index: 1195; /* below mobileMenu (1200) but above page content */
    background: transparent;
    pointer-events: auto;
  }
  /* Dark theme: make PNG menu icons visible by turning them light and adding a soft light background */
  .theme-dark .bottom-tabs .tab-btn img {
    /* make icons larger and appear white/bright for better contrast in dark mode */
    filter: invert(1) brightness(1.55) saturate(0%);
    /* even brighter, higher-contrast background so PNGs stand out more */
    background: rgba(255,255,255,0.36);
    padding: 10px;
    border-radius: 12px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.4) inset;
    /* override inline width/height on the img elements */
    width: 34px !important;
    height: 34px !important;
    display: block;
    object-fit: contain;
  }

  /* Keep the logged-in green tint when in dark mode (stronger selector to override the generic dark rule) */
  .theme-dark .bottom-tabs .tab-btn.logged-in img {
    filter: invert(37%) sepia(72%) saturate(478%) hue-rotate(95deg) brightness(93%) contrast(90%);
    background: rgba(22,163,74,0.30); /* slightly stronger greenish background when logged-in in dark mode */
    width: 34px !important;
    height: 34px !important;
  }
  /* Button variant: text then icon on the same row (icon on the right) */
  .btn.icon-right { display: inline-flex; flex-direction: row-reverse; align-items: center; justify-content: center; gap: 8px; white-space: nowrap; margin: 0 auto; }
  .btn.icon-right span { display: inline-block; direction: rtl; }
  .btn.icon-right img { display: inline-block; width: 24px; height: 24px; object-fit: cover; border-radius: 4px; margin-right: 8px; flex: 0 0 24px; }
  /* Center the icon+text button on small screens (mobile preview) */
  /* Profile action row: force single horizontal row inside profile card */
  .profile-action-row { display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:nowrap; overflow-x:auto; padding-bottom:6px; }
  .profile-action-row .btn { 
    flex:0 0 auto; 
    min-width:44px; /* smaller buttons to fit inside cards */
    padding:6px 8px;
    font-size:13px;
    flex-direction:row; /* keep icon and text on same row */
    align-items:center;
    gap:8px;
    white-space:nowrap;
    border-radius:10px;
    text-align:center; /* ensure label centered */
    display:inline-flex; justify-content:center; align-items:center;
  }
  .profile-action-row .btn img, .profile-action-row .btn i { width:20px; height:20px; flex:0 0 20px; }

  /* 2x2 tile grid for profile action buttons (rectangular tiles) */
  .action-tile-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    align-items: stretch;
  }
  .action-tile-grid .action-tile {
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 14px 16px;
    min-height: 64px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,0.06);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
    color: var(--text);
    font-weight: 800;
    cursor: pointer;
    text-align: center;
    white-space: nowrap;
    box-shadow: 0 10px 26px rgba(6,12,24,0.06);
    transition: transform .18s ease, box-shadow .18s ease;
  }
  .action-tile-grid .action-tile.primary { background: linear-gradient(90deg, var(--accent), var(--accent-2)); color: var(--text-inverse); border: none; box-shadow: 0 14px 36px rgba(99,102,241,0.12); }
  .action-tile-grid .action-tile.warn { background: linear-gradient(90deg, var(--warning), #f59e0b); color: var(--text-inverse); border: none; }
  .action-tile-grid .action-tile:active { transform: translateY(2px) scale(0.995); }
  .action-tile-grid .action-tile .tile-icon { width:22px; height:22px; margin-inline-start:10px; }
  /* membership card responsive tweaks */
  #membershipCard { transition: all 0.25s ease; }
  #membershipCard img { display:block; }
  @media (max-width:420px) {
    #membershipCard { width: 92vw; padding:10px; }
    #membershipCard div[style*="width:96px"] { width:76px; height:76px; }
    #membershipCard div[style*="font-size:18px"] { font-size:16px; }
  }

  /* More responsive behavior for membership preview */
  @media (max-width:640px) {
    /* make the inner grid wrap: use two columns and adjust rows so content doesn't overflow */
    #membershipCard > div { grid-template-columns: repeat(2, 1fr) !important; grid-template-rows: auto auto auto !important; gap:8px !important; }
    #membershipCard img { max-width:100%; height:auto; object-fit:cover; }
    #membershipCard [id^="cell"] { padding:6px !important; }
    #membershipCard #cell2 { font-size:18px !important; }
    #membershipCard #cell6 { font-size:14px !important; }
    #membershipCard #pcName { font-size:15px !important; }
    #membershipCard #pcBirth, #membershipCard #pcNational, #membershipCard #pcJoinDate, #membershipCard #pcExpire { font-size:12px !important; }
  }

  /* breakpoint at 600px: switch to 2 columns and allow auto row heights */
  @media (max-width:600px) {
    #membershipInnerGrid { grid-template-columns: repeat(2, 1fr) !important; grid-auto-rows: auto !important; gap:8px !important; }
    /* ensure image boxes don't overflow */
    #membershipInnerGrid img { max-height:140px; width:100%; height:auto; object-fit:cover; }
  }

  /* breakpoint at 420px: single column stacked layout */
  @media (max-width:420px) {
    #membershipInnerGrid { grid-template-columns: 1fr !important; grid-auto-rows: auto !important; gap:6px !important; }
    /* make important cells full width */
    #cell5, #cell6, #cell2, #cell4, #cell9, #cell8, #cell11 { grid-column: 1 / -1 !important; }
    #membershipInnerGrid img { max-height:120px; }
  }

  /* Prevent text overflow and ensure ellipsis if space is tight */
  #membershipCard [id^="pc"] { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  #membershipCard #pcName { white-space:normal; }

  /* Stronger rules for very small screens (<=320-360px) */
  @media (max-width:420px) {
    #membershipCard { width: min(92vw,520px); box-sizing: border-box; padding:8px; }
    /* switch to single column stack so items never overflow */
    #membershipCard > div { grid-template-columns: 1fr !important; grid-auto-rows: auto !important; gap:6px !important; }
    /* ensure key cells stretch full width and stack in sensible order */
    #cell5, #cell6, #cell2, #cell4, #cell9, #cell8, #cell11 { grid-column: 1 / -1 !important; }
    /* scale images and limit heights so they don't blow the card size */
    #membershipCard img { max-width:100%; max-height:140px; height:auto; display:block; }
    /* allow text to wrap and break long words */
    #membershipCard [id^="pc"] { white-space:normal; overflow-wrap: break-word; word-break: break-word; }
    /* clamp font sizes for extreme small widths */
    #membershipCard #pcName { font-size: clamp(13px, 4vw, 16px) !important; }
    #membershipCard #pcBirth, #membershipCard #pcNational, #membershipCard #pcJoinDate, #membershipCard #pcExpire { font-size: clamp(11px, 3.2vw, 13px) !important; }
    /* tighten paddings */
    #membershipCard [id^="cell"] { padding:4px !important; }
  }

  /* stricter small-screen rules for <=360px and <=320px */
  @media (max-width:360px) {
    #membershipInnerGrid { grid-template-columns: 1fr !important; grid-auto-rows: auto !important; gap:6px !important; }
    /* make each cell a flex column so image and text stack without overflow */
    #membershipInnerGrid > div[id^="cell"] { display:flex !important; flex-direction:column !important; align-items:flex-start !important; justify-content:center !important; box-sizing:border-box; overflow:hidden; }
    /* images scale down more aggressively */
    #membershipInnerGrid img { max-width:100%; width:100%; max-height:110px; height:auto; object-fit:cover; display:block; }
    #cell5 img#pcPhotoImg { max-height:120px; }
    #pcClubLogoImg { max-height:90px; width:auto; }
  }

  @media (max-width:320px) {
    #membershipCard { padding:6px !important; }
    #membershipInnerGrid { gap:5px !important; }
    #membershipInnerGrid img { max-height:90px !important; }
    #membershipInnerGrid > div[id^="cell"] { padding:4px !important; }
    /* make sure long names wrap into multiple lines rather than pushing layout */
    #pcName { white-space:normal !important; word-break:break-word !important; }
  }

  /* ensure cell containers hide overflow horizontally */
  #membershipInnerGrid > div { overflow:hidden; }

  /* apply transform scale based on computed --card-scale variable; clamp between 0.6 and 1 */
  .membership-scale-wrapper { transform: scale(var(--card-scale,1)); }
  /* enforce a minimum readable scale at very small widths */
  @media (max-width:360px) {
    :root { --card-scale: 0.65; }
    .membership-scale-wrapper { transform: scale(0.65); }
  }
  @media (min-width:361px) and (max-width:520px) {
    /* compute scale relative to 520px width */
    :root { --card-scale: calc((100vw - 32px) / 520); }
    .membership-scale-wrapper { transform: scale(var(--card-scale)); }
  }
  /* ensure transform doesn't create overflow by setting wrapper container height auto */
  #membershipCard { display:flex; justify-content:center; }
  .membership-scale-wrapper { display:block; }

  /* Accessibility: ensure no horizontal scroll inside card */
  #membershipCard { overflow: hidden; }

  /* Note card styles */
  .note-card { background: var(--card); border:1px solid rgba(0,0,0,0.06); padding:10px; border-radius:10px; box-shadow: 0 4px 10px rgba(2,6,23,0.04); }
  .note-card .note-meta { font-size:12px; color:var(--muted); margin-bottom:6px; display:flex;justify-content:space-between;align-items:center; }
  .note-actions { display:flex; gap:6px; }
  @media (max-width: 420px) {
    #showAllPlayersBtn.btn.icon-right {
      display: inline-flex !important;
      justify-content: center !important; /* center contents inside the button */
      margin: 0 auto !important; /* center the button itself in its container */
      min-width: 140px !important;
      padding: 10px 14px !important;
    }
    /* ensure the image keeps its spacing when centered */
    #showAllPlayersBtn.btn.icon-right img { margin-left: 8px; }
  }
  .btn.warning {
    background: linear-gradient(90deg, var(--warning), #fbbf24);
    color: var(--text-inverse);
  }
  .btn.warning:hover {
    background: linear-gradient(90deg, #fbbf24, var(--warning));
  }
  .btn.small {
  padding: calc(var(--spacing-small) * 0.75) calc(var(--spacing-medium) * 0.75);
  font-size: calc(var(--base-font-size) * 0.8125);
  min-height: calc(var(--btn-min-height) * 0.8);
  min-width: calc(var(--btn-min-width) * 0.8);
  }
  .card, .box {
  padding: 12px; /* use compact padding similar to players-stat-card */
  gap: 8px;
  background: var(--glass);
  border-radius: var(--border-radius);
  border: 1px solid rgba(0,0,0,0.06);
  }
  .grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr); /* two columns on wider screens */
  gap: 16px;
  margin-top: 16px;
  }
  .access-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* دو ستون */
    gap: 12px;
  }
  .access-grid .btn {
    width: 100%;
    aspect-ratio: 1 / 1; /* مربعی */
    justify-content: center;
    text-align: center;
    padding: 20px; /* بزرگ‌تر کردن */
    font-size: 16px;
    box-shadow: 0 4px 12px var(--shadow); /* سایه بیشتر برای جذابیت */
  }
  .access-grid .btn svg {
    width: 48px; /* بزرگ‌تر کردن آیکن دکمه‌های دسترسی */
    height: 48px;
  }
  .card {
    background: var(--glass);
    backdrop-filter: blur(5px); /* بلور برای کارت‌ها */
    padding: 16px;
    border-radius: var(--border-radius);
    box-shadow: 0 8px 24px var(--shadow);
    transition: transform 0.3s ease-in-out;
  }
  .card:hover {
    transform: translateY(-4px); /* انیمیشن هاور */
  }
  /* Ensure header title is on the left and actions on the right visually.
     We force the layout direction to LTR for the header container while
     keeping the textual direction of the title (RTL) intact so Persian text
     stays aligned to the right inside the title element. */
  .section-title {
    display: flex;
    direction: rtl; /* layout right-to-left so title sits on the right visually */
    align-items: center;
    margin-bottom: 12px;
    gap: 8px;
  }
  .section-title h3 { margin: 0; flex: 0 0 auto; direction: rtl; text-align: right; }
  .section-title .actions { margin-right: auto; display:flex; gap:8px; align-items:center; }
  .players-preview, .full-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .player-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px;
    border-radius: var(--border-radius);
    border: 1px solid rgba(0,0,0,0.04);
    background: var(--glass);
    transition: background 0.2s, transform 0.2s;
    cursor: pointer;
  }
  .transaction-card { border: 1px solid rgba(0,0,0,0.06); padding: 12px; border-radius: 10px; background: #fff; display:flex; flex-direction:column; align-items:stretch; gap:8px; margin-bottom:10px; }
  .transaction-info { display:flex; justify-content:space-between; gap:12px; align-items:center; }
  .transaction-meta { color:var(--muted); font-size:13px; }
  .transaction-actions { display:flex; gap:8px; justify-content:flex-end; flex-wrap:nowrap; align-items:center; white-space:nowrap; }
  .player-row:hover {
    background: rgba(14,165,233,0.1);
    transform: translateY(-2px);
  }
  /* Stats layout: big players card then two-column small stat cards */
  .players-stat-card {
    padding: 12px;
    border-radius: var(--border-radius);
    background: var(--glass);
    box-shadow: 0 8px 24px var(--shadow);
    margin-bottom: 12px;
  }
  /* ensure top players card spans full width of the stats grid */
  .players-stat-card { grid-column: 1 / -1; }
  .players-by-category { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-top:8px; }
  .players-by-category .category-row { display:flex; justify-content:space-between; align-items:center; padding:8px; border-radius:8px; background: rgba(0,0,0,0.03); }
  .players-by-category .category-row .category-count { color: var(--muted); font-weight:700; }
  .category-chip { display:flex; flex-direction:column; gap:4px; }
  /* Mobile: stack profile into a single column for small screens */
  @media (max-width: 768px) {
    .profile-grid { grid-template-columns: 1fr !important; grid-auto-rows: auto; }
    .profile-left, .profile-right { width: 100%; }
    .profile-left .card, .profile-right .card { margin-top: 8px; }
    #profileModalContent { padding: 12px; }
    #profileModalContent h3 { font-size: 18px; }
    #profileImg { width: 100%; height: auto; border-radius: 8px; }
    .players-by-category { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); }
    .small-stats-grid { grid-template-columns: 1fr 1fr; }
  }
  /* Tighter layout specifically for narrow phones/tablets under 700px */
  @media (max-width: 700px) {
    .players-preview { gap: 6px !important; padding-bottom: 6px !important; }
    .players-preview .player-row { padding: 4px !important; }
    .players-preview .player-thumb { width: 56px !important; height: 56px !important; border: 2px solid #fff !important; }
  .players-preview .player-row .meta { display: none !important; }
  /* but for birthdays preview we want the name/meta visible under thumb on small screens */
  #birthdaysToday .player-row .meta { display: block !important; text-align: center !important; margin-top: 6px !important; font-size: 12px !important; }
    #birthdaysToday .player-thumb { width: 56px !important; height: 56px !important; }
    /* reduce horizontal spacing so 4 items fit comfortably on many smaller phones */
    .players-preview .player-row { flex: 0 0 calc((100% - 18px) / 4) !important; min-width: calc((100% - 18px) / 4) !important; }
    /* ensure upcoming birthdays and birthdays today stay compact */
    #birthdaysToday .player-row { flex: 0 0 auto; margin-right: 8px; }
  }
  .small-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 8px; }
  .small-stats-grid .stat-card { padding: 12px; border-radius: var(--border-radius); background: var(--glass); }
  /* Icon in stats title */
  .section-title { position: relative; }
  .stats-icon { width:36px; height:36px; position:absolute; top:-4px; left:12px; opacity:0.95; filter: drop-shadow(0 3px 6px rgba(0,0,0,0.12)); }
  @keyframes spin360 { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
  .stats-icon.spin { animation: spin360 6s linear infinite; }

  /* Stat card color variants for a more professional palette */
  .stat-card.sessions-card { background: linear-gradient(135deg, rgba(30, 88, 229, 0.06), rgba(30,88,229,0.02)); border-left:4px solid var(--accent); color:var(--text); }
  .stat-card.percent-paid-card { background: linear-gradient(135deg, rgba(34,197,94,0.07), rgba(34,197,94,0.02)); border-left:4px solid var(--success); color:var(--text); }
  .stat-card.current-income-card { background: linear-gradient(135deg, rgba(255,179,0,0.06), rgba(255,179,0,0.02)); border-left:4px solid var(--accent-2); color:var(--text); }
  .stat-card.prev-income-card { background: linear-gradient(135deg, rgba(99,102,241,0.04), rgba(99,102,241,0.01)); border-left:4px solid #6b7280; color:var(--text); }
  /* Improve contrast for numeric values */
  .stat-card strong { font-size:20px; color:var(--text); }
  /* ensure stat-card adapts and percent box doesn't overflow */
  .stat-card { display:flex; flex-direction:column; justify-content:center; align-items:flex-start; min-width: 140px; }
  .stat-card strong { font-size: 20px; }
  .stat-card.center { align-items:center; text-align:center; }
  .player-thumb {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    overflow: hidden;
    background: var(--bg);
    flex: 0 0 56px;
    box-shadow: 0 2px 4px var(--shadow); /* سایه برای عکس‌ها */
    aspect-ratio: 1/1;
  }
  .player-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  /* Ensure player images are clickable on touch devices and allow manipulation gestures */
  .player-image, .player-thumb img {
    touch-action: manipulation;
    cursor: pointer;
    -webkit-tap-highlight-color: rgba(0,0,0,0.06);
    pointer-events: auto !important;
  }
  /* placeholder avatar when photo is missing: an inner gray circle sized to match thumb */
  .avatar-placeholder-outer { width: 52px; height: 52px; border-radius:50%; display:flex; align-items:center; justify-content:center; background: transparent }
  .avatar-placeholder-inner { width: 44px; height: 44px; border-radius:50%; background:#e2e8f0 }
  .meta {
    flex: 1;
    min-width: 0;
  }
  .meta strong {
    display: block;
    font-size: 16px;
  }
  .meta small {
    color: var(--muted);
    font-size: 13px;
  }
  /* list-thumb: larger square thumbnails for players list */
  .list-thumb {
    width: 96px;
    height: 96px;
    border-radius: 8px;
    overflow: hidden;
    flex: 0 0 96px;
  }
  @media (min-width: 480px) {
    .list-thumb { width: 112px; height: 112px; flex: 0 0 112px; }
  }
  /* place action buttons side-by-side (inline) in coaches/player rows */
  .player-row .action-buttons { display: flex; gap: 8px; align-items: center; }
  .badge {
    background: var(--accent);
    color: var(--text-inverse);
    padding: 6px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
  }
  .badge.warning {
    background: var(--warning);
  }
  .badge.danger {
    background: var(--danger);
  }
  .muted {
    color: var(--muted);
  }
  .search, .input, input[type='text'], input[type='number'], select {
    padding: 10px;
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.06);
    background: var(--glass);
    font-size: 14px;
    color: var(--text);
  }
  .jalali-input {
    cursor: pointer;
  }
  label {
    display: block;
    font-size: 13px;
    margin-bottom: 4px;
    color: var(--text);
  }
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 12px;
  }
  .form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 16px;
  }
  .hide {
  display: none !important;
}
.coach-card {
  display:flex;
  flex-direction:column;
  align-items:stretch;
  gap:12px;
  padding:12px;
  border-radius:12px;
  background:linear-gradient(180deg,#fff,#fbfdff);
  box-shadow:0 6px 18px rgba(12,40,80,0.06);
  margin-bottom:10px;
}
.coach-top { display:flex; gap:12px; align-items:center }
.coach-thumb { width:72px;height:72px;border-radius:12px;overflow:hidden;flex:0 0 auto;background:#eef6ff;display:flex;align-items:center;justify-content:center }
.coach-thumb img { width:100%;height:100%;object-fit:cover;display:block }
.coach-body { flex:1 1 auto; min-width:0; display:flex;flex-direction:column }
.coach-name { font-weight:800; font-size:16px }
.coach-sub { color:var(--muted); font-size:13px; margin-top:4px }
.coach-meta { margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; align-items:center }
.coach-link { color:var(--muted); font-size:13px; text-decoration:none }
.coach-class { margin-top:6px; font-size:13px; color:var(--muted); display:flex; align-items:center; gap:6px }
.coach-actions { display:flex; gap:8px; justify-content:center; margin-top:6px }
.coach-actions .btn { padding:8px 12px; font-size:13px }
  /* Global modal styles for dynamically-created modals (notes, receipts, etc.) */
  .modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 2500;
  }
  .modal::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 2500;
  }
  .modal .modal-content {
    position: relative;
    z-index: 2501;
    width: 100%;
    max-width: 560px;
    background: var(--card);
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 10px 30px var(--shadow);
  }
  .modal .modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .modal .modal-close { background:transparent; border:none; font-size:20px; padding:6px 8px; cursor:pointer; color:var(--muted); }
  /* place modal close button at top-right corner */
  .modal .modal-content { position:relative; }

  /* share modal action card styling (match birthday modal aesthetics) */
  .share-action-card { max-width:720px; margin:0 auto; }
  .share-action-card .share-controls { gap:12px; }
  /* New share modal layout styles */
  .share-modal-inner { max-width:720px; padding:12px; }
  .share-modal-inner #shareCard { border-radius:14px; box-shadow:0 8px 30px rgba(0,0,0,0.12); max-height:78vh; overflow:hidden; display:flex; flex-direction:column; }
  /* When creating a temporary clone for capture, hide interactive controls cleanly */
  .capture-hide { display:none !important; visibility:hidden !important; }
  /* Small helper to ensure cloned node renders with the same font and layout when offscreen */
  .share-card-clone-preserve { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .share-color-row { justify-content:center; }
  .share-color-row label { margin-right:6px; }
  .share-buttons-row { justify-content:center; width:100%; gap:10px; }
  .share-buttons-row .btn { flex: 1 1 auto; min-width:0; max-width:360px; box-sizing:border-box; }
  /* ensure action row stays inside modal and doesn't overflow horizontally */
  .share-modal-inner { display:flex; flex-direction:column; align-items:stretch; }
  .share-preview-wrap { flex: 0 0 auto; }
  .share-controls-wrap { flex: 0 0 auto; }
  .share-actions-wrap { flex: 0 0 auto; display:flex; align-items:center; justify-content:center; }
  /* allow the card content to scroll internally if viewport is tight */
  .share-modal-inner .card-scroll { overflow:auto; max-height:62vh; }
  /* responsive tweaks */
  .share-modal-inner { box-sizing:border-box; }
  #shareCard img { max-width:100%; height:auto; }
  #shareCard { width:100%; }

  /* birthday-style share button */
  .birthday-share-btn { padding:10px 16px; border-radius:10px; font-weight:700; box-shadow:0 8px 20px rgba(14,165,233,0.12); }
  .birthday-share-btn.primary { background:var(--accent); color:var(--text-inverse); border:0; }
  .modal .modal-header .modal-close { position:absolute; right:8px; top:8px; }
  /* competitions modals: place close button on left for RTL visual preference */
  #matchFormModal .modal-header .modal-close, #matchDetailModal .modal-header .modal-close { left:8px; right:auto; }

  /* For the share modal keep the close button in-flow so it doesn't overflow the white modal */
  #shareOverlay .modal-close, #shareOverlay #closeShareOverlay { position:relative; right:auto; top:auto; margin:0; }
  /* match-detail close: plain text button (black) when it contains text */
  .match-detail-close {
    background: linear-gradient(180deg,#ef4444,#dc2626) !important;
    color: #fff !important;
    width: 40px;
    height: 40px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    box-shadow: 0 6px 18px rgba(220,38,38,0.18);
    font-weight: 700;
    position: absolute;
    left: 8px;
    top: 8px;
  }
  .modal .modal-body textarea { width:100%; min-height:140px; padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:var(--glass); color:var(--text); resize:vertical; }
  /* small chip used in detail modal for date/time and set badges */
  .detail-chip { display:inline-block; padding:6px 8px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.9); font-size:13px; margin-left:6px; }

/* Share overlay: override generic modal pseudo-backdrop to avoid duplicate layers */
#shareOverlay::before { display: none !important; }
  .jalali-calendar {
    /* Centered modal-style calendar */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--card);
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 10px 30px var(--shadow);
    z-index: 2600; /* above other UI layers */
    direction: ltr;
    animation: fadeIn 0.3s ease;
    max-width: 95vw;
    max-height: 80vh;
    overflow: auto;
  }
  .cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 36px);
    gap: 8px;
  }
  .cal-day {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 14px;
    color: var(--text);
  }
  .cal-day:hover {
    background: rgba(14,165,233,0.2);
  }
  .cal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    font-weight: 600;
    direction: rtl;
  }
  .cal-year-btn {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 6px;
    background: var(--glass);
    border: 1px solid rgba(0,0,0,0.1);
    cursor: pointer;
  }
  .stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 16px;
    text-align: center;
  }
  .stat-item {
    flex: 1;
    background: var(--glass);
    padding: 12px;
    border-radius: 10px;
    box-shadow: 0 2px 8px var(--shadow);
    min-width: 120px;
    transition: transform 0.3s;
  }
  .stat-item:hover {
    transform: scale(1.05); /* انیمیشن برای آمار */
  }
  .stat-item strong {
    display: block;
    font-size: 24px;
  }
  .stat-item small {
    color: var(--muted);
  }
  .score-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 4px;
    margin-top: 4px;
    font-size: 13px;
    color: var(--accent-2);
  }
  .topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 16px;
    position: relative;
  }
  .topbar > div {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  .view-more {
    color: var(--accent);
    text-decoration: none;
    font-size: 13px;
    margin-top: 8px;
    display: inline-block;
  }
  .mobile-search {
    display: none;
  }
  .note-btn {
    width: 32px;
    height: 32px;
    background: var(--glass);
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  .note-btn svg {
    width: 16px;
    height: 16px;
    stroke: var(--icon-stroke);
  }
  .note-btn.has-note {
    background: var(--warning);
    color: var(--text-inverse);
  }
  .settings-section {
    margin-top: 20px;
    text-align: center;
  }
  .settings-btn {
    margin: 0 4px;
  }
  .profile-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 8px;
    margin-top: 16px;
  }
  .players-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }
  .players-preview {
  display: flex;
  flex-direction: row;
  gap: 8px;
  overflow-x: auto; /* اسکرول افقی */
  overflow-y: hidden; /* جلوگیری از اسکرول عمودی */
  height: auto; /* ارتفاع داینامیک با توجه به سایز عکس */
  max-height: 140px; /* جلوگیری از بزرگ شدن بیش از حد */
  padding-bottom: 10px; /* فاصله از پایین */
  align-items: center; /* تراز کردن عمودی */
  white-space: nowrap; /* جلوگیری از شکستن به خط بعدی */
  -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
  touch-action: auto; /* allow browser to decide — enable normal page scroll and horizontal pan */
  scroll-snap-type: x mandatory; /* snap items for nicer sliding */
  }
  .players-preview .player-row {
  /* make exactly 4 items visible across the container width; remaining items scroll horizontally */
  flex: 0 0 calc((100% - 36px) / 4); /* 3 gaps of 12px between 4 items */
  min-width: 88px;
  padding: 6px;
  border: none;
  background: none;
  cursor: pointer;
  display: inline-flex; /* اطمینان از چیدمان افقی */
  flex-direction: column;
  align-items: center;
  justify-content: center;
  scroll-snap-align: start;
  }
  .players-preview .player-row .meta {
    display: none;
  }
  .players-preview .player-thumb {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  overflow: hidden;
  background: #e2e8f0; /* بک‌گراند خاکستری برای وقتی عکس نیست */
  flex: none;
  aspect-ratio: 1/1; /* اطمینان از دایره بودن */
  border: 3px solid #ef4444; /* کادر قرمز مخصوص این باکس */
  display: flex;
  align-items: center;
  justify-content: center;
  }
  .players-preview .player-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover; /* اطمینان از پر شدن دایره بدون تغییر شکل */
  border-radius: 50%; /* دایره‌ای کردن تصویر */
  border: 2px solid #fff; /* حاشیه سفید کوچک برای جداسازی */
 }

/* birthdays specific layout: show name and days-left under thumbnail in the preview box */
#birthdaysToday { overflow-x: auto; overflow-y: hidden; padding-bottom: 8px; }
#birthdaysToday .player-row { padding: 6px; display: inline-flex; flex-direction: column; align-items: center; }
#birthdaysToday .player-row .meta { display: block; margin-top: 6px; text-align: center; }
#birthdaysToday .player-row .meta small { display:block; color: var(--muted); font-size: 12px; }

  /* list-thumb: used in full players list (left square thumbnail) */
  .list-thumb {
    width: 120px;
    height: 120px;
    border-radius: 8px;
    background: #f6f7fb;
    flex: 0 0 120px;
    overflow: hidden;
  }
  .list-thumb img { width: 100%; height: 100%; object-fit: cover; display:block; }
 .players-preview .player-thumb svg {
  width: 100%; /* SVG دقیقاً اندازه .player-thumb */
  height: 100%;
  border-radius: 50%; /* دایره‌ای کردن SVG */
  border: 2px solid #fff; /* حاشیه سفید برای هماهنگی با تصاویر */
 }
/* birthdaysToday: do not use red border for this box */
#birthdaysToday .player-thumb {
  border: 0; /* remove red ring specifically for birthdays */
  box-shadow: none;
}
/* overlay for upcoming birthdays */
.birthday-overlay {
  position: absolute;
  inset: 0;
  background: rgba(14,165,233,0.22);
  border-radius: 50%;
  pointer-events: none;
}
  .back-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    color: var(--text);
    position: absolute;
    top: -20px;
    right: 10px;
    padding: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: var(--card);
    box-shadow: 0 2px 4px var(--shadow);
  }
  .back-btn svg {
    width: 20px;
    height: 20px;
    stroke: var(--icon-stroke);
  }

  .birthday-card {
  /* Make birthdays card consistent with other cards; color/typography tuned for birthdays */
  background: var(--glass);
  position: relative;
  overflow: hidden;
  box-shadow: 0 8px 24px var(--shadow);
  color: var(--text);
  border-radius: var(--border-radius);
  padding: 16px;
}
.birthday-card .section-title {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}
.birthday-card .section-title h3 {
  color: var(--text);
  font-size: 16px;
  margin: 0;
}
.birthday-icon-title {
  width: 32px;
  height: 32px;
  background: var(--accent-2);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 8px rgba(0,0,0,0.08);
}
.birthday-icon-title svg { width:20px;height:20px;fill:var(--text-inverse); }
.birthday-card .player-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  background: var(--card);
  border-radius: 10px;
  position: relative;
  cursor: pointer;
  border: 1px solid rgba(0,0,0,0.04);
}
.birthday-card .player-thumb { position: relative; }
/* .birthday-icon-player {
  position: absolute;
  bottom: -5px;
  left: -5px;
  width: 24px;
  height: 24px;
  background: var(--warning);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  animation: pulse 1.5s infinite;
}
.birthday-icon-player svg {
  width: 16px;
  height: 16px;
  fill: var(--text-inverse);
} */
 
.birthday-card .meta {
  display: flex;
  flex-direction: column;
}
.birthday-card .meta strong {
  color: var(--text);
}
.birthday-card .meta small {
  color: rgba(255,255,255,0.8);
}
#noBirthdaysMsg {
  color: var(--text-inverse);
  text-align: center;
  margin-top: 12px;
}
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}


  @media (max-width: 768px) {
    .wrap { padding: 12px; padding-bottom: 80px; }
    .grid { grid-template-columns: 1fr; }
    .mobile-menu { display: flex; }
    .form-row { grid-template-columns: 1fr; }
    .cal-grid { grid-template-columns: repeat(7, 32px); }
    .cal-day { width: 32px; height: 32px; font-size: 13px; }
    .player-row { flex-wrap: wrap; }
    .player-row > div:last-child { flex-basis: 100%; display: flex; justify-content: center; gap: 8px; margin-top: 8px; }
    .topbar { flex-direction: column; align-items: stretch; }
    .topbar > div { width: 100%; }
    .profile-actions { grid-template-columns: repeat(2, 1fr); }
  .players-preview { display: flex; flex-direction: row; gap: 6px; overflow-x: auto; }
    .sessions-preview, .payments-preview, .expired-insurances { display: flex; flex-direction: column; gap: 10px; }
    .topbar div in #view-sessions { flex-direction: column; }
    .topbar div in #view-sessions input, select, button { width: 100%; }
    .card { margin-bottom: 16px; }
    .players-preview .meta { margin-top: 8px; font-size: 12px; }
  .players-preview .player-row { padding: 6px; }
    .health-grid { grid-template-columns: 1fr; }
    .access-grid .btn svg { width: 48px; height: 48px; } /* بزرگ‌تر در موبایل */
    .access-grid .btn { font-size: 14px; padding: 16px; }
  /* on tablets show 3 items per viewport (approx) */
  .players-preview .player-row { flex: 0 0 calc((100% - 20px) / 3); min-width: calc((100% - 20px) / 3); }
  }
  /* keep header action buttons inline and prevent wrapping on small screens */
  .section-title { display:flex; align-items:center; }
  .section-title .btn { white-space: nowrap; }
  @media (max-width: 480px) {
    .access-grid { grid-template-columns: repeat(2, 1fr); } /* نگه داشتن دو ستون حتی در کوچک، برای جلوگیری از ریختن */
    .menu-icon-btn svg { width: 28px; height: 28px; } /* تنظیم برای کوچک‌ترها */
  /* on small phones show 2 items per viewport */
  .players-preview .player-row { flex: 0 0 calc((100% - 12px) / 2); min-width: calc((100% - 12px) / 2); }
  .section-title .btn { padding:6px 8px; font-size:13px; }
  }
  @media (max-width: 360px) {
  :root {
    --base-font-size: 13px; /* فونت کوچکتر */
    --thumb-size: 40px; /* دایره‌های کوچکتر */
    --spacing-small: 6px;
    --spacing-medium: 8px;
    --shadow: rgba(20,30,40,0.1); /* سایه سبک‌تر */
    --glass: rgba(255,255,255,0.7); /* بلور کمتر */
    --btn-min-height: 36px; /* دکمه‌های کوچکتر اما قابل‌کلیک */
    --btn-min-width: 60px; /* عرض کوچکتر */
  }
  .access-grid {
    grid-template-columns: repeat(2, 1fr); /* حفظ دو ستون */
    gap: var(--spacing-small); /* فاصله کمتر */
  }
  .grid, .health-grid, .players-grid {
    grid-template-columns: 1fr; /* بقیه gridها تک ستون */
  }
  .btn {
    font-size: calc(var(--base-font-size) * 0.9);
    min-height: 44px;
    min-width: 56px;
    padding: 10px 12px;
  }
  .btn.small {
    font-size: calc(var(--base-font-size) * 0.77); /* 10px حدوداً */
    min-height: 32px;
    min-width: 50px;
  }
  .menu-icon-btn {
    width: 36px;
    height: 36px;
  }
  .menu-icon-btn svg {
    width: 22px;
    height: 22px;
  }
  .player-thumb, .thumb {
  width: var(--thumb-size);
  height: var(--thumb-size);
  flex: 0 0 var(--thumb-size);
  border-radius: 8px; /* square-ish corners for card thumbnails */
  overflow: hidden;
  background: var(--bg);
  aspect-ratio: 1/1;
  border: 3px solid transparent;
  background-image: linear-gradient(to right, #ff0000, #ff4d4d, #d62976);
  background-origin: border-box;
  background-clip: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
  }

  /* Ensure player-card thumbnails keep the larger square size and override preview rules */
  .players-preview .player-row.player-card .player-thumb,
  .player-card .player-thumb {
    width: 88px !important;
    height: 88px !important;
    aspect-ratio: 1/1 !important;
    border-radius: 12px !important;
  }

  /* place thumbnail near the card's corner for player cards */
  .player-card { position: relative; }
  .player-card .player-thumb {
    position: absolute;
    top: 14px;
    left: 14px;
    width: 88px !important;
    height: 88px !important;
    z-index: 2;
    border-radius: 12px !important;
    aspect-ratio: 1/1 !important;
    overflow: hidden;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  /* Image reliability helpers: reserve space, avoid layout shift and provide fallback */
  img.reserved, img[id^="app"], img[id^="shareLogo"], img[id^="pcClubLogoImg"], img[id^="accountAvatar"], img[id^="profileImg"] {
    display: inline-block;
    width: auto;
    height: auto;
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    background-color: rgba(0,0,0,0.03);
  }
  /* ensure small icons keep fixed size to avoid shifting the menu */
  img.icon-fixed, img.small-icon {
    width: 36px; height: 36px; min-width:36px; min-height:36px; object-fit:contain; display:inline-block;
  }
  /* placeholder when image fails */
  .img-placeholder {
    display:inline-flex;align-items:center;justify-content:center;background:#f1f5f9;color:#94a3b8;font-weight:700;border-radius:6px;border:1px solid rgba(0,0,0,0.04);
  }
  .player-card .player-thumb img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    border-radius: 12px !important;
    display: block;
  }
  .player-card > div {
   /* Increased left padding so absolute thumbnail doesn't overlap content
     and to create more horizontal breathing room between halves */
   padding-left: 180px !important;
   min-height: 110px;
   /* Make inner wrapper a flex row so left and right halves can center their content */
   display: flex !important;
   align-items: stretch !important;
  }
  .player-card .player-info-block {
    margin-bottom: 22px !important;
    text-align: center;
  }
  /* Allow long player names to wrap to next line to avoid breaking card layout */
  .player-card .player-info-block .player-name { display:block; max-width:100%; white-space:normal; overflow-wrap:break-word; word-break:break-word; }
  .player-card .action-buttons {
    margin-top: 10px !important;
    margin-bottom: 4px;
    /* Center buttons horizontally in their half and vertically within the card */
    align-items: center !important;
    justify-content: center !important;
    /* Make the action column wider and push it further from the center */
    flex: 0 0 200px !important;
    padding-left: 16px !important;
    display: flex !important;
    flex-direction: column !important;
  }
  /* very small screens: tighten preview gap even more */
  .players-preview { gap: 4px; }
  .players-preview .player-row {
    flex: 0 0 calc(33.33% - var(--spacing-small)); /* 3 بازیکن */
    min-width: calc(33.33% - var(--spacing-small));
  }
  .jalali-calendar .cal-grid {
    grid-template-columns: repeat(7, 26px);
  }
  .cal-day {
    width: 26px;
    height: 26px;
    font-size: calc(var(--base-font-size) * 0.77); /* 10px */
  }
  }
  body.mobile-active .mobile-menu { display: important; } /* !important رو حذف کن تا .hide بتونه override کنه */
  body.mobile-active .grid { grid-template-columns: 1fr !important; }
  body.mobile-active .form-row { grid-template-columns: 1fr !important; }
  body.mobile-active .player-row { flex-direction: column !important; align-items: center !important; text-align: center !important; }
  body.mobile-active .meta { text-align: center !important; }
  body.mobile-active .players-preview { display: flex !important; flex-direction: row !important; gap: 6px !important; overflow-x: auto !important; }
  body.mobile-active .players-preview .player-row { flex: 0 0 auto; flex-direction: column !important; text-align: center !important; }
  body.mobile-active .topbar { flex-direction: column !important; align-items: stretch !important; }
  body.mobile-active .topbar > div { width: 100% !important; }
  body.mobile-active .cal-grid { grid-template-columns: repeat(7, 32px) !important; }
  body.mobile-active .cal-day { width: 32px !important; height: 32px !important; font-size: 13px !important; }
  body.mobile-active .sessions-preview, .payments-preview, .expired-insurances { display: flex; flex-direction: column; gap: 10px; }
  body.mobile-active header { display: flex; }
  #view-players header, #view-coaches header, #view-sessions header, #view-payments header, #view-insurance header, #view-health header { display: none; }
  @media print {
    .no-print { display: none; }
    .player-row { page-break-inside: avoid; }
  }
  /* اضافه برای جذابیت ورزشی: استفاده از آیکون والیبال بزرگ با بلِر ملایم در پس‌زمینه */
  .sports-bg {
    position: relative; /* container for the decorative pseudo-element */
    overflow: visible;
  }
  .sports-bg::before {
    content: "";
    position: fixed;
    left: 50%;
    top: 30%; /* moved a bit higher */
    width: 220px; /* closer to original small-circle scale */
    height: 220px; /* closer to original small-circle scale */
    transform: translate(-50%, -40%); /* nudge upward visually */
    background-image: url('./icons/volleyball-svgrepo-com (10).svg');
    background-repeat: no-repeat;
    background-size: contain;
    opacity: 0.12; /* slightly stronger but still soft */
    filter: blur(4px); /* mild blur for softness */
    pointer-events: none;
    z-index: 0;
  }
  /* ensure page content sits above the decorative background */
  .wrap { position: relative; z-index: 1; }
  .health-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
  }
  .health-card {
    background: var(--glass);
    padding: 16px;
    border-radius: 16px;
    box-shadow: 0 4px 12px var(--shadow);
  }
  .health-card .bmi-bar {
    height: 10px;
    border-radius: 5px;
    background: #e2e8f0;
    margin-top: 8px;
  }
  .health-card .bmi-fill {
    height: 100%;
    border-radius: 5px;
    transition: width 0.3s;
  }
  .health-card .event-btn {
    margin-top: 12px;
  }
  .event-list {
    margin-top: 8px;
  }
  .event-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
  }
  .event-item .event-text {
    flex: 1;
  }
  .event-item .event-actions {
    display: flex;
    gap: 4px;
  }
  /* Style for home players preview thumbs */
  .players-preview .player-row {
    padding: 0;
    border: none;
    background: none;
    cursor: pointer;
  }
  .players-preview .player-thumb {
    box-shadow: none;
  }
  #scoresContainer {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }
  .action-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .view-header {
    display: flex;
    align-items: center;
  justify-content: space-between;
  /* reverse visual order so back button sits on the right and title on the left (RTL pages) */
  flex-direction: row-reverse;
    padding: 16px;
    background: var(--header-bg);
    box-shadow: 0 4px 12px var(--shadow);
  }
  .view-header h3 {
    margin: 0;
  /* ensure the title text reads from left side when placed on the left */
  text-align: left;
  }
  .form-section {
    border: 1px solid rgba(0,0,0,0.06);
    padding: 12px;
    border-radius: 10px;
    background: var(--card);
    margin-bottom: 12px;
  }
  .view-header .back-btn {
    position: absolute;
    right: 12px;
    top: 12px;
    margin: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: var(--card);
    box-shadow: 0 2px 4px var(--shadow);
  }

  /* header home button: circular like back button and placed to the left of it */
  .view-header .home-btn {
    position: absolute;
    right: 56px; /* sits left of back button */
    top: 12px;
    width: 40px;
    height: 40px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:50%;
    background: var(--card);
    box-shadow: 0 2px 4px var(--shadow);
    border: none;
    transition: transform .08s ease, background .12s ease;
  }
  .view-header .home-btn:hover { transform: translateY(-1px); }
  .view-header .home-btn svg { width:20px; height:20px; }
  /* competitions-specific: pin back button to left edge and keep it flush */
  #view-competitions .view-header { padding-left: 12px; }
  #view-competitions .view-header .back-btn { position: absolute; left: 12px; top: 12px; margin: 0; }
  /* ensure title isn't covered by absolute back button */
  #view-competitions .view-header h3 { margin-left: 48px; }
  .btn, .menu-icon-btn, .jalali-input, .player-row, .cal-day {
  touch-action: manipulation; /* حذف تأخیر 300ms */
}
.view-header.fixed {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000; /* مطمئن می‌شه هدر بالای بقیه عناصر باشه */
  background: var(--header-bg);
  box-shadow: 0 6px 20px var(--shadow); /* سایه برای ظاهر بهتر */
}
section:not(#view-home) {
  padding-top: 84px; /* ارتفاع تقریبی هدر to match larger full-width header */
}
/* Competitions / Matches styles */
.competitions-top {
  display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid rgba(0,0,0,0.06);
}
.competitions-top .left-actions, .competitions-top .right-actions {display:flex;gap:8px;align-items:center}
.matches-tabs {display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;align-items:center}
.matches-tabs button {padding:8px 12px;border-radius:10px;background:var(--glass);border:1px solid rgba(0,0,0,0.04);cursor:pointer;flex: 0 1 auto}
.matches-tabs button.active {background:var(--accent);color:var(--text-inverse);border-color:transparent}
.matches-list {display:flex;flex-direction:column;gap:12px}
.match-card {background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px var(--shadow);display:flex;align-items:center;justify-content:space-between;gap:12px}
.match-meta {display:flex;flex-direction:column;align-items:flex-end;gap:4px}
.match-score {font-weight:800;font-size:20px;margin:0 12px;min-width:80px;text-align:center}
.match-teams {display:flex;flex-direction:column;align-items:flex-end;min-width:120px}

/* responsive: team left/right with VS and scores centered */
@media (max-width:600px) {
  .match-card {flex-direction:row;align-items:center}
  .match-card .left-team, .match-card .right-team {flex:1}
  .match-card .vs {width:48px;text-align:center;font-weight:700}
  .match-score {min-width:56px;font-size:18px}
}
/* keep tabs horizontal down to small phones; change breakpoint to 770px so below that still stays inline */
@media (max-width:770px) {
  /* keep tabs horizontal on small screens (allow horizontal scroll) */
  .matches-tabs { display:flex; flex-direction:row; gap:8px; overflow:auto; white-space:nowrap; -webkit-overflow-scrolling:touch; }
  .matches-tabs button { flex:0 0 auto; min-width:80px; }
}

/* enforce horizontal tabs also under 700px specifically (override other rules) */
@media (max-width:700px) {
  .matches-tabs { display:flex !important; flex-direction:row !important; gap:8px !important; overflow:auto !important; white-space:nowrap !important; }
  .matches-tabs button { flex:0 0 auto !important; min-width:70px !important; }
}

/* on small screens stack tabs-box and controls vertically */
@media (max-width:600px) {
  .tabs-box { margin-bottom:8px; }
  .matches-controls { flex-direction:column; gap:8px; align-items:stretch; }
  .matches-controls input { width:100%; }
}

/* Make tabs vertical and full-width on small screens (mobile first) */
@media (max-width:600px) {
  .matches-tabs { display:flex;flex-direction:column;gap:8px; }
  .matches-tabs button { width:100%; text-align:center; }
}

/* controls box above tabs */
.matches-controls { background:var(--card);padding:8px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.04); box-sizing:border-box; overflow:hidden; }

/* make sure inputs and inner divs can shrink and wrap without overflowing */
.matches-controls { display:flex; flex-wrap:wrap; align-items:center; }
.matches-controls > div { flex: 1 1 auto; min-width:0; box-sizing:border-box; }
.matches-controls .input, .matches-controls input { min-width:0; flex:1 1 auto; box-sizing:border-box; overflow:hidden; }
/* keep small controls from stretching the row and ensure they remain clickable */
.matches-controls button, .matches-controls .btn { flex: 0 0 auto; margin:0; }

/* ensure compact clear button looks correct and doesn't force wider layout */
#clearMatchesDate { padding:6px 8px; width:34px; height:34px; display:inline-flex; align-items:center; justify-content:center; box-sizing:border-box; }

/* marker used in markup so we can target elements easily; not hidden by default */
.no-capture { box-sizing: border-box; }

/* class applied at runtime to hide controls during capture */
.capture-hide { visibility:hidden !important; pointer-events:none !important; }
.capture-hide.collapse { display:none !important; }

/* helpers for new markup */
.matches-controls-left { min-width:0; }
.matches-date-wrap { min-width:0; }

/* compact clear button in competitions controls */
#clearMatchesDate { padding:6px 8px; width:34px; height:34px; display:inline-flex; align-items:center; justify-content:center; }

/* precise match card layout requested */
.match-card .row-top { display:flex;justify-content:space-between;align-items:center;padding-bottom:6px;border-bottom:1px dashed rgba(0,0,0,0.04); }
.match-card .row-mid { display:flex;justify-content:space-between;align-items:center;padding:8px 0; }
.match-card .row-bottom { display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--muted); }
.match-card .team-name { font-weight:700; }
.match-card .score { font-weight:800; font-size:18px; min-width:56px; text-align:center; }
.match-kind {display:flex;gap:8px;align-items:center}
.match-status {font-size:13px}
.match-badges {display:flex;gap:8px;align-items:center}
.fab {position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:50%;background:var(--accent-2);color:var(--text-inverse);display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 8px 24px rgba(255,179,0,0.18);cursor:pointer;z-index:2000}
.fab.fab-blue { background: #2563eb; box-shadow: 0 8px 24px rgba(37,99,235,0.18); }
.muted-small {color:var(--muted);font-size:13px}

/* Share preview tweaks: keep controls out of the printed/captured card */
#shareCard button { -webkit-appearance: none; appearance: none; }
#shareCard input[type="color"] { /* keep native color picker UI */ border: 0; padding: 0; background: transparent; }
#shareCard .share-controls { margin-top:12px; display:flex; gap:8px; width:100%; }
#shareCard .share-controls > * { flex:1 1 auto; }
#shareCard .no-capture { visibility:visible; }

/* Highlighted boxes: used on payments and sessions pages to make form areas
   more prominent and easier to spot. Adjusts border, shadow and spacing. */
.highlight-box {
  border: 2px solid var(--accent);
  padding: 14px;
  border-radius: 12px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
  box-shadow: 0 8px 20px rgba(10,20,30,0.08);
  transition: transform 0.12s ease, box-shadow 0.12s ease;
}
.highlight-box:active, .highlight-box:focus-within {
  transform: translateY(-2px);
  box-shadow: 0 12px 28px rgba(10,20,30,0.12);
}
/* Slightly wider and anchored on payments page */
#view-payments .highlight-box {
  max-width: 1100px; /* a bit wider to match other form areas */
  margin: 8px auto;
  border-left: 6px solid var(--accent);
}
@media (max-width: 900px) {
  #view-payments .highlight-box { max-width: calc(100% - 28px); margin: 8px 14px; }
}
/* Slight visual difference for sessions area */
#view-sessions .highlight-box {
  border-style: solid;
  border-color: rgba(99,102,241,0.95);
  background: linear-gradient(90deg, rgba(99,102,241,0.04), rgba(255,255,255,0.02));
}

/* Make form controls inside highlight-box stretch to available width */
.highlight-box .input, .highlight-box input, .highlight-box select, .highlight-box textarea {
  width: 100%;
  box-sizing: border-box;
}

</style>

</style>
<style>
/* Feather icon rule: sized and colorable by currentColor */
.icon { width: 24px; height: 24px; fill: currentColor; stroke: currentColor; display: inline-block; vertical-align: middle; }
.icon svg { width: 24px; height: 24px; }
</style>
<script>
// Icon injector: replace <span class="icon icon-name"></span> with
// <svg class="icon"><use href="assets/icons/feather-sprite.svg#name"></use></svg>
(function(){
  function nameFromEl(el){
    if(!el || !el.classList) return null;
    for(const c of el.classList){ if (c.indexOf('icon-')===0) return c.replace('icon-',''); }
    return null;
  }
  function makeUseSVG(name, classes){
    try{
      const ns = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(ns, 'svg');
      svg.setAttribute('class', (classes || '').toString());
      svg.setAttribute('aria-hidden', 'true');
      svg.setAttribute('focusable', 'false');
      svg.setAttribute('width', '24'); svg.setAttribute('height', '24');
      // prefer href (supported) and set xlink:href for older browsers
      const use = document.createElementNS(ns, 'use');
      try { use.setAttribute('href', 'assets/icons/feather-sprite.svg#' + name); } catch(e){}
      try { use.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', 'assets/icons/feather-sprite.svg#' + name); } catch(e){}
      svg.appendChild(use);
      return svg;
    } catch(e){ console.warn('makeUseSVG failed', e); return null; }
  }

  function upgradeIcons(root){
    const nodes = (root || document).querySelectorAll('span.icon');
    nodes.forEach(span => {
      const name = nameFromEl(span);
      if(!name) return;
      const classes = Array.from(span.classList).filter(c => c !== 'icon' && !c.startsWith('icon-')).join(' ');
      const svg = makeUseSVG(name, classes);
      if (!svg) return;
      // preserve id and title if present
      if (span.id) svg.id = span.id;
      const title = span.getAttribute('title'); if (title) { const t = document.createElement('title'); t.textContent = title; svg.insertBefore(t, svg.firstChild); }
      span.parentNode.replaceChild(svg, span);
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => upgradeIcons(document));
  } else {
    setTimeout(() => upgradeIcons(document), 0);
  }
  // observe future mutations
  try{
    const mo = new MutationObserver(muts => muts.forEach(m => { m.addedNodes && m.addedNodes.forEach(n=>{ if (n && n.querySelectorAll) upgradeIcons(n); }); }));
    mo.observe(document.documentElement || document.body, { childList: true, subtree: true });
  } catch(e){}
})();

</script>

<!-- Theme tokens override (volleyball light/dark) -->
<style id="vb-theme">
  :root {
    --bg: #f8faff;
    --card: #ffffff;
    --text: #111827;
    --text-inverse: #ffffff;
    --muted: #6b7785;
    --accent: #1e88e5; /* blue */
    --accent-2: #ffb300; /* yellow */
  --glass: rgba(255,255,255,0.9);
  --shadow: rgba(20,30,40,0.12);
  --header-bg: rgba(255,255,255,0.88);
    --border-radius: 16px;
  }
  .theme-dark, .theme-dark body, .theme-dark :root {
    --bg: #121212;
    --card: #1e1e1e;
    --text: #e6eefb;
    --text-inverse: #0b1220;
    --muted: #9aa9c7;
    --accent: #6ab7ff;
    --accent-2: #ffb300;
  --glass: rgba(20,20,20,0.9);
  --shadow: rgba(0,0,0,0.6);
  --header-bg: rgba(18,18,18,0.95);
  }
  /* small helpers for theme switch visuals */
  #themeToggle + .icon, .theme-switch .icon { transition: transform 0.18s ease, color 0.18s ease; }
  .theme-dark #themeToggle + .icon { transform: rotate(20deg); color: var(--accent-2); }
  /* Dark-mode visual fixes: ensure cards, inputs and modals remain legible
     without changing component structure (overrides keep specificity low).
     These are conservative tweaks to fix remaining black text / invisible inputs. */
  .theme-dark .card,
  .theme-dark .note-card,
  .theme-dark .action-tile,
  .theme-dark .notif-card,
  .theme-dark #membershipCard,
  .theme-dark .membership-card,
  .theme-dark .modal { 
    background: rgba(255,255,255,0.02);
    color: var(--text);
    border-color: rgba(255,255,255,0.04);
  }
  .theme-dark input,
  .theme-dark textarea,
  .theme-dark select,
  .theme-dark .input,
  .theme-dark .modal .modal-body textarea {
    border: 1px solid rgba(255,255,255,0.06) !important;
    background: rgba(255,255,255,0.02) !important;
    color: var(--text) !important;
  }
</style>

<script>
// Apply persisted theme and wire the toggle. Uses localStorage 'theme' with values 'light'|'dark'.
(function(){
  const key = 'theme';
  const preferredDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  function applyTheme(t){
    try{
      const root = document.documentElement;
      const body = document.body || root;
      if(!root) return;
      console.debug('applyTheme ->', t);
      if(t === 'dark') {
        root.classList.add('theme-dark');
        try{ body.classList.add('theme-dark'); }catch(e){}
      } else {
        root.classList.remove('theme-dark');
        try{ body.classList.remove('theme-dark'); }catch(e){}
      }
      // set data-theme attribute for any CSS that may check it
      try{ root.setAttribute('data-theme', t); }catch(e){}
      try{ body.setAttribute('data-theme', t); }catch(e){}
      // update toggle states if present (keep all toggles in sync)
      try{ const cb = document.getElementById('themeToggle'); if(cb) cb.checked = (t === 'dark'); }catch(e){}
      try{ const settingsCb = document.getElementById('settingsThemeToggle'); if(settingsCb) settingsCb.checked = (t === 'dark'); }catch(e){}
      try{ const headerCb = document.getElementById('headerThemeToggle'); if(headerCb) headerCb.checked = (t === 'dark'); }catch(e){}
      // update meta theme-color if exists
      const meta = document.querySelector('meta[name="theme-color"]'); if(meta) meta.setAttribute('content', t === 'dark' ? '#121212' : '#f8faff');
    }catch(e){console.warn('applyTheme error', e);}  }

  // initial apply
  try{
    let t = localStorage.getItem(key);
    if(!t) t = preferredDark ? 'dark' : 'light';
    applyTheme(t);
    // expose to global so Settings page can call it
    try{ window.applyTheme = applyTheme; }catch(e){}
  }catch(e){console.debug('theme init failed', e);}

  // wire toggle change event
  try{
    const cb = document.getElementById('themeToggle');
    if(cb) cb.addEventListener('change', function(){
      try{ const next = cb.checked ? 'dark' : 'light'; localStorage.setItem(key, next); applyTheme(next); } catch(e){ console.warn('theme toggle failed', e); }
    });
  }catch(e){ console.debug('attach toggle listener failed', e); }
})();
</script>
  <script>
  // Wire the settings & header theme toggles after DOM is ready so elements exist
  (function(){
    try{
      const key = 'theme';
      function initThemeToggleWiring(){
        try{
          const settingsCb = document.getElementById('settingsThemeToggle');
          const headerCb = document.getElementById('headerThemeToggle');
          function syncFromStorage(){
            try{
              const t = localStorage.getItem(key) || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
              if(settingsCb) settingsCb.checked = (t === 'dark');
              if(headerCb) headerCb.checked = (t === 'dark');
            }catch(e){console.warn('syncFromStorage error', e);}          
          }
          // initial sync
          syncFromStorage();
          // when user toggles in settings, persist and apply
          if(settingsCb) settingsCb.addEventListener('change', function(){
            try{
              const next = settingsCb.checked ? 'dark' : 'light';
              localStorage.setItem(key, next);
              if(window.applyTheme) window.applyTheme(next); else {
                if(next === 'dark') document.documentElement.classList.add('theme-dark'); else document.documentElement.classList.remove('theme-dark');
              }
              // also update any other toggles (header/floating)
              try{ const other = document.getElementById('themeToggle'); if(other) other.checked = settingsCb.checked; }catch(e){}
              try{ if(headerCb) headerCb.checked = settingsCb.checked; }catch(e){}
            }catch(e){console.warn('settings theme toggle failed', e);} 
          });
          // header toggle: when changed, persist and apply and update settings toggle
          if(headerCb) headerCb.addEventListener('change', function(){
            try{
              const next = headerCb.checked ? 'dark' : 'light';
              localStorage.setItem(key, next);
              if(window.applyTheme) window.applyTheme(next); else {
                if(next === 'dark') document.documentElement.classList.add('theme-dark'); else document.documentElement.classList.remove('theme-dark');
              }
              try{ if(settingsCb) settingsCb.checked = headerCb.checked; }catch(e){}
              try{ const other = document.getElementById('themeToggle'); if(other) other.checked = headerCb.checked; }catch(e){}
            }catch(e){console.warn('header theme toggle failed', e);} 
          });
          // label/input are left to native browser behavior for clicks/keyboard; no manual toggles to avoid double events
          // observe storage changes from other contexts
          window.addEventListener('storage', function(e){ if(e.key === key) syncFromStorage(); });
        }catch(e){ console.warn('initThemeToggleWiring error', e); }
      }
      if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initThemeToggleWiring); else initThemeToggleWiring();
    }catch(e){ console.warn('settings theme wiring failed', e); }
  })();
  </script>
  <!-- Image compress / face-crop (libraries + helper) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js"></script>
  <script src="./libs/image-compress.js"></script>
  <script src="./libs/indexeddb-queue.js"></script>
  <style>
    /* Inline spinner used inside buttons */
    .inline-spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(0,0,0,0.12);border-top-color:var(--accent,#0a7);border-radius:50%;animation:__spin 1s linear infinite;vertical-align:middle}
    @keyframes __spin{to{transform:rotate(360deg)}}
  </style>
  <script>
  // Provide a simple global spinner toggle for the backup button (no storage-status UI)
  (function(){
    try {
      window.setBackupButtonLoading = function(on) {
        try {
          const btn = document.getElementById('backupNowBtn');
          const spinner = document.getElementById('backupNowSpinner');
          const progressContainer = document.getElementById('backupProgressContainer');
          const progressText = document.getElementById('backupProgressText');
          const textEl = document.getElementById('backupNowText');
          if (btn) btn.disabled = !!on;
          if (btn) btn.style.opacity = on ? '0.7' : '';
          if (spinner) spinner.style.display = on ? 'inline-block' : 'none';
          if (on) {
            if (textEl) textEl.textContent = 'در حال بک‌آپ گیری...';
            if (progressText) progressText.textContent = 'سیستم در حال بک‌آپ گیری است';
            if (progressContainer) progressContainer.style.display = 'block';
          } else {
            if (textEl) textEl.textContent = 'ایجاد بک‌آپ جدید';
            if (progressText) progressText.textContent = 'بک‌آپ انجام شد';
            if (progressContainer) {
              // show success message briefly then hide
              setTimeout(() => {
                try { progressContainer.style.display = 'none'; if (progressText) progressText.textContent = 'سیستم در حال بک‌آپ گیری است'; } catch(e){}
              }, 2000);
            }
          }
        } catch(e) {}
      };
    } catch(e) {}
  })();
  /* Share poster builder and exporter */
  (function(){
    const SHARE_DEFAULT_AVATAR = 'assets/icons/avatar.png';

    function _ensureShareCardContainer() {
      let el = document.getElementById('shareCard');
      if (!el) {
        el = document.createElement('div'); el.id = 'shareCard'; el.setAttribute('aria-hidden','true'); el.style.display='none'; document.body.appendChild(el);
      }
      return el;
    }

    function buildShareCard(player) {
      const el = _ensureShareCardContainer();
      el.innerHTML = '';
      el.setAttribute('aria-hidden','false');
      const inner = document.createElement('div'); inner.className='poster-inner';
      const photoWrap = document.createElement('div'); photoWrap.className='poster-photo';
      const img = document.createElement('img'); img.id='shareCardPhoto'; img.alt = player && player.name ? `عکس پروفایل ${player.name}` : 'عکس پروفایل'; photoWrap.appendChild(img); inner.appendChild(photoWrap);
      const body = document.createElement('div'); body.className='poster-body';
      const nameEl = document.createElement('div'); nameEl.className='poster-name'; nameEl.textContent = player && player.name ? player.name : '-'; body.appendChild(nameEl);
      const rows = document.createElement('div'); rows.className='poster-rows';
      function addRow(labelText, valueText){ const row=document.createElement('div'); row.className='poster-row'; const label=document.createElement('div'); label.className='label'; label.textContent=labelText; const value=document.createElement('div'); value.className='value'; value.textContent=valueText||'-'; row.appendChild(label); row.appendChild(value); rows.appendChild(row); }
      addRow('تلفن', player && player.phone ? player.phone : '-');
      addRow('تاریخ تولد', player && player.birthdate ? player.birthdate : '-');
      addRow('تاریخ عضویت', player && (player.membershipDate || player.joinDate) ? (player.membershipDate || player.joinDate) : '-');
      addRow('وضعیت جسمی', player && player.physicalStatus ? player.physicalStatus : '-');
      addRow('مهارت‌ها', player && player.skills ? (Array.isArray(player.skills) ? player.skills.join('، ') : player.skills) : '-');
      addRow('امتیاز / امتیازها', player && (player.points || player.score) ? ((player.points || player.score).toString()) : '-');
      body.appendChild(rows); inner.appendChild(body); el.appendChild(inner);
      return img;
    }

    function _waitImageLoad(imgEl, timeout=3000){ return new Promise(res=>{ if(!imgEl) return res(false); if(imgEl.complete && imgEl.naturalWidth) return res(true); let settled=false; const onload=()=>{ if(settled) return; settled=true; cleanup(); res(true); }; const onerror=()=>{ if(settled) return; settled=true; cleanup(); res(false); }; const cleanup=()=>{ imgEl.removeEventListener('load', onload); imgEl.removeEventListener('error', onerror); }; imgEl.addEventListener('load', onload); imgEl.addEventListener('error', onerror); setTimeout(()=>{ if(settled) return; settled=true; cleanup(); res(!!imgEl.naturalWidth); }, timeout); }); }

    async function _fetchImageAsObjectURL(url){ try{ const resp = await fetch(url, { mode: 'cors' }); if(!resp.ok) throw new Error('fetch failed ' + resp.status); const blob = await resp.blob(); return { objUrl: URL.createObjectURL(blob), blob }; } catch(e){ console.warn('fetch image failed', e); return null; } }

    async function exportSharePoster(player){ if(!player) throw new Error('player required'); const el=_ensureShareCardContainer(); const imgEl = buildShareCard(player);
      el.style.display='block'; el.setAttribute('aria-hidden','false');
      let objUrlInfo=null;
      try{
        if(player.photo){ objUrlInfo = await _fetchImageAsObjectURL(player.photo); if(objUrlInfo && objUrlInfo.objUrl) imgEl.src = objUrlInfo.objUrl; else imgEl.src = SHARE_DEFAULT_AVATAR; } else { imgEl.src = SHARE_DEFAULT_AVATAR; }
      } catch(e){ console.warn('error preparing image', e); imgEl.src = SHARE_DEFAULT_AVATAR; }
      await _waitImageLoad(imgEl, 3000);
      await new Promise(r=>setTimeout(r,60)); await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
      let pngBlob = null;
      if(window.html2canvas){ try{ const canvas = await window.html2canvas(el, { scale: 3, useCORS: true, backgroundColor: null }); pngBlob = await new Promise(res=>canvas.toBlob(res,'image/png')); } catch(e){ console.warn('html2canvas failed', e); pngBlob = null; } }
      if(!pngBlob && typeof renderPlayerCanvasFromData === 'function'){ try{ pngBlob = await renderPlayerCanvasFromData(player, { width:1080, height:1080 }); } catch(e){ console.warn('renderer fallback failed', e); pngBlob = null; } }
      if(!pngBlob){ try{ const c=document.createElement('canvas'); c.width=1080; c.height=1080; const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle='#111'; ctx.font='bold 36px Vazirmatn, sans-serif'; ctx.fillText(player.name||'Player',40,80); pngBlob = await new Promise(res=>c.toBlob(res,'image/png')); } catch(e){ console.error('ultimate fallback failed', e); pngBlob=null; } }
      if(!pngBlob){ if(objUrlInfo && objUrlInfo.objUrl) URL.revokeObjectURL(objUrlInfo.objUrl); el.style.display='none'; el.setAttribute('aria-hidden','true'); throw new Error('Failed to create poster image'); }
      const safeName = (player.name||'player').replace(/\s+/g,'_').replace(/[^ -\u007F\w\-_.]/g,''); const file = new File([pngBlob], `${safeName}_poster.png`, { type: 'image/png' });
      let textFile=null; try{ const profileText = (typeof formatPlayerProfileText === 'function') ? formatPlayerProfileText(player) : ''; textFile = new File([profileText||''], `${safeName}_profile.txt`, { type: 'text/plain;charset=utf-8' }); } catch(e){ textFile=null; }
      try{
        if(navigator.canShare && navigator.canShare({ files: textFile ? [file, textFile] : [file] })){ try{ await navigator.share({ files: textFile ? [file, textFile] : [file], title: player.name || 'پروفایل بازیکن' }); } catch(err){ console.warn('navigator.share failed', err); const url=URL.createObjectURL(pngBlob); const a=document.createElement('a'); a.href=url; a.download=`${safeName}_poster.png`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); } }
        else if(navigator.share && !navigator.canShare){ try{ await navigator.share({ title: player.name || 'پروفایل بازیکن', text: (typeof formatPlayerProfileText === 'function' ? formatPlayerProfileText(player) : '') }); } catch(err){ const url=URL.createObjectURL(pngBlob); const a=document.createElement('a'); a.href=url; a.download=`${safeName}_poster.png`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); } }
        else { const url=URL.createObjectURL(pngBlob); const a=document.createElement('a'); a.href=url; a.download=`${safeName}_poster.png`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
      } finally { if(objUrlInfo && objUrlInfo.objUrl) { try{ URL.revokeObjectURL(objUrlInfo.objUrl);}catch(e){} } el.style.display='none'; el.setAttribute('aria-hidden','true'); await new Promise(r=>setTimeout(r,60)); }
    }

    // expose function globally so existing handlers can call it
    window.buildShareCard = buildShareCard;
    window.exportSharePoster = exportSharePoster;

    // augment existing handlers if present
    if(typeof captureAndSharePlayerProfile === 'function'){ const _orig = captureAndSharePlayerProfile; captureAndSharePlayerProfile = async function(p, shareText=''){ try{ await exportSharePoster(p); return; } catch(e){ console.warn('exportSharePoster failed, falling back', e); return await _orig(p, shareText); } }; }
    if(typeof shareProfileDirect === 'function'){ const _orig = shareProfileDirect; shareProfileDirect = async function(p){ try{ await exportSharePoster(p); return; } catch(e){ console.warn('exportSharePoster failed in shareProfileDirect, falling back', e); return await _orig(p); } }; }
  })();
  </script>
<script>
// Deterministic canvas renderer: draws the share card to a canvas and returns a PNG Blob
async function renderShareCanvasFromData(m, opts = {}) {
  const w = opts.width || 1080; const h = opts.height || 1920;
  const colorA = opts.colorA || '#ff6b6b'; const colorB = opts.colorB || '#ff9ac2';
  // create canvas
  const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  // background gradient
  // draw background gradient first
  const g = ctx.createLinearGradient(0,0,0,h);
  g.addColorStop(0, colorA);
  g.addColorStop(1, colorB);
  ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
  // then optionally draw the court background image on top with low opacity so it shows through
  try {
  const court = new Image();
  const courtSrc = (opts.courtImage) ? opts.courtImage : 'icons/court.png';
  try { if (typeof courtSrc === 'string' && (courtSrc.startsWith('http://') || courtSrc.startsWith('https://'))) court.crossOrigin = 'anonymous'; } catch(_) {}
  await new Promise((res, rej) => { court.onload = res; court.onerror = () => rej(new Error('court load failed')); court.src = courtSrc; });
    const cw = Math.floor(w * 0.7); const ch = Math.floor(h * 0.7);
    const cx = Math.floor((w - cw) / 2); const cy = Math.floor(h * 0.08);
    ctx.save(); ctx.globalAlpha = 0.18; ctx.drawImage(court, cx, cy, cw, ch); ctx.restore();
  } catch (e) {
    console.debug('court bg not available', e);
  }
  // ensure webfonts are loaded before drawing text
  try { if (document.fonts && document.fonts.ready) await document.fonts.ready; } catch(e) { /* ignore */ }
  // draw top padding spacer (visual offset)
  const topOffset = Math.floor(h * 0.08);
  // logos row
  const logoSize = Math.floor(w * 0.25);
  const logoY = topOffset + 60;
  const leftX = Math.floor(w * 0.2);
  const rightX = Math.floor(w * 0.8) - logoSize;
  // helper to draw image from src (handles data-urls and same-origin images)
  async function drawLogo(src, dx, dy, dSize) {
    if (!src) return;
    try {
  const img = new Image();
  try { if (typeof src === 'string' && (src.startsWith('http://') || src.startsWith('https://'))) img.crossOrigin = 'anonymous'; } catch(_) {}
  await new Promise((res, rej) => { img.onload = res; img.onerror = () => rej(new Error('logo load failed')); img.src = src; });
      // draw with rounded rect mask
      const r = Math.max(12, Math.floor(dSize * 0.12));
      roundRect(ctx, dx, dy, dSize, dSize, r, true, false);
      ctx.save();
      ctx.beginPath();
      roundedClip(ctx, dx, dy, dSize, dSize, r);
      ctx.drawImage(img, dx, dy, dSize, dSize);
      ctx.restore();
    } catch (err) {
      console.warn('drawLogo error', err, src);
      // draw placeholder circle
      ctx.fillStyle = 'rgba(255,255,255,0.12)'; ctx.beginPath(); ctx.arc(dx + dSize/2, dy + dSize/2, dSize/2 - 6, 0, Math.PI*2); ctx.fill();
    }
  }

  // rounded rect helper (stroke/fill)
  function roundRect(ctx, x, y, w, h, r, fill, stroke) {
    if (typeof r === 'undefined') r = 5;
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
    if (fill) ctx.fill();
    if (stroke) ctx.stroke();
  }
  function roundedClip(ctx, x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
    ctx.clip();
  }

  // draw logos (A left, B right)
  const logoA = (m.logoA && String(m.logoA).startsWith('data:')) ? m.logoA : (m.logoA || (state.settings && state.settings.logo) || 'icons/volleyball (1).png');
  const logoB = (m.logoB && String(m.logoB).startsWith('data:')) ? m.logoB : (m.logoB || 'icons/volleyball (1).png');
  await Promise.all([
    drawLogo(logoA, leftX, logoY, logoSize),
    drawLogo(logoB, rightX, logoY, logoSize)
  ]);

  // team names row
  ctx.fillStyle = '#ffffff'; ctx.textAlign = 'center';
  ctx.font = '700 64px Vazirmatn, sans-serif';
  const teamText = (m.teamA || '') + '  VS  ' + (m.teamB || '');
  ctx.fillText(teamText, w/2, logoY + logoSize + 110);

  // info box near bottom
  const infoBoxH = 220; const infoBoxW = Math.floor(w * 0.88); const infoX = Math.floor((w - infoBoxW)/2); const infoY = h - infoBoxH - 160;
  ctx.fillStyle = 'rgba(255,255,255,0.08)'; roundRect(ctx, infoX, infoY, infoBoxW, infoBoxH, 18, true, false);
  ctx.fillStyle = '#fff'; ctx.font = '600 28px Vazirmatn, sans-serif'; ctx.textAlign = 'left';
  const infoPad = 28; ctx.fillText('نوع: ' + (mapKindToPersian(m.kind) || '-'), infoX + infoPad, infoY + 50);
  ctx.fillText('تاریخ: ' + (m.date || '-'), infoX + infoPad, infoY + 96);
  ctx.fillText('مکان: ' + (m.venue || '-'), infoX + infoPad, infoY + 142);
  ctx.fillText('ساعت: ' + (m.time || '-'), infoX + infoPad, infoY + 188);

  // small title near top
  ctx.fillStyle = 'rgba(255,255,255,0.95)'; ctx.textAlign = 'center'; ctx.font = 'bold 44px Vazirmatn, sans-serif';
  ctx.fillText(m.title || ((m.teamA||'') + ' vs ' + (m.teamB||'')), w/2, topOffset + 40);

  // convert to blob
  return await new Promise((res, rej) => { canvas.toBlob(b => { if (b) res(b); else rej(new Error('toBlob failed')); }, 'image/png'); });
}

// helper to read share color inputs from the DOM (used by multiple share flows)
function readShareColors() {
  try {
    const a = (qs('#shareColorA') && qs('#shareColorA').value) || '#ff6b6b';
    const b = (qs('#shareColorB') && qs('#shareColorB').value) || '#ff9ac2';
    return { colorA: a, colorB: b };
  } catch (e) { return { colorA: '#ff6b6b', colorB: '#ff9ac2' }; }
}

// helper to enable/disable backup buttons (keeps original button elements)
function enableBackupButtons(enable = true) {
  try {
    const ids = ['backupNowBtn', 'restoreBackupBtn', 'backupHistoryBtn'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.disabled = !enable;
      if (enable) el.classList.remove('opacity-50'); else el.classList.add('opacity-50');
    });
  } catch (e) {
    console.error('enableBackupButtons error', e);
  }
}
</script>
  <style id="shareCard-styles">
  /* Scoped styles for the share poster (#shareCard) */
  #shareCard {
    width: 1080px;
    height: 1080px;
    box-sizing: border-box;
    background: #ffffff;
    border-radius: 18px;
    padding: 16px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    font-family: 'Vazirmatn', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    color: #222;
    display: none; /* toggled by JS only when exporting */
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  #shareCard .poster-inner { width:100%; height:100%; display:flex; flex-direction:column; align-items:stretch; }
  #shareCard .poster-photo { flex:0 0 44%; border-radius:12px; overflow:hidden; background:linear-gradient(180deg,#f4f4f4 0%, #e9e9e9 100%); position:relative; }
  #shareCard .poster-photo img { width:100%; height:100%; object-fit:cover; display:block; }
  #shareCard .poster-body { flex:1 1 auto; padding-top:14px; display:flex; flex-direction:column; gap:10px; }
  #shareCard .poster-name { font-weight:700; font-size:56px; line-height:1.05; color:#111; text-align:center; word-break:break-word; margin-bottom:2px; }
  #shareCard .poster-row { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:6px 12px; border-radius:10px; background:rgba(0,0,0,0.02); }
  #shareCard .poster-row .label { font-weight:600; color:#555; font-size:20px; flex:0 0 auto; }
  #shareCard .poster-row .value { font-weight:500; color:#111; font-size:20px; text-align:right; flex:1 1 auto; direction:rtl; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  #shareCard .poster-rows { display:flex; flex-direction:column; gap:8px; padding:6px 4px; }
  #shareCard .accent { color:#FF6B00; font-weight:700; }
  #shareCard .support { color:#007BFF; font-weight:700; }
  #shareCard .poster-name { font-size: clamp(36px, 5vw, 56px); }
  #shareCard .poster-row .value, #shareCard .poster-row .label { font-size: clamp(16px, 2.2vw, 20px); }
  @media screen { #shareCard[aria-hidden="true"] { display: none !important; } }
  </style>
</head>
<body class="mobile-active sports-bg">
<div class="wrap">
  <main>
    <div id="view-root">
      <section id="view-home">
        <header id="appHeader" style="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 12px;">
          <!-- Left side: logo and title -->
          <div style="display:flex;align-items:center;gap:12px;">
            <img id="appLogo" src="./icons/logo.png" alt="لوگو" style="width:44px;height:44px;">
            <span id="appTitle" style="font-size:18px;">مدیریت باشگاه والیبال</span>
          </div>
          <!-- Right side: header theme switch (visible) -->
          <div style="display:flex;align-items:center;gap:12px;">
            <label class="header-theme-switch" title="تم تاریک/روشن" style="display:inline-flex;align-items:center;gap:8px;">
              <input id="headerThemeToggle" type="checkbox" aria-label="تم تاریک/روشن" class="visually-hidden" />
              <span class="switch-track" aria-hidden="true"><span class="switch-thumb"></span></span>
            </label>
          </div>
        </header>
        <div class="grid">
  
          <div class="card">
            <div class="section-title" style="display:flex;align-items:center;gap:8px;">
              <h3 style="margin:0;">جدیدترین بازیکنان ثبت نامی</h3>
              <div class="actions">
                <button id="addPlayerBtn" class="btn primary mobile-friendly" title="بازیکن جدید" style="padding:8px 12px;white-space:nowrap;">
                  <span class="icon icon-plus" aria-hidden="true"></span>
                  <span>بازیکن جدید</span>
                </button>
              </div>
              </div>
              <script>
              // Global image fallback: replace broken images with an inline SVG placeholder and ensure reserved sizing
              function setGlobalImageFallback() {
                const placeholderSvg = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 24 24"><rect width="100%" height="100%" fill="#f8fafc"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#94a3b8" font-size="10">?</text></svg>');
                function applyTo(img) {
                  if (!img) return;
                  // avoid re-wrapping
                  img.classList.add('reserved');
                  img.addEventListener('error', function onerr() {
                    try {
                      img.removeEventListener('error', onerr);
                      // set a neutral placeholder src so layout stays
                      img.src = placeholderSvg;
                      img.alt = img.alt || 'تصویر در دسترس نیست';
                      img.style.objectFit = img.style.objectFit || 'contain';
                    } catch (e) { console.warn('img fallback failed', e); }
                  });
                  // if already failed to load (cached), and naturalWidth is 0, trigger fallback
                  setTimeout(()=>{ try { if (img.naturalWidth === 0) img.dispatchEvent(new Event('error')); } catch(e){} }, 120);
                }
                // apply to existing images
                Array.from(document.querySelectorAll('img')).forEach(img => applyTo(img));
                // observe future images
                const obs = new MutationObserver(muts => {
                  muts.forEach(m => {
                    m.addedNodes && m.addedNodes.forEach(n => { if (n && n.tagName === 'IMG') applyTo(n); if (n && n.querySelectorAll) Array.from(n.querySelectorAll('img')).forEach(i=>applyTo(i)); });
                  });
                });
                obs.observe(document.body, { childList: true, subtree: true });
              }
              try { window.addEventListener('load', setGlobalImageFallback); } catch(e) { setTimeout(setGlobalImageFallback, 500); }
              </script>
            <div id="playersPreview" class="players-preview"></div>
            <div style="margin-top: 12px; text-align: center;">
              <button id="showAllPlayersBtn" class="btn secondary mobile-hero" style="padding:10px 18px;min-width:220px;display:flex;align-items:center;justify-content:center;gap:10px;text-align:center;">
                <img src="./icons/volleyball (7).png" alt="" class="btn-icon" style="width:20px;height:20px;object-fit:contain;">
                <span style="display:inline-block;min-width:120px;text-align:center;">لیست بازیکنان</span>
              </button>
            </div>
          </div>

          <!-- birthdays card moved below to sit above payments preview -->

          <!-- sessions card kept but button moved to header of players card for compact layout -->
          <div class="card">
            <div class="section-title">
                <h3>آخرین جلسات</h3>
                <div class="actions"><button id="addSessionFromHomeBtn" class="btn primary mobile-friendly" style="padding:8px 12px;white-space:nowrap;display:flex;align-items:center;gap:8px;">
                    <svg class="btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" style="color:var(--text-inverse);">
                      <path d="M12 7v5l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                      <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" />
                    </svg>
                    <span>جلسه جدید</span>
                  </button></div>
              </div>
            <div id="sessionsPreview" class="sessions-preview"></div>
              <!-- removed show all sessions button per user request -->
          </div>
          
          <div class="card">
            <div class="section-title">
                <h3>برنامه تمرینات</h3>
                <div class="actions"><button id="addTrainingFromHomeBtn" class="btn primary mobile-friendly" style="padding:8px 12px;white-space:nowrap;display:flex;align-items:center;gap:8px;">
                    <img src="./icons/volleyball-player-motion-svgrepo-com.svg" alt="والیبال" class="btn-icon white-icon" style="width:18px;height:18px;object-fit:contain;">
                    <span>تمرین جدید</span>
                  </button></div>
              </div>
          <div id="trainingPreview" class="training-preview"></div>
          </div>
          
          <!-- birthdays card (moved here so it sits directly above latest payments) -->
          <div class="card birthday-card">
            <div class="section-title">
              <h3>متولدین امروز</h3>
            </div>
            <div id="birthdaysToday" class="players-preview"></div>
            <div id="noBirthdaysMsg" style="display: none;">هیچ تولدی امروز نیست</div>
          </div>

          <div class="card">
              <div class="section-title">
                <h3>آخرین پرداخت‌ها</h3>
                <div class="actions"></div>
              </div>
              <div id="paymentsPreview" class="payments-preview"></div>
          </div>
          
          <div class="card" style="border-left: 4px solid var(--danger);">
            <!-- حذف مدیریت بیمه‌ها از صفحه اصلی -->
              <div class="section-title">
                <h3>بیمه‌های منقضی</h3>
              </div>
              <div id="expiredInsurances" class="expired-insurances"></div>
          </div>
        </div>

        <!-- Player share modal removed per user request; sharing now happens directly from the profile share button -->
        
        <div class="card" style="margin-top: 16px;">
          <div class="section-title" style="position:relative;">
            <h3>آمار کلی باشگاه</h3>
            <!-- volleyball icon placed at the top-right of this title card; file located in icons/ -->
            <img id="statsIcon" src="./icons/volleyball-svgrepo-com (1).svg" alt="volley" class="stats-icon spin" aria-hidden="true">
          </div>
          <div id="statsContainer" class="stats"></div>
        </div>
      </section>

      <!-- Full-page match create/edit view (top-level) -->
      <section id="view-match-edit" class="hide">
        <div class="view-header fixed">
          <h3 id="matchEditTitle">افزودن / ویرایش مسابقه</h3>
          <button class="back-btn" id="backFromMatchEdit"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="matchEditContent">
            <div id="matchFormPage">
              <!-- Status and Type controls will appear above teams -->
              <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px;">
                <div style="display:flex;gap:12px;align-items:center;justify-content:center;padding:8px;">
                  <label style="display:flex;align-items:center;gap:12px;font-size:18px;">
                    <input type="radio" name="formStatusRadio" id="statusScheduled" value="scheduled" style="width:20px;height:20px;" />
                    <span style="font-size:16px;">برنامه‌ریزی‌شده</span>
                  </label>
                  <label style="display:flex;align-items:center;gap:12px;font-size:18px;">
                    <input type="radio" name="formStatusRadio" id="statusFinished" value="finished" style="width:20px;height:20px;" />
                    <span style="font-size:16px;">انجام شده</span>
                  </label>
                </div>
                <div style="border-bottom:1px solid rgba(0,0,0,0.08);"></div>
                <div style="padding-top:10px;display:flex;gap:14px;flex-wrap:wrap;align-items:center;margin-top:6px;">
                  <label style="display:flex;align-items:center;gap:12px;font-size:20px;"><input type="radio" name="formTypeRadio" id="typeFriendly" value="friendly" style="width:22px;height:22px;"/> دوستانه</label>
                  <label style="display:flex;align-items:center;gap:12px;font-size:20px;"><input type="radio" name="formTypeRadio" id="typeLeague" value="league" style="width:22px;height:22px;"/> لیگ</label>
                  <label style="display:flex;align-items:center;gap:12px;font-size:20px;"><input type="radio" name="formTypeRadio" id="typeKnockout" value="knockout" style="width:22px;height:22px;"/> حذفی</label>
                  <label style="display:flex;align-items:center;gap:12px;font-size:20px;"><input type="radio" name="formTypeRadio" id="typeGroup" value="group" style="width:22px;height:22px;"/> گروهی</label>
                </div>
                <div style="border-bottom:1px solid rgba(0,0,0,0.08);margin-top:8px;"></div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:start;">
                <!-- Team A column -->
                <div class="team-column" style="display:flex;flex-direction:column;gap:8px;">
                  <label class="muted-small">تیم اول</label>
                  <input id="formTeamA" class="input" placeholder="تیم اول" />
                  <label class="muted-small" style="margin-top:6px;">لوگو تیم (از دستگاه)</label>
                  <input id="formTeamALogoFile" type="file" accept="image/*" class="input" />
                  <input id="formTeamALogo" type="hidden" />
                  <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px;align-items:flex-start;">
                    <img id="formTeamAPreview" src="" alt="پیش‌نمایش لوگو تیم اول" style="width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid rgba(0,0,0,0.06);display:none;" />
                    <div class="muted-small" id="formTeamACount">نتیجه ست: <span id="formTeamATotal">-</span></div>
                  </div>
                  <div class="sets-area" style="display:grid;grid-template-columns:1fr;gap:6px;margin-top:10px;">
                    <div style="display:grid;grid-template-columns:1fr;gap:6px;">
                      <input class="input small-set" id="formAset1" placeholder="ست1" />
                      <input class="input small-set" id="formAset2" placeholder="ست2" />
                      <input class="input small-set" id="formAset3" placeholder="ست3" />
                      <input class="input small-set" id="formAset4" placeholder="ست4" />
                      <input class="input small-set" id="formAset5" placeholder="ست5" />
                    </div>
                  </div>
                </div>
                <!-- Team B column -->
                <div class="team-column" style="display:flex;flex-direction:column;gap:8px;">
                  <label class="muted-small">تیم دوم</label>
                  <input id="formTeamB" class="input" placeholder="تیم دوم" />
                  <label class="muted-small" style="margin-top:6px;">لوگو تیم (از دستگاه)</label>
                  <input id="formTeamBLogoFile" type="file" accept="image/*" class="input" />
                  <input id="formTeamBLogo" type="hidden" />
                  <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px;align-items:flex-start;">
                    <img id="formTeamBPreview" src="" alt="پیش‌نمایش لوگو تیم دوم" style="width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid rgba(0,0,0,0.06);display:none;" />
                    <div class="muted-small" id="formTeamBCount">نتیجه ست: <span id="formTeamBTotal">-</span></div>
                  </div>
                  <div class="sets-area" style="display:grid;grid-template-columns:1fr;gap:6px;margin-top:10px;">
                    <div style="display:grid;grid-template-columns:1fr;gap:6px;">
                      <input class="input small-set" id="formBset1" placeholder="ست1" />
                      <input class="input small-set" id="formBset2" placeholder="ست2" />
                      <input class="input small-set" id="formBset3" placeholder="ست3" />
                      <input class="input small-set" id="formBset4" placeholder="ست4" />
                      <input class="input small-set" id="formBset5" placeholder="ست5" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="form-row" style="margin-top:8px;display:flex;gap:8px;align-items:center;">
                <input id="formDate" class="input jalali-input small-set" placeholder="تاریخ (YYYY/MM/DD)" />
                <input id="formTime" class="input small-set" placeholder="ساعت (HH:MM)" maxlength="5" />
              </div>
              <div class="form-row" style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-direction:column;">
                <input id="formHashtag" list="hashtagsList" class="input" placeholder="#هشتگ (اختیاری) مانند مسابقات-استانی-2025" style="width:100%;" />
                <datalist id="hashtagsList"></datalist>
              </div>
              <div class="form-row"><input id="formVenue" class="input" placeholder="مکان" style="flex:1;" /></div>
              <div class="form-row" style="flex-direction:column;">
                <label class="muted-small">یادداشت</label>
                <textarea id="formNotes" class="input" style="min-height:80px;"></textarea>
              </div>
              <div class="form-row" style="flex-direction:column;margin-top:8px;">
                <label class="muted-small">قوانین</label>
                <textarea id="formRules" class="input" style="min-height:60px;"></textarea>
              </div>
              <div class="form-row" style="margin-top:8px;">
                <label class="muted-small">تماس مسئول</label>
                <input id="formContact" class="input" placeholder="شماره تماس" />
              </div>
              <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;"><button id="saveMatchBtn" class="btn primary">ذخیره</button></div>
            </div>
          </div>
        </div>
      </section>
      <section id="view-players" class="hide">
        <div class="view-header fixed">
          <h3>بازیکنان</h3>
          <button class="back-btn" id="backPlayers"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <!-- Box 1: Actions (new player, export) -->
        <div class="card">
          <div style="display:flex;justify-content:flex-start;gap:8px;align-items:center;">
            <button id="openAddPlayerFromList" class="btn primary">بازیکن جدید</button>
            <button id="exportPlayersBtn" class="btn">خروجی لیست</button>
          </div>
        </div>

        <!-- Box 2: Filters and search -->
        <div class="card" style="margin-top:8px;">
          <div style="display:flex;flex-direction:column;gap:8px;">
            <div><!-- search stays full width -->
              <input id="playersSearch" class="search" placeholder="جستجوی سریع..." style="width:100%;" />
            </div>
            <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;align-items:center;">
              <div>
                <select id="filterCategory" class="input" style="width:100%;"><option value="">همه رده‌ها</option></select>
              </div>
              <div>
                <select id="filterInsurance" class="input" style="width:100%;"><option value="">همه بیمه‌ها</option><option value="expired">بیمه منقضی</option></select>
              </div>
              <div>
                <select id="sortPlayers" class="input" style="width:100%;"><option value="new">جدیدترین</option><option value="score">امتیاز</option><option value="name">نام</option></select>
              </div>
              <div>
                <!-- BMI filter: use a single select (dropdown) to match health page and simplify mobile UX -->
                <div id="bmiFilters">
                  <select id="filterBmi" class="input" style="width:100%;">
                    <option value="">همه BMI</option>
                    <option value="کم وزن">کم وزن</option>
                    <option value="سالم">سالم</option>
                    <option value="اضافه وزن">اضافه وزن</option>
                    <option value="چاق">چاق</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Box 3: Players list (direct, no extra card) -->
        <div id="playersList" class="full-list" style="margin-top:8px;"></div>
      </section>

      <section id="view-coaches" class="hide">
        <div class="view-header fixed">
          <h3>مربیان</h3>
          <button class="back-btn" id="backCoaches"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div class="topbar">
            <button id="addCoachBtn" class="btn primary" style="display:inline-flex;align-items:center;justify-content:center;gap:8px;">
              <img src="icons/icons8-coach-100.svg" alt="افزودن" style="width:18px;height:18px;display:inline-block;" />
              <span>مربی جدید</span>
            </button>
          </div>
          <div id="coachesList" class="full-list"></div>
        </div>
      </section>

      <section id="view-sessions" class="hide">
        <div class="view-header fixed">
          <h3>مدیریت تمرینات</h3>
          <button class="back-btn" id="backSessions"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <!-- tabs glued to header -->
          <div style="display:flex;gap:8px;border-bottom:1px solid rgba(0,0,0,0.06);padding-bottom:8px;margin-bottom:12px;">
            <button id="tabManageSessions" class="btn" style="border-bottom:2px solid #6366f1;">مدیریت جلسات</button>
            <button id="tabTrainingPlan" class="btn">برنامه تمرینات</button>
          </div>

          <div id="tabManageSessionsPanel">
            <!-- topbar removed: session creation moved to floating FAB (fabSession) -->
            <div id="sessionsList" class="full-list"></div>
          </div>

          <div id="tabTrainingPlanPanel" style="display:none;">
            <div style="padding:6px 0 12px 0;">
              <div style="font-weight:700;margin-bottom:6px;">برنامهٔ تمرینات آینده</div>
            </div>
            <div id="trainingPlanList" class="full-list"></div>
          </div>
        </div>
      </section>

      <!-- Competitions / Matches view -->
      <section id="view-competitions" class="hide">
        <div class="view-header fixed">
          <div style="display:flex;flex-direction:row;align-items:center;gap:8px;justify-content:flex-start;">
            <button class="back-btn" id="backCompetitions" style="margin-left:8px;"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
            <h3 style="margin:0;">مسابقات</h3>
          </div>
        </div>

        <div class="card">
          <div class="competitions-top">
            <div class="tabs-box" style="width:100%;margin-bottom:10px;background:var(--card);padding:8px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.04);">
              <div class="matches-tabs" id="matchesTabs" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start;">
                <button data-filter="all" class="active" style="flex:0 0 auto;min-width:80px;">همه</button>
                <button data-filter="scheduled" style="flex:0 0 auto;min-width:140px;">برنامه‌ریزی شده</button>
                <button data-filter="finished" style="flex:0 0 auto;min-width:110px;">انجام شده</button>
              </div>
            </div>
            <div class="matches-controls" style="display:flex;align-items:center;justify-content:space-between;gap:8px;width:100%;">
              <div class="matches-controls-left" style="display:flex;gap:8px;flex:1;align-items:center;min-width:0;">
                <input id="matchesSearch" class="input" placeholder="جستجو در مسابقات..." style="flex:1;min-width:140px;box-sizing:border-box;" />
                <div class="matches-date-wrap" style="display:flex;gap:6px;align-items:center;position:relative;min-width:0;">
                  <input id="matchesDateFilter" class="input jalali-input" placeholder="فیلتر بر اساس تاریخ (YYYY/MM/DD)" style="width:180px;text-align:center;box-sizing:border-box;" autocomplete="off" />
                  <button id="clearMatchesDate" class="btn" title="پاک کردن فیلتر">✖</button>
                  <div id="matchesDateWidget" style="position:absolute;right:0;top:46px;z-index:1200;display:none;box-shadow:0 10px 24px rgba(0,0,0,0.12);background:var(--card);border-radius:8px;padding:8px;min-width:300px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                      <button id="mdwPrev" class="btn">‹</button>
                      <div style="font-weight:700;"> <span id="mdwTitle">-</span> </div>
                      <button id="mdwNext" class="btn">›</button>
                    </div>
                    <div id="mdwGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;font-size:13px;"> <!-- days will render here -->
                    </div>
                    <div style="display:flex;justify-content:flex-end;margin-top:8px;gap:8px;"><button id="mdwToday" class="btn">امروز</button><button id="mdwClose" class="btn">بستن</button></div>
                  </div>
                </div>
              </div>
              <div class="muted-small" style="white-space:nowrap;">تعداد: <span id="matchesCount">0</span></div>
            </div>
          </div>

          <div id="matchesList" class="matches-list" style="margin-top:12px;"></div>
        </div>

        <div id="matchDetailModal" class="modal hide">
          <div class="modal-content">
              <div class="modal-header"><strong id="detailTitle">جزئیات مسابقه</strong><button class="modal-close match-detail-close" id="closeMatchDetail">×</button></div>
            <div class="modal-body" id="matchDetailBody"></div>
          </div>
        </div>

        <!-- Share overlay: framed preview + color selectors + action buttons -->
        <div id="shareOverlay" class="modal hide" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;">
          <div style="position:fixed;inset:0;background:rgba(0,0,0,0.55);backdrop-filter:blur(6px);" id="shareOverlayBackdrop"></div>
          <div class="share-modal-outer" style="position:relative;z-index:10000;width:min(94vw,740px);max-height:92vh;display:flex;flex-direction:column;gap:12px;align-items:center;overflow:auto;padding:8px;">
            <div class="share-modal-inner" style="width:100%;background:#fff;border-radius:14px;padding:12px;box-shadow:0 10px 40px rgba(0,0,0,0.12);box-sizing:border-box;display:flex;flex-direction:column;">
            <!-- framed preview box -->
            <div id="shareCard" class="share-preview-wrap" style="width:100%;/*aspect-ratio:9/16;*/border-radius:16px;overflow:hidden;border:1px solid rgba(0,0,0,0.06);background:linear-gradient(180deg,#ff6b6b,#ff9ac2);display:flex;flex-direction:column;max-height:76vh;">
              <div class="card-scroll" style="flex:1 1 auto;display:flex;flex-direction:column;padding:22px;gap:10px;align-items:center;justify-content:flex-start;">
                <div style="height:42px;flex-shrink:0"></div>
                <div id="shareLogosRow" style="width:100%;display:flex;align-items:center;justify-content:space-around;gap:12px;margin-bottom:8px;">
                  <img id="shareLogoA" src="icons/volleyball (1).png" alt="logoA" style="width:120px;height:120px;border-radius:12px;object-fit:contain;background:rgba(255,255,255,0.06);padding:8px;" />
                  <img id="shareLogoB" src="icons/volleyball (1).png" alt="logoB" style="width:120px;height:120px;border-radius:12px;object-fit:contain;background:rgba(255,255,255,0.06);padding:8px;" />
                </div>
                <div id="shareTeamsRow" style="width:100%;display:flex;align-items:center;justify-content:center;gap:12px;font-weight:900;color:#fff;font-size:22px;">
                  <div id="shareTeamA" style="flex:1;text-align:right;padding-right:10px;">تیم الف</div>
                  <div style="flex:0 0 auto;font-size:18px;opacity:0.95">VS</div>
                  <div id="shareTeamB" style="flex:1;text-align:left;padding-left:10px;">تیم ب</div>
                </div>
                <div id="shareInfo" style="width:100%;margin-top:10px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(0,0,0,0.04));color:#fff;display:flex;flex-direction:column;gap:8px;font-weight:600;">
                  <div style="display:flex;justify-content:space-between;"><span>نوع</span><span id="shareKind">-</span></div>
                  <div style="display:flex;justify-content:space-between;"><span>تاریخ</span><span id="shareDate">-</span></div>
                  <div style="display:flex;justify-content:space-between;"><span>مکان</span><span id="shareVenue">-</span></div>
                  <div style="display:flex;justify-content:space-between;"><span>ساعت</span><span id="shareTime">-</span></div>
                </div>
              </div>
            </div>

            <!-- color selectors (above buttons) -->
            <div class="share-controls-wrap" style="width:100%;display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;padding:6px 6px;flex:0 0 auto;">
              <div style="display:flex;align-items:center;gap:6px;"><label style="font-size:13px;color:var(--muted);">رنگ آغاز</label><input id="shareColorA" type="color" value="#ff6b6b" style="width:48px;height:34px;border-radius:6px;border:0;padding:0;" /></div>
              <div style="display:flex;align-items:center;gap:6px;"><label style="font-size:13px;color:var(--muted);">رنگ پایان</label><input id="shareColorB" type="color" value="#ff9ac2" style="width:48px;height:34px;border-radius:6px;border:0;padding:0;" /></div>
            </div>

            <!-- buttons row (side-by-side but responsive) -->
            <div class="share-actions-wrap" style="width:100%;display:flex;padding:8px 6px;flex:0 0 auto;">
              <div style="flex:1;display:flex;gap:10px;align-items:center;justify-content:space-between;">
                <button id="closeShareOverlay" class="btn" style="flex:1 1 auto;max-width:160px;">بستن</button>
                <button id="shareToSocialBtn" class="btn primary birthday-share-btn" style="flex:1 1 auto;max-width:420px;">اشتراک کارت بازی</button>
              </div>
            </div>
            </div>
          </div>
        </div>

        <!-- Full-page match create/edit view was moved to be a top-level section -->

        

        <!-- Inline date filter replaced calendar modal for easier access -->

  <div class="fab" id="addMatchFab" title="افزودن مسابقه">+</div>
      </section>

      <section id="view-payments" class="hide">
        <div class="view-header fixed">
          <h3>مدیریت شهریه</h3>
          <button class="back-btn" id="backPayments"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div style="display: grid; gap: 12px; margin-top: 12px;">
            <!-- Floating add-payment FAB (round +) - opens the modal -->
            <!-- payment FAB moved to top-level and is shown only on payments view -->
            
            <div class="highlight-box" style="display:flex;gap:8px;">
              <button id="showDebtorsBtn" class="btn warning">نمایش بدهکاران آخرین دوره</button>
              <button id="reportPaymentsBtn" class="btn">گزارش پرداخت</button>
            </div>
          </div>
          <div id="paymentList" class="full-list" style="margin-top:12px;"></div>
        </div>
      </section>

      <section id="view-insurance" class="hide">
        <div class="view-header fixed">
          <h3>مدیریت بیمه‌ها</h3>
          <button class="back-btn" id="backInsurance"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div class="topbar">
            <div>
              <select id="insuranceCategoryFilter" class="input"><option value="">همه رده‌ها</option></select>
              <select id="insuranceStatusFilter" class="input"><option value="">همه وضعیت‌ها</option><option value="active">فعال</option><option value="expired">منقضی</option><option value="none">بدون بیمه</option></select>
            </div>
          </div>
          <div id="insuranceList" class="full-list"></div>
        </div>
      </section>

      <section id="view-health" class="hide">
        <div class="view-header fixed">
          <h3>سلامت بازیکنان</h3>
          <button class="back-btn" id="backHealth"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div class="topbar">
            <div>
              <input id="healthSearch" class="search" placeholder="جستجوی بازیکن..." />
              <select id="healthBmiFilter" class="input"><option value="">همه وضعیت BMI</option><option value="کم وزن">کم وزن</option><option value="سالم">سالم</option><option value="اضافه وزن">اضافه وزن</option><option value="چاق">چاق</option></select>
              
            </div>
          </div>
          <div id="healthList" class="health-grid"></div>
        </div>
      </section>

      <section id="view-player-form" class="hide">
        <div class="view-header fixed">
          <h3 id="playerFormTitle">ثبت بازیکن</h3>
          <button class="back-btn" id="backPlayerForm"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="playerFormContent"></div>
        </div>
      </section>

      <section id="view-coach-form" class="hide">
        <div class="view-header fixed">
          <h3 id="coachFormTitle">افزودن مربی</h3>
          <button class="back-btn" id="backCoachForm"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="coachFormContent"></div>
        </div>
      </section>

      <section id="view-private-class" class="hide">
        <div class="view-header fixed">
          <h3 id="privateClassTitle">کلاس خصوصی</h3>
          <button class="back-btn" id="backPrivateClass"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="privateClassContent"></div>
        </div>
      </section>

      <section id="view-session-attendance" class="hide">
        <div class="view-header fixed">
          <h3 id="attendanceTitle">حضور/غیاب</h3>
          <button class="back-btn" id="backAttendance"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="attendanceContent"></div>
        </div>
      </section>

      <section id="view-note" class="hide">
        <div class="view-header fixed">
          <h3>یادداشت برای بازیکن</h3>
          <button class="back-btn" id="backNote"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="noteContent"></div>
        </div>
      </section>

      <section id="view-player-profile" class="hide">
        <div class="view-header fixed">
          <h3 id="profileTitle">پروفایل بازیکن</h3>
          <button class="back-btn" id="backProfile"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="profileContent"></div>
          <!-- Hidden share poster container (populated dynamically) -->
          <div id="shareCard" aria-hidden="true" style="display:none;"></div>
          <!-- Hidden compact poster (600x600) for quick share/export -->
          <div id="sharePoster600" aria-hidden="true" style="display:none;"></div>
        </div>
      </section>

      <section id="view-membership" class="hide">
        <div class="view-header fixed">
          <h3 id="membershipTitle">صدور کارت عضویت</h3>
          <button class="back-btn" id="backMembership"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="membershipContent"></div>
        </div>
      </section>

      <section id="view-all-sessions" class="hide">
        <div class="view-header fixed">
          <h3 id="allSessionsTitle">همه جلسات</h3>
          <button class="back-btn" id="backAllSessions"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="allSessionsContent"></div>
        </div>
      </section>

      <section id="view-all-payments" class="hide">
        <div class="view-header fixed">
          <h3 id="allPaymentsTitle">همه پرداخت‌ها</h3>
          <button class="back-btn" id="backAllPayments"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="allPaymentsContent"></div>
        </div>
      </section>

  <!-- duplicate competitions section removed to keep single view-competitions block -->

      <section id="view-debtors" class="hide">
        <div class="view-header fixed">
          <h3>بدهکاران دوره</h3>
          <button class="back-btn" id="backDebtors"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="debtorsContent"></div>
        </div>
      </section>

      <section id="view-payment-report" class="hide">
        <div class="view-header fixed">
          <h3>گزارش پرداخت‌ها</h3>
          <button class="back-btn" id="backPaymentReport"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="paymentReportContent"></div>
        </div>
      </section>

      <section id="view-rank-editor" class="hide">
        <div class="view-header fixed">
          <h3>ویرایش رده‌ها</h3>
          <button class="back-btn" id="backRankEditor"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="rankEditorContent"></div>
        </div>
      </section>

      <section id="view-players-export" class="hide">
        <div class="view-header fixed">
          <h3>خروجی بازیکنان</h3>
          <button class="back-btn" id="backPlayersExport"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="playersExportContent"></div>
        </div>
      </section>

      <section id="view-event-form" class="hide">
        <div class="view-header fixed">
          <h3 id="eventFormTitle">ثبت رویداد</h3>
          <button class="back-btn" id="backEventForm"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="eventFormContent"></div>
        </div>
      </section>

      <section id="view-settings" class="hide">
        <div class="view-header fixed">
          <h3>ویرایش تنظیمات</h3>
          <button class="back-btn" id="backSettings"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="settingsContent">
            <!-- Theme control: moved here per request -->
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 4px;">
              <div style="display:flex;flex-direction:column;">
                <strong>تم برنامه</strong>
                <small style="color:var(--muted);">انتخاب بین حالت روشن و تیره</small>
              </div>
              <div>
                <label style="display:inline-flex;align-items:center;gap:10px;cursor:pointer;">
                  <input id="settingsThemeToggle" type="checkbox" aria-label="تم تاریک/روشن" style="width:36px;height:20px;" />
                </label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="view-edit-payment" class="hide">
        <div class="view-header fixed">
          <h3>ویرایش پرداخت</h3>
          <button class="back-btn" id="backEditPayment"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card">
          <div id="editPaymentContent"></div>
        </div>
      </section>

      <section id="view-birthday-greeting" class="hide">
  <div class="view-header fixed">
    <h3>تبریک تولد</h3>
    <button class="back-btn" id="backBirthdayGreeting">
      <svg viewBox="0 0 24 24">
        <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/>
      </svg>
    </button>
  </div>
  <div class="card">
    <div id="birthdayGreetingContent" style="text-align: center; animation: fadeIn 0.5s ease-in-out;"></div>
  </div>
</section>

      <section id="view-notifications" class="hide">
        <div class="view-header fixed">
          <h3>اعلان‌ها</h3>
          <button class="back-btn" id="backNotifications"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
        </div>
        <div class="card" style="position:relative;">
          <div id="notificationsContent"></div>
        </div>
      </section>
    </section>

      <section id="view-account" class="hide">
    <div class="view-header fixed">
    <h3>حساب کاربری</h3>
    <button class="back-btn" id="backAccount"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
    </div>
       <div class="card" style="padding:0;overflow:visible;">
         <!-- Settings card (separate) -->
         <div class="card" style="padding:12px 16px; margin:12px; border-radius:12px; background:linear-gradient(90deg,#facc15,#fbbf24);">
              <div id="settingsBox" style="display:flex;justify-content:center;align-items:center;gap:12px;">
               <button id="settingsFromAccount" class="btn" style="padding:8px 12px;background:#111;color:#fff;border-radius:10px;border:none;font-weight:700;">تنظیمات</button>
               <button id="notificationsFromSettings" class="btn" style="padding:8px 10px;background:transparent;border:1px solid rgba(0,0,0,0.06);border-radius:10px;color:var(--muted);">اعلان‌ها <span class="notifications-badge" style="background:#ef4444;color:#fff;border-radius:999px;padding:2px 6px;font-size:12px;display:none;margin-left:6px;">0</span></button>
             </div>
         </div>
         <!-- Notifications controls moved to dedicated Notifications page; quick-action removed -->
         <!-- Login / Signup card (separate) -->
         <div id="embeddedAuthBox" class="card" style="padding:12px;border-top:1px solid rgba(0,0,0,0.04);background:var(--card);border-radius:10px;margin:12px 12px 0 12px;">
           <div id="authDebug" class="auth-debug" style="font-size:13px;color:var(--muted);margin-bottom:8px;">
             <span class="auth-event">وضعیت احراز هویت:</span>
             <span class="auth-msg">در حال بررسی...</span>
           </div>
           <style>
             .auth-debug { display:block; text-align:center; }
             .auth-debug .auth-event { color:var(--muted); margin-inline-end:6px; }
             .auth-debug.signed-in .auth-event { color:var(--accent); font-weight:700; }
             .auth-debug.signed-in .auth-msg { color:var(--muted); }
             .auth-debug.auth-error .auth-event { color:var(--danger); font-weight:700; }
           </style>
           <style>
             /* Scoped small adjustments to blend with host app */
             #embeddedAuthBox .auth-container { box-shadow:none; border-radius:12px; background:var(--card); }
             #embeddedAuthBox .tab-btn { font-size:14px; padding:10px; color:var(--muted); text-align:center; box-shadow: 0 1px 2px rgba(0,0,0,0.04); border-radius:10px; }
             #embeddedAuthBox .form-tabs { display:flex; flex-direction:row; gap:8px; margin-bottom:12px; flex-wrap:nowrap; }
             #embeddedAuthBox .form-tabs .tab-btn { flex:1; min-width:0; text-align:center; }
             #embeddedAuthBox .tab-btn.active { color:var(--accent); font-weight:700; box-shadow:0 4px 10px rgba(0,0,0,0.08); transform:translateY(-1px); }
             #embeddedAuthBox .form-content { padding-top:8px; }
               /* Ensure only active form-content is visible */
               #embeddedAuthBox .form-content { display:none !important; }
               #embeddedAuthBox .form-content.active { display:block !important; }
             #embeddedAuthBox .form-control { border:1px solid rgba(0,0,0,0.06); border-radius:10px; padding:10px 12px; box-sizing:border-box; min-height:40px; font-size:inherit; width:100%; }
             /* Ensure password input matches email input sizing */
             #embeddedAuthBox .password-row input { border:1px solid rgba(0,0,0,0.06); border-radius:10px; padding:10px 12px; box-sizing:border-box; min-height:40px; font-size:inherit; }
             #embeddedAuthBox #toggleLoginPassword { height:36px; }
             /* Password field layout: place eye button outside the input in a horizontal row */
             #embeddedAuthBox .form-group { position:relative; }
             #embeddedAuthBox .password-row { display:flex; gap:8px; align-items:center; min-width:0; }
             #embeddedAuthBox .password-row input { flex:1; padding-right:12px; min-width:0; }
             #toggleLoginPassword { border:none; background:transparent; padding:6px; width:34px; height:34px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; border-radius:6px; }
             #toggleLoginPassword svg { width:18px; height:18px; color:var(--muted); }
             @media (max-width:720px) {
               #embeddedAuthBox .auth-container { min-height: auto; }
               #embeddedAuthBox .auth-welcome { display:none; }
               #embeddedAuthBox .auth-form-container { padding:12px; }
               #embeddedAuthBox .tab-btn { font-size:13px; padding:8px; }
             }
           </style>

           <!-- Paste of user's auth HTML (trimmed head/doctype/script) -->
           <div class="auth-container" style="display:flex;flex-direction:column;">
             <div class="auth-welcome" style="padding:12px;border-radius:10px;margin-bottom:12px;">
               <h2 style="font-size:18px;margin-bottom:6px;color:var(--text);">به سیستم ما خوش آمدید</h2>
               <p style="font-size:13px;margin:0;color:var(--muted);">برای استفاده از تمامی امکانات سیستم، وارد شوید یا ثبت نام کنید.</p>
             </div>

             <div class="auth-form-container" style="padding:6px;position:relative;">
               <div id="connectionTop" style="display:flex;align-items:center;justify-content:flex-start;gap:10px;margin-bottom:10px;">
                 <span style="font-size:13px;color:var(--muted);">وضعیت اتصال:</span>
                 <span id="statusIndicator" class="status-indicator status-disconnected" style="width:12px;height:12px;border-radius:50%;display:inline-block;"></span>
                 <span id="statusText" style="font-size:13px;color:var(--muted);">آفلاین</span>
               </div>

               <div class="form-tabs" style="display:flex;gap:8px;margin-bottom:12px;">
                 <button class="tab-btn btn" data-tab="login" style="flex:1;border-radius:10px;">ورود</button>
                 <button class="tab-btn btn" data-tab="signup" style="flex:1;border-radius:10px;">ثبت نام</button>
                 <button class="tab-btn btn" data-tab="recovery" style="flex:1;border-radius:10px;">بازیابی</button>
               </div>

                <datalist id="recentEmails"></datalist>

               <div id="loginFormEmbedded" class="form-content active">
                 <div id="loginAlert" class="alert"></div>
                 <div class="form-group"><label for="loginEmail">ایمیل</label><input list="recentEmails" type="email" id="loginEmail" class="form-control" placeholder="ایمیل خود را وارد کنید"></div>
                 <div class="form-group">
                   <label for="loginPassword">رمز عبور</label>
                   <div class="password-row">
                     <input type="password" id="loginPassword" class="form-control" placeholder="رمز عبور خود را وارد کنید">
                     <button type="button" id="toggleLoginPassword" title="نمایش/مخفی کردن رمز">
                       <svg id="toggleLoginPasswordIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                     </button>
                   </div>
                 </div>
                 <button id="loginBtn" class="btn primary" style="width:100%;margin-top:8px;display:inline-flex;align-items:center;justify-content:center;gap:8px;">
                   <span class="inline-spinner" aria-hidden="true" style="width:18px;height:18px;border-radius:50%;"></span>
                   <span class="login-label">ورود</span>
                 </button>
                 <div id="loginLoading" class="loading"><div class="loading-spinner"></div></div>
               </div>

               <div id="signupFormEmbedded" class="form-content">
                 <div id="signupAlert" class="alert"></div>
                 <div class="form-group"><label for="signupEmail">ایمیل</label><input list="recentEmails" type="email" id="signupEmail" class="form-control" placeholder="ایمیل خود را وارد کنید"></div>
                 <div class="form-group"><label for="signupPassword">رمز عبور</label><input type="password" id="signupPassword" class="form-control" placeholder="رمز عبور خود را وارد کنید"></div>
                 <div class="form-group"><label for="confirmPassword">تکرار رمز عبور</label><input type="password" id="confirmPassword" class="form-control" placeholder="رمز عبور خود را تکرار کنید"></div>
                 <button id="signupBtn" class="btn primary" style="width:100%;margin-top:8px;display:inline-flex;align-items:center;justify-content:center;gap:8px;">
                   <span class="inline-spinner" aria-hidden="true" style="width:18px;height:18px;border-radius:50%;"></span>
                   <span class="signup-label">ثبت نام</span>
                 </button>
               </div>

               <div id="recoveryFormEmbedded" class="form-content">
                 <div id="recoveryAlert" class="alert"></div>
                 <div class="form-group"><label for="recoveryEmail">ایمیل</label><input type="email" id="recoveryEmail" class="form-control" placeholder="ایمیل خود را وارد کنید"></div>
                 <button id="recoveryBtn" class="btn primary" style="width:100%;margin-top:8px;display:inline-flex;align-items:center;justify-content:center;gap:8px;">
                   <span class="inline-spinner" aria-hidden="true" style="width:18px;height:18px;border-radius:50%;"></span>
                   <span class="recovery-label">ارسال لینک بازیابی</span>
                 </button>
               </div>
             </div>
           </div>
          <!-- Account profile container (static profile) -->
          <style>
            /* Inline spinner for auth buttons: sits beside text and animates when .running is toggled */
            .inline-spinner {
              display: inline-block;
              width: 18px;
              height: 18px;
              border-radius: 50%;
              box-sizing: border-box;
              vertical-align: middle;
              opacity: 0;
              transition: opacity 120ms linear, transform 120ms linear;
            }
            .inline-spinner.running {
              opacity: 1;
              border: 2px solid rgba(255,255,255,0.25);
              border-top-color: currentColor;
              animation: __auth_spin 800ms linear infinite;
              transform-origin: 50% 50%;
            }
            @keyframes __auth_spin { to { transform: rotate(360deg); } }
            /* Profile card responsive adjustments: two-column layout by default. On small screens (<600px) buttons stack, but for very small devices (<=320px) keep two-column compact layout so narrow screens show pairs side-by-side. */
            .profile-card-rows { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:8px; align-items:stretch; }
            .profile-card-rows + .profile-card-rows { margin-top:8px; }
            /* Default mobile stacking for narrow tablets/phones */
            @media (max-width:600px) {
              .profile-card-rows { grid-template-columns: 1fr; }
              .profile-card-rows .btn { width:100% !important; }
            }
            /* On very small screens (<=320px) use two columns again so tiny narrow devices show paired buttons side-by-side */
            @media (max-width:320px) {
              /* Force two columns on very narrow screens; use !important to override other layout rules if present */
              .profile-card-rows { grid-template-columns: repeat(2, 1fr) !important; }
              .profile-card-rows .btn { width:100% !important; }
            }
            #backupHistoryBox { overflow:auto; max-height:320px; }
            #accountProfileContainer { overflow:hidden; padding:8px; box-sizing:border-box; }

            /* Profile status and backup-ready visuals (move inline styles into classes) */
            .profile-status-box { background: rgba(34,197,94,0.08); border:1px solid rgba(34,197,94,0.18); border-radius:12px; padding:8px; margin-bottom:12px; }
            .profile-status-box .status-item { display:flex; align-items:center; gap:8px; padding:6px 4px; color:var(--text); }
            .profile-status-box .status-item .material-icons { color:var(--success); font-size:20px; }
            .profile-status-box .status-text { font-weight:600; color:var(--success); }
            /* Small card around edit profile form */
            #editProfileForm { border:1px solid rgba(0,0,0,0.06); padding:10px; border-radius:10px; background:var(--card); box-shadow:0 2px 8px rgba(0,0,0,0.04); margin-top:12px; }
            #editProfileForm .form-group { margin-bottom:8px; }
            #editProfileForm label { display:block; font-weight:600; margin-bottom:6px; }
            /* Logout row styling: ensure logout button sits below and is full-width (max width for large screens) */
            .logout-row { margin-top:8px; width:100%; display:flex; justify-content:center; }
            .logout-row .btn { width:100%; max-width:420px; background:#ef4444; color:#fff; }
          </style>
          <div id="accountProfileContainer" style="margin-top:12px;display:none;">
            <div style="display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:12px;text-align:center;">
              <img id="accountAvatar" src="./icons/logo.png" alt="آواتار" style="width:84px;height:84px;border-radius:50%;object-fit:cover;border:2px solid #eee;background:#f8fafc;box-shadow:0 4px 12px rgba(0,0,0,0.06);">
              <div style="width:100%;min-width:0;">
                <div id="accountName" style="font-size:1.2em;font-weight:600;margin-bottom:6px;text-align:center;">—</div>
                <div id="accountEmail" style="color:var(--muted);font-size:0.98em;margin-bottom:4px;direction:ltr;text-align:center;">—</div>
                <div id="accountPhone" style="color:var(--muted);font-size:0.98em;margin-bottom:4px;direction:ltr;text-align:center;">—</div>
                <div id="accountBio" style="color:var(--muted);font-size:0.92em;margin-top:6px;line-height:1.4;white-space:pre-wrap;text-align:center;">—</div>
              </div>
            </div>
            <!-- Profile card container: layout kept responsive and preserves original buttons/onclic handlers -->
            <div class="flex flex-col items-center gap-3 text-center w-full max-w-md mx-auto p-3" style="box-sizing:border-box;">
              <!-- top title area removed to keep layout compact; edit button moved next to history below -->

              <!-- Backup status (moved above buttons) -->
              <!-- Green status box with individual checked items -->
              <div class="profile-status-box" style="width:100%;">
                <div class="status-item"><span class="material-icons">check_circle</span><span class="status-text">سیستم بکاپ آماده است</span></div>
                <div class="status-item"><span class="material-icons">check_circle</span><span class="status-text">ارتباط با سرور برقرار است</span></div>
              </div>

              <!-- Row 1: Backup Now | Restore -->
              <div class="profile-card-rows" style="width:100%;">
                <button id="backupNowBtn" class="btn primary" onclick="handleManualBackup()" style="display:inline-flex;align-items:center;gap:8px;">
                  <span class="material-icons icon">backup</span>
                  <span id="backupNowSpinner" class="inline-spinner" style="display:none;margin-inline-start:6px;" aria-hidden="true"></span>
                  <span id="backupNowText">ایجاد بک‌آپ جدید</span>
                </button>
                <button id="restoreBackupBtn" class="btn" onclick="handleRestoreBackup()" style="display:inline-flex;align-items:center;gap:8px;">
                  <span class="material-icons icon">restore</span><span>بازگردانی بک‌آپ</span>
                  <span id="restoreBackupSpinner" class="inline-spinner" style="display:none;margin-inline-start:6px;" aria-hidden="true"></span>
                </button>
              </div>

              <!-- Row 2: Edit | History -->
              <div class="profile-card-rows" style="width:100%;">
                <button id="editProfileBtn" class="btn" onclick="openEditProfile()" style="display:inline-flex;align-items:center;gap:8px;">
                  <span class="material-icons icon">edit</span><span>ویرایش پروفایل</span>
                  <span id="editProfileSpinner" class="inline-spinner" style="display:none;margin-inline-start:6px;" aria-hidden="true"></span>
                </button>
                <button id="backupHistoryBtn" class="btn" onclick="showBackupHistory()" style="display:inline-flex;align-items:center;gap:8px;">
                  <span class="material-icons icon">history</span><span>تاریخچه بک‌آپ‌ها</span>
                  <span id="backupHistorySpinner" class="inline-spinner" style="display:none;margin-inline-start:6px;" aria-hidden="true"></span>
                </button>
              </div>

              <!-- Backup history box (hidden by default) placed below the status and rows -->
              <div id="backupHistoryBox" class="hidden bg-white border rounded-xl p-3 shadow-inner mt-2 w-full text-sm text-right overflow-auto" style="display:none;max-height:320px;">
                <!-- Backup list populated dynamically by showBackupHistory() -->
                <div id="backupHistoryList">&nbsp;</div>
                <div style="display:flex;justify-content:flex-end;margin-top:8px;"><button onclick="toggleBackupHistory()" class="text-red-500 text-xs">بستن</button></div>
              </div>

              <!-- Edit profile form (moved before logout for easier access on mobile) -->
              <form id="editProfileForm" style="display:none;margin-top:12px;width:100%;">
                <div class="form-group"><label for="editDisplayName">نام نمایشی</label><input type="text" id="editDisplayName" class="form-control"></div>
                <!-- email removed from edit form as requested -->
                <div class="form-group"><label for="editPhoneNumber">تلفن همراه</label><input type="text" id="editPhoneNumber" class="form-control" dir="ltr"></div>
                <div class="form-group"><label for="editBio">درباره من</label><textarea id="editBio" class="form-control" rows="3"></textarea></div>
                <div class="form-group"><label for="editAvatarUrl">لینک تصویر پروفایل</label><input type="url" id="editAvatarUrl" class="form-control" dir="ltr"></div>
                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
                  <button type="submit" id="saveProfileBtn" class="btn primary">ذخیره<span id="saveProfileSpinner" class="inline-spinner" style="display:none;margin-inline-start:6px;" aria-hidden="true"></span></button>
                  <button type="button" id="cancelEditProfile" class="btn">لغو</button>
                </div>
              </form>

              <!-- Row 3: Logout below history box -->
              <div class="logout-row">
                <button id="logoutBtn" class="btn"><span class="material-icons icon">logout</span><span>خروج</span></button>
              </div>

              <!-- keep legacy profile status element for other messages (moved above buttons) -->
            </div>
            <!-- profileDeviceCount removed per request: debug device count hidden in production UI -->
            <div id="profileLastDevice" style="font-size:0.95em;color:#666;margin-bottom:8px;"></div>
            <div id="profileDebugControls" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;"></div>
            <!-- editProfileForm moved earlier before logout for better UX on mobile -->
          </div>
<script>
// فرض: window.supabase و window.syncHybrid موجود است و کاربر لاگین کرده

function fillProfileUI(profile) {
  // remember the loaded profile so edit/save handlers can reuse it
  try { window._loadedProfile = profile || window._loadedProfile || {}; } catch(_){}
  // Normalize profile object: allow multiple possible column names used in different schemas
  const getName = (p) => p && (p.display_name || p.name || p.full_name || ((p.first_name||'') + ' ' + (p.last_name||'')).trim() || '—');
  const getEmail = (p) => p && (p.email || p.user_email || '—');
  const getPhone = (p) => p && (p.phone_number || p.phone || '');
  const getAvatar = (p) => p && (p.avatar_url || p.avatar || p.photo || p.image_url || '');
  const getBio = (p) => p && (p.bio || p.about || p.description || '');

  document.getElementById('accountName').textContent = getName(profile) || '—';
  document.getElementById('accountEmail').textContent = getEmail(profile) || '—';
  // normalize phone field: support phone_number or phone
  document.getElementById('accountPhone').textContent = getPhone(profile) || '—';
  const avatarUrl = getAvatar(profile);
  if (avatarUrl) document.getElementById('accountAvatar').src = avatarUrl;
  document.getElementById('editDisplayName').value = profile.display_name || profile.name || profile.full_name || '';
  /* editEmail field removed from form; no prefill needed */
  document.getElementById('editPhoneNumber').value = profile.phone_number || profile.phone || '';
  document.getElementById('editBio').value = profile.bio || profile.about || profile.description || '';
  document.getElementById('editAvatarUrl').value = profile.avatar_url || profile.avatar || profile.photo || profile.image_url || '';
  document.getElementById('profileLastDevice').textContent = profile.last_sync_device ? 'آخرین دستگاه: ' + profile.last_sync_device : '';
  // populate visible bio block in account view if present
  try { const ab = document.getElementById('accountBio'); if (ab) ab.textContent = profile.bio || '—'; } catch(_){}
  //updateProfileSyncHybridStatus();
  // Ensure profile container is visible when we have profile data
  try { const pc = document.getElementById('accountProfileContainer'); if (pc) pc.style.display = 'block'; } catch(e) {}
}

// Open edit profile form and prefill fields from DB or auth metadata
window.openEditProfile = async function openEditProfile() {
  try {
    const editSpinner = document.getElementById('editProfileSpinner');
    try { if (editSpinner) { editSpinner.style.display = 'inline-block'; document.getElementById('editProfileBtn').disabled = true; } } catch(_){ }
    const client = getSupabaseClient();
    if (!client) return;
    const { userId, user } = await getCurrentUserId();
    if (!userId) return; // guard: avoid sending undefined to PostgREST

    // Try to fetch profile by user_id
    let profile = null;
    try {
      console.debug('openEditProfile: fetching profile by user_id', userId);
      const res = await client.from('profiles').select('*').eq('user_id', userId).maybeSingle();
      profile = res && res.data ? res.data : null;
      if (res && res.error) console.debug('openEditProfile: fetch by user_id error', res.error);
    } catch(e) { /* ignore */ }

    // If not found, try by email
    if (!profile && user && user.email) {
      try {
        console.debug('openEditProfile: fetching profile by email', user.email);
        const res2 = await client.from('profiles').select('*').eq('email', user.email).maybeSingle();
        profile = res2 && res2.data ? res2.data : profile;
        if (res2 && res2.error) console.debug('openEditProfile: fetch by email error', res2.error);
      } catch(e) { /* ignore */ }
    }

    // If we already loaded a profile earlier on the page, prefer that
    const loaded = (typeof window !== 'undefined' && window._loadedProfile) ? window._loadedProfile : null;
    // If we didn't have a loaded profile but fetched one now, persist it for next time
    if (!loaded && profile) {
      try { window._loadedProfile = profile; } catch(_){}
    }

    // Prefer the already-loaded profile (window._loadedProfile) or the freshly fetched profile
    const src = loaded || profile || {};
    const meta = (user && user.user_metadata) ? user.user_metadata : {};

    // Only prefill fields that exist in the edit form and are shown on the profile screen.
    // Do not clear inputs if the source value is missing — only write when we have a non-empty value.
    const setIfPresent = (id, value) => {
      try {
        const el = document.getElementById(id);
        if (!el) return;
        if (value === null || value === undefined) return;
        if (typeof value === 'string' && value.trim() === '') return;
        el.value = Array.isArray(value) ? value.join(', ') : value;
      } catch(_){}
    };

    // Prefill using multiple possible column names to be robust across schemas
    const getName = (p) => p && (p.display_name || p.name || p.full_name || ((p.first_name||'') + ' ' + (p.last_name||'')).trim() || '');
    const getEmail = (p) => p && (p.email || p.user_email || '');
    const getPhone = (p) => p && (p.phone_number || p.phone || '');
    const getAvatar = (p) => p && (p.avatar_url || p.avatar || p.photo || p.image_url || '');
    const getBio = (p) => p && (p.bio || p.about || p.description || '');

    try { const dn = document.getElementById('editDisplayName'); if (dn) dn.value = getName(src) || getName(meta) || ''; } catch(_){ }
    try { const elp = document.getElementById('editPhoneNumber'); if (elp) elp.value = getPhone(src) || (meta && meta.phone) || ''; } catch(_){ }
    try { const eb = document.getElementById('editBio'); if (eb) eb.value = getBio(src) || (meta && meta.bio) || ''; } catch(_){ }
    try { const ea = document.getElementById('editAvatarUrl'); if (ea) ea.value = getAvatar(src) || (meta && meta.avatar_url) || ''; } catch(_){ }
    // If the optional email input exists, set it too (from profile or auth)
  /* editEmail removed from form; skip setting it */

    // Show the form
    try { document.getElementById('editProfileForm').style.display = 'block'; } catch(_){ }
    try { if (editSpinner) { editSpinner.style.display = 'none'; document.getElementById('editProfileBtn').disabled = false; } } catch(_){ }
  } catch (err) {
    console.warn('openEditProfile failed', err);
    try { const editSpinner = document.getElementById('editProfileSpinner'); if (editSpinner) { editSpinner.style.display = 'none'; document.getElementById('editProfileBtn').disabled = false; } } catch(_){ }
  }
}

// New backup status management
function updateBackupStatus(message, isError = false) {
  const el = document.getElementById('profileSyncHybridStatus');
  if (!el) return;
  
  const icon = isError ? 
    '<span style="color:#ef4444;font-size:1.1em;">❌</span>' : 
    '<span style="color:#0a7;font-size:1.1em;">✅</span>';
  
  el.innerHTML = icon + '<span>' + message + '</span>';
}

// Backup handler
window.handleBackupNow = async function handleBackupNow() {
  const spinner = document.getElementById('backupNowSpinner');
  const btn = document.getElementById('backupNowBtn');
  if (!window.backupSync) {
    updateBackupStatus('سیستم بکاپ در دسترس نیست', true);
    return;
  }
  
  try {
    spinner.style.display = 'inline-block';
    btn.disabled = true;
    
    // Get user email for group sync
    const { data: { user } } = await window.supabase.auth.getUser();
    if (!user?.email) throw new Error('کاربر لاگین نشده است');
    
    // Set group email and create backup with force flag
    window.backupSync.setGroupEmail(user.email);
    const result = await window.backupSync.createBackup({ force: true });
    
    updateBackupStatus(`✅ بکاپ در ${new Date().toLocaleString()} انجام شد`);
  } catch (error) {
    console.error('Backup failed:', error);
    updateBackupStatus('خطا در ایجاد بکاپ: ' + error.message, true);
  } finally {
    spinner.style.display = 'none';
    btn.disabled = false;
  }
}

// Restore handler
window.handleRestoreBackup = async function handleRestoreBackup() {
  const btn = document.getElementById('restoreBackupBtn');
  const spinner = document.getElementById('restoreBackupSpinner');
  if (!window.backupSync) {
    updateBackupStatus('سیستم بکاپ در دسترس نیست', true);
    return;
  }

  if (!confirm('آیا مطمئن هستید؟ این عمل داده‌های فعلی را با آخرین بکاپ جایگزین می‌کند.')) {
    return;
  }

  try {
    if (spinner) spinner.style.display = 'inline-block';
    btn.disabled = true;

    // Use backupSync helper to get the current user email (handles auth check)
    if (!window.backupSync || typeof window.backupSync.getCurrentUserEmail !== 'function') {
      throw new Error('سیستم بکاپ در دسترس نیست');
    }
    const email = await window.backupSync.getCurrentUserEmail();
    if (!email) throw new Error('کاربر لاگین نشده است');

    // Set group email and restore
    window.backupSync.setGroupEmail(email);
    const result = await window.backupSync.restoreFromLatest();

    updateBackupStatus('✅ بازگردانی از آخرین بکاپ انجام شد');

    // Show success feedback without forcing a reload so the in-memory state
    // and the scheduled renderers in restoreData() can update the UI.
    try {
      if (typeof showToast === 'function') {
        showToast('✅ بازیابی با موفقیت انجام شد', 'success');
      } else if (typeof window.toastr !== 'undefined' && typeof window.toastr.success === 'function') {
        window.toastr.success('بازیابی با موفقیت انجام شد');
      } else {
        // Fallback: non-blocking alert
        setTimeout(() => { try { /* avoid blocking immediate UI updates */ alert('✅ بازیابی با موفقیت انجام شد'); } catch(_){} }, 150);
      }
    } catch (e) { console.debug('show success toast failed', e); }

    // Conditional reload fallback: only reload if the restored state doesn't appear
    // to have been applied after a short grace period. This avoids wiping newly
    // restored in-memory UI by an unconditional reload.
    setTimeout(() => {
      try {
        const key = (typeof STORAGE_KEY !== 'undefined') ? STORAGE_KEY : 'vb_dashboard_v8';
        const raw = localStorage.getItem(key);
        let ok = false;
        if (raw) {
          try { const obj = JSON.parse(raw); ok = obj && (Array.isArray(obj.players) || Array.isArray(obj.competitions) || Object.keys(obj).length > 0); } catch(e) { ok = true; }
        }
        if (!ok) {
          console.warn('Restored state not detected in localStorage; performing reload as fallback');
          window.location.reload();
        }
      } catch (e) { console.warn('conditional reload check failed', e); }
    }, 1500);
  } catch (error) {
    console.error('Restore failed:', error);
    updateBackupStatus('خطا در بازگردانی بکاپ: ' + (error && error.message ? error.message : String(error)), true);
  } finally {
    if (spinner) spinner.style.display = 'none';
    btn.disabled = false;
  }
}

// New compatibility wrapper used by UI: calls backupSync.createBackup({ force: true })
window.handleManualBackup = async function handleManualBackup() {
  if (!window.backupSync || typeof window.backupSync.createBackup !== 'function') {
    alert('سیستم بکاپ در دسترس نیست');
    return;
  }
  
  try {
    if (window.setBackupButtonLoading) window.setBackupButtonLoading(true);
    
    // Make sure user is authenticated and group email is set to avoid RLS errors
    if (typeof window.backupSync.getCurrentUserEmail !== 'function') {
      alert('سیستم بکاپ در دسترس نیست');
      return;
    }
    const email = await window.backupSync.getCurrentUserEmail();
    if (!email) return alert('لطفاً ابتدا وارد شوید');
    window.backupSync.setGroupEmail(email);

    const res = await window.backupSync.createBackup({ force: true });
    if (res && res.ok) {
      // successful immediate save on server
      alert('✅ بک‌آپ با موفقیت ذخیره شد');
      updateBackupStatus('بکاپ ذخیره شد');
    } else if (res && res.ok === 'pending' && res.id) {
      // saved locally for later upload — optionally wait for server confirmation for a short period
      updateBackupStatus('بکاپ در صف آپلود قرار گرفت — تلاش برای آپلود...');
      const client = window.supabase;
      let uploaded = false;
      if (client) {
        const pollInterval = 2000; // ms
        const maxAttempts = 15; // ~30s
        for (let attempt = 0; attempt < maxAttempts; attempt++) {
          try {
            // check backups table for presence of this backup id
            const { data, error } = await client.from('backups').select('backup_id').eq('backup_id', res.id).maybeSingle();
            if (!error && data && data.backup_id) { uploaded = true; break; }
          } catch (e) { /* ignore and retry */ }
          // keep spinner active
          await new Promise(r => setTimeout(r, pollInterval));
        }
      }
      if (uploaded) {
        alert('✅ بک‌آپ با موفقیت روی سرور ذخیره شد');
        updateBackupStatus('بکاپ ذخیره شد');
      } else {
        alert('⚠️ بک‌آپ در حالت انتظار ذخیره شد و پس از اتصال آپلود خواهد شد');
        updateBackupStatus('بکاپ در صف آپلود قرار گرفت', true);
      }
    } else {
      alert('⚠️ خطا در بک‌آپ: ' + (res && res.reason ? res.reason : 'نامشخص'));
      updateBackupStatus('خطا در ایجاد بکاپ', true);
    }
  } catch (err) {
    console.error('handleManualBackup failed', err);
    alert('⚠️ خطا در بک‌آپ: ' + (err && err.message ? err.message : String(err)));
  } finally {
    if (window.setBackupButtonLoading) window.setBackupButtonLoading(false);
  }
}

// showBackupHistory: fetch recent backups from DB and render box
window.showBackupHistory = async function showBackupHistory() {
  try {
    const btn = document.getElementById('backupHistoryBtn');
    const spinner = document.getElementById('backupHistorySpinner');
    if (spinner) { spinner.style.display = 'inline-block'; if (btn) btn.disabled = true; }
    const client = window.supabase;
    if (!client) return alert('کلاینت Supabase آماده نیست');
    if (!window.backupSync || typeof window.backupSync.getCurrentUserEmail !== 'function') {
      return alert('سیستم بکاپ در دسترس نیست');
    }
    const email = await window.backupSync.getCurrentUserEmail();
    if (!email) return alert('کاربر لاگین نشده است');
    // ensure group email set for consistency
    window.backupSync.setGroupEmail(email);
    const { data, error } = await client
      .from('backups')
      .select('backup_id, created_at')
      .eq('group_email', email)
      .order('created_at', { ascending: false })
      .limit(5);
    if (error) {
      console.warn('showBackupHistory failed', error);
      return alert('⚠️ خطا در دریافت تاریخچه');
    }
    const box = document.getElementById('backupHistoryBox');
    box.innerHTML = (data && data.length === 0)
      ? '<p>هیچ بک‌آپی وجود ندارد</p>'
      : data.map(b => `
      <div style="margin-bottom:8px;padding:8px;border-bottom:1px solid rgba(0,0,0,0.04);">
        <b>${new Date(b.created_at).toLocaleString()}</b> — ${b.backup_id}
        <button style="margin-left:8px;" onclick="restoreBackup('${b.backup_id}')">🔁 بازیابی</button>
      </div>
    `).join('');
    // Toggle the box: if hidden, open it; if visible, close it
    if (box.style.display === 'none' || box.style.display === '') toggleBackupHistory(); else toggleBackupHistory();
  } catch (err) {
    console.error('showBackupHistory error', err);
    alert('⚠️ خطا در دریافت تاریخچه');
  } finally {
    try { const spinner = document.getElementById('backupHistorySpinner'); const btn = document.getElementById('backupHistoryBtn'); if (spinner) spinner.style.display = 'none'; if (btn) btn.disabled = false; } catch(_){}
  }
}

// restoreBackup by id (called from history list)
async function restoreBackup(backupId) {
  try {
    if (!window.backupSync || typeof window.backupSync.restoreById !== 'function') {
      alert('سیستم بکاپ در دسترس نیست');
      return;
    }
    await window.backupSync.restoreById(backupId);
    // Non-blocking success feedback (use showToast if available)
    if (typeof showToast === 'function') {
      try { showToast('✅ داده‌ها از بک‌آپ انتخابی بازیابی شدند'); } catch (_) { /* ignore */ }
    } else {
      try { alert('✅ داده‌ها از بک‌آپ انتخابی بازیابی شدند'); } catch (_) { /* ignore */ }
    }
    // Conditional reload fallback: only reload if the project's storage key does not contain restored data
    const _key = (window && window.STORAGE_KEY) ? window.STORAGE_KEY : 'vb_dashboard_v8';
    setTimeout(() => {
      try {
        const restored = localStorage.getItem(_key);
        if (!restored || restored.length < 10) {
          // nothing sensible restored — reload as last resort
          try { window.location.reload(); } catch (_) { /* ignore */ }
        } else {
          // If the app exposes a renderer, trigger a refresh of the UI to pick up restored state
          if (typeof window.renderAll === 'function') {
            try { window.renderAll(); } catch (_) { /* ignore */ }
          }
        }
      } catch (e) {
        try { window.location.reload(); } catch (_) { /* ignore */ }
      }
    }, 1200);
  } catch (err) {
    console.error('restoreBackup failed', err);
    alert('❌ بک‌آپ یافت نشد');
  }
}

// Show initial status
updateBackupStatus('سیستم بکاپ آماده است');

async function loadProfile(passedUser) {
  const client = window.supabase || (window.getSupabaseClient && window.getSupabaseClient());
  if (!client || !client.auth || typeof client.auth.getUser !== 'function') {
    console.debug('loadProfile: supabase client not available');
    return;
  }
  // get the authenticated user using destructuring (safe default)
  const { data: { user } = {} } = await client.auth.getUser();
  const currentUser = (passedUser && passedUser.id) ? passedUser : user;
  const userId = currentUser && currentUser.id ? currentUser.id : null;
  // clear any previously-loaded profile to avoid showing cached data for a different user
  if (window._loadedProfile && window._loadedProfile.user_id && window._loadedProfile.user_id !== userId) {
    window._loadedProfile = null;
  }
  if (!currentUser || !userId) {
    console.debug('loadProfile: no authenticated user available');
    try { setAccountIconLogged(false); } catch(_){}
    return;
  }
  let profile = null;
  let selectError = null;
  try {
  // query profile by user_id (use .single() so we get either a row or a clear error)
  const { data: profileData, error: profileError } = await client.from('profiles').select('*').eq('user_id', userId).single();
    if (profileError) {
      // PGRST116 = no rows found (PostgREST). If it's that, treat as empty; otherwise surface the error
      if (profileError && String(profileError.code) === 'PGRST116') {
        profile = null;
      } else {
        selectError = profileError;
        console.error('loadProfile query error', profileError);
      }
    } else {
      profile = profileData || null;
    }
  } catch (err) {
    selectError = err;
    console.error('loadProfile failed', err);
  }
    try {
    if (profile) {
      // Found existing profile - populate UI and keep a reference
      window._loadedProfile = profile;
      fillProfileUI(profile);
      try { setAccountIconLogged(true); } catch(_){}
      // Hide the edit form when we have a stored profile
      try { const f = document.getElementById('editProfileForm'); if (f) f.style.display = 'none'; } catch(_){ }
    } else {
  // No profile row yet: prefill edit form and show it so user can complete their profile
      try {
        // ensure the account container is visible so the user sees the edit area
        try { const pc = document.getElementById('accountProfileContainer'); if (pc) pc.style.display = 'block'; } catch(_){ }
  // editEmail removed; no email field in edit form now
        document.getElementById('accountEmail').textContent = currentUser.email || '—';
        // ensure main display reflects current signed-in user when no stored profile exists
        document.getElementById('accountName').textContent = ((currentUser.user_metadata && (currentUser.user_metadata.name || currentUser.user_metadata.full_name)) || '—');
        document.getElementById('accountPhone').textContent = '';
        document.getElementById('accountBio').textContent = '';
        try { document.getElementById('accountAvatar').src = './icons/logo.png'; } catch(_){}
        // try to prefill display name from auth metadata if available
        const metaName = (currentUser.user_metadata && (currentUser.user_metadata.name || currentUser.user_metadata.full_name)) || '';
        document.getElementById('editDisplayName').value = metaName || '';
        document.getElementById('editPhoneNumber').value = (currentUser.user_metadata && currentUser.user_metadata.phone) || '';
        document.getElementById('editBio').value = '';
        document.getElementById('editAvatarUrl').value = (currentUser.user_metadata && currentUser.user_metadata.avatar_url) || '';
        // Make the edit form visible so the user can complete their profile immediately
        try { const f = document.getElementById('editProfileForm'); if (f) { f.style.display = 'block'; const first = document.getElementById('editDisplayName'); if (first && typeof first.focus === 'function') first.focus(); } } catch(_){ }
        try { setAccountIconLogged(true); } catch(_){}
      } catch (e) { /* ignore DOM errors */ }
    }
  } catch (e) { console.error('loadProfile post-processing failed', e); }
  // devices table removed in new backup-focused schema. Skipping devices fetch.
  try {
    // Keep profileLastDevice DOM unchanged; show placeholder or rely on profile data
    // document.getElementById('profileLastDevice').textContent = '';
  } catch(e) {}
  // وضعیت تبادل داده
  document.getElementById('profileStatus').textContent = selectError ? 'خطا در دریافت پروفایل' : 'ارتباط با سرور برقرار است';

  // Configure backup sync with user email
  try {
    if (window.backupSync) {
      const email = (profile && profile.email) ? profile.email : (currentUser.email || null);
      if (email) window.backupSync.setGroupEmail(email);
    }
  } catch(e) { console.debug('backup sync configuration failed:', e); }

  // Post-load UI adjustments: show/hide settings and edit/backup controls based on email confirmation
  try {
    const isConfirmed = Boolean(currentUser && (currentUser.confirmed_at || currentUser.email_confirmed_at || currentUser.email_confirmed));
    // Ensure embedded auth box is hidden when a user is loaded (stay on profile until logout)
    try { const eb = document.getElementById('embeddedAuthBox'); if (eb) eb.style.display = 'none'; } catch(_){ }

    // Show/hide the static Settings button based on confirmation state
    try {
      const settingsBtn = document.getElementById('settingsFromAccount');
      if (settingsBtn) settingsBtn.style.display = isConfirmed ? '' : 'none';
    } catch(e) { console.debug('settings show/hide failed', e); }

    // Add extra bottom spacing for unconfirmed accounts so the account card doesn't overlap the menu
    try {
      const ac = document.getElementById('accountProfileContainer');
      if (ac) ac.style.paddingBottom = isConfirmed ? '' : '56px';
    } catch(e) { console.debug('account padding adjust failed', e); }

    // Toggle edit & backup controls for unconfirmed accounts
    try {
      const showControls = Boolean(isConfirmed);
      const ep = document.getElementById('editProfileToggle'); if (ep) ep.style.display = showControls ? '' : 'none';
      const ids = ['backupNowBtn','restoreBackupBtn','backupHistoryBtn'];
      ids.forEach(id => { try { const el = document.getElementById(id); if (el) el.style.display = showControls ? '' : 'none'; } catch(_){} });
    } catch(e) { console.debug('edit/backup toggle failed', e); }
  } catch(e) { console.debug('post-loadProfile UI adjustments failed', e); }
}

document.getElementById('editProfileBtn').onclick = function() {
  // Fetch latest profile from DB just before showing the edit form
  (async function(){
    const editSpinner = document.getElementById('editProfileSpinner');
    const editBtn = document.getElementById('editProfileBtn');
    try { if (editSpinner) { editSpinner.style.display = 'inline-block'; if (editBtn) editBtn.disabled = true; } } catch(_){ }
    try {
      const client = getSupabaseClient();
      if (!client) return;
      const { userId, user } = await getCurrentUserId();
      if (userId && user) {
            try {
          const { data: profile, error } = await client.from('profiles').select('*').eq('user_id', userId).maybeSingle();
          if (profile) fillProfileUI(profile);
            else {
            // no profile row yet — prefill display name/phone/avatar from auth metadata
            document.getElementById('editDisplayName').value = (user.user_metadata && user.user_metadata.name) || '';
            document.getElementById('editPhoneNumber').value = (user.user_metadata && user.user_metadata.phone) || '';
            document.getElementById('editAvatarUrl').value = (user.user_metadata && user.user_metadata.avatar_url) || '';
          }
        } catch(e) { console.debug('prefetch profile failed', e); }
      } else {
        // fallback: ensure form has some sensible values
        await ensureProfileFormPopulated();
      }
    } catch(e) { console.debug('open edit profile failed', e); }
    try { document.getElementById('editProfileForm').style.display = 'block'; } catch(_){ }
    try { if (editSpinner) { editSpinner.style.display = 'none'; if (editBtn) editBtn.disabled = false; } } catch(_){ }
  })();
};
document.getElementById('cancelEditProfile').onclick = function() {
  document.getElementById('editProfileForm').style.display = 'none';
};

// Defensive binding: ensure edit button triggers openEditProfile even if inline handler fails
(function(){
  try {
    const btn = document.getElementById('editProfileBtn');
    if (!btn) return;
    btn.addEventListener('click', async function(e){
      try {
        if (typeof window.openEditProfile === 'function') {
          await window.openEditProfile();
          return;
        }
        // fallback: ensure email field is populated from auth
        await ensureProfileFormPopulated();
        document.getElementById('editProfileForm').style.display = 'block';
      } catch(err) { console.debug('defensive edit click failed', err); }
    });
  } catch(e) { console.debug('bind editProfileBtn failed', e); }
})();

// NOTE: previous dynamic profile-card builder removed to preserve original static button elements.
// Provide small helpers to toggle the backup history box and ensure showBackupHistory() displays it.
function toggleBackupHistory() {
  const box = document.getElementById('backupHistoryBox');
  if (!box) return;
  if (box.style.display === 'none' || box.style.display === '') {
    box.style.display = 'block';
    box.style.maxHeight = '360px';
    box.style.opacity = '1';
  } else {
    box.style.maxHeight = '0';
    box.style.opacity = '0';
    setTimeout(()=>{ box.style.display = 'none'; }, 220);
  }
}
function showBackupHistoryBox(){ toggleBackupHistory(); }
function hideBackupHistory(){ toggleBackupHistory(); }

// Ensure edit form has sensible defaults (prefill email from auth user if empty)
async function ensureProfileFormPopulated() {
  const client = window.supabase;
  if (!client) return;
  let user = null;
  if (client.auth && typeof client.auth.getUser === 'function') {
    const { data: ud } = await client.auth.getUser();
    user = ud && ud.user ? ud.user : null;
  }
  // If email input empty, set it from auth user
  try {
    const emailEl = document.getElementById('editEmail');
    if (emailEl && (!emailEl.value || emailEl.value.trim() === '') && user && user.email) {
      emailEl.value = user.email;
    }
  } catch(e) {}
}
document.getElementById('editProfileForm').onsubmit = async function(e) {
  e.preventDefault();
  const saveSpinner = document.getElementById('saveProfileSpinner');
  const saveBtn = document.getElementById('saveProfileBtn');
  try { if (saveSpinner) { saveSpinner.style.display = 'inline-block'; if (saveBtn) saveBtn.disabled = true; } } catch(_){ }
  const client = window.supabase;
  if (!client) return;
  let user = null;
  if (client.auth && typeof client.auth.getUser === 'function') {
    const { data: ud } = await client.auth.getUser();
    user = ud && ud.user ? ud.user : null;
  }
  if (!user) return alert('لطفاً ابتدا وارد شوید');

  // Merge form inputs with any already-loaded profile to avoid saving empty values
  const existing = window._loadedProfile || {};
  const inputDisplay = (document.getElementById('editDisplayName') && document.getElementById('editDisplayName').value) || '';
  // editEmail was removed from the form; read it defensively (null if missing)
  const emailEl = document.getElementById('editEmail');
  const inputEmail = emailEl ? (emailEl.value || '') : null;
  const inputPhone = (document.getElementById('editPhoneNumber') && document.getElementById('editPhoneNumber').value) || '';
  const inputBio = (document.getElementById('editBio') && document.getElementById('editBio').value) || '';
  const inputAvatar = (document.getElementById('editAvatarUrl') && document.getElementById('editAvatarUrl').value) || '';

  const payload = {
    user_id: user.id,
    display_name: inputDisplay || existing.display_name || '',
    // Only set email if we have a value (form removed email field so inputEmail may be null)
    email: (inputEmail === null ? (existing.email || user.email || '') : (inputEmail || existing.email || user.email || '')),
    phone_number: inputPhone || existing.phone_number || existing.phone || '',
    bio: inputBio || existing.bio || '',
    avatar_url: inputAvatar || existing.avatar_url || '',
    updated_at: new Date().toISOString()
  };

  // Try to update auth email if it was changed in the form (best-effort)
  try {
    // Only try to update auth email if the edit form actually provided an email field (best-effort)
    try {
      if (emailEl) {
        const newEmail = (payload.email || '').trim();
        if (newEmail && newEmail !== (user.email || '')) {
          if (client.auth && typeof client.auth.updateUser === 'function') {
            document.getElementById('profileStatus').textContent = 'در حال به‌روزرسانی ایمیل...';
            const upd = await client.auth.updateUser({ email: newEmail });
            if (upd && upd.error) {
              console.warn('auth.updateUser failed', upd.error);
              document.getElementById('profileStatus').textContent = 'خطا در به‌روزرسانی ایمیل (سرور)';
            }
          }
        }
      }
    } catch (err) {
      console.debug('update auth email error', err);
    }
  } catch (err) {
    console.debug('update auth email error', err);
  }

  // Merge any offline local profile data if present (non-destructive)
  try {
    if (typeof STORAGE_KEY !== 'undefined') {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const localState = JSON.parse(raw || '{}');
          if (localState && typeof localState === 'object') {
            const maybeProfiles = localState.profiles || (localState.profile ? [localState.profile] : null);
            if (Array.isArray(maybeProfiles) && maybeProfiles.length > 0) {
              const lp = maybeProfiles[0];
              const legacyName = lp.first_name || lp.last_name ? ((lp.first_name||'') + ' ' + (lp.last_name||'')).trim() : null;
              payload.display_name = payload.display_name || lp.display_name || legacyName || lp.name || '';
              payload.phone_number = payload.phone_number || lp.phone_number || lp.phone || '';
              payload.email = payload.email || lp.email || '';
              payload.bio = payload.bio || lp.bio || '';
              payload.avatar_url = payload.avatar_url || lp.avatar_url || lp.photo || '';
            }
          }
        } catch(e) { /* ignore parse errors */ }
      }
    }
  } catch(e) { /* ignore */ }

  // Upsert profile and refresh UI
  try {
    // Re-fetch authoritative auth user just in case
    const { data: ud2 } = await client.auth.getUser();
    const authUser = ud2 && ud2.user ? ud2.user : null;
    if (!authUser || !authUser.id) {
      document.getElementById('profileStatus').textContent = 'لطفاً ابتدا وارد شوید';
      return;
    }

    let saved = null;

        // 1) Try to find an existing profile for this user_id
    if (!authUser || !authUser.id) {
      console.warn('saveProfile: no auth user id available');
      document.getElementById('profileStatus').textContent = 'لطفاً ابتدا وارد شوید';
      return;
    }
    const { data: byId } = await client.from('profiles').select('*').eq('user_id', authUser.id).maybeSingle();
    if (byId) {
      // update the existing row by user_id
      const { data: updated, error: updateErr } = await client.from('profiles').update(payload).eq('user_id', authUser.id).select().maybeSingle();
      if (updateErr) {
        console.error('profiles update by user_id failed', updateErr);
        document.getElementById('profileStatus').textContent = 'خطا در ذخیره پروفایل';
        return;
      }
      saved = updated;
    } else {
      // 2) No profile for this user_id — check if a profile exists with the same email
      let byEmail = null;
      // Only perform the email-based lookup if we actually have an email value
      const emailToQuery = payload.email && payload.email.trim() ? payload.email.trim() : null;
      if (emailToQuery) {
        const res = await client.from('profiles').select('*').eq('email', emailToQuery).maybeSingle();
        byEmail = res ? res.data || res : null;
      }
      if (byEmail) {
        // Update the existing row that matches the email and attach it to this user_id
        const upObj = Object.assign({}, payload, { user_id: authUser.id });
        const { data: updated, error: updateErr } = await client.from('profiles').update(upObj).eq('email', emailToQuery).select().maybeSingle();
        if (updateErr) {
          console.error('profiles update by email failed', updateErr);
          document.getElementById('profileStatus').textContent = 'خطا در ذخیره پروفایل';
          return;
        }
        saved = updated;
      } else {
        // 3) No profile found — insert a new one
        const { data: inserted, error: insertErr } = await client.from('profiles').insert(payload).select().maybeSingle();
        if (insertErr) {
          console.error('profiles insert failed', insertErr);
          document.getElementById('profileStatus').textContent = 'خطا در ذخیره پروفایل';
          return;
        }
        saved = inserted;
      }
    }

        if (saved) {
      window._loadedProfile = saved;
      fillProfileUI(saved);
    }
    document.getElementById('editProfileForm').style.display = 'none';
    document.getElementById('profileStatus').textContent = 'پروفایل ذخیره شد';
    try { if (typeof enableBackupButtons === 'function') enableBackupButtons(); } catch(_){}

    // reload profile to ensure UI consistency
    try { await loadProfile(); } catch(e){ console.debug('post-save loadProfile failed', e); }

    // Try to update auth user metadata with some fields
    try {
      const meta = {};
      if (payload.phone_number) meta.phone = payload.phone_number;
      if (payload.display_name) meta.name = payload.display_name;
      if (payload.bio) meta.bio = payload.bio;
      if (payload.avatar_url) meta.avatar_url = payload.avatar_url;
      if (Object.keys(meta).length > 0 && client.auth && typeof client.auth.updateUser === 'function') {
        try { await client.auth.updateUser({ data: { user_metadata: meta } }); } catch(e){ console.debug('update user metadata failed', e); }
      }
    } catch(e) { console.debug('auth metadata update error', e); }

    // Refresh profile from DB for full consistency (best-effort)
    try { await loadProfile(); } catch(e) { console.debug('post-save loadProfile failed', e); }
  } catch (e) {
    console.error('profile save error', e);
    document.getElementById('profileStatus').textContent = 'خطا در ذخیره پروفایل';
  } finally {
    try { if (saveSpinner) { saveSpinner.style.display = 'none'; if (saveBtn) saveBtn.disabled = false; } } catch(_){ }
  }
};
document.getElementById('logoutBtn').onclick = async function() {
  if (window.supabase && window.supabase.auth && typeof window.supabase.auth.signOut === 'function') {
    await window.supabase.auth.signOut();
    // نمایش فرم لاگین بعد از خروج
    document.getElementById('accountProfileContainer').style.display = 'none';
    const eb = document.getElementById('embeddedAuthBox');
    if (eb) eb.style.display = 'block';
    try { setAccountIconLogged(false); } catch(_){}
  }
};
// Improved Backup Now button handler (replaced legacy daily button)
document.getElementById('backupNowBtn')?.addEventListener('click', async function _backupNowClicked(e) {
  e.preventDefault();
  const btn = document.getElementById('backupNowBtn');
  const spinner = document.getElementById('backupNowSpinner');
  const status = document.getElementById('profileStatus');
  if (!window.backupSync || typeof window.backupSync.createBackup !== 'function') {
    if (status) status.textContent = 'ماژول پشتیبان فعال نیست';
    return;
  }
    try {
    // disable UI while running
    btn.disabled = true; btn.style.opacity = '0.7';
    if (spinner) spinner.style.display = 'inline-block';
    if (status) status.textContent = 'در حال همگام‌سازی...';

  // Show backup progress indicator
  const backupProgressContainer = document.getElementById('backupProgressContainer');
  if (backupProgressContainer) backupProgressContainer.style.display = 'block';

  // call the backup client (create snapshot, upload or persist pending)
  const result = await window.backupSync.createBackup({ groupEmail: (window.user && window.user.email) || (window.state && window.state.profile && window.state.profile.email) });
    // backupNow returns an object with details; if it contains an error, surface it
    if (result && result.error) {
      console.warn('backupNow returned error', result.error, result);
      if (status) status.textContent = 'خطا در همگام‌سازی: ' + String(result.error).slice(0,140);
      if (backupProgressContainer) backupProgressContainer.style.display = 'none';
    } else {
      if (status) status.textContent = 'بک‌آپ با موفقیت انجام شد';
      if (backupProgressContainer) backupProgressContainer.style.display = 'none';
      try { await loadProfile(); } catch(_) {}
    }
  } catch (err) {
    console.warn('backupNow error (thrown)', err);
    if (status) {
      if (err && err.message) status.textContent = 'خطا: ' + String(err.message).slice(0,120);
      else status.textContent = 'خطا در همگام‌سازی';
    }
  } finally {
    // restore UI
    if (spinner) spinner.style.display = 'none';
    btn.disabled = false; btn.style.opacity = '';
  }
});
// Handler for fetching the latest shared backup (manual trigger)
document.getElementById('fetchSharedBackupBtn')?.addEventListener('click', async function _fetchSharedBackupClicked(e) {
  e.preventDefault();
  const btn = document.getElementById('fetchSharedBackupBtn');
  const status = document.getElementById('profileStatus');
  try {
    btn.disabled = true; btn.style.opacity = '0.6';
    if (status) status.textContent = 'در حال دریافت بک‌آپ گروهی...';
    if (!window.backupSync || typeof window.backupSync.restoreFromLatest !== 'function') {
      if (status) status.textContent = 'ماژول پشتیبان فعال نیست';
      return;
    }
    // use restoreFromLatest to pull and restore the latest shared backup for the group
    const sb = await window.backupSync.restoreFromLatest();
    if (!sb || !sb.data) {
      if (status) status.textContent = 'هیچ بک‌آپ گروهی یافت نشد';
      return;
    }
    const snapshot = sb && sb.snapshot ? sb.snapshot : (sb && sb.data ? sb.data : null);
    // merge snapshot into window.state (backupClient.mergeGroupBackups already does this when called directly)
    try {
      if (snapshot) {
        // If backupClient exposed a merge helper, use it; otherwise rely on mergeSnapshotIntoState existing on window
        if (window.backupClient && typeof window.backupClient._internal !== 'undefined' && typeof window.backupClient._internal.decompressToJson === 'function') {
          // backupClient already merged; nothing to do
        } else if (typeof window.mergeSnapshotIntoState === 'function') {
          try { window.mergeSnapshotIntoState({ tables: snapshot }); } catch(_){}
        }
      }
      if (status) status.textContent = 'بک‌آپ گروهی با موفقیت بارگذاری شد';
      try { if (typeof loadProfile === 'function') await loadProfile(); } catch(_){ }
    } catch (mErr) {
      console.warn('merge shared backup failed', mErr);
      if (status) status.textContent = 'ادغام بک‌آپ گروهی ناموفق بود';
    }
  } catch (e) {
    console.warn('fetchSharedBackup failed', e);
    if (status) status.textContent = 'دریافت بک‌آپ گروهی ناموفق';
  } finally {
    btn.disabled = false; btn.style.opacity = '';
  }
});
// وضعیت لحظه‌ای تبادل داده (مثال ساده)
setInterval(async ()=>{
  const client = window.supabase;
  if (!client) return;
    try {
      const { error } = await client.from('profiles').select('id').limit(1);
      const profileStatusEl = document.getElementById('profileStatus');
      if (profileStatusEl) profileStatusEl.textContent = error ? 'ارتباط قطع است' : 'ارتباط با سرور برقرار است';
    } catch {
      const profileStatusEl = document.getElementById('profileStatus');
      if (profileStatusEl) profileStatusEl.textContent = 'ارتباط قطع است';
    }
}, 10000);
// فعال‌سازی اکشن دکمه‌های ورود، ثبت‌نام و بازیابی
document.getElementById('loginBtn')?.addEventListener('click', async function(e) {
  e.preventDefault();
  // ...اینجا کد ورود قبلی خود را قرار دهید یا فراخوانی کنید...
});
document.getElementById('signupBtn')?.addEventListener('click', async function(e) {
  e.preventDefault();
  // ...اینجا کد ثبت‌نام قبلی خود را قرار دهید یا فراخوانی کنید...
});
document.getElementById('recoveryBtn')?.addEventListener('click', async function(e) {
  e.preventDefault();
  // ...اینجا کد بازیابی قبلی خود را قرار دهید یا فراخوانی کنید...
});
// بارگذاری اولیه پروفایل بعد از لاگین
document.addEventListener('DOMContentLoaded', async function() {
  try {
    const client = window.supabase || (window.getSupabaseClient && window.getSupabaseClient());
    if (client && client.auth && typeof client.auth.getSession === 'function') {
      try {
        const { data } = await client.auth.getSession();
        const session = data && data.session;
        if (session && session.user) {
          // If session exists on first load, immediately show profile (or edit form when missing)
          await loadProfile(session.user);
          return;
        }
      } catch (e) {
        console.debug('initial getSession failed', e);
      }
    }
  } catch (e) { console.debug('DOMContentLoaded loadProfile guard failed', e); }
  // fallback: call loadProfile without provided user
  try { await loadProfile(); } catch(e) { console.debug('fallback loadProfile failed', e); }
});

// Install small touch/tap helpers so images and jalali inputs reliably receive taps
// especially inside horizontal scrollers or TWA containers where click may be lost.
function installTapFixes() {
  const TAP_MOVE_THRESHOLD = 10; // px
  const TAP_TIME_THRESHOLD = 350; // ms

  function makeTapListener(el, fn) {
    let sx = 0, sy = 0, st = 0;
    el.addEventListener('touchstart', function ts(e) {
      if (!e.touches || !e.touches[0]) return;
      sx = e.touches[0].clientX; sy = e.touches[0].clientY; st = Date.now();
    }, { passive: true });
    el.addEventListener('touchend', function te(e) {
      const dt = Date.now() - st;
      let ex = sx, ey = sy;
      try { const touch = (e.changedTouches && e.changedTouches[0]) || (e.touches && e.touches[0]); if (touch) { ex = touch.clientX; ey = touch.clientY; } } catch(_){}
      const dx = Math.abs(ex - sx), dy = Math.abs(ey - sy);
      if (dx <= TAP_MOVE_THRESHOLD && dy <= TAP_MOVE_THRESHOLD && dt <= TAP_TIME_THRESHOLD) {
        try { fn.call(el, e); } catch(err) { console.debug('tap handler error', err); }
      }
    }, { passive: true });
  }

  // For jalali date inputs: focus on tap
  qsa('.jalali-input').forEach(inp => {
    try {
      makeTapListener(inp, function() { try { if (typeof this.focus === 'function') this.focus(); this.dispatchEvent(new Event('click', { bubbles: true })); } catch(_){} });
    } catch (e) { console.debug('install tap jalali-input failed', e); }
  });

  // For player thumbnails and images in previews: treat a short tap as a click
  qsa('.players-preview .player-row, .players-preview .player-thumb, .players-preview .player-thumb img, .player-thumb img').forEach(el => {
    try {
      makeTapListener(el, function(ev) {
        // prefer dispatching a synthetic click so existing handlers run
        try { this.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true })); } catch(e) { try { this.click && this.click(); } catch(_){} }
      });
    } catch (e) { console.debug('install tap on thumb failed', e); }
  });

  // For membership card images or other clickable photos
  qsa('img').forEach(img => {
    // skip images that already have pointer-event none or are purely decorative
    try {
      const p = window.getComputedStyle(img).pointerEvents;
      if (p === 'none') return;
      makeTapListener(img, function() {
        try { this.dispatchEvent(new MouseEvent('click', { bubbles: true })); } catch(e) { try { this.click && this.click(); } catch(_){} }
      });
    } catch(e){}
  });
  // Delegated tap handling for dynamic elements and to avoid missing future nodes
  (function installDelegatedTap() {
    let sx = 0, sy = 0, st = 0, startTarget = null, startScroll = null;
    document.addEventListener('touchstart', function (e) {
      const t = (e.touches && e.touches[0]);
      if (!t) return;
      sx = t.clientX; sy = t.clientY; st = Date.now();
      startTarget = e.target;
      // if inside a horizontal scroller, record its scrollLeft to detect scroll
      const sc = findScrollableAncestor(startTarget);
      startScroll = sc ? sc.scrollLeft : null;
    }, { passive: true });

    document.addEventListener('touchend', function (e) {
      const t = (e.changedTouches && e.changedTouches[0]);
      if (!t) return;
      const dx = Math.abs(t.clientX - sx), dy = Math.abs(t.clientY - sy);
      const dt = Date.now() - st;
      if (dx > TAP_MOVE_THRESHOLD || dy > TAP_MOVE_THRESHOLD || dt > TAP_TIME_THRESHOLD) return;
      // determine if the touch was on an actionable element (player row/thumb or jalali input)
      let el = e.target;
      while (el && el !== document.body) {
        try {
          if (el.matches && (el.matches('.player-row') || el.matches('.player-thumb') || el.matches('.jalali-input') || el.matches('.player-row *') )) break;
        } catch (_) {}
        el = el.parentElement;
      }
      if (!el || el === document.body) return;
      // if the scroller moved, it's likely a scroll, so ignore
      const sc2 = findScrollableAncestor(startTarget);
      if (sc2 && startScroll !== null && sc2.scrollLeft !== startScroll) return;
      try {
        // prefer dispatching click
        el.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));
      } catch (err) {
        try { el.click && el.click(); } catch(_){}
      }
    }, { passive: true });

    function findScrollableAncestor(node) {
      let cur = node;
      while (cur && cur !== document.body) {
        try {
          const s = window.getComputedStyle(cur);
          const overflowX = s.overflowX;
          if (overflowX === 'auto' || overflowX === 'scroll') return cur;
        } catch (_) {}
        cur = cur.parentElement;
      }
      return null;
    }
  })();
}

try { document.addEventListener('DOMContentLoaded', installTapFixes); } catch(e) { setTimeout(installTapFixes, 400); }

// Debug controls for sync queue / dead-letter removed from profile view per user request.
(function installProfileDebugControls(){
  // no-op placeholder so other code can safely call this without errors
  try { /* intentionally empty */ } catch(e) { console.debug('installProfileDebugControls noop failed', e); }
})();
</script>
         <!-- END: embedded auth box -->
       </div>
     </section>
  <!-- MANAGEMENT VIEW REMOVED PER USER REQUEST -->
    </div>
  </main>
  <!-- Floating add-session and add-payment FABs (moved out of view sections to keep fixed positioning reliable) -->
  <div class="fab" id="fabSession" title="ایجاد جلسه" style="display:none">+</div>
  <div class="fab fab-blue" id="fabTraining" title="یادداشت تمرین" style="display:none">+</div>
  <div class="fab" id="fabPayment" title="ثبت پرداخت" style="display:none">+</div>
  <div id="jalaliCalendar" class="jalali-calendar hide" aria-hidden="true"></div>
  <!-- Birthday modal container -->
  <div id="birthdayModal" class="hide" aria-hidden="true" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:2000;">
    <div style="background:rgba(0,0,0,0.5);position:absolute;inset:0;" id="birthdayModalBackdrop"></div>
    <div id="birthdayModalCard" style="position:relative;background:var(--card);padding:20px;border-radius:12px;max-width:420px;width:90%;box-shadow:0 8px 30px var(--shadow);text-align:center;">
      <div id="birthdayModalContent"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center;">
        <button id="birthdayModalClose" class="btn">بستن</button>
      </div>
    </div>
  </div>
  <!-- Plan view modal -->
  <div id="planModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;padding:20px;z-index:2000;">
    <div style="background:var(--card);max-width:720px;width:100%;border-radius:8px;padding:16px;box-shadow:0 6px 30px rgba(0,0,0,0.25);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <h3 id="planModalTitle" style="margin:0">عنوان</h3>
        <div><button class="btn" id="closePlanModal">بستن</button></div>
      </div>
      <div style="color:var(--muted);margin-bottom:12px"><strong>تاریخ:</strong> <span id="planModalDate"></span></div>
      <div id="planModalBody" style="white-space:pre-wrap;color:var(--text)"></div>
    </div>
  </div>

  <!-- ImageKit uploader removed -->
</div>

<!-- Receipt modal for sending payment receipts -->
<div id="receiptModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;padding:20px;z-index:2000;">
  <div style="background:#fff;max-width:520px;width:100%;border-radius:8px;padding:16px;box-shadow:0 6px 30px rgba(0,0,0,0.25);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h3 style="margin:0">ارسال رسید پرداخت</h3>
      <div><button class="btn" id="closeReceiptModal">بستن</button></div>
    </div>
    <div style="display:grid;gap:8px;">
      <div><strong id="receiptPlayerName">—</strong></div>
      <input id="receiptPhone" class="input" placeholder="شماره تلفن (والد یا بازیکن)" />
      <input id="receiptAmount" class="input" placeholder="مبلغ" />
      <textarea id="receiptNote" class="input" placeholder="متن رسید" style="min-height:100px"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button id="sendReceiptBtn" class="btn primary">ارسال (SMS)</button>
        <button id="saveReceiptBtn" class="btn">ذخیره رسید</button>
      </div>
    </div>
  </div>
</div>

<!-- Payment form modal -->
<div id="paymentModal" class="modal hide" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:10002;">
  <div class="modal-content" style="width:min(96vw,720px);background:var(--card);border-radius:12px;padding:12px;box-shadow:0 10px 40px rgba(0,0,0,0.12);">
  <div class="modal-header"><strong>ثبت پرداخت جدید</strong></div>
    <div class="modal-body">
      <div style="display:grid;gap:8px;">
        <input id="paymentPlayerSearch" class="input" placeholder="جستجوی بازیکن..." />
        <select id="paymentPlayer" class="input"><option value="">انتخاب بازیکن</option></select>
        <input id="paymentDate" class="input jalali-input" placeholder="تاریخ پرداخت (YYYY/MM/DD)" />
        <div style="display:flex;gap:8px;">
          <select id="paymentMonth" class="input"></select>
          <select id="paymentYear" class="input"></select>
        </div>
        <input id="paymentAmount" class="input" placeholder="مبلغ (تومان)" type="text" />
        <select id="paymentType" class="input"><option value="">نوع پرداخت</option><option>نقد</option><option>رسید</option><option>کارت به کارت</option></select>
      </div>
    </div>
    <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;"><button id="addPaymentBtn" class="btn primary">ثبت پرداخت</button><button class="btn" id="paymentModalCancel">بستن</button></div>
  </div>
</div>

<!-- Session create modal -->
<div id="sessionModal" class="modal hide" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:10002;">
  <div class="modal-content" style="width:min(96vw,640px);background:var(--card);border-radius:12px;padding:12px;box-shadow:0 10px 40px rgba(0,0,0,0.12);">
  <div class="modal-header"><strong>ایجاد جلسه</strong></div>
    <div class="modal-body">
      <div style="display:flex;gap:8px;flex-direction:column;">
        <input id="sessionTitle" class="input" placeholder="عنوان جلسه (اختیاری)" />
        <input id="sessionDate" class="input jalali-input" placeholder="تاریخ جلسه (YYYY/MM/DD)" style="text-align:center;" />
        <select id="sessionCategory" class="input"><option value="">همه رده‌ها</option></select>
  <select id="sessionPrivateClass" class="input" style="display:none"><option value="">انتخاب کلاس خصوصی</option></select>
  <select id="sessionCoach" class="input"><option value="">بدون مربی</option></select>
      </div>
    </div>
    <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;"><button id="createSessionBtn" class="btn primary">ایجاد جلسه</button><button class="btn" id="sessionModalCancel">بستن</button></div>
  </div>
</div>

<!-- Training plan note modal -->
<div id="trainingFormModal" class="modal hide" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:10002;">
  <div class="modal-content" style="width:min(96vw,720px);background:var(--card);border-radius:12px;padding:12px;box-shadow:0 10px 40px rgba(0,0,0,0.12);">
  <div class="modal-header"><strong>یادداشت برنامهٔ تمرین</strong></div>
    <div class="modal-body">
      <div style="display:grid;gap:8px;">
        <input id="planTitle" class="input" placeholder="عنوان تمرین" style="flex:1;min-width:180px;" />
        <input id="planDate" class="input jalali-input" placeholder="تاریخ تمرین (YYYY/MM/DD)" style="width:130px;" />
        <div style="display:flex;gap:6px;align-items:center;">
          <select id="planHour" class="input" style="width:70px;padding:6px;"></select>
          <select id="planMinute" class="input" style="width:60px;padding:6px;"></select>
        </div>
        <select id="planCoach" class="input" style="width:160px;"></select>
        <select id="planReminderMode" class="input" style="width:180px;"><option value="none">بدون یادآوری</option><option value="on_day">روز تمرین</option><option value="hours_2">2 ساعت قبل</option><option value="hours_24">24 ساعت قبل</option></select>
        <textarea id="planBody" class="input" placeholder="خلاصه یا متن تمرین" style="min-height:140px;margin-top:4px;width:100%;resize:vertical"></textarea>
      </div>
    </div>
    <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;"><button id="savePlanBtn" class="btn primary">ذخیره برنامهٔ تمرین</button><button class="btn" id="trainingFormModalCancel">بستن</button></div>
  </div>
</div>

<nav class="bottom-tabs" id="mobileMenu">
  <button class="tab-btn" id="tabAccount" title="حساب">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="display:block;margin:0 auto;">
    <title>Account Settings</title>
    <path d="M9.6,3.32a3.86,3.86,0,1,0,3.86,3.85A3.85,3.85,0,0,0,9.6,3.32M16.35,11a.26.26,0,0,0-.25.21l-.18,1.27a4.63,4.63,0,0,0-.82.45l-1.2-.48a.3.3,0,0,0-.3.13l-1,1.66a.24.24,0,0,0,.06.31l1,.79a3.94,3.94,0,0,0,0,1l-1,.79a.23.23,0,0,0-.06.3l1,1.67c.06.13.19.13.3.13l1.2-.49a3.85,3.85,0,0,0,.82.46l.18,1.27a.24.24,0,0,0,.25.2h1.93a.24.24,0,0,0,.23-.2l.18-1.27a5,5,0,0,0,.81-.46l1.19.49c.12,0,.25,0,.32-.13l1-1.67a.23.23,0,0,0-.06-.3l-1-.79a4,4,0,0,0,0-.49,2.67,2.67,0,0,0,0-.48l1-.79a.25.25,0,0,0,.06-.31l-1-1.66c-.06-.13-.19-.13-.31-.13L19.5,13a4.07,4.07,0,0,0-.82-.45l-.18-1.27a.23.23,0,0,0-.22-.21H16.46M9.71,13C5.45,13,2,14.7,2,16.83v1.92h9.33a6.65,6.65,0,0,1,0-5.69A13.56,13.56,0,0,0,9.71,13m7.6,1.43a1.45,1.45,0,1,1,0,2.89,1.45,1.45,0,0,1,0-2.89Z"/>
  </svg>
    <div class="tab-label">حساب</div>
  </button>
  <button class="tab-btn" id="tabPayments" title="شهریه">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="display:block;margin:0 auto;">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12.052 1.25H11.948C11.0495 1.24997 10.3003 1.24995 9.70552 1.32991C9.07773 1.41432 8.51093 1.59999 8.05546 2.05546C7.59999 2.51093 7.41432 3.07773 7.32991 3.70552C7.27259 4.13189 7.25637 5.15147 7.25179 6.02566C5.22954 6.09171 4.01536 6.32778 3.17157 7.17157C2 8.34315 2 10.2288 2 14C2 17.7712 2 19.6569 3.17157 20.8284C4.34314 22 6.22876 22 9.99998 22H14C17.7712 22 19.6569 22 20.8284 20.8284C22 19.6569 22 17.7712 22 14C22 10.2288 22 8.34315 20.8284 7.17157C19.9846 6.32778 18.7705 6.09171 16.7482 6.02566C16.7436 5.15147 16.7274 4.13189 16.6701 3.70552C16.5857 3.07773 16.4 2.51093 15.9445 2.05546C15.4891 1.59999 14.9223 1.41432 14.2945 1.32991C13.6997 1.24995 12.9505 1.24997 12.052 1.25ZM15.2479 6.00188C15.2434 5.15523 15.229 4.24407 15.1835 3.9054C15.1214 3.44393 15.0142 3.24644 14.8839 3.11612C14.7536 2.9858 14.5561 2.87858 14.0946 2.81654C13.6116 2.7516 12.964 2.75 12 2.75C11.036 2.75 10.3884 2.7516 9.90539 2.81654C9.44393 2.87858 9.24644 2.9858 9.11612 3.11612C8.9858 3.24644 8.87858 3.44393 8.81654 3.9054C8.771 4.24407 8.75661 5.15523 8.75208 6.00188C9.1435 6 9.55885 6 10 6H14C14.4412 6 14.8565 6 15.2479 6.00188ZM12 9.25C12.4142 9.25 12.75 9.58579 12.75 10V10.0102C13.8388 10.2845 14.75 11.143 14.75 12.3333C14.75 12.7475 14.4142 13.0833 14 13.0833C13.5858 13.0833 13.25 12.7475 13.25 12.3333C13.25 11.9493 12.8242 11.4167 12 11.4167C11.1758 11.4167 10.75 11.9493 10.75 12.3333C10.75 12.7174 11.1758 13.25 12 13.25C13.3849 13.25 14.75 14.2098 14.75 15.6667C14.75 16.857 13.8388 17.7155 12.75 17.9898V18C12.75 18.4142 12.4142 18.75 12 18.75C11.5858 18.75 11.25 18.4142 11.25 18V17.9898C10.1612 17.7155 9.25 16.857 9.25 15.6667C9.25 15.2525 9.58579 14.9167 10 14.9167C10.4142 14.9167 10.75 15.2525 10.75 15.6667C10.75 16.0507 11.1758 16.5833 12 16.5833C12.8242 16.5833 13.25 16.0507 13.25 15.6667C13.25 15.2826 12.8242 14.75 12 14.75C10.6151 14.75 9.25 13.7903 9.25 12.3333C9.25 11.143 10.1612 10.2845 11.25 10.0102V10C11.25 9.58579 11.5858 9.25 12 9.25Z" fill="currentColor"/>
  </svg>
    <div class="tab-label">شهریه</div>
  </button>
  <button class="tab-btn" id="tabCoaches" title="مربیان">
  <svg width="24" height="24" viewBox="0 0 297 297" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="display:block;margin:0 auto;">
  <g>
    <path d="m89.729,101.161c25.394,0 46.053-20.659 46.053-46.053 0-25.394-20.659-46.053-46.053-46.053-25.394,0-46.053,20.659-46.053,46.053 1.42109e-14,25.394 20.659,46.053 46.053,46.053z"/>
    <path d="m296.788,213.636c-0.241-0.742-1.053-2.498-3.377-2.781l-27.882-3.406c-6.908-0.845-12.785-5.115-15.722-11.422l-11.855-25.466v0.001c-0.989-2.124-2.909-2.353-3.691-2.353-0.78,0.001-2.7,0.23-3.688,2.352l-11.856,25.465c-2.935,6.307-8.812,10.578-15.719,11.423l-27.885,3.406c-2.324,0.284-3.135,2.039-3.377,2.781-0.24,0.742-0.616,2.639 1.097,4.235l20.555,19.146c5.094,4.742 7.338,11.652 6.005,18.483l-5.377,27.569c-0.447,2.299 0.971,3.613 1.602,4.071 0.632,0.458 2.322,1.401 4.368,0.266l24.56-13.634c3.042-1.689 6.379-2.533 9.715-2.533 3.338,0 6.675,0.844 9.718,2.533l24.56,13.634c2.049,1.137 3.735,0.193 4.367-0.266 0.631-0.458 2.051-1.772 1.602-4.071l-5.377-27.571c-1.332-6.831 0.913-13.741 6.005-18.482l20.557-19.144c1.712-1.596 1.337-3.494 1.095-4.236z"/>
    <path d="m156.567,208.708c2.433-7.488 8.798-12.732 16.612-13.685l6.262-.765v-32.258c0-17.525-11.262-33.065-27.916-38.521l-.077-.025-24.359-4.033c-2.073-0.638-4.288,0.46-5.034,2.505l-27.638,75.834c-1.595,4.375-7.782,4.375-9.376,0l-27.639-75.834c-0.602-1.652-2.161-2.687-3.831-2.687-0.396,0-25.561,4.21-25.561,4.21-16.791,5.594-28.01,21.159-28.01,38.761v63.1c0,9.456 7.666,17.122 17.122,17.122h145.198c3.739,0 7.193-1.201 10.006-3.237l-10.362-9.651c-5.762-5.366-7.83-13.35-5.397-20.836z"/>
    <path d="m99.719,117.565c-1.057-1.151-2.601-1.73-4.163-1.73h-11.654c-1.563,0-3.107,0.579-4.163,1.73-1.636,1.782-1.873,4.356-0.712,6.368l6.229,9.391-2.916,24.601 5.743,15.277c0.56,1.536 2.733,1.536 3.293,0l5.743-15.277-2.916-24.601 6.229-9.391c1.16-2.011 0.923-4.585-0.713-6.368z"/>
  </g>
  </svg>
    <div class="tab-label">مربیان</div>
  </button>
  <button class="tab-btn" id="tabSessions" title="تمرینات">
  <svg width="24" height="24" viewBox="0 0 512 512" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="display:block;margin:0 auto;">
    <!-- paths adapted from icons8-volleyball-100.svg; colors replaced with currentColor -->
    <g>
      <path d="M383.301,168.546c-6.107,8.825-12.711,17.27-19.676,25.413c-25.851,30.156-57.049,55.51-92.144,74.679c-0.058,2.22-0.058,4.442-0.058,6.604c0,34.227,5.98,68.202,17.455,100.219c5.98-2.591,11.834-5.367,17.698-8.27c76.344-38.046,139.189-97.131,181.939-171.012c3.75-6.535,7.335-13.139,10.724-19.86c-5.367-16.461-12.584-32.688-21.585-48.292c-13.081-22.626-29.046-42.487-47.172-59.328c-8.64,31.082-21.722,60.322-38.552,86.961C389.155,160.043,386.32,164.358,383.301,168.546z"/>
      <path d="M358.19,148.385h0.068c2.289-3.273,4.442-6.536,6.536-9.867c17.63-27.877,30.78-58.9,38.231-92.076c-6.78-4.752-13.744-9.194-20.893-13.198C343.638,11.532,299.983,0,255.762,0.059c-43.422,0-87.332,10.986-127.725,34.286c-11.532,6.662-22.266,14.064-32.318,22.15c86.221,2.834,169.413,29.356,241.443,77.085C344.32,138.332,351.353,143.261,358.19,148.385z"/>
      <path d="M110.952,193.404c10.676,0.926,21.283,2.465,31.822,4.5c39.283,7.587,77.095,22.325,111.323,43.666c32.191-17.269,60.867-40.334,84.488-67.714c-6.224-4.686-12.643-9.185-19.179-13.51c-71.056-47.124-153.692-72.04-239.037-72.04c-6.048,0-12.155,0.137-18.195,0.439c-11.045,12.828-20.718,26.581-28.929,41.133c-12.458,22.14-21.585,45.955-27.069,70.618c24.546-5.796,49.452-8.572,74.192-8.572C90.605,191.924,100.773,192.42,110.952,193.404z"/>
      <path d="M104.601,246.625c0.429-7.149,1.052-14.309,1.782-21.458c-8.63-0.809-17.328-1.179-26.016-1.179c-26.523,0-53.29,3.585-79.433,10.92C0.311,242.009,0,249.089,0,256.249c0.059,43.422,11.045,87.332,34.354,127.725c23.748,41.074,57.05,73.013,95.534,94.783c8.873,5.065,18.068,9.506,27.496,13.383c-35.328-66.974-53.708-141.04-53.708-216.528C103.676,265.931,103.988,256.249,104.601,246.625z"/>
      <path d="M271.482,416.964c-4.685-9.682-8.814-19.549-12.399-29.601c-13.003-35.835-19.724-73.764-19.724-112.121c0-1.666,0-3.331,0.059-4.997c-31.024-19.801-65.435-33.487-101.202-40.51c-0.681,6.224-1.237,12.506-1.607,18.867c-0.556,9-0.867,18.01-0.867,27.01c0,75.799,19.861,149.924,57.975,216.041c2.834,4.928,5.795,9.799,8.873,14.61h0.069c17.58,3.769,35.523,5.678,53.601,5.678c24.477,0,49.022-3.516,73.071-10.733c-18.555-19.549-34.412-41.075-47.416-64.082C278.203,430.532,274.686,423.811,271.482,416.964z"/>
      <path d="M509.848,222.878c-45.576,74.387-110.7,134.086-188.962,172.989c-6.477,3.214-12.956,6.292-19.549,9.136c2.649,5.542,5.484,10.978,8.503,16.335c13.939,24.672,31.452,47.425,52.423,67.53c7.344-3.39,14.62-7.082,21.712-11.212c41.133-23.756,73.013-57.049,94.793-95.533C500.477,343.639,512,299.973,512,255.752C511.941,244.774,511.27,233.807,509.848,222.878z"/>
    </g>
  </svg>
    <div class="tab-label">تمرینات</div>
  </button>
  <button class="tab-btn" id="tabCompetitions" title="مسابقات">
  <svg width="24" height="24" viewBox="0 0 512 512" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="display:block;margin:0 auto;">
  <!-- trophy icon adapted; colors normalized to currentColor for theming -->
  <g>
    <path d="M150.085,294.683h-31.549c-33.241,0-60.285-27.044-60.285-60.285s27.044-60.285,60.285-60.285h31.549c4.328,0,7.837,3.509,7.837,7.837c0,4.328-3.509,7.837-7.837,7.837h-31.549c-24.599,0-44.612,20.013-44.612,44.612s20.013,44.612,44.612,44.612h31.549c4.328,0,7.837,3.509,7.837,7.837S154.413,294.683,150.085,294.683z"/>
    <path d="M385.806,294.683h-31.549c-4.328,0-7.837-3.509-7.837-7.837s3.509-7.837,7.837-7.837h31.549c24.599,0,44.612-20.013,44.612-44.612s-20.013-44.612-44.612-44.612h-31.549c-4.328,0-7.837-3.509-7.837-7.837c0-4.328,3.509-7.837,7.837-7.837h31.549c33.241,0,60.285,27.044,60.285,60.285S419.047,294.683,385.806,294.683z"/>
  </g>
  <path d="M273.922,435.635v-78.734h-43.505v78.734c0,13.374-10.842,24.215-24.216,24.215l0,0v22.675h92.744v-22.675h-0.808C284.763,459.851,273.922,449.009,273.922,435.635z"/>
  <rect x="230.41" y="351.397" width="43.133" height="48.857"/>
  <path d="M354.257,161.958v113.072c0,56.148-45.939,102.085-102.085,102.085l0,0c-56.148,0-102.085-45.939-102.085-102.085V161.958H354.257z"/>
  <g>
    <path d="M323.114,161.958v81.928c0,56.148-45.939,102.085-102.085,102.085l0,0c-20.148,0-38.98-5.916-54.848-16.096c18.189,28.352,49.991,47.239,85.991,47.239l0,0c56.148,0,102.085-45.939,102.085-102.085V161.958H323.114z"/>
    <polygon points="28.643,85.924 40.895,57.281 61.398,80.736 92.425,83.537 76.454,110.285 83.378,140.659 53.005,133.735 26.256,149.706 23.455,118.679 0,98.176"/>
    <polygon points="233.163,37.611 255.835,1.761 278.317,37.731 319.418,48.216 292.156,80.713 294.885,123.041 255.554,107.156 216.14,122.831 219.094,80.517 192.006,47.877"/>
    <polygon points="465.212,76.285 494.128,64.695 492.041,95.778 512,119.699 481.793,127.319 465.212,153.692 448.629,127.319 418.422,119.699 438.381,95.778 436.294,64.695"/>
  </g>
  <rect x="186.295" y="482.531" width="131.647" height="27.708"/>
  <rect x="150.089" y="161.957" width="204.173" height="33.924"/>
  <rect x="186.295" y="496.376" width="131.647" height="13.854"/>
  <path d="M174.372,340.382c9.583,11.446,21.614,20.777,35.268,27.17V161.958h-35.268V340.382z"/>
  </svg>
    <div class="tab-label">مسابقات</div>
  </button>
</nav>

<script>
/* ================================================================
  SECTION: Helpers
  - small DOM helpers, string utilities, uid, escapeHtml, etc.
  ================================================================ */
/* Utility Helpers */
function qs(sel, root) { return (root || document).querySelector(sel); }

// Mark account tab as logged-in (adds green indicator). Call with true/false.
function setAccountIconLogged(isLogged) {
  try {
    const el = qs('#tabAccount'); if (!el) return;
    if (isLogged) el.classList.add('logged-in'); else el.classList.remove('logged-in');
    // also mark the label element explicitly so CSS specificity from other rules won't block the color change
    const lbl = el.querySelector('.tab-label'); if (lbl) { if (isLogged) lbl.classList.add('logged-in-label'); else lbl.classList.remove('logged-in-label'); }
  } catch (e) { console.debug('setAccountIconLogged failed', e); }
}

// Safe event binding helper: won't crash if element is missing
function on(sel, evt, fn, root = document) {
  const r = root || document;
  try {
    const els = r.querySelectorAll(sel);
    if (!els || els.length === 0) return;
    els.forEach(el => el.addEventListener(evt, fn, false));
  } catch (e) {
    // silent
  }

}

function qsa(sel, root) { return Array.from((root || document).querySelectorAll(sel)); }
function uid(prefix) { return (prefix || 'id') + '_' + Date.now() + '_' + Math.floor(Math.random() * 900); }
// Guarded click helper: prevents double-clicks / click-through by temporarily marking element busy
function safeClick(el, handler, ms = 450) {
  if (!el) return;
  el.addEventListener('click', function(e){
    try {
      if (el.dataset.busy === '1') { e.preventDefault(); e.stopPropagation(); return; }
      el.dataset.busy = '1';
      el.classList.add('disabled');
      // run handler synchronously (so it can read event), but protect against errors
      try { handler.call(this, e); } catch(err) { console.error('safeClick handler error', err); }
      setTimeout(() => { try { delete el.dataset.busy; el.classList.remove('disabled'); } catch(e){} }, ms);
    } catch (outer) { console.error('safeClick outer', outer); }
  }, {passive:false});
}
// Persistent device identifier (used for backups/devices registration)
function getDeviceId() {
  try {
    const key = 'vb_device_id_v1';
    let did = localStorage.getItem(key);
    if (!did) {
      // use a stable uuid-like value (not RFC4122) but good enough for client id
      did = 'dev_' + Date.now() + '_' + Math.floor(Math.random() * 1000000);
      localStorage.setItem(key, did);
    }
    return did;
  } catch (e) { return 'dev_unknown'; }
}
function getDeviceName() {
  try { return localStorage.getItem('vb_device_name') || (navigator.userAgent || 'unknown'); } catch(e){ return 'unknown'; }
}
function escapeHtml(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
// Map internal kind keys to Persian display labels
function mapKindToPersian(kind) {
  if (!kind) return '-';
  const k = String(kind).toLowerCase();
  if (k === 'friendly' || k === 'دوستانه') return 'دوستانه';
  if (k === 'league' || k === 'لیگ') return 'لیگ';
  if (k === 'knockout' || k === 'حذفی') return 'حذفی';
  if (k === 'group' || k === 'گروهی') return 'گروهی';
  if (k === 'tournament' || k === 'تورنمنت' || k === 'تورنامنت') return 'تورنمنت';
  return kind;
}
function normPersian(s) { return String(s || '').replace(/ي/g, 'ی').replace(/ك/g, 'ک').replace(/[\u200c\s]+/g, ' ').trim().toLowerCase(); }
// convert Persian/Arabic-Indic digits to ASCII digits for reliable numeric search
function digitsToAscii(s) {
  s = String(s || '');
  const persian = '۰۱۲۳۴۵۶۷۸۹';
  const arabic = '٠١٢٣٤٥٦٧٨٩';
  for (let i = 0; i < 10; i++) {
    const p = new RegExp(persian[i], 'g');
    const a = new RegExp(arabic[i], 'g');
    s = s.replace(p, String(i)).replace(a, String(i));
  }
  return s;
}
// debounce helper to avoid re-rendering on every keystroke
function debounce(fn, wait) {
  let t;
  return function(...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), wait);
  };
}

// build a normalized searchable string for a player record
function playerSearchable(p) {
  const parts = [p.name, p.phone, p.id, p.email, p.nick, p.memberId, p.skills, p.category].filter(Boolean);
  const joined = parts.join(' ');
  return digitsToAscii(normPersian(joined));
}
function formatNumber(input) {
  try {
    // normalize Persian/Arabic-Indic digits to ASCII
    let s = String(input.value || '');
    const persianDigits = '۰۱۲۳۴۵۶۷۸۹';
    const arabicDigits = '٠١٢٣٤٥٦٧٨٩';
    for (let i = 0; i < 10; i++) {
      s = s.replace(new RegExp(persianDigits[i], 'g'), String(i));
      s = s.replace(new RegExp(arabicDigits[i], 'g'), String(i));
    }
    // remove any non-digit characters
    s = s.replace(/[^0-9]/g, '');
    // format with thousand separators
    s = s.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    input.value = s;
  } catch (e) {
    input.value = input.value.replace(/\D/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }
}

// Test helper: call `testCaptureShare(id)` from console to open overlay and capture
window.testCaptureShare = async function(matchId) {
  console.log('html2canvas available?', typeof html2canvas !== 'undefined');
  if (!matchId) {
    console.warn('Please provide a match id. Example: testCaptureShare("match-1");');
    return;
  }
  try {
    openShareOverlay(matchId);
    // small delay to allow overlay to render
    await new Promise(r => setTimeout(r, 220));
    const m = (state.competitions||[]).find(x=>x.id===matchId);
    if (!m) return console.warn('match not found in state');
    await captureAndShareModal(m);
    console.log('capture attempted');
  } catch (e) { console.error('testCaptureShare failed', e); }
}

// Capture the visible share modal quickly using html2canvas (MVP):
// simple lock to prevent concurrent share flows
window.__shareLock = window.__shareLock || false;
async function _captureAndShareModalImpl(m) {
  const overlay = qs('#shareOverlay');
  const card = qs('#shareCard');
  if (!overlay || !card) throw new Error('Share overlay or card not found');
  // Prefer deterministic canvas renderer (faster, no DOM snapshot):
  try {
    // prepare safe data (convert File logos to data URLs if necessary)
    const safeM = { ...m };
    async function fileToDataUrl(f) {
      if (!f) return f;
      if (typeof f === 'string') return f;
      if (!(f instanceof File)) return f;
      return await new Promise(res => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(f); });
    }
    try {
      safeM.logoA = await fileToDataUrl(safeM.logoA);
      safeM.logoB = await fileToDataUrl(safeM.logoB);
    } catch (e) {
      console.warn('logo conversion failed', e);
    }

  // read live selected colors from the UI (use helper for consistency)
  const { colorA, colorB } = readShareColors();

    // If logos are missing from the match data, fall back to the visible image elements in the modal
    try {
      const domLogoA = (qs('#shareLogoA') && qs('#shareLogoA').src) || '';
      const domLogoB = (qs('#shareLogoB') && qs('#shareLogoB').src) || '';
      if (!safeM.logoA) safeM.logoA = domLogoA || (state.settings && state.settings.logo) || 'icons/volleyball (1).png';
      if (!safeM.logoB) safeM.logoB = domLogoB || 'icons/volleyball (1).png';
    } catch (e) { console.debug('logo fallback read failed', e); }

    // pass the visible court background (if present) to the deterministic renderer so it can draw it
    const courtEl = qs('#shareCourtBg');
    const courtImage = courtEl ? courtEl.src : null;

    const blob = await renderShareCanvasFromData(safeM, { width: 1080, height: 1920, colorA, colorB, courtImage });
    if (blob) {
      // attempt native share with files
      const file = new File([blob], (safeM.title||'match') + '.png', { type: 'image/png' });
        if (!window.__shareLock && navigator.canShare && navigator.canShare({ files: [file] })) {
          window.__shareLock = true;
          try { await navigator.share({ files: [file], title: safeM.title || 'مسابقه', text: safeM.teamA + ' vs ' + safeM.teamB }); window.__shareLock = false; return; } catch (e) { console.warn('navigator.share(files) failed', e); window.__shareLock = false; }
        }
      // fallback: download
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = (safeM.title||'match') + '.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      return;
    }
  } catch (err) {
    console.warn('Renderer capture failed, falling back to DOM snapshot', err);
  }

  // Fallback: clone + html2canvas snapshot (previous behavior)
  const clone = card.cloneNode(true);
  clone.style.width = getComputedStyle(card).width;
  clone.style.height = getComputedStyle(card).height;
  clone.style.boxSizing = 'border-box';
  clone.style.margin = '0';
  clone.style.position = 'relative';
  clone.id = 'shareCardClone';

  // copy useful computed styles from the live card so the offscreen clone matches appearance
  try {
    const src = window.getComputedStyle(card);
    const dst = clone.style;
    ['width','height','padding','border','border-radius','font-size','font-family','line-height','box-sizing','display','flex-direction','gap','align-items','justify-content','background','color'].forEach(k => {
      try { const v = src.getPropertyValue(k); if (v) dst.setProperty(k, v); } catch(e) {}
    });
    clone.classList.add('share-card-clone-preserve');
  } catch (e) { console.debug('failed to copy computed styles to clone', e); }

  Array.from(clone.querySelectorAll('.no-capture, button, input[type="color"], .share-controls')).forEach(el => {
    el.classList.add('capture-hide');
    if (el.classList && el.classList.contains('share-controls')) el.classList.add('collapse');
  });

  const stage = document.createElement('div');
  stage.style.position = 'fixed';
  stage.style.left = '-9999px';
  stage.style.top = '0';
  stage.style.zIndex = '99999';
  // sanitize clone images: replace cross-origin external images that may taint canvas
  try {
    Array.from(clone.querySelectorAll('img')).forEach(img => {
      try {
        const src = img.getAttribute('src') || '';
        // if the src is an absolute URL and not same-origin, swap to a local fallback to prevent CORS issues
        if (/^https?:\/\//i.test(src) && !src.startsWith(window.location.origin)) {
          // prefer app icons or in-repo images as fallback
          const fallback = (img.id && (img.id === 'shareLogoA' || img.id === 'shareLogoB')) ? (state.settings && state.settings.logo ? state.settings.logo : 'icons/volleyball (1).png') : 'icons/volleyball (1).png';
          img.setAttribute('data-orig-src', src);
          img.src = fallback;
        }
      } catch(e) { /* ignore per-image errors */ }
    });
  } catch(e) { console.debug('sanitize clone images failed', e); }
  stage.appendChild(clone);
  document.body.appendChild(stage);

  try {
    // wait a frame or two to ensure cloned images/text have started loading/painting
    try { await new Promise(r => setTimeout(r, 60)); await new Promise(res => requestAnimationFrame(() => requestAnimationFrame(res))); } catch(_){}
    const canvas = await html2canvas(clone, { backgroundColor: null, scale: 2, useCORS: true, allowTaint: true });
    const blob2 = await new Promise(res => canvas.toBlob(res, 'image/png'));
    // use a sanitized, match-specific filename instead of a static one
    const rawName = (m && (m.title || (m.teamA && m.teamB && (m.teamA + ' vs ' + m.teamB)) )) || 'match';
    const safeName = String(rawName).replace(/[\\/:\*\?"<>\|]/g, '_').slice(0,120);
    const filesArray = [ new File([blob2], safeName + '.png', { type: 'image/png' }) ];
    if (navigator.canShare && navigator.canShare({ files: filesArray })) {
      try { await navigator.share({ files: filesArray, title: m.title || 'مسابقه', text: m.teamA + ' vs ' + m.teamB }); document.body.removeChild(stage); return; } catch (e) { console.warn('navigator.share(files) failed', e); }
    }
    const url = URL.createObjectURL(blob2);
    const a = document.createElement('a'); a.href = url; a.download = safeName + '.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    document.body.removeChild(stage);
    return;
  } catch (e) {
    document.body.removeChild(stage);
    throw e;
  }
}

// Allow external code to install a primary capture implementation by setting
// window._captureAndShareModalImpl = function(match) { ... }
// Do NOT assign the wrapper to itself (that caused infinite recursion).
try { if (typeof window._captureAndShareModalImpl === 'undefined') window._captureAndShareModalImpl = undefined; } catch(_) {}
// by default, register our internal implementation so the wrapper can delegate to it
try { if (typeof window._captureAndShareModalImpl === 'undefined' || window._captureAndShareModalImpl === undefined) window._captureAndShareModalImpl = _captureAndShareModalImpl; } catch(_) {}

/* ================================================================
  SECTION: Date Utilities (Jalali <-> Gregorian)
  - conversion helpers, iso/jalali helpers, todayJalali, birthdays
  ================================================================ */
/* Jalali <-> Gregorian Utils */
function gregorian_to_jalali(gy, gm, gd) {
  gy = parseInt(gy); gm = parseInt(gm); gd = parseInt(gd);
  var g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
  var jy = (gy <= 1600) ? 0 : 979;
  gy -= (gy <= 1600) ? 621 : 1600;
  var gy2 = (gm > 2) ? (gy + 1) : gy;
  var days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100))
          + (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
  jy += 33 * (parseInt(days / 12053));
  days %= 12053;
  jy += 4 * (parseInt(days / 1461));
  days %= 1461;
  jy += parseInt((days - 1) / 365);
  if (days > 365) days = (days - 1) % 365;
  var jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
  var jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
  return [jy, jm, jd];
}
function jalali_to_gregorian(jy, jm, jd) {
  jy = parseInt(jy); jm = parseInt(jm); jd = parseInt(jd);
  var gy = (jy <= 979) ? 621 : 1600;
  jy -= (jy <= 979) ? 0 : 979;
  var days = (365 * jy) + ((parseInt(jy / 33)) * 8) + (parseInt(((jy % 33) + 3) / 4))
          + 78 + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186);
  gy += 400 * (parseInt(days / 146097));
  days %= 146097;
  if (days > 36524) {
      gy += 100 * (parseInt(--days / 36524));
      days %= 36524;
      if (days >= 365) days++;
  }
  gy += 4 * (parseInt((days) / 1461));
  days %= 1461;
  gy += parseInt((days - 1) / 365);
  if (days > 365) days = (days - 1) % 365;
  var gd = days + 1;
  var sal_a = [0, 31, ((gy % 4 == 0 && gy % 100 != 0) || (gy % 400 == 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
  var gm;
  for (gm = 0; gm < 13; gm++) {
      var v = sal_a[gm];
      if (gd <= v) break;
      gd -= v;
  }
  return [gy, gm, gd];
}
function isoToJalali(iso) {
  let d = new Date(iso);
  if (isNaN(d)) return '';
  let j = gregorian_to_jalali(d.getFullYear(), d.getMonth() + 1, d.getDate());
  return j[0] + '/' + String(j[1]).padStart(2, '0') + '/' + String(j[2]).padStart(2, '0');
}
function jalaliToISO(jalaliStr) {
  if (!jalaliStr || !jalaliStr.match(/^\d{4}\/\d{2}\/\d{2}$/)) return new Date().toISOString();
  let parts = jalaliStr.split('/').map(Number);
  let g = jalali_to_gregorian(parts[0], parts[1], parts[2]);
  return new Date(g[0], g[1] - 1, g[2]).toISOString();
}
function todayJalali() {
  let d = new Date();
  let r = gregorian_to_jalali(d.getFullYear(), d.getMonth() + 1, d.getDate());
  return r[0] + '/' + String(r[1]).padStart(2, '0') + '/' + String(r[2]).padStart(2, '0');
}
function isBirthdayToday(birthdate) {
  if (!birthdate || !birthdate.includes('/')) return false;
  const today = todayJalali(); // e.g., '1404/06/16'
  const [, todayMonth, todayDay] = today.split('/').map(Number);
  const [, birthMonth, birthDay] = birthdate.split('/').map(Number);
  return todayMonth === birthMonth && todayDay === birthDay;
}
// Returns array of players whose birthday is today
function getBirthdaysToday() {
  return (state.players || []).filter(p => isBirthdayToday(p.birthdate));
}
// Return up to n upcoming birthdays (excluding today), sorted by next occurrence
function getUpcomingBirthdays(n = 4) {
  let today = todayJalali().split('/').map(Number);
  let tMonth = today[1], tDay = today[2];
  function distance(birth) {
    if (!birth) return 9999;
    let parts = birth.split('/').map(Number);
    let m = parts[1], d = parts[2];
    // days until birthday in current year (approx by month/day ordering)
    let mm = m - tMonth;
    let dd = d - tDay;
    let dist = mm * 31 + dd;
    if (dist < 0) dist += 366; // next year
    return dist;
  }
  return (state.players || []).slice().sort((a,b) => distance(a.birthdate) - distance(b.birthdate)).filter(p => !isBirthdayToday(p.birthdate)).slice(0,n);
}
// days until next birthday for a Jalali birthdate string
function daysUntilBirthday(birthdate) {
  if (!birthdate) return '';
  // using jalali dates: compute next occurrence in current year or next year
  try {
    let parts = birthdate.split('/').map(Number);
    let now = todayJalali().split('/').map(Number);
    let year = now[0], m = parts[1], d = parts[2];
    let candidate = jalaliToISO(`${year}/${String(m).padStart(2,'0')}/${String(d).padStart(2,'0')}`);
    let cDate = new Date(candidate);
    let today = new Date();
    if (cDate < today) {
      candidate = jalaliToISO(`${year+1}/${String(m).padStart(2,'0')}/${String(d).padStart(2,'0')}`);
      cDate = new Date(candidate);
    }
    const diff = Math.ceil((cDate - today) / (1000*60*60*24));
    return diff;
  } catch(e) { return ''; }
}

// Tweak header background for each theme to be closer to the theme accent color
// (preference: subtle gradient using accent variables)
document.documentElement.style.setProperty('--header-bg-modern', 'linear-gradient(180deg, rgba(59,130,246,0.15), rgba(52,211,153,0.08))');
document.documentElement.style.setProperty('--header-bg-luxury', 'linear-gradient(180deg, rgba(250,204,21,0.12), rgba(14,165,233,0.06))');
document.documentElement.style.setProperty('--header-bg-fun', 'linear-gradient(180deg, rgba(139,92,246,0.12), rgba(6,182,212,0.06))');
// Apply these as defaults
document.querySelectorAll('[data-style]').forEach(el => {});
function isInsuranceExpired(insuranceDate) {
  if (!insuranceDate) return true;
  let parts = insuranceDate.split('/').map(Number);
  let g = jalali_to_gregorian(parts[0], parts[1], parts[2]);
  let insurance = new Date(g[0], g[1] - 1, g[2]);
  insurance.setFullYear(insurance.getFullYear() + 1);
  let today = new Date();
  return today > insurance;
}
function jalaliToDate(jalali) {
  if (!jalali) return new Date(0);
  let parts = jalali.split('/').map(Number);
  let g = jalali_to_gregorian(parts[0], parts[1], parts[2]);
  return new Date(g[0], g[1] - 1, g[2]);
}
function calculateMembershipDuration(joinDate) {
  if (!joinDate) return '—';
  let join = jalaliToDate(joinDate);
  let today = new Date();
  let years = today.getFullYear() - join.getFullYear();
  let months = today.getMonth() - join.getMonth();
  if (today.getDate() < join.getDate()) months--;
  if (months < 0) { years--; months += 12; }
  let parts = [];
  if (years > 0) parts.push(years + ' سال');
  if (months > 0) parts.push(months + ' ماه');
  return parts.length ? parts.join(' و ') : 'کمتر از یک ماه';
}

/* محاسبه سن دقیق */
function calcExactAge(birthJalali) {
  if (!birthJalali) return { years: 0, months: 0, days: 0 };
  let parts = String(birthJalali).split('/').map(Number);
  let today = todayJalali().split('/').map(Number);
  let years = today[0] - parts[0];
  let months = today[1] - parts[1];
  let days = today[2] - parts[2];
  if (days < 0) {
    months--;
    days += 30; // تقریبی
  }
  if (months < 0) {
    years--;
    months += 12;
  }
  return { years, months, days };
}

// تابع تعیین رده بر اساس سن (جایگزین determineCategory)
// helper: parse a Jalali reference date which can be either 'YYYY/MM/DD' or 'DD <PersianMonth> YYYY' (e.g., '11 دی 1404')
function parseJalaliRefDate(rawRef) {
  const persianMonths = { 'فروردین':1,'اردیبهشت':2,'خرداد':3,'تیر':4,'مرداد':5,'شهریور':6,'مهر':7,'آبان':8,'آذر':9,'دی':10,'بهمن':11,'اسفند':12 };
  if (!rawRef) return null;
  let s = String(rawRef).trim();
  // YYYY/MM/DD
  if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(s)) {
    return s.split('/').map(n => Number(n));
  }
  // DD <MonthName> YYYY
  const m = s.match(/^(\d{1,2})\s+(\S+)\s+(\d{4})$/);
  if (m) {
    const d = Number(m[1]);
    const monthName = m[2];
    const y = Number(m[3]);
    const mon = persianMonths[monthName] || NaN;
    if (Number.isFinite(d) && Number.isFinite(mon) && Number.isFinite(y)) return [y, mon, d];
  }
  // fallback: try to split by '/' anyway
  if (s.indexOf('/') !== -1) {
    const parts = s.split('/').map(n => Number(n));
    if (parts.length === 3 && parts.every(p => Number.isFinite(p))) return parts;
  }
  return null;
}

function determineCategory(age) {
  // age: { years, months, days, birthdate }
  const ranks = (state.settings && state.settings.ranks) ? state.settings.ranks : [
    { id: 'mini', name: 'مینی والیبال', minAgeYears: 0, maxAgeYears: 12 },
    { id: 'noonahal', name: 'نونهالان', minAgeYears: 13, maxAgeYears: 14 },
    { id: 'nojavanan', name: 'نوجوانان', minAgeYears: 15, maxAgeYears: 16 },
    { id: 'nojavanan_boghr', name: 'نوجوانان بزرگ', minAgeYears: 17, maxAgeYears: 18 },
    { id: 'javan', name: 'جوانان', minAgeYears: 19, maxAgeYears: 20 },
    { id: 'omid', name: 'امیدها', minAgeYears: 21, maxAgeYears: 22 },
    { id: 'adult', name: 'بزرگسالان', minAgeYears: 23, maxAgeYears: 200 }
  ];

  // Reference date to compute age against (Jalali). Prefer explicit ranksReferenceDate, otherwise use lastCategoryUpdate or today
  const rawRef = (state.settings && state.settings.ranksReferenceDate) ? state.settings.ranksReferenceDate : ((state.settings && state.settings.lastCategoryUpdate) ? state.settings.lastCategoryUpdate : todayJalali());
  const refParts = parseJalaliRefDate(rawRef) || parseJalaliRefDate(todayJalali()) || [ (new Date()).getFullYear(), 1, 1 ];
  // compute exact age on ref date if birthdate present
  if (!age || typeof age !== 'object') return ranks[ranks.length-1].name;
  let years = age.years;
  // if birthdate provided, recalc age relative to reference date
  if (age.birthdate) {
    try {
      const birthParts = String(age.birthdate).split('/').map(Number);
      let y = Number(refParts[0]) - Number(birthParts[0]);
      let m = Number(refParts[1]) - Number(birthParts[1]);
      let d = Number(refParts[2]) - Number(birthParts[2]);
      if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) throw new Error('invalid parts');
      if (d < 0) { m--; d += 30; }
      if (m < 0) { y--; m += 12; }
      years = y;
    } catch (e) { /* fallback to provided age.years */ }
  }

  // Coerce to number and attempt a fallback if years is invalid (NaN/undefined)
  years = Number(years);
  if (!Number.isFinite(years)) {
    // try to compute from birthdate using calcExactAge helper if available
    try {
      if (age && age.birthdate && typeof calcExactAge === 'function') {
        const fb = calcExactAge(age.birthdate);
        if (fb && Number.isFinite(fb.years)) years = Number(fb.years);
      }
    } catch (e) { /* ignore fallback errors */ }
  }
  // if still invalid, return an explicit unknown marker instead of defaulting to last rank
  if (!Number.isFinite(years)) {
    console.warn('determineCategory: invalid age years, returning unknown', age);
    return 'نامشخص';
  }

  // prefer explicit startDateJ overrides: if a rank has startDateJ and refJ is before it, skip it
  for (let r of ranks) {
    if (r.startDateJ) {
      try {
        const startISO = jalaliToISO(r.startDateJ);
        // normalize refParts to YYYY/MM/DD
        const normRef = `${String(refParts[0])}/${String(refParts[1]).padStart(2,'0')}/${String(refParts[2]).padStart(2,'0')}`;
        const refISO = jalaliToISO(normRef);
        if (new Date(refISO) < new Date(startISO)) continue; // rank not yet active at ref
      } catch(e) { /* ignore parse */ }
    }
    const minY = (typeof r.minAgeYears === 'number') ? r.minAgeYears : -1;
    const maxY = (typeof r.maxAgeYears === 'number') ? r.maxAgeYears : 999;
    if (years >= minY && years <= maxY) return r.name;
  }

  return ranks[ranks.length-1].name;
}

// تابع محاسبه زمان باقی‌مانده تا رده بعدی
function calculateTimeToNextCategory(age, category) {
  // تعریف سن هدف برای رده بعدی
  const nextAgeMap = {
    'مینی والیبال': 13,
    'نونهالان': 15,
    'نوجوانان': 17,
    'نوجوانان بزرگ': 19,
    'جوانان': 21,
    'امیدها': 23,
    'بزرگسالان': null
  };

  let nextAge = nextAgeMap[category];
  if (!nextAge) return 'این آخرین رده است.';

  // تاریخ مرجع
  let refDateStr = state.settings.lastCategoryUpdate || '11 دی 1404'; // پیش‌فرض اصلاح‌شده

  // تاریخ تولد از age.birthdate (فرمت جلالی: '1380/01/01')
  let birthParts = age.birthdate.split('/').map(Number); // [سال, ماه, روز]
  let birthYear = birthParts[0];
  let birthMonth = birthParts[1];
  let birthDay = birthParts[2];

  // تاریخ امروز (جلالی)
  let today = todayJalali(); // مثل '1404/06/10'
  let [todayYear, todayMonth, todayDay] = today.split('/').map(Number);

  // محاسبه سال تولد بعدی که بازیکن به سن nextAge می‌رسد
  let nextBirthYear = birthYear + nextAge;
  let nextBirthJ = `${nextBirthYear}/${birthMonth.toString().padStart(2, '0')}/${birthDay.toString().padStart(2, '0')}`;
  let nextBirthISO = jalaliToISO(nextBirthJ); // تبدیل به میلادی
  let nextBirthDate = new Date(nextBirthISO);

  // تاریخ امروز به میلادی
  let todayISO = jalaliToISO(today);
  let todayDate = new Date(todayISO);

  // محاسبه زمان باقی‌مانده تا تولد بعدی
  let delta = nextBirthDate - todayDate; // میلی‌ثانیه
  if (delta < 0) {
    // اگر تولد گذشته، به تولد سال بعد برو
    nextBirthYear++;
    nextBirthJ = `${nextBirthYear}/${birthMonth.toString().padStart(2, '0')}/${birthDay.toString().padStart(2, '0')}`;
    nextBirthISO = jalaliToISO(nextBirthJ);
    nextBirthDate = new Date(nextBirthISO);
    delta = nextBirthDate - todayDate;
  }

  // تبدیل دلتا به سال، ماه، روز
  let daysTotal = Math.floor(delta / (1000 * 60 * 60 * 24));
  let years = Math.floor(daysTotal / 365);
  let remainingDays = daysTotal % 365;
  let months = Math.floor(remainingDays / 30);
  let days = remainingDays % 30;

  // رده بعدی
  let nextCategory = determineCategory({ years: nextAge });

  // تنظیم نسبت به تاریخ مرجع
  // اگر تولد بعدی قبل از تاریخ مرجع باشد، رده تا مرجع بعدی تغییر نمی‌کند
  let refParts = refDateStr.split(' ');
  let refDay = parseInt(refParts[0]);
  let refMonth = monthNameToNumber(refParts[1]);
  let refYear = parseInt(refParts[2]);
  let refDateJ = `${refYear}/${refMonth.toString().padStart(2, '0')}/${refDay.toString().padStart(2, '0')}`;
  let refDateISO = jalaliToISO(refDateJ);
  let refDate = new Date(refDateISO);

  if (nextBirthDate < refDate && todayDate < refDate) {
    // تولد بعدی قبل از مرجع است، باید تا مرجع بعدی صبر کنیم
    let nextRefYear = refYear + 1;
    let nextRefJ = `${nextRefYear}/${refMonth.toString().padStart(2, '0')}/${refDay.toString().padStart(2, '0')}`;
    let nextRefISO = jalaliToISO(nextRefJ);
    let nextRefDate = new Date(nextRefISO);
    delta = nextRefDate - todayDate;
    daysTotal = Math.floor(delta / (1000 * 60 * 60 * 24));
    years = Math.floor(daysTotal / 365);
    remainingDays = daysTotal % 365;
    months = Math.floor(remainingDays / 30);
    days = remainingDays % 30;
  }

  // تولید متن خروجی
  let output = `${years} سال، ${months} ماه، ${days} روز مانده تا رده ${nextCategory} (نسبت به مرجع: ${refDateStr})`;
  return output;
}

/* ================================================================
  SECTION: Embedded Auth Wiring
  - wires the embedded auth box (ids: loginEmail/loginPassword/etc.)
  - uses global `supabase` if available
  - reuses showAlert/showLoading helpers if defined; otherwise provides small fallbacks
  ================================================================ */
;(function(){
  // fallbacks for showAlert / showLoading if not defined in scope yet
  function _showAlert(el, msg, type){
    if (!el) return; el.textContent = msg; el.className = 'alert alert-' + type; el.style.display = 'block';
    // longer display time (8s)
    setTimeout(()=>el.style.display='none',8000);
  }
  function _showLoading(el, show){ if (!el) return; el.style.display = show ? 'block' : 'none'; }

  const TA = document.getElementById('embeddedAuthBox');
  if (!TA) return;

  // Tab behavior
  TA.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
      // manage active tab style
      TA.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      // explicitly hide all forms then show target
      ['loginFormEmbedded','signupFormEmbedded','recoveryFormEmbedded'].forEach(id=>{ const e=document.getElementById(id); if(e) e.classList.remove('active'); });
      const tab = btn.dataset.tab;
      const id = ({login:'loginFormEmbedded', signup:'signupFormEmbedded', recovery:'recoveryFormEmbedded'})[tab];
      const el = document.getElementById(id);
      if (el) {
        el.classList.add('active');
        // ensure the form is visible inside the card
        el.scrollIntoView({behavior:'smooth', block:'start'});
        // clear any running login spinner if user navigates away
        try { const lb = document.getElementById('loginBtn'); if (lb) { const s = lb.querySelector('.inline-spinner'); if (s) s.classList.remove('running'); lb.disabled = false; } } catch(_){ }
      }
    });
  });

  // recent emails helper: store recent used emails for quick suggestions
  function getRecentEmails(){ try { const raw = localStorage.getItem('recentLoginEmails'); return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
  function addRecentEmail(email){ try { if (!email) return; let list = getRecentEmails(); list = list.filter(e=>e!==email); list.unshift(email); list = list.slice(0,10); localStorage.setItem('recentLoginEmails', JSON.stringify(list)); populateRecentEmails(); } catch(e){} }
  function populateRecentEmails(){ try { const list = getRecentEmails(); const dl = document.getElementById('recentEmails'); if (!dl) return; dl.innerHTML = ''; list.forEach(e=>{ const o = document.createElement('option'); o.value = e; dl.appendChild(o); }); } catch(e){} }
  // ensure tabs are horizontal (defensive, in case CSS forced column)
  try { const tabs = TA.querySelector('.form-tabs'); if (tabs) tabs.style.flexDirection = 'row'; } catch(e){}
  // populate datalist on init
  populateRecentEmails();

  // Helper accessors (use global helpers if available)
  const showAlert = window.showAlert || _showAlert;
  const showLoading = window.showLoading || _showLoading;

  // Login
  const loginBtn = document.getElementById('loginBtn');
  if (loginBtn) loginBtn.addEventListener('click', async function(){
    const alertEl = document.getElementById('loginAlert');
    const loadingEl = document.getElementById('loginLoading');
    const spinner = loginBtn.querySelector('.inline-spinner');
    const label = loginBtn.querySelector('.login-label');
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    if (!email || !password) return showAlert(alertEl,'لطفاً تمامی فیلدها را پر کنید','danger');
  // start inline spinner and disable button
  if (spinner) { spinner.classList.add('running'); }
    loginBtn.disabled = true;
    showLoading(loadingEl,true);
    try {
  // ensure UI shows login form
  TA.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  TA.querySelector('[data-tab="login"]').classList.add('active');
  ['loginFormEmbedded','signupFormEmbedded','recoveryFormEmbedded'].forEach(id=>{ const e=document.getElementById(id); if(e) e.classList.remove('active'); });
  document.getElementById('loginFormEmbedded').classList.add('active');
  const client = getSupabaseClient();
    if (!client) { setEmbeddedStatus(false); return showAlert(alertEl,'کلاینت Supabase مقداردهی نشده یا آماده نیست','danger'); }
    const { data, error } = await client.auth.signInWithPassword({ email, password });
    if (data && data.session) {
      // initialize backup client flush attempt (best-effort)
  // Auto backup after login disabled
    }
      if (error) {
        // map common supabase/auth errors to Persian messages
        const msg = (error && error.message) ? String(error.message).toLowerCase() : '';
        // Detect email-not-confirmed / confirmation-required messages and show profile with resend option
        if (msg.includes('email') && (msg.includes('confirm') || msg.includes('confirmation') || msg.includes('not confirmed') || msg.includes('unconfirmed') || msg.includes('confirm email'))) {
          // show compact confirmation UI: 3-line hint, email, Logout & Resend buttons
          try { showAlert(alertEl, 'لطفاً ایمیل خود را تأیید کنید — بعد از تأیید مجدداً وارد برنامه شوید', 'danger'); } catch(_){ }
          try {
            const ac = document.getElementById('accountProfileContainer'); if (ac) {
              ac.style.display = 'block';
              // clear contents of accountActions and show compact layout
              const actions = document.getElementById('accountActions') || ac;
              // remove/clear many controls and inject compact elements
              try { actions.innerHTML = ''; } catch(_){}
              // hint block
              const hint = document.createElement('div');
              hint.id = 'accountConfirmHint';
              hint.style.fontSize = '0.95em';
              hint.style.color = 'var(--muted)';
              hint.style.margin = '6px 0 12px 0';
              hint.style.lineHeight = '1.4';
              hint.innerHTML = 'لطفاً ایمیل خود را تأیید کنید<br>بعد از تأیید ایمیل مجدداً وارد برنامه شوید.<br><small>ایمیل تأیید از طرف Supabase Auth ارسال می‌شود</small>';
              actions.appendChild(hint);
              // show user's email
              const emDiv = document.createElement('div'); emDiv.style.marginBottom = '8px'; emDiv.style.fontWeight = '700'; emDiv.textContent = email || '';
              actions.appendChild(emDiv);
              // row for buttons
              const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginTop='6px';
              // Logout
              try {
                const out = document.getElementById('logoutBtn') ? document.getElementById('logoutBtn') : document.createElement('button');
                out.id = 'logoutBtn'; out.className = 'btn btn-ghost'; out.textContent = '🚪 خروج';
                out.addEventListener('click', async ()=>{ try { const c = getSupabaseClient(); if (c && c.auth) await c.auth.signOut(); window.location.reload(); } catch(e){ console.debug('logout failed', e); } });
                row.appendChild(out);
              } catch(_){ }
              // Resend confirmation
              const b = document.createElement('button');
              b.id = 'resendConfirmBtn'; b.className = 'btn btn-ghost'; b.textContent = 'ارسال مجدد ایمیل تأیید';
              b.addEventListener('click', async ()=>{ try { await attemptResendConfirmation(email); alert('درخواست ارسال ایمیل تأیید ارسال شد. ایمیل خود را بررسی کنید'); } catch(e){ console.warn('resend attempt failed', e); alert('درخواست ارسال ایمیل تایید ناموفق بود'); } });
              row.appendChild(b);
              actions.appendChild(row);
              // bottom spacing to avoid menu overlap
              try { ac.style.paddingBottom = '56px'; } catch(_){ }
            }
          } catch(_){ }
        }
        else if (msg.includes('invalid password') || msg.includes('invalid login') || msg.includes('invalid credentials') || msg.includes('invalid grant')) {
          showAlert(alertEl,'رمز عبور اشتباه است','danger');
        } else if (msg.includes('user not found') || msg.includes('no user') || msg.includes('not found') || msg.includes('email not found')) {
          showAlert(alertEl,'کاربری با این ایمیل یافت نشد','danger');
        } else {
          showAlert(alertEl, error.message || 'خطا در ورود','danger');
        }
      }
      else {
        showAlert(alertEl,'ورود موفقیت‌آمیز','success');
        try { addRecentEmail(email); } catch(_){}
        // Navigate to account view and show the full editable profile under the profile card
        try { showView('account'); } catch(e) {}
        try {
          // Keep the embedded auth box visible and show the minimal account card below it
          const pc = document.getElementById('accountProfileContainer'); if (pc) { pc.style.display = 'block'; pc.scrollIntoView({behavior:'smooth', block:'start'}); }
          if (window.loadProfile) {
            // Ensure we have a stable user object from the auth client. Some Supabase setups
            // may not immediately expose getUser() data right after signInWithPassword returns.
            let userObj = (data && data.user) ? data.user : null;
            try {
              const client = getSupabaseClient();
              if (client && (!userObj || !userObj.id) && client.auth && typeof client.auth.getUser === 'function') {
                // poll briefly for the client to report the current user
                for (let i = 0; i < 8; i++) {
                  try {
                    const { data: gu } = await client.auth.getUser();
                    if (gu && gu.user && gu.user.id) { userObj = gu.user; break; }
                  } catch(_){}
                  await new Promise(r => setTimeout(r, 150));
                }
              }
            } catch(e) { console.debug('post-login getUser poll failed', e); }
            try { await window.loadProfile(userObj || data && data.user); } catch(e) { console.warn('loadProfile after login failed', e); }
            // best-effort: refresh UI renderers so restored state shows immediately
            try { if (typeof window.renderAll === 'function') window.renderAll(); } catch(_){}
          }
          // Hide only the auth forms (keep account/profile card visible)
          try { if (typeof window.showAuthForms === 'function') window.showAuthForms(false); else { const eb = document.getElementById('embeddedAuthBox'); if (eb) eb.style.display = 'none'; } } catch(_){ }
          // automatic background backup disabled to avoid unexpected POST errors
          // (call backupNow manually via the "همگام‌سازی الآن" button)
          try { console.debug('post-login sync skipped (automatic backup disabled)'); } catch(_){ }
        } catch(e) { console.warn('post-login show profile failed', e); }
      }
    } catch(e){ showAlert(alertEl,'خطا در ارتباط','danger'); }
    finally {
      // stop inline spinner and re-enable
      try { if (spinner) { spinner.classList.remove('running'); } } catch(_){}
      try { loginBtn.disabled = false; } catch(_){}
      showLoading(loadingEl,false);
    }
  });

  // password show/hide toggle for embedded login
  (function(){
    const toggle = document.getElementById('toggleLoginPassword');
    const icon = document.getElementById('toggleLoginPasswordIcon');
    if (!toggle) return;
    toggle.addEventListener('click', ()=>{
      const pwd = document.getElementById('loginPassword');
      if (!pwd) return;
      if (pwd.type === 'password') {
        pwd.type = 'text';
        if (icon) icon.innerHTML = '<path d="M2 2l20 20"></path><path d="M10.58 10.58A3 3 0 0 0 13.42 13.42"></path><path d="M9.88 5.88A10 10 0 0 1 22 12a21.5 21.5 0 0 1-5 6"></path>';
      } else {
        pwd.type = 'password';
        if (icon) icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"></path><circle cx="12" cy="12" r="3"></circle>';
      }
    });
  })();

  // Signup
  const signupBtn = document.getElementById('signupBtn');
  if (signupBtn) signupBtn.addEventListener('click', async function(){
    const alertEl = document.getElementById('signupAlert');
    
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    if (!email || !password || !confirmPassword) return showAlert(alertEl,'لطفاً تمامی فیلدها را پر کنید','danger');
    if (password !== confirmPassword) return showAlert(alertEl,'رمز عبور مطابقت ندارد','danger');
    // ensure UI shows signup form
    TA.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    TA.querySelector('[data-tab="signup"]').classList.add('active');
    ['loginFormEmbedded','signupFormEmbedded','recoveryFormEmbedded'].forEach(id=>{ const e=document.getElementById(id); if(e) e.classList.remove('active'); });
    document.getElementById('signupFormEmbedded').classList.add('active');
    // start spinner and disable
    const spinner = signupBtn.querySelector('.inline-spinner'); if (spinner) spinner.classList.add('running'); signupBtn.disabled = true;
    try {
  const client = getSupabaseClient();
  if (!client) { setEmbeddedStatus(false); if (spinner) spinner.classList.remove('running'); signupBtn.disabled = false; return showAlert(alertEl,'کلاینت Supabase مقداردهی نشده یا آماده نیست','danger'); }
  const { data, error } = await client.auth.signUp({ email, password, options:{ emailRedirectTo: 'https://pouriaabedi0073-sys.github.io/volleyball-club/confirm-signup.html' }});
  if (data && data.session) {
  // Auto backup after signup disabled
  }
      if (error) showAlert(alertEl, error.message || 'خطا در ثبت نام','danger');
      else {
        showAlert(alertEl,'ثبت نام انجام شد، ایمیل خود را بررسی کنید','success');
        // If Supabase returned an authenticated user (depends on project settings), show profile or instruct to verify
        try {
          if (data && data.user) {
            try { addRecentEmail(email); } catch(_){ }
            // check for common confirmation flags on the returned user object
            const u = data.user || {};
            const isConfirmed = Boolean(u.confirmed_at || u.email_confirmed_at || u.email_confirmed);
            // hide auth forms
            try { if (typeof window.showAuthForms === 'function') window.showAuthForms(false); else { const eb = document.getElementById('embeddedAuthBox'); if (eb) eb.style.display = 'none'; } } catch(_){ }
            const pc = document.getElementById('accountProfileContainer');
            if (pc) pc.style.display = 'block';
            if (!isConfirmed) {
              // compact confirmation UI for unconfirmed signup
              try { document.getElementById('accountName').textContent = 'لطفاً ایمیل خود را تأیید کنید'; } catch(_){ }
              try { document.getElementById('accountEmail').textContent = email || ''; } catch(_){ }
              try {
                const ac = document.getElementById('accountProfileContainer'); if (ac) {
                  ac.style.display = 'block';
                  const actions = document.getElementById('accountActions') || ac;
                  try { actions.innerHTML = ''; } catch(_){ }
                  const hint = document.createElement('div');
                  hint.id = 'accountConfirmHint'; hint.style.fontSize='0.95em'; hint.style.color='var(--muted)'; hint.style.margin='6px 0 12px 0'; hint.style.lineHeight='1.4';
                  hint.innerHTML = 'لطفاً ایمیل خود را تأیید کنید<br>بعد از تأیید ایمیل مجدداً وارد برنامه شوید.<br><small>ایمیل تأیید از طرف Supabase Auth ارسال می‌شود</small>';
                  actions.appendChild(hint);
                  const emDiv = document.createElement('div'); emDiv.style.marginBottom='8px'; emDiv.style.fontWeight='700'; emDiv.textContent = email || '';
                  actions.appendChild(emDiv);
                  const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginTop='6px';
                  const out = document.getElementById('logoutBtn') ? document.getElementById('logoutBtn') : document.createElement('button');
                  out.id='logoutBtn'; out.className='btn btn-ghost'; out.textContent='🚪 خروج'; out.addEventListener('click', async ()=>{ try { const c = getSupabaseClient(); if (c && c.auth) await c.auth.signOut(); window.location.reload(); } catch(e){ console.debug('logout failed', e); } });
                  row.appendChild(out);
                  const b = document.createElement('button'); b.id='resendConfirmBtn'; b.className='btn btn-ghost'; b.textContent='ارسال مجدد ایمیل تأیید'; b.addEventListener('click', async ()=>{ try { await attemptResendConfirmation(email); alert('درخواست ارسال ایمیل تأیید ارسال شد. ایمیل خود را بررسی کنید'); } catch(e){ console.warn('resend attempt failed', e); alert('درخواست ارسال ایمیل تایید ناموفق بود'); } });
                  row.appendChild(b);
                  actions.appendChild(row);
                  try { ac.style.paddingBottom='56px'; } catch(_){ }
                }
              } catch(_){ }
              // attempt to register device even if account unconfirmed so devices table is populated
              setTimeout(()=>{ try { if (window.registerDeviceForUser) window.registerDeviceForUser(data.user); else console.debug('registerDeviceForUser not ready yet'); } catch(_){ } }, 200);
            } else {
              // confirmed - load profile and show editable UI
              // automatic post-signup backup disabled to avoid unexpected POST errors
              try { console.debug('post-signup sync skipped (automatic backup disabled)'); } catch(_){ }
              if (window.loadProfile) await window.loadProfile(data.user);
              try { const f = document.getElementById('profileFirst'); if (f) f.focus(); } catch(_){ }
            }
          }
        } catch(e) { console.warn('post-signup show profile failed', e); }
      }
    } catch(e){ showAlert(alertEl,'خطا در ارتباط','danger'); }
    finally { if (spinner) spinner.classList.remove('running'); signupBtn.disabled = false; }
  });

  // Recovery
  const recoveryBtn = document.getElementById('recoveryBtn');
  if (recoveryBtn) recoveryBtn.addEventListener('click', async function(){
    const alertEl = document.getElementById('recoveryAlert');
    const email = document.getElementById('recoveryEmail').value.trim();
    if (!email) return showAlert(alertEl,'لطفاً ایمیل را وارد کنید','danger');
    // ensure UI shows recovery form
    TA.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    TA.querySelector('[data-tab="recovery"]').classList.add('active');
    ['loginFormEmbedded','signupFormEmbedded','recoveryFormEmbedded'].forEach(id=>{ const e=document.getElementById(id); if(e) e.classList.remove('active'); });
    document.getElementById('recoveryFormEmbedded').classList.add('active');
    // start spinner and disable
    const rspinner = recoveryBtn.querySelector('.inline-spinner'); if (rspinner) rspinner.classList.add('running'); recoveryBtn.disabled = true;
    try {
  const client = getSupabaseClient();
  if (!client) { setEmbeddedStatus(false); if (rspinner) rspinner.classList.remove('running'); recoveryBtn.disabled = false; return showAlert(alertEl,'کلاینت Supabase مقداردهی نشده یا آماده نیست','danger'); }
  const { data, error } = await client.auth.resetPasswordForEmail(email, { redirectTo: 'https://pouriaabedi0073-sys.github.io/volleyball-club/reset-password.html' });
      if (error) showAlert(alertEl, error.message || 'خطا در درخواست','danger');
      else showAlert(alertEl,'لینک بازیابی به ایمیل شما ارسال شد','success');
    } catch(e){ showAlert(alertEl,'خطا در ارتباط','danger'); }
    finally { if (rspinner) rspinner.classList.remove('running'); recoveryBtn.disabled = false; }
  });

  // Attempt to resend the confirmation email for a given address.
  // Uses Supabase `resend` flow if available (some SDKs expose an API), otherwise calls auth.api via REST if configured.
  async function attemptResendConfirmation(email) {
    try {
      if (!email) return alert('ایمیل وارد نشده است');
      const client = getSupabaseClient(); if (!client) return alert('کلاینت Supabase آماده نیست');
      // Supabase JS doesn't have a direct 'resend confirmation' method; we attempt a magic link signUp with redirect to trigger email OR call the REST endpoint
      try {
        // Try calling /auth/v1/otp (not always available) — safest is to call signUp with redirect which will trigger confirmation email again
        const { data, error } = await client.auth.signUp({ email, password: Math.random().toString(36).slice(2,10) }, { emailRedirectTo: window.location.href });
        // Immediately sign the user out if we accidentally created a temp account session
        try { await client.auth.signOut(); } catch(_){ }
        if (error) {
          console.warn('resend via signUp returned error', error);
          alert('درخواست ارسال ایمیل تأیید ناموفق بود: ' + (error.message || JSON.stringify(error)));
        } else {
          alert('درخواست ارسال ایمیل تأیید انجام شد. ایمیل خود را بررسی کنید');
        }
        return;
      } catch(e) {
        console.warn('resend confirmation fallback failed', e);
        alert('ارسال ایمیل تأیید امکان‌پذیر نیست، لطفاً در تنظیمات سرور بررسی کنید');
      }
    } catch(e) { console.warn('attemptResendConfirmation failed', e); alert('خطا در ارسال ایمیل تأیید'); }
  }

  // reflect connection status if global function exists
  if (typeof updateConnectionStatus === 'function') {
    // if Supabase exists now, mark connected
    try { if (typeof supabase !== 'undefined') updateConnectionStatus(true); }
    catch(_){}
  }

  // Initialize backup sync if available
  try {
    const client = getSupabaseClient();
    if (client && window.backupSync) {
      // Get user email for backup sync
      (async () => {
        try {
          const { data: { user } } = await client.auth.getUser();
          if (user?.email) {
            window.backupSync.setGroupEmail(user.email);
            console.info('✅ Backup sync initialized with user email');
          }
        } catch(e) {
          console.debug('Backup sync initialization deferred until login');
        }
      })();
    }
  } catch(e) {}

  // No realtime events needed for new backup system - it uses pull-based sync
  // This avoids direct coupling to a legacy `shared_backups` table while preserving UI behavior.
  function subscribeToSharedBackups(email) {
    try {
      if (!email) return;
      window.__shared_backups_sub = window.__shared_backups_sub || {};
      if (window.__shared_backups_sub[email]) return; // already subscribed

      const handler = (e) => {
        try {
          const d = e.detail || {};
          // expect supabaseSync to emit { table, event, row }
          if (!d || !d.row) return;
          const record = d.row;
          // match by group_email if present, or fallback to profile email match
          const groupEmail = (record && (record.group_email || (record.profiles && record.profiles[0] && record.profiles[0].email))) || null;
          if (!groupEmail) return;
          if (groupEmail.toLowerCase() !== email.toLowerCase()) return;

          // Update UI similar to previous behavior
          try {
            const deviceInfo = (record && (record.last_sync_device || record.device_id || record.device)) || 'دستگاه دیگر';
            const backupIcon = document.getElementById('backupIcon');
            const backupStatus = document.getElementById('backupStatus');
            const lastSyncLine = document.getElementById('lastSyncLineHeader') || document.getElementById('lastSyncLine') || document.getElementById('lastSyncLineFallback');
            if (backupIcon) { backupIcon.style.background = 'linear-gradient(180deg,#34d399,#10b981)'; backupIcon.style.border='none'; }
            if (backupStatus) { backupStatus.textContent = 'همگام‌سازی گروهی دریافت شد'; backupStatus.style.color = 'var(--accent)'; }
            const when = new Date().toLocaleString();
            if (lastSyncLine) lastSyncLine.textContent = `آخرین همگام‌سازی: ${when} • ${deviceInfo}`;
          } catch(_){ }

          // Auto-import payload into local state (throttled)
          try { autoImportSharedPayload(record); } catch(_){ }
        } catch(err) { console.warn('shared_backups handler error', err); }
      };

      // Attach handler to global supabase:realtime events
      window.addEventListener('supabase:realtime', handler);
      // mark subscription so we don't add duplicate listeners
      window.__shared_backups_sub[email] = { handler };
    } catch (e) { console.warn('subscribeToSharedBackups failed', e); }
  }

  // Ensure a shared backup placeholder exists for this email.
  // New flow: do not touch legacy `shared_backups` table. If possible, enqueue a profiles upsert so other devices can discover the user.
  async function ensureSharedBackupExists(email) {
    try {
      if (!email) return;
      // If the new sync module is available, request a profiles upsert via outbox so the server-side profile gets a last_sync placeholder.
      if (window.supabaseSync && typeof window.supabaseSync.enqueueOp === 'function') {
        try {
          const payload = { id: (window.supabase && window.supabase.auth && window.supabase.auth.user) ? window.supabase.auth.user.id : null, last_sync_at: new Date().toISOString(), last_sync_device: getDeviceName(), last_sync_payload: { note: 'placeholder' } };
          window.supabaseSync.enqueueOp({ type: 'profiles_upsert', payload, ts: Date.now() });
        } catch(e) { console.debug('ensureSharedBackup enqueue failed', e); }
      }
      // otherwise no-op — we keep behavior quiet to avoid errors when legacy table is absent
    } catch (e) { console.debug('ensureSharedBackupExists failed', e); }
  }

  // Device registration removed for new backup-focused schema.
  async function registerDeviceForUser(user) {
    // intentionally a no-op to preserve callers
    return;
  }

  // If the shared_backups row exists but its data is empty ({} or null), seed it with the provided snapshot
  async function ensureSeedSharedBackup(email, snapshot) {
    try {
      if (!email) return;
      const client = getSupabaseClient(); if (!client) return;
      const displayEmailLower = email.toLowerCase();
      // New flow: create a backup snapshot via backupSync so shared_backups and backups are managed server-side
      try {
        if (window.backupSync && typeof window.backupSync.createBackup === 'function') {
          if (snapshot) {
            // set group email and create a backup (this will call mark_shared_backup RPC server-side)
            window.backupSync.setGroupEmail(displayEmailLower);
            await window.backupSync.createBackup();
            return;
          }
        }
      } catch(e) { console.debug('ensureSeedSharedBackup via backupSync failed', e); }
    } catch(e) { console.debug('ensureSeedSharedBackup failed', e); }
  }

  // local status updater for embedded box
  function setEmbeddedStatus(connected) {
    const ind = document.getElementById('statusIndicator');
    const txt = document.getElementById('statusText');
    if (!ind || !txt) return;
    if (connected) {
      ind.classList.remove('status-disconnected'); ind.classList.add('status-connected');
      txt.textContent = 'آنلاین';
      txt.style.color = 'var(--accent)';
    } else {
      ind.classList.remove('status-connected'); ind.classList.add('status-disconnected');
      txt.textContent = 'آفلاین';
      txt.style.color = 'var(--muted)';
    }
  }

  // Update the profile sync status UI with a short status and optional reason
  function updateSyncStatusUI(status, reason) {
    try {
      const backupIcon = document.getElementById('backupIcon');
      const syncStatusLine = document.getElementById('syncStatusLine');
      const syncStatusText = document.getElementById('syncStatusText');
      const lastSyncLine = document.getElementById('lastSyncLine') || document.getElementById('lastSyncLineHeader_old') || document.getElementById('lastSyncLineFallback');
      // keep legacy hidden element updated for compatibility
      const backupStatus_old = document.getElementById('backupStatus_old');
      if (status === 'ok') {
        if (backupIcon) { backupIcon.style.background = 'linear-gradient(180deg,#34d399,#10b981)'; backupIcon.style.border='none'; }
        if (syncStatusText) syncStatusText.textContent = 'انلاین';
        if (syncStatusLine) syncStatusLine.style.display = 'block';
        if (lastSyncLine && reason) lastSyncLine.textContent = `آخرین همگام‌سازی: ${reason}`;
        if (backupStatus_old) { backupStatus_old.textContent = 'همگام‌سازی آنلاین'; backupStatus_old.style.color = 'var(--accent)'; }
      } else if (status === 'group-received') {
        if (backupIcon) { backupIcon.style.background = 'linear-gradient(180deg,#34d399,#10b981)'; backupIcon.style.border='none'; }
        if (syncStatusText) syncStatusText.textContent = 'واردسازی گروهی';
        if (syncStatusLine) syncStatusLine.style.display = 'block';
        if (lastSyncLine && reason) lastSyncLine.textContent = `آخرین همگام‌سازی: ${reason}`;
        if (backupStatus_old) { backupStatus_old.textContent = 'همگام‌سازی گروهی دریافت شد'; backupStatus_old.style.color = 'var(--accent)'; }
      } else if (status === 'pending') {
        if (backupIcon) { backupIcon.style.background = 'transparent'; backupIcon.style.border='1px solid rgba(0,0,0,0.06)'; }
        if (syncStatusText) syncStatusText.textContent = 'در صف';
        if (syncStatusLine) syncStatusLine.style.display = 'block';
        if (lastSyncLine && reason) lastSyncLine.textContent = reason;
        if (backupStatus_old) { backupStatus_old.textContent = 'همگام‌سازی در صف'; backupStatus_old.style.color = 'var(--muted)'; }
      } else {
        // default: not synced
        if (backupIcon) { backupIcon.style.background = 'transparent'; backupIcon.style.border='1px solid rgba(0,0,0,0.06)'; }
        if (syncStatusText) syncStatusText.textContent = 'غیرفعال';
        if (syncStatusLine) syncStatusLine.style.display = 'block';
        if (lastSyncLine && reason) lastSyncLine.textContent = reason;
        if (backupStatus_old) { backupStatus_old.textContent = 'اتصال برقرار نیست'; backupStatus_old.style.color = 'var(--muted)'; }
      }
    } catch(e) { console.warn('updateSyncStatusUI failed', e); }
  }

  // Auto-import shared payloads (throttled). payload may be a record or object containing .data (jsonb)
  const __shared_import_throttle = new Map();
  async function autoImportSharedPayload(payload) {
      try {
        // Respect user preference: only auto-import when toggle enabled
        try {
          const autoToggle = document.getElementById('autoImportToggle');
          if (autoToggle && !autoToggle.checked) return; // user disabled auto-import
          // Fallback to localStorage (in case controls not yet wired)
          if (!autoToggle) {
            try { const v = localStorage.getItem('autoImportToggle'); if (v !== '1') return; } catch(_){ }
          }
        } catch(_){ }
      if (!payload) return;
      const key = (payload.id || payload.group_email || 'shared') + ':' + ((payload.last_sync_at || payload.updated_at) || 't');
      const now = Date.now();
      const last = __shared_import_throttle.get(key) || 0;
      if (now - last < 5000) return; // throttle 5s per payload key
      __shared_import_throttle.set(key, now);
      // Extract data field
      let raw = payload.data || payload;
      // If raw is an empty object, treat as no payload
      try {
        if (raw && typeof raw === 'object' && !Array.isArray(raw) && Object.keys(raw).length === 0) {
          console.debug('autoImportSharedPayload: empty payload, skipping');
          return;
        }
      } catch(_){ }
      // If record shape contains nested .data (from realtime), normalize
      if (payload && payload.record && payload.record.data) raw = payload.record.data;
      let parsed = null;
      try { parsed = typeof raw === 'string' ? JSON.parse(raw) : raw; } catch(e){ parsed = raw; }

      // New flow: apply parsed snapshot to the app state directly using mergeSnapshotIntoState
      try {
        if (Array.isArray(parsed)) {
          // legacy array-of-items shape: try to convert into table -> rows mapping
          const tables = {};
          parsed.forEach(item => { if (item && item.table && item.row) { tables[item.table] = tables[item.table] || []; tables[item.table].push(item.row); } });
          if (Object.keys(tables).length > 0) {
            if (typeof window.mergeSnapshotIntoState === 'function') {
              window.mergeSnapshotIntoState({ tables });
            } else {
              // best-effort: apply rows into window.state
              Object.keys(tables).forEach(tbl => { window.state = window.state || {}; window.state[tbl] = window.state[tbl] || []; const map = new Map((window.state[tbl]||[]).map(r=>[r.id,r])); tables[tbl].forEach(row=>{ if(!row||!row.id) return; const ex = map.get(row.id); if(!ex) { window.state[tbl].push(row); map.set(row.id,row); } else { const a=new Date(ex.last_modified||0).getTime(); const b=new Date(row.last_modified||0).getTime(); if(b>=a){ const idx = window.state[tbl].findIndex(x=>x&&x.id===row.id); if(idx!==-1) window.state[tbl][idx] = Object.assign({}, ex, row); } } }); });
            }
          }
        } else if (typeof parsed === 'object' && parsed !== null) {
          // object shaped snapshot { table: [rows] }
          if (typeof window.mergeSnapshotIntoState === 'function') {
            window.mergeSnapshotIntoState({ tables: parsed });
          } else {
            // fallback merge
            Object.keys(parsed).forEach(tbl => { const rows = parsed[tbl] || []; window.state = window.state || {}; window.state[tbl] = window.state[tbl] || []; const map = new Map((window.state[tbl]||[]).map(r=>[r.id,r])); rows.forEach(row=>{ if(!row||!row.id) return; const ex = map.get(row.id); if(!ex) { window.state[tbl].push(row); map.set(row.id,row); } else { const a=new Date(ex.last_modified||0).getTime(); const b=new Date(row.last_modified||0).getTime(); if(b>=a){ const idx = window.state[tbl].findIndex(x=>x&&x.id===row.id); if(idx!==-1) window.state[tbl][idx] = Object.assign({}, ex, row); } } }); });
          }
        }
        try { updateSyncStatusUI('ok', 'واردسازی گروهی انجام شد'); } catch(_){ }
        // update visible status lines in profile UI
        try {
          const syncStatusText = document.getElementById('syncStatusText');
          const syncStatusLine = document.getElementById('syncStatusLine');
          const lastSyncLine = document.getElementById('lastSyncLine');
          if (syncStatusText) syncStatusText.textContent = 'وارد شد';
          if (syncStatusLine) syncStatusLine.style.display = 'block';
          if (lastSyncLine) { lastSyncLine.style.display = 'block'; lastSyncLine.textContent = `آخرین همگام‌سازی: ${new Date().toLocaleString()}`; }
        } catch(_){ }
      } catch (e) {
        console.warn('autoImportSharedPayload merge error', e);
      }
    } catch(e) { console.warn('autoImportSharedPayload error', e); }
  }

  // Load and render the current user's profile into the account area
  // Accept an optional `providedUser` to avoid race with auth state immediately after sign-in
  window.loadProfile = async function(providedUser) {
    try {
      const client = getSupabaseClient();
      if (!client) { setEmbeddedStatus(false); return; }
      setEmbeddedStatus(true);
      let user = providedUser || null;
      if (!user) {
        const { data: userData } = await client.auth.getUser();
        user = userData?.user || null;
      }
      if (!user) {
        // not signed in
        document.getElementById('accountProfileContainer').style.display = 'none';
        return;
      }
      // Register this device for the signed-in user so the `devices` table is populated
      try { registerDeviceForUser(user); } catch(_){ }
      // fetch profile row (first try selecting known columns)
      let profile = null;
      let fetchFailed = false; // track whether profile fetch ultimately failed
      try {
  const res = await client.from('profiles').select('display_name,phone_number,avatar_url,email,bio,user_id,created_at,updated_at').eq('user_id', user.id).maybeSingle();
        console.debug('profiles select result:', res);
        profile = res.data || null;
        if (res.error) throw res.error;
      } catch (err) {
        console.warn('Could not fetch profile with specific columns:', err && (err.message || err));
        console.debug('detailed error object:', err);
        // retry with a generic select in case PostgREST rejected the explicit columns (avoid 406)
        try {
          const res2 = await client.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
          console.debug('profiles fallback select result:', res2);
          profile = res2.data || null;
          if (res2.error) throw res2.error;
        } catch (err2) {
          console.warn('Fallback profile fetch also failed:', err2 && (err2.message || err2));
          console.debug('fallback detailed error object:', err2);
          fetchFailed = true;
          try { const pm = document.getElementById('profileMsg'); if (pm) pm.textContent = 'پروفایل یافت نشد یا بازیابی نشد (خطای شبکه/پیکربندی)'; } catch(_){}
        }
      }
  // Render minimal fields and populate the editable form
  const accountEl = document.getElementById('accountProfileContainer'); if (accountEl) accountEl.style.display = 'block';
  // If ProfileComponent is available, mount it into the dedicated mount point so it owns rendering
  try {
    const mount = document.getElementById('profileMount');
    if (window.ProfileComponent && mount) {
      // hide legacy static fields to avoid duplicates
      try { document.getElementById('accountName').style.display = 'none'; } catch(_){}
      try { document.getElementById('accountEmail').style.display = 'none'; } catch(_){}
      try { document.getElementById('accountPhone').style.display = 'none'; } catch(_){}
      // mount or remount component
      try {
        if (window._profileComponentInstance && typeof window._profileComponentInstance.unmount === 'function') {
          window._profileComponentInstance.unmount();
          window._profileComponentInstance = null;
        }
      } catch(_){}
      try { window.ProfileComponent.mount(mount); } catch(e) { console.warn('ProfileComponent mount failed', e); }
    } else {
  // fallback to legacy static rendering
  document.getElementById('accountName').textContent = (profile && profile.display_name) ? profile.display_name : (user.email || 'کاربر');
  const displayEmail = ((profile && profile.email) ? profile.email : (user.email || '')) || '';
  const displayEmailLower = displayEmail ? displayEmail.toLowerCase() : '';
  document.getElementById('accountEmail').textContent = displayEmailLower || displayEmail;
  // normalize phone property
  document.getElementById('accountPhone').textContent = (profile && (profile.phone_number || profile.phone)) ? (profile.phone_number || profile.phone) : '';
  try { document.getElementById('accountBio').textContent = (profile && profile.bio) ? profile.bio : ''; } catch(_){ }
  if (profile && profile.avatar_url) document.getElementById('accountAvatar').src = profile.avatar_url;
    }
  } catch(e) { console.warn('mounting ProfileComponent failed', e); }
  // Render last sync info if available on profile
  try {
  const lastSyncLine = document.getElementById('lastSyncLineHeader') || document.getElementById('lastSyncLine') || document.getElementById('lastSyncLineFallback');
    const backupStatus = document.getElementById('backupStatus');
    const backupIcon = document.getElementById('backupIcon');
    if (profile && (profile.last_sync_at || profile.last_sync_device)) {
      const d = profile.last_sync_at ? new Date(profile.last_sync_at) : null;
      const when = d ? d.toLocaleString() : '—';
      const device = profile.last_sync_device || '—';
      if (lastSyncLine) lastSyncLine.textContent = `آخرین همگام‌سازی: ${when} • ${device}`;
      if (backupStatus) { backupStatus.textContent = 'همگام‌سازی انجام شده'; backupStatus.style.color = 'var(--accent)'; }
      if (backupIcon) { backupIcon.style.background = 'linear-gradient(180deg,#34d399,#10b981)'; backupIcon.style.border = 'none'; }
    } else {
      if (lastSyncLine) lastSyncLine.textContent = 'آخرین همگام‌سازی: —';
      if (backupStatus) { backupStatus.textContent = 'همگام‌سازی نشده'; backupStatus.style.color = 'var(--muted)'; }
      if (backupIcon) { backupIcon.style.background = 'transparent'; backupIcon.style.border = '1px solid rgba(0,0,0,0.06)'; }
    }
  } catch(e) { console.warn('render last sync info failed', e); }
  // populate edit fields if present (fallback to auth user when profile read fails)
  try { document.getElementById('profileFirst').value = (!fetchFailed && profile && profile.first_name) ? profile.first_name : ''; } catch(_){ }
  try { document.getElementById('profileLast').value = (!fetchFailed && profile && profile.last_name) ? profile.last_name : ''; } catch(_){ }
  try { document.getElementById('profileEmail').value = (!fetchFailed && profile && profile.email) ? profile.email : (user.email || ''); } catch(_){ }
  try { document.getElementById('profilePhone').value = (!fetchFailed && profile && profile.phone) ? profile.phone : ''; } catch(_){ }
  try { if (!fetchFailed && profile && profile.avatar_url) document.getElementById('editAvatarPreview').src = profile.avatar_url; } catch(_){ }
      // if no profile row exists, attempt to create a minimal one so the admin sees something
      if (!profile) {
        try {
          console.debug('No profile found — attempting to upsert minimal profile');
          // Prefer RPC auto_profile_upsert if available for security and simplicity
          try {
            if (client && typeof client.rpc === 'function') {
              await client.rpc('auto_profile_upsert', { p_email: user.email || '' });
            }
          } catch(rpcErr) { console.debug('auto_profile_upsert rpc failed', rpcErr); }
          const up = await client.from('profiles').upsert(
            { user_id: user.id, email: user.email || '' },
            { onConflict: 'email', returning: 'representation' }
          );
          console.debug('profiles upsert result:', up);
          if (!up.error) {
            profile = up.data && Array.isArray(up.data) ? up.data[0] : up.data; // handle different client return shapes
            // try to re-fetch authoritative profile row (in case upsert returned null shape)
            try {
              const { userId: reUid } = await getCurrentUserId();
              if (reUid) {
                const ref = await client.from('profiles').select('display_name,phone_number,avatar_url,email,bio,user_id,created_at,updated_at').eq('user_id', reUid).maybeSingle();
                console.debug('re-fetch after upsert result:', ref);
                if (ref && !ref.error) profile = ref.data || profile;
              } else {
                console.debug('re-fetch after upsert skipped: no userId');
              }
            } catch (rf) { console.debug('re-fetch after upsert failed', rf); }
          }
        } catch (uerr) {
          console.warn('Auto-upsert profile failed:', uerr && (uerr.message || uerr));
          fetchFailed = true;
        }
      }
      // After profile is present and user is authenticated, set up backupSync group email and prompt restore
      try {
        // ensure supabaseClient exists (use given constants or existing instance)
        try {
          const SUPABASE_URL = window.SUPABASE_URL || 'https://wtycgduarwpgnxxvwtgz.supabase.co';
          const SUPABASE_KEY = window.SUPABASE_KEY || window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0eWNnZHVhcndwZ254eHZ3dGd6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDMyNzUsImV4cCI6MjA3Mzg3OTI3NX0.uqjl1qWII_Yzw86uOHlesjH0YP4AL4QMhjFItPb2DjU';
          if (typeof supabase !== 'undefined' && supabase && !window.supabaseClient) {
            try { window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(_){ }
          }
        } catch(_){ }

        if (window.backupSync && typeof window.backupSync.setGroupEmail === 'function') {
          try { await window.backupSync.setGroupEmail((profile && profile.email) ? profile.email : (user.email || '')); } catch(e) { console.debug('setGroupEmail failed', e); }
          try { await window.backupSync.promptRestoreIfNoLocalData(); } catch(e) { console.debug('promptRestoreIfNoLocalData failed', e); }
        }
      } catch(e) { console.warn('backupSync post-login setup failed', e); }
      // Replace old import button handler with new sync controls wiring
      try {
        async function performImportLastSync() {
          const client = getSupabaseClient();
          if (!client) { try { showToast('کلاینت Supabase آماده نیست'); } catch(_){ } return; }
          try {
                  // Confirm once per email: store confirmation in localStorage
                  try {
                    const displayEmail = ((profile && profile.email) ? profile.email : (user.email || '')) || '';
                    const key = 'import_confirmed:' + (displayEmail ? displayEmail.toLowerCase() : '');
                    if (displayEmail) {
                      const was = localStorage.getItem(key);
                      if (!was) {
                        const ok = confirm('آیا می‌خواهید اولین بار همگام‌سازی مشترک برای این حساب را وارد کنید؟ (این عملیات داده‌های محلی را تغییر می‌دهد)');
                        if (!ok) return; // user cancelled
                        try { localStorage.setItem(key, '1'); } catch(_){ }
                      }
                    }
                  } catch(_){ }
            let payload = null;
            try {
              const displayEmail = ((profile && profile.email) ? profile.email : (user.email || '')) || '';
              const displayEmailLower = displayEmail ? displayEmail.toLowerCase() : '';
              if (displayEmailLower) {
                const sres = await client.from('shared_backups').select('data,last_sync_at,device_id').eq('group_email', displayEmailLower).order('last_sync_at', { ascending: false }).limit(1).maybeSingle();
                if (sres && !sres.error && sres.data && sres.data.data) {
                  payload = sres.data.data;
                  try { const lastSyncLine = document.getElementById('lastSyncLineHeader') || document.getElementById('lastSyncLine') || document.getElementById('lastSyncLineFallback'); if (lastSyncLine) lastSyncLine.textContent = `آخرین همگام‌سازی: ${new Date(sres.data.last_sync_at || sres.data.created_at).toLocaleString()} • ${sres.data.device_id || 'دستگاه دیگر'}`; } catch(_){ }
                }
              }
            } catch (sharedErr) { console.warn('shared_backups read failed', sharedErr); }
            if (!payload) {
              const { userId: pUid } = await getCurrentUserId();
              if (pUid) {
                const res = await client.from('profiles').select('last_sync_payload,last_sync_at,last_sync_device').eq('user_id', pUid).maybeSingle();
                if (res && res.error) throw res.error;
                payload = res.data && res.data.last_sync_payload;
                if (!payload) {
                  try {
                    const bres = await client.from('backups').select('data,created_at,device_id').eq('user_id', pUid).order('created_at', { ascending: false }).limit(1).maybeSingle();
                    if (bres && !bres.error && bres.data && bres.data.data) {
                      payload = bres.data.data;
                      try { const lastSyncLine = document.getElementById('lastSyncLineHeader') || document.getElementById('lastSyncLine') || document.getElementById('lastSyncLineFallback'); if (lastSyncLine) lastSyncLine.textContent = `آخرین همگام‌سازی: ${new Date(bres.data.created_at).toLocaleString()} • ${bres.data.device_id || '—'}`; } catch(_){ }
                    }
                  } catch(be) { console.warn('backup fallback read failed', be); }
                }
              } else {
                console.debug('performImportLastSync: skipped profile/backups lookup - no userId');
              }
            }
            if (!payload) { try { showToast('هیچ همگام‌سازی آخر ذخیره‌شده‌ای پیدا نشد'); } catch(_){ } return; }
            let parsed = null; try { parsed = typeof payload === 'string' ? JSON.parse(payload) : payload; } catch(pe){ parsed = payload; }
            try {
              // Merge parsed snapshot into local state. Prefer existing merge helper if available.
              if (parsed) {
                if (typeof mergeSnapshotIntoState === 'function') {
                  mergeSnapshotIntoState({ tables: parsed });
                } else {
                  // naive merge: replace or assign top-level tables
                  window.state = window.state || {};
                  Object.keys(parsed).forEach(tbl => { try { window.state[tbl] = parsed[tbl]; } catch(_){} });
                }
                try { showToast('همگام‌سازی وارد شد'); } catch(_){ }
                try { const backupIcon = document.getElementById('backupIcon'); if (backupIcon) { backupIcon.style.background = 'linear-gradient(180deg,#34d399,#10b981)'; backupIcon.style.border='none'; } const backupStatus = document.getElementById('backupStatus'); if (backupStatus) { backupStatus.textContent='همگام‌سازی وارد شد'; backupStatus.style.color='var(--accent)'; } } catch(_){ }
              } else {
                try { showToast('هیچ دادهٔ همگام‌سازی برای واردسازی وجود ندارد'); } catch(_){ }
              }
            } catch(err) {
              console.warn('import last sync failed during merge', err);
            }
          } catch (err) {
            console.warn('import last sync failed', err);
            try { showToast('خطا در وارد کردن همگام‌سازی: ' + (err && err.message ? err.message : String(err))); } catch(_){ }
          }
        }

        function attachSyncControls(){
          try {
            const autoToggle = document.getElementById('autoImportToggle');
            const importBtn = document.getElementById('importNowBtn');
            const forceSync = document.getElementById('forceSyncBtn');
            // restore persisted preference
            try { const v = localStorage.getItem('autoImportToggle'); if (autoToggle) autoToggle.checked = (v === null ? true : v === '1'); } catch(_){ }
            if (autoToggle) autoToggle.addEventListener('change', ()=>{ try { localStorage.setItem('autoImportToggle', autoToggle.checked ? '1' : '0'); } catch(_){ } });
            if (importBtn) importBtn.addEventListener('click', async ()=>{ await performImportLastSync(); });
            if (forceSync) forceSync.addEventListener('click', async ()=>{ try { if (typeof backupNow === 'function') await backupNow(); try { showToast('درخواست ارسال همگام‌سازی فرستاده شد'); } catch(_){ } } catch(e){ console.warn('force sync failed', e); try { showToast('ارسال همگام‌سازی ناموفق'); } catch(_){ } } });
          } catch(e) { console.warn('attachSyncControls failed', e); }
        }

        // wire controls now (loadProfile calls subscribeToSharedBackups later, which will call autoImportSharedPayload)
        try { attachSyncControls(); } catch(_){ }
      } catch(e) { console.warn('attach sync controls failed', e); }
      // After profile is loaded, subscribe to shared backups by email so other devices using same email trigger realtime
      try {
  const displayEmail = ((profile && profile.email) ? profile.email : (user.email || '')) || '';
  const displayEmailLower = displayEmail ? displayEmail.toLowerCase() : '';
  if (displayEmailLower) subscribeToSharedBackups(displayEmailLower);
    if (displayEmailLower) try { ensureSharedBackupExists(displayEmailLower); } catch(_){ }
    // If the shared backup exists but is empty, seed it with the local snapshot so other devices see current state
    try {
      try {
        // derive a snapshot from last_sync_payload/profile/backups as in backupNow
        let snapshot = null;
        try {
          const { userId: ssUid } = await getCurrentUserId();
          if (ssUid) {
            const res = await getSupabaseClient().from('profiles').select('last_sync_payload').eq('user_id', ssUid).maybeSingle();
            if (res && !res.error && res.data && res.data.last_sync_payload) snapshot = res.data.last_sync_payload;
          } else console.debug('seed snapshot fetch skipped: no userId');
        } catch(_){}
        // legacy backups.data column no longer exists; skip trying to read it
        if (!snapshot) {
          // fallback left intentionally empty; snapshot may be created later via backupSync
        }
        if (!snapshot) {
          // as a last resort, create a minimal snapshot from profile
          snapshot = { profiles: [ { id: user.id, email: user.email } ] };
        }
        try { ensureSeedSharedBackup(displayEmailLower, snapshot); } catch(_){ }
      } catch(e) { console.debug('seed shared backup workflow failed', e); }
    } catch(_){ }
      } catch(_){ }
    // Do not forcibly close the edit box here; let the user control it via the Edit button
    // (previous behavior hid the box which could interfere with the Edit button UX)
    } catch (e) {
      console.error('loadProfile failed', e);
    }
  };

  // --- Sync status UI wiring: show a small green/white dot before status text and listen to syncHybrid events ---
  (function(){
    try {
      const makeDot = () => {
        let el = document.getElementById('syncStatusDot');
        if (!el) {
          el = document.createElement('span');
          el.id = 'syncStatusDot';
          el.style.display = 'inline-block';
          el.style.width = '12px';
          el.style.height = '12px';
          el.style.borderRadius = '50%';
          el.style.marginRight = '6px';
          el.style.verticalAlign = 'middle';
          el.style.border = '1px solid rgba(0,0,0,0.06)';
        }
        return el;
      };

      function applyStatus(st) {
        try {
          const syncLine = document.getElementById('syncStatusLine');
          const syncText = document.getElementById('syncStatusText');
          if (!syncLine || !syncText) return;
          const dot = makeDot();
          // prepend dot to syncLine if not present
          if (!syncLine.querySelector('#syncStatusDot')) {
            syncLine.insertBefore(dot, syncLine.firstChild);
          }
          if (st && st.syncing) {
            dot.style.background = 'linear-gradient(180deg,#ffffff,#10b981)';
            dot.style.boxShadow = '0 0 0 3px rgba(16,185,129,0.08)';
            syncText.textContent = 'همگام‌سازی در حال انجام است';
            syncLine.style.display = 'block';
          } else if (st && st.online === false) {
            dot.style.background = 'linear-gradient(180deg,#ffffff,#f59e0b)';
            dot.style.boxShadow = '0 0 0 3px rgba(245,158,11,0.06)';
            syncText.textContent = 'آفلاین — تغییرات محلی ذخیره شد';
            syncLine.style.display = 'block';
          } else {
            dot.style.background = 'linear-gradient(180deg,#ffffff,#34d399)';
            dot.style.boxShadow = 'none';
            syncText.textContent = 'همگام‌سازی انجام شده';
            syncLine.style.display = 'block';
          }
        } catch(e) { console.warn('applyStatus failed', e); }
      }

  // initial apply derived from online/pending uploads
  try { applyStatus({ online: navigator.onLine, syncing: false }); } catch(_){ }
  // listen for connectivity or pending changes
  window.addEventListener('online', ()=>{ try { applyStatus({ online: true, syncing: false }); } catch(_){} });
  window.addEventListener('offline', ()=>{ try { applyStatus({ online: false, syncing: false }); } catch(_){} });
  window.addEventListener('storage', (ev) => { try { if (!ev.key || ev.key === 'backup:pendingUploads') applyStatus({ online: navigator.onLine, syncing: false }); } catch(_){} });
    } catch(e) { console.debug('sync status wiring skipped', e); }
  })();

  // Wire up profile edit inputs and buttons
  try {
    const saveBtn = document.getElementById('saveProfileBtn');
    if (saveBtn) saveBtn.addEventListener('click', async function(){
      try { if (typeof saveProfile === 'function') await saveProfile(); } catch(e){ console.warn('saveProfile failed', e); }
    });

    const backupBtn = document.getElementById('backupNowBtn');
    if (backupBtn) backupBtn.addEventListener('click', async function(){
      try { if (typeof backupNow === 'function') await backupNow(); } catch(e){ console.warn('backupNow failed', e); }
    });
  } catch(e){ console.warn('profile edit wiring failed', e); }

  // Edit profile toggle: show the edit box and ensure fields are populated
  try {
    const editToggle = document.getElementById('editProfileToggle');
    if (editToggle) editToggle.addEventListener('click', async function(){
      try {
        const pe = document.getElementById('profileEditBox');
        if (!pe) { console.debug('edit toggle clicked but #profileEditBox not found'); return; }
        const curr = window.getComputedStyle(pe).display;
        console.debug('edit toggle clicked; current display:', curr);
        if (curr === 'none' || curr === '') {
          // open — apply robust inline styles to ensure visibility
          pe.style.display = 'block';
          try {
            pe.style.visibility = 'visible'; pe.style.opacity = '1'; pe.style.zIndex = '9999';
            if (!document.getElementById('forceOpenProfileEditStyle')) {
              const s = document.createElement('style');
              s.id = 'forceOpenProfileEditStyle';
              s.textContent = '#profileEditBox.force-open{ display:block !important; visibility:visible !important; opacity:1 !important; z-index:9999 !important; position:relative !important; }';
              (document.head || document.documentElement).appendChild(s);
            }
            pe.classList.add('force-open');
            try {
              // temporary highlight to make the box obvious during debugging
              pe.style.outline = '3px solid rgba(220,20,60,0.9)';
              pe.style.boxShadow = '0 8px 24px rgba(0,0,0,0.2)';
              const prevBg = pe.style.backgroundColor;
              pe.style.backgroundColor = 'rgba(255,250,240,0.95)';
              setTimeout(()=>{
                try { pe.style.outline = ''; pe.style.boxShadow = ''; pe.style.backgroundColor = prevBg; } catch(_){ }
              }, 4000);
            } catch(_){ }
          } catch(_){ }
          try { if (typeof window.loadProfile === 'function') await window.loadProfile(); } catch(e){ console.warn('loadProfile on edit toggle failed', e); }
          // prefetch and populate the edit form fields from DB/auth so the user sees current values
          try { if (typeof openEditProfile === 'function') await openEditProfile(); } catch(e) { console.warn('openEditProfile prefetch failed', e); }
          try { const rect = pe.getBoundingClientRect(); console.debug('profileEditBox rect after open:', rect); } catch(_){ }
          try { pe.scrollIntoView({behavior:'smooth', block:'start'}); } catch(_){ }
          try { setTimeout(()=>{ const f = document.getElementById('profileFirst'); if (f) f.focus(); }, 120); } catch(_){ }
          console.debug('profileEditBox opened');
        } else {
          // close
          try { pe.style.display = 'none'; pe.style.visibility = 'hidden'; pe.classList.remove('force-open'); } catch(_){ }
          console.debug('profileEditBox closed');
        }
      } catch(e) { console.warn('edit toggle handler failed', e); }
    });
  } catch(e){ console.warn('editProfileToggle wiring failed', e); }

  // Logout wiring
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) logoutBtn.addEventListener('click', async function(){
    try {
      const client = getSupabaseClient();
      if (!client) return;
      await client.auth.signOut();
    } catch (e) { console.warn('Logout failed', e); }
  // ensure edit box closed, then hide profile and show auth forms again (preserve account card structure)
  try { const pe = document.getElementById('profileEditBox'); if (pe) pe.style.display = 'none'; } catch(_){ }
  try { document.getElementById('accountProfileContainer').style.display = 'none'; } catch(_){ }
    try { if (typeof window.showAuthForms === 'function') window.showAuthForms(true); else { const eb = document.getElementById('embeddedAuthBox'); if (eb) eb.style.display = 'block'; } } catch(_){ }
    try { showView('account'); } catch(_){ }
  });

  // initial status and robust client detection
  function getSupabaseClient(){
    try {
      const candidates = [window.supabase, window.supabaseClient, window.SUPABASE_CLIENT, window._supabase, window.__supabase, window.sb, window.sbClient];
      for (let c of candidates) if (c && c.auth && typeof c.auth.signInWithPassword === 'function') return c;
      return null;
    } catch(e){ return null; }
  }

  setEmbeddedStatus(!!getSupabaseClient());

  // Helper: safely obtain current authenticated user's id
  // Returns { userId, user } or null if not available. Logs a debug warning when missing.
  async function getCurrentUserId() {
    try {
      const client = getSupabaseClient();
      if (!client || !client.auth || typeof client.auth.getUser !== 'function') {
        console.debug('getCurrentUserId: Supabase client not ready');
        return { userId: null, user: null };
      }
      const { data: { user } = {} } = await client.auth.getUser();
      const userId = user && user.id ? user.id : null;
      if (!userId) console.warn('Skipped profile/user-scoped query: no userId available');
      return { userId, user };
    } catch (e) {
      console.warn('getCurrentUserId failed', e);
      return { userId: null, user: null };
    }
  }

  // Debug helper: returns userId or null and logs which caller skipped
  async function debugCheckUserGuard(context) {
    try {
      const { userId } = await getCurrentUserId();
      if (!userId) console.warn(`Skipped user-scoped query (${context}): no userId`);
      return userId;
    } catch (e) { console.warn('debugCheckUserGuard failed', e); return null; }
  }

  // try to update later if client is created after script parse
  let tries = 0;
  const statusInterval = setInterval(()=>{
    if (getSupabaseClient()) { setEmbeddedStatus(true); clearInterval(statusInterval); }
    tries++; if (tries > 50) { setEmbeddedStatus(false); clearInterval(statusInterval); }
  }, 200);

})();
/* Image Helper */
function imageFileToDataURL(file, maxKB) {
  return new Promise((resolve, reject) => {
    try {
      let fr = new FileReader();
      fr.onload = (e) => {
        let img = new Image();
        img.onload = () => {
          let MAX_WIDTH = 800;
          let w = img.width, h = img.height;
          if (w > MAX_WIDTH) { h = Math.round(h * (MAX_WIDTH / w)); w = MAX_WIDTH; }
          let canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          let ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          let quality = 0.8;
          let data = canvas.toDataURL('image/jpeg', quality);
          while ((data.length / 1024) > (maxKB || 500) && quality > 0.3) {
            quality -= 0.1;
            data = canvas.toDataURL('image/jpeg', quality);
          }
          resolve(data);
        };
        img.onerror = () => reject(new Error('invalid image'));
        img.src = e.target.result;
      };
      fr.onerror = () => reject(new Error('file read error'));
      fr.readAsDataURL(file);
    } catch (err) { reject(err); }
  });
}

/* ================================================================
  SECTION: Keep auth state across refresh
  - listens for Supabase auth state changes and restores UI
  - on load, tries to get current user and call loadProfile
  ================================================================ */
(function(){
  // Expose a global getSupabaseClient if not already present (used by saveProfile/backupNow)
  if (typeof window.getSupabaseClient !== 'function') {
    window.getSupabaseClient = function(){
      try {
        const candidates = [window.supabase, window.supabaseClient, window.SUPABASE_CLIENT, window._supabase, window.__supabase, window.sb, window.sbClient];
        for (let c of candidates) if (c && c.auth && typeof c.auth.signInWithPassword === 'function') return c;
        return null;
      } catch(e){ return null; }
    };
  }

  // Helper to hide/show only the auth forms (leave account/profile area visible)
  if (typeof window.showAuthForms !== 'function') {
    window.showAuthForms = function(show){
      try {
        const eb = document.getElementById('embeddedAuthBox'); if (!eb) return;
        const formContainer = eb.querySelector('.auth-form-container');
        const welcome = eb.querySelector('.auth-welcome');
        const tabs = eb.querySelector('.form-tabs');
        if (formContainer) formContainer.style.display = show ? '' : 'none';
        if (welcome) welcome.style.display = show ? '' : 'none';
        if (tabs) tabs.style.display = show ? '' : 'none';
      } catch(e){ /* ignore */ }
    };
  }
  function getClient(){
    try { return (window.supabase && typeof window.supabase.auth !== 'undefined') ? window.supabase : null; } catch(e){ return null; }
  }
  async function restore(){
    const client = getClient();
    const dbg = document.getElementById('authDebug');
    if (!client) {
      if (dbg) { dbg.innerHTML = '<span class="auth-event">خطا:</span><span class="auth-msg">کلاینت Supabase پیدا نشد (library ممکن است بارگذاری نشده باشد)</span>'; dbg.classList.add('auth-error'); }
      return;
    }
    try {
      const { data } = await client.auth.getSession();
      const session = data && data.session;
      if (session && session.user) {
        if (dbg) { /* hide the auth debug UI once signed in - show only on errors or signed-out */ dbg.style.display = 'none'; dbg.classList.remove('auth-error'); dbg.classList.add('signed-in'); }
        try { if (typeof window.showAuthForms === 'function') window.showAuthForms(false); else { const eb = document.getElementById('embeddedAuthBox'); if (eb) eb.style.display = 'none'; } } catch(_){ }
  try { await window.loadProfile(session.user); /* no persistent debug message needed here */ } catch(e){ console.warn('restore loadProfile failed', e); if (dbg) dbg.textContent = 'پروفایل یافت نشد (خطا در loadProfile)'; }

        // After successful login/profile load: if local app state is empty, offer to restore the latest shared backup
        try {
          const key = (typeof STORAGE_KEY !== 'undefined') ? STORAGE_KEY : 'vb_dashboard_v8';
          const raw = localStorage.getItem(key);
          const isEmptyLocal = !(raw && raw.length > 10);
          // If local is empty and backupSync provides restoreFromLatest, ask the user whether to import
          if (isEmptyLocal && window.backupSync && typeof window.backupSync.restoreFromLatest === 'function') {
            // Avoid prompting during initial signup flows where UI intentionally hides backup buttons
            // Use a confirm dialog to ask the user — non-blocking fallback if window.confirm unavailable
            let accept = false;
            try {
              accept = confirm('به نظر می‌رسد داده‌های محلی شما خالی است. آیا می‌خواهید آخرین بک‌آپ گروهی را وارد کنید؟ (در غیر این صورت ادامه با داده‌های محلی فعلی)');
            } catch(e) { accept = false; }
            if (accept) {
              try {
                if (dbg) dbg.textContent = 'در حال بازیابی آخرین بک‌آپ...';
                await window.backupSync.restoreFromLatest();
                // render or reload UI to pick up restored data
                try { if (typeof renderAll === 'function') renderAll(); else window.location.reload(); } catch(_){ window.location.reload(); }
                return; // restored and reloaded
              } catch(err) {
                console.warn('restoreFromLatest failed', err);
                try { alert('بازیابی از بک‌آپ ناموفق بود، ادامه با داده محلی'); } catch(_){ }
              }
            } else {
              // user declined; ensure backup buttons are enabled so they can create/import manually
              try { if (typeof enableBackupButtons === 'function') enableBackupButtons(true); } catch(_){ }
            }
          }
        } catch(e) { console.debug('post-login restore prompt failed', e); }
      } else {
        if (dbg) { dbg.innerHTML = `<span class="auth-event">سشن معتبر نیست</span><span class="auth-msg">نمایش فرم لاگین</span>`; dbg.classList.remove('signed-in','auth-error'); }
        try { if (typeof window.showAuthForms === 'function') window.showAuthForms(true); else { const eb = document.getElementById('embeddedAuthBox'); if (eb) eb.style.display = 'block'; } } catch(_){ }
      }
    } catch(e){ console.debug('auth restore failed', e); if (dbg) dbg.textContent = 'خطا هنگام بررسی سشن'; }
  }
  // add onAuthStateChange if available
  const client = getClient();
  if (client && typeof client.auth.onAuthStateChange === 'function') {
    client.auth.onAuthStateChange((event, session) => {
      const dbg = document.getElementById('authDebug');
      if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
        if (dbg) { /* hide debug line when signed in */ dbg.style.display = 'none'; dbg.classList.remove('auth-error'); dbg.classList.add('signed-in'); }
        try { if (typeof window.showAuthForms === 'function') window.showAuthForms(false); else { const eb = document.getElementById('embeddedAuthBox'); if (eb) eb.style.display = 'none'; } } catch(_){ }
  try { if (session && session.user) window.loadProfile(session.user); else window.loadProfile(); /* removed non-essential profile-loaded message */ } catch(e){ console.warn('onAuth loadProfile_failed', e); if (dbg) dbg.textContent = 'خطا در بارگذاری پروفایل پس از رویداد'; }
      } else if (event === 'SIGNED_OUT') {
        if (dbg) { dbg.innerHTML = `<span class="auth-event">رویداد: SIGNED_OUT</span><span class="auth-msg">نمایش فرم لاگین</span>`; dbg.classList.remove('signed-in'); dbg.style.display = 'block'; }
        try { document.getElementById('accountProfileContainer').style.display = 'none'; } catch(_){ }
        try { if (typeof window.showAuthForms === 'function') window.showAuthForms(true); else { const eb = document.getElementById('embeddedAuthBox'); if (eb) eb.style.display = 'block'; } } catch(_){ }
      }
    });
  }
  // try restore on next tick (allow client init)
  setTimeout(restore, 600);
  // also attempt again after a short interval in case client loads later
  let tries = 0; const id = setInterval(()=>{ tries++; if (getClient()) { clearInterval(id); restore(); } if (tries>10) clearInterval(id); }, 400);
})();

    /* Save profile to Supabase and create backups */
    async function saveProfile() {
      try {
        const client = getSupabaseClient();
        if (!client) throw new Error('Supabase client not ready');
        const { data: userData } = await client.auth.getUser();
        const user = userData?.user; if (!user) throw new Error('Not signed in');
        const first_name = (document.getElementById('profileFirst') && document.getElementById('profileFirst').value) || '';
        const last_name = (document.getElementById('profileLast') && document.getElementById('profileLast').value) || '';
  // prefer the authenticated user's email to avoid accidental overwrites
  const emailField = (document.getElementById('profileEmail') && document.getElementById('profileEmail').value) || '';
  const email = user.email || emailField || '';
        const phone_number = (document.getElementById('profilePhone') && document.getElementById('profilePhone').value) || '';
  const avatar_el = document.getElementById('accountAvatar');
  const avatar_url = (avatar_el && avatar_el.src) ? avatar_el.src : null;
  const bio = (document.getElementById('profileBio') && document.getElementById('profileBio').value) || '';

        const payload = { 
          id: user.id,
          display_name: document.getElementById('profileDisplayName').value || '',
          phone_number, 
          email,
          avatar_url,
          bio,
          updated_at: new Date().toISOString()
        };
        // safer flow: try to find existing profile by user id
        let saved = null;
        try {
              if (!user || !user.id) throw new Error('Not signed in');
              const { data: byId } = await client.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
              if (byId) {
                const { data: updated, error: updateErr } = await client.from('profiles').update(payload).eq('user_id', user.id).select().maybeSingle();
                if (updateErr) throw updateErr;
                saved = updated;
              } else {
                // check by email then update/insert accordingly
                const { data: byEmail } = await client.from('profiles').select('*').eq('email', email).maybeSingle();
                if (byEmail) {
                  const upObj = Object.assign({}, payload, { user_id: user.id });
                  const { data: updated, error: updateErr } = await client.from('profiles').update(upObj).eq('email', email).select().maybeSingle();
                  if (updateErr) throw updateErr;
                  saved = updated;
                } else {
                  const { data: inserted, error: insertErr } = await client.from('profiles').insert(payload).select().maybeSingle();
                  if (insertErr) throw insertErr;
                  saved = inserted;
                }
              }
        } catch (dbErr) {
          console.error('saveProfile DB error', dbErr);
          try { const msg = document.getElementById('profileMsg'); if (msg) msg.textContent = 'خطا در ذخیره پروفایل'; } catch(_){ }
          throw dbErr;
        }
            // update UI from saved record
            try { document.getElementById('accountName').textContent = (saved && saved.display_name) ? saved.display_name : (payload.display_name || email); } catch(_){ }
            try { if (saved && saved.avatar_url) document.getElementById('accountAvatar').src = saved.avatar_url; else if (avatar_url) document.getElementById('accountAvatar').src = avatar_url; } catch(_){ }
            try { document.getElementById('accountPhone').textContent = (saved && saved.phone_number) ? saved.phone_number : (phone_number || ''); } catch(_){ }
            try { const msg = document.getElementById('profileMsg'); if (msg) { msg.textContent = 'پروفایل ذخیره شد'; setTimeout(()=>{ msg.textContent = ''; }, 2500); } } catch(_){ }

            // ensure backup buttons only called if the helper exists
            try { if (typeof enableBackupButtons === 'function') enableBackupButtons(true); } catch(_){}

            // Refresh profile to be safe and to avoid stale data across users
            try { await loadProfile(); } catch(e) { console.debug('post-save loadProfile failed', e); }
            return saved;
      } catch (e) {
        console.error('saveProfile error', e);
        try { const msg = document.getElementById('profileMsg'); if (msg) msg.textContent = 'خطا در ذخیره پروفایل'; } catch(_){}
        throw e;
      }
    }

    async function backupNow() {
      // helper to toggle spinner on backup button
      function setBackupButtonLoading(on) {
        try {
          const btn = document.getElementById('backupNowBtn');
          const spinner = document.getElementById('backupNowSpinner');
          const textEl = document.getElementById('backupNowText');
          if (btn) btn.disabled = !!on;
          if (btn) btn.style.opacity = on ? '0.7' : '';
          if (spinner) spinner.style.display = on ? 'inline-block' : 'none';
          if (textEl) textEl.textContent = on ? 'در حال بک‌آپ گیری...' : 'ایجاد بک‌آپ جدید';
        } catch(e) {}
      }
      setBackupButtonLoading(true);
      try {
        const client = getSupabaseClient(); if (!client) throw new Error('Supabase client not ready');
        const { data: userData } = await client.auth.getUser(); const user = userData?.user;
        if (!user) {
          // Not signed in: skip remote backups. Keep local save behavior only.
          console.debug('backupNow: user not signed in — skipping remote backup');
          try { updateSyncStatusUI && updateSyncStatusUI('default', 'محلی'); } catch(_){}
          return null;
        }
        // snapshot the entire app state (players, coaches, sessions, payments, etc.)
        // `state` is the in-memory app state persisted to localStorage
        let snapshot = JSON.parse(JSON.stringify(window.state || {}));
        // if snapshot is empty, try to read saved localStorage state
        try {
          const isEmpty = Object.keys(snapshot).length === 0;
          if (isEmpty && typeof STORAGE_KEY !== 'undefined') {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
              try { snapshot = JSON.parse(raw); } catch(_){}
            }
          }
        } catch(e) { /* ignore */ }
        // If snapshot is empty, ensure at least a minimal profiles snapshot so shared_backups isn't an empty object
        try {
          if (!snapshot || Object.keys(snapshot).length === 0) {
            const em = (profile && profile.email) ? profile.email : (user.email || null);
            snapshot = { profiles: [ { id: user.id, email: em } ] };
          }
        } catch(_){ }
        // Safer flow: attempt to update an existing backup row, otherwise insert a new one.
        const deviceId = getDeviceId();
        const deviceName = getDeviceName();
        const nowIso = new Date().toISOString();
        // New flow: delegate to the backupSync module which handles snapshot->storage->backups metadata->mark_shared_backup
        let resData = null;
        try {
          if (window.backupSync && typeof window.backupSync.createBackup === 'function') {
            // set group email if we have a profile email
            try {
              const email = (profile && profile.email) ? profile.email : (user.email || null);
              if (email) window.backupSync.setGroupEmail(email.toLowerCase());
            } catch(_){ }
            const r = await window.backupSync.createBackup({ revision: 1 });
            resData = r;
          } else {
            // backupSync not ready yet: persist a small pending flag locally and queue an attempt
            const pendingKey = 'backup:pendingLocalSnapshot';
            try { localStorage.setItem(pendingKey, JSON.stringify({ ts: Date.now(), snapshot })); } catch(_){ }
            resData = { ok: 'pending-local' };
          }
        } catch (e) {
          console.debug('backupSync.createBackup failed, falling back to pending local save', e);
          const pendingKey = 'backup:pendingLocalSnapshot';
          try { localStorage.setItem(pendingKey, JSON.stringify({ ts: Date.now(), snapshot })); } catch(_){ }
          resData = { ok: 'pending-local' };
        }

        // shared_backups/profile last_sync handling is now owned by server via mark_shared_backup RPC invoked by backupSync
        // Nothing further to do here; backupSync.createBackup will call mark_shared_backup when appropriate.
        try { updateSyncStatusUI('ok', new Date(nowIso).toLocaleString() + ' • ' + deviceName); } catch(_){ }
        return resData;
        } catch (e) {
        console.error('backupNow error', e);
        try { updateSyncStatusUI('default', 'اتصال برقرار نیست یا خطا — مجدداً تلاش کنید'); } catch(_){ }
        throw e;
      } finally {
        try { 
          setBackupButtonLoading(false);
          const backupProgressContainer = document.getElementById('backupProgressContainer');
          if (backupProgressContainer) backupProgressContainer.style.display = 'none';
        } catch(_){}
      }
    }

  // Toggle edit profile box from account card
  (function(){
    try {
      const toggle = document.getElementById('editProfileToggle');
      if (toggle) toggle.addEventListener('click', async function(){
        try {
          const pe = document.getElementById('profileEditBox');
          if (!pe) { console.debug('edit toggle clicked but #profileEditBox not found'); return; }
          const curr = window.getComputedStyle(pe).display;
          if (curr === 'none' || curr === '') {
            pe.style.display = 'block';
            try { if (typeof window.loadProfile === 'function') await window.loadProfile(); } catch(e){ console.warn('loadProfile on edit toggle failed', e); }
            try { pe.scrollIntoView({behavior:'smooth', block:'start'}); } catch(_){ }
          } else {
            pe.style.display = 'none';
          }
        } catch(e){ console.warn('toggle edit failed', e); }
      });
    } catch(e) { /* ignore */ }
  })();

  /* ImageKit integration (client-side) ----------------------------------
    Using ImageKit.io for image hosting. You must provide an authentication
    endpoint on your server that returns a token for uploads (see ImageKit docs).
    Minimal client setup below uses the provided publicKey and urlEndpoint.
  */
  // load ImageKit script dynamically if not present
  (function(){
    try {
      if (typeof ImageKit === 'undefined') {
        const s = document.createElement('script');
        s.src = 'https://unpkg.com/imagekit-javascript/dist/imagekit.min.js';
        s.async = true;
        (document.head || document.body).appendChild(s);
      }
    } catch(e){}
  })();

  // Initialize ImageKit instance (use your public key & endpoint)
  let __imagekit = null;
  function initImageKit() {
    try {
      if (typeof ImageKit === 'undefined') return;
      if (__imagekit) return __imagekit;
      __imagekit = new ImageKit({
        publicKey: 'public_z44cHiHVzvCvDlKJNtfsCiHg+MY=',
        urlEndpoint: 'https://ik.imagekit.io/vviiiq5g29',
        authenticationEndpoint: '/imagekit-auth' // replace with your server auth path
      });
      return __imagekit;
    } catch(e){ console.warn('initImageKit failed', e); }
  }

  // Note: module uploader (fileInput/uploadBtn) is used instead of the older inline uploader.

// toggleAuthBtn removed per user request; no-op placeholder left intentionally

    /* ================================================================
  SECTION: State & Persistence
  - localStorage key, state object, load/save, seeding
  ================================================================ */
/* Storage & State */
const STORAGE_KEY = 'vb_dashboard_v8'; // بروزرسانی نسخه
let state = { players: [], coaches: [], sessions: [], payments: [], settings: { title: 'مدیریت باشگاه والیبال', logo: 'https://www.transparentpng.com/thumb/volleyball/2esoDe-volleyball-transparent-background.png', style: 'modern', lastCategoryUpdate: '11 دی 1403', ranks: null, ranksReferenceDate: null } };
// competitions storage
state.competitions = state.competitions || [];
// currently selected date filter for matches (YYYY/MM/DD)
let selectedMatchesDate = null;
let customStoragePath = null;

function loadState() {
  try {
    let raw = localStorage.getItem(STORAGE_KEY);
    if (raw) state = JSON.parse(raw);
    else seedSample();
    state.user = state.user || {loggedIn: false}; // خط جدید
  } catch (e) {
    console.error(e);
    seedSample();
    state.user = state.user || {loggedIn: false}; // خط جدید برای حالت خطا
  }

  // بروزرسانی اتومات رده‌ها
  state.players.forEach(p => {
    if (p.birthdate) {
      let age = calcExactAge(p.birthdate);
      p.category = determineCategory(age);
    }
    if (!p.events) p.events = [];
  });
  // بروزرسانی تاریخ آخرین آپدیت رده‌ها
  let todayParts = todayJalali().split('/').map(Number);
  let updateYear = parseInt(state.settings.lastCategoryUpdate.split(' ')[2] || '1403');
  if (todayParts[1] > 10 || (todayParts[1] === 10 && todayParts[2] >= 11)) {
    if (updateYear < todayParts[0]) {
      state.settings.lastCategoryUpdate = `11 دی ${todayParts[0]}`;
    }
  } else {
    if (updateYear < todayParts[0] - 1) {
      state.settings.lastCategoryUpdate = `11 دی ${todayParts[0] - 1}`;
    }
  }
  saveState();
}

function logSampleCategories() {
  try {
    console.group('Sample players categories');
    (state.players || []).forEach(p => {
      const cat = p.birthdate ? determineCategory(Object.assign(calcExactAge(p.birthdate), { birthdate: p.birthdate })) : (p.category || '—');
      console.log(p.name + ' — birth: ' + (p.birthdate || '—') + ' — category: ' + cat);
    });
    console.groupEnd();
  } catch(e){ console.warn('logSampleCategories failed', e); }
}

// call logger after seeding (useful on first load)
try { if (!localStorage.getItem(STORAGE_KEY)) { logSampleCategories(); } } catch(e){}
function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  // also attempt to store an online backup of the current profile/state
  try {
    if (typeof backupNow === 'function') {
      // fire-and-forget; update UI status on completion inside backupNow
      backupNow().catch(e => { console.warn('background backup failed', e); });
    }
  } catch(e){ console.debug('backup call from saveState failed', e); }
}
function seedSample() {
  state.players = [];
  state.coaches = [];
  state.sessions = [];
  state.payments = [];
  state.settings = { title: 'مدیریت باشگاه والیبال', logo: 'https://www.transparentpng.com/thumb/volleyball/2esoDe-volleyball-transparent-background.png', style: 'modern', lastCategoryUpdate: '11 دی 1403', ranks: null, ranksReferenceDate: null };
  let now = Date.now();
  // sample players covering each rank (male)
  state.players.push({ id: uid('p'), name: 'آریا کوچک', birthdate: '1394/01/15', joinDate: todayJalali(), category: '', favoritePosition: 'OH', phone: '09120001011', fatherName: 'لیلا', nationalCode: '1000000001', photo: '', height: 140, weight: 35, insuranceDate: todayJalali(), scores: {}, createdAt: new Date(now - 950000).toISOString(), events: [] });
  state.players.push({ id: uid('p'), name: 'بهرام نور', birthdate: '1390/05/10', joinDate: todayJalali(), category: '', favoritePosition: 'L', phone: '09120001012', fatherName: 'حمید', nationalCode: '1000000002', photo: '', height: 150, weight: 45, insuranceDate: todayJalali(), scores: {}, createdAt: new Date(now - 900000).toISOString(), events: [] });
  state.players.push({ id: uid('p'), name: 'پویان کریمی', birthdate: '1389/07/10', joinDate: todayJalali(), category: '', favoritePosition: 'MB', phone: '09120001013', fatherName: 'کریم', nationalCode: '1000000003', photo: '', height: 160, weight: 50, insuranceDate: todayJalali(), scores: {}, createdAt: new Date(now - 850000).toISOString(), events: [] });
  state.players.push({ id: uid('p'), name: 'تندیس رحیمی', birthdate: '1387/03/20', joinDate: todayJalali(), category: '', favoritePosition: 'OH', phone: '09120001014', fatherName: 'رحیم', nationalCode: '1000000004', photo: '', height: 170, weight: 60, insuranceDate: todayJalali(), scores: {}, createdAt: new Date(now - 800000).toISOString(), events: [] });
  state.players.push({ id: uid('p'), name: 'جواد ملکی', birthdate: '1385/11/01', joinDate: todayJalali(), category: '', favoritePosition: 'ST', phone: '09120001015', fatherName: 'ملک', nationalCode: '1000000005', photo: '', height: 180, weight: 70, insuranceDate: todayJalali(), scores: {}, createdAt: new Date(now - 750000).toISOString(), events: [] });
  state.players.push({ id: uid('p'), name: 'حسین صالحی', birthdate: '1382/08/25', joinDate: todayJalali(), category: '', favoritePosition: 'MB', phone: '09120001016', fatherName: 'صالح', nationalCode: '1000000006', photo: '', height: 185, weight: 80, insuranceDate: todayJalali(), scores: {}, createdAt: new Date(now - 700000).toISOString(), events: [] });
  state.players.push({ id: uid('p'), name: 'داریوش مرندی', birthdate: '1378/04/10', joinDate: todayJalali(), category: '', favoritePosition: 'L', phone: '09120001017', fatherName: 'مهران', nationalCode: '1000000007', photo: '', height: 190, weight: 85, insuranceDate: todayJalali(), scores: {}, createdAt: new Date(now - 650000).toISOString(), events: [] });

  // default rank definitions (editable in Rank Editor). Each item: { id, name, minAgeYears, maxAgeYears, startDateJ }
  // startDateJ (optional) allows specifying a Jalali date from which this category applies (manual override per user request)
  state.settings.ranks = state.settings.ranks || [
    { id: 'mini', name: 'مینی والیبال', minAgeYears: 0, maxAgeYears: 12, startDateJ: '' },
    { id: 'noonahal', name: 'نونهالان', minAgeYears: 13, maxAgeYears: 14, startDateJ: '' },
    { id: 'nojavanan', name: 'نوجوانان', minAgeYears: 15, maxAgeYears: 16, startDateJ: '' },
    { id: 'nojavanan_boghr', name: 'نوجوانان بزرگ', minAgeYears: 17, maxAgeYears: 18, startDateJ: '' },
    { id: 'javan', name: 'جوانان', minAgeYears: 19, maxAgeYears: 20, startDateJ: '' },
    { id: 'omid', name: 'امیدها', minAgeYears: 21, maxAgeYears: 22, startDateJ: '' },
    { id: 'adult', name: 'بزرگسالان', minAgeYears: 23, maxAgeYears: 200, startDateJ: '' }
  ];
  state.settings.ranksReferenceDate = state.settings.ranksReferenceDate || state.settings.lastCategoryUpdate || todayJalali();
  state.coaches.push({
    id: uid('c'), name: 'محمد محمدی', title: 'مربی اصلی', phone: '09120000010', photo: '', createdAt: new Date(now - 600000).toISOString()
  });
  // نمونهٔ برنامه‌های تمرین (notes)
  state.trainingPlans = [];
  state.sessions.push({
    id: uid('s'), title: 'جلسه تمرینی', date: jalaliToISO(todayJalali()), category: 'جوانان', coachId: state.coaches[0].id,
    attendances: { [state.players[0].id]: { present: true, reason: '' }, [state.players[1].id]: { present: false, reason: 'بیمار' } },
    createdAt: new Date(now - 500000).toISOString()
  });
  state.payments.push({
    id: uid('pay'), playerId: state.players[0].id, date: jalaliToISO(todayJalali()), amount: 500000, paymentMonth: 'فروردین', paymentYear: '1403', type: 'نقد',
    createdAt: new Date(now - 400000).toISOString()
  });
  saveState();
}

// seed sample competitions if none
function ensureCompetitionsSeed() {
  state.competitions = state.competitions || [];
  if (state.competitions.length === 0) {
    const nowJ = todayJalali();
    state.competitions.push({ id: uid('m'), teamA: 'تیم الف', teamB: 'تیم ب', scoreA: 2, scoreB: 1, date: nowJ, time: '18:30', kind: 'tournament', title: 'تورنمنت تابستانه', status: 'finished', venue: 'ورزشگاه مرکزی', sets: [[25,20],[22,25],[15,13]] });
    // future match
    let future = addDaysJalali(nowJ, 7);
    state.competitions.push({ id: uid('m'), teamA: 'تیم ج', teamB: 'تیم د', scoreA: null, scoreB: null, date: future, time: '16:00', kind: 'friendly', title: 'دوستی دوستانه', status: 'scheduled', venue: '' });
    saveState();
  }
}

function renderCompetitionsPage() {
  ensureCompetitionsSeed();
  // (team filter removed) keep teams available in state if needed later
  // set count and list
  renderMatchesList();
  // wire tab clicks
  qsa('#matchesTabs button').forEach(b => b.addEventListener('click', (e)=>{
    qsa('#matchesTabs button').forEach(x=>x.classList.remove('active'));
    e.currentTarget.classList.add('active');
    renderMatchesList();
  }));

  // Robust bindings: clone visible nodes and attach event listeners directly
  const bindClickOnce = (sel, handler) => {
    const el = qs(sel);
    if (!el) return console.warn('Missing element for binding:', sel);
    try {
      const n = el.cloneNode(true);
      el.parentNode.replaceChild(n, el);
      // attach click and pointerdown as fallback
      n.addEventListener('click', (ev)=>{ console.debug('bindClickOnce click:', sel); handler(ev); }, false);
      n.addEventListener('pointerdown', (ev)=>{ console.debug('bindClickOnce pointerdown:', sel); handler(ev); }, { passive: true });
    } catch (e) {
      // fallback
      el.addEventListener('click', (ev)=>{ console.debug('bindClickOnce fallback click:', sel); handler(ev); }, false);
      el.addEventListener('pointerdown', (ev)=>{ console.debug('bindClickOnce fallback pointerdown:', sel); handler(ev); }, { passive: true });
    }
  };

  // FAB: open form
  bindClickOnce('#addMatchFab', () => openMatchForm());
  console.debug('renderCompetitionsPage: bound #addMatchFab');

  // Inline date filter: user can type/paste date or clear quickly
  // store selected date in `selectedMatchesDate` (YYYY/MM/DD) or null
  if (qs('#matchesDateFilter')) {
    const dEl = qs('#matchesDateFilter');
    const newD = dEl.cloneNode(true); dEl.parentNode.replaceChild(newD, dEl);
    newD.addEventListener('input', (e)=>{
      const v = e.currentTarget.value.trim();
      selectedMatchesDate = v === '' ? null : v;
      renderMatchesList();
    }, false);
    // ensure clicking/focusing opens the inline widget
    newD.addEventListener('focus', ()=>{ try { openJalaliCalendarForMatches(); const ev = new Event('click'); newD.dispatchEvent(ev); } catch(e){ console.warn(e); } }, false);
    newD.addEventListener('click', (ev)=>{ try{ openJalaliCalendarForMatches(); ev.stopPropagation(); }catch(e){console.warn(e);} }, false);
  }
  bindClickOnce('#clearMatchesDate', ()=>{
    const inpt = qs('#matchesDateFilter'); if (inpt) { inpt.value = ''; }
    selectedMatchesDate = null; renderMatchesList();
  });

  // back button
  bindClickOnce('#backCompetitions', ()=> showView('home'));

  // Search input: attach input listener directly (not passive)
  const searchEl = qs('#matchesSearch');
  if (searchEl) {
    const newSearch = searchEl.cloneNode(true);
    searchEl.parentNode.replaceChild(newSearch, searchEl);
    newSearch.addEventListener('input', renderMatchesList, false);
  } else console.warn('Search input not found: #matchesSearch');
}

function renderMatchesList() {
  let list = qs('#matchesList'); list.innerHTML = '';
  const active = qs('#matchesTabs button.active')?.dataset.filter || 'all';
  const team = null; const type = null;
  const searchQ = qs('#matchesSearch') ? qs('#matchesSearch').value.trim().toLowerCase() : '';
  let matches = (state.competitions || []).slice().sort((a,b)=> new Date(jalaliToISO(a.date)) - new Date(jalaliToISO(b.date)) );
  matches = matches.filter(m=>{
    if (active === 'scheduled' && m.status !== 'scheduled') return false;
    if (active === 'finished' && m.status !== 'finished') return false;
  // only 'all', 'scheduled', 'finished' are supported tabs now
    if (selectedMatchesDate && m.date !== selectedMatchesDate) return false;
    if (searchQ) {
      const hay = ((m.teamA||'') + ' ' + (m.teamB||'') + ' ' + (m.title||'') + ' ' + (m.date||'')).toLowerCase();
      if (!hay.includes(searchQ)) return false;
    }
    return true;
  });
  qs('#matchesCount').textContent = matches.length;
  if (matches.length === 0) { list.innerHTML = '<div class="muted">هیچ مسابقه‌ای یافت نشد</div>'; return; }
  // (design placeholder removed) -- only real matches will be listed
  matches.forEach(m=>{
    let card = document.createElement('div'); card.className = 'match-card';
    // compute display score
    let displayScore = '';
    if (m.status === 'scheduled') displayScore = 'VS';
    else if (Array.isArray(m.sets) && m.sets.length>0) {
      let aWins = 0, bWins = 0; m.sets.forEach(s=>{ const a=s[0]||0, b=s[1]||0; if (a>b) aWins++; if (b>a) bWins++; });
      displayScore = `${aWins} - ${bWins}`;
    } else if (m.scoreA==null || m.scoreB==null) displayScore = '-';
    else displayScore = `${escapeHtml(String(m.scoreA))} - ${escapeHtml(String(m.scoreB))}`;
    const logoA = escapeHtml(m.logoA || (state.settings && state.settings.logo) || 'icons/volleyball (1).png');
    const logoB = escapeHtml(m.logoB || '');
    card.innerHTML = `
      <div style="flex:1;display:flex;flex-direction:column;gap:8px;">
        <div class="row-top" style="display:flex;justify-content:space-between;align-items:center;">
          <div class="team-name" style="text-align:right;flex:1;display:flex;align-items:center;gap:8px;justify-content:flex-end">${escapeHtml(m.teamA)}<img src="${logoA}" alt="logoA" style="width:36px;height:36px;border-radius:6px;object-fit:contain"/></div>
          <div class="score" style="min-width:60px;text-align:center">${displayScore}</div>
          <div class="team-name" style="text-align:left;flex:1;display:flex;align-items:center;gap:8px"><img src="${logoB || 'icons/volleyball (1).png'}" alt="logoB" style="width:36px;height:36px;border-radius:6px;object-fit:contain"/>${escapeHtml(m.teamB)}</div>
        </div>
        <div class="row-mid" style="display:flex;justify-content:center;align-items:center;gap:12px;">
          <div class="match-kind muted-small">${mapKindToPersian(m.kind) || ''}</div>
          <div class="match-status muted-small">${m.status==='finished'?'انجام شده':'برنامه‌ریزی‌شده'}</div>
          <div style="display:flex;gap:6px;align-items:center;">
            <button class="btn small" data-id="${m.id}">جزییات</button>
            <button class="btn small share-btn" data-share-id="${m.id}" title="اشتراک‌گذاری" aria-label="اشتراک‌گذاری">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M16 6l-4-4-4 4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M12 2v13" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </button>
          </div>
        </div>
        <div class="row-bottom" style="display:flex;justify-content:space-between;align-items:center;">
          <div class="muted-small">📅 ${m.date || '-'}</div>
          <div class="muted-small">⏰ ${m.time ? escapeHtml(m.time) : '-'} • ${escapeHtml(m.venue || '-')}</div>
        </div>
      </div>
    `;
  card.querySelector('button[data-id]').addEventListener('click', ()=> openMatchDetail(m.id));
  const shareBtn = card.querySelector('button[data-share-id]');
  if (shareBtn) shareBtn.addEventListener('click', ()=> openShareOverlay(m.id));
    list.appendChild(card);
  });
}

// Delegated handler: ensure share buttons work even if created via innerHTML
// Delegated handler: ensure share buttons work even if created via innerHTML
document.addEventListener('click', function(evt){
  try {
    let el = evt.target;
    while (el && el !== document) {
      if (el.getAttribute && el.getAttribute('data-share-id')) {
        const id = el.getAttribute('data-share-id'); if (!id) return; openShareOverlay(id); return;
      }
      el = el.parentNode;
    }
  } catch (e) { console.warn('delegated share handler error', e); }
});

function openMatchDetail(id) {
  let m = (state.competitions||[]).find(x=>x.id===id);
  if (!m) return alert('مسابقه پیدا نشد');
  let body = qs('#matchDetailBody');
  // build notes/rules/contact from the match object
  const noteLines = [];
  if (m.notes && String(m.notes).trim()) noteLines.push(`یادداشت: ${escapeHtml(m.notes)}`);
  if (m.rules && String(m.rules).trim()) noteLines.push(`قوانین: ${escapeHtml(m.rules)}`);
  if (m.contact && String(m.contact).trim()) noteLines.push(`تماس مسئول: ${escapeHtml(m.contact)}`);
  let notesHtml = noteLines.length ? `<ul style="margin:8px 0 0 0;padding-left:18px;">${noteLines.map(l=>`<li>${l}</li>`).join('')}</ul>` : '';
  // compute display score/hyphen-separated
  let displayScore = '';
  if (m.status === 'scheduled') displayScore = 'VS';
  else if (Array.isArray(m.sets) && m.sets.length>0) { let aWins=0,bWins=0; m.sets.forEach(s=>{const a=s[0]||0,b=s[1]||0; if(a>b) aWins++; if(b>a) bWins++;}); displayScore = `${aWins} - ${bWins}`; }
  else displayScore = (m.scoreA==null||m.scoreB==null) ? '-' : `${escapeHtml(String(m.scoreA))} - ${escapeHtml(String(m.scoreB))}`;
  // build per-set display if available
  let setsHtml = '';
  if (Array.isArray(m.sets) && m.sets.length>0) {
    const parts = m.sets.map((s,idx)=>{
      const a = s[0] == null ? '-' : String(s[0]);
      const b = s[1] == null ? '-' : String(s[1]);
      return `<span class="detail-chip">ست ${idx+1}: ${escapeHtml(a)} - ${escapeHtml(b)}</span>`;
    });
    setsHtml = `<div style="margin-top:8px;">${parts.join(' ')}</div>`;
  }
  const logoA = escapeHtml(m.logoA || (state.settings && state.settings.logo) || 'icons/volleyball (1).png');
  const logoB = escapeHtml(m.logoB || 'icons/volleyball (1).png');
  body.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:8px;">
    <div class="row-top" style="display:flex;justify-content:space-between;align-items:center;">
    <div style="text-align:right;flex:1;display:flex;align-items:center;justify-content:flex-end;gap:8px"><div class="team-name">${escapeHtml(m.teamA)}</div> <img src="${logoA}" style="width:48px;height:48px;object-fit:contain;border-radius:6px"/></div>
  <div style="text-align:center;min-width:80px;font-weight:800">${escapeHtml(String(displayScore))}</div>
    <div style="text-align:left;flex:1;display:flex;align-items:center;gap:8px"><img src="${logoB}" style="width:48px;height:48px;object-fit:contain;border-radius:6px"/> <div class="team-name">${escapeHtml(m.teamB)}</div></div>
  </div>
      <div class="row-mid" style="display:flex;justify-content:center;gap:12px;align-items:center;">
  <div class="match-kind muted-small">${mapKindToPersian(m.kind) || '-'}</div>
        <div class="match-status muted-small">${m.status==='finished' ? 'انجام شده' : 'برنامه‌ریزی‌شده'}</div>
      </div>
      <div class="row-bottom" style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <div><span class="detail-chip">📅 ${m.date || '-'}</span></div>
        <div><span class="detail-chip">⏰ ${m.time ? escapeHtml(m.time) : '-'}</span> <span class="detail-chip">${escapeHtml(m.venue || '-')}</span></div>
      </div>
  <div style="margin-top:8px;">${notesHtml}</div>
  ${setsHtml}
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;"><button id="editMatchBtn" class="btn">ویرایش</button><button id="delMatchBtn" class="btn danger">حذف</button></div>
    </div>
  `;
  console.debug('openMatchDetail: opening detail for', id);
  qs('#matchDetailModal').classList.remove('hide');
  // Create explicit control buttons (close/edit/delete) and attach handlers
  // ensure header close button exists and works
  const headerClose = qs('#closeMatchDetail');
  if (headerClose) {
    try { headerClose.removeEventListener && headerClose.removeEventListener('click', ()=>{}); } catch(e){}
    // Keep existing button content (we set it in HTML). Ensure white color for contrast on red background.
    headerClose.style.color = '#fff';
    headerClose.setAttribute('aria-label', 'بستن');
    headerClose.onclick = () => qs('#matchDetailModal').classList.add('hide');
  }
  // footer buttons: find the container and re-wire buttons
  const footerEdit = qs('#editMatchBtn');
  const footerDel = qs('#delMatchBtn');
  if (footerEdit) {
    footerEdit.onclick = (e) => { e.preventDefault(); console.debug('edit button clicked for', id); qs('#matchDetailModal').classList.add('hide'); openMatchForm(id); };
  }
  if (footerDel) {
    footerDel.onclick = (e) => { e.preventDefault(); if (confirm('حذف شود؟')) { state.competitions = state.competitions.filter(x=>x.id!==id); saveState(); qs('#matchDetailModal').classList.add('hide'); renderMatchesList(); } };
  }
}

function openMatchForm(editId) {
  console.debug('openMatchForm invoked, editId=', editId);
  // new full-page create/edit
  const isEdit = !!editId;
  let obj = isEdit ? JSON.parse(JSON.stringify(state.competitions.find(x=>x.id===editId))) : { id: uid('m'), status: 'scheduled', sets: [] };
  showView('match-edit');
  qs('#matchEditTitle').textContent = isEdit ? 'ویرایش مسابقه' : 'افزودن مسابقه';
  // default team A from club title/logo if creating
  const defaultClub = state.settings && state.settings.title ? state.settings.title : '';
  const defaultLogo = (state.settings && state.settings.logo) ? state.settings.logo : 'icons/volleyball (1).png';
  qs('#formTeamA').value = obj.teamA || defaultClub;
  qs('#formTeamALogo').value = obj.logoA || defaultLogo;
  qs('#formTeamB').value = obj.teamB || '';
  qs('#formTeamBLogo').value = obj.logoB || 'icons/volleyball (1).png';
  qs('#formDate').value = obj.date || todayJalali();
  qs('#formTime').value = obj.time || '';
  // initialize radios for status/type
  try { if (obj.status === 'finished') { const s = qs('#statusFinished'); if (s) s.checked = true; } else { const s = qs('#statusScheduled'); if (s) s.checked = true; } } catch(e){}
  try { const t = (obj.kind||'friendly'); const sel = qs('#type'+ (t.charAt(0).toUpperCase()+t.slice(1)) ); if (sel) sel.checked = true; } catch(e){}
  qs('#formVenue').value = obj.venue || '';
  qs('#formNotes').value = obj.notes || '';
  qs('#formRules').value = obj.rules || '';
  qs('#formContact').value = obj.contact || '';
  // populate sets into static inputs (5 fields)
  const sets = Array.isArray(obj.sets) ? obj.sets : [];
  for (let i=1;i<=5;i++) {
    qs(`#formAset${i}`).value = sets[i-1] ? (sets[i-1][0] ?? '') : '';
    qs(`#formBset${i}`).value = sets[i-1] ? (sets[i-1][1] ?? '') : '';
  }
  // show previews for logos if available
  const showPreview = (imgEl, val) => {
    if (!imgEl) return;
    if (val && val.trim()) { imgEl.src = val; imgEl.style.display = 'block'; }
    else { imgEl.src = defaultLogo; imgEl.style.display = 'block'; }
  };
  // if logo inputs empty, use default club logo for preview
  if (!qs('#formTeamALogo').value || !qs('#formTeamALogo').value.trim()) qs('#formTeamALogo').value = defaultLogo;
  if (!qs('#formTeamBLogo').value || !qs('#formTeamBLogo').value.trim()) qs('#formTeamBLogo').value = defaultLogo;
  showPreview(qs('#formTeamAPreview'), qs('#formTeamALogo').value);
  showPreview(qs('#formTeamBPreview'), qs('#formTeamBLogo').value);

  // --- New: populate hashtag suggestions list from existing competitions ---
  (function populateHashtags(){
    try {
      const list = qs('#hashtagsList'); if (!list) return;
      // collect unique saved hashtags
      const seen = new Set();
      (state.competitions||[]).forEach(c=>{ if (c && c.hashtag) seen.add(c.hashtag); });
      // clear and add
      list.innerHTML = '';
      Array.from(seen).forEach(h => { const opt = document.createElement('option'); opt.value = h; list.appendChild(opt); });
    } catch(e) { console.warn('populateHashtags failed', e); }
  })();

  // wire file inputs to read data URLs and set preview + hidden logo input
  const wireFile = (fileInputId, logoInputId, previewId) => {
    const fi = qs(fileInputId); const li = qs(logoInputId); const pi = qs(previewId);
    if (!fi) return;
    fi.onchange = (ev) => {
      const f = fi.files && fi.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const url = e.target.result;
        if (li) li.value = url;
        if (pi) { pi.src = url; pi.style.display = 'block'; }
      };
      reader.readAsDataURL(f);
    };
  };
  wireFile('#formTeamALogoFile','#formTeamALogo','#formTeamAPreview');
  wireFile('#formTeamBLogoFile','#formTeamBLogo','#formTeamBPreview');

  // compute set totals live
  const computeTotals = () => {
    let aTotal = 0, bTotal = 0;
    for (let i=1;i<=5;i++){
      const aEl = qs(`#formAset${i}`); const bEl = qs(`#formBset${i}`);
      const a = aEl ? String(aEl.value || '').trim() : '';
      const b = bEl ? String(bEl.value || '').trim() : '';
      const an = a === '' ? null : Number(a);
      const bn = b === '' ? null : Number(b);
      if (an != null && bn != null) {
        if (an > bn) aTotal++; else if (bn > an) bTotal++;
      }
    }
    if (qs('#formTeamATotal')) qs('#formTeamATotal').textContent = aTotal || '-';
    if (qs('#formTeamBTotal')) qs('#formTeamBTotal').textContent = bTotal || '-';
  };
  for (let i=1;i<=5;i++) { const ael = qs(`#formAset${i}`); const bel = qs(`#formBset${i}`); if (ael) ael.oninput=computeTotals; if (bel) bel.oninput=computeTotals; }
  computeTotals();
  // ensure sets-area visibility default based on selected status radio
  const updateSetsVisibility = () => {
    const finished = qs('#statusFinished');
    const show = !!(finished && finished.checked);
    qsa('.sets-area').forEach(el=> el.style.display = show ? 'grid' : 'none');
  };
  // wire radios to update sets visibility
  const sA = qs('#statusScheduled'); const sB = qs('#statusFinished'); if (sA) sA.onchange = updateSetsVisibility; if (sB) sB.onchange = updateSetsVisibility;
  // wire type radios (they are true radios by name, so no need to enforce)
  const typeIds = ['typeFriendly','typeLeague','typeKnockout','typeGroup'];
  // set defaults if none selected
  (function setDefaults(){ if (!qs('#statusScheduled') && !qs('#statusFinished')) { const s = qs('#statusScheduled'); if (s) s.checked = true; } if (!typeIds.some(id=>qs('#'+id) && qs('#'+id).checked)) { const tf = qs('#typeFriendly'); if (tf) tf.checked = true; } updateSetsVisibility(); })();
  // time input: auto-insert ':' after 2 digits and validate HH:MM
  const timeInput = qs('#formTime');
  if (timeInput) {
    // allow Persian / Arabic-Indic digits in the time input — normalize to ASCII before formatting/validation
    function normalizePersianDigits(s) {
      if (!s) return s;
      const map = { '۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9', '٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9' };
      return String(s).replace(/[۰-۹٠-٩]/g, ch => map[ch] || ch);
    }

    timeInput.oninput = (ev) => {
      // normalize any Persian digits before processing
      let raw = normalizePersianDigits(timeInput.value || '');
      let v = raw.replace(/[^0-9:]/g, '');
      v = v.replace(/:/g, '');
      if (v.length > 2) v = v.slice(0,2) + ':' + v.slice(2,4);
      if (v.length > 5) v = v.slice(0,5);
      timeInput.value = v;
    };
    timeInput.onblur = () => {
      let val = normalizePersianDigits(timeInput.value || '');
      if (!val) return;
      const m = val.match(/^(\d{1,2}):(\d{2})$/);
      if (!m) { alert('فرمت زمان باید HH:MM باشد'); timeInput.focus(); return; }
      const hh = Number(m[1]); const mm = Number(m[2]);
      if (hh<0 || hh>23 || mm<0 || mm>59) { alert('ساعت معتبر نیست (00:00 - 23:59)'); timeInput.focus(); }
    };
  }
  // wire back button
  const backBtn = qs('#backFromMatchEdit'); if (backBtn) { backBtn.onclick = ()=> showView('competitions'); }
  // save handler — collect fields and persist
  const saveBtnEl = qs('#saveMatchBtn'); if (saveBtnEl) {
    // overwrite any previous handlers and prevent double-submit by disabling the button during save
    saveBtnEl.onclick = async function(ev) {
      try {
        ev.preventDefault();
        // disable to avoid duplicate clicks
        saveBtnEl.disabled = true;
        obj.teamA = qs('#formTeamA').value.trim(); obj.teamB = qs('#formTeamB').value.trim(); obj.date = qs('#formDate').value.trim(); obj.time = qs('#formTime').value.trim(); obj.venue = qs('#formVenue').value.trim();
        // status from radios
        obj.status = (qs('#statusFinished') && qs('#statusFinished').checked) ? 'finished' : 'scheduled';
        // kind/type from radios
        let selType = null; typeIds.forEach(tid => { const e = qs('#'+tid); if (e && e.checked) selType = e.value || tid.replace('type','').toLowerCase(); });
        if (!selType) { alert('لطفا نوع مسابقه را انتخاب کنید'); saveBtnEl.disabled = false; return; }
        obj.kind = selType;
        // hashtag
        const hashtagInput = qs('#formHashtag'); if (hashtagInput) obj.hashtag = hashtagInput.value.trim().replace(/^#+/,'');
        // logos: if user uploaded a file we stored a dataURL in the input; otherwise fallback to entered URL or defaults
        obj.logoA = (qs('#formTeamALogo') && qs('#formTeamALogo').value.trim()) || defaultLogo;
        obj.logoB = (qs('#formTeamBLogo') && qs('#formTeamBLogo').value.trim()) || '';
        obj.notes = qs('#formNotes').value.trim();
        obj.rules = qs('#formRules').value.trim();
        obj.contact = qs('#formContact').value.trim();
        // collect static sets 1..5
        const newSets = [];
        for (let i=1;i<=5;i++) {
          const a = qs(`#formAset${i}`).value.trim(); const b = qs(`#formBset${i}`).value.trim();
          if (a === '' && b === '') continue;
          newSets.push([ a === '' ? null : Number(a), b === '' ? null : Number(b) ]);
        }
        obj.sets = newSets;
        if (!obj.teamA || !obj.teamB) { alert('نام هر دو تیم لازم است'); saveBtnEl.disabled = false; return; }
        if (isEdit) { let idx = state.competitions.findIndex(x=>x.id===editId); if (idx!==-1) state.competitions[idx]=obj; }
        else state.competitions.unshift(obj);
        // update hashtags datalist after save
        try { const list = qs('#hashtagsList'); if (list && obj.hashtag) { const exists = Array.from(list.children).some(o=>o.value===obj.hashtag); if (!exists) { const o = document.createElement('option'); o.value = obj.hashtag; list.appendChild(o); } } } catch(e){}
        saveState(); showView('competitions'); renderMatchesList();
      } catch(err) { console.error('saveMatch failed', err); alert('خطا هنگام ذخیره مسابقه — کنسول را بررسی کنید.'); }
      finally { try { saveBtnEl.disabled = false; } catch(_){} }
    };
  }
}

// --- Share card generation ---
async function openShareOverlay(matchId) {
  const m = (state.competitions||[]).find(x=>x.id===matchId);
  if (!m) { console.warn('openShareOverlay: match not found', matchId); return; }
  console.debug('openShareOverlay called for', matchId, 'resolved to', m && m.id);
  // fill overlay fields (use safe checks because markup may vary)
  const elTitle = qs('#shareTitle'); if (elTitle) elTitle.textContent = `${m.teamA || ''} vs ${m.teamB || ''}`;
  const elKind = qs('#shareKind'); if (elKind) elKind.textContent = mapKindToPersian(m.kind) || '-';
  const elDate = qs('#shareDate'); if (elDate) elDate.textContent = m.date || '-';
  const elVenue = qs('#shareVenue'); if (elVenue) elVenue.textContent = m.venue || '-';
  const elTime = qs('#shareTime'); if (elTime) elTime.textContent = m.time || '-';
  // logos into the card
  const logoA = m.logoA || (state.settings && state.settings.logo) || 'icons/volleyball (1).png';
  const logoB = m.logoB || 'icons/volleyball (1).png';
  const imgA = qs('#shareLogoA'); const imgB = qs('#shareLogoB');
  if (imgA) imgA.src = logoA; if (imgB) imgB.src = logoB;
  // set team name fields and VS (new layout)
  const tA = qs('#shareTeamA'); const tB = qs('#shareTeamB');
  if (tA) tA.textContent = m.teamA || '';
  if (tB) tB.textContent = m.teamB || '';
  // show overlay AFTER fields are populated so capture sees the correct DOM
  const overlayEl = qs('#shareOverlay');
  if (overlayEl) overlayEl.classList.remove('hide');
  // make sure backdrop is below modal content and content accepts pointer events
  try {
    const backdropEl = qs('#shareOverlayBackdrop');
    const modalOuter = overlayEl && overlayEl.querySelector('.share-modal-outer');
    if (backdropEl) { backdropEl.style.zIndex = '10000'; backdropEl.style.pointerEvents = 'auto'; }
    if (modalOuter) { modalOuter.style.zIndex = '10001'; modalOuter.style.pointerEvents = 'auto'; }
    if (overlayEl) { overlayEl.dataset.activeShareMatch = matchId; overlayEl.style.zIndex = 10000; }
  } catch (e) { console.warn('failed adjust share overlay stacking', e); }
  // apply current colors to the visible card (live preview)
  const card = qs('#shareCard');
  const colorAInput = qs('#shareColorA'); const colorBInput = qs('#shareColorB');
  function applyCardColors() {
    const a = (colorAInput && colorAInput.value) || '#ff6b6b';
    const b = (colorBInput && colorBInput.value) || '#ff9ac2';
    if (card) card.style.background = `linear-gradient(180deg, ${a}, ${b})`;
  }
  applyCardColors();

  // ensure DOM had a chance to paint with the new content (helps capture match correct text)
  try {
    await new Promise(r => setTimeout(r, 40));
    await new Promise(res => requestAnimationFrame(() => requestAnimationFrame(res)));
  } catch(e) { console.debug('openShareOverlay paint wait failed', e); }
  // support both live input and change events (some mobile pickers only fire change)
  if (colorAInput) {
    colorAInput.disabled = false;
    colorAInput.addEventListener('input', applyCardColors);
    colorAInput.addEventListener('change', applyCardColors);
  }
  if (colorBInput) {
    colorBInput.disabled = false;
    colorBInput.addEventListener('input', applyCardColors);
    colorBInput.addEventListener('change', applyCardColors);
  }
  // Make the visible swatches clickable (larger tap target): clicking their parent opens native color input
  try {
    const swA = colorAInput && colorAInput.parentNode;
    const swB = colorBInput && colorBInput.parentNode;
      if (swA && colorAInput) {
        swA.style.cursor = 'pointer';
        // large-tap support: click and touchstart
        const openA = (ev) => { ev.stopPropagation(); try { colorAInput.focus(); colorAInput.click(); } catch(e) { try { colorAInput.dispatchEvent(new MouseEvent('click')); } catch(_){} } };
        swA.addEventListener('click', openA);
        swA.addEventListener('touchstart', openA, { passive: true });
        // ensure wrapper doesn't block pointer events from the input
        swA.style.pointerEvents = 'auto';
        // ensure the input is interactive
        colorAInput.style.pointerEvents = 'auto'; colorAInput.style.visibility = 'visible'; colorAInput.style.opacity = colorAInput.style.opacity || '1';
      }
      if (swB && colorBInput) {
        swB.style.cursor = 'pointer';
        const openB = (ev) => { ev.stopPropagation(); try { colorBInput.focus(); colorBInput.click(); } catch(e) { try { colorBInput.dispatchEvent(new MouseEvent('click')); } catch(_){} } };
        swB.addEventListener('click', openB);
        swB.addEventListener('touchstart', openB, { passive: true });
        swB.style.pointerEvents = 'auto';
        colorBInput.style.pointerEvents = 'auto'; colorBInput.style.visibility = 'visible'; colorBInput.style.opacity = colorBInput.style.opacity || '1';
      }
    // Ensure the live inputs accept pointer events while overlay is active
    if (colorAInput) colorAInput.style.pointerEvents = 'auto';
    if (colorBInput) colorBInput.style.pointerEvents = 'auto';
  } catch (e) { console.debug('swatch click wiring failed', e); }
  // Extra defensive styling: ensure native color pickers can open above the overlay
  try {
    [colorAInput, colorBInput].forEach(inp => {
      if (!inp) return;
      // prefer not to override styles the page intentionally set, only fill missing pieces
      if (!inp.style.position) inp.style.position = 'relative';
      // make sure they sit above modal/backdrop so native pickers can render
      const currentZ = parseInt(inp.style.zIndex || '0', 10) || 0;
      if (currentZ < 10002) inp.style.zIndex = '10002';
      inp.style.visibility = 'visible';
      if (!inp.style.opacity) inp.style.opacity = '1';
      inp.style.pointerEvents = 'auto';
    });
  } catch(e) { console.debug('color input enhancement failed', e); }
  // insert court image behind the gradient if available
  const courtImgPath = 'icons/court.png';
  if (card) {
    // add background image element if not present
    if (!qs('#shareCourtBg')) {
  const bg = document.createElement('img'); bg.id = 'shareCourtBg'; bg.src = courtImgPath; bg.style.position = 'absolute'; bg.style.width = '70%'; bg.style.height = '70%'; bg.style.left = '50%'; bg.style.top = '50%'; bg.style.transform = 'translate(-50%, -50%)'; bg.style.objectFit = 'contain'; bg.style.opacity = '0.18'; bg.style.zIndex = '1'; card.prepend(bg);
      // ensure existing content stays above bg
      Array.from(card.querySelectorAll(':scope > *:not(#shareCourtBg)')).forEach(el=> el.style.zIndex = '2');
    }
  }
  // backdrop click closes overlay
  const backdrop = qs('#shareOverlayBackdrop'); if (backdrop) { backdrop.onclick = ()=> qs('#shareOverlay').classList.add('hide'); }
  // wire actions (use direct listeners so cloning doesn't break handlers)
  const closeBtn = qs('#closeShareOverlay');
  if (closeBtn) { try { closeBtn.onclick = null; } catch(e){}; closeBtn.addEventListener('click', ()=> qs('#shareOverlay').classList.add('hide')); }
  const socialBtn = qs('#shareToSocialBtn');
  if (socialBtn) {
    try { socialBtn.onclick = null; } catch(e){}
    socialBtn.addEventListener('click', async () => {
      socialBtn.disabled = true;
      socialBtn.textContent = 'در حال ساخت تصویر...';
      try {
        await captureAndShareModal(m);
      } catch(e) {
        console.warn('capture flow failed, falling back to renderer', e);
        try { await shareToSocial(m); } catch(err) { console.error('share action failed', err); alert('خطا در اشتراک‌گذاری'); }
      }
  socialBtn.disabled = false;
  socialBtn.textContent = 'اشتراک کارت بازی';
    });
  }
}

async function shareToSocial(m) {
  // try navigator.share with text + URL; fallback to taking a snapshot of the card via html2canvas-like approach (simple canvas fallback)
  const text = `${m.title || ''}\n${m.teamA || ''} - ${m.teamB || ''}\n${m.date || ''} ${m.time || ''} @ ${m.venue || ''}`;
  if (navigator.share) {
    try {
      await navigator.share({ title: m.title || 'مسابقه', text });
      return;
    } catch (e) {
      console.warn('navigator.share failed', e);
    }
  }
  // fallback: capture the `#shareCard` using html2canvas at story resolution (1080x1920)
  // Use deterministic canvas renderer (avoids html2canvas / CORS issues)
  try {
    const colorA = (qs('#shareColorA') && qs('#shareColorA').value) || '#ff6b6b';
    const colorB = (qs('#shareColorB') && qs('#shareColorB').value) || '#ff9ac2';
    // ensure logos are accessible: if logo fields are File objects, convert to data URLs first
    const safeM = { ...m };
    try {
      if (safeM.logoA && safeM.logoA instanceof File) {
        safeM.logoA = await new Promise(res => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(safeM.logoA); });
      }
      if (safeM.logoB && safeM.logoB instanceof File) {
        safeM.logoB = await new Promise(res => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(safeM.logoB); });
      }
    } catch(e) { console.debug('logo File -> dataURL conversion failed', e); }

    const blob = await renderShareCanvasFromData(safeM, { width: 1080, height: 1920, colorA, colorB });
    if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'match-story.png', { type: blob.type })] })) {
      try {
        await navigator.share({ files: [new File([blob], 'match-story.png', { type: blob.type })], title: m.title || 'مسابقه' });
        return;
      } catch (e) { console.warn('share with file failed', e); }
    }
    // fallback: download
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'match-story.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  } catch (e) {
    console.error('shareToSocial (canvas renderer) failed', e);
    try {
      console.debug('shareToSocial: falling back to previous text-only story image');
      await fallbackTextStory(m);
      return;
    } catch (fbErr) {
      console.error('fallbackTextStory also failed', fbErr);
      alert('خطا در تولید تصویر اشتراک');
    }
  }
}

// Renderer for player profile story image (1080x1920 scaled to preview)
async function renderPlayerCanvasFromData(p, opts = {}) {
  const w = opts.width || 1080; const h = opts.height || 1920;
  const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  // background gradient
  const colorA = opts.colorA || '#ff6b6b'; const colorB = opts.colorB || '#ff9ac2';
  const g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,colorA); g.addColorStop(1,colorB);
  ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
  // draw optional photo box
  const photoSize = Math.floor(w * 0.24); const photoX = Math.floor((w - photoSize)/2); const photoY = Math.floor(h * 0.08);
  try {
    if (p.photo) {
      const img = new Image(); img.crossOrigin = 'anonymous'; await new Promise((res, rej)=>{ img.onload = res; img.onerror = rej; img.src = p.photo; });
      // draw circular/rounded photo
      const r = Math.floor(photoSize * 0.12);
      roundRect(ctx, photoX, photoY, photoSize, photoSize, r, true, false);
      ctx.save(); roundedClip(ctx, photoX, photoY, photoSize, photoSize, r); ctx.drawImage(img, photoX, photoY, photoSize, photoSize); ctx.restore();
    } else {
      ctx.fillStyle = 'rgba(255,255,255,0.16)'; ctx.fillRect(photoX, photoY, photoSize, photoSize);
    }
  } catch (e) { console.debug('player photo draw failed', e); }
  // draw name
  // draw name centered under photo
  ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.font = '700 64px Vazirmatn, sans-serif';
  const nameY = photoY + photoSize + 90;
  ctx.fillText(p.name || '-', w/2, nameY);
  // draw stacked centered info lines (multiline wrap helper)
  function drawWrappedCenter(text, x, startY, maxWidth, lineHeight, font) {
    ctx.font = font;
    const words = String(text || '').split(/\s+/);
    const lines = [];
    let line = '';
    words.forEach((wrd) => {
      const test = line ? (line + ' ' + wrd) : wrd;
      const m = ctx.measureText(test).width;
      if (m > maxWidth && line) { lines.push(line); line = wrd; } else { line = test; }
    });
    if (line) lines.push(line);
    lines.forEach((ln, idx) => { ctx.fillText(ln, x, startY + idx * lineHeight); });
    return lines.length;
  }
  const infoX = Math.floor(w * 0.12); const infoW = Math.floor(w * 0.76);
  let lineY = nameY + 48;
  ctx.fillStyle = 'rgba(255,255,255,0.95)';
  drawWrappedCenter('تاریخ تولد: ' + (p.birthdate || '-'), w/2, lineY, infoW, 42, '600 30px Vazirmatn, sans-serif'); lineY += 48;
  drawWrappedCenter('سابقه عضویت: ' + (p.joinDate || '-'), w/2, lineY, infoW, 40, '500 28px Vazirmatn, sans-serif'); lineY += 44;
  drawWrappedCenter('قد/وزن: ' + ((p.height || '-') + 'cm / ' + (p.weight || '-') + 'kg'), w/2, lineY, infoW, 40, '500 28px Vazirmatn, sans-serif'); lineY += 44;
  drawWrappedCenter('مهارت: ' + (p.skills || '-') + ' • امتیاز: ' + (p.score || '-'), w/2, lineY, infoW, 40, '600 30px Vazirmatn, sans-serif');
  // return blob
  return await new Promise((res, rej) => { canvas.toBlob(b => { if (b) res(b); else rej(new Error('toBlob failed')); }, 'image/png'); });
}

// Helpers for rounded drawing (reuse existing functions names from renderer)
function roundRect(ctx, x, y, w, h, r, fill, stroke) {
  if (typeof r === 'undefined') r = 5; ctx.beginPath(); ctx.moveTo(x + r, y); ctx.arcTo(x + w, y, x + w, y + h, r); ctx.arcTo(x + w, y + h, x, y + h, r); ctx.arcTo(x, y + h, x, y, r); ctx.arcTo(x, y, x + w, y, r); ctx.closePath(); if (fill) ctx.fill(); if (stroke) ctx.stroke();
}
function roundedClip(ctx, x, y, w, h, r) { ctx.beginPath(); ctx.moveTo(x + r, y); ctx.arcTo(x + w, y, x + w, y + h, r); ctx.arcTo(x + w, y + h, x, y + h, r); ctx.arcTo(x, y + h, x, y, r); ctx.arcTo(x, y, x + w, y, r); ctx.closePath(); ctx.clip(); }

// Player share modal flow removed. Sharing is now performed directly from the profile share button.

// Create image and share/download it
async function captureAndSharePlayerProfile(p, shareText = '') {
  // create blob via renderer
  const blob = await renderPlayerCanvasFromData(p, { width:1080, height:1920 });
  if (!blob) throw new Error('render failed');
  const file = new File([blob], (p.name||'player') + '.png', { type: 'image/png' });
  // Include the textual profile as a separate text file when sharing alongside the image.
  try {
    const textFile = new File([shareText || formatPlayerProfileText(p) || ''], `${(p.name||'player').replace(/\s+/g,'_')}_profile.txt`, { type: 'text/plain;charset=utf-8' });
    const filesArray = [file, textFile];
    if (navigator.canShare && navigator.canShare({ files: filesArray })) {
      try { await navigator.share({ files: filesArray, title: p.name || 'پروفایل بازیکن', text: shareText || undefined }); return; } catch (e) { console.warn('navigator.share(files+text) failed', e); }
    }
  } catch (e) { console.warn('creating text file for share failed', e); }
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = (p.name||'player') + '.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function formatPlayerProfileText(p) {
  // build richer textual profile
  const age = p.birthdate ? calcExactAge(p.birthdate) : null;
  const category = age ? determineCategory(age) : (p.category || '-');
  const payments = (state.payments || []).filter(x => x.playerId === p.id).slice(-5).reverse().map(x => `${x.amount} (${isoToJalali(x.date)})`).join('؛ ') || 'هیچ پرداختی ثبت نشده';
  const recentNotes = (p.events || []).slice(-5).reverse().map(e => `${e.date}${e.author ? ' • ' + (e.author.name||'') : ''}: ${e.text}`).join('\n') || 'بدون یادداشت';
  return `پروفایل بازیکن: ${p.name || '-'}\nاطلاعات تماس: ${p.phone||'-'}\nتاریخ تولد: ${p.birthdate || '-'}\nرده/رده‌سنی: ${category}\nسابقه عضویت: ${p.joinDate || '-'}\nقد: ${p.height||'-'} cm • وزن: ${p.weight||'-'} kg\nمهارت: ${p.skills || '-'} • امتیاز: ${p.score || '-'}\n\nآخرین پرداخت‌ها: ${payments}\n\nیادداشت‌های اخیر:\n${recentNotes}`;
}

// Backwards-compatible wrapper: delegate to the primary capture implementation.
async function captureAndShareModal(match) {
  // If called without a match, try to infer the currently opened match from the overlay
  if (!match) {
    try {
      const overlay = qs('#shareOverlay'); if (!overlay || overlay.classList.contains('hide')) return;
      const title = qs('#shareTitle') ? qs('#shareTitle').textContent : null;
      const candidate = (state.competitions||[]).find(x => (x.title && x.title === title) || (x.teamA && (title||'').includes(x.teamA)) || (x.teamB && (title||'').includes(x.teamB)));
      if (candidate) match = candidate; else { console.debug('captureAndShareModal: no match inferred'); return; }
    } catch (e) { console.debug('capture wrapper infer failed', e); return; }
  }
  // If an external implementation is registered, call it -- but guard against self-delegation.
  try {
    // Give the browser a tiny moment to finish layout/paint after openShareOverlay
    // This prevents captures that miss the last DOM updates (colors/logos/z-index)
    await new Promise(res => setTimeout(res, 80));
    // also wait two rAFs for extra safety
    await new Promise(res => requestAnimationFrame(() => requestAnimationFrame(res)));

    if (typeof window._captureAndShareModalImpl === 'function' && window._captureAndShareModalImpl !== captureAndShareModal) {
      return await window._captureAndShareModalImpl(match);
    }
  } catch(e) { console.debug('external capture impl failed', e); }
  // fallback: nothing to do
  console.debug('No capture implementation available');
}

// Share profile directly: try to share player's photo (if accessible) and include textual profile as fallback/extra
async function shareProfileDirect(p) {
  if (!p) return;
  const text = formatPlayerProfileText(p);
  // If player has a photo, try to fetch it as a blob and share it along with text
  if (p.photo) {
    try {
      const resp = await fetch(p.photo, { mode: 'cors' });
      if (resp && resp.ok) {
        const blob = await resp.blob();
        const ext = (blob.type || 'image/png').split('/').pop();
        const file = new File([blob], `${(p.name||'player').replace(/\s+/g,'_')}.${ext}`, { type: blob.type || 'image/png' });
        try {
          const textFile = new File([text || formatPlayerProfileText(p) || ''], `${(p.name||'player').replace(/\s+/g,'_')}_profile.txt`, { type: 'text/plain;charset=utf-8' });
          const filesArray = [file, textFile];
          if (navigator.canShare && navigator.canShare({ files: filesArray })) {
            try { await navigator.share({ files: filesArray, title: p.name || 'پروفایل بازیکن', text }); return; } catch(e) { console.warn('navigator.share(files+text) failed', e); }
          }
        } catch (e) { console.warn('prepare share files failed', e); }
        // If native share failed, fallback to capture (which will include photo via html2canvas if possible)
      }
    } catch (e) { console.warn('fetching player photo failed (CORS?)', e); }
  }
  // fallback: use capture flow which will create an image (html2canvas or renderer) and include text when possible
  try { await captureAndSharePlayerProfile(p, text); } catch (e) { console.error('shareProfileDirect failed', e); alert('اشتراک انجام نشد'); }
}
// Fallback: create a simple text-only story image and trigger download/share
async function fallbackTextStory(m) {
  try {
    const outCanvas = document.createElement('canvas'); outCanvas.width = 1080; outCanvas.height = 1920;
    const ctx = outCanvas.getContext('2d');
    // background
    const g = ctx.createLinearGradient(0,0,outCanvas.width,outCanvas.height);
    g.addColorStop(0,'#ff6b6b'); g.addColorStop(1,'#ff9ac2');
    ctx.fillStyle = g; ctx.fillRect(0,0,outCanvas.width,outCanvas.height);
    // title
    ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.font = 'bold 48px Vazirmatn, sans-serif';
    ctx.fillText(m.title || (m.teamA + ' vs ' + m.teamB), outCanvas.width/2, 220);
    // teams
    ctx.font = '700 64px Vazirmatn, sans-serif'; ctx.fillText((m.teamA||'') + '  VS  ' + (m.teamB||''), outCanvas.width/2, 520);
    // date/time/venue
    ctx.font = '500 28px Vazirmatn, sans-serif'; ctx.fillText((m.date || '-') + '   •   ' + (m.time || '-'), outCanvas.width/2, outCanvas.height - 260);
    ctx.fillText(m.venue || '-', outCanvas.width/2, outCanvas.height - 210);
    // convert
    const blob = await new Promise(res => outCanvas.toBlob(res, 'image/png'));
    if (!blob) throw new Error('Failed to create blob');
    // try to share
    if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'match-story.png', { type: blob.type })] })) {
      try { await navigator.share({ files: [new File([blob], 'match-story.png', { type: blob.type })], title: m.title || 'مسابقه' }); return; }
      catch (err) { console.warn('navigator.share fallback failed', err); }
    }
    // download fallback
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'match-story.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  } catch (err) {
    console.error('fallbackTextStory failed', err);
    alert('خطا در تولید تصویر اشتراک');
  }
}

function openJalaliCalendarForMatches() {
  // calendar modal removed; focus the inline date filter for convenience
  const el = qs('#matchesDateFilter'); if (el) { el.focus(); el.scrollIntoView({behavior:'smooth',block:'center'}); }
}

// --- Inline Jalali calendar widget for matches date filter ---
(function(){
  let current = null; // { y, m }
  const widget = () => qs('#matchesDateWidget');
  const grid = () => qs('#mdwGrid');
  const title = () => qs('#mdwTitle');
  function openWidget() { const w = widget(); if (!w) return; w.style.display = 'block'; document.addEventListener('click', outsideHide); }
  function closeWidget() { const w = widget(); if (!w) return; w.style.display = 'none'; document.removeEventListener('click', outsideHide); }
  function outsideHide(e) {
    const w = widget(); if (!w) return; const input = qs('#matchesDateFilter');
    if (!w.contains(e.target) && e.target !== input) closeWidget();
  }
  function pad(n){ return String(n).padStart(2,'0'); }
  function renderMonth(y,m){
    current = { y, m };
    if (!grid()||!title()) return;
    // title: year/month
    title().textContent = `${y}/${pad(m)}`;
    // compute first day of month weekday and days in month using jalali_to_gregorian
    // create days array
    const days = [];
    // find weekday of first day: convert to ISO and use Date
    const firstISO = jalaliToISO(`${y}/${pad(m)}/01`);
    const wd = new Date(firstISO).getDay(); // 0 (Sun) .. 6
    // Jalali week in UI will start on Sat (but we'll align with existing locale using JS weekday)
    const daysInMonth = (function(){
      // determine by trying next month day 1 minus one day
      let nextM = m+1, nextY = y; if (nextM>12){ nextM=1; nextY++; }
      const nextISO = jalaliToISO(`${nextY}/${pad(nextM)}/01`);
      const d = new Date(nextISO); d.setDate(d.getDate()-1);
      const j = gregorian_to_jalali(d.getFullYear(), d.getMonth()+1, d.getDate()); return j[2];
    })();
    // clear grid and render empty slots + days
    grid().innerHTML = '';
    // render weekday headers (short Persian)
    const wNames = ['ش','ی','د','س','چ','پ','ج']; // Sat..Fri (approx short)
    wNames.forEach(n=>{ const el = document.createElement('div'); el.style.fontWeight='700'; el.style.textAlign='center'; el.style.padding='6px 0'; el.textContent = n; grid().appendChild(el); });
    for (let i=0;i< (7*6); i++){ // 6 rows to cover all months
      const cell = document.createElement('div'); cell.style.minHeight='34px'; cell.style.textAlign='center'; cell.style.padding='6px 4px'; cell.style.borderRadius='6px';
      const hdrCount = 7; // first row is weekdays so skip placing day numbers until index >=7
      if (i < hdrCount) continue; // skip header placeholders since already added
    }
    // We will render days starting after weekday header row; create separate container for numbers
    const numsContainer = document.createElement('div'); numsContainer.style.gridColumn = '1/-1'; numsContainer.style.display='grid'; numsContainer.style.gridTemplateColumns='repeat(7,1fr)'; numsContainer.style.gap='6px';
    // compute offset: weekday of first date (JS getDay) where Sun=0; we want to align to Sat-first view; shift accordingly
    // Convert JS weekday to index where Sat=0: ((wd+1)%7)
    const offset = ((wd + 1) % 7);
    for (let i=0;i<offset;i++){ const e = document.createElement('div'); numsContainer.appendChild(e); }
    for (let d=1; d<=daysInMonth; d++){
      const e = document.createElement('button'); e.className='btn'; e.style.padding='6px'; e.style.width='100%'; e.style.boxSizing='border-box'; e.textContent = String(d);
      e.addEventListener('click', ()=>{
        const val = `${y}/${pad(m)}/${pad(d)}`;
        const inpt = qs('#matchesDateFilter'); if (inpt) inpt.value = val;
        selectedMatchesDate = val; renderMatchesList(); closeWidget();
      });
      numsContainer.appendChild(e);
    }
    // append empty cells to complete grid (optional)
    const totalCells = offset + daysInMonth; const trailing = (7 - (totalCells % 7)) % 7;
    for (let i=0;i<trailing;i++) numsContainer.appendChild(document.createElement('div'));
    // now put weekdays header + numbers into mdwGrid
    const mdw = grid(); mdw.innerHTML = ''; wNames.forEach(n=>{ const h = document.createElement('div'); h.style.fontWeight='700'; h.style.textAlign='center'; h.style.padding='6px 0'; h.textContent = n; mdw.appendChild(h); });
    mdw.appendChild(numsContainer);
  }
  // nav handlers
  function initWidget(){
    const inpt = qs('#matchesDateFilter'); if (!inpt) return;
    const w = widget(); if (!w) return;
    inpt.addEventListener('focus', ()=>{ // open and set to input month or today
      const parts = (inpt.value || todayJalali()).split('/').map(Number);
      renderMonth(parts[0], parts[1]); openWidget();
    }, false);
    inpt.addEventListener('click', (e)=>{ e.stopPropagation(); const parts = (inpt.value || todayJalali()).split('/').map(Number); renderMonth(parts[0], parts[1]); openWidget(); }, false);
  const prevBtn = qs('#mdwPrev'); if (prevBtn) prevBtn.addEventListener('click', ()=>{ if (!current) return; let y=current.y, m=current.m-1; if (m<1){ m=12; y--; } renderMonth(y,m); });
  const nextBtn = qs('#mdwNext'); if (nextBtn) nextBtn.addEventListener('click', ()=>{ if (!current) return; let y=current.y, m=current.m+1; if (m>12){ m=1; y++; } renderMonth(y,m); });
  const todayBtn = qs('#mdwToday'); if (todayBtn) todayBtn.addEventListener('click', ()=>{ const t = todayJalali().split('/').map(Number); renderMonth(t[0], t[1]); const inpt = qs('#matchesDateFilter'); if (inpt) inpt.value = todayJalali(); selectedMatchesDate = todayJalali(); renderMatchesList(); closeWidget(); });
  const closeBtn = qs('#mdwClose'); if (closeBtn) closeBtn.addEventListener('click', ()=>{ closeWidget(); });
    // clicking calendar icon (if any) or calling openJalaliCalendarForMatches should focus; we already wired that function
  }
  // expose init on DOM ready for competitions page
  document.addEventListener('DOMContentLoaded', ()=>{ try{ initWidget(); }catch(e){console.warn('initWidget failed',e);} });
})();

/* ================================================================
  SECTION: Views & Rendering
  - renderHome, renderPlayersPage, renderPlayerProfile, etc.
  ================================================================ */
/* Views & Rendering */
/* renderRankEditor moved here so it is available before showView is called */
function renderRankEditor() {
  const content = qs('#rankEditorContent');
  // Ensure we have a usable ranks array (handle older backups where ranks may be null)
  const defaultRanks = [
    { id: 'mini', name: 'مینی والیبال', minAgeYears: 0, maxAgeYears: 12, startDateJ: '' },
    { id: 'noonahal', name: 'نونهالان', minAgeYears: 13, maxAgeYears: 14, startDateJ: '' },
    { id: 'nojavanan', name: 'نوجوانان', minAgeYears: 15, maxAgeYears: 16, startDateJ: '' },
    { id: 'nojavanan_boghr', name: 'نوجوانان بزرگ', minAgeYears: 17, maxAgeYears: 18, startDateJ: '' },
    { id: 'javan', name: 'جوانان', minAgeYears: 19, maxAgeYears: 20, startDateJ: '' },
    { id: 'omid', name: 'امیدها', minAgeYears: 21, maxAgeYears: 22, startDateJ: '' },
    { id: 'adult', name: 'بزرگسالان', minAgeYears: 23, maxAgeYears: 200, startDateJ: '' }
  ];
  if (!state.settings) state.settings = {};
  if (!state.settings.ranks) state.settings.ranks = defaultRanks.slice();
  const ranks = state.settings.ranks;
  // reference date: can be manual or automatic. store mode in state.settings.ranksRefMode = 'auto'|'manual'
  if (!state.settings.ranksRefMode) state.settings.ranksRefMode = 'auto';
  // ensure ranksReferenceDate exists for display. If mode is auto, default to the upcoming yyyy/10/11 (11 Dey)
  if (!state.settings.ranksReferenceDate) {
    if (state.settings.ranksRefMode === 'auto') {
      const t = todayJalali().split('/').map(Number);
      const thisYearCutoff = `${t[0]}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
      if (jalaliToISO(todayJalali()) < jalaliToISO(thisYearCutoff)) {
        state.settings.ranksReferenceDate = thisYearCutoff;
      } else {
        state.settings.ranksReferenceDate = `${t[0]+1}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
      }
    } else {
      state.settings.ranksReferenceDate = state.settings.lastCategoryUpdate || todayJalali();
    }
  }
  const refDate = state.settings.ranksReferenceDate;
  content.innerHTML = `
    <style>
      /* Rank Editor responsive tweaks - tightened per user request */
      #rankEditorContent { font-size:11px; }
      #rankEditorContent .rank-row { display:flex;gap:4px;align-items:center;flex-wrap:wrap; }
      #rankEditorContent .rank-name { flex:1 1 100px;min-width:48px;max-width:170px;font-size:11px;padding:4px; }
      #rankEditorContent .rank-min, #rankEditorContent .rank-max { width:56px;text-align:center;flex:0 0 auto;font-size:11px;padding:4px; }
      #rankEditorContent .delete-rank { padding:4px 6px; font-size:12px; width:30px; height:30px; border-radius:4px; }
      @media (max-width:360px){
        #rankEditorContent .delete-rank { width:20px; height:20px; padding:2px 4px; font-size:10px; }
        #rankEditorContent .rank-name { max-width:140px; }
        #rankEditorContent .rank-min, #rankEditorContent .rank-max { width:52px; }
      }
      @media (max-width:300px){
        /* Stack fields vertically to avoid breaking columns on very small screens */
        #rankEditorContent .rank-row { flex-direction:column; align-items:flex-start; gap:6px; }
        #rankEditorContent .rank-name { flex:1 1 100%; min-width:0; max-width:100%; font-size:12px; }
        #rankEditorContent .rank-min, #rankEditorContent .rank-max { width:44px; flex:0 0 auto; }
        /* Make delete button smaller and less intrusive */
        #rankEditorContent .delete-rank { width:18px; height:18px; padding:0 4px; font-size:10px; }
        /* Reduce spacing for control buttons */
        #rankEditorContent .controls-row .buttons { gap:4px; }
        #rankEditorContent .controls-row button { padding:6px 4px; font-size:12px; }
      }
  /* Header and subtext tweaks for rank editor */
  #rankEditorContent .rank-header { font-size:13px; }
  /* make the subnote noticeably smaller (two sizes smaller than header) */
  #rankEditorContent .rank-header .rank-sub { font-size:10px; color:var(--muted); font-weight:400; }
      /* Two-step smaller rank name at small widths */
      @media (max-width:420px){
        #rankEditorContent .rank-name { font-size:13px; }
      }
      @media (max-width:320px){
        #rankEditorContent .rank-name { font-size:11px; }
        #rankEditorContent .rank-header { font-size:12px; }
        /* make subtext even smaller on very narrow screens */
        #rankEditorContent .rank-header .rank-sub { font-size:9px; }
        #rankEditorContent #backRankEditorSmall { display:inline-flex; }
      }
      #rankEditorContent .ref-box { border:1px solid rgba(0,0,0,0.06);padding:6px;border-radius:8px;background:#fff; }
      #rankEditorContent .controls-row { display:block; }
      #rankEditorContent .controls-row .buttons { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; align-items:center; }
      #rankEditorContent .controls-row button { padding:6px 6px; font-size:12px }
      @media (max-width:420px){
        #rankEditorContent .controls-row .buttons { grid-template-columns:repeat(2,1fr); }
      }
      @media (max-width:320px){
        #rankEditorContent .controls-row .buttons { grid-template-columns:1fr; }
        #rankEditorContent .controls-row button{width:100%;}
      }
    </style>
    <div id="rankEditorContent" style="display:flex;flex-direction:column;gap:10px;">
      <div class="ref-box">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
          <div style="font-weight:700;">تاریخ مرجع آپدیت رده ها</div>
          <div style="display:flex;align-items:center;gap:8px;"> 
            <label style="display:flex;align-items:center;gap:6px;"> <input type="radio" name="ranksRefMode" value="auto" ${state.settings.ranksRefMode === 'auto' ? 'checked' : ''}/> خودکار</label>
            <label style="display:flex;align-items:center;gap:6px;"> <input type="radio" name="ranksRefMode" value="manual" ${state.settings.ranksRefMode === 'manual' ? 'checked' : ''}/> دستی</label>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
          <input id="ranksRefDate" class="input jalali-input" value="${refDate}" style="max-width:160px;" />
          <div id="ranksRefStatus" style="font-weight:700;padding:6px;border-radius:4px;">&nbsp;</div>
        </div>
      </div>
      <div class="rank-header" style="display:flex;gap:8px;align-items:flex-end;font-weight:700;padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.06);flex-wrap:wrap;">
        <div class="rank-col rank-col-name" style="flex:1;min-width:80px;text-align:center;">
          <div class="rank-col-label">رده‌ها</div>
        </div>
        <div class="rank-col rank-col-min" style="width:72px;text-align:center;">
          <div class="rank-col-label">سن شروع</div>
          <div class="rank-sub">(شامل رده می‌شود)</div>
        </div>
        <div class="rank-col rank-col-max" style="width:72px;text-align:center;">
          <div class="rank-col-label">سن پایان</div>
          <div class="rank-sub">(شامل رده می‌شود)</div>
        </div>
        <div class="rank-col rank-col-delete" style="width:48px;text-align:center;">
          <div class="rank-col-label">حذف</div>
        </div>
        <!-- small back button shown on very narrow screens, placed next to age columns -->
        <button id="backRankEditorSmall" class="back-btn" style="display:none;margin-left:6px;"> <svg viewBox="0 0 24 24" width="18" height="18"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
      </div>
      <div id="ranksRows" style="display:flex;flex-direction:column;gap:8px;">
        ${ranks.map((r, idx) => `
          <div class="rank-row" data-idx="${idx}" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <input class="input rank-name" data-idx="${idx}" data-field="name" value="${escapeHtml(r.name)}" style="flex:1 1 110px;min-width:56px;max-width:200px;" />
            <input class="input rank-min" data-idx="${idx}" data-field="minAge" value="${r.minAgeYears}" style="width:72px;text-align:center;flex:0 0 auto;" />
            <input class="input rank-max" data-idx="${idx}" data-field="maxAge" value="${r.maxAgeYears}" style="width:72px;text-align:center;flex:0 0 auto;" />
            <button class="btn small danger delete-rank" data-idx="${idx}" title="حذف">×</button>
          </div>
        `).join('')}
      </div>
      <div id="rankSaveNotice" style="display:none;color:#064e3b;background:#ecfccb;padding:8px;border-radius:8px;font-weight:700;text-align:center;margin-bottom:8px;"></div>
      <div class="controls-row" style="margin-top:8px;">
        <div class="buttons">
          <button id="addRankBtn" class="btn">افزودن</button>
          <button id="resetRanksBtn" class="btn danger">ریست</button>
          <button id="saveRanksBtn" class="btn primary">ذخیره</button>
        </div>
      </div>
    </div>
  `;

  // removed Cancel button per UX request; navigation handled by header/back
  // delete handler
  content.querySelectorAll('.delete-rank').forEach(btn => btn.addEventListener('click', (e) => {
    const idx = Number(btn.dataset.idx);
    if (!confirm('آیا از حذف این رده مطمئن هستید؟')) return;
    state.settings.ranks.splice(idx, 1);
    saveState();
    renderRankEditor();
  }));

  on('#addRankBtn', 'click', () => {
    const id = 'r' + Math.floor(Math.random()*100000);
    state.settings.ranks.push({ id, name: 'رده جدید', minAgeYears: 0, maxAgeYears: 0 });
    saveState(); renderRankEditor();
  });

  on('#resetRanksBtn', 'click', () => {
    if (!confirm('بازنشانی رده‌ها به پیش‌فرض انجام شود؟')) return;
    state.settings.ranks = defaultRanks.slice();
    state.settings.ranksReferenceDate = state.settings.lastCategoryUpdate || todayJalali();
    // apply defaults to existing players by recalculating categories
    state.players.forEach(p => { if (p.birthdate) p.category = determineCategory(calcExactAge(p.birthdate)); });
    saveState(); renderRankEditor(); refreshCategorySelects(); showToast('رده‌ها به پیش‌فرض بازنشانی شدند');
  });

  on('#saveRanksBtn', 'click', () => {
    const rows = Array.from(qsa('#ranksRows .rank-row'));
    const newRanks = rows.map((row, idx) => {
      const name = qs('.rank-name', row).value || ('رده ' + (idx+1));
      const minA = parseInt(qs('.rank-min', row).value) || 0;
      const maxA = parseInt(qs('.rank-max', row).value) || 200;
      return { id: state.settings.ranks[idx]?.id || ('r'+idx), name, minAgeYears: minA, maxAgeYears: maxA };
    });
    state.settings.ranks = newRanks;
    const ref = qs('#ranksRefDate').value || todayJalali();
    state.settings.ranksReferenceDate = ref;
    if (state.settings.ranksRefMode === 'manual') {
      state.settings.lastCategoryUpdate = `ویرایش دستی ${ref}`;
    } else {
      state.settings.lastCategoryUpdate = `خودکار ${ref}`;
    }
    // apply ranks to all players (recompute their categories)
    state.players.forEach(p => { if (p.birthdate) p.category = determineCategory(calcExactAge(p.birthdate)); });
    saveState();
    refreshCategorySelects();
    // stay on the rank editor page and show a visible confirmation
    try { showToast('رده‌ها ذخیره شد', 1800); } catch(e) { console.warn('showToast failed', e); }
    // briefly highlight the save button so the user notices the change
    try {
      const sb = qs('#saveRanksBtn');
      if (sb) {
        const prevBox = sb.style.boxShadow;
        sb.style.boxShadow = '0 8px 20px rgba(34,197,94,0.18)';
        setTimeout(() => { try { sb.style.boxShadow = prevBox; } catch(_){} }, 1200);
      }
    } catch(e) { console.warn('highlight save button failed', e); }
    // show an inline confirmation in the editor (visible even if toast is hidden)
    try {
      const notice = qs('#rankSaveNotice');
      if (notice) {
        notice.textContent = 'ذخیره شد';
        notice.style.display = 'block';
        setTimeout(() => { try { notice.style.display = 'none'; } catch(_){} }, 3000);
      }
    } catch(e) { console.warn('inline save notice failed', e); }
  });

  // header back button routing to settings (if present in header)
  try { on('#backRankEditor', 'click', () => { showView('settings'); }); } catch(e) {}
  // small back button visible on very narrow screens: reuse same handler
  try { on('#backRankEditorSmall', 'click', () => { showView('settings'); }); } catch(e) {}

  // handle auto/manual mode switching and status color
  const statusEl = qs('#ranksRefStatus');
  function updateRefModeUI(){
    const mode = state.settings.ranksRefMode || 'auto';
    const ref = state.settings.ranksReferenceDate || todayJalali();
    if (mode === 'auto'){
      // Auto mode: compute next upcoming cutoff = yyyy/10/11 based on today's jalali year
      const today = todayJalali();
      const todayParts = today.split('/').map(Number);
      const cutoffThisYear = `${todayParts[0]}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
      const cutoffNextYear = `${todayParts[0]+1}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
      const chosen = (jalaliToISO(today) <= jalaliToISO(cutoffThisYear)) ? cutoffThisYear : cutoffNextYear;
      const refInput = qs('#ranksRefDate');
      if (refInput) refInput.value = chosen;
      // if stored ref is older than chosen, update and re-evaluate
      if (!state.settings.ranksReferenceDate || jalaliToISO(state.settings.ranksReferenceDate) < jalaliToISO(chosen)){
        state.settings.ranksReferenceDate = chosen;
        state.settings.lastCategoryUpdate = `خودکار ${chosen}`;
        state.players.forEach(p => { if (p.birthdate) p.category = determineCategory(Object.assign(calcExactAge(p.birthdate), { birthdate: p.birthdate })); });
        saveState();
        showToast(`مرجع رده‌ها به‌صورت خودکار به ${chosen} بروزرسانی شد`);
      }
      statusEl.textContent = 'خودکار';
      statusEl.style.background = '#e6ffed';
      statusEl.style.color = '#137333';
    } else {
      // manual mode: show stored manual date in the input
      const refInput = qs('#ranksRefDate');
      if (refInput) refInput.value = state.settings.ranksReferenceDate || todayJalali();
      statusEl.textContent = 'دستی';
      statusEl.style.background = '#fff7e6';
      statusEl.style.color = '#92400e';
    }
    // enable/disable ref input depending on mode; color text green/yellow
    const refInput = qs('#ranksRefDate');
    if (refInput) {
      refInput.disabled = (mode !== 'manual');
      refInput.style.color = (mode === 'auto') ? '#137333' : '#92400e';
      refInput.style.fontWeight = (mode === 'auto') ? '700' : '600';
    }
  }
  // radio change handlers
  qsa('input[name="ranksRefMode"]').forEach(r => r.addEventListener('change', (e)=>{
    const newMode = e.target.value;
    state.settings.ranksRefMode = newMode;
    if (newMode === 'auto'){
      // compute nearest cutoff yyyy/10/11 based on today's jalali year
      const today = todayJalali();
      const parts = today.split('/').map(Number);
      const cutoffThisYear = `${parts[0]}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
      const cutoffNextYear = `${parts[0]+1}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
      const chosen = (jalaliToISO(today) <= jalaliToISO(cutoffThisYear)) ? cutoffThisYear : cutoffNextYear;
      state.settings.ranksReferenceDate = chosen;
      state.settings.lastCategoryUpdate = `خودکار ${chosen}`;
      // re-evaluate player categories immediately for the chosen cutoff
      state.players.forEach(p => { if (p.birthdate) p.category = determineCategory(Object.assign(calcExactAge(p.birthdate), { birthdate: p.birthdate })); });
    } else {
      // manual: preserve existing manual date if present, otherwise default to last update or today
      if (!state.settings.ranksReferenceDate) state.settings.ranksReferenceDate = state.settings.lastCategoryUpdate || todayJalali();
    }
    saveState(); updateRefModeUI();
  }));
  // when manual, allow editing ref input; when auto, disable manual editing
  qs('#ranksRefDate').addEventListener('input', (e)=>{
    if (state.settings.ranksRefMode === 'manual') {
      state.settings.ranksReferenceDate = e.target.value;
      saveState();
    }
  });
  // ensure jalali calendar hooks are attached for the ref input
  try{ attachJalaliInputs(content); } catch(e){}
  // initial UI update
  try{ updateRefModeUI(); } catch(e){}
}
function showView(viewId, params = {}, noPush = false) {
  qsa('#view-root > section').forEach(s => s.classList.add('hide'));
  qs(`#view-${viewId}`).classList.remove('hide');
  // toggle visibility of page-specific FABs
    try {
    let fp = qs('#fabPayment'); if (fp) fp.style.display = (viewId === 'payments') ? '' : 'none';
    let fs = qs('#fabSession'); if (fs) fs.style.display = (viewId === 'sessions') ? '' : 'none';
    let ft = qs('#fabTraining'); if (ft) ft.style.display = 'none';
    // if we're on sessions view, ensure we show the correct FAB for the active tab
    if (viewId === 'sessions') {
      try {
        let isTrainingTab = qs('#tabTrainingPlanPanel') && qs('#tabTrainingPlanPanel').style.display !== 'none';
        try { qs('#fabSession').style.display = isTrainingTab ? 'none' : ''; } catch(e) {}
        try { qs('#fabTraining').style.display = isTrainingTab ? '' : 'none'; } catch(e) {}
      } catch(e) {}
    }
  } catch(e) {}
  
  if (viewId === 'home') {
    qs('#appHeader').style.display = 'flex';
    renderHome();
    // notifications loader moved to end-of-file to ensure the debug script
    // is loaded after all main app code and window-level helpers are defined.
    // (no-op here)
  } else {
    qs('#appHeader').style.display = 'none';
  }
  if (viewId === 'players') renderPlayersPage();
  if (viewId === 'coaches') renderCoaches();
  if (viewId === 'sessions') renderSessionsPage();
  if (viewId === 'payments') renderPaymentsPage();
  if (viewId === 'insurance') renderInsurancePage();
  if (viewId === 'health') renderHealthPage();
  if (viewId === 'player-form') renderPlayerForm(params.player);
  if (viewId === 'coach-form') renderCoachForm(params.coach);
  if (viewId === 'private-class') renderPrivateClass(params.coachId, params.classId);
  if (viewId === 'session-attendance') renderSessionAttendance(params.sessionId);
  if (viewId === 'note') renderNote(params.playerId, params.currentNote, params.callback, params.sessionId, params.tempAttendances);
  if (viewId === 'player-profile') renderPlayerProfile(params.playerId);
  // If caller requests the share overlay to open when showing profile, do so after render
  try {
    if (viewId === 'player-profile' && params && params.openShare) {
      // delay slightly to allow renderPlayerProfile to finish DOM updates
      setTimeout(() => {
        try { const p = (state.players||[]).find(x=>x.id===params.playerId); if (p) shareProfileDirect(p); } catch (e) { console.error('auto-shareProfileDirect failed', e); }
      }, 80);
    }
  } catch (e) { console.warn('showView openShare param handling failed', e); }
  if (viewId === 'membership') renderMembershipCard(params.playerId);
  if (viewId === 'competitions') renderCompetitionsPage();
  if (viewId === 'all-sessions') renderAllSessions(params.playerId);
  if (viewId === 'all-payments') renderAllPayments(params.playerId);
  if (viewId === 'debtors') renderDebtors();
  if (viewId === 'payment-report') renderPaymentReport();
  if (viewId === 'players-export') renderPlayersExport();
  if (viewId === 'rank-editor') {
    if (typeof renderRankEditor === 'function') {
      try { renderRankEditor(); } catch (e) { console.error('renderRankEditor threw', e); }
    } else {
      console.warn('renderRankEditor not available yet — retrying shortly');
      // Retry once after a short delay in case the function is defined later in the script
      setTimeout(() => {
        if (typeof renderRankEditor === 'function') {
          try { renderRankEditor(); } catch (e) { console.error('renderRankEditor threw on retry', e); }
        } else {
          console.error('renderRankEditor still not defined — opening Settings instead');
          showView('settings');
        }
      }, 120);
    }
  }
  if (viewId === 'event-form') renderEventForm(params.playerId, params.eventIndex);
  if (viewId === 'settings') renderSettings();
  if (viewId === 'edit-payment') renderEditPayment(params.pay);
  // اضافه کردن شرط برای ویو تبریک تولد
  if (viewId === 'birthday-greeting') renderBirthdayGreeting(params.playerId);

  // کنترل منوی پایین
  const mobileMenu = qs('#mobileMenu');
  if (['home', 'account'].includes(viewId)) {
    mobileMenu.classList.remove('hide');
    console.log('Showing mobileMenu for viewId:', viewId); // دیباگ
  } else {
    mobileMenu.classList.add('hide');
    console.log('Hiding mobileMenu for viewId:', viewId); // دیباگ
  }
  if (!mobileMenu) {
    console.error('Error: #mobileMenu not found in DOM');
    return; // خروج از تابع اگر منو پیدا نشد
  }
  console.log('viewId received:', viewId, typeof viewId);
  window.scrollTo(0, 0); // اسکرول به بالا
  if (!noPush) history.pushState({ view: viewId, params }, '', `#${viewId}`);
}
function applySettings() {
  qs('#appTitle').textContent = state.settings.title;
  qs('#appLogo').src = state.settings.logo || 'icons/logo.png';
  document.body.dataset.style = state.settings.style;
}


/* simple calculateAge helper (commented out - use calcExactAge instead)
function calculateAge(birthdate) {
  if (!birthdate) return 'نامشخص';
  const [bYear, bMonth, bDay] = birthdate.split('/').map(Number);
  const [tYear, tMonth, tDay] = todayJalali().split('/').map(Number);
  let age = tYear - bYear;
  if (tMonth < bMonth || (tMonth === bMonth && tDay < bDay)) age--;
  return age + ' سال';
}
*/

function renderHome() {
  applySettings();
  // آخرین بازیکنان
  let playersPreview = qs('#playersPreview');
  playersPreview.innerHTML = '';
  // ensure container is a no-wrap horizontal scroller and will show up to 4 items' width
  playersPreview.style.display = 'flex';
  playersPreview.style.flexWrap = 'nowrap';
  playersPreview.style.overflowX = 'auto';
  playersPreview.style.gap = '12px';
  // render newest players: show only the 4 most-recent items and let the rest be scrollable
  state.players
    .slice()
    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
    .slice(0, 4)
    .forEach(p => {
      let row = document.createElement('div');
      row.className = 'player-row';
  // rely on CSS for responsive sizing/scroll-snap; keep only semantic class
  // (removed inline flex sizing so media queries can control item width)
      row.innerHTML = `
  <div class="player-thumb">${p.photo ? `<img class="player-image" src="${p.photo}" alt="${escapeHtml(p.name)}">` : '<svg width="36" height="36" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>'}</div>
        <div class="meta"><strong>${escapeHtml(p.name)}</strong><small class="muted">${p.category || ''}</small></div>
      `;
      row.addEventListener('click', () => showView('player-profile', {playerId: p.id}));
      playersPreview.appendChild(row);
    });
    // ensure preview is touch-scrollable and compact on small screens
    try { enableHorizontalSwipeLock(); } catch (e) {}
  // enable swipe lock for better touch behavior
  try { enableHorizontalSwipeLock(); } catch (e) {}
  
    
  // رندر باکس تولد: اگر امروز کسی تولد نداشت، عنوان را به "تولدهای پیش رو" تغییر بده
  let birthdaysToday = document.querySelector('#birthdaysToday');
  birthdaysToday.innerHTML = '';
  let titleEl = document.querySelector('.birthday-card .section-title h3');
  let todayPlayers = getBirthdaysToday(); // players whose birthday is today
  let noBirthdaysMsg = document.querySelector('#noBirthdaysMsg');
  if (todayPlayers.length === 0) {
    // عنوان را به تولدهای پیش رو تغییر می‌دهیم
    if (titleEl) titleEl.textContent = 'تولدهای پیش رو';
    noBirthdaysMsg.style.display = 'none';
    // show up to 4 upcoming birthdays and make the box scrollable if there are more
    let upcoming = getUpcomingBirthdays(8).slice(0, 4);
    upcoming.forEach(p => {
      let dist = daysUntilBirthday(p.birthdate);
      let row = document.createElement('div');
      row.className = 'player-row upcoming-birthday';
      row.innerHTML = `
  <div class="player-thumb">${p.photo ? `<img class="player-image" src="${p.photo}" alt="${escapeHtml(p.name)}">` : '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>'}</div>
        <div class="meta"><strong>${escapeHtml(p.name)}</strong><small>${dist} روز مانده</small></div>
      `;
      row.addEventListener('click', () => openBirthdayModal(p.id));
      // add blue overlay layer to indicate upcoming
      let thumb = row.querySelector('.player-thumb');
      let overlay = document.createElement('div');
      overlay.className = 'birthday-overlay';
      overlay.title = 'به زودی تولد';
      thumb.style.position = 'relative';
      thumb.appendChild(overlay);
      birthdaysToday.appendChild(row);
    });
    birthdaysToday.style.overflowX = 'auto';
    try { enableHorizontalSwipeLock(); } catch (e) {}
  } else {
    if (titleEl) titleEl.textContent = 'متولدین امروز';
    noBirthdaysMsg.style.display = 'none';
    // show up to 4 birthdays today; display how many years they turned
    todayPlayers.slice(0,4).forEach(p => {
      let age = { years: '—' };
      try { age = calcExactAge(p.birthdate); } catch(e) {}
      let ageText = age && typeof age.years === 'number' ? `${age.years} ساله شد` : (p.category || '');
      let row = document.createElement('div');
      row.className = 'player-row';
      row.innerHTML = `
  <div class="player-thumb">${p.photo ? `<img class="player-image" src="${p.photo}" alt="${escapeHtml(p.name)}">` : '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>'}</div>
        <div class="meta"><strong>${escapeHtml(p.name)}</strong><small>${ageText}</small></div>
      `;
      row.addEventListener('click', () => openBirthdayModal(p.id));
      birthdaysToday.appendChild(row);
    });
    if (todayPlayers.length > 4) {
      birthdaysToday.style.overflowX = 'auto';
      try { enableHorizontalSwipeLock(); } catch (e) {}
    } else {
      birthdaysToday.style.overflowX = '';
    }
  }
  
  
  // آخرین جلسات
  let sessionsPreview = qs('#sessionsPreview');
  sessionsPreview.innerHTML = '';
    state.sessions.slice(0, 3).forEach(s => {
    let attCount = Object.values(s.attendances || {}).filter(a => a.present).length;
    let row = document.createElement('div');
    row.className = 'player-row';
    // compact layout: put attendee badge at the right side and date/category to its left
    row.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;width:100%">
        <div class="meta" style="flex:1;min-width:0"><strong>${escapeHtml(s.title || 'جلسه')}</strong><small style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${isoToJalali(s.date)} • ${s.category || '—'}</small></div>
        <div style="margin-right:12px;flex:0 0 auto"><div class="badge">${attCount} حاضر</div></div>
      </div>
    `;
    row.addEventListener('click', () => showView('session-attendance', {sessionId: s.id}));
    sessionsPreview.appendChild(row);
  });

  // باکس تمرینات برنامه‌ریزی‌شده (زیر آخرین جلسات)
  let trainingPreviewBox = qs('#trainingPreview');
  if (trainingPreviewBox) {
    trainingPreviewBox.innerHTML = '';
  // header contains add button in DOM; no dynamic insertion here

    // show up to 3 most recent plans (by date if present, else most recently added)
    let allPlans = (state.trainingPlans || []).slice();
    let last3 = allPlans.slice().sort((a,b) => {
      try {
        let da = a.date ? new Date(jalaliToISO(a.date)) : new Date(0);
        let db = b.date ? new Date(jalaliToISO(b.date)) : new Date(0);
        return db - da;
      } catch(e) { return 0; }
  }).slice(0,2);

    if (!last3 || last3.length === 0) {
      let empty = document.createElement('div'); empty.className = 'muted'; empty.textContent = 'هیچ برنامهٔ تمرینی برنامه‌ریزی نشده';
      trainingPreviewBox.appendChild(empty);
    } else {
      last3.forEach(pl => {
        let node = document.createElement('div');
        node.className = 'player-row';
        // show only first line of the body as a single-line excerpt
        let firstLine = '';
        if (pl.body) {
          firstLine = String(pl.body).split(/\r?\n/)[0] || '';
          if (firstLine.length > 80) firstLine = firstLine.slice(0,80) + '…';
        }
        node.innerHTML = `
          <div class="meta"><strong>${escapeHtml(pl.title)}</strong><small>${pl.date || ''} ${pl.time ? '• ' + pl.time : ''}</small></div>
          <div class="muted plan-excerpt">${escapeHtml(firstLine)}</div>
        `;
        // clicking the row still opens modal as before for full view
        node.addEventListener('click', () => {
          try {
            let modal = qs('#planModal');
            if (!modal) return;
            qs('#planModalTitle').textContent = pl.title || '';
            qs('#planModalDate').textContent = pl.date || '';
            qs('#planModalBody').textContent = pl.body || '';
            modal.style.display = 'flex';
          } catch(e) {}
        });
        trainingPreviewBox.appendChild(node);
      });
    }
  }

  // آخرین پرداخت‌ها
  let paymentsPreview = qs('#paymentsPreview');
  paymentsPreview.innerHTML = '';
  state.payments.slice(0, 3).forEach(pay => {
    let player = state.players.find(p => p.id === pay.playerId);
    let row = document.createElement('div');
    row.className = 'player-row';
    // show payment type before the amount
    row.innerHTML = `
      <div class="meta"><strong>${player ? escapeHtml(player.name) : '—'}</strong><small>${isoToJalali(pay.date)} • ${pay.type || '—'} • ${Number(pay.amount).toLocaleString()} تومان</small></div>
    `;
    paymentsPreview.appendChild(row);
  });

  // بیمه‌های منقضی
  let expired = qs('#expiredInsurances');
  expired.innerHTML = '';
  // compute expired players list and show up to 3 items in the preview
  let expiredPlayers = state.players.filter(p => isInsuranceExpired(p.insuranceDate));
  let totalExpired = expiredPlayers.length;
  expiredPlayers.slice(0, 3).forEach(p => {
    let row = document.createElement('div');
    row.className = 'player-row';
    row.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;width:100%">
        <div class="meta" style="flex:1;min-width:0"><strong>${escapeHtml(p.name)}</strong><small style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.insuranceDate || '—'}</small></div>
        <div style="margin-right:12px;flex:0 0 auto"><div class="badge danger" style="padding:6px 8px;font-size:12px;">منقضی</div></div>
      </div>
    `;
    expired.appendChild(row);
  });
  // if there are more than 3 expired, show a small "بیشتر" link at bottom to open players view filtered
  if (totalExpired > 3) {
    let more = document.createElement('div');
    more.style.textAlign = 'center';
    more.style.marginTop = '6px';
    more.innerHTML = `<a href="#" class="muted" style="font-size:12px;">بیشتر</a>`;
    more.querySelector('a').addEventListener('click', (e) => {
      e.preventDefault();
      try { showView('players'); } catch(e) {}
      // set the players filter to expired and re-render after view is shown
      setTimeout(() => {
        try { qs('#filterInsurance').value = 'expired'; renderPlayersPage(); } catch(e) {}
      }, 60);
    });
    expired.appendChild(more);
  }

  // آمار کلی
  try {
    let stats = qs('#statsContainer');
    if (!stats) throw new Error('#statsContainer not found in DOM');
    stats.innerHTML = '';
    let totalPlayers = (state.players || []).length;
    let totalSessions = (state.sessions || []).length;
  // per-category counts
  const counts = state.players.reduce((acc, p) => {
    const c = p.category || 'نامشخص';
    acc[c] = (acc[c] || 0) + 1;
    return acc;
  }, {});
  // compute current and previous payment sums based on paymentMonth/paymentYear fields
  const nowJ = todayJalali().split('/').map(Number); // [YYYY,MM,DD]
  const currentYear = String(nowJ[0]);
  const currentMonth = String(nowJ[1]).padStart(2, '0');

  // normalize paymentMonth which may be stored as numeric string or Persian month name
  const normalizePaymentMonth = (pm) => {
    if (!pm && pm !== 0 && pm !== '0' && pm !== '') return '';
    // try numeric
    const n = Number(pm);
    if (!isNaN(n) && n > 0) return String(n).padStart(2, '0');
    // fallback: treat as month name
    try {
      const mNum = monthNameToNumber(pm);
      return String(mNum).padStart(2, '0');
    } catch (e) {
      return '';
    }
  };

  // derive year/month from payment record — prefer explicit paymentMonth/paymentYear but
  // fallback to parsing the payment.date (ISO or Jalali) when those fields are missing.
  const getPaymentYearMonth = (pay) => {
    try {
      const pm = pay.paymentMonth;
      const py = pay.paymentYear;
      if ((pm || pm === 0 || pm === '0') && (py || py === 0 || py === '0')) {
        return { year: String(py), month: normalizePaymentMonth(pm) };
      }
      // fallback: use date field
      if (pay.date) {
        try {
          // try ISO -> jalali conversion; isoToJalali returns YYYY/MM/DD for valid ISO
          const jal = (typeof isoToJalali === 'function') ? isoToJalali(pay.date) : null;
          if (jal && String(jal).split('/').length >= 2) {
            const parts = String(jal).split('/').map(s => s.trim());
            return { year: String(parts[0]), month: String(parts[1]).padStart(2, '0') };
          }
          // if isoToJalali not available or failed, try parsing as YYYY-MM-DD or ISO
          const d = new Date(pay.date);
          if (!isNaN(d.getTime())) {
            // convert gregorian to jalali if helper exists
            if (typeof gregorian_to_jalali === 'function') {
              const g = [d.getFullYear(), d.getMonth()+1, d.getDate()];
              try {
                const j = gregorian_to_jalali(g[0], g[1], g[2]); // returns [jy,jm,jd]
                if (Array.isArray(j) && j.length >= 2) return { year: String(j[0]), month: String(j[1]).padStart(2,'0') };
              } catch (e) { /* ignore */ }
            }
            // last resort: use gregorian year/month (not ideal but better than zero)
            return { year: String(d.getFullYear()), month: String(d.getMonth()+1).padStart(2,'0') };
          }
        } catch (e) { /* ignore parse errors */ }
      }
    } catch (e) { /* ignore */ }
    return { year: '', month: '' };
  };

  // percent of players who have a payment recorded for the current period (current month/year)
  const paidPlayersThisPeriod = new Set((state.payments || []).filter(pay => {
    const ym = getPaymentYearMonth(pay);
    return ym.month === currentMonth && String(ym.year) === currentYear;
  }).map(p => p.playerId));
  const percentPaid = totalPlayers ? Math.round((paidPlayersThisPeriod.size / totalPlayers) * 100) : 0;

  // previous month handling
  let prevMonth = nowJ[1] - 1;
  let prevYear = nowJ[0];
  if (prevMonth < 1) { prevMonth = 12; prevYear -= 1; }
  const prevMonthStr = String(prevMonth).padStart(2, '0');
  const prevYearStr = String(prevYear);

  const currentSum = (state.payments || []).filter(pay => {
    const ym = getPaymentYearMonth(pay);
    return ym.month === currentMonth && String(ym.year) === currentYear;
  }).reduce((acc,p)=>acc+Number(p.amount||0),0);
  const prevSum = (state.payments || []).filter(pay => {
    const ym = getPaymentYearMonth(pay);
    return ym.month === prevMonthStr && String(ym.year) === prevYearStr;
  }).reduce((acc,p)=>acc+Number(p.amount||0),0);
  // build categories list (rows)
  // prefer a sensible order for common categories, but also include any custom categories
  const preferred = ['مینی','نونهال','نوجوان','جوانان','زیر 20 سال','امید','بزرگسال','بازیکنان'];
  const allCats = Object.keys(counts).filter(Boolean);
  // ensure we include all categories: start with preferred that exist, then append any remaining dynamic categories
  const ordered = [];
  preferred.forEach(c => { if (allCats.includes(c) && !ordered.includes(c)) ordered.push(c); });
  allCats.sort().forEach(c => { if (!ordered.includes(c)) ordered.push(c); });
  // if no categories found, show preferred defaults with zero
  if (ordered.length === 0) ordered.push(...preferred);
  let categoriesHtml = '<div class="players-by-category">';
  ordered.forEach(name => {
    const num = counts[name] || 0;
    categoriesHtml += `<div class="category-row"><div class="category-name">${escapeHtml(name)}</div><div class="category-count">${num}</div></div>`;
  });
  categoriesHtml += '</div>';

  // debug: log computed stats values to console to help diagnosis
  try { console.log('renderHome: stats', { totalPlayers, totalSessions, counts, percentPaid, currentSum, prevSum }); } catch(e){}
  // construct the new stats layout: a big players card with all detected categories
  // then render the small stat cards as direct children of the .stats grid so
  // they appear in two columns below the full-width players card.
    stats.innerHTML = `
    <div class="players-stat-card card">
      <div class="section-title"><h3>تعداد بازیکنان</h3></div>
      <div style="font-size:28px;font-weight:700;margin:8px 0;">${totalPlayers}</div>
      ${categoriesHtml}
    </div>
  <div class="stat-card card sessions-card"><div class="section-title"><h3>تعداد جلسات</h3></div><div><strong>${totalSessions}</strong></div></div>
  <div class="stat-card card percent-paid-card"><div class="section-title"><h3>درصد پرداخت‌شده</h3></div><div><strong>${percentPaid}%</strong></div></div>
  <div class="stat-card card current-income-card"><div class="section-title"><h3>درآمد دوره جاری</h3></div><div><strong>${(currentSum).toLocaleString()}</strong></div></div>
  <div class="stat-card card prev-income-card"><div class="section-title"><h3>درآمد دوره قبل</h3></div><div><strong>${(prevSum).toLocaleString()}</strong></div></div>
    `;
  } catch (err) {
    try { console.error('renderHome: stats render failed', err); } catch(e){}
    try {
      const stats = qs('#statsContainer');
      if (stats) stats.innerHTML = `<div class="muted" style="padding:12px">خطا در بارگذاری آمار: ${escapeHtml(String(err && err.message ? err.message : err))}</div>`;
    } catch(e){}
  }

}

function renderBirthdayGreeting(playerId) {
  let content = qs('#birthdayGreetingContent');
  let p = state.players.find(x => x.id === playerId); // فرض: state.players آرایه بازیکن‌هاست
  if (!p) return showView('home'); // اگه بازیکن پیدا نشد، برگرد به خانه

  let age = calcExactAge(p.birthdate);
  let greetingMsg = `تولدت مبارک ${p.name}! حالا ${age.years} ساله شدی. امیدوارم سالی پر از موفقیت در والیبال داشته باشی! 🎉`;

  content.innerHTML = `
    <div style="padding: 16px; background: linear-gradient(135deg, #FF6B6B, #FFD700); border-radius: 16px; color: #fff; animation: pulse 1.5s infinite;">
      <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; margin: 0 auto;">
  ${p.photo ? `<img class="player-image" src="${p.photo}" style="width: 100%; height: 100%; object-fit: cover;" alt="${p.name}">` : '<div>بدون عکس</div>'}
      </div>
      <h2 style="margin-top: 12px;">${greetingMsg}</h2>
      <div class="form-actions" style="margin-top: 16px;">
        <button id="shareBirthday" class="btn primary">اشتراک‌گذاری</button>
        <button id="closeBirthday" class="btn">بستن</button>
      </div>
    </div>
  `;

  on('#closeBirthday', 'click', () => showView('home'));
  on('#backBirthdayGreeting', 'click', () => { if (!goBack()) showView('home'); });
  on('#shareBirthday', 'click', () => {
    html2canvas(content).then(canvas => {
      let imgData = canvas.toDataURL('image/png');
      if (navigator.share) {
        fetch(imgData).then(res => res.blob()).then(blob => {
          navigator.share({
            files: [new File([blob], 'birthday.png', { type: 'image/png' })],
            title: 'تبریک تولد',
            text: greetingMsg
          });
        });
      } else {
        let a = document.createElement('a');
        a.href = imgData;
        a.download = 'birthday.png';
        a.click();
      }
    });
  });
}

function populateCategoryFilter(select) {
  if (!select) return;
  // preserve current selection if any
  const current = select.value || '';
  let categories = [...new Set(state.players.map(p => p.category))].filter(Boolean);
  select.innerHTML = '<option value="">همه رده‌ها</option>' + categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
  // try to restore previous selection; if missing, keep it blank
  try { if (current) select.value = current; } catch(e) { /* ignore */ }
}

function populateCategoriesFromRanks(select, firstOptionText = 'انتخاب رده', selected = ''){
  if (!select) return;
  const ranks = (state.settings && state.settings.ranks && state.settings.ranks.length) ? state.settings.ranks : defaultRanks;
  // If this is the player form category select, append the age range (e.g., از X تا Y) to each option label
  let opts = ranks.map(r => {
    const labelBase = escapeHtml(r.name);
    const rangeText = (typeof r.minAgeYears === 'number' || typeof r.maxAgeYears === 'number') ? ` از ${r.minAgeYears ?? '-'} تا ${r.maxAgeYears ?? '-'} ` : '';
    const label = (select && select.id === 'p_category') ? `${labelBase} ${rangeText}` : labelBase;
    return `<option value="${escapeHtml(r.name)}" ${selected === r.name ? 'selected' : ''}>${label}</option>`;
  }).join('');
  opts += `<option value="نامشخص" ${selected === 'نامشخص' ? 'selected' : ''}>نامشخص</option>`;
  select.innerHTML = `<option value="">${firstOptionText}</option>` + opts;
}

function refreshCategorySelects(){
  // try to update common selects if they exist in DOM
  populateCategoriesFromRanks(qs('#p_category'), 'انتخاب رده');
  populateCategoriesFromRanks(qs('#sessionCategory'), 'همه رده‌ها');
  populateCategoriesFromRanks(qs('#filterCategory'), 'همه رده‌ها');
  populateCategoriesFromRanks(qs('#reportCategory'), 'همه رده‌ها');
  populateCategoriesFromRanks(qs('#exportCategory'), 'همه رده‌ها');
  populateCategoriesFromRanks(qs('#insuranceCategoryFilter'), 'همه رده‌ها');
}

function populateCoachSelect(select) {
  select.innerHTML = '<option value="">بدون مربی</option>' + state.coaches.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
}

function populateSessionPrivateClassSelect(targetSelector) {
  // populate one or both selects used across the app
  const selectors = targetSelector ? [targetSelector] : ['#sessionPrivateClass', '#reportPrivateClass'];
  selectors.forEach(selId => {
    let sel = qs(selId);
    if (!sel) return;
    sel.innerHTML = '<option value="">انتخاب کلاس خصوصی</option>';
    (state.privateClasses || []).forEach(cl => {
      let opt = document.createElement('option'); opt.value = cl.id; opt.textContent = cl.title || 'کلاس'; opt.dataset.coach = cl.coachId || '';
      sel.appendChild(opt);
    });
  });
}

function populatePaymentMonthYear(monthId = 'paymentMonth', yearId = 'paymentYear') {
  let monthSelect = qs('#' + monthId);
  let months = ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'];
  monthSelect.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');
  let yearSelect = qs('#' + yearId);
  let currentYear = parseInt(todayJalali().split('/')[0]);
  yearSelect.innerHTML = '';
  for (let y = currentYear - 2; y <= currentYear + 10; y++) {
    let opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    if (y === currentYear) opt.selected = true;
    yearSelect.appendChild(opt);
  }
}

function populatePaymentPlayerSelect(search = '') {
  let select = qs('#paymentPlayer');
  let q = normPersian(search);
  let filtered = state.players.filter(p => normPersian(p.name).includes(q));
  select.innerHTML = '<option value="">انتخاب بازیکن</option>' + filtered.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
}

function renderPlayersPage() {
  let list = qs('#playersList');
  list.innerHTML = '';
  let qRaw = qs('#playersSearch').value || '';
  let q = normPersian(qRaw);
  let qDigits = digitsToAscii(q);
  let cat = qs('#filterCategory').value;
  let ins = qs('#filterInsurance').value;
  // BMI filter (single select)
  let bmiSelected = qs('#filterBmi') ? qs('#filterBmi').value : '';
  let sort = qs('#sortPlayers').value;
  let arr = state.players.slice();
  if (q) {
    arr = arr.filter(p => {
      const hay = playerSearchable(p);
      // match either normalized text or normalized digits (phone/id)
      return hay.includes(q) || hay.includes(qDigits);
    });
  }
  if (cat) {
    arr = arr.filter(p => {
      let cats = [];
      if (Array.isArray(p.category)) cats = p.category.slice();
      else if (typeof p.category === 'string' && p.category.indexOf(',') !== -1) cats = p.category.split(',').map(s=>s.trim());
      else if (p.category) cats = [p.category];
      else if (p.categories) cats = Array.isArray(p.categories) ? p.categories : String(p.categories).split(',').map(s=>s.trim());
      cats = cats.map(c => normPersian(String(c||'')));
      const catNorm = normPersian(cat);
      return cats.some(c => c === catNorm || c.includes(catNorm));
    });
  }
  if (bmiSelected) {
    arr = arr.filter(p => {
      let bmiData = calculateBMI(p.height, p.weight);
      let status = bmiData ? bmiData.status : null;
      return status === bmiSelected;
    });
  }
  if (ins === 'expired') arr = arr.filter(p => isInsuranceExpired(p.insuranceDate));
  if (sort === 'new') arr.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  if (sort === 'score') arr.sort((a, b) => calcAverageScore(b) - calcAverageScore(a));
  if (sort === 'name') arr.sort((a, b) => a.name.localeCompare(b.name));
  arr.forEach(p => {
    console.debug('[renderPlayersPage] player', p.id, p.name, 'gender=', p.gender, 'photo=', p.photo);
    let node = document.createElement('div');
    node.className = 'player-row player-card';
    // determine placeholder based on gender
    let placeholder = p.gender === 'female' ? './icons/volleyball-player (3).png' : './icons/volleyball-player (4).png';
    let imgSrc = p.photo || placeholder;
    let avgScore = calcAverageScore(p);
    const ageObj = p.birthdate ? (() => { try { return calcExactAge(p.birthdate); } catch(e){ return null; } })() : null;
    const ageText = ageObj && ageObj.years ? (ageObj.years + ' سال') : '—';
    // If a BMI filter is active, show health summary instead of action buttons
    if (bmiSelected) {
      const bmiData = calculateBMI(p.height, p.weight) || {bmi: '—', status: '—', color: '#cbd5e1', percent: 0};
      node.innerHTML = `
      <div style="display:flex;gap:12px;align-items:stretch;justify-content:space-between;padding:10px;">
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;min-width:0;flex:1;">
          <div class="player-thumb list-thumb">
            <img src="${imgSrc}" />
          </div>
            <div class="player-info-block" style="text-align:center;">
            <div class="player-name" style="font-weight:700;">${escapeHtml(p.name)}</div>
            <div style="font-size:13px;color:var(--muted);">${p.category || '—'} • ${ageText}</div>
          </div>
        </div>
        <div class="action-buttons" style="display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;flex:0 0 200px;">
          <div style="text-align:center;font-weight:700;">وضعیت سلامت</div>
          <div style="font-size:13px;color:var(--muted);">قد: ${p.height || '—'} cm</div>
          <div style="font-size:13px;color:var(--muted);">وزن: ${p.weight || '—'} kg</div>
          <div style="font-size:13px;color:var(--muted);">BMI: ${bmiData.bmi}</div>
          <div style="font-size:13px;color:var(--muted);">${bmiData.status}</div>
          <div style="width:90%;height:8px;background:#eef2ff;border-radius:6px;overflow:hidden;margin-top:6px;">
            <div style="width:${bmiData.percent}%;height:100%;background:${bmiData.color};border-radius:6px;"></div>
          </div>
        </div>
      </div>
      `;
    } else {
      node.innerHTML = `
      <div style="display:flex;gap:12px;align-items:stretch;justify-content:space-between;padding:10px;">
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;min-width:0;flex:1;">
          <div class="player-thumb list-thumb">
            <img src="${imgSrc}" />
          </div>
          <div class="player-info-block" style="text-align:center;">
            <div class="player-name" style="font-weight:700;">${escapeHtml(p.name)}</div>
            <div style="font-size:13px;color:var(--muted);">${p.category || '—'} • امتیاز: ${avgScore} • ${ageText}</div>
          </div>
        </div>
        <div class="action-buttons" style="display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;flex:0 0 200px;">
          <button class="btn small profile-btn" style="min-width:140px;">پروفایل</button>
          <button class="btn small pay-btn" style="min-width:140px;">پرداخت</button>
          <button class="btn small edit-btn" style="min-width:140px;">ویرایش</button>
          <button class="btn small danger del-btn" style="min-width:140px;">حذف</button>
        </div>
      </div>
      `;
    }
    const profileBtn = node.querySelector('.profile-btn');
    const payBtn = node.querySelector('.pay-btn');
    const editBtn = node.querySelector('.edit-btn');
    const delBtn = node.querySelector('.del-btn');
    // thumbnail click should open profile in all modes
    const thumb = node.querySelector('.player-thumb');
    if (thumb) thumb.addEventListener('click', () => showView('player-profile', {playerId: p.id}));
    if (profileBtn) profileBtn.addEventListener('click', () => showView('player-profile', {playerId: p.id}));
    if (payBtn) payBtn.addEventListener('click', () => openPaymentModal(p.id));
    if (editBtn) editBtn.addEventListener('click', () => showView('player-form', {player: p}));
    if (delBtn) delBtn.addEventListener('click', () => {
      if (confirm('حذف شود؟')) {
        state.players = state.players.filter(x => x.id !== p.id);
        state.sessions.forEach(s => { if (s.attendances) delete s.attendances[p.id]; });
        state.payments = state.payments.filter(x => x.playerId !== p.id);
        saveState();
        renderPlayersPage();
        renderHome();
      }
    });
    list.appendChild(node);
  });
  populateCategoryFilter(qs('#filterCategory'));
}

// Add a touch-direction handler so horizontal swipes inside .players-preview
// prevent the page from vertically scrolling on browsers/webviews that ignore
// touch-action CSS. This is a small, conservative handler that only calls
// preventDefault when the gesture is clearly horizontal.
function enableHorizontalSwipeLock() {
  let containers = document.querySelectorAll('.players-preview');
  containers.forEach(container => {
    let startX = 0, startY = 0, locked = false;
    const threshold = 5; // px before we consider it a move
    function onStart(e) {
      if (!e.touches || e.touches.length !== 1) return;
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      locked = false;
    }
    function onMove(e) {
      if (!e.touches || e.touches.length !== 1) return;
      const dx = e.touches[0].clientX - startX;
      const dy = e.touches[0].clientY - startY;
      if (locked) {
        // we already determined it's horizontal
        e.preventDefault();
        return;
      }
      if (Math.abs(dx) > Math.abs(dy) + threshold) {
        locked = true;
        // prevent the page from scrolling vertically while user is
        // performing a horizontal pan inside the container
        e.preventDefault();
      }
    }
    function onEnd() { startX = startY = 0; locked = false; }
    container.addEventListener('touchstart', onStart, {passive: true});
    container.addEventListener('touchmove', onMove, {passive: false});
    container.addEventListener('touchend', onEnd, {passive: true});
    container.addEventListener('touchcancel', onEnd, {passive: true});
  });
}

function calcAverageScore(player) {
  let scores = Object.values(player.scores || {});
  return scores.length ? (scores.reduce((a, b) => a + Number(b), 0) / scores.length).toFixed(1) : 0;
}

function renderCoaches() {
  let list = qs('#coachesList');
  list.innerHTML = '';
  state.coaches.forEach(c => {
    let node = document.createElement('div');
    node.className = 'coach-card';
    const photoHtml = c.photo ? `<img src="${c.photo}" alt="${escapeHtml(c.name)}">` : `<div class="avatar-placeholder-outer"><div class="avatar-placeholder-inner"></div></div>`;
    const classes = (state.privateClasses || []).filter(cl => cl.coachId === c.id);
    // normalize instagram handle / url and prepare date fields
    let instaHandle = (c.instagram || '').toString().trim();
    let instaHref = '';
    if (instaHandle) {
      if (/^https?:\/\//i.test(instaHandle)) {
        instaHref = instaHandle;
      } else {
        instaHandle = instaHandle.replace(/^@+/, '');
        instaHref = 'https://instagram.com/' + encodeURIComponent(instaHandle);
      }
    }
    const birth = c.birthdate || c.birth || '';
    const start = c.startDate || c.start || '';

    node.innerHTML = `
      <div class="coach-top">
        <div class="coach-thumb">${photoHtml}</div>
        <div class="coach-body">
          <div class="coach-name">${escapeHtml(c.name)}</div>
          <div class="coach-sub">${escapeHtml(c.title || '')} ${c.phone ? '• ' + escapeHtml(c.phone) : ''}</div>
          ${ (birth || start) ? `<div class="coach-dates muted-small">${birth ? 'تولد: ' + escapeHtml(birth) : ''}${birth && start ? ' • ' : ''}${start ? 'شروع: ' + escapeHtml(start) : ''}</div>` : '' }
          <div class="coach-meta">
            ${c.email ? `<a href="mailto:${escapeHtml(c.email)}" class="coach-link">✉ ${escapeHtml(c.email)}</a>` : ''}
            ${instaHandle ? `<a href="${instaHref}" target="_blank" rel="noopener noreferrer" class="coach-link" style="margin-left:6px">📸 @${escapeHtml(instaHandle)}</a>` : ''}
          </div>
          ${classes && classes.length ? `<div class="coach-class"><svg width="14" height="14" viewBox="0 0 24 24" style="vertical-align:middle"><path d="M12 2l7 4v6c0 5-4 9-7 10-3-1-7-5-7-10V6l7-4z" fill="currentColor"/></svg> ${classes.map(cl=>`<a href="#" class="class-link" data-id="${cl.id}" style="margin-left:8px">${escapeHtml(cl.title || 'کلاس')}</a>`).join('')}</div>` : ''}
        </div>
      </div>
      <div class="coach-actions">
        <button class="btn small add-class">افزودن کلاس خصوصی</button>
        <button class="btn small edit-coach">ویرایش</button>
        <button class="btn small danger del-coach">حذف</button>
      </div>
    `;
    node.querySelector('.add-class').addEventListener('click', () => showView('private-class', { coachId: c.id }));
  node.querySelectorAll('.class-link').forEach(el => el.addEventListener('click', (ev) => { ev.preventDefault(); const id = ev.currentTarget.dataset.id; showView('private-class', { coachId: c.id, classId: id }); }));
    node.querySelector('.edit-coach').addEventListener('click', () => showView('coach-form', {coach: c}));
    node.querySelector('.del-coach').addEventListener('click', () => {
      if (confirm('حذف شود؟')) {
        state.coaches = state.coaches.filter(x => x.id !== c.id);
        state.sessions.forEach(s => { if (s.coachId === c.id) s.coachId = null; });
        saveState();
        renderCoaches();
      }
    });
    list.appendChild(node);
  });
  populateCoachSelect(qs('#sessionCoach'));
}

function renderSessionsPage() {
  // render manage sessions tab
  let managePanel = qs('#tabManageSessionsPanel');
  let list = managePanel ? managePanel.querySelector('#sessionsList') : qs('#sessionsList');
  if (!list) return;
  list.innerHTML = '';
  state.sessions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(s => {
    let attCount = Object.values(s.attendances || {}).filter(a => a.present).length;
    let coach = state.coaches.find(c => c.id === s.coachId);
    let node = document.createElement('div');
    node.className = 'player-row';
    node.innerHTML = `
      <div class="meta"><strong>${escapeHtml(s.title || 'جلسه')}</strong><small>${isoToJalali(s.date)} • ${s.category || '—'} • مربی: ${coach ? escapeHtml(coach.name) : '—'}</small></div>
      <div style="display:flex;gap:8px;align-items:center;">
        <div class="badge">${attCount} حاضر</div>
        <button class="btn small att-btn">حضورغیاب</button>
        <button class="btn small danger del-sess">حذف</button>
      </div>
    `;
    node.querySelector('.att-btn').addEventListener('click', () => showView('session-attendance', {sessionId: s.id}));
    node.querySelector('.del-sess').addEventListener('click', () => {
      if (confirm('حذف شود؟')) {
        state.sessions = state.sessions.filter(x => x.id !== s.id);
        saveState();
        renderSessionsPage();
        renderHome();
      }
    });
    list.appendChild(node);
  });
  populateCategoryFilter(qs('#sessionCategory'));
  populateCoachSelect(qs('#sessionCoach'));

  // render training plan tab (upcoming sessions)
  let planPanel = qs('#tabTrainingPlanPanel');
  if (planPanel) {
    let planList = planPanel.querySelector('#trainingPlanList');
    planList.innerHTML = '';
    // upcoming sessions: date >= today
    let today = new Date();
    state.sessions
      .slice()
      .filter(s => new Date(s.date) >= today)
      .sort((a,b) => new Date(a.date) - new Date(b.date))
      .forEach(s => {
        let coach = state.coaches.find(c => c.id === s.coachId);
        let item = document.createElement('div');
        item.className = 'player-row';
        let reminderKey = `reminder_${s.id}`;
        let reminderOn = localStorage.getItem(reminderKey) === '1';
        item.innerHTML = `
          <div class="meta"><strong>${escapeHtml(s.title || 'جلسه')}</strong><small>${isoToJalali(s.date)} • ${s.category || '—'} • مربی: ${coach ? escapeHtml(coach.name) : '—'}</small></div>
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" class="reminder-toggle" data-id="${s.id}" ${reminderOn? 'checked' : ''} /> یادآوری
            </label>
            <button class="btn small" data-id="${s.id}">ویرایش برنامه</button>
          </div>
        `;
        planList.appendChild(item);
      });

      // render saved training plan notes inside the training tab
      let trainingNotes = planPanel.querySelector('#trainingPlanList');
      if (trainingNotes) {
        // prepend session-derived items are already there; now list explicit plans
        (state.trainingPlans || []).forEach(pl => {
          let plNode = document.createElement('div');
          plNode.className = 'player-row';
          plNode.id = `planItem-${pl.id}`;
          plNode.innerHTML = `
            <div class="meta"><strong>${escapeHtml(pl.title)}</strong><small>${pl.date || ''}</small></div>
            <div class="muted">${escapeHtml((pl.body||'').slice(0,120))}${(pl.body||'').length>120? '…' : ''}</div>
            <div style="margin-top:6px;display:flex;gap:8px;">
              <button class="btn small view-plan" data-id="${pl.id}">مشاهده</button>
              <button class="btn small edit-plan" data-id="${pl.id}">ویرایش</button>
              <button class="btn small danger del-plan" data-id="${pl.id}">حذف</button>
            </div>
            <div class="plan-full" style="display:none;margin-top:8px;border-top:1px dashed rgba(0,0,0,0.06);padding-top:8px;">${escapeHtml(pl.body || '')}</div>
          `;
          trainingNotes.appendChild(plNode);
        });

      // populate coach select inside the plan tab
      try { populateCoachSelect(planPanel.querySelector('#planCoach')); } catch(e) {}
      try { populateCoachSelect(qs('#trainingFormModal')?.querySelector('#planCoach')); } catch(e) {}
      // populate hour select (00-23)
      try {
        let ph = planPanel.querySelector('#planHour');
        if (ph) {
          ph.innerHTML = Array.from({length:24}).map((_,i)=>{const v=('0'+i).slice(-2); return `<option value="${v}">${v}</option>`}).join('');
        }
        // also populate modal hour select if present
        try {
          let mph = qs('#trainingFormModal')?.querySelector('#planHour');
          if (mph) {
            mph.innerHTML = Array.from({length:24}).map((_,i)=>{const v=('0'+i).slice(-2); return `<option value="${v}">${v}</option>`}).join('');
          }
          // populate modal minute select (00,15,30,45)
          try {
            let mpm = qs('#trainingFormModal')?.querySelector('#planMinute');
            if (mpm) {
              mpm.innerHTML = ['00','15','30','45'].map(v => `<option value="${v}">${v}</option>`).join('');
            }
          } catch(e) {}
        } catch(e) {}
      } catch(e) {}

      // attach view handlers
        // view/edit/delete handlers
  trainingNotes.querySelectorAll('.view-plan').forEach(b => b.addEventListener('click', (e) => {
          let id = e.currentTarget.dataset.id;
          let pl = (state.trainingPlans||[]).find(x => x.id === id);
          if (!pl) return;
          // open modal with full content
          let modal = qs('#planModal');
          if (!modal) return;
          qs('#planModalTitle').textContent = pl.title;
          qs('#planModalDate').textContent = pl.date || '';
          qs('#planModalBody').textContent = pl.body || '';
          modal.style.display = 'flex';
        }));
  trainingNotes.querySelectorAll('.del-plan').forEach(b => b.addEventListener('click', (e) => {
          let id = e.currentTarget.dataset.id;
          if (!confirm('حذف شود؟')) return;
          state.trainingPlans = (state.trainingPlans||[]).filter(x => x.id !== id);
          saveState();
          renderSessionsPage();
          showToast('یادداشت حذف شد');
        }));
  trainingNotes.querySelectorAll('.edit-plan').forEach(b => b.addEventListener('click', (e) => {
          let id = e.currentTarget.dataset.id;
          let pl = (state.trainingPlans||[]).find(x => x.id === id);
          if (!pl) return;
          console.debug('[plan] edit clicked, populate form with plan', id, pl && pl.title);
          // prefer populating the modal form if present, else fallback to tab panel
          let root = qs('#trainingFormModal') || planPanel || document;
          try { root.querySelector('#planTitle').value = pl.title; } catch(e) {}
          try { root.querySelector('#planDate').value = pl.date || ''; } catch(e) {}
          // populate hour/minute selects from stored time if present
          if (pl.time) {
            let parts = String(pl.time).split(':');
            try { root.querySelector('#planHour').value = parts[0].padStart(2,'0'); } catch(e) {}
            try { root.querySelector('#planMinute').value = (parts[1] || '00').padStart(2,'0'); } catch(e) {}
          } else {
            try { root.querySelector('#planHour').value = '09'; } catch(e) {}
            try { root.querySelector('#planMinute').value = '00'; } catch(e) {}
          }
          try { root.querySelector('#planBody').value = pl.body || ''; } catch(e) {}
          try { root.querySelector('#planCoach').value = pl.coachId || ''; } catch(e) {}
          try { root.querySelector('#planReminderMode').value = pl.reminder || 'none'; } catch(e) {}
          // set save button into edit mode
          let saveBtn = (qs('#trainingFormModal')?.querySelector('#savePlanBtn')) || planPanel.querySelector('#savePlanBtn') || qs('#savePlanBtn');
          if (saveBtn) saveBtn.dataset.editId = pl.id;
          // open modal (preferred) and focus textarea there
          if (typeof openTrainingFormModal === 'function') {
            openTrainingFormModal(pl.id);
            setTimeout(() => {
              try {
                let el = qs('#trainingFormModal')?.querySelector('#planBody');
                if (el) {
                  el.focus();
                  el.setSelectionRange(el.value.length, el.value.length);
                }
              } catch(e) {}
            }, 120);
          } else {
            // fallback: switch to the training tab and focus the in-tab body
            try { qs('#tabTrainingPlan').click(); } catch(e) {}
            setTimeout(() => {
              try {
                let el = planPanel.querySelector('#planBody') || qs('#planBody');
                if (el) {
                  el.focus();
                  el.setSelectionRange(el.value.length, el.value.length);
                }
              } catch(e) {}
            }, 200);
          }
          showToast('حالا می‌توانید تغییرات را ذخیره کنید');
        }));
      }

    // attach reminder toggle handlers
    planPanel.querySelectorAll('.reminder-toggle').forEach(cb => {
      cb.addEventListener('change', (e) => {
        let id = e.currentTarget.dataset.id;
        let key = `reminder_${id}`;
        if (e.currentTarget.checked) {
          localStorage.setItem(key, '1');
          // optionally schedule Notification if permissions
          if (window.Notification && Notification.permission === 'granted') {
            Notification.requestPermission();
          }
        } else {
          localStorage.removeItem(key);
        }
      });
    });
  }

  // Close plan modal handler
  try {
    on('#closePlanModal', 'click', () => {
      let modal = qs('#planModal');
      if (modal) modal.style.display = 'none';
    });
  } catch(e) {}

  // tab switching handlers
  try {
    on('#tabManageSessions', 'click', () => {
      qs('#tabManageSessionsPanel').style.display = '';
      qs('#tabTrainingPlanPanel').style.display = 'none';
      qs('#tabManageSessions').style.borderBottom = '2px solid #6366f1';
      qs('#tabTrainingPlan').style.borderBottom = 'none';
      try { qs('#fabSession').style.display = ''; } catch(e) {}
      try { qs('#fabTraining').style.display = 'none'; } catch(e) {}
    });
    on('#tabTrainingPlan', 'click', () => {
      qs('#tabManageSessionsPanel').style.display = 'none';
      qs('#tabTrainingPlanPanel').style.display = '';
      qs('#tabTrainingPlan').style.borderBottom = '2px solid #6366f1';
      qs('#tabManageSessions').style.borderBottom = 'none';
      try { qs('#fabSession').style.display = 'none'; } catch(e) {}
      try { qs('#fabTraining').style.display = ''; } catch(e) {}
    });
  } catch (e) { console.error(e); }
}

// handlers for training plan creation saved in state.trainingPlans
try {
  on('#savePlanBtn', 'click', () => {
  // scope all plan inputs to the training form modal if open, else training tab panel
  let planRoot = qs('#trainingFormModal') || qs('#tabTrainingPlanPanel') || document;
  let title = planRoot.querySelector('#planTitle')?.value?.trim();
  let date = planRoot.querySelector('#planDate')?.value?.trim();
  let hour = (planRoot.querySelector('#planHour') && planRoot.querySelector('#planHour').value) ? planRoot.querySelector('#planHour').value : '09';
  let minute = (planRoot.querySelector('#planMinute') && planRoot.querySelector('#planMinute').value) ? planRoot.querySelector('#planMinute').value : '00';
  let time = `${hour}:${minute}`;
  let coachId = planRoot.querySelector('#planCoach')?.value || '';
  let body = planRoot.querySelector('#planBody')?.value?.trim();
  let reminderMode = planRoot.querySelector('#planReminderMode')?.value || 'none';
    if (!title) return showToast('عنوان تمرین را وارد کنید');
    state.trainingPlans = state.trainingPlans || [];
    let editId = qs('#savePlanBtn').dataset.editId;
    if (editId) {
      // update existing
      let idx = state.trainingPlans.findIndex(x => x.id === editId);
      if (idx > -1) {
        state.trainingPlans[idx] = { ...state.trainingPlans[idx], title, date, time, coachId, body, reminder: reminderMode, updatedAt: new Date().toISOString() };
      }
      try { delete qs('#savePlanBtn').dataset.editId; } catch(e) {}
    } else {
      let plan = { id: uid('tp'), title, date, time, coachId, body, reminder: reminderMode, createdAt: new Date().toISOString() };
      state.trainingPlans.unshift(plan);
    }
    saveState();
  renderSessionsPage();
    // immediate defensive clear (run synchronously) to remove any lingering values
    try {
      const names = ['planTitle','planDate','planHour','planMinute','planCoach','planBody','planReminderMode'];
      names.forEach(name => {
        try {
          const nodes = document.querySelectorAll('#' + name);
          nodes.forEach(el => {
            if (!el) return;
            const tag = (el.tagName || '').toUpperCase();
            if (tag === 'SELECT') {
              if (name === 'planHour' || name === 'planMinute') el.value = '00';
              else if (name === 'planReminderMode') el.value = 'none';
              else el.selectedIndex = 0;
            } else if (tag === 'INPUT' || tag === 'TEXTAREA') {
              if (name === 'planHour' || name === 'planMinute') el.value = '00';
              else if (name === 'planReminderMode') el.value = 'none';
              else el.value = '';
            } else {
              try { el.textContent = ''; } catch(e) {}
            }
          });
        } catch(e){}
      });
      try { let sb = qs('#savePlanBtn'); if (sb && sb.dataset && sb.dataset.editId) delete sb.dataset.editId; } catch(e) {}
    } catch(e) {}
  showToast('یادداشت تمرین ذخیره شد');
  // close training modal if open and navigate to sessions->training tab so user sees the plan
  try { let tfm = qs('#trainingFormModal'); if (tfm) { tfm.classList.add('hide'); tfm.style.display = 'none'; tfm.setAttribute('aria-hidden','true'); } } catch(e){}
  try { showView('sessions'); setTimeout(()=>{ try{ qs('#tabTrainingPlan').click(); }catch(e){} }, 40); } catch(e){}
  // clear inputs and hide any open modal
  try { if (planRoot.querySelector('#planTitle')) planRoot.querySelector('#planTitle').value = ''; } catch(e) {}
  try { if (planRoot.querySelector('#planDate')) planRoot.querySelector('#planDate').value = ''; } catch(e) {}
  try { if (planRoot.querySelector('#planHour')) planRoot.querySelector('#planHour').value = '00'; } catch(e) {}
  try { if (planRoot.querySelector('#planMinute')) planRoot.querySelector('#planMinute').value = '00'; } catch(e) {}
  try { if (planRoot.querySelector('#planCoach')) planRoot.querySelector('#planCoach').value = ''; } catch(e) {}
  try { if (planRoot.querySelector('#planBody')) planRoot.querySelector('#planBody').value = ''; } catch(e) {}
  try { if (planRoot.querySelector('#planReminderMode')) planRoot.querySelector('#planReminderMode').value = 'none'; } catch(e) {}
  try { let modal = qs('#planModal'); if (modal) { modal.style.display = 'none'; qs('#planModalTitle').textContent = ''; qs('#planModalDate').textContent = ''; qs('#planModalBody').textContent = ''; } } catch(e) {}
  try { let tfm = qs('#trainingFormModal'); if (tfm) { tfm.style.display = 'none'; } } catch(e) {}
  // defensive clear: rerun clear shortly after render in case something repopulates the form
  setTimeout(() => {
    try {
      const ids = ['planTitle','planDate','planHour','planMinute','planCoach','planBody','planReminderMode'];
      ids.forEach(name => {
        try {
          // clear all elements that mistakenly share the same id (duplicate-ID situation)
          const nodes = document.querySelectorAll('#' + name);
          nodes.forEach(el => {
            if (!el) return;
            const tag = (el.tagName || '').toUpperCase();
            if (tag === 'SELECT') {
              if (name === 'planHour' || name === 'planMinute') el.value = '00';
              else if (name === 'planReminderMode') el.value = 'none';
              else el.selectedIndex = 0;
            } else if (tag === 'INPUT' || tag === 'TEXTAREA') {
              if (name === 'planHour' || name === 'planMinute') el.value = '00';
              else if (name === 'planReminderMode') el.value = 'none';
              else el.value = '';
            } else {
              // fallback: clear textContent if present
              try { el.textContent = ''; } catch(e) {}
            }
          });
        } catch (e) {}
      });
      try { let sb = qs('#savePlanBtn'); if (sb && sb.dataset && sb.dataset.editId) delete sb.dataset.editId; } catch(e) {}
      console.debug('[plan] post-clear run (all ids): planBody=', Array.from(document.querySelectorAll('#planBody')).map(n=>n.value || n.textContent));
    } catch(e) { console.error('[plan] post-clear error', e); }
  }, 120);
  // debug: log form state after save/clear to trace lingering values
  try { console.debug('[plan] after save: editId cleared, planTitle=', qs('#planTitle')?.value, 'planDate=', qs('#planDate')?.value, 'planHour=', qs('#planHour')?.value, 'planMinute=', qs('#planMinute')?.value, 'planCoach=', qs('#planCoach')?.value, 'planBody=', qs('#planBody')?.value); } catch(e) {}
  });
} catch(e) {}

try { on('#createTrainingPlan', 'click', () => { qs('#tabTrainingPlan').click(); window.scrollTo(0,0); }); } catch(e) {}
try { on('#addTrainingFromHomeBtn', 'click', () => {
    try { if (typeof openTrainingFormModal === 'function') return openTrainingFormModal(); } catch(e){}
    // fallback: navigate to sessions view so renderSessionsPage runs and binds tab handlers
    try { showView('sessions'); } catch(e) {}
    // give renderSessionsPage a tick then activate the training tab
    setTimeout(() => {
      try { qs('#tabTrainingPlan').click(); } catch(e) {}
      try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch(e) {}
      setTimeout(() => {
        try {
          let root = qs('#tabTrainingPlanPanel') || document;
          let el = root.querySelector('#planTitle') || root.querySelector('#planBody') || qs('#planTitle');
          if (el) { el.focus(); if (el.select) el.select(); }
        } catch(e) {}
      }, 120);
    }, 40);
  }); } catch(e) {}

function addPayment(dateStr, amount, type, pMonth, pYear, playerId) {
  if (!playerId) return alert('بازیکن را انتخاب کنید');
  if (!amount) return alert('مبلغ را وارد کنید');
  // If payment month/year not provided, derive from the Jalali date string (YYYY/MM/DD)
  try {
    if (!pMonth || !pYear) {
      const parts = (dateStr || todayJalali()).split('/').map(s => s && s.trim());
      if (parts.length >= 2) {
        pYear = pYear || parts[0];
        pMonth = pMonth || parts[1];
      }
    }
  } catch (e) {
    // fallback: leave pMonth/pYear as-is
  }

  // normalize month to two digits and year to string
  const paymentMonthNorm = String(pMonth || '').padStart(2, '0');
  const paymentYearNorm = String(pYear || '');

  let pay = {
    id: uid('pay'), playerId, date: jalaliToISO(dateStr), amount, paymentMonth: paymentMonthNorm, paymentYear: paymentYearNorm, type,
    createdAt: new Date().toISOString()
  };
  state.payments.unshift(pay);
  saveState();
  renderPaymentsPage();
  // close payment modal if open, navigate to payments view and show toast
  try { let m = qs('#paymentModal'); if (m) { m.classList.add('hide'); m.style.display='none'; m.setAttribute('aria-hidden','true'); } } catch(e){}
  try { showView('payments'); } catch(e){}
  try { showToast('پرداخت ثبت شد'); } catch(e){}
}

function renderPaymentsPage() {
  let list = qs('#paymentList');
  list.innerHTML = '';
  state.payments.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(pay => {
    let player = state.players.find(p => p.id === pay.playerId);
    let node = document.createElement('div');
    node.className = 'transaction-card';
    node.innerHTML = `
      <div class="transaction-info">
        <div>
          <strong>${player ? escapeHtml(player.name) : '—'}</strong>
          <div class="transaction-meta">${isoToJalali(pay.date)} • ${Number(pay.amount).toLocaleString()} تومان • دوره: ${pay.paymentMonth}/${pay.paymentYear}</div>
        </div>
        </div>
        <div class="transaction-meta" style="min-width:80px;text-align:right">${pay.type || '—'}</div>
      </div>
      <div class="transaction-actions">
        <button class="btn small send-receipt">ارسال رسید</button>
        <button class="btn small edit-pay">ویرایش</button>
        <button class="btn small danger del-pay">حذف</button>
      </div>
    `;
    // send receipt handler: open receipt modal and prefills with phone
    const _sr = node.querySelector('.send-receipt');
    if (_sr) safeClick(_sr, () => {
      let phone = player ? (player.parentPhone || player.phone || '') : '';
      let modal = qs('#receiptModal');
      if (!modal) return alert('مدیریت رسید موجود نیست');
      qs('#receiptPlayerName').textContent = player ? player.name : '—';
      qs('#receiptPhone').value = phone;
      qs('#receiptAmount').value = Number(pay.amount).toLocaleString();
      qs('#receiptNote').value = `رسید پرداخت شهریه به مبلغ ${Number(pay.amount).toLocaleString()} تومان برای دوره ${pay.paymentMonth}/${pay.paymentYear}`;
      modal.style.display = 'flex';
    }, 450);
    node.querySelector('.edit-pay').addEventListener('click', () => showView('edit-payment', {pay}));
    node.querySelector('.del-pay').addEventListener('click', () => {
      if (confirm('حذف شود؟')) {
        state.payments = state.payments.filter(x => x.id !== pay.id);
        saveState();
        renderPaymentsPage();
        renderHome();
      }
    });
    list.appendChild(node);
  });
  populatePaymentMonthYear();
  populatePaymentPlayerSelect();
}

function renderEditPayment(pay) {
  let content = qs('#editPaymentContent');
  content.innerHTML = `
    <div style="display: grid; gap: 12px; margin-top: 12px;">
      <input id="editPaymentDate" class="input jalali-input" value="${isoToJalali(pay.date)}" />
      <div style="display: flex; gap: 8px;">
        <select id="editPaymentMonth" class="input"></select>
        <select id="editPaymentYear" class="input"></select>
      </div>
      <input id="editPaymentAmount" class="input" value="${Number(pay.amount).toLocaleString()}" type="text" />
      <select id="editPaymentType" class="input">
        <option value="">نوع پرداخت</option><option>نقد</option><option>رسید</option><option>کارت به کارت</option>
      </select>
      <div class="form-actions">
        <button id="saveEditPayment" class="btn primary">ذخیره</button>
        <button id="cancelEditPayment" class="btn">انصراف</button>
      </div>
    </div>
  `;
  populatePaymentMonthYear('editPaymentMonth', 'editPaymentYear');
  qs('#editPaymentMonth').value = pay.paymentMonth;
  qs('#editPaymentYear').value = pay.paymentYear;
  qs('#editPaymentType').value = pay.type;
  on('#editPaymentAmount', 'input', (e) => formatNumber(e.target));
  on('#cancelEditPayment', 'click', () => showView('payments'));
  on('#saveEditPayment', 'click', () => {
    let dateStr = qs('#editPaymentDate').value || isoToJalali(pay.date);
    let amount = qs('#editPaymentAmount').value.replace(/,/g, '');
    let type = qs('#editPaymentType').value || '';
    let pMonth = qs('#editPaymentMonth').value;
    let pYear = qs('#editPaymentYear').value;
    pay.date = jalaliToISO(dateStr);
    pay.amount = amount;
    pay.type = type;
    pay.paymentMonth = pMonth;
    pay.paymentYear = pYear;
    pay.updatedAt = new Date().toISOString();
    saveState();
    showView('payments');
  });
}

function renderDebtors() {
  let content = qs('#debtorsContent');
  let todayParts = todayJalali().split('/').map(Number);
  let currentMonth = ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'][todayParts[1] - 1];
  let currentYear = todayParts[0].toString();
  let monthSessions = state.sessions.filter(s => {
    let sDate = isoToJalali(s.date).split('/').map(Number);
    return sDate[0] === todayParts[0] && sDate[1] === todayParts[1];
  });
  let debtors = state.players.filter(p => {
    let sessionsAttended = monthSessions.filter(s => s.attendances?.[p.id]?.present).length;
    let paid = state.payments.some(pay => pay.playerId === p.id && pay.paymentMonth === currentMonth && pay.paymentYear === currentYear);
    return sessionsAttended >= 4 && !paid;
  });
  content.innerHTML = `
    <div class="muted" style="margin-bottom:8px;">هر بازیکنی که در این ماه حداقل 4 جلسه حضور داشته باشد و شهریه را پرداخت نکرده باشد، در این لیست نمایش داده می‌شود.</div>
    ${debtors.map(p => `
      <div class="player-row">
        <div class="meta"><strong>${escapeHtml(p.name)}</strong><small>${p.category || '—'}</small></div>
        <button class="btn small pay-debt">پرداخت</button>
      </div>
    `).join('') || '<div class="muted">هیچ بدهکاری نیست</div>'}
  `;
  qsa('.pay-debt').forEach(btn => {
    let row = btn.closest('.player-row');
    let name = row.querySelector('strong').textContent;
    let player = state.players.find(p => p.name === name);
    btn.addEventListener('click', () => {
      showView('payments');
      qs('#paymentPlayer').value = player.id;
      qs('#paymentPlayerSearch').value = player.name;
      qs('#paymentMonth').value = currentMonth;
      qs('#paymentYear').value = currentYear;
    });
  });
}

function renderPaymentReport() {
  let content = qs('#paymentReportContent');
  content.innerHTML = `
    <div style="margin-top: 12px; display: grid; gap: 12px;">
      <select id="reportCategory" class="input" style="direction: rtl;"><option value="">همه رده‌ها</option></select>
      <select id="reportPrivateClass" class="input" style="direction: rtl;display:none;"><option value="">انتخاب کلاس خصوصی</option></select>
      <div style="display: flex; gap: 8px;">
        <select id="reportMonth" class="input" style="direction: rtl;"></select>
        <select id="reportYear" class="input" style="direction: rtl;"></select>
      </div>
      <div id="reportPeriodLabel" style="font-weight:700; text-align:center;">دوره: -</div>
      <div style="display:flex;gap:8px;align-items:center;justify-content:center;">
        <button id="exportPdfBtn" class="btn">خروجی PDF</button>
        <button id="exportExcelBtn" class="btn">خروجی Excel</button>
      </div>
      <div id="reportList" style="max-height: 40vh; overflow: auto;"></div>
    </div>
  `;
  populateCategoryFilter(qs('#reportCategory'));
  // append private-class option to reportCategory
  try {
    let rc = qs('#reportCategory');
    if (rc && !rc.querySelector('option[value="__private_class__"]')) {
      let opt = document.createElement('option'); opt.value = '__private_class__'; opt.textContent = 'کلاس خصوصی';
      rc.appendChild(opt);
    }
    // populate private class select but keep it hidden until chosen
    populateSessionPrivateClassSelect();
    let rpc = qs('#reportPrivateClass'); if (rpc) rpc.style.display = 'none';
  } catch(e) { console.warn('reportCategory private class setup failed', e); }
  populatePaymentMonthYear('reportMonth', 'reportYear');
  let month = qs('#reportMonth').value;
  let year = qs('#reportYear').value;
  let category = qs('#reportCategory').value;
  renderReportList(month, year, category);
  function updateReportPeriod(){
    const m = qs('#reportMonth').value || '-';
    const y = qs('#reportYear').value || '-';
    const c = qs('#reportCategory').value || 'همه رده‌ها';
    const label = qs('#reportPeriodLabel'); if (label) label.textContent = `دوره: ${m} ${y} — ${c}`;
  }
  on('#reportMonth', 'change', () => { updateReportPeriod(); renderReportList(qs('#reportMonth').value, qs('#reportYear').value, qs('#reportCategory').value); });
  on('#reportYear', 'change', () => { updateReportPeriod(); renderReportList(qs('#reportMonth').value, qs('#reportYear').value, qs('#reportCategory').value); });
  on('#reportCategory', 'change', (e) => { updateReportPeriod(); try { let v = e.target.value; let rpc = qs('#reportPrivateClass'); if (v === '__private_class__') { populateSessionPrivateClassSelect(); if (rpc) rpc.style.display = ''; } else { if (rpc) { rpc.style.display = 'none'; rpc.value = ''; } } } catch(err){}; renderReportList(qs('#reportMonth').value, qs('#reportYear').value, qs('#reportCategory').value); });
  on('#reportPrivateClass', 'change', () => { updateReportPeriod(); renderReportList(qs('#reportMonth').value, qs('#reportYear').value, qs('#reportCategory').value); });
  on('#exportPdfBtn', 'click', () => { month = qs('#reportMonth').value; year = qs('#reportYear').value; category = qs('#reportCategory').value; updateReportPeriod(); exportPaymentsToPdf(month, year, category); });
  on('#exportExcelBtn', 'click', () => { month = qs('#reportMonth').value; year = qs('#reportYear').value; category = qs('#reportCategory').value; updateReportPeriod(); exportPaymentsToExcel(month, year, category); });
}

function renderReportList(month, year, category) {
  let list = qs('#reportList');
  list.innerHTML = '';
  let filteredPlayers = state.players.slice();
  if (category === '__private_class__') {
    // if private class reporting, use selected private class id
    let pcId = qs('#reportPrivateClass') ? qs('#reportPrivateClass').value : null;
    if (pcId) {
      let cls = (state.privateClasses || []).find(x => x.id === pcId);
      if (cls && Array.isArray(cls.players)) filteredPlayers = filteredPlayers.filter(p => cls.players.includes(p.id));
      else filteredPlayers = [];
    } else {
      filteredPlayers = [];
    }
  } else if (category) filteredPlayers = filteredPlayers.filter(p => p.category === category);
  let monthSessions = state.sessions.filter(s => {
    let sDate = isoToJalali(s.date).split('/').map(Number);
    return sDate[0].toString() === year && ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'].indexOf(month) + 1 === sDate[1];
  });
  filteredPlayers.forEach(p => {
    let paid = state.payments.some(pay => pay.playerId === p.id && pay.paymentMonth === month && pay.paymentYear === year);
    let sessionsAttended = monthSessions.filter(s => s.attendances?.[p.id]?.present).length;
    let row = document.createElement('div');
    row.className = 'player-row';
    const statusText = paid ? 'پرداخت شده' : 'بدهکار';
    const statusColor = paid ? 'color: #16a34a; font-weight:700;' : 'color: #dc2626; font-weight:700;';
    row.innerHTML = `
      <div class="meta"><strong>${escapeHtml(p.name)}</strong><small>پرداخت: <span style="${statusColor}">${statusText}</span> • حضور: ${sessionsAttended} جلسه</small></div>
    `;
    list.appendChild(row);
  });
}

function exportPaymentsToPdf(month, year, category) {
  const reportEl = qs('#reportList');
  if (!reportEl) return showToast('لیست گزارش پیدا نشد');
  const period = `دوره: ${month || '-'} ${year || '-'} — ${category || 'همه رده‌ها'}`;
  // create a temporary wrapper so the period header is included in the captured image
  const wrapper = document.createElement('div');
  wrapper.style.position = 'fixed';
  wrapper.style.left = '-9999px';
  wrapper.style.top = '0';
  wrapper.style.background = '#ffffff';
  wrapper.style.padding = '12px';
  wrapper.innerHTML = `<div style="font-weight:700; text-align:center; margin-bottom:8px;">${period}</div><div style="background:#fff;">${reportEl.innerHTML}</div>`;
  document.body.appendChild(wrapper);
  html2canvas(wrapper, { backgroundColor: '#ffffff', scale: 2 }).then(canvas => {
    try {
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf || window.jspdf ? window.jspdf : window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const imgProps = pdf.getImageProperties(imgData);
      const imgWidth = pageWidth - 20; // margins
      const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
      pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
      const safeMonth = (month || '').toString().replace(/\s+/g, '_');
      const safeYear = (year || '').toString().replace(/\s+/g, '_');
      const fileName = `payments_report_${safeMonth || 'all'}_${safeYear || 'all'}.pdf`;
      pdf.save(fileName);
    } catch (e) { console.error('PDF export failed', e); showToast('خروجی PDF موفقیت‌آمیز نبود'); }
    document.body.removeChild(wrapper);
  }).catch(e => { console.error('html2canvas failed', e); showToast('خطا در تهیه تصویر برای PDF'); document.body.removeChild(wrapper); });
}

function exportPaymentsToExcel(month, year, category) {
  const period = `دوره: ${month || '-'} ${year || '-'} — ${category || 'همه رده‌ها'}`;
  let csv = `${period}\nنام,پرداخت,حضور\n`;
  let filteredPlayers = state.players.slice();
  if (category) filteredPlayers = filteredPlayers.filter(p => p.category === category);
  let monthSessions = state.sessions.filter(s => {
    let sDate = isoToJalali(s.date).split('/').map(Number);
    return sDate[0].toString() === year && ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'].indexOf(month) + 1 === sDate[1];
  });
  filteredPlayers.forEach(p => {
    let paid = state.payments.some(pay => pay.playerId === p.id && pay.paymentMonth === month && pay.paymentYear === year) ? 'پرداخت شده' : 'بدهکار';
    let sessionsAttended = monthSessions.filter(s => s.attendances?.[p.id]?.present).length;
    csv += `${p.name},${paid},${sessionsAttended}\n`;
  });
  let blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
  let url = URL.createObjectURL(blob);
  let a = document.createElement('a');
  a.href = url;
  const safeMonth = (month || '').toString().replace(/\s+/g, '_');
  const safeYear = (year || '').toString().replace(/\s+/g, '_');
  a.download = `payments_report_${safeMonth || 'all'}_${safeYear || 'all'}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function renderPlayersExport() {
  let content = qs('#playersExportContent');
  content.innerHTML = `
    <select id="exportCategory" class="input"><option value="">همه رده‌ها</option></select>
    <div class="form-actions">
      <button id="exportPlayers" class="btn primary">خروجی لیست</button>
    </div>
  `;
  populateCategoryFilter(qs('#exportCategory'));
  on('#exportPlayers', 'click', () => {
    let cat = qs('#exportCategory').value;
    exportPlayersToExcel(cat);
    showView('players');
  });
}

function exportPlayersToExcel(category) {
  let csv = 'نام,رده,تاریخ تولد,تاریخ عضویت,تاریخ بیمه,پست,تلفن,کد ملی,نام پدر,قد,وزن\n';
  let filtered = state.players.slice();
  if (category) filtered = filtered.filter(p => p.category === category);
  filtered.forEach(p => {
    csv += `${p.name},${p.category || ''},${p.birthdate || ''},${p.joinDate || ''},${p.insuranceDate || ''},${p.favoritePosition || ''},${p.phone || ''},${p.nationalCode || ''},${p.fatherName || ''},${p.height || ''},${p.weight || ''}\n`;
  });
  let blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
  let url = URL.createObjectURL(blob);
  let a = document.createElement('a');
  a.href = url;
  a.download = 'players_report.csv';
  a.click();
  URL.revokeObjectURL(url);
}
/* applyTheme(theme) {
  const validThemes = ['luxury', 'fun', 'modern'];
  const selectedTheme = validThemes.includes(theme) ? theme : 'modern'; // پیش‌فرض modern
  document.documentElement.setAttribute('data-style', selectedTheme);
  state.settings.theme = selectedTheme;
  saveState();
} */
function renderPlayerForm(player = null) {
  let isEdit = !!player;
  let title = qs('#playerFormTitle');
  title.textContent = isEdit ? 'ویرایش بازیکن' : 'ثبت بازیکن';
  let content = qs('#playerFormContent');
  let scores = player ? player.scores || {} : {};
  let birth = player ? player.birthdate || '' : '';
  let insurance = player ? player.insuranceDate || '' : '';
  content.innerHTML = `
    <div style="display: flex; flex-direction: column; align-items: center; margin-top: 12px; width:100%;">
      <div style="width: 120px; height: 120px; border-radius: 12px; overflow: hidden; background: #e2e8f0;" id="previewPhoto">
        ${player && player.photo ? `<img src="${player.photo}" style="width: 100%; height: 100%; object-fit: cover;">` : (player && player.gender ? `<img src="./icons/${player.gender === 'female' ? 'volleyball-player (3).png' : 'volleyball-player (4).png'}" style="width:100%;height:100%;object-fit:cover;">` : '<div class="muted" style="display:flex;align-items:center;justify-content:center;height:100%;">عکس</div>')}
      </div>
      <div style="display: flex; gap: 8px; margin-top: 8px;">
        <label class="btn primary" style="padding: 8px 16px; font-size: 14px;">انتخاب عکس<input id="p_photo" type="file" accept="image/*" style="display: none;"></label>
        <button id="removePhotoBtn" class="btn small" ${player && player.photo ? '' : 'disabled'}>حذف عکس</button>
      </div>

      <div style="width:100%; margin-top:12px;">
        <div class="form-section">
          <h4 style="margin:0 0 8px 0">اطلاعات شخصی</h4>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <div>
              <label for="p_name">نام کامل</label>
              <input id="p_name" class="input" type="text" value="${player ? escapeHtml(player.name || '') : ''}">
            </div>
            <div>
              <label for="p_father">نام پدر</label>
              <input id="p_father" class="input" type="text" value="${player ? escapeHtml(player.fatherName || '') : ''}">
            </div>
            <div>
              <label for="p_nationalCode">کد ملی</label>
              <input id="p_nationalCode" class="input" type="text" value="${player ? escapeHtml(player.nationalCode || '') : ''}">
            </div>
            <div>
              <label for="p_phone">تلفن</label>
              <input id="p_phone" class="input" type="text" value="${player ? escapeHtml(player.phone || '') : ''}">
            </div>
            <div>
              <label for="p_parentPhone">تلفن والد</label>
              <input id="p_parentPhone" class="input" type="text" value="${player ? escapeHtml(player.parentPhone || '') : ''}">
            </div>
            <div>
              <label for="p_gender">جنسیت</label>
              <select id="p_gender" class="input">
                <option value="male">پسر</option>
                <option value="female">دختر</option>
              </select>
            </div>
            <div>
              <label for="p_birth">تاریخ تولد (YYYY/MM/DD)</label>
              <input id="p_birth" class="input jalali-input" value="${birth}" readonly="readonly" />
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4 style="margin:0 0 8px 0">پروفایل ورزشی</h4>
          <div class="form-row">
            <div>
              <label for="p_join">تاریخ عضویت (YYYY/MM/DD)</label>
              <input id="p_join" class="input jalali-input" value="${player ? player.joinDate : todayJalali()}">
            </div>
          </div>
          <div class="form-row">
            <div>
              <label for="p_insurance">تاریخ بیمه (YYYY/MM/DD)</label>
              <input id="p_insurance" class="input jalali-input" value="${insurance}" readonly="readonly" />
            </div>
            <div>
              <label for="p_category">رده</label>
              <select id="p_category" class="input"></select>
              <div id="p_category_note" class="muted" style="margin-top:6px;font-size:0.95em;">&nbsp;</div>
            </div>
          </div>
          <div class="form-row">
            <div>
              <label for="p_position">پست</label>
              <select id="p_position" class="input">
                <option value="">انتخاب پست</option>
                <option value="OH">Outside Hitter</option>
                <option value="OPP">Opposite Hitter</option>
                <option value="L">Libero</option>
                <option value="ST">Setter</option>
                <option value="MB">Middle Blocker</option>
              </select>
            </div>
            <div>
              <label for="p_jersey">شماره پیراهن</label>
              <input id="p_jersey" class="input" type="text" value="${player ? escapeHtml(player.jersey || '') : ''}">
            </div>
          </div>
          <div class="form-row">
            <div>
              <label for="p_height">قد (cm)</label>
              <input id="p_height" class="input" type="number" value="${player ? player.height : ''}">
            </div>
            <div>
              <label for="p_weight">وزن (kg)</label>
              <input id="p_weight" class="input" type="number" value="${player ? player.weight : ''}">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4 style="margin:0 0 8px 0">مهارت‌ها و امتیازات</h4>
          <div id="scoresContainer"></div>
        </div>

        <div class="form-actions">
          <button id="savePlayerBtn" class="btn primary">ذخیره</button>
        </div>
      </div>
    </div>
  `;
  attachJalaliInputs(content); // بعد از تکمیل content.innerHTML
  // populate category select with current ranks and select player's category if editing
  try{ populateCategoriesFromRanks(qs('#p_category'), 'انتخاب رده', player ? player.category : ''); } catch(e){}
  // ... بقیه کد بدون تغییر
  function updateCategoryAndPosition() {
  let birthInput = qs('#p_birth');
  let categoryInput = qs('#p_category');
  let positionInput = qs('#p_position');

  // بررسی وجود المنت‌ها
  if (!birthInput || !categoryInput || !positionInput) {
    console.warn('One or more required elements (#p_birth, #p_category, #p_position) not found');
    return;
  }

  let birth = birthInput.value;
  if (!birth || !birth.match(/^\d{4}\/\d{2}\/\d{2}$/)) {
    console.warn('Invalid birthdate format:', birth);
    categoryInput.value = '';
    positionInput.value = '';
    positionInput.disabled = true;
    positionInput.options[0].text = 'انتخاب پست';
    renderScoreFields('', null);
    return;
  }

  try {
  let age = calcExactAge(birth);
  age.birthdate = birth;
  let category = determineCategory(age);
    categoryInput.value = category || 'نامشخص';

    // مدیریت پست و امتیازات
      // For مینی والیبال keep position selection disabled (all positions)
      if (category === 'مینی والیبال') {
        positionInput.value = '';
        positionInput.disabled = true;
        positionInput.options[0].text = 'همه پست‌ها';
        renderScoreFields(category, null);
      }
      // For نونهالان allow selecting a specific position but show "همه پست‌ها" as the default option label
      else if (category === 'نونهالان') {
        positionInput.disabled = false;
        positionInput.options[0].text = 'همه پست‌ها';
        renderScoreFields(category, positionInput.value || null);
        // If editing an existing player in this category, open the position dropdown so coach can choose
        try {
          if (player) {
            // focus + click to hint the browser to open the native dropdown (may vary by platform)
            positionInput.focus();
            try { positionInput.click(); } catch(_){ }
          }
        } catch(e) { console.debug('open position dropdown failed', e); }
      }
      else {
        positionInput.disabled = false;
        positionInput.options[0].text = 'انتخاب پست';
        renderScoreFields(category, positionInput.value || null);
      }
  } catch (e) {
    console.error('Error in updateCategoryAndPosition:', e);
    categoryInput.value = 'خطا';
    positionInput.value = '';
    positionInput.disabled = true;
    positionInput.options[0].text = 'انتخاب پست';
    renderScoreFields('', null);
  }
}

  on('#p_birth', 'change', updateCategoryAndPosition);
  on('#p_position', 'change', () => renderScoreFields(qs('#p_category').value, qs('#p_position').value));

  updateCategoryAndPosition();
  // After initial update, update the explanatory note that shows why this category was chosen
  function refreshCategoryNote() {
    const noteEl = qs('#p_category_note');
    if (!noteEl) return;
    const birthVal = qs('#p_birth') ? qs('#p_birth').value : '';
    if (!birthVal) { noteEl.innerHTML = 'برای تعیین رده لطفاً تاریخ تولد را وارد کنید.'; return; }
    try {
      // compute age relative to ranks reference date (use settings ref if present)
      const rawRef = (state.settings && state.settings.ranksReferenceDate) ? state.settings.ranksReferenceDate : ((state.settings && state.settings.lastCategoryUpdate) ? state.settings.lastCategoryUpdate : todayJalali());
      let refJ = String(rawRef || todayJalali()).trim();
      // helper: map Persian month names to month numbers
      const persianMonths = { 'فروردین':1,'اردیبهشت':2,'خرداد':3,'تیر':4,'مرداد':5,'شهریور':6,'مهر':7,'آبان':8,'آذر':9,'دی':10,'بهمن':11,'اسفند':12 };
      let refParts = null;

      // Format 1: YYYY/MM/DD
      if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(refJ)) {
        refParts = String(refJ).split('/').map(n => Number(n));
      }
      // Format 2: DD <PersianMonth> YYYY  (e.g., "11 دی 1404")
      else if (/^\d{1,2}\s+\S+\s+\d{4}$/.test(refJ)) {
        const parts = refJ.split(/\s+/);
        const d = Number(parts[0]);
        const monthName = parts[1];
        const y = Number(parts[2]);
        const mnum = persianMonths[monthName] || NaN;
        if (!Number.isFinite(d) || !Number.isFinite(mnum) || !Number.isFinite(y)) {
          refParts = null;
        } else {
          refParts = [y, mnum, d];
        }
      }
      // fallback: try parsing todayJalali()
      if (!refParts) {
        try { refParts = String(todayJalali()).split('/').map(n => Number(n)); refJ = todayJalali(); } catch(_) { refParts = null; }
      }

      const birthParts = String(birthVal).split('/').map(n => Number(n));
      if (!refParts || refParts.length < 3 || birthParts.length < 3) {
        noteEl.innerHTML = `اطلاعات تاریخ تولد یا تاریخ مرجع نامعتبر است (${rawRef})`;
        return;
      }

      let y = Number(refParts[0]) - Number(birthParts[0]);
      let m = Number(refParts[1]) - Number(birthParts[1]);
      let d = Number(refParts[2]) - Number(birthParts[2]);
      if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) {
        noteEl.innerHTML = `اطلاعات تاریخ تولد یا تاریخ مرجع نامعتبر است (${rawRef})`;
        return;
      }
      if (d < 0) { m--; d += 30; }
      if (m < 0) { y--; m += 12; }
      if (!Number.isFinite(y)) y = 0;
      if (!Number.isFinite(m)) m = 0;
      // shorter age string (years and months)
      const ageStr = (m > 0) ? `${y} سال و ${m} ماه` : `${y} سال`;
      const cat = qs('#p_category') ? qs('#p_category').value : '';
      // show the rawRef (settings text) as the reference date in the message
      noteEl.innerHTML = `این بازیکن در تاریخ مرجع ${rawRef} سنی برابر ${ageStr} دارد، بنابراین در رده «${cat || 'نامشخص'}» قرار گرفته. <span style="color:var(--accent);">برای تغییر محدودهٔ سن رده‌ها به صفحهٔ تنظیمات مراجعه کنید.</span>`;
    } catch(e) { noteEl.innerHTML = 'اطلاعات رده قابل محاسبه نیست'; }
  }
  // keep the note updated when birth or category changes
  on('#p_birth', 'change', refreshCategoryNote);
  on('#p_category', 'change', refreshCategoryNote);
  // initial refresh
  refreshCategoryNote();
  if (player) {
    qs('#p_position').value = player.favoritePosition || '';
    for (let key in scores) {
      let input = qs(`#score_${key}`);
      if (input) input.value = scores[key];
    }
  // populate additional fields
  if (qs('#p_jersey')) qs('#p_jersey').value = player.jersey || '';
  if (qs('#p_parentPhone')) qs('#p_parentPhone').value = player.parentPhone || '';
  if (qs('#p_gender')) qs('#p_gender').value = player.gender || 'male';
  }
  
  on('#p_photo', 'change', e => {
    let f = e.target.files[0];
    if (!f) return;
    const prev = qs('#previewPhoto');
    // show temporary loading state
    try { prev.innerHTML = '<div class="muted">در حال پردازش تصویر...</div>'; } catch(_) {}
    // Prefer using the new face-crop compressor when available
    if (window.imageCompress && typeof window.imageCompress.compressWithFaceCrop === 'function') {
      window.imageCompress.compressWithFaceCrop(f, { outputSize: 256, expand: 1.4, quality: 0.7, mimeType: 'image/webp' })
        .then(res => {
          // render preview
          if (prev.querySelector('img')) prev.querySelector('img').src = res.dataUrl;
          else {
            prev.innerHTML = '';
            const img = document.createElement('img'); img.src = res.dataUrl; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; prev.appendChild(img);
          }
          qs('#removePhotoBtn').disabled = false;
          qs('#p_photo').dataset.dataurl = res.dataUrl;
          // also keep blob for potential upload
          qs('#p_photo').dataset.blob = true; // marker; real blob kept in window.state by demo UI if needed
        })
        .catch(err => {
          console.warn('compressWithFaceCrop failed, falling back to basic read', err);
          imageFileToDataURL(f, 500).then(data => {
            prev.innerHTML = '';
            let img = document.createElement('img'); img.src = data; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; prev.appendChild(img);
            qs('#removePhotoBtn').disabled = false;
            qs('#p_photo').dataset.dataurl = data;
          }).catch(err2 => { console.error(err2); alert('خطا در خواندن تصویر'); prev.innerHTML = '<div class="muted">خطا در پردازش تصویر</div>'; });
        });
    } else {
      // fallback to existing helper if model not loaded
      imageFileToDataURL(f, 500).then(data => {
        if (prev.querySelector('img')) prev.querySelector('img').src = data;
        else { prev.innerHTML = ''; let img = document.createElement('img'); img.src = data; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; prev.appendChild(img); }
        qs('#removePhotoBtn').disabled = false;
        qs('#p_photo').dataset.dataurl = data;
      }).catch(err => alert('خطا در خواندن تصویر'));
    }
  });

  on('#removePhotoBtn', 'click', () => {
    qs('#previewPhoto').innerHTML = '<div class="muted">عکس</div>';
    qs('#p_photo').value = '';
    qs('#p_photo').dataset.dataurl = '';
    qs('#removePhotoBtn').disabled = true;
  });

  on('#savePlayerBtn', 'click', () => {
    let name = qs('#p_name').value.trim();
    if (!name) return alert('نام را وارد کنید');
    let birth = qs('#p_birth').value.trim();
    // sanitize birthdate: accept ISO (YYYY-MM-DD) or ISO string and convert to Jalali YYYY/MM/DD
    try {
      if (birth && !birth.match(/^\d{4}\/\d{2}\/\d{2}$/)) {
        // handle common ISO 'YYYY-MM-DD'
        if (/^\d{4}-\d{2}-\d{2}$/.test(birth)) {
          try { birth = isoToJalali(new Date(birth).toISOString()); } catch (e) { console.warn('Failed to convert YYYY-MM-DD to Jalali', e); }
        } else if (/^\d{4}-\d{2}-\d{2}T/.test(birth) || /^\d{4}-\d{2}-\d{2}Z$/.test(birth)) {
          try { birth = isoToJalali(birth); } catch (e) { console.warn('Failed to convert ISO datetime to Jalali', e); }
        }
      }
    } catch(e) { console.warn('birth sanitization failed', e); }
    let join = qs('#p_join').value.trim() || todayJalali();
    let insurance = qs('#p_insurance').value.trim();
    let category = qs('#p_category').value;
    let pos = qs('#p_position').value;
  let phone = qs('#p_phone').value;
  let parentPhone = qs('#p_parentPhone') ? qs('#p_parentPhone').value.trim() : '';
  let jersey = qs('#p_jersey') ? qs('#p_jersey').value.trim() : '';
    let nationalCode = qs('#p_nationalCode').value;
    let father = qs('#p_father').value;
    let height = qs('#p_height').value;
    let weight = qs('#p_weight').value;
    
    let scores = {};
    qsa('#scoresContainer input[type="number"]').forEach(input => {
      let key = input.id.replace('score_', '');
      scores[key] = input.value || 0;
    });
    
  // Determine photo: prefer uploaded image, else keep existing, else use gender placeholder
  let uploaded = qs('#p_photo').dataset.dataurl || '';
  let existing = player ? (player.photo || '') : '';
  let gender = qs('#p_gender') ? (qs('#p_gender').value || 'male') : 'male';
  gender = ('' + gender).toLowerCase().startsWith('f') ? 'female' : 'male';
  let placeholder = `./icons/${gender === 'female' ? 'volleyball-player (3).png' : 'volleyball-player (4).png'}`;
  let photoData = uploaded || existing || placeholder;
  console.debug('[savePlayer] chosen source=', uploaded ? 'uploaded' : (existing ? 'existing' : 'placeholder'), 'name=', name, 'gender=', gender, 'photoData=', photoData);

    let savedPlayerId = null;
    if (isEdit) {
      let idx = state.players.findIndex(x => x.id === player.id);
      if (idx > -1) {
        state.players[idx] = {
          ...state.players[idx],
          name, birthdate: birth, joinDate: join, insuranceDate: insurance, category, favoritePosition: pos,
          phone, parentPhone, jersey, nationalCode, fatherName: father, height, weight, scores, photo: photoData, gender: gender, updatedAt: new Date().toISOString()
        };
        savedPlayerId = state.players[idx].id;
      }
    } else {
      const newId = uid('p');
      state.players.push({
        id: newId, name, birthdate: birth, joinDate: join, insuranceDate: insurance, category, favoritePosition: pos,
        phone, parentPhone, jersey, nationalCode, fatherName: father, height, weight, scores, photo: photoData, gender: gender, createdAt: new Date().toISOString(), events: []
      });
      savedPlayerId = newId;
    }
    saveState();
    // After saving, go back to the saved player's profile
    if (savedPlayerId) {
      showView('player-profile', { playerId: savedPlayerId });
      renderPlayerProfile(savedPlayerId);
    } else {
      // fallback
      showView('players');
      renderHome();
    }
  });
  on('#backPlayerForm', 'click', () => { if (!goBack()) return; });
}

function renderScoreFields(category, position) {
  let container = qs('#scoresContainer');
  container.innerHTML = '';
  let fields = getPositionSpecificFields(position);
  fields.forEach(key => {
    let div = document.createElement('div');
    const displayLabel = ('' + key).replace(/_/g, ' ');
    div.innerHTML = `
      <label for="score_${key}">${displayLabel}</label>
      <input id="score_${key}" type="number" min="0" max="10" step="1" class="input" placeholder="0-10" title="امتیاز 0 تا 10" aria-label="امتیاز ${displayLabel} (0-10)">
    `;
    container.appendChild(div);
  });
}

function getPositionSpecificFields(position) {
  if (!position) return ['سرویس', 'حمله', 'دریافت', 'توپگیری', 'جاگیری', 'نظم_تیمی'];
  switch (position) {
    case 'OH': // Outside Hitter
      return ['سرویس', 'حمله', 'دریافت', 'توپگیری', 'جاگیری', 'دفاع_روی_تور', 'نظم_تیمی'];
    case 'OPP': // Opposite Hitter
      return ['سرویس', 'حمله', 'دریافت', 'توپگیری', 'جاگیری', 'دفاع_روی_تور', 'نظم_تیمی'];
    case 'L': // Libero
      return ['دریافت', 'توپگیری', 'جاگیری', 'نظم_تیمی'];
    case 'ST': // Setter
      return ['سرویس', 'پاس', 'دریافت', 'توپگیری', 'جاگیری', 'دفاع_روی_تور', 'نظم_تیمی'];
    case 'MB': // Middle Blocker
      return ['سرویس', 'حمله', 'دفاع_روی_تور', 'جاگیری', 'نظم_تیمی'];
    default:
      return ['سرویس', 'حمله', 'دریافت', 'توپگیری', 'جاگیری', 'نظم_تیمی'];
  }
}

function renderCoachForm(coach) {
  let isEdit = !!coach;
  let title = qs('#coachFormTitle');
  title.textContent = isEdit ? 'ویرایش مربی' : 'افزودن مربی';
  let content = qs('#coachFormContent');
  content.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:12px;margin-top:12px;">
      <div id="coachPreview" style="width:160px;height:160px;border-radius:16px;overflow:hidden;background:#e9eef6;margin:0 auto;display:flex;align-items:center;justify-content:center;">${coach?.photo ? `<img src="${coach.photo}" style="width:100%;height:100%;object-fit:cover;">` : '<div style="color:#666">عکس</div>'}</div>
      <div style="display:flex;justify-content:center;gap:8px;">
        <label class="btn primary" style="padding:10px 18px;min-width:140px;display:inline-flex;align-items:center;justify-content:center;">عکس<input id="c_photo" type="file" accept="image/*" style="display:none;"></label>
        <button id="removeCoachPhoto" class="btn" ${coach?.photo ? '' : 'disabled'} style="padding:8px 12px;">حذف</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div>
          <label for="c_name">نام کامل</label>
          <input id="c_name" class="input" type="text" value="${coach ? escapeHtml(coach.name) : ''}">
        </div>
        <div>
          <label for="c_title">سمت / عنوان</label>
          <input id="c_title" class="input" type="text" value="${coach ? escapeHtml(coach.title || '') : ''}">
        </div>
        <div>
          <label for="c_phone">تلفن</label>
          <input id="c_phone" class="input" type="text" value="${coach ? escapeHtml(coach.phone || '') : ''}">
        </div>
        <div>
          <label for="c_birth">تاریخ تولد</label>
          <input id="c_birth" class="jalali-input input" type="text" value="${coach ? escapeHtml(coach.birthdate || '') : ''}">
        </div>
        <div>
          <label for="c_start">تاریخ شروع به کار</label>
          <input id="c_start" class="jalali-input input" type="text" value="${coach ? escapeHtml(coach.startDate || '') : ''}">
        </div>
        <div>
          <label for="c_email">ایمیل</label>
          <input id="c_email" class="input" type="email" value="${coach ? escapeHtml(coach.email || '') : ''}">
        </div>
        <div>
          <label for="c_insta">اینستاگرام (نام کاربری)</label>
          <input id="c_insta" class="input" type="text" placeholder="مثال: username_123" value="${coach ? escapeHtml(coach.instagram || '') : ''}">
        </div>
      </div>
      <div class="form-actions" style="display:flex;justify-content:center;gap:10px;margin-top:8px;">
        <button id="saveCoach" class="btn primary">${isEdit ? 'ذخیره' : 'افزودن'}</button>
        <button id="cancelCoach" class="btn">انصراف</button>
      </div>
    </div>
  `;
  // initialize jalali date pickers for the newly injected inputs
  try { attachJalaliInputs(content); } catch (e) { console.warn('attachJalaliInputs failed for coach form', e); }

  on('#cancelCoach', 'click', () => showView('coaches'));
  on('#c_photo', 'change', e => {
    let f = e.target.files[0];
    if (!f) return;
    const prev = qs('#coachPreview');
    try { prev.innerHTML = '<div class="muted">در حال پردازش تصویر...</div>'; } catch(_){}

    // Prefer face-aware compressor if available (same behavior as player photo flow)
    if (window.imageCompress && typeof window.imageCompress.compressWithFaceCrop === 'function') {
      window.imageCompress.compressWithFaceCrop(f, { outputSize: 256, expand: 1.4, quality: 0.7, mimeType: 'image/webp' })
        .then(res => {
          if (prev.querySelector('img')) prev.querySelector('img').src = res.dataUrl;
          else { prev.innerHTML = ''; const img = document.createElement('img'); img.src = res.dataUrl; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; prev.appendChild(img); }
          qs('#removeCoachPhoto').disabled = false;
          qs('#c_photo').dataset.dataurl = res.dataUrl;
          // mark that we have a processed blob available (actual blob handling is upstream)
          qs('#c_photo').dataset.blob = true;
        })
        .catch(err => {
          console.warn('compressWithFaceCrop failed for coach photo, falling back', err);
          imageFileToDataURL(f, 500).then(data => {
            prev.innerHTML = '';
            let img = document.createElement('img'); img.src = data; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; prev.appendChild(img);
            qs('#removeCoachPhoto').disabled = false;
            qs('#c_photo').dataset.dataurl = data;
          }).catch(err2 => { console.error(err2); alert('خطا در خواندن عکس'); prev.innerHTML = '<div style="color:#666">خطا در پردازش تصویر</div>'; });
        });
    } else {
      // fallback: basic resize + quality loop
      imageFileToDataURL(f, 500).then(data => {
        if (prev.querySelector('img')) prev.querySelector('img').src = data;
        else { prev.innerHTML = ''; let img = document.createElement('img'); img.src = data; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; prev.appendChild(img); }
        qs('#removeCoachPhoto').disabled = false;
        qs('#c_photo').dataset.dataurl = data;
      }).catch(err => { console.error(err); alert('خطا در خواندن عکس'); });
    }
  });
  on('#removeCoachPhoto', 'click', () => {
    qs('#coachPreview').innerHTML = '<div style="color:#666">عکس</div>';
    qs('#c_photo').dataset.dataurl = '';
    qs('#removeCoachPhoto').disabled = true;
  });

  on('#saveCoach', 'click', () => {
    let name = qs('#c_name').value.trim();
    if (!name) return alert('نام را وارد کنید');
    let title = qs('#c_title').value.trim();
    let phone = qs('#c_phone').value.trim();
    let photo = qs('#c_photo').dataset.dataurl || (coach ? coach.photo || '' : '');
    let birth = qs('#c_birth') ? qs('#c_birth').value.trim() : '';
    let start = qs('#c_start') ? qs('#c_start').value.trim() : '';
    let email = qs('#c_email') ? qs('#c_email').value.trim() : '';
    let insta = qs('#c_insta') ? qs('#c_insta').value.trim() : '';
    if (isEdit) {
      let idx = state.coaches.findIndex(x => x.id === coach.id);
      if (idx > -1) {
        state.coaches[idx] = { ...state.coaches[idx], name, title, phone, photo, birthdate: birth, startDate: start, email: email, instagram: insta, updatedAt: new Date().toISOString() };
      }
    } else {
      state.coaches.push({ id: uid('c'), name, title, phone, photo, birthdate: birth, startDate: start, email: email, instagram: insta, createdAt: new Date().toISOString() });
    }
    saveState();
    showView('coaches');
    renderHome();
  });
  on('#backCoachForm', 'click', () => { if (!goBack()) showView('coaches'); });
}

function createSession() {
  let title = qs('#sessionTitle').value.trim();
  let dateStr = qs('#sessionDate').value || todayJalali();
  let category = qs('#sessionCategory').value || null;
  let privateClassId = null;
  if (category === '__private_class__') {
    privateClassId = qs('#sessionPrivateClass') ? qs('#sessionPrivateClass').value || null : null;
    // keep category marker as 'کلاس خصوصی' for readability
    category = 'کلاس خصوصی';
  }
  let coachId = qs('#sessionCoach').value || null;
  let id = uid('s');
  let s = { id, title, date: jalaliToISO(dateStr), category, coachId, privateClassId, createdAt: new Date().toISOString(), attendances: {} };
  state.sessions.unshift(s);
  saveState();
  qs('#sessionTitle').value = '';
  qs('#sessionDate').value = '';
  // close modal if open
  try {
    let m = qs('#sessionModal');
    if (m) { m.classList.add('hide'); m.style.display='none'; m.setAttribute('aria-hidden','true'); }
  } catch(e){}
  // refresh sessions list and navigate to sessions tab so user sees the new session
  try { renderSessionsPage(); showView('sessions'); } catch(e){}
  try { showToast('جلسه ایجاد شد'); } catch(e){}
}

function renderSessionAttendance(id) {
  let s = state.sessions.find(x => x.id === id);
  if (!s) return;
  let title = qs('#attendanceTitle');
  title.textContent = `حضور/غیاب — ${escapeHtml(s.title)}`;
  let content = qs('#attendanceContent');
  let sessionDate = jalaliToDate(isoToJalali(s.date));
  let html = '';
  let filteredPlayers = state.players.filter(p => jalaliToDate(p.joinDate) <= sessionDate);
  if (s.privateClassId) {
    let cls = (state.privateClasses || []).find(x => x.id === s.privateClassId);
    if (cls && Array.isArray(cls.players)) {
      filteredPlayers = filteredPlayers.filter(p => cls.players.includes(p.id));
    }
  } else if (s.category) {
    filteredPlayers = filteredPlayers.filter(p => p.category === s.category);
  }
  filteredPlayers.forEach(p => {
    let att = s.attendances?.[p.id] || { present: false, reason: '' };
  let imgHtml = p.photo ? `<img class="player-image" src="${p.photo}" alt="avatar">` : `<svg width="36" height="36" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>`;
    html += `
      <div style="display: flex; align-items: center; gap: 12px; padding: 8px; border-bottom: 1px dashed rgba(0,0,0,0.06);">
        <div class="player-thumb">${imgHtml}</div>
        <div class="meta"><strong>${escapeHtml(p.name)}</strong><small>${p.category || ''}</small></div>
        <label style="display: flex; gap: 8px;"><input type="checkbox" data-player="${p.id}" ${att.present ? 'checked' : ''}> حاضر</label>
        <button class="note-btn${att.reason ? ' has-note' : ''}" data-reason-btn="${p.id}"><svg viewBox="0 0 24 24"><path d="M3 3h18v18H3z" stroke="currentColor" stroke-width="2" fill="none"/><path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
      </div>
    `;
  });
  html += `
    <div class="form-actions">
      <button id="saveAttendance" class="btn primary">ذخیره</button>
      <button id="closeAttendance" class="btn">بستن</button>
    </div>
  `;
  content.innerHTML = html;
  on('#closeAttendance', 'click', () => showView('sessions'));
  qsa('[data-reason-btn]').forEach(btn => {
    let pid = btn.dataset.reasonBtn;
    let att = s.attendances?.[pid] || { reason: '' };
    btn.addEventListener('click', () => {
      // ذخیره موقت حضور
      let tempAttendances = {};
      filteredPlayers.forEach(pl => {
        let cb = qs(`[data-player="${pl.id}"]`);
        if (cb) {
          tempAttendances[pl.id] = { ...s.attendances[pl.id], present: !!cb.checked };
        }
      });
      showView('note', {playerId: pid, currentNote: att.reason, callback: (newReason) => {
        s.attendances[pid] = { ...s.attendances[pid], reason: newReason };
      }, sessionId: id, tempAttendances});
    });
  });
  on('#saveAttendance', 'click', () => {
    filteredPlayers.forEach(p => {
      let cb = qs(`[data-player="${p.id}"]`);
      if (cb) {
        s.attendances[p.id] = { ...s.attendances[p.id], present: !!cb.checked };
      }
    });
    saveState();
    showView('sessions');
  });
  on('#backAttendance', 'click', () => { if (!goBack()) return; });
}

function renderNote(playerId, currentNote, callback, sessionId, tempAttendances) {
  let content = qs('#noteContent');
  content.innerHTML = `
    <textarea id="noteText" class="input" style="height: 120px; margin-top: 12px;">${escapeHtml(currentNote)}</textarea>
    <div class="form-actions">
      <button id="saveNote" class="btn primary">ذخیره</button>
      <button id="cancelNote" class="btn">انصراف</button>
    </div>
  `;
  on('#cancelNote', 'click', () => {
    showView('session-attendance', {sessionId});
    // برگرداندن تیک‌ها
    let keys = Object.keys(tempAttendances);
    keys.forEach(pid => {
      let cb = qs(`[data-player="${pid}"]`);
      if (cb) cb.checked = tempAttendances[pid].present;
    });
  });
  on('#saveNote', 'click', () => {
    let newNote = qs('#noteText').value.trim();
    callback(newNote);
    saveState();
    showView('session-attendance', {sessionId});
    // برگرداندن تیک‌ها
    let keys = Object.keys(tempAttendances);
    keys.forEach(pid => {
      let cb = qs(`[data-player="${pid}"]`);
      if (cb) cb.checked = tempAttendances[pid].present;
    });
  });
  on('#backNote', 'click', () => {
    showView('session-attendance', {sessionId});
    // برگرداندن تیک‌ها
    let keys = Object.keys(tempAttendances);
    keys.forEach(pid => {
      let cb = qs(`[data-player="${pid}"]`);
      if (cb) cb.checked = tempAttendances[pid].present;
    });
  });
}

function renderPlayerProfile(id) {
  let title = qs('#profileTitle');
  if (!title) {
    console.error('Element #profileTitle not found');
    return showView('players');
  }
  title.textContent = 'پروفایل بازیکن';

  let content = qs('#profileContent');
  if (!content) {
    console.error('Element #profileContent not found');
    return showView('players');
  }

  let p = state.players.find(x => x.id === id);
  if (!p) {
    console.warn('Player not found for ID:', id);
    alert('پروفایل پیدا نشد');
    return showView('players');
  }

  // بررسی و تنظیم birthdate
  if (!p.birthdate || typeof p.birthdate !== 'string' || !p.birthdate.includes('/')) {
    console.warn('Invalid or missing birthdate for player:', p);
    p.birthdate = todayJalali(); // تاریخ پیش‌فرض امروز
  }

  let age;
  try {
    age = calcExactAge(p.birthdate); // سن دقیق
    if (!age.birthdate) age.birthdate = p.birthdate; // اطمینان از وجود birthdate
  } catch (e) {
    console.error('Error in calcExactAge:', e);
    age = { years: 0, months: 0, days: 0, birthdate: p.birthdate };
  }

  // محاسبه رده با determineCategory
  let category;
  try {
    category = determineCategory(age);
  } catch (e) {
    console.error('Error in determineCategory:', e);
    category = 'نامشخص';
  }

  // time-to-next-category removed by request
  let timeToNext = null;

  // بررسی و تنظیم sessions
  let sessions = [];
  try {
    sessions = state.sessions
      .filter(s => s.attendances?.[p.id]?.present)
      .map(s => ({
        title: s.title || 'جلسه',
        date: isoToJalali(s.date) || '—',
        category: s.category || '—'
      }));
  } catch (e) {
    console.error('Error processing sessions:', e);
  }

  // بررسی و تنظیم payments
  let payments = [];
  try {
    payments = state.payments
      .filter(x => x.playerId === p.id)
      .map(pay => ({
        amount: Number(pay.amount).toLocaleString() || '—',
        date: isoToJalali(pay.date) || '—',
        period: pay.paymentMonth && pay.paymentYear ? `${pay.paymentMonth}/${pay.paymentYear}` : '—',
        type: pay.type || '—'
      }));
  } catch (e) {
    console.error('Error processing payments:', e);
  }

  // remember current player on the profile view root for delegated actions
  try {
    const profileView = qs('#view-player-profile'); if (profileView) profileView.dataset.currentPlayer = p.id;
    // Do not add a delegated click handler for #shareProfile to avoid duplicate invocations;
    // we will bind a single direct handler to the share button below.
  } catch (e) { console.warn('profile view dataset assignment failed', e); }

  // بررسی و تنظیم scores
  let scores = p.scores || {};
  let avgScore;
  try {
    avgScore = calcAverageScore(p) || '—';
  } catch (e) {
    console.error('Error in calcAverageScore:', e);
    avgScore = 'نامشخص';
  }

  // بررسی وضعیت بیمه
  let expired = false;
  let insuranceStatus = 'بیمه‌ای ثبت نشده';
  try {
    expired = isInsuranceExpired(p.insuranceDate);
    insuranceStatus = p.insuranceDate ? (expired ? 'منقضی' : 'فعال') + ` (${p.insuranceDate})` : 'بیمه‌ای ثبت نشده';
  } catch (e) {
    console.error('Error in isInsuranceExpired:', e);
  }

  // محاسبه سابقه عضویت
  let membershipDuration;
  try {
    membershipDuration = calculateMembershipDuration(p.joinDate) || '—';
  } catch (e) {
    console.error('Error in calculateMembershipDuration:', e);
    membershipDuration = 'نامشخص';
  }

  // محاسبه BMI
  let bmiHtml;
  try {
    let bmiData = calculateBMI(p.height, p.weight);
    bmiHtml = bmiData
      ? `
        <div><strong>شاخص سلامت (BMI):</strong> ${bmiData.bmi} (${bmiData.status})</div>
        <div style="background: #e2e8f0; height: 10px; border-radius: 5px; position: relative; margin-top: 4px; margin-bottom: 8px;">
          <div style="width: ${bmiData.percent}%; background: ${bmiData.color}; height: 100%; border-radius: 5px;"></div>
        </div>
        <small>اضافه وزن: ${bmiData.excessWeight.toFixed(1)} kg</small>
      `
      : '<div>اطلاعات کافی برای محاسبه BMI نیست</div>';
  } catch (e) {
    console.error('Error in calculateBMI:', e);
    bmiHtml = '<div>خطا در محاسبه BMI</div>';
  }

  // بررسی و تنظیم رویدادها
  let eventsHtml;
  try {
    eventsHtml = p.events && Array.isArray(p.events) && p.events.length > 0
      ? p.events.map((e, idx) => `<div class="muted">${escapeHtml(e.text)} (${e.date})</div>`).join('')
      : '<div class="muted">بدون رویداد</div>';
  } catch (e) {
    console.error('Error processing events:', e);
    eventsHtml = '<div class="muted">خطا در بارگذاری رویدادها</div>';
  }

  // محاسبه وضعیت قد نسبت به میانگین استاندارد بر اساس سن و جنس
  let statureStatus = '';
  try {
    const statureTable = {
      1: { male:75, female:74 },2:{male:87,female:86},3:{male:95,female:94},4:{male:102,female:101},5:{male:109,female:108},6:{male:115,female:115},7:{male:121,female:121},8:{male:127,female:128},9:{male:133,female:134},10:{male:138,female:139},11:{male:144,female:145},12:{male:149,female:151},13:{male:156,female:156},14:{male:163,female:158},15:{male:169,female:160},16:{male:173,female:162},17:{male:175,female:163},18:{male:176,female:163}
    };
    const ageY = Math.max(1, Math.min(18, Number(age.years) || 1));
    const expected = (p.gender === 'female') ? (statureTable[ageY].female || statureTable[ageY].male) : (statureTable[ageY].male || statureTable[ageY].female);
    if (p.height) {
      const diff = Number(p.height) - expected;
      if (Math.abs(diff) < 2) statureStatus = 'خوبه';
      else if (diff >= 6) statureStatus = 'عالیه';
      else if (diff >= 2) statureStatus = 'کمی بلند';
      else if (diff <= -6) statureStatus = 'ضعیف';
      else if (diff <= -2) statureStatus = 'کمی کوتاه';
      else statureStatus = 'خوبه';
    }
  } catch(e) { console.error('stature calc error', e); }

  // تولید HTML پروفایل (طرح جدید: ستون چپ عکس/وضعیت/یادداشت، ستون راست اطلاعات/مهارت‌ها/جلسات/پرداخت‌ها)
  let profileHtml = `
  <div class="profile-grid" style="display:grid;grid-template-columns:260px 1fr;gap:12px;align-items:start;" id="profileModalContent">
    <div class="profile-left">
      <div class="card" style="text-align:center;padding:16px;">
        <div style="width:160px;height:160px;border-radius:12px;overflow:hidden;margin:0 auto;background:#e2e8f0;">
          ${p.photo ? `<img id="profileImg" src="${p.photo}" style="width:100%;height:100%;object-fit:cover;">` : '<div class="muted">بدون عکس</div>'}
        </div>
        <h3 style="margin-top:12px;">${escapeHtml(p.name || '—')}</h3>
        <div id="categoryDisplay" class="muted" style="cursor:pointer;">رده: ${category || '—'}</div>
  <!-- time-to-next-category removed -->
        <div class="badge ${expired ? 'danger' : expired === false ? '' : 'warning'}" style="margin-top:8px;">بیمه: ${insuranceStatus}</div>
      </div>

      <!-- action buttons: single responsive horizontal row -->
      <div class="card" style="margin-top:8px;padding:12px;">
        <div class="profile-action-row" style="display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:nowrap;">
            <button id="addPaymentFromProfile" class="btn primary" style="flex:1 1 auto;min-width:90px;max-width:220px;">ثبت پرداخت</button>
            <button id="editFromProfile" class="btn" style="flex:1 1 auto;min-width:90px;max-width:220px;">ویرایش</button>
            <button id="shareProfile" class="btn" style="flex:1 1 auto;min-width:90px;max-width:220px;">اشتراک‌گذاری</button>
          </div>
      </div>

      <div class="card" style="margin-top:8px;">
        <div class="section-title"><h3>اطلاعات فردی</h3></div>
        <div style="text-align:right;display:grid;gap:8px;">
          <div><strong>کد ملی:</strong> ${escapeHtml(p.nationalCode || '—')}</div>
          <div><strong>تلفن:</strong> ${escapeHtml(p.phone || '—')}</div>
          <div><strong>نام پدر:</strong> ${escapeHtml(p.fatherName || '—')}</div>
          <div><strong>شماره والد:</strong> ${escapeHtml(p.parentPhone || '—')}</div>
          <div><strong>تاریخ تولد:</strong> ${p.birthdate || '—'}</div>
          <div><strong>سن:</strong> ${typeof age === 'object' ? ( (typeof age.years !== 'undefined' ? age.years : '—') + ' سال، ' + (typeof age.months !== 'undefined' ? age.months : '—') + ' ماه، ' + (typeof age.days !== 'undefined' ? age.days : '—') + ' روز' ) : '—'}</div>
          <div><strong>تاریخ عضویت:</strong> ${p.joinDate || '—'}</div>
          <div><strong>سابقه عضویت:</strong> ${membershipDuration}</div>
        </div>
      </div>

      <div class="card" style="margin-top:8px;">
        <h4 style="margin:0 0 8px 0">وضعیت جسمانی</h4>
        <div>${bmiHtml}</div>
        <div style="margin-top:8px;"><strong>قد:</strong> ${p.height ? p.height + ' cm' : '—'} ${statureStatus ? ('<span class="muted">(' + statureStatus + ')</span>') : ''}</div>
        <div><strong>وزن:</strong> ${p.weight ? p.weight + ' kg' : '—'}</div>
      </div>
    </div>

    <div class="profile-right">
      <div class="card">
        <div class="section-title"><h3>مهارت‌ها و امتیازها</h3></div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
            <div style="display:flex;align-items:center;gap:8px;"><img src="./icons/jersey.png" alt="jersey" style="width:28px;height:28px;object-fit:contain;"> <strong style="margin-right:6px;">${escapeHtml(p.jersey || '—')}</strong></div>
            <div class="muted" style="font-size:13px;">پست: ${escapeHtml(p.favoritePosition || '—')}</div>
          </div>
          <div><strong>امتیاز کلی:</strong> <span class="badge">${avgScore}</span></div>
        </div>
        <div style="margin-top:8px;" class="score-list">
          ${Object.keys(scores).length ? Object.keys(scores).map(key => `<div>${escapeHtml((key||'').replace(/_/g,' '))}: ${scores[key] || 0}</div>`).join('') : '<div class="muted">هیچ امتیازی ثبت نشده</div>'}
        </div>

      </div>

  <!-- action-buttons moved to left column -->

  <div class="card" style="margin-top:8px;">
        <div class="section-title"><h3>جلسات اخیر و پرداخت‌ها</h3></div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;">
          <div style="flex:1;min-width:200px;">
            <strong>جلسات شرکت‌کرده (${sessions.length})</strong>
            ${sessions.length ? `<div style="margin-top:8px; max-height:200px; overflow:auto;">${sessions.slice(0,5).map(s => `<div>${escapeHtml(s.title)} - ${s.date} (${s.category})</div>`).join('')}${sessions.length>5?`<div style="margin-top:6px;"><a href="#" class="view-more show-all-sessions">مشاهده همه جلسات (${sessions.length})</a></div>`:''}</div>` : '<div class="muted">هیچ جلسه‌ای</div>'}
          </div>
          <div style="flex:1;min-width:200px;">
            <strong>پرداخت‌ها (${payments.length})</strong>
            ${payments.length ? `<div style="margin-top:8px; max-height:200px; overflow:auto;">${payments.slice(0,5).map(pay => `<div>${pay.amount} تومان - ${pay.date} - ${pay.period} (${escapeHtml(pay.type)})</div>`).join('')}${payments.length>5?`<div style="margin-top:6px;"><a href="#" class="view-more show-all-payments">مشاهده همه پرداخت‌ها (${payments.length})</a></div>`:''}</div>` : '<div class="muted">هیچ پرداختی</div>'}
          </div>
        </div>
      </div>

        <!-- notes moved to the very bottom with add-note button -->
        <div class="card" style="margin-top:8px;">
          <div style="display:flex;align-items:center;margin-bottom:8px;">
            <h4 style="margin:0">یادداشت‌ها</h4>
            <button id="addNoteFromProfile" title="یادداشت جدید" class="btn small primary" style="margin-inline-start:auto;padding:6px 10px;font-size:13px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">+ افزودن یادداشت</button>
          </div>
          <div id="profileNotesContent" style="display:grid;gap:8px;grid-template-columns:1fr;">${/* notes will be injected by JS */''}</div>
        </div>

        <!-- membership card issuance button inside action area (kept near other actions) -->
        <div style="display:none;"> <!-- placeholder to keep structure clear -->
        </div>
    </div>
  </div>
  `;

  try {
    content.innerHTML = profileHtml;
  } catch (e) {
    console.error('Error setting profile HTML:', e);
    return showView('players');
  }

  // render notes list as cards
  try {
    const notesContainer = qs('#profileNotesContent');
    if (notesContainer) {
      notesContainer.innerHTML = '';
      const notes = p.events && Array.isArray(p.events) ? p.events.slice().reverse() : [];
      if (!notes.length) {
        notesContainer.innerHTML = '<div class="muted">بدون یادداشت</div>';
      } else {
        notes.forEach((n, idx) => {
          const card = document.createElement('div');
          card.className = 'note-card';
          // show author name (if available) before the date
          const authorName = (n && n.author && n.author.name) ? escapeHtml(n.author.name) + ' • ' : '';
          card.innerHTML = `
            <div class="note-meta"><div>${authorName}${escapeHtml(n.date || '')}</div><div class="note-actions"><button class="btn small" data-edit-idx="${idx}">ویرایش</button><button class="btn small danger" data-del-idx="${idx}">حذف</button></div></div>
            <div class="note-body">${escapeHtml(n.text)}</div>
          `;
          notesContainer.appendChild(card);
        });
        // wire edit/delete
        notesContainer.querySelectorAll('[data-edit-idx]').forEach(b => b.addEventListener('click', (e) => {
          const i = Number(e.currentTarget.dataset.editIdx);
          openNotesModal(p.id, i);
        }));
        notesContainer.querySelectorAll('[data-del-idx]').forEach(b => b.addEventListener('click', (e) => {
          const i = Number(e.currentTarget.dataset.delIdx);
          if (confirm('حذف شود؟')) {
            p.events.splice(i, 1);
            saveState();
            renderPlayerProfile(p.id);
          }
        }));
      }
    }
  } catch (e) { console.error('Error rendering notes list', e); }

  // اتصال event listenerها
  try {
  // #closeProfile button was removed from the template; no handler needed
  on('#editFromProfile', 'click', () => showView('player-form', { player: p }));
  on('#addPaymentFromProfile', 'click', () => openPaymentModal(p.id));
  on('#addNoteFromProfile', 'click', () => openNotesModal(p.id, null));
    // Defensive binding: attach direct event handler to the actual element
    try {
      const _sp = qs('#shareProfile');
      if (_sp) {
        // remove previous handler if present
        try { if (_sp._sharedHandler) _sp.removeEventListener('click', _sp._sharedHandler); } catch(_e){}
  _sp._sharedHandler = function(e){ e.preventDefault && e.preventDefault(); try { if (typeof exportPoster600 === 'function') { return exportPoster600(p); } return shareProfileDirect(p); } catch(err){ console.error('shareProfile handler error', err); try { shareProfileDirect(p); } catch(_){} } };
        _sp.addEventListener('click', _sp._sharedHandler, false);
      }
    } catch(e) { console.warn('defensive shareProfile binding failed', e); }

  // صدور کارت عضویت removed: nothing to wire

    if (qs('.show-all-sessions')) {
      qs('.show-all-sessions').addEventListener('click', () => showView('all-sessions', { playerId: p.id }));
    }
    if (qs('.show-all-payments')) {
      qs('.show-all-payments').addEventListener('click', () => showView('all-payments', { playerId: p.id }));
    }

    // timeToNextDisplay removed — no toggle binding needed

  on('#backProfile', 'click', () => { showView('players'); });
  // back button for membership view
  try { on('#backMembership', 'click', () => { if (!goBack()) showView('players'); }); } catch(e) {}
  } catch (e) {
    console.error('Error attaching event listeners:', e);
  }
}

// Private class (one-to-many players per coach) - create/edit modal
function renderPrivateClass(coachId, classId) {
  let titleEl = qs('#privateClassTitle');
  titleEl.textContent = classId ? 'ویرایش کلاس خصوصی' : 'افزودن کلاس خصوصی';
  let content = qs('#privateClassContent');
  let coach = state.coaches.find(x => x.id === coachId) || null;
  let cls = (state.privateClasses || []).find(x => x.id === classId) || null;

  let html = `<div style="display:flex;flex-direction:column;gap:12px;margin-top:12px;">`;
  html += `<div><strong>مربی:</strong> ${coach ? escapeHtml(coach.name) : '—'}</div>`;
  html += `<div><label for="pc_title">عنوان کلاس</label><input id="pc_title" class="input" type="text" value="${cls ? escapeHtml(cls.title || '') : ''}"></div>`;
  html += `<div style="max-height:280px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:8px;"><strong>انتخاب بازیکنان</strong><div style="display:flex;flex-direction:column;gap:6px;margin-top:8px;">`;
  (state.players || []).forEach(p => {
    let checked = cls && Array.isArray(cls.players) && cls.players.includes(p.id) ? 'checked' : '';
    let imgHtml = p.photo ? `<img src="${p.photo}" style="width:28px;height:28px;border-radius:6px;object-fit:cover;margin-left:8px;">` : `<svg width="28" height="28" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>`;
    html += `<label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" data-player="${p.id}" ${checked}>${imgHtml}<span>${escapeHtml(p.name)}</span></label>`;
  });
  html += `</div></div>`;
  html += `<div class="form-actions" style="margin-top:12px;display:flex;gap:8px;justify-content:center;">`;
  html += `<button id="savePrivateClass" class="btn primary">${classId ? 'ذخیره' : 'افزودن'}</button>`;
  html += `<button id="cancelPrivateClass" class="btn">انصراف</button>`;
  if (classId) html += `<button id="deletePrivateClass" class="btn danger">حذف</button>`;
  html += `</div></div>`;

  content.innerHTML = html;

  on('#cancelPrivateClass', 'click', () => showView('coaches'));
  on('#backPrivateClass', 'click', () => { if (!goBack()) showView('coaches'); });

  on('#savePrivateClass', 'click', () => {
    let title = qs('#pc_title').value.trim();
    let selected = [];
    qsa('#privateClassContent input[type="checkbox"][data-player]').forEach(cb => { if (cb.checked) selected.push(cb.dataset.player); });
    if (!state.privateClasses) state.privateClasses = [];
    if (classId) {
      let idx = state.privateClasses.findIndex(x => x.id === classId);
      if (idx > -1) {
        state.privateClasses[idx] = { ...state.privateClasses[idx], title, players: selected, coachId, updatedAt: new Date().toISOString() };
      }
    } else {
      state.privateClasses.push({ id: uid('pc'), coachId, title, players: selected, createdAt: new Date().toISOString() });
    }
    saveState();
    showView('coaches');
    renderCoaches();
  });

  if (classId) on('#deletePrivateClass', 'click', () => {
    if (confirm('حذف شود؟')) {
      state.privateClasses = (state.privateClasses || []).filter(x => x.id !== classId);
      saveState();
      showView('coaches');
      renderCoaches();
    }
  });
}

function renderAllSessions(playerId) {
  let title = qs('#allSessionsTitle');
  title.textContent = 'همه جلسات';
  let content = qs('#allSessionsContent');
  let p = state.players.find(x => x.id === playerId);
  if (!p) return;
  let sessions = state.sessions.filter(s => s.attendances?.[p.id]?.present).map(s => ({
    title: s.title || 'جلسه',
    date: isoToJalali(s.date),
    category: s.category
  }));
  
  content.innerHTML = `
    ${sessions.map(s => `
      <div style="padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.1);">
        <div><strong>${s.title}</strong></div>
        <div class="muted">${s.date} • ${s.category || '—'}</div>
      </div>
    `).join('')}
    <div class="form-actions">
      <button id="closeAllSessions" class="btn">بستن</button>
    </div>
  `;
  on('#closeAllSessions', 'click', () => { if (!goBack()) showView('player-profile', {playerId}); });
  on('#backAllSessions', 'click', () => { if (!goBack()) showView('player-profile', {playerId}); });
}

function renderAllPayments(playerId) {
  let title = qs('#allPaymentsTitle');
  title.textContent = 'همه پرداخت‌ها';
  let content = qs('#allPaymentsContent');
  let p = state.players.find(x => x.id === playerId);
  if (!p) return;
  let payments = state.payments.filter(x => x.playerId === p.id).map(pay => ({
    amount: Number(pay.amount).toLocaleString(),
    date: isoToJalali(pay.date),
    period: pay.paymentMonth && pay.paymentYear ? `${pay.paymentMonth}/${pay.paymentYear}` : '—',
    type: pay.type || '—'
  }));
  
  content.innerHTML = `
    ${payments.map(p => `
      <div style="padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.1);">
        <div><strong>${p.amount} تومان</strong></div>
        <div class="muted">${p.date} • دوره: ${p.period} • ${p.type}</div>
      </div>
    `).join('')}
    <div class="form-actions">
      <button id="closeAllPayments" class="btn">بستن</button>
    </div>
  `;
  on('#closeAllPayments', 'click', () => showView('player-profile', {playerId}));
  on('#backAllPayments', 'click', () => { if (!goBack()) showView('player-profile', {playerId}); });
}

// نمایش مودال اشتراک‌گذاری پروفایل (متن، PDF، HTML)
function renderShareProfile(playerId) {
  let title = qs('#shareTitle');
  if (title) title.textContent = 'اشتراک‌گذاری پروفایل';
  let content = qs('#shareContent');
  let p = state.players.find(x => x.id === playerId);
  if (!p) return showView('players');

  let textExport = `پروفایل ${p.name}\nتلفن: ${p.phone || '—'}\nرده: ${determineCategory(calcExactAge(p.birthdate))}\nتوضیحات: ${p.notes || ''}`;

  content.innerHTML = `
    <div style="display:grid;gap:8px;">
      <div><strong>گزینه‌ها:</strong></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="exportText" class="btn">کپی به صورت متن</button>
        <button id="exportHtml" class="btn">دانلود HTML</button>
        <button id="exportPdf" class="btn primary">ساخت PDF</button>
      </div>
      <div style="margin-top:12px;">نمایش پیش‌نمایش:</div>
      <pre id="sharePreview" style="background:#f7fafc;padding:8px;border-radius:6px;max-height:200px;overflow:auto;">${escapeHtml(textExport)}</pre>
    </div>
  `;

  on('#exportText', 'click', () => {
    navigator.clipboard?.writeText(textExport).then(() => alert('متن کپی شد')).catch(() => alert('کپی ناموفق'));
  });

  on('#exportHtml', 'click', () => {
    let html = `<!doctype html><html><head><meta charset="utf-8"><title>پروفایل ${escapeHtml(p.name)}</title></head><body><h1>${escapeHtml(p.name)}</h1><p>تلفن: ${escapeHtml(p.phone || '—')}</p><p>رده: ${escapeHtml(determineCategory(calcExactAge(p.birthdate)))}</p><p>یادداشت‌ها:${escapeHtml(p.notes || '')}</p></body></html>`;
    let blob = new Blob([html], { type: 'text/html' });
    let a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `profile-${p.id}.html`;
    a.click();
  });

  on('#exportPdf', 'click', () => {
    // ساده: از html2canvas و jsPDF استفاده می‌کنیم (اگر jsPDF موجود باشد)
    html2canvas(qs('#profileModalContent'), { backgroundColor: '#fff' }).then(canvas => {
      try {
        if (window.jsPDF) {
          let imgData = canvas.toDataURL('image/png');
          let pdf = new jsPDF({ unit: 'pt', format: 'a4' });
          let ratio = Math.min(595 / canvas.width, 842 / canvas.height);
          pdf.addImage(imgData, 'PNG', 0, 0, canvas.width * ratio, canvas.height * ratio);
          pdf.save(`profile-${p.id}.pdf`);
        } else {
          // fallback: download image
          let a = document.createElement('a');
          a.href = canvas.toDataURL('image/png');
          a.download = `profile-${p.id}.png`;
          a.click();
        }
      } catch (e) {
        console.error('Error exporting PDF:', e);
        alert('شبکهٔ خروجی موفق نشد');
      }
    }).catch(e => { console.error(e); alert('خطا در گرفتن تصویر'); });
  });

  on('#closeShare', 'click', () => showView('player-profile', { playerId }));
}

// نمایش مودال صدور کارت عضویت با خروجی تصویر
function renderMembershipCard(playerId) {
  let title = qs('#membershipTitle'); if (title) title.textContent = 'صدور کارت عضویت';
  let content = qs('#membershipContent');
  let p = state.players.find(x => x.id === playerId);
  if (!p) return showView('players');
  // New layout: settings box, preview box, buttons box
  content.innerHTML = `
    <div style="display:grid;gap:12px;">
      <div class="card" style="display:flex;flex-direction:column;gap:8px;">
        <div style="font-weight:700">تنظیمات کارت</div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="font-size:13px;margin-left:6px">رنگ آغاز</label>
            <input id="memColorA" type="color" value="#06B6D4" />
            <label style="font-size:13px;margin-left:6px">رنگ پایان</label>
            <input id="memColorB" type="color" value="#8B5CF6" />
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="margin-left:6px">رنگ فونت</label>
            <input id="memFontColor" type="color" value="#0f172a" />
          </div>
          <div style="display:flex;gap:10px;align-items:center;margin-top:6px;flex-basis:100%">
            <label style="font-size:13px;margin-right:6px">نمایش در کارت:</label>
            <label style="display:flex;align-items:center;gap:6px"><input id="chkPhoto" type="checkbox" checked /> عکس</label>
            <label style="display:flex;align-items:center;gap:6px"><input id="chkClubLogo" type="checkbox" checked /> لوگوی باشگاه</label>
            <label style="display:flex;align-items:center;gap:6px"><input id="chkBirth" type="checkbox" checked /> تاریخ تولد</label>
            <label style="display:flex;align-items:center;gap:6px"><input id="chkNational" type="checkbox" checked /> کد ملی</label>
            <label style="display:flex;align-items:center;gap:6px"><input id="chkJoinDate" type="checkbox" checked /> تاریخ عضویت</label>
            <label style="display:flex;align-items:center;gap:6px"><input id="chkClubName" type="checkbox" checked /> نام باشگاه</label>
          </div>
        </div>
      </div>

  <div class="card" style="display:flex;flex-direction:column;align-items:center;">
        <div style="font-weight:700;margin-bottom:8px;">پیش‌نمایش کارت عضویت</div>
  <div id="membershipCard" style="position:relative;--card-original-width:520;--card-original-height:380px;--card-scale: min(1, calc((100vw - 32px) / 520));max-width:98vw;max-width:520px;width:100%;min-height:220px;padding:10px;border-radius:12px;background:var(--accent);color:var(--mem-font-color, var(--text));direction:rtl;font-family:'Vazirmatn',sans-serif;overflow:hidden;border:1px solid rgba(0,0,0,0.06);">
          <!-- scale wrapper: actual card content is 520px wide and will scale down via transform -->
          <div class="membership-scale-wrapper" style="width:520px;margin:0 auto;transform-origin:top center;">
          <!-- explicit placement for 12 cells (rows adjusted to 30/40/30) -->
          <div id="membershipInnerGrid" style="display:grid;grid-template-rows:auto;grid-auto-rows:1fr;grid-template-columns:repeat(4,1fr);gap:6px;width:100%;min-height:100%;align-items:stretch;">
            <!-- row1 col1 (empty) -->
            <div style="grid-row:1;grid-column:1;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center;color:var(--mem-font-color, var(--text));font-weight:700;font-size:18px"></div>
            <!-- 2-3 merged: club name spanning columns 2 and 3 -->
            <div id="cell2" style="grid-row:1;grid-column:2 / span 2;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px">${escapeHtml(state.settings.title || 'باشگاه')}</div>
            <!-- 4: club logo -->
            <div id="cell4" style="grid-row:1;grid-column:4;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center;">
              <img id="pcClubLogoImg" src="${escapeHtml(state.settings.logo || 'icons/logo.png')}" style="max-width:100%;max-height:100%;object-fit:contain" />
            </div>

            <!-- 5: profile photo -->
            <div id="cell5" style="grid-row:2;grid-column:1;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center;">
              ${p.photo?`<img id="pcPhotoImg" src="${p.photo}" style="width:100%;height:100%;object-fit:cover">`:`<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted)">عکس</div>`}
            </div>
            <!-- 6: stacked player info (span visually) -->
            <div id="cell6" style="grid-row:2;grid-column:2 / span 2;border-radius:6px;padding:6px;display:flex;flex-direction:column;align-items:flex-start;justify-content:center;text-align:left;font-weight:700;">
              <div id="pcName" style="font-size:16px;color:var(--mem-font-color, var(--text));">${escapeHtml(p.name)}</div>
              <div id="pcBirth" style="font-size:13px;color:var(--mem-font-color, rgba(255,255,255,0.85));margin-top:6px">تاریخ تولد: ${escapeHtml(isoToJalali(p.birthdate) || '—')}</div>
              <div id="pcNational" style="font-size:13px;color:var(--mem-font-color, rgba(255,255,255,0.85));margin-top:6px">کد ملی: ${escapeHtml(p.nationalCode || '—')}</div>
            </div>
            <!-- 7 placeholder (right column of row 2 if needed) -->
            <div id="cell7" style="grid-row:2;grid-column:4;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center;color:rgba(15,23,42,0.9);"></div>

            <!-- 8: volleyball (2) image -->
            <div id="cell8" style="grid-row:3;grid-column:1;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center;color:rgba(15,23,42,0.9);">
              <img src="icons/volleyball (2).png" style="max-width:100%;max-height:100%;object-fit:contain" />
            </div>
            <!-- 9-10 merged: join & expiry stacked (join emphasized) -->
            <div id="cell9" style="grid-row:3;grid-column:2 / span 2;border-radius:6px;padding:6px;display:flex;flex-direction:column;align-items:flex-start;justify-content:center;text-align:left;">
              <div id="pcJoinDate" style="font-size:15px;font-weight:800">تاریخ عضویت: ${escapeHtml(p.joinDate || '—')}</div>
              <div id="pcExpire" style="margin-top:6px;font-size:13px">تاریخ انقضا: ${escapeHtml(p.expiryDate || 'مادام\u200cالعمر')}</div>
            </div>
            <!-- 11: volleyball-player centered -->
            <div id="cell11" style="grid-row:3;grid-column:4;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center;color:rgba(15,23,42,0.9);">
              <img src="icons/volleyball-player.png" style="max-width:70%;max-height:70%;object-fit:contain" />
            </div>
            <!-- 12 placeholder (unused) -->
            <div id="cell12" style="display:none"></div>
          </div>
          </div>
          <!-- overlay removed - volleyball icons moved into cells 8 and 11 -->
        </div>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-start;">
        <button id="downloadCardImage" class="btn primary">دانلود کارت</button>
        <button id="shareCard" class="btn">اشتراک‌گذاری</button>
        <button id="printCard" class="btn">چاپ</button>
      </div>
    </div>
  `;

  // wire settings -> preview updates
  (function(){
    const card = qs('#membershipCard');
    const colorA = qs('#memColorA');
    const colorB = qs('#memColorB');
    
    const pcPhoto = qs('#pcPhoto');
    const pcPhotoImg = qs('#pcPhotoImg');
    const pcClubLogo = qs('#pcClubLogo');
    const pcClubLogoImg = qs('#pcClubLogoImg');
    const pcBirth = qs('#pcBirth');
    const pcNational = qs('#pcNational');
    const pcJoinDate = qs('#pcJoinDate');
    const pcClubName = qs('#pcClubName');
  const memFontColor = qs('#memFontColor');
  // checkboxes
  const chkPhoto = qs('#chkPhoto');
  const chkClubLogo = qs('#chkClubLogo');
  const chkBirth = qs('#chkBirth');
  const chkNational = qs('#chkNational');
  const chkJoinDate = qs('#chkJoinDate');
  const chkClubName = qs('#chkClubName');

  function applyColors(){
      const a = colorA ? colorA.value : '#06B6D4';
      const b = colorB ? colorB.value : '#8B5CF6';
      if (card) card.style.background = `linear-gradient(135deg, ${a} 0%, ${b} 100%)`;
      // apply font color/weight CSS variables
      const fc = memFontColor ? memFontColor.value : '#0f172a';
  const fw = '700';
      if (card) {
        card.style.setProperty('--mem-font-color', fc);
        // apply to specific elements as inline style too for better html2canvas capture
        const nameEl = qs('#pcName'); if (nameEl) { nameEl.style.color = fc; nameEl.style.fontWeight = fw; }
        const birthEl = qs('#pcBirth'); if (birthEl) { birthEl.style.color = fc; birthEl.style.fontWeight = fw; }
        const natEl = qs('#pcNational'); if (natEl) { natEl.style.color = fc; natEl.style.fontWeight = fw; }
      }
    }
    function applyVisibility(){
  if (pcPhoto) pcPhoto.style.display = (chkPhoto && chkPhoto.checked) ? 'block' : 'none';
  if (pcClubLogoImg) pcClubLogoImg.style.display = (chkClubLogo && chkClubLogo.checked) ? 'block' : 'none';
  if (pcBirth) pcBirth.style.display = (chkBirth && chkBirth.checked) ? 'block' : 'none';
  if (pcNational) pcNational.style.display = (chkNational && chkNational.checked) ? 'block' : 'none';
  if (pcJoinDate) pcJoinDate.style.display = (chkJoinDate && chkJoinDate.checked) ? 'block' : 'none';
  if (pcClubName) pcClubName.style.display = (chkClubName && chkClubName.checked) ? 'block' : 'none';
    }
    // compute and apply scale for the inner wrapper so the whole card scales proportionally
    function applyCardScale(){
      const wrapper = qs('.membership-scale-wrapper');
      if (!wrapper || !card) return;
      // available width inside card (accounting for card padding)
      const padding = 20; // approximate
      const avail = Math.max(200, card.clientWidth - padding);
      const base = 520; // design width
      let scale = Math.min(1, avail / base);
      if (scale < 0.5) scale = 0.5; // minimum readable
      // Instead of transform, resize the wrapper so the parent flow adapts
      const newWidth = Math.round(base * scale);
      wrapper.style.width = newWidth + 'px';
      // scale fonts by adjusting root font-size on the wrapper
      const baseFont = 16; // reference
      wrapper.style.fontSize = (baseFont * scale) + 'px';
      // adjust images max-height proportional to scale
      const imgs = wrapper.querySelectorAll('img');
      imgs.forEach(i => { i.style.maxHeight = Math.round(140 * scale) + 'px'; });
    }
    // run on init and on resize
    applyCardScale();
    window.addEventListener('resize', applyCardScale);
    if (colorA) colorA.addEventListener('input', applyColors);
    if (colorB) colorB.addEventListener('input', applyColors);
    if (memFontColor) memFontColor.addEventListener('input', applyColors);
    [chkPhoto,chkClubLogo,chkBirth,chkNational,chkJoinDate,chkClubName].forEach(ch=>{ if (ch) ch.addEventListener('change', applyVisibility); });
    // run initial
    applyColors(); applyVisibility();
  applyCardScale();

  // ensure club logo fallback
  if (pcClubLogoImg && (!pcClubLogoImg.src || pcClubLogoImg.src.trim()==='')) pcClubLogoImg.src = 'icons/logo.png';

    // download/share/print handlers (reuse existing share/download logic for cards)
    const downloadBtn = qs('#downloadCardImage');
    const shareBtn = qs('#shareCard');
    const printBtn = qs('#printCard');
    async function captureCardAndDownload(){
      try{
        const outCanvas = document.createElement('canvas'); outCanvas.width = 1080; outCanvas.height = 640; const ctx = outCanvas.getContext('2d');
        // draw gradient background
  const colA = colorA ? colorA.value : '#e0f2fe'; const colB = colorB ? colorB.value : '#bae6fd';
        const g = ctx.createLinearGradient(0,0,0,outCanvas.height); g.addColorStop(0,colA); g.addColorStop(1,colB); ctx.fillStyle = g; ctx.fillRect(0,0,outCanvas.width,outCanvas.height);
        // render simple text and images by drawing img elements where available
        // draw club logo (right)
        const logoImg = pcClubLogoImg && pcClubLogoImg.src ? await loadImage(pcClubLogoImg.src) : null;
  const photoImg = pcPhotoImg && pcPhotoImg.src ? await loadImage(pcPhotoImg.src) : null;
        if (logoImg) ctx.drawImage(logoImg, outCanvas.width-140, 40, 96, 96);
        if (photoImg) ctx.drawImage(photoImg, 40, 160, 176, 176);
        // draw name and stacked info (approx positions)
        ctx.fillStyle = '#0f172a'; ctx.font = '700 48px Vazirmatn, sans-serif'; ctx.textAlign='left';
        const nameX = 240; const nameY = 210;
        ctx.fillText((qs('#pcName')?.textContent)||'', nameX, nameY);
        ctx.font = '400 28px Vazirmatn, sans-serif';
  // show birth/national if present
  const birthText = (qs('#pcBirth')?.textContent) || '';
  const natText = (qs('#pcNational')?.textContent) || '';
  if (birthText) ctx.fillText(birthText, nameX, nameY + 48);
  if (natText) ctx.fillText(natText, nameX, nameY + 92);
        // validity bottom-left and volleyball icon bottom-right
  ctx.font = '400 24px Vazirmatn, sans-serif';
  // expiry default to مادام‌العمر if empty
  const expiryText = (qs('#pcExpire')?.textContent) || 'تاریخ انقضا: مادام‌العمر';
  ctx.fillText(expiryText, 36, outCanvas.height - 36);
        const volleyImg = await loadImage('icons/volleyball-player.png');
        if (volleyImg) ctx.drawImage(volleyImg, outCanvas.width - 76, outCanvas.height - 76, 64, 64);
        const blob = await new Promise(res => outCanvas.toBlob(res,'image/png'));
        if (!blob) throw new Error('capture failed');
  const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href=url; link.download = `${escapeFileName(p.name)}-membership.png`; document.body.appendChild(link); link.click(); link.remove(); URL.revokeObjectURL(url);
      } catch(err){ console.error('capture failed',err); alert('خطا در تولید تصویر کارت'); }
    }
    if (downloadBtn) downloadBtn.addEventListener('click', captureCardAndDownload);
    if (shareBtn) shareBtn.addEventListener('click', async ()=>{ try{ await captureCardAndDownload(); alert('تصویر برای اشتراک تهیه شد'); }catch(e){console.warn(e);} });
    if (printBtn) printBtn.addEventListener('click', ()=>{ window.print(); });

    // helper to load image
    function loadImage(src){ return new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=(e)=>res(null); i.src=src; }); }
    function escapeFileName(s){ return (s||'card').replace(/[^a-z0-9\-_.]/gi,'_'); }
  })();

  // header back should return to player profile
  try { on('#backMembership', 'click', () => { if (!goBack()) showView('player-profile', { playerId }); }); } catch(e) { }

  // دانلود تصویر کارت
  on('#downloadCardImage', 'click', () => {
    html2canvas(qs('#membershipCard'), { backgroundColor: null, scale: 2 }).then(canvas => {
      let a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = `membership-${p.id}.png`;
      a.click();
    }).catch(e => { console.error(e); alert('خطا در ساخت تصویر'); });
  });

  // دانلود تصویر کارت
  on('#downloadCardImage', 'click', () => {
    html2canvas(qs('#membershipCard'), { backgroundColor: null, scale: 2 }).then(canvas => {
      let a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = `membership-${p.id}.png`;
      a.click();
    }).catch(e => { console.error(e); alert('خطا در ساخت تصویر'); });
  });

  // اشتراک‌گذاری کارت: ابتدا تلاش برای Web Share با فایل، سپس fallback به تصویر دانلود
  on('#shareCard', 'click', () => {
    html2canvas(qs('#membershipCard'), { backgroundColor: null, scale: 2 }).then(canvas => {
      canvas.toBlob(blob => {
        if (!blob) return alert('خطا در تهیه تصویر');
        let file = new File([blob], `membership-${p.id}.png`, { type: 'image/png' });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({ files: [file], title: `کارت عضویت ${p.name}`, text: 'کارت عضویت' }).catch(() => alert('اشتراک‌گذاری شکست خورد'));
        } else if (navigator.share) {
          // بعضی مرورگرها share را بدون files پشتیبانی می‌کنند
          let url = URL.createObjectURL(file);
          navigator.share({ title: `کارت عضویت ${p.name}`, text: 'کارت عضویت', url }).catch(() => alert('اشتراک‌گذاری شکست خورد'));
        } else {
          // fallback: دانلود تصویر و اطلاع دادن به کاربر
          let a = document.createElement('a');
          a.href = URL.createObjectURL(file);
          a.download = `membership-${p.id}.png`;
          a.click();
          alert('اشتراک‌گذاری مستقیم پشتیبانی نمی‌شود؛ تصویر دانلود شد.');
        }
      }, 'image/png');
    }).catch(e => { console.error(e); alert('خطا در آماده‌سازی تصویر برای اشتراک‌گذاری'); });
  });

  on('#printCard', 'click', () => {
    let w = window.open('', '_blank');
    w.document.write('<html><head><meta charset="utf-8"><title>کارت عضویت</title><style>body{margin:0;padding:20px;background:#fff}</style></head><body>' + qs('#membershipCard').outerHTML + '</body></html>');
    w.document.close();
    w.focus();
    w.print();
  });
  // no bottom close button; header back handles return to profile
}

// Notes modal helpers (global)
function openNotesModal(playerId, noteIndex) {
  let p = state.players.find(x => x.id === playerId);
  if (!p) return alert('بازیکن پیدا نشد'); // Check if player exists
  // helper to populate coach/author select (kept local to this modal)
  function populateNotesAuthorsLocal() {
    try {
      const sel = qs('#notesAuthorSelect'); if (!sel) return;
      sel.innerHTML = '';
      const coaches = (state.coaches || []);
      if (!coaches.length) {
        const o = document.createElement('option'); o.value = ''; o.textContent = '— بدون مربی —'; sel.appendChild(o);
        return;
      }
      const empty = document.createElement('option'); empty.value = ''; empty.textContent = 'انتخاب مربی'; sel.appendChild(empty);
      coaches.forEach(c => {
        const o = document.createElement('option'); o.value = c.id; o.textContent = c.name || c.title || ('مربی'); sel.appendChild(o);
      });
    } catch (e) { console.warn('populateNotesAuthorsLocal failed', e); }
  }
  // Additional logic can be added here
  // create modal if not exists
  let m = qs('#notesModalGlobal');
  if (!m) {
    m = document.createElement('div');
    m.id = 'notesModalGlobal';
    m.className = 'modal hide';
    m.setAttribute('role', 'dialog');
    m.setAttribute('aria-modal', 'true');
    m.innerHTML = `
      <div class="modal-content">
        <div class="modal-header" style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
          <div style="display:flex;align-items:center;gap:8px;">
            <h3 id="notesModalTitle">یادداشت مربی</h3>
            <select id="notesAuthorSelect" class="input" style="min-width:160px;font-size:13px;padding:6px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);"></select>
          </div>
        </div>
        <div class="modal-body"><textarea id="notesGlobalInput" placeholder="نقاط قوت و ضعف..."></textarea></div>
        <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:8px;"><button class="btn" id="notesCloseBtn">بستن</button> <button class="btn primary" id="notesSaveBtn">ذخیره</button></div>
      </div>`;
    document.body.appendChild(m);
    // populate authors into the select
    populateNotesAuthorsLocal();
    on('#notesCloseBtn', 'click', () => closeNotesModal());
    on('#notesSaveBtn', 'click', () => {
      try {
        let txt = qs('#notesGlobalInput').value.trim();
        if (!p.events) p.events = [];
        const sel = qs('#notesAuthorSelect');
        const selId = sel ? sel.value : '';
        const coach = (state.coaches || []).find(c => c.id === selId) || null;
        const author = coach ? { id: coach.id, name: coach.name } : null;
        if (m._editingIndex >= 0) {
          // edit existing (preserve author if none selected)
          const prev = p.events[m._editingIndex] || {};
          p.events[m._editingIndex] = { date: todayJalali(), text: txt, author: (author || prev.author || null) };
        } else {
          // new note
          p.events.push({ date: todayJalali(), text: txt, author });
        }
        p.notes = p.events.length ? p.events[p.events.length - 1].text : '';
        saveState();
        closeNotesModal();
        renderPlayerProfile(playerId);
      } catch (err) { console.error('notes save handler failed', err); alert('خطا هنگام ذخیره یادداشت'); }
    });
    // close when clicking backdrop (outside modal-content)
    m.addEventListener('click', (ev) => {
      if (ev.target === m) closeNotesModal();
    });
  }
  // prepare modal state
  m._editingIndex = (typeof noteIndex !== 'undefined' && noteIndex !== null) ? noteIndex : -1;
  if (m._editingIndex >= 0) {
    qs('#notesModalTitle').textContent = 'ویرایش یادداشت';
    qs('#notesGlobalInput').value = (p.events && p.events[m._editingIndex]) ? p.events[m._editingIndex].text : '';
  // set author select to existing note author if present
  try { const sel = qs('#notesAuthorSelect'); if (sel) { const existing = (p.events && p.events[m._editingIndex] && p.events[m._editingIndex].author) ? p.events[m._editingIndex].author.id : ''; if (existing) { sel.value = existing; } else { sel.value = ''; } } } catch(e){}
  } else {
    qs('#notesModalTitle').textContent = 'یادداشت جدید';
    qs('#notesGlobalInput').value = '';
  // ensure authors are freshly populated
  try { populateNotesAuthorsLocal(); } catch(e) {}
  }
  m.classList.remove('hide');
  // focus textarea for faster entry
  setTimeout(() => {
    let ta = qs('#notesGlobalInput'); if (ta) ta.focus();
  }, 60);
}

function closeNotesModal() {
  let m = qs('#notesModalGlobal');
  if (!m) return;
  m.classList.add('hide');
}

function renderInsurancePage() {
  let list = qs('#insuranceList');
  list.innerHTML = '';
  let cat = qs('#insuranceCategoryFilter').value;
  let status = qs('#insuranceStatusFilter').value;
  let arr = state.players.slice();
  if (cat) arr = arr.filter(p => p.category === cat);
  if (status === 'active') arr = arr.filter(p => p.insuranceDate && !isInsuranceExpired(p.insuranceDate));
  if (status === 'expired') arr = arr.filter(p => p.insuranceDate && isInsuranceExpired(p.insuranceDate));
  if (status === 'none') arr = arr.filter(p => !p.insuranceDate);
  arr.forEach(p => {
    let node = document.createElement('div');
    node.className = 'player-row';
  let imgHtml = p.photo ? `<img class="player-image" src="${p.photo}">` : `<svg width="36" height="36" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>`;
    let exp = isInsuranceExpired(p.insuranceDate);
    let st = p.insuranceDate ? (exp ? 'منقضی' : 'فعال') : 'بدون بیمه';
    let badgeClass = p.insuranceDate ? (exp ? 'danger' : 'success') : 'warning';
    node.innerHTML = `
      <div class="player-thumb">${imgHtml}</div>
      <div class="meta"><strong>${escapeHtml(p.name)}</strong><small>${p.category || '—'} • ${p.insuranceDate || '—'}</small></div>
      <div class="badge ${badgeClass}">${st}</div>
      <button class="btn small edit-ins-btn">ویرایش</button>
    `;
    node.querySelector('.edit-ins-btn').addEventListener('click', () => showView('player-form', {player: p}));
    list.appendChild(node);
  });
  populateCategoryFilter(qs('#insuranceCategoryFilter'));
}

function calculateBMI(heightCm, weightKg) {
  if (!heightCm || !weightKg) return null;
  let heightM = heightCm / 100;
  let bmi = (weightKg / (heightM * heightM)).toFixed(1);
  let status, color, percent;
  let idealWeight = heightM * heightM * 22.5; // BMI ایده‌آل متوسط 22.5
  let excessWeight = weightKg - idealWeight;
  if (bmi < 18.5) { status = 'کم وزن'; color = '#fbbf24'; percent = (bmi / 18.5) * 25; }
  else if (bmi < 25) { status = 'سالم'; color = '#22c55e'; percent = 25 + ((bmi - 18.5) / 6.5) * 25; }
  else if (bmi < 30) { status = 'اضافه وزن'; color = '#f59e0b'; percent = 50 + ((bmi - 25) / 5) * 25; }
  else { status = 'چاق'; color = '#ef4444'; percent = 75 + ((bmi - 30) / 10) * 25; }
  percent = Math.min(100, percent);
  return { bmi, status, color, percent, excessWeight };
}

function renderHealthPage() {
  let list = qs('#healthList');
  list.innerHTML = '';
  let q = normPersian(qs('#healthSearch').value || '');
  let bmiFilter = qs('#healthBmiFilter').value;
  let arr = state.players.slice();
  if (q) arr = arr.filter(p => normPersian(p.name).includes(q));
  if (bmiFilter) arr = arr.filter(p => {
    let bmiData = calculateBMI(p.height, p.weight);
    return bmiData && bmiData.status === bmiFilter;
  });
  arr.forEach(p => {
    let bmiData = calculateBMI(p.height, p.weight);
    let bmiHtml = bmiData ? `
      <div class="bmi-bar">
        <div class="bmi-fill" style="width: ${bmiData.percent}%; background: ${bmiData.color};"></div>
      </div>
      <small>${bmiData.bmi} - ${bmiData.status}</small>
      <small>چربی تقریبی بدن: ${(bmiData.bmi * 1.2).toFixed(1)}%</small>
      <small>اضافه وزن: ${bmiData.excessWeight.toFixed(1)} kg</small>
    ` : '<div class="muted">اطلاعات کافی نیست (قد/وزن)</div>';
    let eventsHtml = p.events.length > 0 ? p.events.map((e, idx) => `
      <div class="event-item">
        <div class="event-text">${e.text} (${e.date})</div>
        <div class="event-actions">
          <button class="btn small edit-event-btn">ویرایش</button>
          <button class="btn small danger delete-event-btn">حذف</button>
        </div>
      </div>
    `).join('') : '<div class="muted">بدون رویداد</div>';
    let card = document.createElement('div');
    card.className = 'health-card';
    card.innerHTML = `
      <div style="display: flex; gap: 12px; align-items: center;">
  <div class="player-thumb">${p.photo ? `<img class="player-image" src="${p.photo}">` : '<svg width="56" height="56" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>'}</div>
        <div>
          <strong>${escapeHtml(p.name)}</strong>
          <small>${p.category || '—'}</small>
        </div>
      </div>
      ${bmiHtml}
      <div style="margin-top: 8px;"><strong>رویدادها:</strong>
        <div class="event-list">${eventsHtml}</div>
      </div>
      <button class="btn small event-btn add-event-btn">ثبت رویداد</button>
    `;
    card.querySelector('.player-thumb').addEventListener('click', () => showView('player-profile', {playerId: p.id}));
    card.querySelector('.add-event-btn').addEventListener('click', () => showView('event-form', {playerId: p.id}));
    let eventItems = card.querySelectorAll('.event-item');
    eventItems.forEach((item, idx) => {
      item.querySelector('.edit-event-btn').addEventListener('click', () => showView('event-form', {playerId: p.id, eventIndex: idx}));
      item.querySelector('.delete-event-btn').addEventListener('click', () => deleteEvent(p.id, idx));
    });
    list.appendChild(card);
  });
  on('#healthSearch', 'input', renderHealthPage);
  on('#healthBmiFilter', 'change', renderHealthPage);
  on('#addHealthEventBtn', 'click', () => {
    let playerId = prompt('شناسه بازیکن را وارد کنید');
    if (playerId) showView('event-form', {playerId});
  });
}

function getExtensionFromContentType(type) {
  if (!type) return '.png';
  if (type.includes('jpeg')) return '.jpg';
  if (type.includes('png')) return '.png';
  if (type.includes('gif')) return '.gif';
  if (type.includes('svg')) return '.svg';
  return '.bin';
}

function renderEventForm(playerId, eventIndex = -1) {
  let title = qs('#eventFormTitle');
  title.textContent = eventIndex >= 0 ? 'ویرایش رویداد' : 'ثبت رویداد';
  let content = qs('#eventFormContent');
  let p = state.players.find(x => x.id === playerId);
  if (!p) return alert('بازیکن پیدا نشد');
  let event = eventIndex >= 0 ? p.events[eventIndex] : { text: '', date: todayJalali() };
  content.innerHTML = `
    <textarea id="eventText" class="input" placeholder="توضیح رویداد..." style="height: 100px; margin-top: 12px;">${event.text}</textarea>
    <label for="eventDate">تاریخ رویداد</label>
    <input id="eventDate" class="input jalali-input" value="${event.date}" />
    <div class="form-actions">
      <button id="saveEvent" class="btn primary">ذخیره</button>
      <button id="cancelEvent" class="btn">انصراف</button>
    </div>
  `;
  on('#cancelEvent', 'click', () => showView('health'));
  on('#saveEvent', 'click', () => {
    let text = qs('#eventText').value.trim();
    let date = qs('#eventDate').value || todayJalali();
    if (text) {
      if (eventIndex >= 0) {
        p.events[eventIndex] = { text, date };
      } else {
        p.events.push({ text, date });
      }
      saveState();
      showView('health');
    } else {
      alert('توضیح رویداد را وارد کنید');
    }
  });
  on('#backEventForm', 'click', () => { if (!goBack()) showView('health'); });
}

function deleteEvent(playerId, index) {
  if (confirm('حذف شود؟')) {
    let p = state.players.find(x => x.id === playerId);
    if (p) p.events.splice(index, 1);
    saveState();
    renderHealthPage();
  }
}

function renderSettings() {
  let content = qs('#settingsContent');
  let dataSize = (localStorage.getItem(STORAGE_KEY)?.length / 1024 || 0).toFixed(2);
  let lastUpdate = state.settings.lastCategoryUpdate || '11 دی 1403';
  // determine display date and color for ranks reference based on mode
  const refMode = state.settings.ranksRefMode || 'auto';
  let displayDate;
  if (refMode === 'auto'){
    const today = todayJalali();
    const parts = today.split('/').map(Number);
    const cutoffThisYear = `${parts[0]}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
    const cutoffNextYear = `${parts[0]+1}/${String(10).padStart(2,'0')}/${String(11).padStart(2,'0')}`;
    displayDate = (jalaliToISO(today) <= jalaliToISO(cutoffThisYear)) ? cutoffThisYear : cutoffNextYear;
  } else {
    displayDate = state.settings.ranksReferenceDate || lastUpdate;
  }
  const displayColor = (refMode === 'auto') ? '#137333' : '#92400e';
  content.innerHTML = `
    <div style="display: grid; gap: 18px; margin-top: 12px;">
  <label for="settingsTitle" style="font-size:15px;">عنوان برنامه</label>
  <input id="settingsTitle" class="input" value="${state.settings.title}" style="font-size:20px;padding:12px;" />
  <hr style="border:none;border-top:1px solid rgba(0,0,0,0.04);" />
  <label style="font-size:15px;">لوگو</label>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-start;">
        <img id="settingsLogoPreview" src="${escapeHtml(state.settings.logo || 'icons/icon-192.png')}" style="width:56px;height:56px;border-radius:8px;object-fit:cover;border:1px solid rgba(0,0,0,0.06);" />
        <input id="settingsLogo" type="file" accept="image/*" />
      </div>
  <hr style="border:none;border-top:1px solid rgba(0,0,0,0.04);" />
  <!-- سبک برنامه removed: theme/style chooser deprecated (theme controlled centrally) -->
  <hr style="border:none;border-top:1px solid rgba(0,0,0,0.04);" />
  <div style="display:flex;align-items:center;gap:8px;">
    <div style="flex:1;">مرجع آپدیت رده‌ها: <strong style="color:${displayColor};font-weight:700;">${displayDate}</strong></div>
      <div style="flex:0;">
      <button id="openRankEditorFromSettings" class="btn small" style="background:var(--accent-2);color:var(--text-inverse);padding:8px 12px;font-weight:700;box-shadow:0 4px 10px rgba(0,0,0,0.09);">ویرایش رده‌ها</button>
    </div>
  </div>
  <hr style="border:none;border-top:1px solid rgba(0,0,0,0.04);" />
  <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:6px;">
  <button id="backupBtnInSettings" class="btn">ذخیره بک آپ در دستگاه</button>
  <button id="restoreBtnInSettings" class="btn">وارد کردن بک‌آپ (ZIP/JSON)</button>
    <button id="clearAllData" class="btn danger">پاک کردن تمام داده‌ها</button>
  </div>
  <div class="form-actions" style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
    <button id="saveSettings" class="btn primary">ذخیره</button>
  </div>
  <hr style="margin-top:16px;border:none;border-top:1px solid rgba(0,0,0,0.06);" />
  <div style="margin-top:8px;color:var(--muted);font-size:13px;text-align:center;"> 
    <div>برنامه طراحی شده توسط پوریا عابدی</div>
    <div style="margin-top:6px;display:flex;gap:8px;justify-content:center;align-items:center;">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color:var(--accent-2);flex:0 0 16px;">
        <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
        <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
        <line x1="17.5" y1="6.5" x2="17.5" y2="6.5"></line>
      </svg>
      <a href="https://instagram.com/club.management2025" target="_blank" rel="noopener" style="color:var(--accent-2);font-weight:700;text-decoration:none;">@club.management2025</a>
    </div>
    <div style="margin-top:6px;">حجم داده‌های ذخیره شده: ${dataSize} KB</div>
  </div>
    </div>
  `;
  // direct binding: button exists after innerHTML assignment
  const openRankBtn = qs('#openRankEditorFromSettings');
  if (openRankBtn) openRankBtn.addEventListener('click', () => showView('rank-editor'));
  on('#cancelSettings', 'click', () => showView('account'));
  on('#saveSettings', 'click', () => {
  state.settings.title = qs('#settingsTitle').value || 'مدیریت باشگاه والیبال';
    let file = qs('#settingsLogo').files[0];
    if (file) {
      imageFileToDataURL(file, 100).then(data => {
        state.settings.logo = data;
        saveState();
        applySettings();
        showView('account');
        renderHome();
      });
    } else {
      saveState();
      applySettings();
      showView('account');
      renderHome();
    }
  });
  // Create backup: JSON + player profile images inside folder, zipped automatically
  on('#backupBtnInSettings', 'click', async () => {
    try {
      const zip = new JSZip();
      // add JSON state
      const jsonStr = JSON.stringify(state, null, 2);
      zip.file('volleyball_backup.json', jsonStr);
      // add images under folder 'player_images/'
      const imgFolder = zip.folder('player_images');
      // gather unique image URLs from players
      const imgs = [...new Set((state.players || []).map(p => p.photo).filter(Boolean))];
      for (let i = 0; i < imgs.length; i++) {
        const url = imgs[i];
        try {
          // if data URL already, use it directly
          if (String(url).startsWith('data:')) {
            // convert dataURL to binary and add
            const dataParts = url.split(',');
            const meta = dataParts[0];
            const b64 = dataParts[1];
            const content = atob(b64);
            const arr = new Uint8Array(content.length);
            for (let j = 0; j < content.length; j++) arr[j] = content.charCodeAt(j);
            imgFolder.file(`image_${i}.png`, arr);
          } else {
            const resp = await fetch(url);
            const blob = await resp.blob();
            imgFolder.file(`image_${i}${getExtensionFromContentType(blob.type)}`, blob);
          }
        } catch (e) {
          console.warn('Failed to fetch image for backup', url, e);
        }
      }
      const content = await zip.generateAsync({type: 'blob'});
      const backupName = `volleyball_backup_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.zip`;
      // trigger download
      const a = document.createElement('a');
      a.href = URL.createObjectURL(content);
      a.download = backupName;
      a.click();
      URL.revokeObjectURL(a.href);
    } catch (e) {
      console.error('Backup failed', e);
      alert('خطا در تولید بک‌آپ');
    }
  });

  // Share backup handler removed: 'اشتراک‌گذاری بک آپ' button no longer exists in settings UI.
  // logo preview handler (after elements exist)
  setTimeout(() => {
    const logoInput = qs('#settingsLogo');
    const logoPreview = qs('#settingsLogoPreview');
    if (logoInput && logoPreview) {
      logoInput.addEventListener('change', async (ev) => {
        const f = ev.target.files[0];
        if (!f) return;
        const data = await imageFileToDataURL(f, 100).catch(() => null);
        if (data) logoPreview.src = data;
      });
    }
  }, 50);
  on('#restoreBtnInSettings', 'click', () => {
    let input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,.zip';
    input.onchange = async e => {
      let file = e.target.files[0];
      if (!file) return;
      try {
        if (file.name.endsWith('.zip')) {
          const jszip = new JSZip();
          const z = await jszip.loadAsync(file);
          if (z.files['volleyball_backup.json']) {
            const txt = await z.files['volleyball_backup.json'].async('string');
            state = JSON.parse(txt);
            saveState();
            alert('بک‌آپ وارد شد');
            location.reload();
          } else {
            alert('فایل ZIP معتبر نیست');
          }
        } else {
          const text = await file.text();
          state = JSON.parse(text);
          saveState();
          alert('بک‌آپ وارد شد');
          location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('خطا در وارد کردن بک‌آپ');
      }
    };
    input.click();
  });
  on('#clearAllData', 'click', () => {
    if (confirm('آیا مطمئن هستید که می‌خواهید تمام داده‌ها را پاک کنید؟')) {
      localStorage.clear();
      state = {};
      seedSample();
      saveState();
      alert('تمام داده‌ها پاک شد');
      location.reload();
    }
  });
  on('#backSettings', 'click', () => { showView('account'); });
}

function openPaymentModal(playerId) {
  // If a dedicated payment modal exists, open it and prefill the player; else fallback to payments view.
  const m = qs('#paymentModal');
  if (m) {
    try { m.classList.remove('hide'); m.style.display = 'flex'; m.setAttribute('aria-hidden','false'); } catch(e){}
    try { m.querySelector('#paymentDate').value = todayJalali(); } catch(e){}
    if (playerId) {
      try { m.querySelector('#paymentPlayer').value = playerId; } catch(e){}
      let player = state.players.find(x => x.id === playerId);
      if (player) try{ m.querySelector('#paymentPlayerSearch').value = player.name; } catch(e){}
    } else {
      try{ m.querySelector('#paymentPlayerSearch').value = ''; m.querySelector('#paymentPlayer').value = ''; } catch(e){}
    }
    return;
  }
  showView('payments');
  qs('#paymentPlayer').value = playerId;
  let player = state.players.find(x => x.id === playerId);
  if (player) qs('#paymentPlayerSearch').value = player.name;
}

// Open the session create modal (or fallback to sessions view)
function openSessionModal(editId) {
  const m = qs('#sessionModal');
  if (m) {
    try { m.classList.remove('hide'); m.style.display = 'flex'; m.setAttribute('aria-hidden','false'); } catch(e){}
    try { m.querySelector('#sessionDate').value = todayJalali(); } catch(e){}
    try { if (editId) m.querySelector('#createSessionBtn')?.dataset && (m.querySelector('#createSessionBtn').dataset.editId = editId); } catch(e){}
    // populate categories and append private-classes option specifically for session modal
    try {
      populateCategoriesFromRanks(m.querySelector('#sessionCategory'), 'همه رده‌ها');
      // append a special option for private classes
      let cat = m.querySelector('#sessionCategory');
      if (cat && !cat.querySelector('option[value="__private_class__"]')) {
        let opt = document.createElement('option'); opt.value = '__private_class__'; opt.textContent = 'کلاس خصوصی';
        cat.appendChild(opt);
      }
      // populate coaches
      populateCoachSelect(m.querySelector('#sessionCoach'));
      // populate private classes list (hidden by default)
      populateSessionPrivateClassSelect();
      // hide private class select initially
      let pc = m.querySelector('#sessionPrivateClass'); if (pc) pc.style.display = 'none';
    } catch(e) { console.warn('openSessionModal populate failed', e); }
    return;
  }
  // fallback
  try { showView('sessions'); qs('#sessionDate').value = todayJalali(); } catch(e){}
}

// Open the training plan form modal (or fallback to training tab)
function openTrainingFormModal(editId) {
  const m = qs('#trainingFormModal');
  if (m) {
    try { m.classList.remove('hide'); m.style.display = 'flex'; m.setAttribute('aria-hidden','false'); } catch(e){}
    try { m.querySelector('#planDate').value = todayJalali(); } catch(e){}
    try { if (editId) m.querySelector('#savePlanBtn')?.dataset && (m.querySelector('#savePlanBtn').dataset.editId = editId); } catch(e){}
    return;
  }
  // fallback behavior: navigate to training tab
  try { showView('sessions'); setTimeout(()=>qs('#tabTrainingPlan').click(), 40); } catch(e){}
}

/* ================================================================
  SECTION: Jalali Datepicker & Calendar UI
  - calendar rendering, input attaching, show/hide helpers
  ================================================================ */
/* Jalali Datepicker */
const calendar = qs('#jalaliCalendar');
let activeInput = null;

function showJalaliCalendar(inputEl) {
  activeInput = inputEl;
  calendar.innerHTML = '';
  calendar.classList.remove('hide');
  calendar.setAttribute('aria-hidden', 'false');
  // make sure the calendar overlay appears above modals
  try { calendar.style.zIndex = '20000'; } catch(e) {}
  // Use CSS fixed centering; do not position relative to input to ensure consistent centered display
  calendar.style.top = '';
  calendar.style.left = '';
  calendar.style.transform = 'translate(-50%, -50%)';
  let cur = inputEl.value && inputEl.value.match(/^\d{4}\/\d{2}\/\d{2}$/) ? inputEl.value : todayJalali();
  let parts = cur.split('/').map(Number);
  renderCalendar(parts[0], parts[1], parts[2]);
}

function hideJalaliCalendar() {
  calendar.classList.add('hide');
  calendar.setAttribute('aria-hidden', 'true');
  calendar.innerHTML = '';
  if (activeInput && activeInput.id === 'p_birth') {
    try { if (typeof updateCategoryAndPosition === 'function') updateCategoryAndPosition(); } catch(_){ }
  }
  activeInput = null;
}

function renderCalendar(year, month, selectedDay) {
  calendar.innerHTML = '';
  // header (year/month controls + nav)
  let header = document.createElement('div');
  header.className = 'cal-header';

  let yearSelect = document.createElement('select');
  yearSelect.className = 'input';
  yearSelect.style.width = '80px';
  for (let y = 1300; y <= year + 50; y++) {
    let option = document.createElement('option');
    option.value = y;
    option.textContent = y;
    if (y === year) option.selected = true;
    yearSelect.appendChild(option);
  }

  let monthSelect = document.createElement('select');
  monthSelect.className = 'input';
  monthSelect.style.width = '120px';
  let months = ['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'];
  months.forEach((m, i) => {
    let option = document.createElement('option');
    option.value = i + 1;
    option.textContent = m;
    if (i + 1 === month) option.selected = true;
    monthSelect.appendChild(option);
  });

  let prevBtn = document.createElement('button'); prevBtn.className = 'btn small'; prevBtn.textContent = '<';
  let nextBtn = document.createElement('button'); nextBtn.className = 'btn small'; nextBtn.textContent = '>';

  header.appendChild(yearSelect);
  header.appendChild(monthSelect);
  header.appendChild(prevBtn);
  header.appendChild(nextBtn);
  calendar.appendChild(header);

  yearSelect.addEventListener('change', () => renderCalendar(parseInt(yearSelect.value), month, selectedDay));
  monthSelect.addEventListener('change', () => renderCalendar(year, parseInt(monthSelect.value), selectedDay));
  prevBtn.addEventListener('click', () => { month--; if (month < 1) { month = 12; year--; } renderCalendar(year, month, selectedDay); });
  nextBtn.addEventListener('click', () => { month++; if (month > 12) { month = 1; year++; } renderCalendar(year, month, selectedDay); });

  // calendar grid
  let grid = document.createElement('div');
  grid.className = 'cal-grid';

  // week day headers (Saturday..Friday)
  let weekTitles = ['ش','ی','د','س','چ','پ','ج'];
  weekTitles.forEach(w => {
    let t = document.createElement('div');
    t.style.textAlign = 'center';
    t.style.fontSize = '13px';
    t.style.color = 'var(--muted)';
    t.style.fontWeight = '600';
    t.textContent = w;
    grid.appendChild(t);
  });

  // compute first-day offset by converting Jalali(year,month,1) to Gregorian and reading weekday
  let gFirst = jalali_to_gregorian(year, month, 1);
  let dFirst = new Date(gFirst[0], gFirst[1] - 1, gFirst[2]);
  // JS: 0=Sunday .. 6=Saturday. Our week starts Saturday (index 0), so map as follows:
  let offset = (dFirst.getDay() + 1) % 7;

  // compute days in month by measuring difference to first day of next month
  let gNext = (month < 12) ? jalali_to_gregorian(year, month + 1, 1) : jalali_to_gregorian(year + 1, 1, 1);
  let dNext = new Date(gNext[0], gNext[1] - 1, gNext[2]);
  let daysInMonth = Math.round((dNext - dFirst) / (1000 * 60 * 60 * 24));

  // add blank placeholders for offset
  for (let i = 0; i < offset; i++) {
    let blank = document.createElement('div');
    grid.appendChild(blank);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    let cell = document.createElement('div');
    cell.className = 'cal-day';
    if (d === selectedDay) { cell.style.background = 'var(--accent)'; cell.style.color = '#fff'; }
    cell.textContent = d;
    cell.addEventListener('click', () => {
      if (activeInput) {
        activeInput.value = `${year}/${String(month).padStart(2, '0')}/${String(d).padStart(2, '0')}`;
        activeInput.dispatchEvent(new Event('change'));
      }
      hideJalaliCalendar();
    });
    grid.appendChild(cell);
  }

  calendar.appendChild(grid);
}

function attachJalaliInputs(root = document) {
  qsa('.jalali-input', root).forEach(inp => {
    inp.addEventListener('keydown', e => e.preventDefault());
    inp.addEventListener('paste', e => e.preventDefault());
    inp.addEventListener('input', e => { if (e.inputType !== 'insertFromPaste') inp.value = inp.value.slice(0, -1); });
    inp.addEventListener('focus', () => showJalaliCalendar(inp));
    inp.addEventListener('click', () => showJalaliCalendar(inp));
  });
  document.addEventListener('click', e => {
    if (calendar.contains(e.target)) return;
    let inputs = qsa('.jalali-input');
    let isInp = Array.from(inputs).some(i => i === e.target);
    if (!isInp) hideJalaliCalendar();
  });
}
// تابع کمکی برای تبدیل نام ماه به عدد
function monthNameToNumber(monthName) {
  const months = {
    'فروردین': 1, 'اردیبهشت': 2, 'خرداد': 3, 'تیر': 4, 'مرداد': 5, 'شهریور': 6,
    'مهر': 7, 'آبان': 8, 'آذر': 9, 'دی': 10, 'بهمن': 11, 'اسفند': 12
  };
  return months[monthName] || 10; // پیش‌فرض 'دی' = 10
}

// تابع کمکی برای تبدیل عدد ماه به نام
function numberToMonthName(monthNumber) {
  const months = {
    1: 'فروردین', 2: 'اردیبهشت', 3: 'خرداد', 4: 'تیر', 5: 'مرداد', 6: 'شهریور',
    7: 'مهر', 8: 'آبان', 9: 'آذر', 10: 'دی', 11: 'بهمن', 12: 'اسفند'
  };
  return months[monthNumber] || 'دی'; // پیش‌فرض 'دی'
}

// تابع بروزرسانی تاریخ مرجع
function updateCategoryReferenceDate() {
  let today = todayJalali(); // تاریخ امروز، مثل '1404/06/10'
  let [todayYear, todayMonth, todayDay] = today.split('/').map(Number);
  
  let lastUpdate = state.settings.lastCategoryUpdate || '11 دی 1403';
  let refDay, refMonth, refYear, refMonthStr;

  // بررسی فرمت‌های مختلف تاریخ مرجع
  if (lastUpdate.includes('/')) {
    // فرمت: 1403/10/11
    [refYear, refMonth, refDay] = lastUpdate.split('/').map(Number);
    refMonthStr = numberToMonthName(refMonth);
  } else if (lastUpdate.split(' ').length === 3 && !lastUpdate.includes('undefined')) {
    // فرمت: 11 دی 1403
    [refDay, refMonthStr, refYear] = lastUpdate.split(' ');
    refMonth = monthNameToNumber(refMonthStr);
    refDay = parseInt(refDay);
    refYear = parseInt(refYear);
  } else {
    // فرمت نامعتبر (مثل 11 undefined 1404)
    console.warn('فرمت تاریخ مرجع نامعتبر است، تنظیم به پیش‌فرض');
    refDay = 11;
    refMonth = 10;
    refYear = todayYear; // استفاده از سال امروز به جای پیش‌فرض
    refMonthStr = 'دی';
  }

  // لاگ برای دیباگ
  console.log('تاریخ امروز:', today);
  console.log('تاریخ مرجع فعلی:', lastUpdate);
  console.log('پارامترهای مرجع:', { refDay, refMonth, refYear, refMonthStr });

  // بررسی فرمت معتبر
  if (!refDay || !refMonth || !refYear || isNaN(refDay) || isNaN(refMonth) || isNaN(refYear)) {
    console.warn('فرمت تاریخ مرجع نامعتبر است، تنظیم به پیش‌فرض');
    refDay = 11;
    refMonth = 10;
    refYear = todayYear;
    refMonthStr = 'دی';
  }

  // اگر سال امروز بزرگتر از سال مرجع است، یا در همان سال اما بعد از تاریخ مرجع
  if (todayYear > refYear || 
      (todayYear === refYear && (todayMonth > refMonth || (todayMonth === refMonth && todayDay >= refDay)))) {
    refYear = todayYear + (todayMonth > refMonth || (todayMonth === refMonth && todayDay >= refDay) ? 1 : 0);
    state.settings.lastCategoryUpdate = `${refDay} ${refMonthStr} ${refYear}`;
    saveState(); // ذخیره تغییرات
    console.log('تاریخ مرجع بروز شد به:', state.settings.lastCategoryUpdate);
  } else {
    // اگر بروزرسانی لازم نیست، همچنان فرمت را اصلاح کنیم
    state.settings.lastCategoryUpdate = `${refDay} ${refMonthStr} ${refYear}`;
    saveState();
    console.log('بروزرسانی لازم نبود، تاریخ مرجع اصلاح شد به:', state.settings.lastCategoryUpdate);
  }
}

/* Event Binding & Init */
document.addEventListener('DOMContentLoaded', () => {
  
  loadState();
  updateCategoryReferenceDate();  // اضافه شده اینجا
  if ('serviceWorker' in navigator) {
    try {
      const origin = window.location && window.location.origin;
      // don't register service worker when origin is 'null' (file://) or insecure
      if (!origin || origin === 'null' || origin.startsWith('file:')) {
        console.debug('Skipping service worker registration: origin not supported', origin);
      } else {
        navigator.serviceWorker.register("./sw-advanced.js", { scope: './' })
          .then(reg => {
            console.log('Advanced Service Worker registered:', reg.scope);
            // Setup periodic background sync if supported
            if ('periodicSync' in reg) {
              reg.periodicSync.register('sync-data', {
                minInterval: 24 * 60 * 60 * 1000 // 24 hours
              }).catch(() => {/* Ignore if not supported */});
            }
            
            // Handle updates
            reg.addEventListener('updatefound', () => {
              const newWorker = reg.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // Show update notification with app version
                  const updateNotification = document.createElement('div');
                  updateNotification.className = 'update-notification';
                  updateNotification.innerHTML = `
                    <div class="update-content">
                      نسخه جدید برنامه در دسترس است
                      <button onclick="location.reload()" class="update-btn">بروزرسانی</button>
                    </div>
                  `;
                  document.body.appendChild(updateNotification);
                }
              });
            });
          })
          .catch(err => console.error('Service Worker registration failed:', err));
      }
    } catch (swErr) { console.debug('service worker guard failed', swErr); }
  }

  // PWA install prompt
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // نشان دادن دکمه نصب اگر لازم باشد
    let installBtn = document.createElement('button');
    installBtn.className = 'btn primary';
    installBtn.textContent = 'نصب اپ';
    installBtn.style.position = 'fixed';
    installBtn.style.bottom = '80px';
    installBtn.style.left = '50%';
    installBtn.style.transform = 'translateX(-50%)';
    installBtn.addEventListener('click', () => {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choice) => {
        if (choice.outcome === 'accepted') {
          console.log('اپ نصب شد');
        }
        deferredPrompt = null;
      });
    });
    document.body.appendChild(installBtn);
    setTimeout(() => installBtn.remove(), 10000); // پنهان پس از 10 ثانیه
  });

  //qs('#mobileMenu').classList.add('hide');  مخفی کردن اولیه منو

  // enable horizontal swipe lock on players preview containers as a fallback
  // for browsers/webviews that ignore CSS touch-action.
  try { enableHorizontalSwipeLock(); } catch (e) { console.debug('swipeLock init failed', e); }

  on('#homeMenu', 'click', () => showView('home'));
  on('#accountMenu', 'click', () => showView('account'));
  // management menu removed
  on('#playersBtnAccess', 'click', () => showView('players'));
  on('#coachesBtnAccess', 'click', () => showView('coaches'));
  // healthBtnAccess removed from DOM to avoid duplicate access points

  

  // record last back press for double-press-to-exit behaviour
  let _lastBackAt = 0;
  function goBack() {
    // if there's history state to go back to, just go back
    if (history.state && history.state.view) {
      history.back();
      return true;
    }
    // no app history left — implement double-press-to-exit
    const now = Date.now();
    if (now - _lastBackAt < 1500) {
      // allow default behaviour (close) by returning false
      return false;
    }
    _lastBackAt = now;
    showToast('برای خروج دوباره بازگشت را فشار دهید', 1400);
    return true; // handled (prevent default)
  }

  // expose globally so handlers created earlier can call it
  try { window.goBack = goBack; } catch (e) { console.warn('Unable to expose goBack on window', e); }

  function handleAndroidBack() {
    try {
      return goBack();
    } catch (e) { return false; }
  }

  try { window.handleAndroidBack = handleAndroidBack; } catch (e) { console.warn('Unable to expose handleAndroidBack on window', e); }

  // When the user navigates via browser back/forward, reflect the view
  window.addEventListener('popstate', (ev) => {
    try {
      const stateObj = ev.state;
      if (stateObj && stateObj.view) {
        // render without pushing a new history entry
        showView(stateObj.view, stateObj.params || {}, true);
      } else {
        // fallback: show home
        showView('home', {}, true);
      }
    } catch (e) {
      console.warn('popstate handler failed', e);
    }
  });

  // Listen for Cordova/Capacitor/Android backbutton event if available
  try {
    document.addEventListener('backbutton', (ev) => {
      // If any modal open, let its handler manage back; otherwise defer to goBack
      try {
        const handled = goBack();
        if (!handled) {
          // Not handled by app (double-press detected), allow default to close
          return true;
        }
      } catch(e) { console.warn('backbutton handler error', e); }
    });
  } catch(e) { /* not running in Cordova-like environment */ }

  // Helper: inject a small home button beside existing back buttons in view headers
  function ensureHeaderHomeButtons() {
    try {
      document.querySelectorAll('.view-header').forEach(h => {
        if (h.querySelector('.home-btn')) return; // already added
        const btn = document.createElement('button');
        btn.className = 'home-btn';
        btn.title = 'خانه';
        // prettier house icon (filled) for better visibility
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" stroke="none" width="20" height="20"><path d="M12 3l9 7v9a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V10l9-7z"/></svg>';
        btn.addEventListener('click', (e) => { e.stopPropagation(); showView('home'); });
        // Try to insert immediately after back button if present so it visually sits next to it
        const backBtn = h.querySelector('.back-btn');
        if (backBtn && backBtn.parentNode) {
          backBtn.parentNode.insertBefore(btn, backBtn.nextSibling);
          // no inline positioning: CSS handles circular visuals and spacing
        } else {
          // fallback: append to header
          h.appendChild(btn);
        }
      });
    } catch(e) { console.warn('ensureHeaderHomeButtons failed', e); }
  }
  // run now and on DOM mutations that may add headers later
  ensureHeaderHomeButtons();
  const mo = new MutationObserver(() => ensureHeaderHomeButtons());
  try { mo.observe(document.body, { childList:true, subtree:true }); } catch(_){}

  // --- Notifications view and account link ---
  // add notifications view skeleton near other sections

  // basic toast helper
  function showToast(msg, timeout = 1800) {
    let t = qs('#__app_toast');
    if (!t) {
      t = document.createElement('div');
      t.id = '__app_toast';
      t.style.position = 'fixed';
      t.style.bottom = '90px';
      t.style.left = '50%';
      t.style.transform = 'translateX(-50%)';
      t.style.background = 'rgba(0,0,0,0.75)';
      t.style.color = '#fff';
      t.style.padding = '8px 12px';
      t.style.borderRadius = '8px';
      t.style.zIndex = 3000;
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.opacity = '1';
    clearTimeout(t._to);
    t._to = setTimeout(() => { t.style.opacity = '0'; }, timeout);
  }

  // Notifications store (in-memory) — you can replace with persisted storage or server sync
  if (!state.notifications) state.notifications = [];

  function updateNotificationsBadge() {
    try {
      const unread = (state.notifications || []).filter(n => !n.read).length;
      // update any class-based badges
      Array.from(document.querySelectorAll('.notifications-badge')).forEach(b => {
        if (unread > 0) { b.style.display = 'inline-block'; b.textContent = String(unread > 99 ? '99+' : unread); }
        else b.style.display = 'none';
      });
      // update account icon dot if present
      try {
        const acc = document.getElementById('accountMenu');
        if (acc) {
          let dot = acc.querySelector('.account-notif-dot');
          if (!dot) {
            dot = document.createElement('span');
            dot.className = 'account-notif-dot';
            acc.style.position = acc.style.position || 'relative';
            acc.appendChild(dot);
          }
          dot.style.display = unread > 0 ? 'block' : 'none';
        }
      } catch(e){}
    } catch (e) { console.warn('updateNotificationsBadge failed', e); }
  }

  function renderNotifications() {
    try {
      const el = document.getElementById('notificationsContent');
      if (!el) return;
      // mark all as read when opening the notifications view
      try {
        if (state && Array.isArray(state.notifications)) {
          state.notifications.forEach(n => { if (n) n.read = true; });
          try { if (typeof saveState === 'function') saveState(); } catch(e){}
          try { updateNotificationsBadge(); } catch(e){}
        }
      } catch(e){}
      el.innerHTML = '';
      const arr = (state.notifications || []).slice().sort((a,b)=> (b && b.ts? b.ts:0) - (a && a.ts? a.ts:0));
      if (!arr.length) {
        el.innerHTML = '<div class="muted" style="padding:12px;">هیچ اعلانی وجود ندارد</div>';
        return;
      }
  // render newest first (arr already sorted desc)
      arr.forEach(n => {
        try {
          const r = document.createElement('div');
          const typeClass = n && n.type ? 'type-' + String(n.type).replace(/[^a-z0-9\-]/gi,'').toLowerCase() : '';
          r.className = 'notif-card ' + typeClass;
          // full width card styling (keeps existing theme classes but enforces full width)
          r.style.width = '100%';
          r.style.boxSizing = 'border-box';
          r.style.padding = '12px 14px';
          r.style.marginBottom = '10px';
          r.style.position = 'relative';

          // close button positioned top-left (won't overlap content)
          const btn = document.createElement('button');
          btn.className = 'close-btn';
          btn.title = 'حذف';
          btn.setAttribute('data-id', String(n.id));
          btn.textContent = '✖';
          // style: top-left corner, subtle, non-intrusive
          btn.style.position = 'absolute';
          btn.style.top = '8px';
          btn.style.left = '8px';
          btn.style.background = 'transparent';
          btn.style.border = 'none';
          btn.style.cursor = 'pointer';
          btn.style.fontSize = '14px';
          btn.style.padding = '4px';
          btn.style.lineHeight = '1';

          // content wrapper with left padding so the close button doesn't overlap (RTL aware)
          const content = document.createElement('div');
          content.style.paddingLeft = '36px';
          content.style.paddingRight = '6px';
          content.style.textAlign = 'right';

          const titleDiv = document.createElement('div');
          titleDiv.className = 'title';
          titleDiv.innerHTML = escapeHtml(n.title || 'بدون عنوان');
          titleDiv.style.fontWeight = '700';
          titleDiv.style.marginBottom = '6px';

          const bodyDiv = document.createElement('div');
          bodyDiv.className = 'body';
          bodyDiv.innerHTML = escapeHtml(n.body || '');
          bodyDiv.style.marginBottom = '8px';

          // Format timestamp to Jalali if helper exists
          let tsStr = '';
          try {
            if (n.ts && typeof window.isoToJalali === 'function') {
              // convert numeric ts -> ISO -> jalali
              const iso = new Date(Number(n.ts)).toISOString();
              tsStr = isoToJalali(iso) + ' - ' + new Date(Number(n.ts)).toLocaleTimeString();
            } else {
              tsStr = new Date(Number(n.ts||Date.now())).toLocaleString();
            }
          } catch(e){ tsStr = new Date(Number(n.ts||Date.now())).toLocaleString(); }

          const tsDiv = document.createElement('div');
          tsDiv.className = 'ts';
          tsDiv.textContent = tsStr;
          tsDiv.style.color = 'var(--muted)';
          tsDiv.style.fontSize = '13px';

          content.appendChild(titleDiv);
          content.appendChild(bodyDiv);
          content.appendChild(tsDiv);

          // click on card (but not on close btn) marks as read and triggers optional onClick
          r.addEventListener('click', (ev)=>{
            if (ev.target && ev.target.classList && ev.target.classList.contains('close-btn')) return;
            try { if (n) n.read = true; } catch(_){}
            try{ if (typeof saveState === 'function') saveState(); } catch(e){}
            try{ updateNotificationsBadge(); } catch(e){}
            try{ if (n && typeof n.onClick === 'function') n.onClick(n); } catch(e){}
            // keep view showing; do not auto-close view
            renderNotifications();
          });

          // close button handler: remove and persist
          btn.addEventListener('click', (e)=>{
            e.stopPropagation();
            try { state.notifications = (state.notifications || []).filter(x=>String(x.id) !== String(btn.getAttribute('data-id'))); } catch(_){ }
            try{ if (typeof saveState === 'function') saveState(); } catch(e){}
            try{ updateNotificationsBadge(); } catch(e){}
            renderNotifications();
          });

          r.appendChild(btn);
          r.appendChild(content);
          el.appendChild(r);
        } catch (e) { console.warn('renderNotifications: item render failed', e); }
      });
      // toggle visibility of the floating close-all button
      try {
        const floatBtn = document.getElementById('closeAllNotificationsFloat');
        if (floatBtn) {
          floatBtn.style.display = (state.notifications && state.notifications.length) ? 'block' : 'none';
        }
      } catch(e){}
    } catch(e) { console.warn('renderNotifications failed', e); }
  }

    // expose for console testing
    window.renderNotifications = renderNotifications;

  // wire notifications button in account area to the view
  try {
  // notifications button inside settings area
  const nbSettings = document.getElementById('notificationsFromSettings');
  if (nbSettings) nbSettings.addEventListener('click', ()=>{ showView('notifications'); renderNotifications(); updateNotificationsBadge(); });
  // back button in notifications view
  const backNot = document.getElementById('backNotifications'); if (backNot) backNot.addEventListener('click', ()=> { if (!goBack()) showView('home'); });
    // floating close-all button in notifications view (bottom-right)
    try {
      const closeFloat = document.getElementById('closeAllNotificationsFloat');
      if (closeFloat) {
        closeFloat.addEventListener('click', (e)=>{
          e.stopPropagation();
          try { const cnt = (state.notifications||[]).length; state.notifications = []; } catch(_){ state.notifications = []; }
          try{ if (typeof saveState === 'function') saveState(); } catch(e){}
          try{ updateNotificationsBadge(); } catch(e){}
          try{ renderNotifications(); } catch(e){}
          try { if (typeof showToast === 'function') showToast('همهٔ اعلان‌ها بسته شد'); } catch(e){}
        });
      }
    } catch(e){}
    // keep any class-based badges in sync
    function syncClassBadges() {
      const cnt = (state.notifications||[]).filter(n=>!n.read).length;
      Array.from(document.querySelectorAll('.notifications-badge')).forEach(b => { if (cnt>0) { b.style.display='inline-block'; b.textContent = String(cnt>99?'99+':cnt); } else b.style.display='none'; });
    }
    // call once and also when badge updates
    try { syncClassBadges(); } catch(_){ }
    // ensure account icon has a dot element
    try {
      const acc = document.getElementById('accountMenu');
      if (acc) {
        let dot = acc.querySelector('.account-notif-dot');
        if (!dot) {
          dot = document.createElement('span');
          dot.className = 'account-notif-dot';
          acc.style.position = acc.style.position || 'relative';
          acc.appendChild(dot);
        }
        // update visibility now
        const cnt = (state.notifications||[]).filter(n=>!n.read).length;
        dot.style.display = cnt>0 ? 'block' : 'none';
      }
    } catch(e){}
  } catch(e) { console.warn('wire notifications handlers failed', e); }

  // Test notification helpers removed to prevent test messages from appearing
  // to end users. We keep a silent cleanup below to remove any persisted
  // test notifications (id starts with 'test-' or type === 'test') on load.
  try {
    // silently remove any leftover test notifications on load so end users
    // don't see test items. This runs without showing any toast.
    try {
      if (state && Array.isArray(state.notifications) && state.notifications.length) {
        state.notifications = state.notifications.filter(n => { try { return !(String(n.id||'').startsWith('test-') || (n && n.type === 'test')); } catch(e){ return true; } });
        try{ if (typeof saveState === 'function') saveState(); } catch(e){}
        try{ updateNotificationsBadge(); } catch(e){}
        try{ renderNotifications(); } catch(e){}
      }
    } catch(e) { /* silent */ }
  } catch(e){}

  // safe HTML escape helper for small UI snippets
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // initial badge render
  try { updateNotificationsBadge(); } catch(_){}
  on('#paymentsBtnAccess', 'click', () => showView('payments'));
  on('#sessionsBtnAccess', 'click', () => showView('sessions'));
  on('#tabCompetitions', 'click', () => showView('competitions'));
  on('#backPlayers', 'click', () => { showView('home'); });
  on('#backCoaches', 'click', () => { if (!goBack()) showView('home'); });
  on('#backSessions', 'click', () => { if (!goBack()) return; });
  on('#backPayments', 'click', () => { if (!goBack()) showView('home'); });
  on('#backInsurance', 'click', () => { if (!goBack()) return; });
  on('#backHealth', 'click', () => { if (!goBack()) return; });
  on('#backPlayersExport', 'click', () => { if (!goBack()) return; });
  on('#backPaymentReport', 'click', () => { if (!goBack()) showView('home'); });
  on('#backManagement', 'click', () => { if (!goBack()) return; });
  on('#backAccount', 'click', () => { showView('home'); });
  on('#backDebtors', 'click', () => { if (!goBack()) showView('payments'); });
  // BMI filter: use dropdown #filterBmi on players page
  on('#filterBmi', 'change', renderPlayersPage);
  // settings button is created dynamically for confirmed users; notifications quick-action remains
  on('#notificationsFromSettings', 'click', () => { showView('notifications'); renderNotifications(); updateNotificationsBadge(); });
  // transient DOM toast fallback: guaranteed visible popup for a few seconds
  function showTransientMessage(msg, ms = 5000) {
    try {
      // remove existing transient if present
      const existing = document.getElementById('__transient_toast');
      if (existing) { try { existing.remove(); } catch(_){} }
      const d = document.createElement('div');
      d.id = '__transient_toast';
      d.setAttribute('role','status');
      d.style.position = 'fixed';
      d.style.left = '50%';
      d.style.transform = 'translateX(-50%)';
      d.style.bottom = '84px';
      d.style.zIndex = 99999;
      d.style.background = 'rgba(17,24,39,0.98)';
      d.style.color = '#fff';
      d.style.padding = '12px 16px';
      d.style.borderRadius = '10px';
      d.style.boxShadow = '0 6px 24px rgba(2,6,23,0.24)';
      d.style.fontSize = '14px';
      d.style.direction = 'rtl';
      d.style.textAlign = 'right';
      d.style.maxWidth = '92%';
      d.style.opacity = '0';
      d.style.transition = 'opacity 220ms ease';
      d.textContent = String(msg || '');
      document.body.appendChild(d);
      // force paint then fade in
      window.getComputedStyle(d).opacity;
      d.style.opacity = '1';
      // remove after timeout
      setTimeout(()=>{
        try { d.style.opacity = '0'; setTimeout(()=>{ try { d.remove(); } catch(_){} }, 260); } catch(_){}
      }, Math.max(2000, ms || 5000));
      return d;
    } catch(e) { try { alert(msg); } catch(_){} }
  }
  // Settings button: only open settings if user is authenticated; otherwise show a hint
  on('#settingsFromAccount', 'click', async function(){
    try {
      // prefer getCurrentUserId helper which returns { userId, user }
      if (typeof getCurrentUserId === 'function') {
        const { userId } = await getCurrentUserId();
        if (userId) { try { showView('settings'); } catch(_){}; return; }
      } else {
        const client = getSupabaseClient();
        if (client && client.auth && typeof client.auth.getUser === 'function') {
          try {
            const { data } = await client.auth.getUser();
            const u = data && data.user ? data.user : null;
            if (u && u.id) { try { showView('settings'); } catch(_){}; return; }
          } catch(_){}
        }
      }
    } catch(e) { console.debug('settings auth check failed', e); }
    // Not authenticated: show a small inline hint under the Settings button for a few seconds
    try {
      const btn = document.getElementById('settingsFromAccount');
      const hintId = 'settingsAuthHint';
      // remove existing hint if present
      try { const ex = document.getElementById(hintId); if (ex) ex.remove(); } catch(_){ }
      const hint = document.createElement('div');
      hint.id = hintId;
      hint.style.marginTop = '8px';
      hint.style.fontSize = '0.95em';
      hint.style.color = 'var(--muted)';
      hint.style.background = 'transparent';
      hint.style.direction = 'rtl';
      hint.textContent = 'برای دسترسی به تنظیمات وارد حساب کاربری خود شوید.';
      if (btn && btn.parentNode) {
        // insert directly after the button
        try { btn.parentNode.insertBefore(hint, btn.nextSibling); } catch(_) { btn.parentNode.appendChild(hint); }
      } else {
        // fallback: append to account container
        try { const ac = document.getElementById('accountProfileContainer'); if (ac) ac.appendChild(hint); }
        catch(_){}
      }
      // auto-hide after 9 seconds
      setTimeout(()=>{ try { const el = document.getElementById(hintId); if (el) el.remove(); } catch(_){} }, 9000);
    } catch(e) { console.debug('show settings auth hint failed', e); }
  });

// ensure Rank Editor link updates when showing settings
function showSettingsAndRankInfo() {
  renderSettings();
}

  on('#addPlayerBtn', 'click', () => showView('player-form'));
  on('#openAddPlayerFromList', 'click', () => showView('player-form'));
  on('#addCoachBtn', 'click', () => showView('coach-form'));
  on('#createCompetitionBtn', 'click', () => {
    showView('competitions');
    renderCompetitions();
    // show a simple prompt flow: competition name -> add matches later
    let name = prompt('نام مسابقه را وارد کنید:');
    if (!name) return;
    let comp = { id: uid('comp'), name, type: 'competition', createdAt: new Date().toISOString(), matches: [] };
    state.competitions.push(comp);
    saveState();
    renderCompetitions();
  });
  on('#createTournamentBtn', 'click', () => {
    showView('competitions');
    renderCompetitions();
    let name = prompt('نام تورنومنت را وارد کنید:');
    if (!name) return;
    let t = { id: uid('tourn'), name, type: 'tournament', createdAt: new Date().toISOString(), matches: [] };
    state.competitions.push(t);
    saveState();
    renderCompetitions();
  });
  on('#backCompetitions', 'click', () => { if (!goBack()) showView('home'); });
  on('#createSessionBtn', 'click', createSession);
  on('#addSessionFromHomeBtn', 'click', () => {
    try { if (typeof openSessionModal === 'function') return openSessionModal(); } catch(e){}
    try { showView('sessions'); qs('#sessionDate').value = todayJalali(); } catch(e){}
  });
  // debounce search input to improve responsiveness on large lists
  const debouncedRenderPlayersPage = debounce(renderPlayersPage, 180);
  on('#playersSearch', 'input', debouncedRenderPlayersPage);
  on('#filterCategory', 'change', renderPlayersPage);
  on('#filterInsurance', 'change', renderPlayersPage);
  on('#sortPlayers', 'change', renderPlayersPage);
  on('#showAllPlayersBtn', 'click', () => showView('players'));
  // removed showAllSessionsBtn and showAllPaymentsBtn handlers per UI changes
  // removed showAllInsurancesBtn handler
  // addPaymentFromHomeBtn removed from home UI
  on('#addPaymentBtn', 'click', () => {
    let dateStr = qs('#paymentDate').value || todayJalali();
    let amount = qs('#paymentAmount').value.replace(/,/g, '');
    let type = qs('#paymentType').value || '';
    let pMonth = qs('#paymentMonth').value;
    let pYear = qs('#paymentYear').value;
    let playerId = qs('#paymentPlayer').value;
    addPayment(dateStr, amount, type, pMonth, pYear, playerId);
    qs('#paymentAmount').value = '';
    qs('#paymentDate').value = '';
    qs('#paymentMonth').value = '';
    qs('#paymentYear').value = '';
    qs('#paymentPlayerSearch').value = '';
  });
  on('#paymentPlayerSearch', 'input', (e) => populatePaymentPlayerSelect(e.target.value));
  on('#paymentAmount', 'input', (e) => formatNumber(e.target));
  // Open payment modal from buttons / FAB
  try { on('#openPaymentModalBtn', 'click', () => openPaymentModal(null)); } catch(e) {}
  try { on('#fabPayment', 'click', () => openPaymentModal(null)); } catch(e) {}
  try { on('#paymentModalCancel', 'click', () => { let m = qs('#paymentModal'); if (m) { m.classList.add('hide'); m.style.display='none'; m.setAttribute('aria-hidden','true'); } }); } catch(e) {}

  // Session modal open/close handlers
  try { on('#openSessionModalBtn', 'click', () => openSessionModal()); } catch(e) {}
  try { on('#fabSession', 'click', () => openSessionModal(null)); } catch(e) {}
  try { on('#fabTraining', 'click', () => openTrainingFormModal(null)); } catch(e) {}
  try { on('#sessionModalCancel', 'click', () => { let m = qs('#sessionModal'); if (m) { m.classList.add('hide'); m.style.display='none'; m.setAttribute('aria-hidden','true'); } }); } catch(e) {}
  // session category -> show private class selector when 'کلاس خصوصی' selected
  try {
    on('#sessionCategory', 'change', (e) => {
      try {
        let v = e.target.value;
        let pc = qs('#sessionPrivateClass');
        if (v === '__private_class__') {
          populateSessionPrivateClassSelect();
          if (pc) pc.style.display = '';
        } else {
          if (pc) { pc.style.display = 'none'; pc.value = ''; }
        }
      } catch(err) { console.warn('sessionCategory change handler failed', err); }
    });
  } catch(e) {}
  // when a private class is selected, auto-fill coach select
  try {
    on('#sessionPrivateClass', 'change', (e) => {
      try {
        let clsId = e.target.value;
        if (!clsId) return;
        let cls = (state.privateClasses||[]).find(x=>x.id===clsId);
        if (cls && cls.coachId) {
          let coachSelect = qs('#sessionCoach'); if (coachSelect) coachSelect.value = cls.coachId;
        }
      } catch(err) { console.warn('sessionPrivateClass change handler failed', err); }
    });
  } catch(e) {}

  // Training form modal open/close handlers
  try { on('#openTrainingModalBtn', 'click', () => openTrainingFormModal()); } catch(e) {}
  try { on('#trainingFormModalCancel', 'click', () => { let m = qs('#trainingFormModal'); if (m) { m.classList.add('hide'); m.style.display='none'; m.setAttribute('aria-hidden','true'); } }); } catch(e) {}
  // Ensure modal-specific save also closes modal and navigates to training tab
  try {
    on('#trainingFormModal #savePlanBtn', 'click', () => {
      try { let tfm = qs('#trainingFormModal'); if (tfm) { tfm.classList.add('hide'); tfm.style.display = 'none'; tfm.setAttribute('aria-hidden','true'); } } catch(e){}
      try { showView('sessions'); setTimeout(()=>{ try{ qs('#tabTrainingPlan').click(); }catch(e){} }, 40); } catch(e){}
      try { showToast('یادداشت تمرین ذخیره شد'); } catch(e){}
    });
  } catch(e) {}
  on('#showDebtorsBtn', 'click', () => showView('debtors'));
  on('#reportPaymentsBtn', 'click', () => showView('payment-report'));
  on('#insuranceCategoryFilter', 'change', renderInsurancePage);
  on('#insuranceStatusFilter', 'change', renderInsurancePage);
  on('#exportPlayersBtn', 'click', () => showView('players-export'));
  on('#accountMenu', 'click', () => showView('account'));

  on('#loginForm', 'submit', (e) => {
    e.preventDefault();
    let username = qs('#username').value.trim();
    let password = qs('#password').value.trim();
    if (username === 'admin' && password === '123') {
      state.user.loggedIn = true;
      saveState();
      alert('لاگین موفق!');
    } else {
      alert('نام کاربری یا رمز اشتباه است');
    }
  });

  // bottom-tabs: wire new mobile tab buttons to app views and manage active state
  function setActiveBottomTab(id) {
    qsa('.bottom-tabs .tab-btn').forEach(b => b.classList.remove('active'));
    let el = qs('#' + id);
    if (el) el.classList.add('active');
  }
  try {
    // wire bottom tabs using safeClick and prevent propagation so clicks never pass-through to underlying elements
    const tabHandlers = {
      tabAccount: () => { showView('account'); setActiveBottomTab('tabAccount'); },
      tabPayments: () => { showView('payments'); setActiveBottomTab('tabPayments'); },
      tabCoaches: () => { showView('coaches'); setActiveBottomTab('tabCoaches'); },
      tabSessions: () => { showView('sessions'); setActiveBottomTab('tabSessions'); },
      tabCompetitions: () => { showView('competitions'); setActiveBottomTab('tabCompetitions'); }
    };
    Object.keys(tabHandlers).forEach(id => {
      const btn = qs('#' + id);
      if (!btn) return;
      // small, subtle lock for bottom tabs so quick accidental multi-presses don't trigger other actions
      safeClick(btn, (e) => {
        try { e.preventDefault(); e.stopPropagation(); } catch(ex){}
        tabHandlers[id]();
      }, 300);
    });
  } catch(e) { console.debug('bottom tabs wiring failed', e); }

  // capture touch/clicks on the mobile menu and block downstream events even if touchend happens outside the menu
  try {
    const mobileMenuEl = qs('#mobileMenu');
    if (mobileMenuEl) {
      // When a touch/pointer starts inside the mobile menu, temporarily add a capture click listener
      // that swallows the next click if it would target an element outside the menu. This prevents
      // accidental click-through to underlying controls while preserving normal menu clicks.
      const TEMP_BLOCK_MS = 350;
      // menuBlocker overlay approach: insert a transparent full-page div (below the menu) that
      // intercepts clicks for a short time after a touchstart/mousedown on the menu. This
      // blocks click-through while keeping the menu itself fully interactive.
      function addMenuBlock(ms) {
        try {
          ms = ms || TEMP_BLOCK_MS;
          let existing = document.getElementById('menuBlocker');
          if (existing) {
            // refresh timeout
            clearTimeout(existing._vb_timeout);
            existing._vb_timeout = setTimeout(() => { try { existing.remove(); } catch(e){} }, ms);
            return;
          }
          const blocker = document.createElement('div');
          blocker.id = 'menuBlocker';
          blocker.className = 'menu-blocker';
          // clicking the blocker removes it immediately
          blocker.addEventListener('click', function(ev){ try { ev.stopPropagation(); ev.preventDefault(); } catch(e){}; try{ blocker.remove(); }catch(e){} });
          document.body.appendChild(blocker);
          blocker._vb_timeout = setTimeout(() => { try { blocker.remove(); } catch(e){} }, ms);
        } catch (err) { console.debug('addMenuBlock failed', err); }
      }

      mobileMenuEl.addEventListener('touchstart', function(e){ try{ addMenuBlock(); }catch(e){} }, {passive:true, capture:true});
      mobileMenuEl.addEventListener('mousedown', function(e){ try{ addMenuBlock(); }catch(e){} }, {passive:true, capture:true});
    }
  } catch(e) { console.debug('mobile menu global guard failed', e); }

  // set initial active tab based on current history state (if any)
  setTimeout(() => {
    try {
      const v = (history.state && history.state.view) ? history.state.view : 'home';
      switch (v) {
        case 'account': setActiveBottomTab('tabAccount'); break;
        case 'payments': setActiveBottomTab('tabPayments'); break;
        case 'coaches': setActiveBottomTab('tabCoaches'); break;
        case 'sessions': setActiveBottomTab('tabSessions'); break;
        case 'competitions': setActiveBottomTab('tabCompetitions'); break;
        default: break;
      }
    } catch (e) {}
  }, 80);

  applySettings();

  // receipt modal actions
  try { on('#closeReceiptModal', 'click', () => { let m = qs('#receiptModal'); if (m) m.style.display = 'none'; }); } catch(e) {}
  try { on('#sendReceiptBtn', 'click', () => {
    let phone = qs('#receiptPhone').value.replace(/[^0-9+]/g, '');
    let text = qs('#receiptNote').value || '';
    if (!phone) return alert('شماره تلفن را وارد کنید');
    // open sms: link to allow sending via device (works on mobile)
    window.location.href = `sms:${phone}?body=${encodeURIComponent(text)}`;
  }); } catch(e) {}
  try { on('#saveReceiptBtn', 'click', () => {
    // save a simple local record of receipts (not robust)
    let r = { id: uid('r'), phone: qs('#receiptPhone').value, amount: qs('#receiptAmount').value, note: qs('#receiptNote').value, createdAt: new Date().toISOString() };
    state.receipts = state.receipts || [];
    state.receipts.unshift(r);
    saveState();
    showToast('رسید ذخیره شد');
    let m = qs('#receiptModal'); if (m) m.style.display = 'none';
  }); } catch(e) {}
  renderHome();
  renderPlayersPage();
  renderCoaches();
  renderSessionsPage();
  renderPaymentsPage();
  renderInsurancePage();
  renderHealthPage();
  attachJalaliInputs();

  // initial history state: ensure home is the default entry
  history.replaceState({ view: 'home' }, '', '#home');
});

// Birthday modal controls
function openBirthdayModal(playerId) {
  const modal = qs('#birthdayModal');
  const content = qs('#birthdayModalContent');
  const p = state.players.find(x => x.id === playerId);
  if (!p) return alert('بازیکن پیدا نشد');
  const age = calcExactAge(p.birthdate);
  const todayFlag = isBirthdayToday(p.birthdate);
  const clubName = escapeHtml(state.settings.title || 'باشگاه');
  const clubLogo = state.settings.logo || '';
  // if player's birthday is today -> full greeting modal; otherwise simple upcoming modal
  if (todayFlag) {
    const defaultMsg = `تولدت مبارک 🌟 ${escapeHtml(p.name)} عزیز! امیدوارم سال جدید برات سرشار از انگیزه، پیروزی‌های بزرگ و روزهای پر از لبخند باشه. همیشه پرقدرت بدرخشی.`;
    content.innerHTML = `
      <div id="birthdayCard" style="padding:14px;background:linear-gradient(135deg,#fff,#f7fbff);border-radius:12px;border:1px solid rgba(0,0,0,0.06);max-width:720px;">
        <div style="display:flex;flex-direction:column;align-items:center;">
          <div style="display:flex;flex-direction:column;align-items:center;gap:6px;width:100%;">
            <div style="width:56px;height:56px;border-radius:8px;overflow:hidden;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.08);">${clubLogo?`<img src="${clubLogo}" style="width:100%;height:100%;object-fit:contain;">`:''}</div>
            <div style="font-weight:700;font-size:16px;margin-top:4px;">${clubName}</div>
          </div>
          <div style="width:100%;display:flex;gap:12px;align-items:center;margin-top:12px;">
            <div style="flex:0 0 120px;">
              <div style="width:120px;height:120px;border-radius:12px;overflow:hidden;background:#e2e8f0;box-shadow:0 6px 18px rgba(2,6,23,0.04);">
                ${p.photo?`<img class="player-image" src="${p.photo}" style="width:100%;height:100%;object-fit:cover;">`:'<svg width="120" height="120" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e2e8f0"/></svg>'}
              </div>
            </div>
            <div style="flex:1;display:flex;flex-direction:column;justify-content:center;">
              <div style="font-size:18px;font-weight:800;">${escapeHtml(p.name)}</div>
              <div style="color:var(--muted);margin-top:6px;font-size:13px;">${p.category || '—'} • سن: ${age.years} سال</div>
            </div>
          </div>
          <div style="width:100%;margin-top:14px;">
            <textarea id="birthdayMessageText" style="width:100%;min-height:160px;border:1px solid rgba(0,0,0,0.06);border-radius:8px;padding:12px;font-size:15px;resize:vertical;direction:rtl;">${defaultMsg}</textarea>
          </div>
        </div>
      </div>
      <!-- action area: kept OUTSIDE #birthdayCard so it won't be included in shared image -->
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px;align-items:center;">
        <div style="display:flex;gap:8px;align-items:center;">
          <label for="birthdayPhoneInput" style="font-size:13px;color:var(--muted);">شماره:</label>
          <input id="birthdayPhoneInput" type="tel" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);width:160px;text-align:left;" value="${escapeHtml(p.phone || '')}">
        </div>
        <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
          <button id="sendBirthdaySms" class="btn primary">ارسال SMS</button>
          <button id="shareBirthdayImage" class="btn">اشتراک به‌صورت عکس</button>
        </div>
      </div>
    `;
  } else {
    // upcoming birthday: show a compact modal with days remaining
    const days = daysUntilBirthday(p.birthdate) || '—';
    content.innerHTML = `
      <div style="padding:18px;max-width:420px;text-align:center;">
        <div style="font-size:18px;font-weight:800;margin-bottom:8px;">${escapeHtml(p.name)}</div>
        <div style="color:var(--muted);margin-bottom:12px;">${days} روز مانده تا تولد</div>
      </div>
    `;
    // No explicit close button here; use the modal close control or backdrop to dismiss
  }
  // attach handlers for share buttons
  setTimeout(() => {
  let smsBtn = qs('#sendBirthdaySms');
  let imgBtn = qs('#shareBirthdayImage');
    if (smsBtn) smsBtn.addEventListener('click', () => {
      // open sms app with recipient and body prefilled; fallback copies to clipboard
      const phoneInput = qs('#birthdayPhoneInput');
      const msgArea = qs('#birthdayMessageText');
      const to = phoneInput?.value?.trim() || '';
      const body = (msgArea?.value || defaultMsg) + ` — از طرف ${clubName}`;
      const encoded = encodeURIComponent(body);
      try {
        // common pattern: sms:<number>?body=...
        const smsUrl = `sms:${to}?body=${encoded}`;
        window.location.href = smsUrl;
      } catch (e) {
        navigator.clipboard?.writeText(body);
        alert('متن پیام در کلیپ‌بورد کپی شد. آن را در برنامه پیامک الصاق و شماره را وارد کنید.');
      }
    });
    if (imgBtn) imgBtn.addEventListener('click', async () => {
      // clone the card and replace textarea with full-message div so the entire text is captured
      const card = qs('#birthdayCard');
      const clone = card.cloneNode(true);
      const textarea = clone.querySelector('#birthdayMessageText');
      // normalize Persian characters and ensure proper joining
      let fullText = (qs('#birthdayMessageText')?.value || defaultMsg) || '';
      try {
        fullText = String(fullText)
          .replace(/ي/g, 'ی')
          .replace(/ك/g, 'ک')
          .replace(/\u200C/g, ' ') // replace zero-width non-joiner with space to avoid rendering issues
          .trim();
      } catch(e) { /* ignore normalization errors */ }
      if (textarea) {
        const div = document.createElement('div');
        // important: set explicit Persian-capable font and RTL alignment
        div.style.whiteSpace = 'pre-wrap';
        div.style.fontSize = '15px';
        div.style.direction = 'rtl';
        div.style.textAlign = 'right';
        div.style.lineHeight = '1.4';
        div.style.padding = '10px';
        div.style.borderRadius = '8px';
        div.style.border = '1px solid rgba(0,0,0,0.06)';
        div.style.wordBreak = 'keep-all';
        div.style.fontFamily = "'Vazirmatn', 'IRANSans', 'Tahoma', 'Arial', sans-serif";
        div.textContent = fullText;
        textarea.parentNode.replaceChild(div, textarea);
      }
      // place clone off-screen for rendering and set font on the clone container too
      clone.style.boxSizing = 'border-box';
      clone.style.width = card.offsetWidth + 'px';
      clone.style.background = getComputedStyle(card).backgroundColor || '#ffffff';
      clone.style.padding = getComputedStyle(card).padding;
      clone.style.position = 'fixed';
      clone.style.left = '-9999px';
      clone.style.fontFamily = "'Vazirmatn', 'IRANSans', 'Tahoma', 'Arial', sans-serif";
      document.body.appendChild(clone);
      try {
        // wait for fonts to be available (improves complex-script shaping)
        if (document.fonts && typeof document.fonts.ready !== 'undefined') await document.fonts.ready;
      } catch(e) { /* ignore */ }
      // use a slightly lower scale to avoid glyph separation issues
      try {
        await html2canvas(clone, { backgroundColor: '#ffffff', scale: 1.5 }).then(canvas => {
          return new Promise((res) => {
            canvas.toBlob(blob => { res(blob); }, 'image/png');
          });
        }).then(blob => {
          if (!blob) return alert('خطا در تولید تصویر');
          const file = new File([blob], `${normPersian(p.name).replace(/\s+/g,'_')}_birthday.png`, { type: 'image/png' });
          if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            navigator.share({ files: [file], title: `تبریک تولد ${p.name}`, text: fullText });
          } else {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            a.click();
            URL.revokeObjectURL(url);
          }
        }).catch(err => { console.error('html2canvas error', err); alert('خطا در آماده‌سازی تصویر'); });
      } finally { try { clone.remove(); } catch(e){} }
    });
  // share-link removed per user request
  }, 50);
  modal.classList.remove('hide');
  modal.setAttribute('aria-hidden','false');
  on('#birthdayModalClose', 'click', closeBirthdayModal);
  on('#birthdayModalBackdrop', 'click', closeBirthdayModal);
  // focus management: save last focused element and trap focus inside modal
  const lastFocus = document.activeElement;
  modal._lastFocus = lastFocus;
  const focusableSelector = 'a[href], button, textarea, input, select, [tabindex]:not([tabindex="-1"])';
  const focusable = Array.from(qs('#birthdayModal').querySelectorAll(focusableSelector)).filter(el => !el.disabled && el.offsetParent !== null);
  if (focusable.length) focusable[0].focus();
  function trap(e) {
    if (e.key === 'Tab') {
      const idx = focusable.indexOf(document.activeElement);
      if (e.shiftKey) {
        if (idx === 0) { e.preventDefault(); focusable[focusable.length - 1].focus(); }
      } else {
        if (idx === focusable.length - 1) { e.preventDefault(); focusable[0].focus(); }
      }
    } else if (e.key === 'Escape') {
      closeBirthdayModal();
    }
  }
  window.addEventListener('keydown', trap);
  // store to remove when closing
  modal._trapHandler = trap;
}

function closeBirthdayModal() {
  const modal = qs('#birthdayModal');
  modal.classList.add('hide');
  modal.setAttribute('aria-hidden','true');
  // remove focus trap and restore focus
  if (modal._trapHandler) {
    window.removeEventListener('keydown', modal._trapHandler);
    delete modal._trapHandler;
  }
  if (modal._lastFocus) {
    try { modal._lastFocus.focus(); } catch (e) {}
    delete modal._lastFocus;
  }
}

calendar.addEventListener('click', e => e.stopPropagation());
window.addEventListener('keydown', e => {
  if (e.key === 'Escape') { hideJalaliCalendar(); }
});
window.addEventListener('beforeunload', saveState);

// برای آفلاین، اگر آنلاین نبود، از cache استفاده کن
if (!navigator.onLine) {
  alert('اپ آفلاین است. داده‌ها از کش لود شدند.');
}

// بروزرسانی service worker
navigator.serviceWorker.addEventListener('controllerchange', () => {
  window.location.reload();
});

</script>
  <script src="sync-supabase.js"></script>
  <script src="sw-register.js"></script>
</body>
  <script src="sync-supabase.js"></script>
  <script src="sw-register.js"></script>

  <script>
  // --- بهینه‌سازی UX دکمه ذخیره بازیکن ---
  const savePlayerBtn = document.getElementById('savePlayerBtn');
  if (savePlayerBtn) {
    savePlayerBtn.onclick = async function(e) {
      e.preventDefault();
      const btn = this;
      btn.disabled = true;
      btn.textContent = 'در حال ذخیره...';
      try {
        // فرض: داده‌های فرم بازیکن آماده است
        const payload = {
          // ...داده‌های فرم را اینجا قرار دهید (مثال: name, phone, ...)
        };
        const { data, error } = await window.supabase.from('players').insert([payload]);
        if (error) {
          alert('خطا در ذخیره بازیکن: ' + error.message);
          btn.textContent = 'ذخیره بازیکن';
          btn.disabled = false;
          return;
        }
        alert('بازیکن ذخیره شد');
        // رفرش لیست یا هدایت به پروفایل بازیکن
        // window.location.href = '/profile.html?id=' + data[0].id;
        btn.textContent = 'ذخیره بازیکن';
        btn.disabled = false;
  // trigger background backup (uses backupNow helper which writes shared_backups and backups)
  try { if (typeof backupNow === 'function') backupNow().catch(e=>console.warn('background backup failed', e)); } catch(e){}
      } catch (err) {
        alert('خطای غیرمنتظره: ' + err.message);
        btn.textContent = 'ذخیره بازیکن';
        btn.disabled = false;
      }
    };
  }

  // --- بهینه‌سازی UX دکمه ثبت پرداخت ---
  const savePaymentBtn = document.getElementById('savePaymentBtn');
  if (savePaymentBtn) {
    savePaymentBtn.onclick = async function(e) {
      e.preventDefault();
      const btn = this;
      btn.disabled = true;
      btn.textContent = 'در حال ثبت...';
      try {
        // فرض: داده‌های فرم پرداخت آماده است
        const payload = {
          // ...داده‌های فرم را اینجا قرار دهید (مثال: player_id, amount, ...)
        };
        const { data, error } = await window.supabase.from('payments').insert([payload]);
        if (error) {
          alert('خطا در ثبت پرداخت: ' + error.message);
          btn.textContent = 'ثبت پرداخت';
          btn.disabled = false;
          return;
        }
        alert('رسید ثبت شد');
        // رفرش لیست یا بستن فرم
        btn.textContent = 'ثبت پرداخت';
        btn.disabled = false;
  try { if (typeof backupNow === 'function') backupNow().catch(e=>console.warn('background backup failed', e)); } catch(e){}
      } catch (err) {
        alert('خطای غیرمنتظره: ' + err.message);
        btn.textContent = 'ثبت پرداخت';
        btn.disabled = false;
      }
    };
  }

  // --- subscribe به realtime برای همگام‌سازی بین دستگاه‌ها ---
  if (window.supabase && typeof window.supabase.channel === 'function') {
    try {
      const chPlayers = window.supabase.channel('public:players');
      chPlayers.on('postgres_changes', { event: '*', schema: 'public', table: 'players' }, payload => {
        // رفرش لیست بازیکنان یا فراخوانی تابع مورد نیاز
        // refreshPlayersList();
      }).subscribe();
      const chPayments = window.supabase.channel('public:payments');
      chPayments.on('postgres_changes', { event: '*', schema: 'public', table: 'payments' }, payload => {
        // رفرش لیست پرداخت‌ها یا فراخوانی تابع مورد نیاز
        // refreshPaymentsList();
      }).subscribe();
    } catch(e) { console.warn('realtime subscribe failed', e); }
  }
  </script>
</body>
  <script src="sync-supabase.js"></script>
  <script src="sw-register.js"></script>

  <script>
  // --- Load all main tables from Supabase and update state ---
  async function loadAllDataFromServer() {
    if (!window.supabase || !window.supabase.auth) return;
    let userRes = await window.supabase.auth.getUser();
    let user = userRes && userRes.data && userRes.data.user ? userRes.data.user : null;
    if (!user) return;

    // Helper to fetch and update state
    async function fetchTable(table, stateKey, extra = {}) {
      let q = window.supabase.from(table).select('*');
      if (table !== 'notes' && table !== 'shared_backups') {
        const uId = await debugCheckUserGuard('loadAllDataFromServer:' + table);
        if (!uId) return; // skip reading user-scoped table when no user
        q = q.eq('user_id', uId);
      }
      if (extra.order) q = q.order(extra.order, { ascending: false });
      let { data, error } = await q;
      if (!error && data) state[stateKey] = data;
      else console.warn('Load failed for', table, error);
    }

  await fetchTable('players', 'players');
  await fetchTable('payments', 'payments');
  await fetchTable('coaches', 'coaches');
  await fetchTable('sessions', 'sessions');
  await fetchTable('competitions', 'competitions');
  await fetchTable('training_plans', 'trainingPlans');
  // devices table removed in new schema; skip
  await fetchTable('notes', 'notes');
    // Optionally: shared_backups, backups, etc.

    // Call render functions if available
    if (typeof renderPlayersPage === 'function') renderPlayersPage();
    if (typeof renderCoaches === 'function') renderCoaches();
    if (typeof renderSessionsPage === 'function') renderSessionsPage();
    if (typeof renderPaymentsPage === 'function') renderPaymentsPage();
    if (typeof renderCompetitionsPage === 'function') renderCompetitionsPage();
    if (typeof renderTrainingPlansPage === 'function') renderTrainingPlansPage();
    // ... add more as needed
  }

  // Call this after login/signup or on refresh
  window.loadAllDataFromServer = loadAllDataFromServer;
  // Example: after successful login
  // await loadAllDataFromServer();
  </script>
  <script>
    // Auto-patch Supabase on load so select/insert/update are normalized
    (function() {
      function ensurePatch() {
        try {
          if (window.syncHybrid && typeof window.syncHybrid.ensureSupabasePatched === 'function') {
            try { window.syncHybrid.ensureSupabasePatched(); console.info('✅ Supabase auto-patched on load'); } catch(e) { console.debug('ensureSupabasePatched failed', e); }
            return;
          }
          // If syncHybrid isn't present, attempt lightweight header normalization for Supabase fetch calls
          if (window.fetch && window.SUPABASE_ANON_KEY && window.SUPABASE_URL) {
            // no-op: the fetch wrapper earlier already normalizes apikey header when matching SUPABASE_URL
            console.info('Supabase fetch wrapper active (no syncHybrid)');
            return;
          }
        } catch (e) { /* ignore */ }
        setTimeout(ensurePatch, 300);
      }
      if (document.readyState === 'complete' || document.readyState === 'interactive') ensurePatch();
      else document.addEventListener('DOMContentLoaded', ensurePatch);
    })();
  </script>
  </script>

  <!-- Load new backup module and expose singleton to non-module scripts -->
  <script type="module">
    try {
      import('./sync-backup.js').then(mod => {
        try { window.backupSync = mod.default || mod.backupSync || null; }
        catch(e) { console.debug('assigning backupSync failed', e); }
      }).catch(e => console.debug('loading sync-backup.js failed', e));
    } catch(e) { console.debug('module import failed', e); }
  </script>

  <!-- ✅ لود بعد از همه‌ی فایل‌های دیگر -->
  <!-- Ensure a container for in-page notifications exists -->
  <style>
    #view-notifications {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      max-width: 360px;
      z-index: 9999;
      font-family: Vazirmatn, sans-serif;
      direction: rtl;
    }
    #view-notifications h2 { display:none; }
    #notificationsList { display:flex;flex-direction:column;gap:0.75rem; }
    .notif-card {
      background:#fff3cd;
      padding:0.75rem 1rem;
      border-radius:10px;
      box-shadow:0 2px 5px rgba(0,0,0,0.12);
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:stretch;
      animation:slidein 0.22s ease;
      border-left:6px solid #ffc107;
      width:95%;
      margin:0 auto;
      position:relative;
      box-sizing:border-box;
    }
    .notif-card.type-birthday { border-left-color: #ff9800; }
    .notif-card.type-session, .notif-card.type-training { border-left-color: #4caf50; }
    .notif-card.type-competition { border-left-color: #2196f3; }
    .notif-card .title { font-weight:700; text-align:right; }
    .notif-card .body { color:var(--muted); font-size:14px; text-align:right; }
    .notif-card .ts { color:var(--muted); font-size:12px; text-align:right; }
    .notif-card .actions { display:flex; justify-content:flex-start; gap:8px; }
  .notif-card button { background:transparent;border:none;font-size:16px;cursor:pointer;color:#555; }
  .notif-card .close-btn { position:absolute; top:8px; right:8px; background:transparent;border:none;font-size:16px;cursor:pointer;color:#555; }
  /* account dot overlay */
  .account-notif-dot { position:absolute; width:10px; height:10px; border-radius:999px; background:#dc3545; right:8px; top:8px; box-shadow:0 0 0 2px rgba(255,255,255,0.5); display:none; }
    @keyframes slidein { from { opacity:0; transform: translateY(10px);} to { opacity:1; transform: translateY(0);} }
    .notifications-badge { background:#dc3545;color:#fff;border-radius:999px;padding:2px 6px;font-size:12px;display:none;margin-left:6px; }
    .badge-pop { transform: scale(1.15); transition: transform 0.25s ease; }
  </style>
  <div id="view-notifications" style="display:block;padding:8px;">
    <h2>📢 اعلان‌ها</h2>
    <div id="notificationsList"></div>
  </div>
  <script src="./notifications.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.initNotifications) {
        try {
          window.initNotifications();
          console.log("✅ notifications initialized from index.html");
        } catch(e) {
          console.warn("⚠️ initNotifications failed:", e);
        }
      } else {
        console.warn("⚠️ notifications.js not loaded yet.");
      }
    });
  </script>
  <!-- Touch-fix for player images: robust delegated handlers (tap vs scroll) -->
  <script>
    (function(){
      // Set to true to enable console debug logs for touch events (temporary while debugging)
      const TOUCH_DEBUG = false;
      const MOVE_THRESHOLD = 10; // px
      const TIME_THRESHOLD = 400; // ms

      let startX = 0, startY = 0, startT = 0, moved = false, startTarget = null, startScrollLeft = null;

      function findScrollableAncestor(node) {
        let cur = node;
        while (cur && cur !== document.body) {
          try {
            const s = window.getComputedStyle(cur);
            if (s && (s.overflowX === 'auto' || s.overflowX === 'scroll')) return cur;
          } catch (e) { break; }
          cur = cur.parentElement;
        }
        return null;
      }

      document.addEventListener('touchstart', function(e){
        try {
          const t = e.touches && e.touches[0]; if (!t) return;
          startX = t.clientX; startY = t.clientY; startT = Date.now(); moved = false;
          startTarget = e.target;
          const sc = findScrollableAncestor(startTarget);
          startScrollLeft = sc ? sc.scrollLeft : null;
          if (TOUCH_DEBUG) console.debug('touchstart', startX, startY, 'target=', startTarget && startTarget.className);
        } catch (err) { if (TOUCH_DEBUG) console.debug('touchstart err', err); }
      }, { passive: true });

      document.addEventListener('touchmove', function(e){
        try {
          const t = e.touches && e.touches[0]; if (!t) return;
          if (Math.abs(t.clientX - startX) > MOVE_THRESHOLD || Math.abs(t.clientY - startY) > MOVE_THRESHOLD) moved = true;
          if (TOUCH_DEBUG) console.debug('touchmove moved=', moved);
        } catch (err) { if (TOUCH_DEBUG) console.debug('touchmove err', err); }
      }, { passive: true });

      document.addEventListener('touchend', function(e){
        try {
          const t = e.changedTouches && e.changedTouches[0]; if (!t) return;
          const dt = Date.now() - startT;
          if (TOUCH_DEBUG) console.debug('touchend dt=', dt, 'moved=', moved);
          if (moved || dt > TIME_THRESHOLD) return; // likely a scroll or long press

          // find actionable element: prefer explicit .player-image or player-row
          let el = e.target;
          while (el && el !== document.body) {
            try {
              if (el.matches && (el.matches('.player-image') || el.matches('.player-row') || el.matches('.player-thumb') || el.matches('.player-thumb img'))) break;
            } catch(_){}
            el = el.parentElement;
          }
          if (!el || el === document.body) return;

          // if scroll container moved, ignore (user scrolled)
          const sc2 = findScrollableAncestor(startTarget);
          if (sc2 && startScrollLeft !== null && sc2.scrollLeft !== startScrollLeft) return;

          if (TOUCH_DEBUG) console.debug('dispatching synthetic click to', el);
          try { el.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true })); }
          catch (err) { try { el.click && el.click(); } catch(_){} }

        } catch (err) { if (TOUCH_DEBUG) console.debug('touchend err', err); }
      }, { passive: true });
    })();
  </script>
  <style>
    /* Feather sprite injected SVG sizing: inline <svg> inside .icon should use currentColor */
    .icon svg{ width:100%; height:100%; display:block; stroke:currentColor; fill:none; stroke-width:2; }
    /* Ensure span.icon has sensible size when inline-SVG is injected */
    span.icon{ display:inline-block; width:24px; height:24px; vertical-align:middle; }
  </style>

  <script>
  (function(){
    const SPRITE_PATH = 'assets/icons/feather-sprite.svg';

    // Inline the external SVG sprite (if present) so <use href="#id"> can reference symbols
    async function inlineSprite(){
      try{
        const res = await fetch(SPRITE_PATH);
        if (!res.ok) return;
        const text = await res.text();
        const container = document.createElement('div');
        container.style.display = 'none';
        container.innerHTML = text;
        document.body.insertBefore(container, document.body.firstChild);
        return true;
      } catch(e){ console.warn('feather sprite inline failed', e); return false; }
    }

    // Inject inline <svg><use href="#icon-name"></use></svg> into each <span class="icon icon-...">
    function injectIcons(){
      const nodes = document.querySelectorAll('span.icon');
      nodes.forEach(span => {
        if (span.querySelector('svg')) return; // already injected
        // find the icon-xxx class
        const cls = Array.from(span.classList).find(c => c.startsWith('icon-') && c !== 'icon');
        if (!cls) return;
        const iconName = cls.replace('icon-','').replace('_','-');
        try{
          const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
          svg.setAttribute('width','24'); svg.setAttribute('height','24'); svg.setAttribute('viewBox','0 0 24 24');
          const use = document.createElementNS('http://www.w3.org/2000/svg','use');
          // set both href and xlink:href for broader compatibility
          use.setAttribute('href', '#' + iconName);
          use.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href', '#' + iconName);
          svg.appendChild(use);
          // clear any background-image fallback
          span.style.backgroundImage = '';
          span.appendChild(svg);
        } catch(e){ /* ignore per-icon errors */ }
      });
    }

    // Run on DOMContentLoaded: inline sprite if available and inject icons. Also observe DOM for later injections.
    document.addEventListener('DOMContentLoaded', async () => {
      await inlineSprite();
      injectIcons();
      // keep injecting when new elements appear (useful for templates)
      const mo = new MutationObserver(() => injectIcons());
      mo.observe(document.body, { childList:true, subtree:true });
    });
  })();
  </script>
  
  <!-- Compact 600x600 poster styles and exporter -->
  <style id="sharePoster600-styles">
  /* Rectangular poster styles (scoped to #sharePoster600) - 600px wide and proportional height (4:5 -> 600x750) */
  #sharePoster600 { width:600px; height:750px; box-sizing:border-box; background:#ffffff; border-radius:12px; padding:14px; box-shadow:0 10px 24px rgba(0,0,0,0.08); font-family: 'Vazirmatn', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#111; display:none; }
  #sharePoster600 .poster-wrap { width:100%; height:100%; display:flex; flex-direction:column; align-items:stretch; }
  /* Photo area occupies larger portion to show full player image naturally */
  #sharePoster600 .poster-photo { flex:0 0 60%; border-radius:10px; overflow:hidden; background:#f4f4f4; position:relative; }
  #sharePoster600 .poster-photo img { width:100%; height:100%; object-fit:cover; display:block; }
  /* square profile thumbnail (like profile photo) — larger and centered; keep object-fit:cover so the image isn't distorted */
  #sharePoster600 .poster-photo .profile-thumb { width:280px; height:280px; border-radius:18px; overflow:hidden; margin:20px auto; box-shadow:0 10px 26px rgba(0,0,0,0.10); background:#eee; }
  #sharePoster600 .poster-photo .profile-thumb img { width:100%; height:100%; object-fit:cover; display:block; transform: scale(1.35); transform-origin: center center; }
  /* small team logo overlay inside photo area */
  #sharePoster600 .poster-photo .team-logo { position:absolute; top:12px; left:12px; width:64px; height:64px; border-radius:8px; background:#fff; padding:6px; box-shadow:0 6px 18px rgba(0,0,0,0.12); display:flex; align-items:center; justify-content:center; overflow:hidden; z-index:40; }
  #sharePoster600 .poster-photo .team-logo img { width:100%; height:100%; object-fit:contain; display:block; }
  #sharePoster600 .poster-body { flex:1 1 auto; padding-top:12px; display:flex; flex-direction:column; gap:8px; }
  #sharePoster600 .poster-name { font-weight:800; font-size:28px; text-align:center; color:#111; line-height:1.05; }
  #sharePoster600 .poster-rows { display:flex; flex-direction:column; gap:6px; padding:6px 4px; }
  #sharePoster600 .poster-row { display:flex; justify-content:space-between; gap:8px; align-items:center; padding:6px 8px; border-radius:8px; background:rgba(0,0,0,0.03); }
  #sharePoster600 .poster-row .label { font-weight:700; color:#444; font-size:14px; }
  #sharePoster600 .poster-row .value { font-weight:600; color:#111; font-size:15px; text-align:right; direction:rtl; }
  @media screen { #sharePoster600[aria-hidden="true"] { display:none !important; } }
  </style>

  <script>
  /* Compact 600x600 poster builder + exporter */
  (function(){
    const DEFAULT_AVATAR = 'assets/icons/avatar.png';

    function _ensurePoster600() {
      let el = document.getElementById('sharePoster600');
      if (!el) { el = document.createElement('div'); el.id = 'sharePoster600'; el.setAttribute('aria-hidden','true'); el.style.display='none'; document.body.appendChild(el); }
      return el;
    }

    function buildPoster600(player) {
      const el = _ensurePoster600();
      el.innerHTML = '';
      el.setAttribute('aria-hidden','false');
      const wrap = document.createElement('div'); wrap.className = 'poster-wrap';

    const photo = document.createElement('div'); photo.className = 'poster-photo';
    // smaller square thumbnail centered inside photo area to match profile display
    const thumb = document.createElement('div'); thumb.className = 'profile-thumb';
    const img = document.createElement('img'); img.id = 'poster600Photo'; img.alt = player && player.name ? `عکس ${player.name}` : 'عکس بازیکن';
    thumb.appendChild(img);
    photo.appendChild(thumb);
    // team logo overlay (small)
    const teamLogoWrap = document.createElement('div'); teamLogoWrap.className = 'team-logo';
    const teamLogoImg = document.createElement('img'); teamLogoImg.alt = 'لوگوی تیم'; teamLogoWrap.appendChild(teamLogoImg);
    photo.appendChild(teamLogoWrap);
      wrap.appendChild(photo);

      const body = document.createElement('div'); body.className = 'poster-body';
      const nameEl = document.createElement('div'); nameEl.className = 'poster-name'; nameEl.textContent = player && player.name ? player.name : '-'; body.appendChild(nameEl);

      const rows = document.createElement('div'); rows.className = 'poster-rows';
      function r(label, val) { const row = document.createElement('div'); row.className='poster-row'; const L = document.createElement('div'); L.className='label'; L.textContent=label; const V = document.createElement('div'); V.className='value'; V.textContent=val || '-'; row.appendChild(L); row.appendChild(V); rows.appendChild(row); }
      r('تلفن', player && player.phone ? player.phone : '-');
      r('تاریخ تولد', player && player.birthdate ? player.birthdate : '-');
  r('تاریخ عضویت', player && (player.membershipDate || player.joinDate) ? (player.membershipDate || player.joinDate) : '-');
  // physical status, skills and points intentionally removed from poster per user request

      body.appendChild(rows);
      wrap.appendChild(body);
      el.appendChild(wrap);
      return img;
    }

    function _waitImg(imgEl, timeout=2500) {
      return new Promise(res=>{ if(!imgEl) return res(false); if(imgEl.complete && imgEl.naturalWidth) return res(true); let done=false; const onl=()=>{ if(done) return; done=true; cleanup(); res(true); }; const one=()=>{ if(done) return; done=true; cleanup(); res(false); }; const cleanup=()=>{ imgEl.removeEventListener('load', onl); imgEl.removeEventListener('error', one); }; imgEl.addEventListener('load', onl); imgEl.addEventListener('error', one); setTimeout(()=>{ if(done) return; done=true; cleanup(); res(!!imgEl.naturalWidth); }, timeout); });
    }

    async function _fetchAsObjectURL(url) {
      try { const r = await fetch(url, { mode: 'cors' }); if(!r.ok) throw new Error('bad'); const b = await r.blob(); return { obj: URL.createObjectURL(b), blob: b }; } catch(e){ console.warn('fetch image for poster failed', e); return null; }
    }

    async function exportPoster600(player) {
      if(!player) throw new Error('player required');
      const el = _ensurePoster600();
      const imgEl = buildPoster600(player);
      el.style.display = 'block'; el.setAttribute('aria-hidden','false');

      let objInfo = null;
      try {
        if(player.photo) { objInfo = await _fetchAsObjectURL(player.photo); if(objInfo && objInfo.obj) imgEl.src = objInfo.obj; else imgEl.src = DEFAULT_AVATAR; }
        else imgEl.src = DEFAULT_AVATAR;
      } catch(e) { imgEl.src = DEFAULT_AVATAR; }

      // Attempt to load a team/club logo into the overlay if present (try several candidate fields)
      try {
        const logoImgEl = el.querySelector('.team-logo img');
        if (logoImgEl) {
          const headerLogo = (document.querySelector('#appLogo img') && document.querySelector('#appLogo img').src) ? document.querySelector('#appLogo img').src : null;
          const candidates = [headerLogo, player.teamLogo, player.clubLogo, (player.team && player.team.logo), (window.clubLogo || null), 'assets/icons/logo.png'];
          const logoUrl = candidates.find(u => u);
          if (logoUrl) {
            const logoObj = await _fetchAsObjectURL(logoUrl);
            if (logoObj && logoObj.obj) logoImgEl.src = logoObj.obj; else logoImgEl.src = 'assets/icons/logo.png';
          } else {
            logoImgEl.src = 'assets/icons/logo.png';
          }
        }
      } catch (e) { /* non-fatal */ }

      await _waitImg(imgEl, 3000);
      await new Promise(r=>setTimeout(r,40));
      // render with html2canvas at the element's natural size (1080x1350) - use higher scale for quality
      let blob = null;
      try {
        const canvas = await window.html2canvas(el, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
        blob = await new Promise(res=>canvas.toBlob(res, 'image/png'));
      } catch(e) { console.warn('html2canvas render failed', e); blob = null; }

      if(!blob) {
        // fallback: create canvas matching target poster dimensions
        try {
    const c = document.createElement('canvas'); c.width = 600; c.height = 750; const ctx = c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,600,750); ctx.fillStyle='#111'; ctx.font='bold 22px Vazirmatn, sans-serif'; ctx.fillText(player.name || '-', 24, 80); blob = await new Promise(res=>c.toBlob(res,'image/png'));
        } catch(e) { console.error('fallback canvas failed', e); }
      }

      if(!blob) { el.style.display='none'; el.setAttribute('aria-hidden','true'); if(objInfo && objInfo.obj) URL.revokeObjectURL(objInfo.obj); throw new Error('Failed to render poster'); }

      const safe = (player.name || 'player').replace(/\s+/g,'_').replace(/[^\w\-_.]/g,'');
  const file = new File([blob], `${safe}_poster_600x750.png`, { type: 'image/png' });

      try {
        if(navigator.canShare && navigator.canShare({ files: [file] })) {
          try { await navigator.share({ files: [file], title: player.name || 'پروفایل بازیکن' }); }
          catch(e) { console.warn('navigator.share failed', e); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${safe}_poster.png`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
        } else {
          const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${safe}_poster.png`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }
      } finally {
        el.style.display='none'; el.setAttribute('aria-hidden','true'); if(objInfo && objInfo.obj) { try{ URL.revokeObjectURL(objInfo.obj); } catch(_){} }
      }
    }

    window.buildPoster600 = buildPoster600;
    window.exportPoster600 = exportPoster600;
  })();
  <!-- Floating Close-All button (bottom-right) - placed globally so it's not affected by container transforms/overflow -->
  <button id="closeAllNotificationsFloat" aria-label="بستن همه اعلان‌ها" style="position:fixed;right:16px;bottom:20px;z-index:10010;padding:10px 14px;background:var(--accent, #0ea5a4);color:#fff;border:none;border-radius:28px;box-shadow:0 6px 18px rgba(0,0,0,0.18);font-weight:700;display:none;cursor:pointer;width:110px;text-align:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">بستن همه</button>

  </script>
  <script>
    window.setBackupButtonLoading = function(on){
      const btn = document.getElementById('backupNowBtn');
      const spinner = document.getElementById('backupNowSpinner');
      const text = document.querySelector('#backupNowBtn span:last-child');
      if(btn) btn.disabled = !!on;
      if(btn) btn.style.opacity = on ? '0.7' : '';
      if(spinner) spinner.style.display = on ? 'inline-block' : 'none';
      if(text) text.textContent = on ? 'در حال بک‌آپ گیری...' : 'ایجاد بک‌آپ جدید';
    };
  </script>
    <script type="module">
      // Test harness for backup-storage.js — call `await window.testBackupStorage()` in the browser console
      import { openAppDB, saveAppState, loadAppState, createFullBackup } from './backup-storage.js';

      window.testBackupStorage = async function() {
        console.log('🔧 testBackupStorage: starting prioritized storage test');
        try {
          const sample = { testAt: new Date().toISOString(), random: Math.random(), sampleData: { msg: 'hello from test' } };

          console.log('1) ensure/open IndexedDB (if supported)');
          await openAppDB().catch(e => console.warn('openAppDB warning', e));

          console.log('2) saving sample state (saveAppState)');
          const saveResult = await saveAppState(sample);
          console.log('   saveAppState ->', saveResult);

          console.log('3) loading back (loadAppState)');
          const loaded = await loadAppState();
          console.log('   loadAppState ->', loaded);

          console.log('4) creating full backup (createFullBackup) — this may include IndexedDB and Cache contents');
          const full = await createFullBackup();
          // store last result for convenience
          window._lastFullBackup = full;
          console.log('   createFullBackup -> string length:', full ? full.length : null);
          // show a truncated preview
          if (typeof full === 'string') console.log('\n---- full backup (first 2k chars) ----\n', full.slice(0, 2000), '\n--- end preview ---');

          console.log('✅ testBackupStorage: finished. Last full backup JSON is available as window._lastFullBackup');
          return { saveResult, loaded, fullLength: full ? full.length : null };
        } catch (err) {
          console.error('❌ testBackupStorage failed', err);
          throw err;
        }
      };

      console.log('backup-storage test helper installed: run `await window.testBackupStorage()` in the console');
    </script>
</body>
</html>
